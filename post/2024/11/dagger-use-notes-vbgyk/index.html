<!doctype html><html lang=zh dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Dagger 使用札记 | Akkuman 的技术博客</title><meta name=keywords content="DevOps,Dagger"><meta name=description content="Dagger 用来简化和标准化复杂的 CI/CD 管道，本文介绍了它的使用技巧"><meta name=author content><link rel=canonical href=https://www.hacktech.cn/post/2024/11/dagger-use-notes-vbgyk/><link crossorigin=anonymous href=https://cdn.jsdmirror.cn/gh/akkuman/akkuman.github.io@master/assets/css/stylesheet.2824803599022172c5df03c979b2556dc526917d1f5a5d792793d0907875bfd9.css integrity="sha256-KCSANZkCIXLF3wPJebJVbcUmkX0fWl15J5PQkHh1v9k=" rel="preload stylesheet" as=style><link rel=icon href=https://www.hacktech.cn/images/avatar.webp><link rel=icon type=image/png sizes=16x16 href=https://www.hacktech.cn/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://www.hacktech.cn/favicon-32x32.png><link rel=apple-touch-icon href=https://www.hacktech.cn/apple-touch-icon.png><link rel=mask-icon href=https://www.hacktech.cn/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh href=https://www.hacktech.cn/post/2024/11/dagger-use-notes-vbgyk/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC&family=Source+Code+Pro&display=swap" rel=stylesheet><script async src=https://cn.vercount.one/js></script><meta property="og:url" content="https://www.hacktech.cn/post/2024/11/dagger-use-notes-vbgyk/"><meta property="og:site_name" content="Akkuman 的技术博客"><meta property="og:title" content="Dagger 使用札记"><meta property="og:description" content="Dagger 用来简化和标准化复杂的 CI/CD 管道，本文介绍了它的使用技巧"><meta property="og:locale" content="zh-cn"><meta property="og:type" content="article"><meta property="article:section" content="post"><meta property="article:published_time" content="2024-11-04T15:30:22+08:00"><meta property="article:modified_time" content="2024-11-12T18:01:13+08:00"><meta property="article:tag" content="DevOps"><meta property="article:tag" content="Dagger"><meta name=twitter:card content="summary"><meta name=twitter:title content="Dagger 使用札记"><meta name=twitter:description content="Dagger 用来简化和标准化复杂的 CI/CD 管道，本文介绍了它的使用技巧"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://www.hacktech.cn/post/"},{"@type":"ListItem","position":3,"name":"Dagger 使用札记","item":"https://www.hacktech.cn/post/2024/11/dagger-use-notes-vbgyk/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Dagger 使用札记","name":"Dagger 使用札记","description":"Dagger 用来简化和标准化复杂的 CI/CD 管道，本文介绍了它的使用技巧","keywords":["DevOps,Dagger"],"articleBody":"Dagger 使用札记 工具介绍 用于构建 DevOps 工作流的开源平台，旨在简化和标准化复杂的 CI/CD 管道。\nDagger 提供了 Go/Python/TypeScript 等语言的 sdk，使你能使用这些语言来操作 BuildKit 来生成或推送你想要的文件或镜像\n用法 以下的安装和初始化给出了国内网络环境下的使用\n安装 工欲善其事必先利其器，首先就是需要下载使用\n首先可以按照官网 Installation | Dagger 来进行安装\n1 curl -fsSL https://dl.dagger.io/dagger/install.sh | BIN_DIR=/usr/local/bin sudo -E sh 初始化 我们可以使用如下命令对我们已有的项目进行初始化\n1 dagger init --sdk=go --source=./dagger 但是你可能会碰到如下错误\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 ✘ connect 17.0s ! start engine: failed to pull image: failed to run command: exit status 1 ✘ starting engine 17.0s ! failed to pull image: failed to run command: exit status 1 ✘ create 17.0s ! failed to pull image: failed to run command: exit status 1 ✔ exec docker ps -a --no-trunc --filter name=^/dagger-engine- --format {{.Names}} 0.3s ✘ exec docker inspect --type=image registry.dagger.io/engine:v0.13.7 0.0s ! failed to run command: exit status 1 ┃ [] ┃ Error response from daemon: No such image: registry.dagger.io/engine:v0.13.7 ✘ exec docker pull registry.dagger.io/engine:v0.13.7 16.7s ! failed to run command: exit status 1 ┃ Error response from daemon: Get \"https://registry.dagger.io/v2/\": net/http: request canceled while waiting for connection (Client.Timeout exceeded while awaiting headers) Error: start engine: failed to pull image: failed to run command: exit status 1 错误提示我们拉取不到镜像，很明显是网络问题\n根据以下链接\n记录如何在私有 Intranet 中运行 dagger · 问题 #6275 · dagger/dagger — Document how to run dagger in a private intranet · Issue #6275 · dagger/dagger 缺少有关如何在公司代理后面使用 dagger 的文档 · 问题 #5240 · dagger/dagger — Missing documentation on how to use dagger behind a corporate proxy · Issue #5240 · dagger/dagger 支持本地调试远程引擎·问题#25852·airbytehq/airbyte — Support for debugging remote engines locally · Issue #25852 · airbytehq/airbyte 我们可以得到一个解决方案（文档参见 Custom Runner | Dagger）\n1 2 export _EXPERIMENTAL_DAGGER_RUNNER_HOST=docker-image://ghcr.nju.edu.cn/dagger/engine:v0.13.7 dagger init --sdk=go --source=./dagger 但可能还是会报错\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 ✔ connect 7m19.9s ✔ cache request: mkfile /schema.json 0.0s ✔ mkfile /schema.json 0.1s ✔ cache request: blob://sha256:ccfd910d90eb8e37ae8d9131e99f63cec19c582e841db89062a05342514c2165 0.0s ✔ blob://sha256:ccfd910d90eb8e37ae8d9131e99f63cec19c582e841db89062a05342514c2165 0.0s ✔ moduleSource(refString: \".\"): ModuleSource! 0.0s ✔ ModuleSource.kind: ModuleSourceKind! 0.0s ✔ ModuleSource.resolveContextPathFromCaller: String! 0.0s ✔ ModuleSource.withName(name: \"z_deploy\"): ModuleSource! 0.0s ✔ ModuleSource.withSDK(sdk: \"go\"): ModuleSource! 0.0s ✔ ModuleSource.withInit: ModuleSource! 0.0s ✔ ModuleSource.withSourceSubpath(path: \"dagger\"): ModuleSource! 0.0s ✔ ModuleSource.resolveFromCaller: ModuleSource! 0.2s ✘ ModuleSource.asModule(engineVersion: \"latest\"): Module! 45.2s ! failed to create module: select: failed to update codegen and runtime: failed to generate code: failed to get modified source directory for go module sdk codegen: select: process \"codegen --output /src --module-context-path /src/z_deploy/dagger --module-name z_deploy --introspection-json-path /schema.json --merge=false\" did not complete successfully: exit code: 1 Error: failed to generate code: input: moduleSource.withContextDirectory.withName.withSDK.withSourceSubpath.withInit.asModule resolve: failed to create module: select: failed to update codegen and runtime: failed to generate code: failed to get modified source directory for go module sdk codegen: select: process \"codegen --output /src --module-context-path /src/z_deploy/dagger --module-name z_deploy --introspection-json-path /schema.json --merge=false\" did not complete successfully: exit code: 1 Stdout: generating go module: z_deploy creating directory . [skipped] creating directory z_deploy [skipped] creating directory z_deploy/dagger [skipped] writing z_deploy/dagger/dagger.gen.go writing z_deploy/dagger/go.mod writing z_deploy/dagger/go.sum creating directory z_deploy/dagger/internal creating directory z_deploy/dagger/internal/dagger writing z_deploy/dagger/internal/dagger/dagger.gen.go creating directory z_deploy/dagger/internal/querybuilder writing z_deploy/dagger/internal/querybuilder/marshal.go writing z_deploy/dagger/internal/querybuilder/querybuilder.go creating directory z_deploy/dagger/internal/telemetry writing z_deploy/dagger/internal/telemetry/attrs.go writing z_deploy/dagger/internal/telemetry/env.go writing z_deploy/dagger/internal/telemetry/exporters.go writing z_deploy/dagger/internal/telemetry/init.go writing z_deploy/dagger/internal/telemetry/live.go writing z_deploy/dagger/internal/telemetry/logging.go writing z_deploy/dagger/internal/telemetry/metrics.go writing z_deploy/dagger/internal/telemetry/proxy.go writing z_deploy/dagger/internal/telemetry/span.go writing z_deploy/dagger/internal/telemetry/transform.go writing z_deploy/dagger/main.go creating directory z_deploy/dagger/internal [skipped] creating directory z_deploy/dagger/internal/dagger [skipped] writing z_deploy/dagger/internal/dagger/dagger.gen.go [skipped] creating directory z_deploy/dagger/internal/querybuilder [skipped] writing z_deploy/dagger/internal/querybuilder/marshal.go [skipped] writing z_deploy/dagger/internal/querybuilder/querybuilder.go [skipped] creating directory z_deploy/dagger/internal/telemetry [skipped] writing z_deploy/dagger/internal/telemetry/attrs.go [skipped] writing z_deploy/dagger/internal/telemetry/env.go [skipped] writing z_deploy/dagger/internal/telemetry/exporters.go [skipped] writing z_deploy/dagger/internal/telemetry/init.go [skipped] writing z_deploy/dagger/internal/telemetry/live.go [skipped] writing z_deploy/dagger/internal/telemetry/logging.go [skipped] writing z_deploy/dagger/internal/telemetry/metrics.go [skipped] writing z_deploy/dagger/internal/telemetry/proxy.go [skipped] writing z_deploy/dagger/internal/telemetry/span.go [skipped] writing z_deploy/dagger/internal/telemetry/transform.go [skipped] running post-command: go mod tidy post-command failed: exit status 1 Stderr: go: downloading github.com/stretchr/testify v1.9.0 go: github.com/go-logr/stdr@v1.2.2 requires github.com/go-logr/logr@v1.2.2: Get \"https://proxy.golang.org/github.com/go-logr/logr/@v/v1.2.2.mod\": dial tcp 142.250.217.113:443: i/o timeout Error: exit status 1 我搜索了一下，在这里找到了方案\n🐞 Dagger 模块在企业环境中崩溃 · Issue #6599 · dagger/dagger — 🐞 Dagger modules break in corporate environments · Issue #6599 · dagger/dagger engine: support for system proxy settings by sipsma · Pull Request #7255 · dagger/dagger 我们可以设置 _DAGGER_ENGINE_SYSTEMENV_GOPROXY​ 环境变量，让我们试试\n1 2 3 export _DAGGER_ENGINE_SYSTEMENV_GOPROXY=https://goproxy.cn,direct # 使用 -vvv 打印更丰富的日志 dagger init --sdk=go --source=./dagger -vvv 我们会发现还是报同样的错误，我在 🐞 Dagger 模块在企业环境中崩溃 · Issue #6599 · dagger/dagger — 🐞 Dagger modules break in corporate environments · Issue #6599 · dagger/dagger 问了下大家，发现这个环境变量并不是作用于客户端，而是引擎。\n通过我们上面 -vvv​ 可以看到实际调用的 docker run​ 命令是\n1 docker run --name dagger-engine-v0.13.7 -d --restart always -v /var/lib/dagger --privileged ghcr.nju.edu.cn/dagger/engine:v0.13.7 --debug 所以最终的处理方案是\n1 2 3 export _EXPERIMENTAL_DAGGER_RUNNER_HOST=docker-image://ghcr.nju.edu.cn/dagger/engine:v0.13.7 docker run --name dagger-engine-v0.13.7 -d --restart always -v /var/lib/dagger -e _DAGGER_ENGINE_SYSTEMENV_GOPROXY=https://goproxy.cn,direct --privileged ghcr.nju.edu.cn/dagger/engine:v0.13.7 --debug dagger init --sdk=go --source=./dagger -vvv 将 _EXPERIMENTAL_DAGGER_RUNNER_HOST​ 设置为 docker-image://ghcr.nju.edu.cn/dagger/engine:v0.13.7​ 将会指示 dagger 客户端查找当前是否有对应镜像的容器正在运行，如果没有，则按照内置的命令创建一个。或者你也可以使用 docker-container://dagger-engine-v0.13.7​ 直接指定容器。\n使用样例 这里给出一个使用样例，我们希望有的功能清单为\n编译出二进制 编译多架构 Docker 镜像并推送到远端 目录结构 1 2 3 4 5 6 7 8 9 . ├── dagger.json ├── dagger │ ├── ... │ └── main.go ├── .goreleaser.yaml ├── makefile ├── go.mod └── go.sum 文件内容 dagger/main.go 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 package main import ( \"context\" \"fmt\" \"strings\" \"time\" \"dagger/peien-engine/internal/dagger\" ) type MyEngine struct{} func (m *MyEngine) joinCommands(cmds []string) string { return strings.Join(cmds, \" \u0026\u0026 \") } func (m *MyEngine) BuildApp(ctx context.Context, src *dagger.Directory, token *dagger.Secret) *dagger.Container { // build app builder := dag.Container(). From(\"golang:1.22-bullseye\"). WithSecretVariable(\"GITEA_TOKEN\", token). WithWorkdir(\"/src\"). WithMountedCache(\"/go/pkg/mod\", dag.CacheVolume(\"go-mod\")). WithEnvVariable(\"GOMODCACHE\", \"/go/pkg/mod\"). WithMountedCache(\"/go/build-cache\", dag.CacheVolume(\"go-build\")). WithEnvVariable(\"GOCACHE\", \"/go/build-cache\"). WithEnvVariable(\"CGO_ENABLED\", \"0\"). WithEnvVariable(\"GOPROXY\", \"https://goproxy.cn,direct\"). WithEnvVariable(\"GOINSECURE\", \"gitprivate.com\"). WithEnvVariable(\"GOPRIVATE\", \"gitprivate.com\"). WithExec([]string{\"sh\", \"-c\", m.joinCommands([]string{ \"curl -L -o goreleaser_Linux_x86_64.tar.gz https://files.m.daocloud.io/github.com/goreleaser/goreleaser/releases/download/v2.3.2/goreleaser_Linux_x86_64.tar.gz\", \"tar -xzvf goreleaser_Linux_x86_64.tar.gz -C /usr/local/bin goreleaser\", \"chmod +x /usr/local/bin/goreleaser\", \"rm -rf goreleaser_Linux_x86_64.tar.gz\", })}). WithExec([]string{\"sh\", \"-c\", `git config --global url.\"http://${GITEA_TOKEN}@gitprivate.com\".insteadOf \"http://gitprivate.com\"`}). WithDirectory(\"/src\", src). WithExec([]string{\"sh\", \"-c\", m.joinCommands([]string{ \"goreleaser build --skip=validate --clean\", \"mv dist/my-engine_linux_amd64_v1 dist/my-engine_linux_amd64\", })}) return builder } func (m *MyEngine) buildImage(platform dagger.Platform, src *dagger.Directory, appName string, version string, builder *dagger.Container) *dagger.Container { osArch := strings.Split(string(platform), \"/\")[1] ctr := dag.Container(dagger.ContainerOpts{Platform: platform}). From(\"debian:bullseye-slim\"). WithLabel(\"org.opencontainers.image.version\", version). WithLabel(\"org.opencontainers.image.created\", time.Now().String()). WithWorkdir(\"/app\"). WithEnvVariable(\"TZ\", \"Asia/Shanghai\"). WithExec([]string{\"sh\", \"-c\", m.joinCommands([]string{ \"sed -i 's|http://deb.debian.org/debian|http://mirror.sjtu.edu.cn/debian|g' /etc/apt/sources.list\", \"sed -i '/security.debian.org/d' /etc/apt/sources.list\", \"apt-get update\", \"apt-get -qq install -y --no-install-recommends ca-certificates curl openssl firefox-esr firefox-esr-l10n-zh-cn wget fontconfig\", // 清理 apt 缓存 \"apt-get clean -y\", \"rm -rf /var/lib/apt/lists/*\", })}). WithFile(fmt.Sprintf(\"/app/%s\", appName), builder.File(fmt.Sprintf(\"/src/dist/%s_linux_%s/%s\", appName, osArch, appName))). WithEntrypoint([]string{fmt.Sprintf(\"/app/%s\", appName)}) return ctr } func (m *MyEngine) BuildOneImage( ctx context.Context, src *dagger.Directory, // GITEA TOKEN token *dagger.Secret, // +optional // +default=\"\" imageName string, // +optional // +default=\"unknown\" version string, ) (*dagger.Container, error) { builder := m.BuildApp(ctx, src, token) appName := \"my-engine\" ctr := m.buildImage(\"linux/amd64\", src, appName, version, builder) if imageName == \"\" { imageName = fmt.Sprintf(\"docker-registry.com/akkuman/%s:easm-dev\", appName) } ctr = ctr.WithAnnotation(\"io.containerd.image.name\", imageName) return ctr, nil } func (m *MyEngine) BuildAllImagePublish( ctx context.Context, src *dagger.Directory, token *dagger.Secret, version string, registryUser string, registryPass *dagger.Secret, ) ([]string, error) { builder := m.BuildApp(ctx, src, token) var platforms = []dagger.Platform{ \"linux/amd64\", // a.k.a. x86_64 \"linux/arm64\", // a.k.a. aarch64 } var imageRepos []string appName := \"my-engine\" platformVariants := make([]*dagger.Container, 0, len(platforms)) for _, platform := range platforms { ctr := m.buildImage(platform, src, appName, version, builder) platformVariants = append(platformVariants, ctr) } imageRepo := []string{ fmt.Sprintf(\"docker-registry.com/akkuman/%s:latest\", appName), fmt.Sprintf(\"docker-registry.com/akkuman/%s:%s\", appName, version), } for _, repoAddr := range imageRepo { addr, err := dag.Container().WithRegistryAuth(\"docker-registry.com/\", registryUser, registryPass).Publish(ctx, repoAddr, dagger.ContainerPublishOpts{ PlatformVariants: platformVariants, }) if err != nil { return nil, err } imageRepos = append(imageRepos, addr) } return imageRepos, nil } makefile 1 2 3 4 5 6 7 8 9 10 11 build: goreleaser build --skip=validate --clean dagger-build: # 编译后可在 dist 目录下查看 dagger call build-app --src=. --token=env:GITEA_TOKEN directory --path=\"/src/dist\" export --path=\"./dist\" image-build-export: # 构建 amd64 镜像并导出到 my-engine.tgz dagger call build-one-image --src=. --token=env:GITEA_TOKEN export --path=my-engine.tgz build-all-publish: # 构建多架构镜像并推送 dagger call build-all-image-publish --src=. --token=env:GITEA_TOKEN --version=\"$GIT_TAG\" --registry-user=\"$DOCKER_USERNAME\" --registry-pass=env:DOCKER_PASSWORD 一些 Tips Dagger CLI 某些功能可以和代码等同 拿 Golang 编译然后导出到本地目录做演示\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 package main import ( \"context\" \"fmt\" \"strings\" \"time\" \"dagger/peien-engine/internal/dagger\" ) type PeienEngine struct{} func (m *PeienEngine) joinCommands(cmds []string) string { return strings.Join(cmds, \" \u0026\u0026 \") } func (m *PeienEngine) BuildApp(ctx context.Context, src *dagger.Directory, token *dagger.Secret) *dagger.Container { // build app builder := dag.Container(). ... WithExec([]string{\"sh\", \"-c\", m.joinCommands([]string{ \"goreleaser build --skip=validate --clean\", \"mv dist/engine_linux_amd64_v1 dist/engine_linux_amd64\", })}) return builder } 可以使用如下命令导出编译产物\n1 2 # 编译后可在 dist 目录下查看 dagger call build-app --src=. --token=env:GITEA_TOKEN directory --path=\"/src/dist\" export --path=\"./dist\" 也可以新建一个函数\n1 2 3 func (m *PeienEngine) BuildAndExport(ctx context.Context, src *dagger.Directory, token *dagger.Secret) (string, error) { return m.BuildApp(ctx, src, token).Directory(\"/src/dist\").Export(\"./dist\") } 然后执行命令 dagger call build-and-export --src=. --token=env:GITEA_TOKEN​\nWithExec 不会合并成一层 我们写 Dockerfile 的时候，常常为了体积考虑，会把几行命令写成一行，比如上面的\n1 2 RUN goreleaser build --skip=validate --clean \u0026\u0026 \\ mv dist/engine_linux_amd64_v1 dist/engine_linux_amd64 如果写成两行的话，则编译出来会占用编译产物的所有体积，然后下面的 mv​ 又会占用一次体积。\n而 Dagger 官方示例中处处都是类似下面这种\n1 2 3 ... WithExec([]string{\"goreleaser\", \"build\", \"--skip=validate\", \"--clean\"}). WithExec([]string{\"mv\", \"dist/engine_linux_amd64_v1\", \"dist/engine_linux_amd64\"}) 最开始我以为既然官方示例这么写，那应该会自动合并，但是我使用 dive 查看后，发现并没有合并，上面这种写法基本等同下面两行 RUN​\n1 2 RUN goreleaser build --skip=validate --clean RUN mv dist/engine_linux_amd64_v1 dist/engine_linux_amd64 所以需要合并的，最好使用 sh -c​ 来合并，例如\n1 WithExec([]string{\"sh\", \"-c\",\"goreleaser build --skip=validate --clean \u0026\u0026 mv dist/engine_linux_amd64_v1 dist/engine_linux_amd64\")}) 操作是有序的 可能我们会看到很多 WithX 操作，比如\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 builder := dag.Container(). From(\"golang:1.22-bullseye\"). WithSecretVariable(\"GITEA_TOKEN\", token). WithWorkdir(\"/src\"). WithMountedCache(\"/go/pkg/mod\", dag.CacheVolume(\"go-mod\")). WithEnvVariable(\"GOMODCACHE\", \"/go/pkg/mod\"). WithMountedCache(\"/go/build-cache\", dag.CacheVolume(\"go-build\")). WithEnvVariable(\"GOCACHE\", \"/go/build-cache\"). WithEnvVariable(\"CGO_ENABLED\", \"0\"). WithEnvVariable(\"GOPROXY\", \"https://goproxy.cn,direct\"). WithExec([]string{\"sh\", \"-c\", m.joinCommands([]string{ \"curl -L -o goreleaser_Linux_x86_64.tar.gz https://github.com/goreleaser/goreleaser/releases/download/v2.3.2/goreleaser_Linux_x86_64.tar.gz\", \"tar -xzvf goreleaser_Linux_x86_64.tar.gz -C /usr/local/bin goreleaser\", \"chmod +x /usr/local/bin/goreleaser\", \"rm -rf goreleaser_Linux_x86_64.tar.gz\", })}). WithDirectory(\"/src\", src). WithExec([]string{\"sh\", \"-c\", m.joinCommands([]string{ \"goreleaser build --skip=validate --clean\", \"mv dist/peien-engine_linux_amd64_v1 dist/peien-engine_linux_amd64\", \"mv dist/peien-node_linux_amd64_v1 dist/peien-node_linux_amd64\", })}) 需要注意这些操作都是有序的，比如官方很多样例把 WithDirectory(\"/src\", src)​ 放在最前面，就导致任何一点变动都会影响后续所有流程，正确的方法是放在编译前，就和我们平时写 Dockerfile 考虑的层级构造一样，是有序的，变动多的往后放。\nDagger 开发环境恢复 TLDR: dagger develop​ 即可安装 SDK\n当我们使用 init​ 创建一个 Dagger 流程后，会发现它生成的文件夹里面排除了生成的 sdk，参见以下 .gitignore​ 示例\n1 2 3 4 /dagger.gen.go /internal/dagger /internal/querybuilder /internal/telemetry 也就是这些文件不会签入 git 仓库，和其他人协作开发时，这些文件不会同步，虽说这对于 Dagger 各种命令的运行不影响（Dagger内部会构建环境），这些文件是供我们开发 Dagger 流程的。\n我们可以使用命令 dagger develop​ 来生成这些 SDK 文件，这个命令会找到项目下面生成的 dagger.json 文件，然后根据里面的配置在对应的文件夹生成 SDK\n以上说明可参见\n✨ Cannot update SDK when using newer version of Dagger · Issue #7964 · dagger/dagger CLI Reference | Dagger dagger.gen.go 报错 有时候你想改变 main.go​ 的导出函数名称，会看到类似这样的报错\n1 (*PeienEngine).BuildOneImage undefined (type *PeienEngine has no field or method BuildOneImage) 此时你需要使用上面提到的 dagger develop​ 来重新生成 dagger.gen.go​\n不过不运行也没关系，就是 IDE 或编辑器会有错误提示而已，实际运行不影响\n导出镜像 tarball 设置镜像tag 问题描述：使用 export 导出的镜像 tarball 是没有 tag 的\n解决方案：添加 io.containerd.image.name​ 的 annotation​ 即可，代码示例如下\n1 2 3 4 5 6 ... builder := dag.Container(). From(\"golang:1.22-bullseye\"). ... WithAnnotation(\"io.containerd.image.name\", fmt.Sprintf(\"akkuman/testapp:%s\", version)) ... 其中 WithAnnotation(\"io.containerd.image.name\", fmt.Sprintf(\"akkuman/testapp:%s\", version))​ 将会设置镜像 tag\n相关 issue:\n✨ .AsTarball Add OCI manifest RepoTags · Issue #7368 · dagger/dagger [Container.Export] Support custom annotations for exporting oci tar. · Issue #6999 · dagger/dagger ✨ Import image to local container runtime · Issue #8025 · dagger/dagger .dockerignore 不起效 我们知道，Docker 构建时可以使用 .dockerignore 来排除一些文件的导入，但似乎 Dagger 不会依照 .dockerignore\n查阅文档 Directory Filters | Dagger，发现需要指定\n例如\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 package main import ( \"context\" \"dagger/my-module/internal/dagger\" ) type MyModule struct{} func (m *MyModule) Foo( ctx context.Context, // +ignore=[\".git\", \"**/.gitignore\"] source *dagger.Directory, ) (*dagger.Container, error) { return dag.Container(). From(\"alpine:latest\"). WithDirectory(\"/src\", source). Sync(ctx) } 可以查看其中的 +ignore​，详情参阅 Directory Filters | Dagger\n如何限制某个参数是特定选项值 这是一个类似枚举的需求，如果没有仔细查阅文档，可能会这样做\n1 2 3 4 5 6 7 8 9 10 func (m *MyApp) BuildOneImage( ctx context.Context, src *dagger.Directory, appTag string, ) (*dagger.Container, error) { if appTag != \"engine\" \u0026\u0026 appTag != \"node\" { return nil, fmt.Errorf(\"appTag 必须为 engine 或者 node\") } ... } 但实际上 Dagger 支持枚举，可以改成\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 type AppTag string const ( EngineAppTag AppTag = \"engine\" NodeAppTag AppTag = \"node\" ) func (m *MyApp) BuildOneImage( ctx context.Context, src *dagger.Directory, appTag AppTag, ) (*dagger.Container, error) { ... } 这样除了可以简化自己的判断之外，也可以使用 dagger call build-one-image --help​ 在帮助中查看到\n1 2 ARGUMENTS --app-tag engine,node [required] 详情参见 Enumerations | Dagger\n使用 dag.Container().From(“alpine:latest”) 无法拉取镜像 国内因为网络问题，无法拉取到 docker.io 上的镜像，但是 dagger call​ 的执行实际上在 dagger engine 容器中，所以拉取时不会依照本地设置的 /etc/docke/daemon.json​\n这时我们可以采用手动运行 Dagger Engine 服务容器的方式，指定 Dagger Eninge 的 engine.toml\n例如，创建文件 engine.toml​，注意：其中的镜像换成自己的要使用的镜像地址\n1 2 [registry.\"docker.io\"] mirrors = [\"mirror.a.com\", \"mirror.b.com\"] 然后手动运行 Engine\n1 docker run --rm -v /var/lib/dagger --name customized-dagger-engine --privileged --volume $PWD/engine.toml:/etc/dagger/engine.toml ghcr.nju.edu.cn/dagger/engine:v0.13.7 然后配置环境变量指定 Dagger CLI 使用该 Dagger Engine 服务\n1 export _EXPERIMENTAL_DAGGER_RUNNER_HOST=docker-container://customized-dagger-engine 接下来再使用 Dagger CLI 执行 dagger call​ 各种 From​ 拉取就不会有问题了\n详情参见\nCustom Registry Mirrors | Dagger Custom Runner | Dagger Dagger 缓存占据了很大空间，如何清理 缓存大小可以使用 BuildKit 垃圾收集配置来控制，也可以使用如下命令清理 Dagger Engine 的所有缓存\n1 2 3 4 5 6 7 8 9 dagger query \u003c","wordCount":"4327","inLanguage":"zh","datePublished":"2024-11-04T15:30:22+08:00","dateModified":"2024-11-12T18:01:13+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://www.hacktech.cn/post/2024/11/dagger-use-notes-vbgyk/"},"publisher":{"@type":"Organization","name":"Akkuman 的技术博客","logo":{"@type":"ImageObject","url":"https://www.hacktech.cn/images/avatar.webp"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://www.hacktech.cn/ accesskey=h title="Akkuman 的技术博客 (Alt + H)">Akkuman 的技术博客</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://www.hacktech.cn/archives/ title=归档><span>归档</span></a></li><li><a href=https://www.hacktech.cn/categories/ title=分类><span>分类</span></a></li><li><a href=https://www.hacktech.cn/search/ title=搜索><span>搜索</span></a></li><li><a href=https://www.hacktech.cn/tags/ title=标签><span>标签</span></a></li><li><a href=https://www.hacktech.cn/links/ title=友情链接><span>友情链接</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://www.hacktech.cn/>主页</a>&nbsp;»&nbsp;<a href=https://www.hacktech.cn/post/>Posts</a></div><h1 class="post-title entry-hint-parent">Dagger 使用札记</h1><div class=post-description>Dagger 用来简化和标准化复杂的 CI/CD 管道，本文介绍了它的使用技巧</div><div class=post-meta><span title='2024-11-04 15:30:22 +0800 +0800'>十一月 4, 2024</span>&nbsp;·&nbsp;9 分钟&nbsp;|&nbsp;<a href="mailto://akkumans@qq.com?subject=Suggesting%20changes%20for%20/post/dagger-use-notes-vbgyk.md" rel="noopener noreferrer edit" target=_blank>给我邮件</a></div></header><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>目录</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#工具介绍>工具介绍</a></li><li><a href=#用法>用法</a><ul><li><a href=#安装>安装</a></li><li><a href=#初始化>初始化</a></li></ul></li><li><a href=#使用样例>使用样例</a><ul><li><a href=#目录结构>目录结构</a></li><li><a href=#文件内容>文件内容</a></li></ul></li><li><a href=#一些-tips>一些 Tips</a><ul><li><a href=#dagger-cli-某些功能可以和代码等同>Dagger CLI 某些功能可以和代码等同</a></li><li><a href=#withexec-不会合并成一层>WithExec 不会合并成一层</a></li><li><a href=#操作是有序的>操作是有序的</a></li><li><a href=#dagger-开发环境恢复>Dagger 开发环境恢复</a></li><li><a href=#daggergengo-报错>dagger.gen.go 报错</a></li><li><a href=#导出镜像-tarball-设置镜像tag>导出镜像 tarball 设置镜像tag</a></li><li><a href=#dockerignore-不起效>.dockerignore 不起效</a></li><li><a href=#如何限制某个参数是特定选项值>如何限制某个参数是特定选项值</a></li><li><a href=#使用-dagcontainerfromalpinelatest-无法拉取镜像>使用 dag.Container().From(&ldquo;alpine:latest&rdquo;) 无法拉取镜像</a></li><li><a href=#dagger-缓存占据了很大空间如何清理>Dagger 缓存占据了很大空间，如何清理</a></li><li><a href=#github-action-中如何保留缓存>Github Action 中如何保留缓存</a></li></ul></li><li><a href=#为什么是-dagger-而不是-earthly>为什么是 Dagger 而不是 Earthly</a></li></ul></nav></div></details></div><div class=post-content><h1 id=dagger-使用札记>Dagger 使用札记<a hidden class=anchor aria-hidden=true href=#dagger-使用札记>#</a></h1><h2 id=工具介绍>工具介绍<a hidden class=anchor aria-hidden=true href=#工具介绍>#</a></h2><p>用于构建 DevOps 工作流的开源平台，旨在简化和标准化复杂的 CI/CD 管道。</p><p>Dagger 提供了 Go/Python/TypeScript 等语言的 sdk，使你能使用这些语言来操作 BuildKit 来生成或推送你想要的文件或镜像</p><h2 id=用法>用法<a hidden class=anchor aria-hidden=true href=#用法>#</a></h2><p>以下的安装和初始化给出了国内网络环境下的使用</p><h3 id=安装>安装<a hidden class=anchor aria-hidden=true href=#安装>#</a></h3><p>工欲善其事必先利其器，首先就是需要下载使用</p><p>首先可以按照官网 <a href=https://docs.dagger.io/install/>Installation | Dagger</a> 来进行安装</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl -fsSL https://dl.dagger.io/dagger/install.sh | BIN_DIR<span style=color:#f92672>=</span>/usr/local/bin sudo -E sh
</span></span></code></pre></td></tr></table></div></div><h3 id=初始化>初始化<a hidden class=anchor aria-hidden=true href=#初始化>#</a></h3><p>我们可以使用如下命令对我们已有的项目进行初始化</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>dagger init --sdk<span style=color:#f92672>=</span>go --source<span style=color:#f92672>=</span>./dagger
</span></span></code></pre></td></tr></table></div></div><p>但是你可能会碰到如下错误</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plaintext data-lang=plaintext><span style=display:flex><span>✘ connect 17.0s
</span></span><span style=display:flex><span>! start engine: failed to pull image: failed to run command: exit status 1
</span></span><span style=display:flex><span>  ✘ starting engine 17.0s
</span></span><span style=display:flex><span>  ! failed to pull image: failed to run command: exit status 1
</span></span><span style=display:flex><span>    ✘ create 17.0s
</span></span><span style=display:flex><span>    ! failed to pull image: failed to run command: exit status 1
</span></span><span style=display:flex><span>      ✔ exec docker ps -a --no-trunc --filter name=^/dagger-engine- --format {{.Names}} 0.3s
</span></span><span style=display:flex><span>      ✘ exec docker inspect --type=image registry.dagger.io/engine:v0.13.7 0.0s
</span></span><span style=display:flex><span>      ! failed to run command: exit status 1
</span></span><span style=display:flex><span>      ┃ []                                                                                                                                                                                                       
</span></span><span style=display:flex><span>      ┃ Error response from daemon: No such image: registry.dagger.io/engine:v0.13.7                                                                                                                             
</span></span><span style=display:flex><span>      ✘ exec docker pull registry.dagger.io/engine:v0.13.7 16.7s
</span></span><span style=display:flex><span>      ! failed to run command: exit status 1
</span></span><span style=display:flex><span>      ┃ Error response from daemon: Get &#34;https://registry.dagger.io/v2/&#34;: net/http: request canceled while waiting for connection (Client.Timeout exceeded while awaiting headers)                               
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Error: start engine: failed to pull image: failed to run command: exit status 1
</span></span></code></pre></td></tr></table></div></div><p>错误提示我们拉取不到镜像，很明显是网络问题</p><p>根据以下链接</p><ul><li><a href=https://github.com/dagger/dagger/issues/6275>记录如何在私有 Intranet 中运行 dagger · 问题 #6275 · dagger/dagger &mdash; Document how to run dagger in a private intranet · Issue #6275 · dagger/dagger</a></li><li><a href=https://github.com/dagger/dagger/issues/5240>缺少有关如何在公司代理后面使用 dagger 的文档 · 问题 #5240 · dagger/dagger &mdash; Missing documentation on how to use dagger behind a corporate proxy · Issue #5240 · dagger/dagger</a></li><li><a href=https://github.com/airbytehq/airbyte/issues/25852>支持本地调试远程引擎·问题#25852·airbytehq/airbyte &mdash; Support for debugging remote engines locally · Issue #25852 · airbytehq/airbyte</a></li></ul><p>我们可以得到一个解决方案（文档参见 <a href=https://docs.dagger.io/configuration/custom-runner>Custom Runner | Dagger</a>）</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>export _EXPERIMENTAL_DAGGER_RUNNER_HOST<span style=color:#f92672>=</span>docker-image://ghcr.nju.edu.cn/dagger/engine:v0.13.7
</span></span><span style=display:flex><span>dagger init --sdk<span style=color:#f92672>=</span>go --source<span style=color:#f92672>=</span>./dagger
</span></span></code></pre></td></tr></table></div></div><p>但可能还是会报错</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">68
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plaintext data-lang=plaintext><span style=display:flex><span>✔ connect 7m19.9s
</span></span><span style=display:flex><span>✔ cache request: mkfile /schema.json 0.0s
</span></span><span style=display:flex><span>✔ mkfile /schema.json 0.1s
</span></span><span style=display:flex><span>✔ cache request: blob://sha256:ccfd910d90eb8e37ae8d9131e99f63cec19c582e841db89062a05342514c2165 0.0s
</span></span><span style=display:flex><span>✔ blob://sha256:ccfd910d90eb8e37ae8d9131e99f63cec19c582e841db89062a05342514c2165 0.0s
</span></span><span style=display:flex><span>✔ moduleSource(refString: &#34;.&#34;): ModuleSource! 0.0s
</span></span><span style=display:flex><span>✔ ModuleSource.kind: ModuleSourceKind! 0.0s
</span></span><span style=display:flex><span>✔ ModuleSource.resolveContextPathFromCaller: String! 0.0s
</span></span><span style=display:flex><span>✔ ModuleSource.withName(name: &#34;z_deploy&#34;): ModuleSource! 0.0s
</span></span><span style=display:flex><span>✔ ModuleSource.withSDK(sdk: &#34;go&#34;): ModuleSource! 0.0s
</span></span><span style=display:flex><span>✔ ModuleSource.withInit: ModuleSource! 0.0s
</span></span><span style=display:flex><span>✔ ModuleSource.withSourceSubpath(path: &#34;dagger&#34;): ModuleSource! 0.0s
</span></span><span style=display:flex><span>✔ ModuleSource.resolveFromCaller: ModuleSource! 0.2s
</span></span><span style=display:flex><span>✘ ModuleSource.asModule(engineVersion: &#34;latest&#34;): Module! 45.2s
</span></span><span style=display:flex><span>! failed to create module: select: failed to update codegen and runtime: failed to generate code: failed to get modified source directory for go module sdk codegen: select: process &#34;codegen --output /src --module-context-path /src/z_deploy/dagger --module-name z_deploy --introspection-json-path /schema.json --merge=false&#34; did not complete successfully: exit code: 1
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Error: failed to generate code: input: moduleSource.withContextDirectory.withName.withSDK.withSourceSubpath.withInit.asModule resolve: failed to create module: select: failed to update codegen and runtime: failed to generate code: failed to get modified source directory for go module sdk codegen: select: process &#34;codegen --output /src --module-context-path /src/z_deploy/dagger --module-name z_deploy --introspection-json-path /schema.json --merge=false&#34; did not complete successfully: exit code: 1
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Stdout:
</span></span><span style=display:flex><span>generating go module: z_deploy
</span></span><span style=display:flex><span>creating directory . [skipped]
</span></span><span style=display:flex><span>creating directory z_deploy [skipped]
</span></span><span style=display:flex><span>creating directory z_deploy/dagger [skipped]
</span></span><span style=display:flex><span>writing z_deploy/dagger/dagger.gen.go
</span></span><span style=display:flex><span>writing z_deploy/dagger/go.mod
</span></span><span style=display:flex><span>writing z_deploy/dagger/go.sum
</span></span><span style=display:flex><span>creating directory z_deploy/dagger/internal
</span></span><span style=display:flex><span>creating directory z_deploy/dagger/internal/dagger
</span></span><span style=display:flex><span>writing z_deploy/dagger/internal/dagger/dagger.gen.go
</span></span><span style=display:flex><span>creating directory z_deploy/dagger/internal/querybuilder
</span></span><span style=display:flex><span>writing z_deploy/dagger/internal/querybuilder/marshal.go
</span></span><span style=display:flex><span>writing z_deploy/dagger/internal/querybuilder/querybuilder.go
</span></span><span style=display:flex><span>creating directory z_deploy/dagger/internal/telemetry
</span></span><span style=display:flex><span>writing z_deploy/dagger/internal/telemetry/attrs.go
</span></span><span style=display:flex><span>writing z_deploy/dagger/internal/telemetry/env.go
</span></span><span style=display:flex><span>writing z_deploy/dagger/internal/telemetry/exporters.go
</span></span><span style=display:flex><span>writing z_deploy/dagger/internal/telemetry/init.go
</span></span><span style=display:flex><span>writing z_deploy/dagger/internal/telemetry/live.go
</span></span><span style=display:flex><span>writing z_deploy/dagger/internal/telemetry/logging.go
</span></span><span style=display:flex><span>writing z_deploy/dagger/internal/telemetry/metrics.go
</span></span><span style=display:flex><span>writing z_deploy/dagger/internal/telemetry/proxy.go
</span></span><span style=display:flex><span>writing z_deploy/dagger/internal/telemetry/span.go
</span></span><span style=display:flex><span>writing z_deploy/dagger/internal/telemetry/transform.go
</span></span><span style=display:flex><span>writing z_deploy/dagger/main.go
</span></span><span style=display:flex><span>creating directory z_deploy/dagger/internal [skipped]
</span></span><span style=display:flex><span>creating directory z_deploy/dagger/internal/dagger [skipped]
</span></span><span style=display:flex><span>writing z_deploy/dagger/internal/dagger/dagger.gen.go [skipped]
</span></span><span style=display:flex><span>creating directory z_deploy/dagger/internal/querybuilder [skipped]
</span></span><span style=display:flex><span>writing z_deploy/dagger/internal/querybuilder/marshal.go [skipped]
</span></span><span style=display:flex><span>writing z_deploy/dagger/internal/querybuilder/querybuilder.go [skipped]
</span></span><span style=display:flex><span>creating directory z_deploy/dagger/internal/telemetry [skipped]
</span></span><span style=display:flex><span>writing z_deploy/dagger/internal/telemetry/attrs.go [skipped]
</span></span><span style=display:flex><span>writing z_deploy/dagger/internal/telemetry/env.go [skipped]
</span></span><span style=display:flex><span>writing z_deploy/dagger/internal/telemetry/exporters.go [skipped]
</span></span><span style=display:flex><span>writing z_deploy/dagger/internal/telemetry/init.go [skipped]
</span></span><span style=display:flex><span>writing z_deploy/dagger/internal/telemetry/live.go [skipped]
</span></span><span style=display:flex><span>writing z_deploy/dagger/internal/telemetry/logging.go [skipped]
</span></span><span style=display:flex><span>writing z_deploy/dagger/internal/telemetry/metrics.go [skipped]
</span></span><span style=display:flex><span>writing z_deploy/dagger/internal/telemetry/proxy.go [skipped]
</span></span><span style=display:flex><span>writing z_deploy/dagger/internal/telemetry/span.go [skipped]
</span></span><span style=display:flex><span>writing z_deploy/dagger/internal/telemetry/transform.go [skipped]
</span></span><span style=display:flex><span>running post-command: go mod tidy
</span></span><span style=display:flex><span>post-command failed: exit status 1
</span></span><span style=display:flex><span>Stderr:
</span></span><span style=display:flex><span>go: downloading github.com/stretchr/testify v1.9.0
</span></span><span style=display:flex><span>go: github.com/go-logr/stdr@v1.2.2 requires
</span></span><span style=display:flex><span>        github.com/go-logr/logr@v1.2.2: Get &#34;https://proxy.golang.org/github.com/go-logr/logr/@v/v1.2.2.mod&#34;: dial tcp 142.250.217.113:443: i/o timeout
</span></span><span style=display:flex><span>Error: exit status 1
</span></span></code></pre></td></tr></table></div></div><p>我搜索了一下，在这里找到了方案</p><ul><li><a href=https://github.com/dagger/dagger/issues/6599>🐞 Dagger 模块在企业环境中崩溃 · Issue #6599 · dagger/dagger &mdash; 🐞 Dagger modules break in corporate environments · Issue #6599 · dagger/dagger</a></li><li><a href=https://github.com/dagger/dagger/pull/7255>engine: support for system proxy settings by sipsma · Pull Request #7255 · dagger/dagger</a></li></ul><p>我们可以设置 <code>_DAGGER_ENGINE_SYSTEMENV_GOPROXY</code>​ 环境变量，让我们试试</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>export _DAGGER_ENGINE_SYSTEMENV_GOPROXY<span style=color:#f92672>=</span>https://goproxy.cn,direct
</span></span><span style=display:flex><span><span style=color:#75715e># 使用 -vvv 打印更丰富的日志</span>
</span></span><span style=display:flex><span>dagger init --sdk<span style=color:#f92672>=</span>go --source<span style=color:#f92672>=</span>./dagger -vvv
</span></span></code></pre></td></tr></table></div></div><p>我们会发现还是报同样的错误，我在 <a href=https://github.com/dagger/dagger/issues/6599#issuecomment-2455461588>🐞 Dagger 模块在企业环境中崩溃 · Issue #6599 · dagger/dagger &mdash; 🐞 Dagger modules break in corporate environments · Issue #6599 · dagger/dagger</a> 问了下大家，发现这个环境变量并不是作用于客户端，而是引擎。</p><p>通过我们上面 <code>-vvv</code>​ 可以看到实际调用的 <code>docker run</code>​ 命令是</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker run --name dagger-engine-v0.13.7 -d --restart always -v /var/lib/dagger --privileged ghcr.nju.edu.cn/dagger/engine:v0.13.7 --debug
</span></span></code></pre></td></tr></table></div></div><p>所以最终的处理方案是</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>export _EXPERIMENTAL_DAGGER_RUNNER_HOST<span style=color:#f92672>=</span>docker-image://ghcr.nju.edu.cn/dagger/engine:v0.13.7
</span></span><span style=display:flex><span>docker run --name dagger-engine-v0.13.7 -d --restart always -v /var/lib/dagger -e _DAGGER_ENGINE_SYSTEMENV_GOPROXY<span style=color:#f92672>=</span>https://goproxy.cn,direct --privileged ghcr.nju.edu.cn/dagger/engine:v0.13.7 --debug
</span></span><span style=display:flex><span>dagger init --sdk<span style=color:#f92672>=</span>go --source<span style=color:#f92672>=</span>./dagger -vvv
</span></span></code></pre></td></tr></table></div></div><p>将 <code>_EXPERIMENTAL_DAGGER_RUNNER_HOST</code>​ 设置为 <code>docker-image://ghcr.nju.edu.cn/dagger/engine:v0.13.7</code>​ 将会指示 dagger 客户端查找当前是否有对应镜像的容器正在运行，如果没有，则按照内置的命令创建一个。或者你也可以使用 <code>docker-container://dagger-engine-v0.13.7</code>​ 直接指定容器。</p><h2 id=使用样例>使用样例<a hidden class=anchor aria-hidden=true href=#使用样例>#</a></h2><p>这里给出一个使用样例，我们希望有的功能清单为</p><ul><li>编译出二进制</li><li>编译多架构 Docker 镜像并推送到远端</li></ul><h3 id=目录结构>目录结构<a hidden class=anchor aria-hidden=true href=#目录结构>#</a></h3><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plaintext data-lang=plaintext><span style=display:flex><span>.
</span></span><span style=display:flex><span>├── dagger.json
</span></span><span style=display:flex><span>├── dagger
</span></span><span style=display:flex><span>│   ├── ...
</span></span><span style=display:flex><span>│   └── main.go
</span></span><span style=display:flex><span>├── .goreleaser.yaml
</span></span><span style=display:flex><span>├── makefile
</span></span><span style=display:flex><span>├── go.mod
</span></span><span style=display:flex><span>└── go.sum
</span></span></code></pre></td></tr></table></div></div><h3 id=文件内容>文件内容<a hidden class=anchor aria-hidden=true href=#文件内容>#</a></h3><h4 id=daggermaingo>dagger/main.go<a hidden class=anchor aria-hidden=true href=#daggermaingo>#</a></h4><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 77
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 78
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 79
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 80
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 81
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 82
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 83
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 84
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 85
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 86
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 87
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 88
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 89
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 90
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 91
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 92
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 93
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 94
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 95
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 96
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 97
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 98
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 99
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">100
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">101
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">102
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">103
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">104
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">105
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">106
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">107
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">108
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">109
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">110
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">111
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">112
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">113
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">114
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">115
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">116
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">117
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">118
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">119
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">120
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">121
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">122
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">123
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">124
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">125
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">126
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">127
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;context&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;strings&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;time&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;dagger/peien-engine/internal/dagger&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>MyEngine</span> <span style=color:#66d9ef>struct</span>{}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>m</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>MyEngine</span>) <span style=color:#a6e22e>joinCommands</span>(<span style=color:#a6e22e>cmds</span> []<span style=color:#66d9ef>string</span>) <span style=color:#66d9ef>string</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>Join</span>(<span style=color:#a6e22e>cmds</span>, <span style=color:#e6db74>&#34; &amp;&amp; &#34;</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>m</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>MyEngine</span>) <span style=color:#a6e22e>BuildApp</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>src</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>dagger</span>.<span style=color:#a6e22e>Directory</span>, <span style=color:#a6e22e>token</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>dagger</span>.<span style=color:#a6e22e>Secret</span>) <span style=color:#f92672>*</span><span style=color:#a6e22e>dagger</span>.<span style=color:#a6e22e>Container</span> {
</span></span><span style=display:flex><span>	<span style=color:#75715e>// build app</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>builder</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>dag</span>.<span style=color:#a6e22e>Container</span>().
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>From</span>(<span style=color:#e6db74>&#34;golang:1.22-bullseye&#34;</span>).
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>WithSecretVariable</span>(<span style=color:#e6db74>&#34;GITEA_TOKEN&#34;</span>, <span style=color:#a6e22e>token</span>).
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>WithWorkdir</span>(<span style=color:#e6db74>&#34;/src&#34;</span>).
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>WithMountedCache</span>(<span style=color:#e6db74>&#34;/go/pkg/mod&#34;</span>, <span style=color:#a6e22e>dag</span>.<span style=color:#a6e22e>CacheVolume</span>(<span style=color:#e6db74>&#34;go-mod&#34;</span>)).
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>WithEnvVariable</span>(<span style=color:#e6db74>&#34;GOMODCACHE&#34;</span>, <span style=color:#e6db74>&#34;/go/pkg/mod&#34;</span>).
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>WithMountedCache</span>(<span style=color:#e6db74>&#34;/go/build-cache&#34;</span>, <span style=color:#a6e22e>dag</span>.<span style=color:#a6e22e>CacheVolume</span>(<span style=color:#e6db74>&#34;go-build&#34;</span>)).
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>WithEnvVariable</span>(<span style=color:#e6db74>&#34;GOCACHE&#34;</span>, <span style=color:#e6db74>&#34;/go/build-cache&#34;</span>).
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>WithEnvVariable</span>(<span style=color:#e6db74>&#34;CGO_ENABLED&#34;</span>, <span style=color:#e6db74>&#34;0&#34;</span>).
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>WithEnvVariable</span>(<span style=color:#e6db74>&#34;GOPROXY&#34;</span>, <span style=color:#e6db74>&#34;https://goproxy.cn,direct&#34;</span>).
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>WithEnvVariable</span>(<span style=color:#e6db74>&#34;GOINSECURE&#34;</span>, <span style=color:#e6db74>&#34;gitprivate.com&#34;</span>).
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>WithEnvVariable</span>(<span style=color:#e6db74>&#34;GOPRIVATE&#34;</span>, <span style=color:#e6db74>&#34;gitprivate.com&#34;</span>).
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>WithExec</span>([]<span style=color:#66d9ef>string</span>{<span style=color:#e6db74>&#34;sh&#34;</span>, <span style=color:#e6db74>&#34;-c&#34;</span>, <span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>joinCommands</span>([]<span style=color:#66d9ef>string</span>{
</span></span><span style=display:flex><span>			<span style=color:#e6db74>&#34;curl -L -o goreleaser_Linux_x86_64.tar.gz https://files.m.daocloud.io/github.com/goreleaser/goreleaser/releases/download/v2.3.2/goreleaser_Linux_x86_64.tar.gz&#34;</span>,
</span></span><span style=display:flex><span>			<span style=color:#e6db74>&#34;tar -xzvf goreleaser_Linux_x86_64.tar.gz -C /usr/local/bin goreleaser&#34;</span>,
</span></span><span style=display:flex><span>			<span style=color:#e6db74>&#34;chmod +x /usr/local/bin/goreleaser&#34;</span>,
</span></span><span style=display:flex><span>			<span style=color:#e6db74>&#34;rm -rf goreleaser_Linux_x86_64.tar.gz&#34;</span>,
</span></span><span style=display:flex><span>		})}).
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>WithExec</span>([]<span style=color:#66d9ef>string</span>{<span style=color:#e6db74>&#34;sh&#34;</span>, <span style=color:#e6db74>&#34;-c&#34;</span>, <span style=color:#e6db74>`git config --global url.&#34;http://${GITEA_TOKEN}@gitprivate.com&#34;.insteadOf &#34;http://gitprivate.com&#34;`</span>}).
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>WithDirectory</span>(<span style=color:#e6db74>&#34;/src&#34;</span>, <span style=color:#a6e22e>src</span>).
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>WithExec</span>([]<span style=color:#66d9ef>string</span>{<span style=color:#e6db74>&#34;sh&#34;</span>, <span style=color:#e6db74>&#34;-c&#34;</span>, <span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>joinCommands</span>([]<span style=color:#66d9ef>string</span>{
</span></span><span style=display:flex><span>			<span style=color:#e6db74>&#34;goreleaser build --skip=validate --clean&#34;</span>,
</span></span><span style=display:flex><span>			<span style=color:#e6db74>&#34;mv dist/my-engine_linux_amd64_v1 dist/my-engine_linux_amd64&#34;</span>,
</span></span><span style=display:flex><span>		})})
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>builder</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>m</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>MyEngine</span>) <span style=color:#a6e22e>buildImage</span>(<span style=color:#a6e22e>platform</span> <span style=color:#a6e22e>dagger</span>.<span style=color:#a6e22e>Platform</span>, <span style=color:#a6e22e>src</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>dagger</span>.<span style=color:#a6e22e>Directory</span>, <span style=color:#a6e22e>appName</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>version</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>builder</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>dagger</span>.<span style=color:#a6e22e>Container</span>) <span style=color:#f92672>*</span><span style=color:#a6e22e>dagger</span>.<span style=color:#a6e22e>Container</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>osArch</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>Split</span>(string(<span style=color:#a6e22e>platform</span>), <span style=color:#e6db74>&#34;/&#34;</span>)[<span style=color:#ae81ff>1</span>]
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ctr</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>dag</span>.<span style=color:#a6e22e>Container</span>(<span style=color:#a6e22e>dagger</span>.<span style=color:#a6e22e>ContainerOpts</span>{<span style=color:#a6e22e>Platform</span>: <span style=color:#a6e22e>platform</span>}).
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>From</span>(<span style=color:#e6db74>&#34;debian:bullseye-slim&#34;</span>).
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>WithLabel</span>(<span style=color:#e6db74>&#34;org.opencontainers.image.version&#34;</span>, <span style=color:#a6e22e>version</span>).
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>WithLabel</span>(<span style=color:#e6db74>&#34;org.opencontainers.image.created&#34;</span>, <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Now</span>().<span style=color:#a6e22e>String</span>()).
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>WithWorkdir</span>(<span style=color:#e6db74>&#34;/app&#34;</span>).
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>WithEnvVariable</span>(<span style=color:#e6db74>&#34;TZ&#34;</span>, <span style=color:#e6db74>&#34;Asia/Shanghai&#34;</span>).
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>WithExec</span>([]<span style=color:#66d9ef>string</span>{<span style=color:#e6db74>&#34;sh&#34;</span>, <span style=color:#e6db74>&#34;-c&#34;</span>, <span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>joinCommands</span>([]<span style=color:#66d9ef>string</span>{
</span></span><span style=display:flex><span>			<span style=color:#e6db74>&#34;sed -i &#39;s|http://deb.debian.org/debian|http://mirror.sjtu.edu.cn/debian|g&#39; /etc/apt/sources.list&#34;</span>,
</span></span><span style=display:flex><span>			<span style=color:#e6db74>&#34;sed -i &#39;/security.debian.org/d&#39; /etc/apt/sources.list&#34;</span>,
</span></span><span style=display:flex><span>			<span style=color:#e6db74>&#34;apt-get update&#34;</span>,
</span></span><span style=display:flex><span>			<span style=color:#e6db74>&#34;apt-get -qq install -y --no-install-recommends ca-certificates curl openssl firefox-esr firefox-esr-l10n-zh-cn wget fontconfig&#34;</span>,
</span></span><span style=display:flex><span>			<span style=color:#75715e>// 清理 apt 缓存</span>
</span></span><span style=display:flex><span>			<span style=color:#e6db74>&#34;apt-get clean -y&#34;</span>,
</span></span><span style=display:flex><span>			<span style=color:#e6db74>&#34;rm -rf /var/lib/apt/lists/*&#34;</span>,
</span></span><span style=display:flex><span>		})}).
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>WithFile</span>(<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;/app/%s&#34;</span>, <span style=color:#a6e22e>appName</span>), <span style=color:#a6e22e>builder</span>.<span style=color:#a6e22e>File</span>(<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;/src/dist/%s_linux_%s/%s&#34;</span>, <span style=color:#a6e22e>appName</span>, <span style=color:#a6e22e>osArch</span>, <span style=color:#a6e22e>appName</span>))).
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>WithEntrypoint</span>([]<span style=color:#66d9ef>string</span>{<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;/app/%s&#34;</span>, <span style=color:#a6e22e>appName</span>)})
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>ctr</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>m</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>MyEngine</span>) <span style=color:#a6e22e>BuildOneImage</span>(
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>,
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>src</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>dagger</span>.<span style=color:#a6e22e>Directory</span>,
</span></span><span style=display:flex><span>	<span style=color:#75715e>// GITEA TOKEN</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>token</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>dagger</span>.<span style=color:#a6e22e>Secret</span>,
</span></span><span style=display:flex><span>	<span style=color:#75715e>// +optional</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// +default=&#34;&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>imageName</span> <span style=color:#66d9ef>string</span>,
</span></span><span style=display:flex><span>	<span style=color:#75715e>// +optional</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// +default=&#34;unknown&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>version</span> <span style=color:#66d9ef>string</span>,
</span></span><span style=display:flex><span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>dagger</span>.<span style=color:#a6e22e>Container</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>builder</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>BuildApp</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>src</span>, <span style=color:#a6e22e>token</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>appName</span> <span style=color:#f92672>:=</span> <span style=color:#e6db74>&#34;my-engine&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ctr</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>buildImage</span>(<span style=color:#e6db74>&#34;linux/amd64&#34;</span>, <span style=color:#a6e22e>src</span>, <span style=color:#a6e22e>appName</span>, <span style=color:#a6e22e>version</span>, <span style=color:#a6e22e>builder</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>imageName</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;&#34;</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>imageName</span> = <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;docker-registry.com/akkuman/%s:easm-dev&#34;</span>, <span style=color:#a6e22e>appName</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ctr</span> = <span style=color:#a6e22e>ctr</span>.<span style=color:#a6e22e>WithAnnotation</span>(<span style=color:#e6db74>&#34;io.containerd.image.name&#34;</span>, <span style=color:#a6e22e>imageName</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>ctr</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>m</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>MyEngine</span>) <span style=color:#a6e22e>BuildAllImagePublish</span>(
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>,
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>src</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>dagger</span>.<span style=color:#a6e22e>Directory</span>,
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>token</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>dagger</span>.<span style=color:#a6e22e>Secret</span>,
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>version</span> <span style=color:#66d9ef>string</span>,
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>registryUser</span> <span style=color:#66d9ef>string</span>,
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>registryPass</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>dagger</span>.<span style=color:#a6e22e>Secret</span>,
</span></span><span style=display:flex><span>) ([]<span style=color:#66d9ef>string</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>builder</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>BuildApp</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>src</span>, <span style=color:#a6e22e>token</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>platforms</span> = []<span style=color:#a6e22e>dagger</span>.<span style=color:#a6e22e>Platform</span>{
</span></span><span style=display:flex><span>		<span style=color:#e6db74>&#34;linux/amd64&#34;</span>, <span style=color:#75715e>// a.k.a. x86_64</span>
</span></span><span style=display:flex><span>		<span style=color:#e6db74>&#34;linux/arm64&#34;</span>, <span style=color:#75715e>// a.k.a. aarch64</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>imageRepos</span> []<span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>appName</span> <span style=color:#f92672>:=</span> <span style=color:#e6db74>&#34;my-engine&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>platformVariants</span> <span style=color:#f92672>:=</span> make([]<span style=color:#f92672>*</span><span style=color:#a6e22e>dagger</span>.<span style=color:#a6e22e>Container</span>, <span style=color:#ae81ff>0</span>, len(<span style=color:#a6e22e>platforms</span>))
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>platform</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>platforms</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>ctr</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>buildImage</span>(<span style=color:#a6e22e>platform</span>, <span style=color:#a6e22e>src</span>, <span style=color:#a6e22e>appName</span>, <span style=color:#a6e22e>version</span>, <span style=color:#a6e22e>builder</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>platformVariants</span> = append(<span style=color:#a6e22e>platformVariants</span>, <span style=color:#a6e22e>ctr</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>imageRepo</span> <span style=color:#f92672>:=</span> []<span style=color:#66d9ef>string</span>{
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;docker-registry.com/akkuman/%s:latest&#34;</span>, <span style=color:#a6e22e>appName</span>),
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;docker-registry.com/akkuman/%s:%s&#34;</span>, <span style=color:#a6e22e>appName</span>, <span style=color:#a6e22e>version</span>),
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>repoAddr</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>imageRepo</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>addr</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>dag</span>.<span style=color:#a6e22e>Container</span>().<span style=color:#a6e22e>WithRegistryAuth</span>(<span style=color:#e6db74>&#34;docker-registry.com/&#34;</span>, <span style=color:#a6e22e>registryUser</span>, <span style=color:#a6e22e>registryPass</span>).<span style=color:#a6e22e>Publish</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>repoAddr</span>, <span style=color:#a6e22e>dagger</span>.<span style=color:#a6e22e>ContainerPublishOpts</span>{
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>PlatformVariants</span>: <span style=color:#a6e22e>platformVariants</span>,
</span></span><span style=display:flex><span>		})
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>imageRepos</span> = append(<span style=color:#a6e22e>imageRepos</span>, <span style=color:#a6e22e>addr</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>imageRepos</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h4 id=makefile>makefile<a hidden class=anchor aria-hidden=true href=#makefile>#</a></h4><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-makefile data-lang=makefile><span style=display:flex><span><span style=color:#a6e22e>build</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>	goreleaser build --skip<span style=color:#f92672>=</span>validate --clean
</span></span><span style=display:flex><span><span style=color:#a6e22e>dagger-build</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e># 编译后可在 dist 目录下查看</span>
</span></span><span style=display:flex><span>	dagger call build-app --src<span style=color:#f92672>=</span>. --token<span style=color:#f92672>=</span>env:GITEA_TOKEN directory --path<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;/src/dist&#34;</span> export --path<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;./dist&#34;</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>image-build-export</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e># 构建 amd64 镜像并导出到 my-engine.tgz</span>
</span></span><span style=display:flex><span>	dagger call build-one-image --src<span style=color:#f92672>=</span>. --token<span style=color:#f92672>=</span>env:GITEA_TOKEN export --path<span style=color:#f92672>=</span>my-engine.tgz
</span></span><span style=display:flex><span><span style=color:#a6e22e>build-all-publish</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e># 构建多架构镜像并推送</span>
</span></span><span style=display:flex><span>	dagger call build-all-image-publish --src<span style=color:#f92672>=</span>. --token<span style=color:#f92672>=</span>env:GITEA_TOKEN --version<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span>$GIT_TAG<span style=color:#e6db74>&#34;</span> --registry-user<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span>$DOCKER_USERNAME<span style=color:#e6db74>&#34;</span> --registry-pass<span style=color:#f92672>=</span>env:DOCKER_PASSWORD
</span></span></code></pre></td></tr></table></div></div><h2 id=一些-tips>一些 Tips<a hidden class=anchor aria-hidden=true href=#一些-tips>#</a></h2><h3 id=dagger-cli-某些功能可以和代码等同>Dagger CLI 某些功能可以和代码等同<a hidden class=anchor aria-hidden=true href=#dagger-cli-某些功能可以和代码等同>#</a></h3><p>拿 Golang 编译然后导出到本地目录做演示</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;context&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;strings&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;time&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;dagger/peien-engine/internal/dagger&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>PeienEngine</span> <span style=color:#66d9ef>struct</span>{}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>m</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>PeienEngine</span>) <span style=color:#a6e22e>joinCommands</span>(<span style=color:#a6e22e>cmds</span> []<span style=color:#66d9ef>string</span>) <span style=color:#66d9ef>string</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>Join</span>(<span style=color:#a6e22e>cmds</span>, <span style=color:#e6db74>&#34; &amp;&amp; &#34;</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>m</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>PeienEngine</span>) <span style=color:#a6e22e>BuildApp</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>src</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>dagger</span>.<span style=color:#a6e22e>Directory</span>, <span style=color:#a6e22e>token</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>dagger</span>.<span style=color:#a6e22e>Secret</span>) <span style=color:#f92672>*</span><span style=color:#a6e22e>dagger</span>.<span style=color:#a6e22e>Container</span> {
</span></span><span style=display:flex><span>	<span style=color:#75715e>// build app</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>builder</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>dag</span>.<span style=color:#a6e22e>Container</span>().
</span></span><span style=display:flex><span>		<span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>WithExec</span>([]<span style=color:#66d9ef>string</span>{<span style=color:#e6db74>&#34;sh&#34;</span>, <span style=color:#e6db74>&#34;-c&#34;</span>, <span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>joinCommands</span>([]<span style=color:#66d9ef>string</span>{
</span></span><span style=display:flex><span>			<span style=color:#e6db74>&#34;goreleaser build --skip=validate --clean&#34;</span>,
</span></span><span style=display:flex><span>			<span style=color:#e6db74>&#34;mv dist/engine_linux_amd64_v1 dist/engine_linux_amd64&#34;</span>,
</span></span><span style=display:flex><span>		})})
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>builder</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><ol><li><p>可以使用如下命令导出编译产物</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 编译后可在 dist 目录下查看</span>
</span></span><span style=display:flex><span>dagger call build-app --src<span style=color:#f92672>=</span>. --token<span style=color:#f92672>=</span>env:GITEA_TOKEN directory --path<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;/src/dist&#34;</span> export --path<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;./dist&#34;</span>
</span></span></code></pre></td></tr></table></div></div></li><li><p>也可以新建一个函数</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>m</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>PeienEngine</span>) <span style=color:#a6e22e>BuildAndExport</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>src</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>dagger</span>.<span style=color:#a6e22e>Directory</span>, <span style=color:#a6e22e>token</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>dagger</span>.<span style=color:#a6e22e>Secret</span>) (<span style=color:#66d9ef>string</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>BuildApp</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>src</span>, <span style=color:#a6e22e>token</span>).<span style=color:#a6e22e>Directory</span>(<span style=color:#e6db74>&#34;/src/dist&#34;</span>).<span style=color:#a6e22e>Export</span>(<span style=color:#e6db74>&#34;./dist&#34;</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>然后执行命令 <code>dagger call build-and-export --src=. --token=env:GITEA_TOKEN</code>​</p></li></ol><h3 id=withexec-不会合并成一层>WithExec 不会合并成一层<a hidden class=anchor aria-hidden=true href=#withexec-不会合并成一层>#</a></h3><p>我们写 Dockerfile 的时候，常常为了体积考虑，会把几行命令写成一行，比如上面的</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#66d9ef>RUN</span> goreleaser build --skip<span style=color:#f92672>=</span>validate --clean <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>	mv dist/engine_linux_amd64_v1 dist/engine_linux_amd64<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></td></tr></table></div></div><p>如果写成两行的话，则编译出来会占用编译产物的所有体积，然后下面的 <code>mv</code>​ 又会占用一次体积。</p><p>而 Dagger 官方示例中处处都是类似下面这种</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>...</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>WithExec</span>([]<span style=color:#66d9ef>string</span>{<span style=color:#e6db74>&#34;goreleaser&#34;</span>, <span style=color:#e6db74>&#34;build&#34;</span>, <span style=color:#e6db74>&#34;--skip=validate&#34;</span>, <span style=color:#e6db74>&#34;--clean&#34;</span>}).
</span></span><span style=display:flex><span><span style=color:#a6e22e>WithExec</span>([]<span style=color:#66d9ef>string</span>{<span style=color:#e6db74>&#34;mv&#34;</span>, <span style=color:#e6db74>&#34;dist/engine_linux_amd64_v1&#34;</span>, <span style=color:#e6db74>&#34;dist/engine_linux_amd64&#34;</span>})
</span></span></code></pre></td></tr></table></div></div><p>最开始我以为既然官方示例这么写，那应该会自动合并，但是我使用 <a href=https://github.com/wagoodman/dive>dive</a> 查看后，发现并没有合并，上面这种写法基本等同下面两行 <code>RUN</code>​</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#66d9ef>RUN</span> goreleaser build --skip<span style=color:#f92672>=</span>validate --clean<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> mv dist/engine_linux_amd64_v1 dist/engine_linux_amd64<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></td></tr></table></div></div><p>所以需要合并的，最好使用 <code>sh -c</code>​ 来合并，例如</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>WithExec</span>([]<span style=color:#66d9ef>string</span>{<span style=color:#e6db74>&#34;sh&#34;</span>, <span style=color:#e6db74>&#34;-c&#34;</span>,<span style=color:#e6db74>&#34;goreleaser build --skip=validate --clean &amp;&amp; mv dist/engine_linux_amd64_v1 dist/engine_linux_amd64&#34;</span>)})
</span></span></code></pre></td></tr></table></div></div><h3 id=操作是有序的>操作是有序的<a hidden class=anchor aria-hidden=true href=#操作是有序的>#</a></h3><p>可能我们会看到很多 WithX 操作，比如</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>builder</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>dag</span>.<span style=color:#a6e22e>Container</span>().
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>From</span>(<span style=color:#e6db74>&#34;golang:1.22-bullseye&#34;</span>).
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>WithSecretVariable</span>(<span style=color:#e6db74>&#34;GITEA_TOKEN&#34;</span>, <span style=color:#a6e22e>token</span>).
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>WithWorkdir</span>(<span style=color:#e6db74>&#34;/src&#34;</span>).
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>WithMountedCache</span>(<span style=color:#e6db74>&#34;/go/pkg/mod&#34;</span>, <span style=color:#a6e22e>dag</span>.<span style=color:#a6e22e>CacheVolume</span>(<span style=color:#e6db74>&#34;go-mod&#34;</span>)).
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>WithEnvVariable</span>(<span style=color:#e6db74>&#34;GOMODCACHE&#34;</span>, <span style=color:#e6db74>&#34;/go/pkg/mod&#34;</span>).
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>WithMountedCache</span>(<span style=color:#e6db74>&#34;/go/build-cache&#34;</span>, <span style=color:#a6e22e>dag</span>.<span style=color:#a6e22e>CacheVolume</span>(<span style=color:#e6db74>&#34;go-build&#34;</span>)).
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>WithEnvVariable</span>(<span style=color:#e6db74>&#34;GOCACHE&#34;</span>, <span style=color:#e6db74>&#34;/go/build-cache&#34;</span>).
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>WithEnvVariable</span>(<span style=color:#e6db74>&#34;CGO_ENABLED&#34;</span>, <span style=color:#e6db74>&#34;0&#34;</span>).
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>WithEnvVariable</span>(<span style=color:#e6db74>&#34;GOPROXY&#34;</span>, <span style=color:#e6db74>&#34;https://goproxy.cn,direct&#34;</span>).
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>WithExec</span>([]<span style=color:#66d9ef>string</span>{<span style=color:#e6db74>&#34;sh&#34;</span>, <span style=color:#e6db74>&#34;-c&#34;</span>, <span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>joinCommands</span>([]<span style=color:#66d9ef>string</span>{
</span></span><span style=display:flex><span>			<span style=color:#e6db74>&#34;curl -L -o goreleaser_Linux_x86_64.tar.gz https://github.com/goreleaser/goreleaser/releases/download/v2.3.2/goreleaser_Linux_x86_64.tar.gz&#34;</span>,
</span></span><span style=display:flex><span>			<span style=color:#e6db74>&#34;tar -xzvf goreleaser_Linux_x86_64.tar.gz -C /usr/local/bin goreleaser&#34;</span>,
</span></span><span style=display:flex><span>			<span style=color:#e6db74>&#34;chmod +x /usr/local/bin/goreleaser&#34;</span>,
</span></span><span style=display:flex><span>			<span style=color:#e6db74>&#34;rm -rf goreleaser_Linux_x86_64.tar.gz&#34;</span>,
</span></span><span style=display:flex><span>		})}).
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>WithDirectory</span>(<span style=color:#e6db74>&#34;/src&#34;</span>, <span style=color:#a6e22e>src</span>).
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>WithExec</span>([]<span style=color:#66d9ef>string</span>{<span style=color:#e6db74>&#34;sh&#34;</span>, <span style=color:#e6db74>&#34;-c&#34;</span>, <span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>joinCommands</span>([]<span style=color:#66d9ef>string</span>{
</span></span><span style=display:flex><span>			<span style=color:#e6db74>&#34;goreleaser build --skip=validate --clean&#34;</span>,
</span></span><span style=display:flex><span>			<span style=color:#e6db74>&#34;mv dist/peien-engine_linux_amd64_v1 dist/peien-engine_linux_amd64&#34;</span>,
</span></span><span style=display:flex><span>			<span style=color:#e6db74>&#34;mv dist/peien-node_linux_amd64_v1 dist/peien-node_linux_amd64&#34;</span>,
</span></span><span style=display:flex><span>		})})
</span></span></code></pre></td></tr></table></div></div><p>需要注意这些操作都是有序的，比如官方很多样例把 <code>WithDirectory("/src", src)</code>​ 放在最前面，就导致任何一点变动都会影响后续所有流程，正确的方法是放在编译前，就和我们平时写 Dockerfile 考虑的层级构造一样，是有序的，变动多的往后放。</p><h3 id=dagger-开发环境恢复>Dagger 开发环境恢复<a hidden class=anchor aria-hidden=true href=#dagger-开发环境恢复>#</a></h3><p>TLDR: <code>dagger develop</code>​ 即可安装 SDK</p><p>当我们使用 <code>init</code>​ 创建一个 Dagger 流程后，会发现它生成的文件夹里面排除了生成的 sdk，参见以下 <code>.gitignore</code>​ 示例</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plaintext data-lang=plaintext><span style=display:flex><span>/dagger.gen.go
</span></span><span style=display:flex><span>/internal/dagger
</span></span><span style=display:flex><span>/internal/querybuilder
</span></span><span style=display:flex><span>/internal/telemetry
</span></span></code></pre></td></tr></table></div></div><p>也就是这些文件不会签入 git 仓库，和其他人协作开发时，这些文件不会同步，虽说这对于 Dagger 各种命令的运行不影响（Dagger内部会构建环境），这些文件是供我们开发 Dagger 流程的。</p><p>我们可以使用命令 <code>dagger develop</code>​ 来生成这些 SDK 文件，这个命令会找到项目下面生成的 dagger.json 文件，然后根据里面的配置在对应的文件夹生成 SDK</p><p>以上说明可参见</p><ul><li><a href=https://github.com/dagger/dagger/issues/7964>✨ Cannot update SDK when using newer version of Dagger · Issue #7964 · dagger/dagger</a></li><li><a href=https://docs.dagger.io/reference/cli/#dagger-develop>CLI Reference | Dagger</a></li></ul><h3 id=daggergengo-报错>dagger.gen.go 报错<a hidden class=anchor aria-hidden=true href=#daggergengo-报错>#</a></h3><p>有时候你想改变 <code>main.go</code>​ 的导出函数名称，会看到类似这样的报错</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plaintext data-lang=plaintext><span style=display:flex><span>(*PeienEngine).BuildOneImage undefined (type *PeienEngine has no field or method BuildOneImage)
</span></span></code></pre></td></tr></table></div></div><p>此时你需要使用上面提到的 <code>dagger develop</code>​ 来重新生成 <code>dagger.gen.go</code>​</p><p>不过不运行也没关系，就是 IDE 或编辑器会有错误提示而已，实际运行不影响</p><h3 id=导出镜像-tarball-设置镜像tag>导出镜像 tarball 设置镜像tag<a hidden class=anchor aria-hidden=true href=#导出镜像-tarball-设置镜像tag>#</a></h3><p>问题描述：使用 export 导出的镜像 tarball 是没有 tag 的</p><p>解决方案：添加 <code>io.containerd.image.name</code>​ 的 <code>annotation</code>​ 即可，代码示例如下</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>...</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>builder</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>dag</span>.<span style=color:#a6e22e>Container</span>().
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>From</span>(<span style=color:#e6db74>&#34;golang:1.22-bullseye&#34;</span>).
</span></span><span style=display:flex><span>		<span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>WithAnnotation</span>(<span style=color:#e6db74>&#34;io.containerd.image.name&#34;</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;akkuman/testapp:%s&#34;</span>, <span style=color:#a6e22e>version</span>))
</span></span><span style=display:flex><span><span style=color:#f92672>...</span>
</span></span></code></pre></td></tr></table></div></div><p>其中 <code>WithAnnotation("io.containerd.image.name", fmt.Sprintf("akkuman/testapp:%s", version))</code>​ 将会设置镜像 tag</p><p>相关 issue:</p><ul><li><a href=https://github.com/dagger/dagger/issues/7368>✨ <code>.AsTarball</code> Add OCI manifest RepoTags · Issue #7368 · dagger/dagger</a></li><li><a href=https://github.com/dagger/dagger/issues/6999>[Container.Export] Support custom annotations for exporting oci tar. · Issue #6999 · dagger/dagger</a></li><li><a href=https://github.com/dagger/dagger/issues/8025#issuecomment-2250667221>✨ Import image to local container runtime · Issue #8025 · dagger/dagger</a></li></ul><h3 id=dockerignore-不起效>.dockerignore 不起效<a hidden class=anchor aria-hidden=true href=#dockerignore-不起效>#</a></h3><p>我们知道，Docker 构建时可以使用 .dockerignore 来排除一些文件的导入，但似乎 Dagger 不会依照 .dockerignore</p><p>查阅文档 <a href=https://docs.dagger.io/api/filters/>Directory Filters | Dagger</a>，发现需要指定</p><p>例如</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;context&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;dagger/my-module/internal/dagger&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>MyModule</span> <span style=color:#66d9ef>struct</span>{}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>m</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>MyModule</span>) <span style=color:#a6e22e>Foo</span>(
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>,
</span></span><span style=display:flex><span>	<span style=color:#75715e>// +ignore=[&#34;.git&#34;, &#34;**/.gitignore&#34;]</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>source</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>dagger</span>.<span style=color:#a6e22e>Directory</span>,
</span></span><span style=display:flex><span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>dagger</span>.<span style=color:#a6e22e>Container</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>dag</span>.<span style=color:#a6e22e>Container</span>().
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>From</span>(<span style=color:#e6db74>&#34;alpine:latest&#34;</span>).
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>WithDirectory</span>(<span style=color:#e6db74>&#34;/src&#34;</span>, <span style=color:#a6e22e>source</span>).
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Sync</span>(<span style=color:#a6e22e>ctx</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>可以查看其中的 <code>+ignore</code>​，详情参阅 <a href=https://docs.dagger.io/api/filters/>Directory Filters | Dagger</a></p><h3 id=如何限制某个参数是特定选项值>如何限制某个参数是特定选项值<a hidden class=anchor aria-hidden=true href=#如何限制某个参数是特定选项值>#</a></h3><p>这是一个类似枚举的需求，如果没有仔细查阅文档，可能会这样做</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>m</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>MyApp</span>) <span style=color:#a6e22e>BuildOneImage</span>(
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>,
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>src</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>dagger</span>.<span style=color:#a6e22e>Directory</span>,
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>appTag</span> <span style=color:#66d9ef>string</span>,
</span></span><span style=display:flex><span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>dagger</span>.<span style=color:#a6e22e>Container</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>appTag</span> <span style=color:#f92672>!=</span> <span style=color:#e6db74>&#34;engine&#34;</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>appTag</span> <span style=color:#f92672>!=</span> <span style=color:#e6db74>&#34;node&#34;</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;appTag 必须为 engine 或者 node&#34;</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>但实际上 Dagger 支持枚举，可以改成</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>AppTag</span> <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> (
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>EngineAppTag</span> <span style=color:#a6e22e>AppTag</span> = <span style=color:#e6db74>&#34;engine&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>NodeAppTag</span> <span style=color:#a6e22e>AppTag</span> = <span style=color:#e6db74>&#34;node&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>m</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>MyApp</span>) <span style=color:#a6e22e>BuildOneImage</span>(
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>,
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>src</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>dagger</span>.<span style=color:#a6e22e>Directory</span>,
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>appTag</span> <span style=color:#a6e22e>AppTag</span>,
</span></span><span style=display:flex><span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>dagger</span>.<span style=color:#a6e22e>Container</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>这样除了可以简化自己的判断之外，也可以使用 <code>dagger call build-one-image --help</code>​ 在帮助中查看到</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>ARGUMENTS</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>--</span><span style=color:#a6e22e>app</span><span style=color:#f92672>-</span><span style=color:#a6e22e>tag</span> <span style=color:#a6e22e>engine</span>,<span style=color:#a6e22e>node</span>   [<span style=color:#a6e22e>required</span>]
</span></span></code></pre></td></tr></table></div></div><p>详情参见 <a href=https://docs.dagger.io/api/enumerations>Enumerations | Dagger</a></p><h3 id=使用-dagcontainerfromalpinelatest-无法拉取镜像>使用 dag.Container().From(&ldquo;alpine:latest&rdquo;) 无法拉取镜像<a hidden class=anchor aria-hidden=true href=#使用-dagcontainerfromalpinelatest-无法拉取镜像>#</a></h3><p>国内因为网络问题，无法拉取到 docker.io 上的镜像，但是 <code>dagger call</code>​ 的执行实际上在 dagger engine 容器中，所以拉取时不会依照本地设置的 <code>/etc/docke/daemon.json</code>​</p><p>这时我们可以采用手动运行 Dagger Engine 服务容器的方式，指定 Dagger Eninge 的 engine.toml</p><p>例如，创建文件 <code>engine.toml</code>​，注意：其中的镜像换成自己的要使用的镜像地址</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-toml data-lang=toml><span style=display:flex><span>[<span style=color:#a6e22e>registry</span>.<span style=color:#e6db74>&#34;docker.io&#34;</span>]
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>mirrors</span> = [<span style=color:#e6db74>&#34;mirror.a.com&#34;</span>, <span style=color:#e6db74>&#34;mirror.b.com&#34;</span>]
</span></span></code></pre></td></tr></table></div></div><p>然后手动运行 Engine</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker run --rm -v /var/lib/dagger --name customized-dagger-engine --privileged --volume $PWD/engine.toml:/etc/dagger/engine.toml ghcr.nju.edu.cn/dagger/engine:v0.13.7
</span></span></code></pre></td></tr></table></div></div><p>然后配置环境变量指定 Dagger CLI 使用该 Dagger Engine 服务</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>export _EXPERIMENTAL_DAGGER_RUNNER_HOST<span style=color:#f92672>=</span>docker-container://customized-dagger-engine
</span></span></code></pre></td></tr></table></div></div><p>接下来再使用 Dagger CLI 执行 <code>dagger call</code>​ 各种 <code>From</code>​ 拉取就不会有问题了</p><p>详情参见</p><ul><li><a href=https://docs.dagger.io/configuration/custom-registry>Custom Registry Mirrors | Dagger</a></li><li><a href=https://docs.dagger.io/configuration/custom-runner>Custom Runner | Dagger</a></li></ul><h3 id=dagger-缓存占据了很大空间如何清理>Dagger 缓存占据了很大空间，如何清理<a hidden class=anchor aria-hidden=true href=#dagger-缓存占据了很大空间如何清理>#</a></h3><p>缓存大小可以使用 BuildKit 垃圾收集配置来控制，也可以使用如下命令清理 Dagger Engine 的所有缓存</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>dagger query <span style=color:#e6db74>&lt;&lt;EOF
</span></span></span><span style=display:flex><span><span style=color:#e6db74>{
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  daggerEngine {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    localCache {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      prune
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>}
</span></span></span><span style=display:flex><span><span style=color:#e6db74>EOF</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=github-action-中如何保留缓存>Github Action 中如何保留缓存<a hidden class=anchor aria-hidden=true href=#github-action-中如何保留缓存>#</a></h3><p>不幸的是，很难用，因为 Docker 构建在 GHA 中是二等公民，这里提供一些链接参考</p><ul><li><a href=https://github.com/dagger/dagger/issues/6911>No information on caching for CI environments · Issue #6911 · dagger/dagger</a></li><li><a href=https://github.com/dagger/dagger/issues/8717>🐞 Fail to export cache with _EXPERIMENTAL_DAGGER_CACHE_CONFIG (<code>failed to compute blob by overlay differ (ok=false)</code>) · Issue #8717 · dagger/dagger</a></li><li><a href=https://discord.com/channels/707636530424053791/1165204052154535956>(334) Discord | "actions/cache" | Dagger</a></li><li><a href=https://docs.docker.com/build/ci/github-actions/cache/#github-cache>Cache management | Docker Docs</a></li></ul><h2 id=为什么是-dagger-而不是-earthly>为什么是 Dagger 而不是 Earthly<a hidden class=anchor aria-hidden=true href=#为什么是-dagger-而不是-earthly>#</a></h2><p>Earthly 我也用过，好处是和 Dockerfile 语法基本一致，基本上会写 Dockerfile 就会写 Earthfile。</p><p>具体来说，Earthly 使用下来没啥太致命的缺点，目前发现的一个问题是有些语法在 Dockerfile 中可以，但在 Earthfile 中就不行了，没有及时与 Dockerfile 上游对齐</p><p>另一方面是从 github 仓库来看，Earthly 不如 Dagger 活跃，毕竟 Dagger 是 Docker 创始人牵头，有一定的明星效应，能吸引更多的人来参与开源维护。</p><p>其实从语法来看，我觉得分不出太大优劣，使用 Dockerfile 的语法缺点是灵活性不如编程语言高，但优点是便于维护。</p><p>如果是之前使用 CUE 语言的 Dagger，那我觉得不如使用 Earthly 了，不需要多学一门语言，但现在 Dagger 改成了使用编程语言维护，使用 Dagger SDK 来构建，这样就比之前方便多了。</p><p>我目前发现了 Earthly 的两个 bug</p><ul><li><a href=https://github.com/earthly/earthly/issues/4305>Unexpected environment variable substitution · Issue #4305 · earthly/earthly</a></li><li><a href=https://github.com/earthly/earthly/issues/3959><code>ENV</code> doesn't support setting multiple values · Issue #3959 · earthly/earthly</a></li></ul><p>官方也不是很积极。</p><p>就目前项目前景来看，可能 Dagger 更好一些</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://www.hacktech.cn/tags/devops/>DevOps</a></li><li><a href=https://www.hacktech.cn/tags/dagger/>Dagger</a></li></ul><nav class=paginav><a class=prev href=https://www.hacktech.cn/post/2024/11/ansibleplaybook-independent-binary-compilation-actual-record-2f3tyf/><span class=title>« 上一页</span><br><span>ansible-playbook 独立二进制编译实录</span>
</a><a class=next href=https://www.hacktech.cn/post/2023/08/docker-pywpsrpc-use/><span class=title>下一页 »</span><br><span>docker 中使用 pywpsrpc</span></a></nav><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share Dagger 使用札记 on x" href="https://x.com/intent/tweet/?text=Dagger%20%e4%bd%bf%e7%94%a8%e6%9c%ad%e8%ae%b0&amp;url=https%3a%2f%2fwww.hacktech.cn%2fpost%2f2024%2f11%2fdagger-use-notes-vbgyk%2f&amp;hashtags=DevOps%2cDagger"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Dagger 使用札记 on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fwww.hacktech.cn%2fpost%2f2024%2f11%2fdagger-use-notes-vbgyk%2f&amp;title=Dagger%20%e4%bd%bf%e7%94%a8%e6%9c%ad%e8%ae%b0&amp;summary=Dagger%20%e4%bd%bf%e7%94%a8%e6%9c%ad%e8%ae%b0&amp;source=https%3a%2f%2fwww.hacktech.cn%2fpost%2f2024%2f11%2fdagger-use-notes-vbgyk%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Dagger 使用札记 on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fwww.hacktech.cn%2fpost%2f2024%2f11%2fdagger-use-notes-vbgyk%2f&title=Dagger%20%e4%bd%bf%e7%94%a8%e6%9c%ad%e8%ae%b0"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Dagger 使用札记 on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fwww.hacktech.cn%2fpost%2f2024%2f11%2fdagger-use-notes-vbgyk%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Dagger 使用札记 on whatsapp" href="https://api.whatsapp.com/send?text=Dagger%20%e4%bd%bf%e7%94%a8%e6%9c%ad%e8%ae%b0%20-%20https%3a%2f%2fwww.hacktech.cn%2fpost%2f2024%2f11%2fdagger-use-notes-vbgyk%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Dagger 使用札记 on telegram" href="https://telegram.me/share/url?text=Dagger%20%e4%bd%bf%e7%94%a8%e6%9c%ad%e8%ae%b0&amp;url=https%3a%2f%2fwww.hacktech.cn%2fpost%2f2024%2f11%2fdagger-use-notes-vbgyk%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentColor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Dagger 使用札记 on ycombinator" href="https://news.ycombinator.com/submitlink?t=Dagger%20%e4%bd%bf%e7%94%a8%e6%9c%ad%e8%ae%b0&u=https%3a%2f%2fwww.hacktech.cn%2fpost%2f2024%2f11%2fdagger-use-notes-vbgyk%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer><script src=https://cdn.jsdelivr.net/npm/@waline/client></script><div id=waline></div><script>new Waline({el:"#waline",serverURL:"https://blog-waline-api-d1lk7kqu8-akkum4n.vercel.app",visitor:!0,dark:"body.dark",requiredMeta:["nick","mail"],uploadImage:!1,copyright:!0,locale:{placeholder:"欢迎评论"}})</script></article></main><footer class=footer><span>&copy; 2025 <a href=https://www.hacktech.cn/>Akkuman 的技术博客</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script defer src=https://umm.wodewo.win/script.js data-website-id=d14cc524-4c14-40da-876c-437d65176899></script><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="复制";function s(){t.innerHTML="已复制！",setTimeout(()=>{t.innerHTML="复制"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>