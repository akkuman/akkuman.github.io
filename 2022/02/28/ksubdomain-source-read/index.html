<!doctype html><html lang=zh dir=auto>
<head><meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=robots content="index, follow">
<title>ksubdomain源码阅读 | Akkuman 的博客</title>
<meta name=keywords content="源码阅读,学习">
<meta name=description content="前两天看了amass关于dns枚举的实现，当然关于加速dns枚举的还有ksubdomain这个项目，今天花了几分钟看了下实现
阅读基于 https://github.com/boy-hack/ksubdomain/commit/9a2f2967eb8fb5c155b22393b9241f4cd6a02dc4
分析 首先从入口点开始看 https://github.com/boy-hack/ksubdomain/blob/main/cmd/ksubdomain/enum.go#L55-L109
1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56  Action: func(c *cli.Context) error { if c.NumFlags() == 0 { cli.">
<meta name=author content>
<link rel=canonical href=//hacktech.cn/2022/02/28/ksubdomain-source-read/>
<link crossorigin=anonymous href=https://cdn.jsdelivr.net/gh/akkuman/akkuman.github.io@master/assets/css/stylesheet.4158007d1975708d1c78a5f18d877b728f8457f9c790b3dc013638bba69ea19d.css integrity="sha256-QVgAfRl1cI0ceKXxjYd7co+EV/nHkLPcATY4u6aeoZ0=" rel="preload stylesheet" as=style>
<link rel=icon href=//hacktech.cn/images/avatar.webp>
<link rel=icon type=image/png sizes=16x16 href=//hacktech.cn/favicon-16x16.png>
<link rel=icon type=image/png sizes=32x32 href=//hacktech.cn/favicon-32x32.png>
<link rel=apple-touch-icon href=//hacktech.cn/apple-touch-icon.png>
<link rel=mask-icon href=//hacktech.cn/safari-pinned-tab.svg>
<meta name=theme-color content="#2e2e33">
<meta name=msapplication-TileColor content="#2e2e33">
<link rel=alternate hreflang=zh href=//hacktech.cn/2022/02/28/ksubdomain-source-read/>
<noscript>
<style>#theme-toggle,.top-link{display:none}</style>
<style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style>
</noscript>
<link rel=preconnect href=https://fonts.googleapis.com>
<link rel=preconnect href=https://fonts.gstatic.com crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC&family=Source+Code+Pro&display=swap" rel=stylesheet>
<script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script>
<script src=https://identity.netlify.com/v1/netlify-identity-widget.js></script>
<meta property="og:title" content="ksubdomain源码阅读">
<meta property="og:description" content="前两天看了amass关于dns枚举的实现，当然关于加速dns枚举的还有ksubdomain这个项目，今天花了几分钟看了下实现
阅读基于 https://github.com/boy-hack/ksubdomain/commit/9a2f2967eb8fb5c155b22393b9241f4cd6a02dc4
分析 首先从入口点开始看 https://github.com/boy-hack/ksubdomain/blob/main/cmd/ksubdomain/enum.go#L55-L109
1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56  Action: func(c *cli.Context) error { if c.NumFlags() == 0 { cli.">
<meta property="og:type" content="article">
<meta property="og:url" content="//hacktech.cn/2022/02/28/ksubdomain-source-read/"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2022-02-28T02:56:00+00:00">
<meta property="article:modified_time" content="2022-02-28T02:56:00+00:00">
<meta name=twitter:card content="summary">
<meta name=twitter:title content="ksubdomain源码阅读">
<meta name=twitter:description content="前两天看了amass关于dns枚举的实现，当然关于加速dns枚举的还有ksubdomain这个项目，今天花了几分钟看了下实现
阅读基于 https://github.com/boy-hack/ksubdomain/commit/9a2f2967eb8fb5c155b22393b9241f4cd6a02dc4
分析 首先从入口点开始看 https://github.com/boy-hack/ksubdomain/blob/main/cmd/ksubdomain/enum.go#L55-L109
1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56  Action: func(c *cli.Context) error { if c.NumFlags() == 0 { cli.">
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"//hacktech.cn/posts/"},{"@type":"ListItem","position":2,"name":"ksubdomain源码阅读","item":"//hacktech.cn/2022/02/28/ksubdomain-source-read/"}]}</script>
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"ksubdomain源码阅读","name":"ksubdomain源码阅读","description":"前两天看了amass关于dns枚举的实现，当然关于加速dns枚举的还有ksubdomain这个项目，今天花了几分钟看了下实现\n阅读基于 https://github.com/boy-hack/ksubdomain/commit/9a2f2967eb8fb5c155b22393b9241f4cd6a02dc4\n分析 首先从入口点开始看 https://github.com/boy-hack/ksubdomain/blob/main/cmd/ksubdomain/enum.go#L55-L109\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56  Action: func(c *cli.Context) error { if c.NumFlags() == 0 { cli.","keywords":["源码阅读","学习"],"articleBody":"前两天看了amass关于dns枚举的实现，当然关于加速dns枚举的还有ksubdomain这个项目，今天花了几分钟看了下实现\n阅读基于 https://github.com/boy-hack/ksubdomain/commit/9a2f2967eb8fb5c155b22393b9241f4cd6a02dc4\n分析 首先从入口点开始看 https://github.com/boy-hack/ksubdomain/blob/main/cmd/ksubdomain/enum.go#L55-L109\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56  Action: func(c *cli.Context) error { if c.NumFlags() == 0 { cli.ShowCommandHelpAndExit(c, \"enum\", 0) } var domains []string // handle domain \tif c.String(\"domain\") != \"\" { domains = append(domains, c.String(\"domain\")) } if c.String(\"domainList\") != \"\" { dl, err := core.LinesInFile(c.String(\"domainList\")) if err != nil { gologger.Fatalf(\"读取domain文件失败:%s\\n\", err.Error()) } domains = append(dl, domains...) } levelDict := c.String(\"level-dict\") var levelDomains []string if levelDict != \"\" { dl, err := core.LinesInFile(levelDict) if err != nil { gologger.Fatalf(\"读取domain文件失败:%s,请检查--level-dict参数\\n\", err.Error()) } levelDomains = dl } else if c.Int(\"level\")  2 { levelDomains = core.GetDefaultSubNextData() } opt := \u0026options.Options{ Rate: options.Band2Rate(c.String(\"band\")), Domain: domains, FileName: c.String(\"filename\"), Resolvers: options.GetResolvers(c.String(\"resolvers\")), Output: c.String(\"output\"), Silent: c.Bool(\"silent\"), Stdin: c.Bool(\"stdin\"), SkipWildCard: c.Bool(\"skip-wild\"), TimeOut: c.Int(\"timeout\"), Retry: c.Int(\"retry\"), Method: \"enum\", OnlyDomain: c.Bool(\"only-domain\"), NotPrint: c.Bool(\"not-print\"), Level: c.Int(\"level\"), LevelDomains: levelDomains, } opt.Check() r, err := runner.New(opt) if err != nil { gologger.Fatalf(\"%s\\n\", err.Error()) return nil } r.RunEnumeration() r.Close() return nil },   具体的实现细节就不关注了，可以看到入口点只是读取了一些配置，继续进入 RunEnumeration 看看\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29  func (r *runner) RunEnumeration() { ctx, cancel := context.WithCancel(r.ctx) defer cancel() go r.recvChanel(ctx) // 启动接收线程 \tfor i := 0; i 3; i++ { go r.sendCycle(ctx) // 发送线程 \t} go r.handleResult(ctx) // 处理结果，打印输出  var isLoadOver bool = false // 是否加载文件完毕 \tt := time.NewTicker(1 * time.Second) defer t.Stop() for { select { case t.C: r.PrintStatus() if isLoadOver { if r.hm.Length() == 0 { gologger.Printf(\"\\n\") gologger.Infof(\"扫描完毕\") return } } case r.fisrtloadChanel: go r.retry(ctx) // 遍历hm，依次重试 \tisLoadOver = true } } }   首先是启动了一个接收dns resp数据包的协程，然后启动了三个发送dns req数据包的协程，还有一个线程 handleResult 用来输出结果\n剩下的我们先不关注，可以思考一下，启动一个发送协程，一个接收协程，一个用来打印结果，单纯这三个协程我们肯定是没法控制整个程序的停止的，因为接收协程肯定是需要一个死循环去读取。\n所以我们看看下来的控制，isLoadOver 比较关键，可以看到它由 fisrtloadChanel 来控制，我们找找它是在哪里被赋值的\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80  type runner struct { ether *device.EtherTable //本地网卡信息 \thm *statusdb.StatusDb options *options2.Options limit ratelimit.Limiter handle *pcap.Handle successIndex uint64 sendIndex uint64 recvIndex uint64 faildIndex uint64 sender chan string recver chan core.RecvResult freeport int dnsid uint16 // dnsid 用于接收的确定ID \tmaxRetry int // 最大重试次数 \ttimeout int64 // 超时xx秒后重试 \tctx context.Context fisrtloadChanel chan string // 数据加载完毕的chanel \tstartTime time.Time domains []string } func New(options *options2.Options) (*runner, error) { var err error version := pcap.Version() r := new(runner) gologger.Infof(version + \"\\n\") r.options = options r.ether = GetDeviceConfig() r.hm = statusdb.CreateMemoryDB() gologger.Infof(\"DNS:%s\\n\", options.Resolvers) r.handle, err = device.PcapInit(r.ether.Device) if err != nil { return nil, err } // 根据发包总数和timeout时间来分配每秒速度 \tallPacket := r.loadTargets() if options.Level  2 { allPacket = allPacket * int(math.Pow(float64(len(options.LevelDomains)), float64(options.Level-2))) } calcLimit := float64(allPacket/options.TimeOut) * 0.85 if calcLimit 1000 { calcLimit = 1000 } limit := int(math.Min(calcLimit, float64(options.Rate))) r.limit = ratelimit.New(limit) // per second  gologger.Infof(\"Rate:%dpps\\n\", limit) r.sender = make(chan string, 99) // 多个协程发送 \tr.recver = make(chan core.RecvResult, 99) // 多个协程接收  freePort, err := freeport.GetFreePort() if err != nil { return nil, err } r.freeport = freePort gologger.Infof(\"FreePort:%d\\n\", freePort) r.dnsid = 0x2021 // set dnsid 65500 \tr.maxRetry = r.options.Retry r.timeout = int64(r.options.TimeOut) r.ctx = context.Background() r.fisrtloadChanel = make(chan string) r.startTime = time.Now() go func() { for _, msg := range r.domains { r.sender  msg if options.Method == \"enum\" \u0026\u0026 options.Level  2 { r.iterDomains(options.Level, msg) } } r.domains = nil r.fisrtloadChanel  \"ok\" }() return r, nil }   我们可以看到它是用来在数据全部发往 sender 后的一个标识位，可以看到 New 函数是用来初始化限速器，timeout等等。\n然后我们继续回到之前的代码看看\n1 2 3  case r.fisrtloadChanel: go r.retry(ctx) // 遍历hm，依次重试 \tisLoadOver = true   可以看到当数据全部发往 sender 后，将会调用retry\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20  func (r *runner) retry(ctx context.Context) { for { // 循环检测超时的队列 \tnow := time.Now() r.hm.Scan(func(key string, v statusdb.Item) error { if r.maxRetry  0 \u0026\u0026 v.Retry  r.maxRetry { r.hm.Del(key) atomic.AddUint64(\u0026r.faildIndex, 1) return nil } if int64(now.Sub(v.Time)) = r.timeout { // 重新发送 \tr.sender  key } return nil }) length := 1000 time.Sleep(time.Millisecond * time.Duration(length)) } }   可以看到具体逻辑是：判断是否达到最大重试次数，如果没有就重新入队去进行dns请求，如果达到最大次数则从缓存中删除它。\n然后继续往下看，可以看到 isLoadOver = true ，然后可以看\n1 2 3 4 5 6 7  if isLoadOver { if r.hm.Length() == 0 { gologger.Printf(\"\\n\") gologger.Infof(\"扫描完毕\") return } }   可以看到当 isLoadOver == true \u0026\u0026 r.hm.Length() == 0 时，会停止扫描退出。也就是所有的子域名枚举完成或达到最大重试次数，则退出。\n看完了控制逻辑，我们可以看看具体的发送包和接收包的函数了\n首先看看发送\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23  func (r *runner) sendCycle(ctx context.Context) { for domain := range r.sender { r.limit.Take() v, ok := r.hm.Get(domain) if !ok { v = statusdb.Item{ Domain: domain, Dns: r.choseDns(), Time: time.Now(), Retry: 0, DomainLevel: 0, } r.hm.Add(domain, v) } else { v.Retry += 1 v.Time = time.Now() v.Dns = r.choseDns() r.hm.Set(domain, v) } send(domain, v.Dns, r.ether, r.dnsid, uint16(r.freeport), r.handle) atomic.AddUint64(\u0026r.sendIndex, 1) } }   可以看到首先是发送速率的控制，然后从缓存中获取生成的子域名，如果没有代表第一次跑，初始化一个Item丢给send去发包，如果已经存在则重试次数加一，然后重新选择dns服务器，然后丢给send发包。\n具体的发包函数我们就不看了，ksubdomain 是采用的 gopacket 直接构造dns包然后使用网卡发包，目的为了提速\n然后看看接收函数\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39  func (r *runner) recvChanel(ctx context.Context) error { ... parser := gopacket.NewDecodingLayerParser( layers.LayerTypeEthernet, \u0026eth, \u0026ipv4, \u0026ipv6, \u0026udp, \u0026dns) var data []byte var decoded []gopacket.LayerType for { data, _, err = handle.ReadPacketData() if err != nil { continue } err = parser.DecodeLayers(data, \u0026decoded) if err != nil { continue } if !dns.QR { continue } if dns.ID != r.dnsid { continue } atomic.AddUint64(\u0026r.recvIndex, 1) if len(dns.Questions) == 0 { continue } subdomain := string(dns.Questions[0].Name) r.hm.Del(subdomain) if dns.ANCount  0 { atomic.AddUint64(\u0026r.successIndex, 1) result := core.RecvResult{ Subdomain: subdomain, Answers: dns.Answers, } r.recver  result } } }   我摘取了一部分，可以看到具体逻辑就是不断从网卡中获取然后解析dns返回包，然后从缓存中删除该子域名并放入 recver chan，这个chan主要是用来读取并输出的。\n整体逻辑大体上就是这样。\n总结 整体加速思路其实和amass有点像\namass是使用了一些额外的技巧来达到同步调用，使用单个udp连接来完成，一个协程用来写，一个用来读，而ksubdomain直接调用网卡驱动绕过了操作系统，可以突破操作系统的发包限制，会更快一些，amass对于udp到tcp的dns请求做了一些适配\n","wordCount":"1003","inLanguage":"zh","datePublished":"2022-02-28T02:56:00Z","dateModified":"2022-02-28T02:56:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"//hacktech.cn/2022/02/28/ksubdomain-source-read/"},"publisher":{"@type":"Organization","name":"Akkuman 的博客","logo":{"@type":"ImageObject","url":"//hacktech.cn/images/avatar.webp"}}}</script>
</head>
<body id=top>
<script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add('dark'):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove('dark'):window.matchMedia('(prefers-color-scheme: dark)').matches&&document.body.classList.add('dark')</script>
<header class=header>
<nav class=nav>
<div class=logo>
<a href=//hacktech.cn/ accesskey=h title="Akkuman 的博客 (Alt + H)">Akkuman 的博客</a>
<div class=logo-switches>
<button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
</button>
<ul class=lang-switch><li>|</li>
<li>
<a href=//hacktech.cn/en/ title=English aria-label=English>En</a>
</li>
</ul>
</div>
</div>
<ul id=menu>
<li>
<a href=//hacktech.cn/archives/ title=归档>
<span>归档</span>
</a>
</li>
<li>
<a href=//hacktech.cn/categories/ title=分类>
<span>分类</span>
</a>
</li>
<li>
<a href=//hacktech.cn/search/ title=搜索>
<span>搜索</span>
</a>
</li>
<li>
<a href=//hacktech.cn/tags/ title=标签>
<span>标签</span>
</a>
</li>
<li>
<a href=//hacktech.cn/links/ title=链接>
<span>链接</span>
</a>
</li>
</ul>
</nav>
</header>
<main class=main>
<article class=post-single>
<header class=post-header>
<div class=breadcrumbs><a href=//hacktech.cn/>主页</a>&nbsp;»&nbsp;<a href=//hacktech.cn/posts/>Posts</a></div>
<h1 class=post-title>
ksubdomain源码阅读
</h1>
<div class=post-meta><span title="2022-02-28 02:56:00 +0000 UTC">二月 28, 2022</span>&nbsp;·&nbsp;5 分钟&nbsp;·&nbsp;<span id=busuanzi_container_page_pv><span id=busuanzi_value_page_pv></span></span>&nbsp;|&nbsp;<a href="mailto://akkumans@qq.com?subject=Suggesting%20changes%20for%20/posts/ksubdomain-source-read.md" rel="noopener noreferrer" target=_blank>给我邮件</a>
</div>
</header> <div class=toc>
<details>
<summary accesskey=c title="(Alt + C)">
<span class=details>目录</span>
</summary>
<div class=inner><ul>
<li>
<a href=#%e5%88%86%e6%9e%90 aria-label=分析>分析</a></li>
<li>
<a href=#%e6%80%bb%e7%bb%93 aria-label=总结>总结</a>
</li>
</ul>
</div>
</details>
</div>
<div class=post-content><p>前两天看了amass关于dns枚举的实现，当然关于加速dns枚举的还有ksubdomain这个项目，今天花了几分钟看了下实现</p>
<p>阅读基于 <a href=https://github.com/boy-hack/ksubdomain/commit/9a2f2967eb8fb5c155b22393b9241f4cd6a02dc4>https://github.com/boy-hack/ksubdomain/commit/9a2f2967eb8fb5c155b22393b9241f4cd6a02dc4</a></p>
<h2 id=分析>分析<a hidden class=anchor aria-hidden=true href=#分析>#</a></h2>
<p>首先从入口点开始看 <a href=https://github.com/boy-hack/ksubdomain/blob/main/cmd/ksubdomain/enum.go#L55-L109>https://github.com/boy-hack/ksubdomain/blob/main/cmd/ksubdomain/enum.go#L55-L109</a></p>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">50
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">51
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">52
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">53
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">54
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">55
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">56
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#a6e22e>Action</span>: <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>cli</span>.<span style=color:#a6e22e>Context</span>) <span style=color:#66d9ef>error</span> {
		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>NumFlags</span>() <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
			<span style=color:#a6e22e>cli</span>.<span style=color:#a6e22e>ShowCommandHelpAndExit</span>(<span style=color:#a6e22e>c</span>, <span style=color:#e6db74>&#34;enum&#34;</span>, <span style=color:#ae81ff>0</span>)
		}
		<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>domains</span> []<span style=color:#66d9ef>string</span>
		<span style=color:#75715e>// handle domain
</span><span style=color:#75715e></span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>String</span>(<span style=color:#e6db74>&#34;domain&#34;</span>) <span style=color:#f92672>!=</span> <span style=color:#e6db74>&#34;&#34;</span> {
			<span style=color:#a6e22e>domains</span> = append(<span style=color:#a6e22e>domains</span>, <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>String</span>(<span style=color:#e6db74>&#34;domain&#34;</span>))
		}
		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>String</span>(<span style=color:#e6db74>&#34;domainList&#34;</span>) <span style=color:#f92672>!=</span> <span style=color:#e6db74>&#34;&#34;</span> {
			<span style=color:#a6e22e>dl</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>core</span>.<span style=color:#a6e22e>LinesInFile</span>(<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>String</span>(<span style=color:#e6db74>&#34;domainList&#34;</span>))
			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
				<span style=color:#a6e22e>gologger</span>.<span style=color:#a6e22e>Fatalf</span>(<span style=color:#e6db74>&#34;读取domain文件失败:%s\n&#34;</span>, <span style=color:#a6e22e>err</span>.<span style=color:#a6e22e>Error</span>())
			}
			<span style=color:#a6e22e>domains</span> = append(<span style=color:#a6e22e>dl</span>, <span style=color:#a6e22e>domains</span><span style=color:#f92672>...</span>)
		}
		<span style=color:#a6e22e>levelDict</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>String</span>(<span style=color:#e6db74>&#34;level-dict&#34;</span>)
		<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>levelDomains</span> []<span style=color:#66d9ef>string</span>
		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>levelDict</span> <span style=color:#f92672>!=</span> <span style=color:#e6db74>&#34;&#34;</span> {
			<span style=color:#a6e22e>dl</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>core</span>.<span style=color:#a6e22e>LinesInFile</span>(<span style=color:#a6e22e>levelDict</span>)
			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
				<span style=color:#a6e22e>gologger</span>.<span style=color:#a6e22e>Fatalf</span>(<span style=color:#e6db74>&#34;读取domain文件失败:%s,请检查--level-dict参数\n&#34;</span>, <span style=color:#a6e22e>err</span>.<span style=color:#a6e22e>Error</span>())
			}
			<span style=color:#a6e22e>levelDomains</span> = <span style=color:#a6e22e>dl</span>
		} <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Int</span>(<span style=color:#e6db74>&#34;level&#34;</span>) &gt; <span style=color:#ae81ff>2</span> {
			<span style=color:#a6e22e>levelDomains</span> = <span style=color:#a6e22e>core</span>.<span style=color:#a6e22e>GetDefaultSubNextData</span>()
		}

		<span style=color:#a6e22e>opt</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>options</span>.<span style=color:#a6e22e>Options</span>{
			<span style=color:#a6e22e>Rate</span>:         <span style=color:#a6e22e>options</span>.<span style=color:#a6e22e>Band2Rate</span>(<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>String</span>(<span style=color:#e6db74>&#34;band&#34;</span>)),
			<span style=color:#a6e22e>Domain</span>:       <span style=color:#a6e22e>domains</span>,
			<span style=color:#a6e22e>FileName</span>:     <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>String</span>(<span style=color:#e6db74>&#34;filename&#34;</span>),
			<span style=color:#a6e22e>Resolvers</span>:    <span style=color:#a6e22e>options</span>.<span style=color:#a6e22e>GetResolvers</span>(<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>String</span>(<span style=color:#e6db74>&#34;resolvers&#34;</span>)),
			<span style=color:#a6e22e>Output</span>:       <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>String</span>(<span style=color:#e6db74>&#34;output&#34;</span>),
			<span style=color:#a6e22e>Silent</span>:       <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Bool</span>(<span style=color:#e6db74>&#34;silent&#34;</span>),
			<span style=color:#a6e22e>Stdin</span>:        <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Bool</span>(<span style=color:#e6db74>&#34;stdin&#34;</span>),
			<span style=color:#a6e22e>SkipWildCard</span>: <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Bool</span>(<span style=color:#e6db74>&#34;skip-wild&#34;</span>),
			<span style=color:#a6e22e>TimeOut</span>:      <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Int</span>(<span style=color:#e6db74>&#34;timeout&#34;</span>),
			<span style=color:#a6e22e>Retry</span>:        <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Int</span>(<span style=color:#e6db74>&#34;retry&#34;</span>),
			<span style=color:#a6e22e>Method</span>:       <span style=color:#e6db74>&#34;enum&#34;</span>,
			<span style=color:#a6e22e>OnlyDomain</span>:   <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Bool</span>(<span style=color:#e6db74>&#34;only-domain&#34;</span>),
			<span style=color:#a6e22e>NotPrint</span>:     <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Bool</span>(<span style=color:#e6db74>&#34;not-print&#34;</span>),
			<span style=color:#a6e22e>Level</span>:        <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Int</span>(<span style=color:#e6db74>&#34;level&#34;</span>),
			<span style=color:#a6e22e>LevelDomains</span>: <span style=color:#a6e22e>levelDomains</span>,
		}
		<span style=color:#a6e22e>opt</span>.<span style=color:#a6e22e>Check</span>()

		<span style=color:#a6e22e>r</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>runner</span>.<span style=color:#a6e22e>New</span>(<span style=color:#a6e22e>opt</span>)
		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
			<span style=color:#a6e22e>gologger</span>.<span style=color:#a6e22e>Fatalf</span>(<span style=color:#e6db74>&#34;%s\n&#34;</span>, <span style=color:#a6e22e>err</span>.<span style=color:#a6e22e>Error</span>())
			<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
		}
		<span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>RunEnumeration</span>()
		<span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>Close</span>()
		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
	},
</code></pre></td></tr></table>
</div>
</div><p>具体的实现细节就不关注了，可以看到入口点只是读取了一些配置，继续进入 <code>RunEnumeration</code> 看看</p>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>r</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>runner</span>) <span style=color:#a6e22e>RunEnumeration</span>() {
	<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>cancel</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>WithCancel</span>(<span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>ctx</span>)
	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>cancel</span>()
	<span style=color:#66d9ef>go</span> <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>recvChanel</span>(<span style=color:#a6e22e>ctx</span>) <span style=color:#75715e>// 启动接收线程
</span><span style=color:#75715e></span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>i</span> &lt; <span style=color:#ae81ff>3</span>; <span style=color:#a6e22e>i</span><span style=color:#f92672>++</span> {
		<span style=color:#66d9ef>go</span> <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>sendCycle</span>(<span style=color:#a6e22e>ctx</span>) <span style=color:#75715e>// 发送线程
</span><span style=color:#75715e></span>	}
	<span style=color:#66d9ef>go</span> <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>handleResult</span>(<span style=color:#a6e22e>ctx</span>) <span style=color:#75715e>// 处理结果，打印输出
</span><span style=color:#75715e></span>
	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>isLoadOver</span> <span style=color:#66d9ef>bool</span> = <span style=color:#66d9ef>false</span> <span style=color:#75715e>// 是否加载文件完毕
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>t</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>NewTicker</span>(<span style=color:#ae81ff>1</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span>)
	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>Stop</span>()
	<span style=color:#66d9ef>for</span> {
		<span style=color:#66d9ef>select</span> {
		<span style=color:#66d9ef>case</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>C</span>:
			<span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>PrintStatus</span>()
			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>isLoadOver</span> {
				<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>hm</span>.<span style=color:#a6e22e>Length</span>() <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
					<span style=color:#a6e22e>gologger</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;\n&#34;</span>)
					<span style=color:#a6e22e>gologger</span>.<span style=color:#a6e22e>Infof</span>(<span style=color:#e6db74>&#34;扫描完毕&#34;</span>)
					<span style=color:#66d9ef>return</span>
				}
			}
		<span style=color:#66d9ef>case</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>fisrtloadChanel</span>:
			<span style=color:#66d9ef>go</span> <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>retry</span>(<span style=color:#a6e22e>ctx</span>) <span style=color:#75715e>// 遍历hm，依次重试
</span><span style=color:#75715e></span>			<span style=color:#a6e22e>isLoadOver</span> = <span style=color:#66d9ef>true</span>
		}
	}
}
</code></pre></td></tr></table>
</div>
</div><p>首先是启动了一个接收dns resp数据包的协程，然后启动了三个发送dns req数据包的协程，还有一个线程 <code>handleResult</code> 用来输出结果</p>
<p>剩下的我们先不关注，可以思考一下，启动一个发送协程，一个接收协程，一个用来打印结果，单纯这三个协程我们肯定是没法控制整个程序的停止的，因为接收协程肯定是需要一个死循环去读取。</p>
<p>所以我们看看下来的控制，<code>isLoadOver</code> 比较关键，可以看到它由 <code>fisrtloadChanel</code> 来控制，我们找找它是在哪里被赋值的</p>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">50
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">51
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">52
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">53
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">54
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">55
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">56
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">57
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">58
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">59
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">60
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">61
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">62
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">63
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">64
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">65
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">66
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">67
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">68
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">69
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">70
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">71
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">72
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">73
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">74
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">75
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">76
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">77
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">78
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">79
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">80
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>runner</span> <span style=color:#66d9ef>struct</span> {
	<span style=color:#a6e22e>ether</span>           <span style=color:#f92672>*</span><span style=color:#a6e22e>device</span>.<span style=color:#a6e22e>EtherTable</span> <span style=color:#75715e>//本地网卡信息
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>hm</span>              <span style=color:#f92672>*</span><span style=color:#a6e22e>statusdb</span>.<span style=color:#a6e22e>StatusDb</span>
	<span style=color:#a6e22e>options</span>         <span style=color:#f92672>*</span><span style=color:#a6e22e>options2</span>.<span style=color:#a6e22e>Options</span>
	<span style=color:#a6e22e>limit</span>           <span style=color:#a6e22e>ratelimit</span>.<span style=color:#a6e22e>Limiter</span>
	<span style=color:#a6e22e>handle</span>          <span style=color:#f92672>*</span><span style=color:#a6e22e>pcap</span>.<span style=color:#a6e22e>Handle</span>
	<span style=color:#a6e22e>successIndex</span>    <span style=color:#66d9ef>uint64</span>
	<span style=color:#a6e22e>sendIndex</span>       <span style=color:#66d9ef>uint64</span>
	<span style=color:#a6e22e>recvIndex</span>       <span style=color:#66d9ef>uint64</span>
	<span style=color:#a6e22e>faildIndex</span>      <span style=color:#66d9ef>uint64</span>
	<span style=color:#a6e22e>sender</span>          <span style=color:#66d9ef>chan</span> <span style=color:#66d9ef>string</span>
	<span style=color:#a6e22e>recver</span>          <span style=color:#66d9ef>chan</span> <span style=color:#a6e22e>core</span>.<span style=color:#a6e22e>RecvResult</span>
	<span style=color:#a6e22e>freeport</span>        <span style=color:#66d9ef>int</span>
	<span style=color:#a6e22e>dnsid</span>           <span style=color:#66d9ef>uint16</span> <span style=color:#75715e>// dnsid 用于接收的确定ID
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>maxRetry</span>        <span style=color:#66d9ef>int</span>    <span style=color:#75715e>// 最大重试次数
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>timeout</span>         <span style=color:#66d9ef>int64</span>  <span style=color:#75715e>// 超时xx秒后重试
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>ctx</span>             <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>
	<span style=color:#a6e22e>fisrtloadChanel</span> <span style=color:#66d9ef>chan</span> <span style=color:#66d9ef>string</span> <span style=color:#75715e>// 数据加载完毕的chanel
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>startTime</span>       <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Time</span>
	<span style=color:#a6e22e>domains</span>         []<span style=color:#66d9ef>string</span>
}

<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>New</span>(<span style=color:#a6e22e>options</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>options2</span>.<span style=color:#a6e22e>Options</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>runner</span>, <span style=color:#66d9ef>error</span>) {
	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>err</span> <span style=color:#66d9ef>error</span>
	<span style=color:#a6e22e>version</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>pcap</span>.<span style=color:#a6e22e>Version</span>()
	<span style=color:#a6e22e>r</span> <span style=color:#f92672>:=</span> new(<span style=color:#a6e22e>runner</span>)
	<span style=color:#a6e22e>gologger</span>.<span style=color:#a6e22e>Infof</span>(<span style=color:#a6e22e>version</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;\n&#34;</span>)

	<span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>options</span> = <span style=color:#a6e22e>options</span>
	<span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>ether</span> = <span style=color:#a6e22e>GetDeviceConfig</span>()
	<span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>hm</span> = <span style=color:#a6e22e>statusdb</span>.<span style=color:#a6e22e>CreateMemoryDB</span>()

	<span style=color:#a6e22e>gologger</span>.<span style=color:#a6e22e>Infof</span>(<span style=color:#e6db74>&#34;DNS:%s\n&#34;</span>, <span style=color:#a6e22e>options</span>.<span style=color:#a6e22e>Resolvers</span>)
	<span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>handle</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>device</span>.<span style=color:#a6e22e>PcapInit</span>(<span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>ether</span>.<span style=color:#a6e22e>Device</span>)
	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
	}

	<span style=color:#75715e>// 根据发包总数和timeout时间来分配每秒速度
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>allPacket</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>loadTargets</span>()
	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>options</span>.<span style=color:#a6e22e>Level</span> &gt; <span style=color:#ae81ff>2</span> {
		<span style=color:#a6e22e>allPacket</span> = <span style=color:#a6e22e>allPacket</span> <span style=color:#f92672>*</span> int(<span style=color:#a6e22e>math</span>.<span style=color:#a6e22e>Pow</span>(float64(len(<span style=color:#a6e22e>options</span>.<span style=color:#a6e22e>LevelDomains</span>)), float64(<span style=color:#a6e22e>options</span>.<span style=color:#a6e22e>Level</span><span style=color:#f92672>-</span><span style=color:#ae81ff>2</span>)))
	}
	<span style=color:#a6e22e>calcLimit</span> <span style=color:#f92672>:=</span> float64(<span style=color:#a6e22e>allPacket</span><span style=color:#f92672>/</span><span style=color:#a6e22e>options</span>.<span style=color:#a6e22e>TimeOut</span>) <span style=color:#f92672>*</span> <span style=color:#ae81ff>0.85</span>
	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>calcLimit</span> &lt; <span style=color:#ae81ff>1000</span> {
		<span style=color:#a6e22e>calcLimit</span> = <span style=color:#ae81ff>1000</span>
	}
	<span style=color:#a6e22e>limit</span> <span style=color:#f92672>:=</span> int(<span style=color:#a6e22e>math</span>.<span style=color:#a6e22e>Min</span>(<span style=color:#a6e22e>calcLimit</span>, float64(<span style=color:#a6e22e>options</span>.<span style=color:#a6e22e>Rate</span>)))
	<span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>limit</span> = <span style=color:#a6e22e>ratelimit</span>.<span style=color:#a6e22e>New</span>(<span style=color:#a6e22e>limit</span>) <span style=color:#75715e>// per second
</span><span style=color:#75715e></span>
	<span style=color:#a6e22e>gologger</span>.<span style=color:#a6e22e>Infof</span>(<span style=color:#e6db74>&#34;Rate:%dpps\n&#34;</span>, <span style=color:#a6e22e>limit</span>)

	<span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>sender</span> = make(<span style=color:#66d9ef>chan</span> <span style=color:#66d9ef>string</span>, <span style=color:#ae81ff>99</span>)          <span style=color:#75715e>// 多个协程发送
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>recver</span> = make(<span style=color:#66d9ef>chan</span> <span style=color:#a6e22e>core</span>.<span style=color:#a6e22e>RecvResult</span>, <span style=color:#ae81ff>99</span>) <span style=color:#75715e>// 多个协程接收
</span><span style=color:#75715e></span>
	<span style=color:#a6e22e>freePort</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>freeport</span>.<span style=color:#a6e22e>GetFreePort</span>()
	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
	}
	<span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>freeport</span> = <span style=color:#a6e22e>freePort</span>
	<span style=color:#a6e22e>gologger</span>.<span style=color:#a6e22e>Infof</span>(<span style=color:#e6db74>&#34;FreePort:%d\n&#34;</span>, <span style=color:#a6e22e>freePort</span>)
	<span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>dnsid</span> = <span style=color:#ae81ff>0x2021</span> <span style=color:#75715e>// set dnsid 65500
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>maxRetry</span> = <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>options</span>.<span style=color:#a6e22e>Retry</span>
	<span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>timeout</span> = int64(<span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>options</span>.<span style=color:#a6e22e>TimeOut</span>)
	<span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>ctx</span> = <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Background</span>()
	<span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>fisrtloadChanel</span> = make(<span style=color:#66d9ef>chan</span> <span style=color:#66d9ef>string</span>)
	<span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>startTime</span> = <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Now</span>()

	<span style=color:#66d9ef>go</span> <span style=color:#66d9ef>func</span>() {
		<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>msg</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>domains</span> {
			<span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>sender</span> <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>msg</span>
			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>options</span>.<span style=color:#a6e22e>Method</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;enum&#34;</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>options</span>.<span style=color:#a6e22e>Level</span> &gt; <span style=color:#ae81ff>2</span> {
				<span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>iterDomains</span>(<span style=color:#a6e22e>options</span>.<span style=color:#a6e22e>Level</span>, <span style=color:#a6e22e>msg</span>)
			}
		}
		<span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>domains</span> = <span style=color:#66d9ef>nil</span>
		<span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>fisrtloadChanel</span> <span style=color:#f92672>&lt;-</span> <span style=color:#e6db74>&#34;ok&#34;</span>
	}()
	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>r</span>, <span style=color:#66d9ef>nil</span>
}
</code></pre></td></tr></table>
</div>
</div><p>我们可以看到它是用来在数据全部发往 <code>sender</code> 后的一个标识位，可以看到 <code>New</code> 函数是用来初始化限速器，timeout等等。</p>
<p>然后我们继续回到之前的代码看看</p>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>case</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>fisrtloadChanel</span>:
			<span style=color:#66d9ef>go</span> <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>retry</span>(<span style=color:#a6e22e>ctx</span>) <span style=color:#75715e>// 遍历hm，依次重试
</span><span style=color:#75715e></span>			<span style=color:#a6e22e>isLoadOver</span> = <span style=color:#66d9ef>true</span>
</code></pre></td></tr></table>
</div>
</div><p>可以看到当数据全部发往 <code>sender</code> 后，将会调用<code>retry</code></p>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>r</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>runner</span>) <span style=color:#a6e22e>retry</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>) {
	<span style=color:#66d9ef>for</span> {
		<span style=color:#75715e>// 循环检测超时的队列
</span><span style=color:#75715e></span>		<span style=color:#a6e22e>now</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Now</span>()
		<span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>hm</span>.<span style=color:#a6e22e>Scan</span>(<span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>key</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>v</span> <span style=color:#a6e22e>statusdb</span>.<span style=color:#a6e22e>Item</span>) <span style=color:#66d9ef>error</span> {
			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>maxRetry</span> &gt; <span style=color:#ae81ff>0</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>v</span>.<span style=color:#a6e22e>Retry</span> &gt; <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>maxRetry</span> {
				<span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>hm</span>.<span style=color:#a6e22e>Del</span>(<span style=color:#a6e22e>key</span>)
				<span style=color:#a6e22e>atomic</span>.<span style=color:#a6e22e>AddUint64</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>faildIndex</span>, <span style=color:#ae81ff>1</span>)
				<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
			}
			<span style=color:#66d9ef>if</span> int64(<span style=color:#a6e22e>now</span>.<span style=color:#a6e22e>Sub</span>(<span style=color:#a6e22e>v</span>.<span style=color:#a6e22e>Time</span>)) <span style=color:#f92672>&gt;=</span> <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>timeout</span> {
				<span style=color:#75715e>// 重新发送
</span><span style=color:#75715e></span>				<span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>sender</span> <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>key</span>
			}
			<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
		})
		<span style=color:#a6e22e>length</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>1000</span>
		<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Sleep</span>(<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Millisecond</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span>(<span style=color:#a6e22e>length</span>))
	}
}
</code></pre></td></tr></table>
</div>
</div><p>可以看到具体逻辑是：判断是否达到最大重试次数，如果没有就重新入队去进行dns请求，如果达到最大次数则从缓存中删除它。</p>
<p>然后继续往下看，可以看到 <code>isLoadOver = true</code> ，然后可以看</p>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>isLoadOver</span> {
				<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>hm</span>.<span style=color:#a6e22e>Length</span>() <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
					<span style=color:#a6e22e>gologger</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;\n&#34;</span>)
					<span style=color:#a6e22e>gologger</span>.<span style=color:#a6e22e>Infof</span>(<span style=color:#e6db74>&#34;扫描完毕&#34;</span>)
					<span style=color:#66d9ef>return</span>
				}
			}
</code></pre></td></tr></table>
</div>
</div><p>可以看到当 <code>isLoadOver == true && r.hm.Length() == 0</code> 时，会停止扫描退出。也就是所有的子域名枚举完成或达到最大重试次数，则退出。</p>
<p>看完了控制逻辑，我们可以看看具体的发送包和接收包的函数了</p>
<p>首先看看发送</p>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>r</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>runner</span>) <span style=color:#a6e22e>sendCycle</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>) {
	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>domain</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>sender</span> {
		<span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>limit</span>.<span style=color:#a6e22e>Take</span>()
		<span style=color:#a6e22e>v</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>hm</span>.<span style=color:#a6e22e>Get</span>(<span style=color:#a6e22e>domain</span>)
		<span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>ok</span> {
			<span style=color:#a6e22e>v</span> = <span style=color:#a6e22e>statusdb</span>.<span style=color:#a6e22e>Item</span>{
				<span style=color:#a6e22e>Domain</span>:      <span style=color:#a6e22e>domain</span>,
				<span style=color:#a6e22e>Dns</span>:         <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>choseDns</span>(),
				<span style=color:#a6e22e>Time</span>:        <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Now</span>(),
				<span style=color:#a6e22e>Retry</span>:       <span style=color:#ae81ff>0</span>,
				<span style=color:#a6e22e>DomainLevel</span>: <span style=color:#ae81ff>0</span>,
			}
			<span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>hm</span>.<span style=color:#a6e22e>Add</span>(<span style=color:#a6e22e>domain</span>, <span style=color:#a6e22e>v</span>)
		} <span style=color:#66d9ef>else</span> {
			<span style=color:#a6e22e>v</span>.<span style=color:#a6e22e>Retry</span> <span style=color:#f92672>+=</span> <span style=color:#ae81ff>1</span>
			<span style=color:#a6e22e>v</span>.<span style=color:#a6e22e>Time</span> = <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Now</span>()
			<span style=color:#a6e22e>v</span>.<span style=color:#a6e22e>Dns</span> = <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>choseDns</span>()
			<span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>hm</span>.<span style=color:#a6e22e>Set</span>(<span style=color:#a6e22e>domain</span>, <span style=color:#a6e22e>v</span>)
		}
		<span style=color:#a6e22e>send</span>(<span style=color:#a6e22e>domain</span>, <span style=color:#a6e22e>v</span>.<span style=color:#a6e22e>Dns</span>, <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>ether</span>, <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>dnsid</span>, uint16(<span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>freeport</span>), <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>handle</span>)
		<span style=color:#a6e22e>atomic</span>.<span style=color:#a6e22e>AddUint64</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>sendIndex</span>, <span style=color:#ae81ff>1</span>)
	}
}
</code></pre></td></tr></table>
</div>
</div><p>可以看到首先是发送速率的控制，然后从缓存中获取生成的子域名，如果没有代表第一次跑，初始化一个Item丢给send去发包，如果已经存在则重试次数加一，然后重新选择dns服务器，然后丢给send发包。</p>
<p>具体的发包函数我们就不看了，<code>ksubdomain</code> 是采用的 <code>gopacket</code> 直接构造dns包然后使用网卡发包，目的为了提速</p>
<p>然后看看接收函数</p>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>r</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>runner</span>) <span style=color:#a6e22e>recvChanel</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>) <span style=color:#66d9ef>error</span> {
	<span style=color:#f92672>...</span>

	<span style=color:#a6e22e>parser</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>gopacket</span>.<span style=color:#a6e22e>NewDecodingLayerParser</span>(
		<span style=color:#a6e22e>layers</span>.<span style=color:#a6e22e>LayerTypeEthernet</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>eth</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>ipv4</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>ipv6</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>udp</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>dns</span>)

	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>data</span> []<span style=color:#66d9ef>byte</span>
	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>decoded</span> []<span style=color:#a6e22e>gopacket</span>.<span style=color:#a6e22e>LayerType</span>
	<span style=color:#66d9ef>for</span> {
		<span style=color:#a6e22e>data</span>, <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>handle</span>.<span style=color:#a6e22e>ReadPacketData</span>()
		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
			<span style=color:#66d9ef>continue</span>
		}
		<span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>parser</span>.<span style=color:#a6e22e>DecodeLayers</span>(<span style=color:#a6e22e>data</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>decoded</span>)
		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
			<span style=color:#66d9ef>continue</span>
		}
		<span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>dns</span>.<span style=color:#a6e22e>QR</span> {
			<span style=color:#66d9ef>continue</span>
		}
		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>dns</span>.<span style=color:#a6e22e>ID</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>dnsid</span> {
			<span style=color:#66d9ef>continue</span>
		}
		<span style=color:#a6e22e>atomic</span>.<span style=color:#a6e22e>AddUint64</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>recvIndex</span>, <span style=color:#ae81ff>1</span>)
		<span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>dns</span>.<span style=color:#a6e22e>Questions</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
			<span style=color:#66d9ef>continue</span>
		}
		<span style=color:#a6e22e>subdomain</span> <span style=color:#f92672>:=</span> string(<span style=color:#a6e22e>dns</span>.<span style=color:#a6e22e>Questions</span>[<span style=color:#ae81ff>0</span>].<span style=color:#a6e22e>Name</span>)
		<span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>hm</span>.<span style=color:#a6e22e>Del</span>(<span style=color:#a6e22e>subdomain</span>)
		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>dns</span>.<span style=color:#a6e22e>ANCount</span> &gt; <span style=color:#ae81ff>0</span> {
			<span style=color:#a6e22e>atomic</span>.<span style=color:#a6e22e>AddUint64</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>successIndex</span>, <span style=color:#ae81ff>1</span>)
			<span style=color:#a6e22e>result</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>core</span>.<span style=color:#a6e22e>RecvResult</span>{
				<span style=color:#a6e22e>Subdomain</span>: <span style=color:#a6e22e>subdomain</span>,
				<span style=color:#a6e22e>Answers</span>:   <span style=color:#a6e22e>dns</span>.<span style=color:#a6e22e>Answers</span>,
			}
			<span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>recver</span> <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>result</span>
		}
	}
}
</code></pre></td></tr></table>
</div>
</div><p>我摘取了一部分，可以看到具体逻辑就是不断从网卡中获取然后解析dns返回包，然后从缓存中删除该子域名并放入 <code>recver</code> chan，这个chan主要是用来读取并输出的。</p>
<p>整体逻辑大体上就是这样。</p>
<h2 id=总结>总结<a hidden class=anchor aria-hidden=true href=#总结>#</a></h2>
<p>整体加速思路其实和amass有点像</p>
<p>amass是使用了一些额外的技巧来达到同步调用，使用单个udp连接来完成，一个协程用来写，一个用来读，而ksubdomain直接调用网卡驱动绕过了操作系统，可以突破操作系统的发包限制，会更快一些，amass对于udp到tcp的dns请求做了一些适配</p>
</div>
<footer class=post-footer>
<ul class=post-tags>
<li><a href=//hacktech.cn/tags/%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/>源码阅读</a></li>
<li><a href=//hacktech.cn/tags/%E5%AD%A6%E4%B9%A0/>学习</a></li>
</ul>
<nav class=paginav>
<a class=prev href=//hacktech.cn/2022/03/04/shikata-ga-nai-to-wasm/>
<span class=title>« 上一页</span>
<br>
<span>将Shikata ga nai带到前端</span>
</a>
<a class=next href=//hacktech.cn/2021/12/10/selfhost-bitwarden-sync-nutstore/>
<span class=title>下一页 »</span>
<br>
<span>自建bitwarden备份同步到坚果云</span>
</a>
</nav>
<div class=share-buttons>
<a target=_blank rel="noopener noreferrer" aria-label="share ksubdomain源码阅读 on twitter" href="https://twitter.com/intent/tweet/?text=ksubdomain%e6%ba%90%e7%a0%81%e9%98%85%e8%af%bb&url=%2f%2fhacktech.cn%2f2022%2f02%2f28%2fksubdomain-source-read%2f&hashtags=%e6%ba%90%e7%a0%81%e9%98%85%e8%af%bb%2c%e5%ad%a6%e4%b9%a0"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share ksubdomain源码阅读 on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=%2f%2fhacktech.cn%2f2022%2f02%2f28%2fksubdomain-source-read%2f&title=ksubdomain%e6%ba%90%e7%a0%81%e9%98%85%e8%af%bb&summary=ksubdomain%e6%ba%90%e7%a0%81%e9%98%85%e8%af%bb&source=%2f%2fhacktech.cn%2f2022%2f02%2f28%2fksubdomain-source-read%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share ksubdomain源码阅读 on reddit" href="https://reddit.com/submit?url=%2f%2fhacktech.cn%2f2022%2f02%2f28%2fksubdomain-source-read%2f&title=ksubdomain%e6%ba%90%e7%a0%81%e9%98%85%e8%af%bb"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share ksubdomain源码阅读 on facebook" href="https://facebook.com/sharer/sharer.php?u=%2f%2fhacktech.cn%2f2022%2f02%2f28%2fksubdomain-source-read%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share ksubdomain源码阅读 on whatsapp" href="https://api.whatsapp.com/send?text=ksubdomain%e6%ba%90%e7%a0%81%e9%98%85%e8%af%bb%20-%20%2f%2fhacktech.cn%2f2022%2f02%2f28%2fksubdomain-source-read%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share ksubdomain源码阅读 on telegram" href="https://telegram.me/share/url?text=ksubdomain%e6%ba%90%e7%a0%81%e9%98%85%e8%af%bb&url=%2f%2fhacktech.cn%2f2022%2f02%2f28%2fksubdomain-source-read%2f"><svg viewBox="2 2 28 28"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg>
</a>
</div>
</footer><script src=https://cdn.jsdelivr.net/npm/@waline/client></script>
<div id=waline></div>
<script>new Waline({el:'#waline',serverURL:'https://blog-waline-api-d1lk7kqu8-akkum4n.vercel.app',visitor:!0,dark:'body.dark',requiredMeta:['nick','mail'],uploadImage:!1,copyright:!0,locale:{placeholder:'欢迎评论'}})</script>
</article>
</main>
<footer class=footer>
<span>&copy; 2022 <a href=//hacktech.cn/>Akkuman 的博客</a></span>
<span>
Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a>
</span>
</footer>
<a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>window.netlifyIdentity&&window.netlifyIdentity.on("init",a=>{a||window.netlifyIdentity.on("login",()=>{document.location.href="/admin/"})})</script>
<script>let menu=document.getElementById('menu');menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})})</script>
<script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script>
<script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script>
<script>document.querySelectorAll('pre > code').forEach(b=>{const c=b.parentNode.parentNode,a=document.createElement('button');a.classList.add('copy-code'),a.innerHTML='复制';function d(){a.innerHTML='已复制！',setTimeout(()=>{a.innerHTML='复制'},2e3)}a.addEventListener('click',e=>{if('clipboard'in navigator){navigator.clipboard.writeText(b.textContent),d();return}const a=document.createRange();a.selectNodeContents(b);const c=window.getSelection();c.removeAllRanges(),c.addRange(a);try{document.execCommand('copy'),d()}catch(a){}c.removeRange(a)}),c.classList.contains("highlight")?c.appendChild(a):c.parentNode.firstChild==c||(b.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?b.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(a):b.parentNode.appendChild(a))})</script>
</body>
</html>