<!doctype html><html lang=zh dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>识别SigFlip生成的恶意文件 | Akkuman 的博客</title><meta name=keywords content="蓝队,网络安全"><meta name=description content="最近在移植 med0x2e/SigFlip 的过程中发现了一个有意思的点，可以用来作为检测的手段
在 SigFlip 项目的 Detect/Prevent 一节中作者有提到一些检测防御手段
https://docs.microsoft.com/en-us/security-updates/SecurityAdvisories/2014/2915720?redirectedfrom=MSDN
Once the patch is installed and proper registry keys are set, No system restarts are required, you only need to restart the Cryptographic Services. The Applocker service will be also restarted as it depends on the cryptographic services.(@p0w3rsh3ll)
Yara rule by Adrien; https://twitter.com/Int2e_/status/1330975808941330432
从 SigFlip 源码中，其实也能发现一个点
SigFlip 依赖一串特定的字节来定位shellcode的位置，详见 Native/SigLoader/SigLoader/SigLoader.cpp#L102 和 Native/SigFlip/SigFlip/SigFlip.cpp#L232
1 2 3 4 5 6 7 for (_index = 0; _index < _CertTableSize; _index++) { if (*(_pePtr + _index) == 0xfe && *(_pePtr + _index + 1) == 0xed && *(_pePtr + _index + 2) == 0xfa && *(_pePtr + _index + 3) == 0xce) { printf(&#34;[*]: Tag Found 0x%x%x%x%x&#34;, *(_pePtr + _index), *(_pePtr + _index+1), *(_pePtr + _index+2), *(_pePtr + _index+3)); _dataOffset = _index + 8; break; } } 1 2 memcpy(_encryptedData, &#34;\xFE\xED\xFA\xCE\xFE\xED\xFA\xCE&#34;, 8); crypt((unsigned char*)_data, _dataSize, _key, _keySize, (unsigned char*)_encryptedData + 8); 也就是说我们在证书表中定位到 \xFE\xED\xFA\xCE\xFE\xED\xFA\xCE 这段特征就可以断定它疑似 SigFlip 生成的 payload 了，想要更精准一些可以结合 https://twitter."><meta name=author content><link rel=canonical href=//akkuman.github.io/2021/12/10/identify-sigflip-file/><link crossorigin=anonymous href=https://cdn.jsdmirror.cn/gh/akkuman/akkuman.github.io@master/assets/css/stylesheet.4158007d1975708d1c78a5f18d877b728f8457f9c790b3dc013638bba69ea19d.css integrity="sha256-QVgAfRl1cI0ceKXxjYd7co+EV/nHkLPcATY4u6aeoZ0=" rel="preload stylesheet" as=style><link rel=icon href=//akkuman.github.io/images/avatar.webp><link rel=icon type=image/png sizes=16x16 href=//akkuman.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=//akkuman.github.io/favicon-32x32.png><link rel=apple-touch-icon href=//akkuman.github.io/apple-touch-icon.png><link rel=mask-icon href=//akkuman.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh href=//akkuman.github.io/2021/12/10/identify-sigflip-file/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC&family=Source+Code+Pro&display=swap" rel=stylesheet><script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script><meta property="og:title" content="识别SigFlip生成的恶意文件"><meta property="og:description" content="最近在移植 med0x2e/SigFlip 的过程中发现了一个有意思的点，可以用来作为检测的手段
在 SigFlip 项目的 Detect/Prevent 一节中作者有提到一些检测防御手段
https://docs.microsoft.com/en-us/security-updates/SecurityAdvisories/2014/2915720?redirectedfrom=MSDN
Once the patch is installed and proper registry keys are set, No system restarts are required, you only need to restart the Cryptographic Services. The Applocker service will be also restarted as it depends on the cryptographic services.(@p0w3rsh3ll)
Yara rule by Adrien; https://twitter.com/Int2e_/status/1330975808941330432
从 SigFlip 源码中，其实也能发现一个点
SigFlip 依赖一串特定的字节来定位shellcode的位置，详见 Native/SigLoader/SigLoader/SigLoader.cpp#L102 和 Native/SigFlip/SigFlip/SigFlip.cpp#L232
1 2 3 4 5 6 7 for (_index = 0; _index < _CertTableSize; _index++) { if (*(_pePtr + _index) == 0xfe && *(_pePtr + _index + 1) == 0xed && *(_pePtr + _index + 2) == 0xfa && *(_pePtr + _index + 3) == 0xce) { printf(&#34;[*]: Tag Found 0x%x%x%x%x&#34;, *(_pePtr + _index), *(_pePtr + _index+1), *(_pePtr + _index+2), *(_pePtr + _index+3)); _dataOffset = _index + 8; break; } } 1 2 memcpy(_encryptedData, &#34;\xFE\xED\xFA\xCE\xFE\xED\xFA\xCE&#34;, 8); crypt((unsigned char*)_data, _dataSize, _key, _keySize, (unsigned char*)_encryptedData + 8); 也就是说我们在证书表中定位到 \xFE\xED\xFA\xCE\xFE\xED\xFA\xCE 这段特征就可以断定它疑似 SigFlip 生成的 payload 了，想要更精准一些可以结合 https://twitter."><meta property="og:type" content="article"><meta property="og:url" content="//akkuman.github.io/2021/12/10/identify-sigflip-file/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-12-10T07:41:00+00:00"><meta property="article:modified_time" content="2021-12-10T07:41:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="识别SigFlip生成的恶意文件"><meta name=twitter:description content="最近在移植 med0x2e/SigFlip 的过程中发现了一个有意思的点，可以用来作为检测的手段
在 SigFlip 项目的 Detect/Prevent 一节中作者有提到一些检测防御手段
https://docs.microsoft.com/en-us/security-updates/SecurityAdvisories/2014/2915720?redirectedfrom=MSDN
Once the patch is installed and proper registry keys are set, No system restarts are required, you only need to restart the Cryptographic Services. The Applocker service will be also restarted as it depends on the cryptographic services.(@p0w3rsh3ll)
Yara rule by Adrien; https://twitter.com/Int2e_/status/1330975808941330432
从 SigFlip 源码中，其实也能发现一个点
SigFlip 依赖一串特定的字节来定位shellcode的位置，详见 Native/SigLoader/SigLoader/SigLoader.cpp#L102 和 Native/SigFlip/SigFlip/SigFlip.cpp#L232
1 2 3 4 5 6 7 for (_index = 0; _index < _CertTableSize; _index++) { if (*(_pePtr + _index) == 0xfe && *(_pePtr + _index + 1) == 0xed && *(_pePtr + _index + 2) == 0xfa && *(_pePtr + _index + 3) == 0xce) { printf(&#34;[*]: Tag Found 0x%x%x%x%x&#34;, *(_pePtr + _index), *(_pePtr + _index+1), *(_pePtr + _index+2), *(_pePtr + _index+3)); _dataOffset = _index + 8; break; } } 1 2 memcpy(_encryptedData, &#34;\xFE\xED\xFA\xCE\xFE\xED\xFA\xCE&#34;, 8); crypt((unsigned char*)_data, _dataSize, _key, _keySize, (unsigned char*)_encryptedData + 8); 也就是说我们在证书表中定位到 \xFE\xED\xFA\xCE\xFE\xED\xFA\xCE 这段特征就可以断定它疑似 SigFlip 生成的 payload 了，想要更精准一些可以结合 https://twitter."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"//akkuman.github.io/posts/"},{"@type":"ListItem","position":2,"name":"识别SigFlip生成的恶意文件","item":"//akkuman.github.io/2021/12/10/identify-sigflip-file/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"识别SigFlip生成的恶意文件","name":"识别SigFlip生成的恶意文件","description":"最近在移植 med0x2e/SigFlip 的过程中发现了一个有意思的点，可以用来作为检测的手段\n在 SigFlip 项目的 Detect/Prevent 一节中作者有提到一些检测防御手段\nhttps://docs.microsoft.com/en-us/security-updates/SecurityAdvisories/2014/2915720?redirectedfrom=MSDN\nOnce the patch is installed and proper registry keys are set, No system restarts are required, you only need to restart the Cryptographic Services. The Applocker service will be also restarted as it depends on the cryptographic services.(@p0w3rsh3ll)\nYara rule by Adrien; https://twitter.com/Int2e_/status/1330975808941330432\n从 SigFlip 源码中，其实也能发现一个点\nSigFlip 依赖一串特定的字节来定位shellcode的位置，详见 Native/SigLoader/SigLoader/SigLoader.cpp#L102 和 Native/SigFlip/SigFlip/SigFlip.cpp#L232\n1 2 3 4 5 6 7 for (_index = 0; _index \u0026lt; _CertTableSize; _index++) { if (*(_pePtr + _index) == 0xfe \u0026amp;\u0026amp; *(_pePtr + _index + 1) == 0xed \u0026amp;\u0026amp; *(_pePtr + _index + 2) == 0xfa \u0026amp;\u0026amp; *(_pePtr + _index + 3) == 0xce) { printf(\u0026#34;[*]: Tag Found 0x%x%x%x%x\u0026#34;, *(_pePtr + _index), *(_pePtr + _index+1), *(_pePtr + _index+2), *(_pePtr + _index+3)); _dataOffset = _index + 8; break; } } 1 2 memcpy(_encryptedData, \u0026#34;\\xFE\\xED\\xFA\\xCE\\xFE\\xED\\xFA\\xCE\u0026#34;, 8); crypt((unsigned char*)_data, _dataSize, _key, _keySize, (unsigned char*)_encryptedData + 8); 也就是说我们在证书表中定位到 \\xFE\\xED\\xFA\\xCE\\xFE\\xED\\xFA\\xCE 这段特征就可以断定它疑似 SigFlip 生成的 payload 了，想要更精准一些可以结合 https://twitter.","keywords":["蓝队","网络安全"],"articleBody":"最近在移植 med0x2e/SigFlip 的过程中发现了一个有意思的点，可以用来作为检测的手段\n在 SigFlip 项目的 Detect/Prevent 一节中作者有提到一些检测防御手段\nhttps://docs.microsoft.com/en-us/security-updates/SecurityAdvisories/2014/2915720?redirectedfrom=MSDN\nOnce the patch is installed and proper registry keys are set, No system restarts are required, you only need to restart the Cryptographic Services. The Applocker service will be also restarted as it depends on the cryptographic services.(@p0w3rsh3ll)\nYara rule by Adrien; https://twitter.com/Int2e_/status/1330975808941330432\n从 SigFlip 源码中，其实也能发现一个点\nSigFlip 依赖一串特定的字节来定位shellcode的位置，详见 Native/SigLoader/SigLoader/SigLoader.cpp#L102 和 Native/SigFlip/SigFlip/SigFlip.cpp#L232\n1 2 3 4 5 6 7 for (_index = 0; _index \u003c _CertTableSize; _index++) { if (*(_pePtr + _index) == 0xfe \u0026\u0026 *(_pePtr + _index + 1) == 0xed \u0026\u0026 *(_pePtr + _index + 2) == 0xfa \u0026\u0026 *(_pePtr + _index + 3) == 0xce) { printf(\"[*]: Tag Found 0x%x%x%x%x\", *(_pePtr + _index), *(_pePtr + _index+1), *(_pePtr + _index+2), *(_pePtr + _index+3)); _dataOffset = _index + 8; break; } } 1 2 memcpy(_encryptedData, \"\\xFE\\xED\\xFA\\xCE\\xFE\\xED\\xFA\\xCE\", 8); crypt((unsigned char*)_data, _dataSize, _key, _keySize, (unsigned char*)_encryptedData + 8); 也就是说我们在证书表中定位到 \\xFE\\xED\\xFA\\xCE\\xFE\\xED\\xFA\\xCE 这段特征就可以断定它疑似 SigFlip 生成的 payload 了，想要更精准一些可以结合 https://twitter.com/Int2e_/status/1330975808941330432 中提到的长度特征。\n另外很有意思的一点是，这个项目是有问题的（截至20211103 commit e24a1fc），详见 Native/SigFlip/SigFlip/SigFlip.cpp#L164 和 Native/SigFlip/SigFlip/SigFlip.cpp#L260，很多情况下该项目根本没法正常使用，因为pe文件的RVA和FOA之间的关系作者并没有进行处理，只有当pe文件中的 ~~SectionAlignment~~ 和 ~~FileAlignment~~ 一样时，RVA才等于FOA，导致的结果是，可能使用工具后签名会失效。错误的位置，加上上面的特征码，这个更加是一个强特征了。公鸡队之家修改后的 CrackerCat/sigFile 也没有修正这个bug。\n上面是我莽撞了，IMAGE_DIRECTORY_ENTRY_SECURITY 这个结构的 VirtualAddress 就是相对于文件开头的偏移，可参见 Does DataDirectory[IMAGE_DIRECTORY_ENTRY_SECURITY].VirtualAddress actually mean file offset? 和 SigThief 的相关实现，所以这个并不是bug\n另外还有一个bug，注意在 Native/SigFlip/SigFlip/SigFlip.cpp#L149-L159\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 //Security entry seems to be located at the 7th offset (Data_Dir) for For x64 PE files, and the 5th offset for x86 PE files. just a quick workaround to make the script work for different PE archs. if (IsWow64(GetCurrentProcess())) { if (_optHeader.Magic == 0x20B) { _DT_SecEntry_Offset = 2; } } else { if (_optHeader.Magic == 0x10B) { _DT_SecEntry_Offset = -2; } } ... //Get IMAGE_DIRECTORY_ENTRY_SECURITY field and retrieve the RVA and SIZE of the Certificate Table (WIN_CERTIFICATE). _CertTableRVA = _optHeader.DataDirectory[IMAGE_DIRECTORY_ENTRY_SECURITY + _DT_SecEntry_Offset].VirtualAddress; _CertTableSize = _optHeader.DataDirectory[IMAGE_DIRECTORY_ENTRY_SECURITY + _DT_SecEntry_Offset].Size; 但是实际上看到的基本都是 IMAGE_DIRECTORY_ENTRY_SECURITY 在第五个，而没有他这里的情况，并且就算是有这种情况，注释和代码写得也不相符。\n最后一句，Native跑不起来，DotNet的实现是正确的\n最后的 yara 规则大家可以自己研究下\n","wordCount":"290","inLanguage":"zh","datePublished":"2021-12-10T07:41:00Z","dateModified":"2021-12-10T07:41:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"//akkuman.github.io/2021/12/10/identify-sigflip-file/"},"publisher":{"@type":"Organization","name":"Akkuman 的博客","logo":{"@type":"ImageObject","url":"//akkuman.github.io/images/avatar.webp"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=//akkuman.github.io/ accesskey=h title="Akkuman 的博客 (Alt + H)">Akkuman 的博客</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li><li><a href=//akkuman.github.io/en/ title=English aria-label=English>En</a></li></ul></div></div><ul id=menu><li><a href=//akkuman.github.io/archives/ title=归档><span>归档</span></a></li><li><a href=//akkuman.github.io/categories/ title=分类><span>分类</span></a></li><li><a href=//akkuman.github.io/search/ title=搜索><span>搜索</span></a></li><li><a href=//akkuman.github.io/tags/ title=标签><span>标签</span></a></li><li><a href=//akkuman.github.io/links/ title=链接><span>链接</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=//akkuman.github.io/>主页</a>&nbsp;»&nbsp;<a href=//akkuman.github.io/posts/>Posts</a></div><h1 class=post-title>识别SigFlip生成的恶意文件</h1><div class=post-meta><span title='2021-12-10 07:41:00 +0000 UTC'>十二月 10, 2021</span>&nbsp;·&nbsp;2 分钟&nbsp;·&nbsp;<span id=busuanzi_container_page_pv><span id=busuanzi_value_page_pv></span></span>&nbsp;|&nbsp;<a href="mailto://akkumans@qq.com?subject=Suggesting%20changes%20for%20/posts/identify-sigflip-file.md" rel="noopener noreferrer" target=_blank>给我邮件</a></div></header><div class=post-content><p>最近在移植 <a href=https://github.com/med0x2e/SigFlip>med0x2e/SigFlip</a> 的过程中发现了一个有意思的点，可以用来作为检测的手段</p><p>在 SigFlip 项目的 <a href=https://github.com/med0x2e/SigFlip#detectprevent>Detect/Prevent</a> 一节中作者有提到一些检测防御手段</p><blockquote><p><a href="https://docs.microsoft.com/en-us/security-updates/SecurityAdvisories/2014/2915720?redirectedfrom=MSDN">https://docs.microsoft.com/en-us/security-updates/SecurityAdvisories/2014/2915720?redirectedfrom=MSDN</a></p></blockquote><blockquote><p>Once the patch is installed and proper registry keys are set, No system restarts are required, you only need to restart the Cryptographic Services. The Applocker service will be also restarted as it depends on the cryptographic services.(@p0w3rsh3ll)</p></blockquote><blockquote><p>Yara rule by Adrien; <a href=https://twitter.com/Int2e_/status/1330975808941330432>https://twitter.com/Int2e_/status/1330975808941330432</a></p></blockquote><p>从 SigFlip 源码中，其实也能发现一个点</p><p>SigFlip 依赖一串特定的字节来定位shellcode的位置，详见 <a href=https://github.com/med0x2e/SigFlip/blob/e24a1fcde8ab27f58c35935f65078b47b20eca43/Native/SigLoader/SigLoader/SigLoader.cpp#L102>Native/SigLoader/SigLoader/SigLoader.cpp#L102</a> 和 <a href=https://github.com/med0x2e/SigFlip/blob/e24a1fcde8ab27f58c35935f65078b47b20eca43/Native/SigFlip/SigFlip/SigFlip.cpp#L232>Native/SigFlip/SigFlip/SigFlip.cpp#L232</a></p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>for</span> (_index <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; _index <span style=color:#f92672>&lt;</span> _CertTableSize; _index<span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> (<span style=color:#f92672>*</span>(_pePtr <span style=color:#f92672>+</span> _index) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0xfe</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>*</span>(_pePtr <span style=color:#f92672>+</span> _index <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0xed</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>*</span>(_pePtr <span style=color:#f92672>+</span> _index <span style=color:#f92672>+</span> <span style=color:#ae81ff>2</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0xfa</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>*</span>(_pePtr <span style=color:#f92672>+</span> _index <span style=color:#f92672>+</span> <span style=color:#ae81ff>3</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0xce</span>) {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;[*]: Tag Found 0x%x%x%x%x&#34;</span>, <span style=color:#f92672>*</span>(_pePtr <span style=color:#f92672>+</span> _index), <span style=color:#f92672>*</span>(_pePtr <span style=color:#f92672>+</span> _index<span style=color:#f92672>+</span><span style=color:#ae81ff>1</span>), <span style=color:#f92672>*</span>(_pePtr <span style=color:#f92672>+</span> _index<span style=color:#f92672>+</span><span style=color:#ae81ff>2</span>), <span style=color:#f92672>*</span>(_pePtr <span style=color:#f92672>+</span> _index<span style=color:#f92672>+</span><span style=color:#ae81ff>3</span>));
</span></span><span style=display:flex><span>			_dataOffset <span style=color:#f92672>=</span> _index <span style=color:#f92672>+</span> <span style=color:#ae81ff>8</span>;
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#a6e22e>memcpy</span>(_encryptedData, <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\xFE\xED\xFA\xCE\xFE\xED\xFA\xCE</span><span style=color:#e6db74>&#34;</span>, <span style=color:#ae81ff>8</span>);
</span></span><span style=display:flex><span><span style=color:#a6e22e>crypt</span>((<span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>char</span><span style=color:#f92672>*</span>)_data, _dataSize, _key, _keySize, (<span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>char</span><span style=color:#f92672>*</span>)_encryptedData <span style=color:#f92672>+</span> <span style=color:#ae81ff>8</span>);
</span></span></code></pre></td></tr></table></div></div><p>也就是说我们在证书表中定位到 <code>\xFE\xED\xFA\xCE\xFE\xED\xFA\xCE</code> 这段特征就可以断定它疑似 SigFlip 生成的 payload 了，想要更精准一些可以结合 <a href=https://twitter.com/Int2e_/status/1330975808941330432>https://twitter.com/Int2e_/status/1330975808941330432</a> 中提到的长度特征。</p><p><del>另外很有意思的一点是，这个项目是有问题的（截至20211103 commit <del><del><a href=/58535d3f5ef64030991147ab0a85701f>e24a1fc</a></del></del>），详见 <del><del><a href=https://github.com/med0x2e/SigFlip/blob/e24a1fcde8ab27f58c35935f65078b47b20eca43/Native/SigFlip/SigFlip/SigFlip.cpp#L164>Native/SigFlip/SigFlip/SigFlip.cpp#L164</a></del></del> 和 <del><del><a href=https://github.com/med0x2e/SigFlip/blob/e24a1fcde8ab27f58c35935f65078b47b20eca43/Native/SigFlip/SigFlip/SigFlip.cpp#L260>Native/SigFlip/SigFlip/SigFlip.cpp#L260</a></del></del>，很多情况下该项目根本没法正常使用，因为pe文件的RVA和FOA之间的关系作者并没有进行处理，只有当pe文件中的 <del><code>~~SectionAlignment~~</code></del> 和 <del><code>~~FileAlignment~~</code></del> 一样时，RVA才等于FOA，导致的结果是，可能使用工具后签名会失效。错误的位置，加上上面的特征码，这个更加是一个强特征了。公鸡队之家修改后的 <del><del><a href=https://github.com/CrackerCat/sigFile>CrackerCat/sigFile</a></del></del> 也没有修正这个bug。</del></p><p>上面是我莽撞了，<code>IMAGE_DIRECTORY_ENTRY_SECURITY</code> 这个结构的 <code>VirtualAddress</code> 就是相对于文件开头的偏移，可参见 <a href="https://social.msdn.microsoft.com/Forums/windows/en-US/29d3a40b-844e-49a5-b436-3aff929dba30/does-datadirectoryimagedirectoryentrysecurityvirtualaddress-actually-mean-file-offset?forum=windowssdk">Does DataDirectory[IMAGE_DIRECTORY_ENTRY_SECURITY].VirtualAddress actually mean file offset?</a> 和 <a href=https://github.com/secretsquirrel/SigThief/blob/ffb501bcd86acd439e4458a33e9fc5ebed4b59a8/sigthief.py#L99-L116>SigThief 的相关实现</a>，所以这个并不是bug</p><p>另外还有一个bug，注意在 <a href=https://github.com/med0x2e/SigFlip/blob/e24a1fcde8ab27f58c35935f65078b47b20eca43/Native/SigFlip/SigFlip/SigFlip.cpp#L149-L159>Native/SigFlip/SigFlip/SigFlip.cpp#L149-L159</a></p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>//Security entry seems to be located at the 7th offset (Data_Dir) for For x64 PE files, and the 5th offset for x86 PE files. just a quick workaround to make the script work for different PE archs.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>IsWow64</span>(<span style=color:#a6e22e>GetCurrentProcess</span>())) {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (_optHeader.Magic <span style=color:#f92672>==</span> <span style=color:#ae81ff>0x20B</span>) {
</span></span><span style=display:flex><span>		_DT_SecEntry_Offset <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span>;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (_optHeader.Magic <span style=color:#f92672>==</span> <span style=color:#ae81ff>0x10B</span>) {
</span></span><span style=display:flex><span>		_DT_SecEntry_Offset <span style=color:#f92672>=</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>2</span>;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span><span style=color:#75715e>//Get IMAGE_DIRECTORY_ENTRY_SECURITY field and retrieve the RVA and SIZE of the Certificate Table (WIN_CERTIFICATE).
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>_CertTableRVA <span style=color:#f92672>=</span> _optHeader.DataDirectory[IMAGE_DIRECTORY_ENTRY_SECURITY <span style=color:#f92672>+</span> _DT_SecEntry_Offset].VirtualAddress;
</span></span><span style=display:flex><span>_CertTableSize <span style=color:#f92672>=</span> _optHeader.DataDirectory[IMAGE_DIRECTORY_ENTRY_SECURITY <span style=color:#f92672>+</span> _DT_SecEntry_Offset].Size;
</span></span></code></pre></td></tr></table></div></div><p>但是实际上看到的基本都是 <code>IMAGE_DIRECTORY_ENTRY_SECURITY</code> 在第五个，而没有他这里的情况，并且就算是有这种情况，注释和代码写得也不相符。</p><p>最后一句，Native跑不起来，DotNet的实现是正确的</p><p>最后的 yara 规则大家可以自己研究下</p></div><footer class=post-footer><ul class=post-tags><li><a href=//akkuman.github.io/tags/%E8%93%9D%E9%98%9F/>蓝队</a></li><li><a href=//akkuman.github.io/tags/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/>网络安全</a></li></ul><nav class=paginav><a class=prev href=//akkuman.github.io/2021/12/10/notion-to-github-blog/><span class=title>« 上一页</span><br><span>notion实现自动发布到hugo github博客</span></a>
<a class=next href=//akkuman.github.io/2021/12/06/newsletter2rss/><span class=title>下一页 »</span><br><span>将newsletter转为rss</span></a></nav><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share 识别SigFlip生成的恶意文件 on twitter" href="https://twitter.com/intent/tweet/?text=%e8%af%86%e5%88%abSigFlip%e7%94%9f%e6%88%90%e7%9a%84%e6%81%b6%e6%84%8f%e6%96%87%e4%bb%b6&amp;url=%2f%2fakkuman.github.io%2f2021%2f12%2f10%2fidentify-sigflip-file%2f&amp;hashtags=%e8%93%9d%e9%98%9f%2c%e7%bd%91%e7%bb%9c%e5%ae%89%e5%85%a8"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share 识别SigFlip生成的恶意文件 on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=%2f%2fakkuman.github.io%2f2021%2f12%2f10%2fidentify-sigflip-file%2f&amp;title=%e8%af%86%e5%88%abSigFlip%e7%94%9f%e6%88%90%e7%9a%84%e6%81%b6%e6%84%8f%e6%96%87%e4%bb%b6&amp;summary=%e8%af%86%e5%88%abSigFlip%e7%94%9f%e6%88%90%e7%9a%84%e6%81%b6%e6%84%8f%e6%96%87%e4%bb%b6&amp;source=%2f%2fakkuman.github.io%2f2021%2f12%2f10%2fidentify-sigflip-file%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share 识别SigFlip生成的恶意文件 on reddit" href="https://reddit.com/submit?url=%2f%2fakkuman.github.io%2f2021%2f12%2f10%2fidentify-sigflip-file%2f&title=%e8%af%86%e5%88%abSigFlip%e7%94%9f%e6%88%90%e7%9a%84%e6%81%b6%e6%84%8f%e6%96%87%e4%bb%b6"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share 识别SigFlip生成的恶意文件 on facebook" href="https://facebook.com/sharer/sharer.php?u=%2f%2fakkuman.github.io%2f2021%2f12%2f10%2fidentify-sigflip-file%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share 识别SigFlip生成的恶意文件 on whatsapp" href="https://api.whatsapp.com/send?text=%e8%af%86%e5%88%abSigFlip%e7%94%9f%e6%88%90%e7%9a%84%e6%81%b6%e6%84%8f%e6%96%87%e4%bb%b6%20-%20%2f%2fakkuman.github.io%2f2021%2f12%2f10%2fidentify-sigflip-file%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share 识别SigFlip生成的恶意文件 on telegram" href="https://telegram.me/share/url?text=%e8%af%86%e5%88%abSigFlip%e7%94%9f%e6%88%90%e7%9a%84%e6%81%b6%e6%84%8f%e6%96%87%e4%bb%b6&amp;url=%2f%2fakkuman.github.io%2f2021%2f12%2f10%2fidentify-sigflip-file%2f"><svg viewBox="2 2 28 28"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div></footer><script src=https://cdn.jsdelivr.net/npm/@waline/client></script><div id=waline></div><script>new Waline({el:"#waline",serverURL:"https://blog-waline-api-d1lk7kqu8-akkum4n.vercel.app",visitor:!0,dark:"body.dark",requiredMeta:["nick","mail"],uploadImage:!1,copyright:!0,locale:{placeholder:"欢迎评论"}})</script></article></main><footer class=footer><span>&copy; 2024 <a href=//akkuman.github.io/>Akkuman 的博客</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="复制";function s(){t.innerHTML="已复制！",setTimeout(()=>{t.innerHTML="复制"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>